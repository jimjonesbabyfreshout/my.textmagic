var Subaccount=function(){var $this=this;$this.init();$this.modalAddPeople.on('hide.bs.modal',function(){$this.clearAjaxErrors($this.modalAddPeople);});$this.modalEditPeople.on('hide.bs.modal',function(){$this.clearAjaxErrors($this.modalEditPeople);});$this.modalAddPeople.on('show.bs.modal',function(){$this.emailEdit.val('');$($this.rolesSelector).first().click();});$(document).on('click',$this.deleteSessionBtn,function(e){e.preventDefault();$this.deleteImportSessionBtnClickHandler($(this).closest('tr').data('id'));});$this.topDeleteBtn.on('click',function(){$this.deleteImportSessionBtnClickHandler(null);});};String.prototype.replaceArray=function(find,replace){var replaceString=this;for(var i=0;i<find.length;i++){replaceString=replaceString.replace(find[i],replace);}
return replaceString;};Subaccount.prototype.init=function(){this.alert=$('.alert');this.deleteSessionBtn='[data-widget="deleteSession"]';this.topDeleteBtn=$('#removeCheckedRows');this.emptyScreen=$('.panel-blank');this.addSubaccountForm=$('#add-subaccount-form');this.editSubaccountForm=$('#edit-subaccount-form');this.resendInvitationForm=$('#resend-invitation-form');this.modalAddPeople=$('#add-people-modal');this.modalEditPeople=$('#edit-people-modal');this.modalResendInvitation=$('#resend-people-invitation-modal');this.modalMessageDetail=$('#messagedetailModal');this.closeBtn=$('[data-widget=deleteSubAccount]');this.closeRowBtn='[data-widget="close-subaccount-row"]';this.openBtn=$('[data-widget=openSubAccount]');this.openRowBtn='[data-widget="open-subaccount-row"]';this.editRowBtn='a[data-widget="edit-row"]';this.sendResetPwdBtn=$('[data-widget=passwordReminder]');this.sendResetPwdRowBtn='[data-widget="password-reminder-row"]';this.resendInvRowBtn='[data-widget="resend-inv-row"]';this.pdfExportLink=$('a.pdf_export');this.exportSelectedLink=$('a.export-lnk');this.dateFilterClose=$('#dateFilterClose');this.commandUrl='/online/account/ajax';this.phoneCountry='GB';this.phoneEdit=$('#form_phone');this.emailEdit=$('#form_email');this.rolesSelector='[name="form[role]"]';this.initSubaccountsCrudApi();this.initMessagesCrudApi();};Subaccount.prototype.editRowClickHandler=function(target,form){var fields=['id','username','email','firstName','lastName','phone'];fields.forEach(function(f){form.find('input[data-field="'+f+'"]').val(target.data(f));});var radio=form.find('input[data-field="role"][value="'+target.data('role')+'"]');if(radio.length){radio.click();}};Subaccount.prototype.updatePhonePopoverForCountry=function(){var phoneNumberUtil=i18n.phonenumbers.PhoneNumberUtil.getInstance(),exampleNumberObj=phoneNumberUtil.getExampleNumberForType(this.phoneCountry,i18n.phonenumbers.PhoneNumberType.MOBILE),exampleNumber=phoneNumberUtil.format(exampleNumberObj,i18n.phonenumbers.PhoneNumberFormat.NATIONAL);this.phoneEdit.attr('placeholder',exampleNumber);};Subaccount.prototype.renderListErrors=function(errors,form){$.each(errors,function(key,value){if(key=='alert'){return true;}
form.find('[data-field='+key+']').closest('.form-group').addClass('has-error').find('.help-block.error').html(value);});};Subaccount.prototype.clearAjaxErrors=function($el){$el.find('.form-group').removeClass('has-error').find('.help-block.error').empty();}
Subaccount.prototype.showAjaxAlert=function(cls,message){if(cls=='alert alert-success'){return this.alert.successBlock(message);}
this.alert.removeClass().addClass(cls).show().find('.message').html(message);};Subaccount.prototype.initSubaccountsCrudApi=function(){$this=this;this.subaccountsCrudApi=$.prepareCrudPage({containerSelector:'#subaccounts-content',itemSelector:'tr[data-widget=subaccount]',commandUrl:$this.commandUrl,paginationCommand:'peopleTable',searchFormSelector:'#subaccounts-search',beforeReloadFunction:function(api){var requestParams=api.getOptions().requestParams;if(requestParams.hasOwnProperty('params')){requestParams.params=$.extend({},requestParams.params,{type:$('#subaccounts-content').data('type')});}else{requestParams.params={type:$('#subaccounts-content').data('type')};}
api.setOptions({requestParams:requestParams});},});};Subaccount.prototype.initMessagesCrudApi=function(){$this=this;var container=$('#subaccount-messages-content');var messagesCrudApi=container.widgetPagination({'page':1,'perPage':10,query:{'datePair':'All','text':''},requestParams:{'cmd':'sentTable','userId':container.data('userid')},callbackReloadBefore:function(api,requestParams){container.find('table').spin('enable');},callbackReloadSuccess:function(api){container.find('th[data-field]').on('click.crudSort',function(e){e.preventDefault();var data=api.getOptions();var orderBy=$(this).data('field');var direction=($(this).hasClass('headerSortUp'))?'asc':'desc';api.setOptions({requestParams:{'cmd':data.requestParams.cmd,'userId':container.data('userid'),'orderBy':orderBy,'direction':direction}}).reload();});container.find('table').spin('disable');},callbackReloadError:function(){container.find('table').spin('disable');}},function(api){$('#user-sent-search-form').on('submit',function(e){e.preventDefault();var data=api.getOptions();var query=data.query;data.page=1;query.text=$(this).find('input:text[name=search-query]').val();api.setOptions({query:query}).reload();return false;});var changeDate=function(type,from,to){var data=api.getOptions();var query=data.query;data.page=1;query.datePair=type;query.from=from;query.to=to;api.setOptions({query:query}).reload();};var pickChangeDate=function(){changeDate('Pick date range',$('#dateFilterStart').val(),$('#dateFilterEnd').val());};$('input[name="date-filter-list"]').change(function(){if($(this).val()=='Pick date range'){pickChangeDate();return;}
changeDate($(this).val(),null,null);});$('#showDateRange').on('click',function(){pickChangeDate();});$('input:radio[name="date-filter-list"]').on('change',function(){$('#dateFilterValue').text($(this).parent().text());if(this.value=='Pick date range'){$('#dateFilter').removeClass('hidden');}else{$('#dateFilter').addClass('hidden');}});$("#report-tabs a").click(function(e){e.preventDefault();var toggleExportLnk=function(status){$('a.export-lnk').each(function(){var href=$(this).attr('href').replaceArray(['sent','inbox'],status);$(this).attr('href',href);});};var status=$(this).attr('href').replace('#content-','');var data=api.getOptions();var query=data.query;data.page=1;toggleExportLnk(status);api.setOptions({'query':query,'requestParams':{'cmd':status+'Table','userId':container.data('userid')}}).reload();$(this).parent().parent().find('li.active').removeClass('active');$(this).parent().addClass('active');});api.reload();initExportWidget(api,'a.export-lnk');});$this.messagesCrudApi=messagesCrudApi;};Subaccount.prototype.getExportInvoicesLinkParam=function(){var $this=this;var last=$this.messagesCrudApi.getRequestParams();delete last.page;delete last.perPage;return '?'+decodeURIComponent($.param(last));}
Subaccount.prototype.updateDetailsInfo=function(data){$.each(data,function(key,value){if(value===null){value='';}
var $input=$('[data-field='+key+']');switch(key){case 'email':$('[data-rel='+key+']').text(value);$('[data-rel='+key+']').attr('href','mailto:'+value);break;case 'role':$('[data-rel='+key+']').text(value==='A'?'ADMINISTRATOR':'USER');break;case 'phone':$('[data-rel='+key+']').text(value);$input.val(value);break;case 'number':$('[data-rel='+key+']').text(value?value:'None');break;default:if(!value.trim()){$('[data-rel='+key+']').closest('tr').hide();}else{$('[data-rel='+key+']').text(value);}}});}
Subaccount.prototype.inboxMessageDetailsPdf=function(messageId){this.pdfExportLink.attr('href','/online/export/messages_inbox_detail/pdf?id='+messageId);$.ajax({url:'/online/messages/inbox/detail',cache:false,type:"POST",data:{id:messageId,ajax:true},dataType:"html"}).done(function(html){$('#modal-content-table').html(html);});}
Subaccount.prototype.processSubaccount=function(modal,form,afterSuccessAction){var $this=this;var $data=form.serializeJSON();$data.cmd=form.data('cmd');$.ajax({url:$this.commandUrl,type:'POST',dataType:'JSON',data:$data,beforeSend:function(){modal.find('.btn-success').spin('enable','Saving...');modal.find(':button').attr('disabled','disabled');modal.find(':input').attr('disabled','disabled');$this.clearAjaxErrors(modal);},complete:function(xhr){modal.find('.btn-success').spin('disable');modal.find(':button').removeAttr('disabled');modal.find(':input').removeAttr('disabled');},success:function(xhr){if(xhr.success){if(afterSuccessAction=='reloadList'){if($this.subaccountsCrudApi.getPaginationApi()!=undefined){$this.subaccountsCrudApi.getPaginationApi().reload();}}else{$this.updateDetailsInfo(xhr.data);}
modal.modal('hide');$this.showAjaxAlert('alert alert-success',xhr.message['alert']);}else{if(xhr.message['alert']){modal.modal('hide');$this.showAjaxAlert('alert alert-warning',xhr.message['alert']);}else{$this.renderListErrors(xhr.message,form);}}},error:function(xhr){modal.modal('hide');$this.showAjaxAlert('alert alert-warning','Sorry, but it looks like something has gone wrong. Please try again or contact us at support@textmagic.com.');}});}
Subaccount.prototype.resendInvitationSubaccount=function(){$this=this;var $data=$this.resendInvitationForm.serializeJSON();$data.cmd='resendSubInvitation';$.ajax({url:$this.commandUrl,type:'POST',dataType:'JSON',data:$data,beforeSend:function(){$this.modalResendInvitation.find('.btn-success').spin('enable','Loading...');$this.modalResendInvitation.find(':button').attr('disabled','disabled');$this.modalResendInvitation.find(':input').attr('disabled','disabled');$this.clearAjaxErrors($this.modalResendInvitation);},complete:function(xhr){$this.modalResendInvitation.find('.btn-success').spin('disable');$this.modalResendInvitation.find(':button').removeAttr('disabled');$this.modalResendInvitation.find(':input').removeAttr('disabled');},success:function(xhr){if(xhr.success){if($this.subaccountsCrudApi.getPaginationApi()!=undefined){$this.subaccountsCrudApi.getPaginationApi().reload();}
$this.modalResendInvitation.modal('hide');$this.showAjaxAlert('alert alert-success',xhr.message['alert']);}else{if(xhr.message['alert']){$this.modalResendInvitation.modal('hide');$this.showAjaxAlert('alert alert-warning',xhr.message['alert']);}else{$this.renderListErrors(xhr.message,$this.resendInvitationForm);}}},error:function(xhr){$this.modalResendInvitation.modal('hide');$this.showAjaxAlert('alert alert-warning','Sorry, but it looks like something has gone wrong. Please try again or contact us at support@textmagic.com.');}});};Subaccount.prototype.closeSubaccountConfirm=function(userIds){$this=this;$.confirm({'title':'Close sub-account','message':'Are you sure you want to close this sub-account?','buttons':{'cancel':{'text':'Cancel','class':'btn btn-default'},'Yes':{'text':'Close sub-account','class':'btn btn-danger','click':function(){$this.closeAction(userIds);}}},checkboxes:[{name:'contacts',text:'I understand that <b>contacts</b> owned by this account will be permanently deleted and cannot be restored.'},{name:'messages',text:'I understand that <b>sent and received messages</b> owned by this account will be permanently deleted and cannot be restored.'}]});};Subaccount.prototype.openSubaccountConfirm=function(userIds){$this=this;$.confirm({'title':'Reopen sub-account','message':'Are you sure, you want to reopen this sub-account?','buttons':{'cancel':{'text':'Cancel','class':'btn btn-default'},'Yes':{'text':'Reopen sub-account','class':'btn btn-success btn-solid','click':function(){$this.reopenAction(userIds);}}}});};Subaccount.prototype.sendResetPwdConfirm=function(userIds){var $this=this;$.confirm({'title':'Reset sub-account password','message':'Are you sure you want to reset this sub-account password?','buttons':{'cancel':{'text':'Cancel','class':'btn btn-default'},'Yes':{'text':'Reset password','class':'btn btn-success btn-solid','click':function(){$this.sendPasswordResetAction(userIds);}}}});};Subaccount.prototype.reopenAction=function(userIds){$this=this;$.ajax({url:$this.commandUrl,type:'POST',data:{'cmd':'reopenSubaccount','accountIds':userIds},dataType:'JSON',beforeSend:function(){$('#confirmModal').find('.btn-success').spin('enable','Reopening...');$('#confirmModal').find('.btn-default').hide();},complete:function(xhr){$('#confirmModal').modal('hide');},success:function(xhr){if(xhr.success){$this.subaccountsCrudApi.setCheckedItems([]);if($this.subaccountsCrudApi.getPaginationApi()){$this.subaccountsCrudApi.getPaginationApi().reload();}
$this.updateFacets();$this.showAjaxAlert('alert alert-success',xhr.message['alert']);}else if(xhr.message['alert']){$this.showAjaxAlert('alert alert-warning',xhr.message['alert']);}},error:function(xhr){$this.showAjaxAlert('alert alert-warning','Sorry, but it looks like something has gone wrong. Please try again or contact us at support@textmagic.com.');}});};Subaccount.prototype.closeAction=function(userIds){$this=this;$.ajax({url:$this.commandUrl,type:'POST',data:{'cmd':'closeSubaccount','accountIds':userIds},dataType:'JSON',beforeSend:function(){$('#confirmModal').find('.btn-danger').spin('enable','Closing...');$('#confirmModal').find('.btn-default').hide();},complete:function(xhr){$('#confirmModal').modal('hide');},success:function(xhr){if(xhr.success){$this.subaccountsCrudApi.setCheckedItems([]);if($this.subaccountsCrudApi.getPaginationApi()){$this.subaccountsCrudApi.getPaginationApi().reload();}
$this.updateFacets();$this.showAjaxAlert('alert alert-success',xhr.message['alert']);}else if(xhr.message['alert']){$this.showAjaxAlert('alert alert-warning',xhr.message['alert']);}},error:function(xhr){$this.showAjaxAlert('alert alert-warning','Sorry, but it looks like something has gone wrong. Please try again or contact us at support@textmagic.com.');}});};Subaccount.prototype.sendPasswordResetAction=function(userIds){$this=this;$.ajax({url:$this.commandUrl,type:'POST',dataType:'JSON',data:{'cmd':'resetPasswordSubaccount','accountIds':userIds},beforeSend:function(){$('#confirmModal').find('.btn-success').spin('enable','Loading...');$('#confirmModal').find('.btn-default').hide();},complete:function(xhr){$('#confirmModal').modal('hide');},success:function(xhr){if(xhr.success){$this.showAjaxAlert('alert alert-success',xhr.message['alert']);}else if(xhr.message['alert']){$this.showAjaxAlert('alert alert-warning',xhr.message['alert']);}},error:function(xhr){$this.showAjaxAlert('alert alert-warning','Sorry, but it looks like something has gone wrong. Please try again or contact us at support@textmagic.com.');}});};Subaccount.prototype.deleteImportSessionBtnClickHandler=function(ids){var $this=this;if(ids===null){ids=$this.subaccountsCrudApi.getCheckedItems();}
var message='Are you sure you would like to delete this file?';var title='Delete file';if($.isArray(ids)&&ids.length>1){message='Are you sure you would like to delete the selected files?';title='Delete files';}
$.confirm({title:title,message:message,buttons:{'cancel':{class:'btn btn-default',text:'Cancel'},'ok':{text:'Delete',class:'btn btn-danger',click:function(){$.ajax({url:$this.commandUrl,type:'POST',dataType:'JSON',data:{'cmd':'removeSubaccountSession','ids':ids},beforeSend:function(){$('#confirmModal').find('.btn-danger').spin('enable','Loading...');$('#confirmModal').find('.btn-default').hide();},complete:function(xhr){$('#confirmModal').modal('hide');},success:function(xhr){if(xhr.success){$this.subaccountsCrudApi.setCheckedItems([]);$this.subaccountsCrudApi.getPaginationApi().reload();$this.updateFacets();$this.showAjaxAlert('alert alert-success','The selected file has been successfully deleted.');}else if(xhr.message['alert']){$this.showAjaxAlert('alert alert-warning',xhr.message);}},error:function(xhr){$this.showAjaxAlert('alert alert-warning','Sorry, but it looks like something has gone wrong. Please try again or contact us at support@textmagic.com.');}});}}}});};Subaccount.prototype.updateFacets=function(){var $this=this;$.ajax({url:$this.commandUrl,type:'POST',data:{cmd:'subaccountFacets'},dataType:'JSON',success:function(xhr){$.each(xhr.data,function(key,value){$('.people-'+key+'-counter').html(value);});},error:function(xhr){}});};var SelectSubaccount=function(options){this.init(options)};SelectSubaccount.prototype.init=function(_options){var that=this;var _default={containerSelector:'#subaccounts-content',paginationCommand:'peopleTable',paginationScroll:false,commandUrl:'/online/account/ajax',itemSelector:'tr[data-widget=subaccount]',searchFormSelector:'#subaccounts-search',beforeReloadFunction:function(api){var requestParams=api.getOptions().requestParams;if(requestParams.hasOwnProperty('params')){requestParams.params=$.extend({},requestParams.params,{type:$(this.containerSelector).data('type')});}else{requestParams.params={type:$(this.containerSelector).data('type')};}
api.setOptions({requestParams:requestParams});}};this.options=$.extend({},_default,_options);this.topAlert=$('[data-widget="top-alert"]');this.initCrudApi();};SelectSubaccount.prototype.initCrudApi=function(){var that=this;this.crudApi=$.prepareCrudPage(that.options);};