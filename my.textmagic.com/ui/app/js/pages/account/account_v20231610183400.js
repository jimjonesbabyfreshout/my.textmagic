var Account=function(){var $this=this;$this.emailConfirmation=new EmailConfirmation();$this.smsConfirmation=new SMSConfirmation();$this.init();$this.updateCredentialsModal.on('hide.bs.modal',function(){$this.updateCredentialsOldPass.val(null);$this.updateCredentialsNewPass.val(null);$this.updateCredentialsNewPassConfirm.val(null);$this.clearAjaxErrors($this.updateCredentialsModal);});$this.editSecurityQuestionModal.on('hide.bs.modal',function(){$this.editSecurityQuestionOldAnswer.val(null);$this.editSecurityQuestionNewAnswer.val(null);$this.clearAjaxErrors($this.editSecurityQuestionModal);});$this.addSecurityQuestionModal.on('hide.bs.modal',function(){$this.addSecurityQuestionAnswer.val(null);$this.clearAjaxErrors($this.addSecurityQuestionModal);});$this.closeAccountModal.on('hide.bs.modal',function(){$this.clearAjaxErrors($this.closeAccountModal);});};Account.prototype.init=function(){this.contactDetailsAlert=$('#updateContactDetailsAlert');this.replyConfirmAlert=$('#replyConfirmAlert');this.billingDetailsAlert=$('#updateBillingDetailsAlert');this.vatInformationAlert=$('#updateVatInformationAlert');this.samlDetailsAlert=$('#updateSamlDetailsAlert');this.securityAlert=$('#securityAlert');this.updateContactDetailsLink=$('#updateContactDetailsLink');this.contactDetailsBlock=$('#contactDetails');this.contactDetailsForm=$('#contactDetailsForm');this.contactDetailsFormPhoneField=$('#contactDetailsForm #form_phone');this.cancelContactDetailsBtn=$('#cancelContactDetailsBtn');this.replyConfirmModal=$('#replyConfirmModal');this.replyConfirmSendSmsAgain=$('#replyConfirmSendSmsAgain');this.replyConfirmMobileCode=$('#replyConfirmMobileCode');this.replyConfirmVerifyNumber=$('#replyConfirmVerifyNumber');this.updateBillingDetailsLink=$('#updateBillingDetailsLink');this.billingDetailsBlock=$('#billingDetails');this.billingDetailsForm=$('#billingDetailsForm');this.cancelBillingDetailsBtn=$('#cancelBillingDetailsBtn');this.updateVatInformationLink=$('#updateVatInformationLink');this.vatBlock=$('#vatBlock');this.vatInformationBlock=$('#vatInformation');this.vatInformationForm=$('#vatInformationForm');this.cancelVatInformationBtn=$('#cancelVatInformationBtn');this.updateSamlDetailsLink=$('#updateSamlDetailsLink');this.samlAddDetailsBtn=$('#samlDetailsBlock [data-widget=cta-button]');this.samlDetailsBlock=$('#samlDetailsBlock');this.samlDetailsForm=$('#samlDetailsForm');this.cancelSamlDetailsBtn=$('#cancelSamlDetailsBtn');this.addSecurityQuestionModal=$('#createQuestionModal');this.addSecurityQuestionForm=$('#addSecurityQuestionForm');this.addSecurityQuestionAnswer=$('#form_answer');this.editSecurityQuestionModal=$('#updateQuestionModal');this.editSecurityQuestionForm=$('#editSecurityQuestionForm');this.editSecurityQuestionOldAnswerId=$('#form_oldAnswerId');this.editSecurityQuestionOldQuestion=$('#form_oldQuestion');this.editSecurityQuestionOldAnswer=$('#form_oldAnswer');this.editSecurityQuestionNewAnswer=$('#form_newAnswer');this.editSecurityQuestionQuestion=$('#form_question');this.editSecurityQuestionNewQuestion=$('#form_newQuestion');this.whitelistIpModal=$('#whitelistIpModal');this.whitelistIpForm=$('#whitelistIpForm');this.updateCredentialsModal=$('#updateCredentialsModal');this.updateCredentialsForm=$('#updateCredentialsForm');this.updateCredentialsOldPass=$('#form_oldPassword');this.updateCredentialsNewPass=$('#form_newPassword_first');this.updateCredentialsNewPassConfirm=$('#form_newPassword_second');this.closeAccountModal=$('#closeAccountModal');this.accessHistoryModal=$('#accessHistoryModal');this.logoutAllModal=$('#logoutAllModal');this.logoutAllBtn=$('[data-widget="logout-all"]');this.closeAccountForm=$('#closeAccountForm');this.emailConfirmationBtn=$('[data-widget=emailConfirm]');this.numberConfirmationBtn=$('[data-widget=numberConfirm]');this.removeSamlSettingsBtn=$('[data-widget=removeSamlSettings]');this.passToggle=$('[data-widget=passToggle]');this.toggleTfa=$('[data-widget=toggle-2fa]');this.sendResetPwdBtn=$('[data-widget=passwordReminder]');this.pleaseFillCorrectMobilePhoneLink=$('#pleaseFillCorrectMobilePhone');this.phoneAccountWrapper=$('#phoneAccountWrapper');this.commandUrl='/online/account/ajax';};Account.prototype.renderListErrors=function(errors){$.each(errors,function(key,value){if(key=='alert'){return true;}
$('[data-field='+key+']').closest('.form-group').addClass('has-error').find('.help-block.error').html(value);});};Account.prototype.clearAjaxErrors=function($el){$el.find('.form-group').removeClass('has-error').find('.help-block.error').empty();}
Account.prototype.loadPhoneAccount=function(callback){var $this=this;$.ajax({url:$this.commandUrl,dataType:'JSON',data:{cmd:'phoneSettingsAccount'},success:function(response){$this.phoneAccountWrapper.html(response.content);callback?callback(response):null;},error:function(){window.location.reload();}});}
Account.prototype.showAjaxAlert=function($el,cls,message){if(cls=='alert alert-success'){return $el.successBlock(message);}
$el.siblings('.alert').remove();$el.removeClass().addClass(cls).show().find('.message').html(message);};Account.prototype.updateDetailsInfo=function(data){var $this=this;$.each(data,function(key,value){if(value===null){value='';}
var $input=$('[data-field='+key+']');if($input.is("select")){$('[data-rel='+key+']').text($input.find('option[value='+value+']').text());}else{switch(key){case 'vatNumber':$('[data-rel='+key+']').text((value?$input.prev('.input-group-addon').text():'')+value);$('[data-field='+key+']').val(value);break;case 'emailAccepted':if(value){$('[data-rel='+key+']').removeClass('label-warning').addClass('label-success').text('VERIFIED');$this.emailConfirmationBtn.hide();$this.emailConfirmation.removeTopAlert();}else{$('[data-rel='+key+']').removeClass('label-success').addClass('label-warning').text('NOT VERIFIED');$this.emailConfirmation.removeTopAlert();$this.emailConfirmation.addTopAlert(data['email']);$this.emailConfirmationBtn.show();$this.emailConfirmationBtn.click();}
break;case 'forceSsoLogin':if(value){$('[data-rel='+key+']').removeClass('label-warning').addClass('label-success').text('SSO ONLY');}else{$('[data-rel='+key+']').removeClass('label-success').addClass('label-warning').text('SSO AND TEXTMAGIC PASSWORD');}
break;case 'showVatBlock':if(value){$this.vatBlock.show();}else{$this.vatBlock.hide();}
break;default:$('[data-rel='+key+']').text(value);}}});if(data['firstName']&&data['lastName']){$('[data-rel=owner]').text(data['firstName']+' '+data['lastName']);}}
Account.prototype.showUpdateForm=function(block,showBlockLink){block.find('.table-responsive').hide();showBlockLink.parent().parent().show();showBlockLink.hide();block.find('.form').show();if(block.find('.no-data').length){block.find('.no-data').hide();}}
Account.prototype.showEmptyBlock=function(block,showBlockLink){if(block.find('.no-data').length){block.find('.table-responsive').hide();block.find('.form').hide();showBlockLink.parent().parent().hide();showBlockLink.hide();block.find('.no-data').show();}}
Account.prototype.hideUpdateForm=function(block,showBlockLink){block.find('.form').hide();block.find('.table-responsive').show();showBlockLink.parent().parent().show();showBlockLink.show();if(block.attr('data-exist')&&block.find('.no-data').length){if(!block.data('exist')){block.find('.table-responsive').hide();showBlockLink.parent().parent().hide();showBlockLink.hide();block.find('.no-data').show();}else{block.find('.no-data').hide();}}else if(block.find('.no-data').length){block.find('.no-data').hide();}}
Account.prototype.updateDetails=function(form,block,alertBlock,showBlockLink){var $this=this;var $data=form.serializeJSON();$data.cmd=form.data('cmd');if(form.data('type')){$data.type=form.data('type');}
$.ajax({url:$this.commandUrl,type:'POST',dataType:'JSON',data:$data,beforeSend:function(){block.find('.btn-success').spin('enable','Saving...');block.find(':button').attr('disabled','disabled');block.find('.form-field').attr('disabled','disabled');block.find('.btn-link').hide();$this.clearAjaxErrors(block);},success:function(xhr){if(xhr.success){if(xhr.data.redirect){$(location).attr('href',xhr.data.redirect);}else{$this.showAjaxAlert(alertBlock,'alert alert-success',xhr.message['alert']);$this.updateDetailsInfo(xhr.data);if(block.find('.no-data').length){block.data('exist',1);}
$this.loadPhoneAccount(function(){block.find('.btn-success').spin('disable');block.find(':button').removeAttr('disabled');block.find('.form-field').removeAttr('disabled');block.find('.btn-link').show();$this.hideUpdateForm(block,showBlockLink);if(xhr.data['phoneAccepted']!==undefined&&!xhr.data['phoneAccepted']&&xhr.data['phone']){$('[data-widget="numberConfirm"]').click();}});}}else{block.find('.btn-success').spin('disable');block.find(':button').removeAttr('disabled');block.find('.form-field').removeAttr('disabled');block.find('.btn-link').show();$this.renderListErrors(xhr.message);if(xhr.message['alert']){$this.showAjaxAlert(alertBlock,'alert alert-warning',xhr.message['alert']);}}},error:function(xhr){$this.showAjaxAlert(alertBlock,'alert alert-warning','Sorry, but it looks like something has gone wrong. Please try again or contact us at support@textmagic.com.');}});}
Account.prototype.switchPassField=function(element){element.closest('div').find('[data-widget=passToggleField]').prop('type',element.is(':checked')?'text':'password');};Account.prototype.switchTwoFactorAuth=function(element){var spinning=element.closest('span');var data={'cmd':'updateTwoFactorAuth','enabled':element.is(':checked')};spinning.spin('enable');element.prop('disabled',true);$.post(this.commandUrl,data).done(function(r){if(r.success){spinning.spin('disable');}else{element.prop('checked',!element.prop('checked'));spinning.spin('disable');}
element.prop('disabled',false);}).fail(function(){spinning.spin('disable');element.prop('checked',!element.prop('checked'));element.prop('disabled',false);});};Account.prototype.updateCredentials=function(){var $this=this;var $data=$this.updateCredentialsForm.serializeJSON();$data.cmd='updateCredentials';$.ajax({url:$this.commandUrl,type:'POST',dataType:'JSON',data:$data,beforeSend:function(){$this.updateCredentialsModal.find('.btn-success').html('Saving...');$this.updateCredentialsModal.find(':button').attr('disabled','disabled');$this.updateCredentialsModal.find('.modal-body').spin('enable');$this.updateCredentialsModal.find('.btn-link').hide();$this.clearAjaxErrors($this.updateCredentialsModal);},complete:function(xhr){$this.updateCredentialsModal.find('.btn-success').html('Save changes');$this.updateCredentialsModal.find(':button').removeAttr('disabled');$this.updateCredentialsModal.find('.modal-body').spin('disable');$this.updateCredentialsModal.find('.btn-link').show();},success:function(xhr){if(xhr.success){$this.updateCredentialsModal.modal('hide');$this.showAjaxAlert($this.securityAlert,'alert alert-success',xhr.message['alert']);}else{$this.renderListErrors(xhr.message);if(xhr.message['alert']){$this.showAjaxAlert($this.securityAlert,'alert alert-warning',xhr.message['alert']);$this.updateCredentialsModal.modal('hide');}}},error:function(xhr){$this.updateCredentialsModal.modal('hide');$this.showAjaxAlert($this.securityAlert,'alert alert-warning','Sorry, but it looks like something has gone wrong. Please try again or contact us at support@textmagic.com.');}});};Account.prototype.addSecurityAnswer=function(){var $this=this;var $data=$this.addSecurityQuestionForm.serializeJSON();$data.cmd='addSecurityQuestion';$.ajax({url:$this.commandUrl,type:'POST',dataType:'JSON',data:$data,beforeSend:function(){$this.addSecurityQuestionModal.find('.btn-success').html('Saving...');$this.addSecurityQuestionModal.find(':button').attr('disabled','disabled');$this.addSecurityQuestionModal.find('.modal-body').spin('enable');$this.addSecurityQuestionModal.find('.btn-link').hide();$this.clearAjaxErrors($this.addSecurityQuestionModal);},complete:function(xhr){$this.addSecurityQuestionModal.find('.btn-success').html('Save changes');$this.addSecurityQuestionModal.find(':button').removeAttr('disabled');$this.addSecurityQuestionModal.find('.modal-body').spin('disable');$this.addSecurityQuestionModal.find('.btn-link').show();},success:function(xhr){if(xhr.success){$this.addSecurityQuestionModal.modal('hide');$(location).attr('href',xhr.data.redirect);}else{$this.renderListErrors(xhr.message);if(xhr.message['alert']){$this.showAjaxAlert($this.securityAlert,'alert alert-warning',xhr.message['alert']);$this.addSecurityQuestionModal.modal('hide');}}},error:function(xhr){$this.addSecurityQuestionModal.modal('hide');$this.showAjaxAlert($this.securityAlert,'alert alert-warning','Sorry, but it looks like something has gone wrong. Please try again or contact us at support@textmagic.com.');}});};Account.prototype.editSecurityQuestionUpdateDetails=function(questionId,answerId,target){var that=this;this.editSecurityQuestionNewQuestion.find('option').show();$('[data-question-id]').not($(target)).each(function(k,v){that.editSecurityQuestionNewQuestion.find('option[value="'+$(v).data('question-id')+'"]').hide();that.editSecurityQuestionNewQuestion.val(that.editSecurityQuestionNewQuestion.children('option').not('[style*="display: none"]').first().val());that.editSecurityQuestionNewQuestion.trigger('chosen:updated');});this.editSecurityQuestionOldQuestion.val(questionId).trigger('chosen:updated');this.editSecurityQuestionOldAnswerId.val(answerId);};Account.prototype.addSecurityQuestionUpdateDetails=function(){var that=this;this.editSecurityQuestionQuestion.find('option').show();$('[data-question-id]').each(function(k,v){that.editSecurityQuestionQuestion.find('option[value="'+$(v).data('question-id')+'"]').hide();that.editSecurityQuestionQuestion.val(that.editSecurityQuestionQuestion.children('option').not('[style*="display: none"]').first().val());});}
Account.prototype.editSecurityAnswer=function(){var $this=this;var $data=$this.editSecurityQuestionForm.serializeJSON();$data.cmd='editSecurityQuestion';$.ajax({url:$this.commandUrl,type:'POST',dataType:'JSON',data:$data,beforeSend:function(){$this.editSecurityQuestionModal.find('.btn-success').html('Saving...');$this.editSecurityQuestionModal.find(':button').attr('disabled','disabled');$this.editSecurityQuestionModal.find('.modal-body').spin('enable');$this.editSecurityQuestionModal.find('.btn-link').hide();$this.clearAjaxErrors($this.editSecurityQuestionModal);},complete:function(xhr){$this.editSecurityQuestionModal.find('.btn-success').html('Save changes');$this.editSecurityQuestionModal.find(':button').removeAttr('disabled');$this.editSecurityQuestionModal.find('.modal-body').spin('disable');$this.editSecurityQuestionModal.find('.btn-link').show();},success:function(xhr){if(xhr.success){$this.editSecurityQuestionModal.modal('hide');$(location).attr('href',xhr.data.redirect);}else{$this.renderListErrors(xhr.message);if(xhr.message['alert']){$this.showAjaxAlert($this.securityAlert,'alert alert-warning',xhr.message['alert']);$this.editSecurityQuestionModal.modal('hide');}}},error:function(xhr){$this.editSecurityQuestionModal.modal('hide');$this.showAjaxAlert($this.securityAlert,'alert alert-warning','Sorry, but it looks like something has gone wrong. Please try again or contact us at support@textmagic.com.');}});};Account.prototype.editWhitelistIp=function(){var $this=this;var $data=$this.whitelistIpForm.serializeJSON();$data.cmd='editWhitelistIp';$.ajax({url:$this.commandUrl,type:'POST',dataType:'JSON',data:$data,beforeSend:function(){$this.whitelistIpModal.find('.btn-success').html('Saving...');$this.whitelistIpModal.find(':button').attr('disabled','disabled');$this.whitelistIpModal.find('.modal-body').spin('enable');$this.whitelistIpModal.find('.btn-link').hide();$this.clearAjaxErrors($this.whitelistIpModal);},complete:function(xhr){$this.whitelistIpModal.find('.btn-success').html('Save changes');$this.whitelistIpModal.find(':button').removeAttr('disabled');$this.whitelistIpModal.find('.modal-body').spin('disable');$this.whitelistIpModal.find('.btn-link').show();},success:function(xhr){if(xhr.success){$this.whitelistIpModal.modal('hide');$(location).attr('href',xhr.data.redirect);}else{$this.renderListErrors(xhr.message);if(xhr.message['alert']){$this.showAjaxAlert($this.securityAlert,'alert alert-warning',xhr.message['alert']);$this.whitelistIpModal.modal('hide');}}},error:function(xhr){$this.whitelistIpModal.modal('hide');$this.showAjaxAlert($this.securityAlert,'alert alert-warning','Sorry, but it looks like something has gone wrong. Please try again or contact us at support@textmagic.com.');}});};Account.prototype.closeAccount=function(){var $this=this;var $data=$this.closeAccountForm.serializeJSON();$data.cmd='closeAccount';$.ajax({url:$this.commandUrl,type:'POST',dataType:'JSON',data:$data,beforeSend:function(){$this.closeAccountModal.find('.btn-danger').html('Loading...');$this.closeAccountModal.find(':button').attr('disabled','disabled');$this.closeAccountModal.find('.modal-body').spin('enable');$this.closeAccountModal.find('.btn-link').hide();$this.clearAjaxErrors($this.closeAccountModal);},complete:function(xhr){$this.closeAccountModal.find('.btn-danger').html('Close account');$this.closeAccountModal.find(':button').removeAttr('disabled');$this.closeAccountModal.find('.modal-body').spin('disable');$this.closeAccountModal.find('.btn-link').show();},success:function(xhr){if(xhr.success){$this.closeAccountModal.modal('hide');$(location).attr('href',xhr.data.redirect);}else{$this.renderListErrors(xhr.message);if(xhr.message['alert']){$this.showAjaxAlert($this.securityAlert,'alert alert-warning',xhr.message['alert']);$this.closeAccountModal.modal('hide');}}},error:function(xhr){$this.closeAccountModal.modal('hide');$this.showAjaxAlert($this.securityAlert,'alert alert-warning','Sorry, but it looks like something has gone wrong. Please try again or contact us at support@textmagic.com.');}});};Account.prototype.removeSamlSettings=function(){var $this=this;$.confirm({title:'Disable SSO feature',message:'You are going to disable your Single Sign-On feature. No accounts will be able to log in using SSO anymore. '+
'Are you sure you would like to disable this feature?',buttons:{'cancel':{text:'Cancel','class':'btn btn-default'},'ok':{text:'Disable','class':'btn btn-danger',click:function(){var $thatModal=$(this);var $btn=$thatModal.find('button.btn-danger');$btn.spin('enable','Disabling...');var addOptions={cmd:'updateSamlSettings',remove:1};$.post($this.commandUrl,addOptions).done(function(r){if(r.success==true){$this.showAjaxAlert($this.samlDetailsAlert,'alert alert-success',r.message['alert']);}else{$this.showAjaxAlert($this.samlDetailsAlert,'alert alert-warning','Sorry, but it looks like something has gone wrong. Please try again or contact us at support@textmagic.com.');}
$btn.spin('disable');$thatModal.modal('hide');$this.samlDetailsForm.find('.form-field:not([type="radio"])').each(function(){$(this).val('');});$this.samlDetailsForm.find("input:radio").attr("checked",false);$this.samlDetailsBlock.data('exist',0);$this.showEmptyBlock($this.samlDetailsBlock,$this.updateSamlDetailsLink);}).fail(function(){$btn.spin('disable');$thatModal.modal('hide');$this.showAjaxAlert($this.samlDetailsAlert,'alert alert-warning','Sorry, but it looks like something has gone wrong. Please try again or contact us at support@textmagic.com.');});}}}});};Account.prototype.logoutAllBtnClickHandler=function(){var that=this;$.confirm({title:'Log out from all devices',message:'You will be logged out and will have to re-enter your password to log in again on all devices except this one. '+
'Are you sure you would like to proceed?',buttons:{'cancel':{text:'Cancel','class':'btn btn-default'},'ok':{text:'Log out','class':'btn btn-danger',click:function(){var $modal=$(this),$btn=$modal.find('button.btn-danger');$.ajax({url:that.commandUrl,dataType:'JSON',method:'POST',data:{cmd:'logoutAll'},beforeSend:function(){$btn.spin('enable','Logging out...');},success:function(xhr){if(xhr.success){that.showAjaxAlert(that.securityAlert,'alert alert-success',xhr.message['alert']);}else{console.log(xhr);}
return;},error:function(xhr){console.warn(xhr);},complete:function(xhr){$btn.spin('disable');$modal.modal('hide');}});}}}});};Account.prototype.sendResetPwdConfirm=function(userIds){var $this=this;$.confirm({'title':'Reset account password','message':'Are you sure you want to reset your account password?','buttons':{'cancel':{'text':'Cancel','class':'btn btn-default'},'Yes':{'text':'Reset password','class':'btn btn-success btn-solid','click':function(){$this.sendPasswordResetAction(userIds);}}}});};Account.prototype.sendPasswordResetAction=function(userIds){$this=this;$.ajax({url:$this.commandUrl,type:'POST',dataType:'JSON',data:{'cmd':'resetPasswordSubaccount','accountIds':userIds},beforeSend:function(){$('#confirmModal').find('.btn-success').spin('enable','Loading...');$('#confirmModal').find('.btn-default').hide();},complete:function(xhr){$('#confirmModal').modal('hide');},success:function(xhr){if(xhr.success){$this.securityAlert.successBlock(xhr.message['alert']);}else if(xhr.message['alert']){$this.securityAlert.warningBlock(xhr.message['alert']);}},error:function(xhr){$this.securityAlert.warningBlock('Sorry, but it looks like something has gone wrong. Please try again or contact us at support@textmagic.com.');}});};