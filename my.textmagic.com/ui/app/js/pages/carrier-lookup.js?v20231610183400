;var CarrierLookup=function(options){this.initControls();this.initEventHandlers();this.phoneColumnInx=-1;this.progress=0;this.estimated=0;this.interval=5;};CarrierLookup.prototype.initControls=function(options){this.controls={};var that=this;var c=this.controls;c.btnSubmitFirst=$(‘button#firstSubmitBtn’);c.btnSubmitSecond=$(‘button#settingsSubmitBtn’);c.btnSubmitStart=$(‘#startSubmitBtn’);c.btnImportToContacts=$(‘#btn-import-to-contacts’);c.btnDownloadCsv=$(‘#btn-download-csv’);c.btnFinish=$(‘#btn-finish’);c.formUpload=$(‘form#uploadForm’);c.formSettings=$(‘form#settingsForm’);c.formPrivew=$(‘form#previewForm’);c.progressForm=$(‘form#progressForm’);c.progressBar=$(‘[role=“progressbar”]’);c.inputIsSingleCountry=$(‘input[name=“isSingleCountry”]’);c.inputSource=$(‘input[name=“import_contact[source]”]’);c.lookupId=$(‘input.lookup_id’);c.inputPhoneColumnInx=$(‘#phoneColumnInx’);c.panelCountrySelect=$(‘#panel-country-select’);c.panelPreviewTable=$(‘#table-import’);c.panelClipboardInput=$(‘#clipboarddiv’);c.panelFileInput=$(‘#filediv’);c.panelPreview=$(‘#preview-panel’);c.panelSuccesBtns=$(‘.btn-panel’);c.panelTabStep1=$(‘#carrierLookupFileContent’);c.panelTabStep2=$(‘#carrierLookupSettings’);c.panelTabStep3=$(‘#3’);c.panelTabStep4=$(‘#4’);c.panelAlert=$(‘#carrier-lookup-alert’);c.panelAlertSuccess=$(‘#carrier-lookup-success’);c.labelFileSize=$(‘.label-file-size’);c.labelFileName=$(‘.label-file-name’);c.labelLinesCount=$(‘.label-lines-count’);c.labelPrice=$(‘#label-price’);c.labelCost=$(‘#label-cost’);c.labelCostFinish=$(‘#label-cost-finish’);c.labelEstimatedTime=$(‘#label-estimated-time’);c.labelImportStatus=$(‘#import-status’);c.formUpload.clearErrors=function(){c.formUpload.find(‘div.form-group.has-error’).removeClass(‘has-error’).find(‘span.help-block:not(.static)’).remove();};c.formUpload.renderErrors=function(r){$.each(r.message,function(key,msg){$el=$(‘input#’+key+’, textarea#’+key);$el.after(‘<span class=“help-block col-sm-12”>’+msg+’</span>’).closest(‘div.form-group’).addClass(‘has-error’);});};c.panelPreviewTable.clear=function(){c.panelPreviewTable.find(‘thead’).empty();c.panelPreviewTable.find(‘tbody’).empty();};c.progressBar.setSpeed=function(s){c.progressBar.removeClass(‘pb-speed-5 pb-speed-1’).css(‘transition-duration’,s);};c.progressBar.drawProgress=function(p){c.progressBar.css(‘width’,Math.round(that.progress)+’%’);c.progressBar.find(‘span[data-widget=“percent”]’).text(Math.round(that.progress)+’%’);}};CarrierLookup.prototype.formSubmit=function(form,options){form.ajaxSubmit({url:form.attr(‘action’),type:’POST’,dataType:’JSON’,data:{},beforeSubmit:options.before,success:options.success,error:options.error});};CarrierLookup.prototype.initEventHandlers=function(options){var c=this.controls;var that=this;$(document).on(‘change’,’select.mask-field’,function(){var colInx=$(this).closest(‘th’).index();that.selectColumn(colInx)});c.inputIsSingleCountry.click(function(){c.panelCountrySelect.toggleClass(‘hidden’,$(this).val()!=‘single’);});c.inputSource.on(‘change’,function(){if(this.value===“file”){c.panelClipboardInput.hide();c.panelFileInput.show();}
if(this.value===“clipboard”){c.panelFileInput.hide();c.panelClipboardInput.show();}});c.btnSubmitFirst.click(function(e){e.preventDefault();e.stopPropagation();that.formSubmit(c.formUpload,{before:function(){c.formUpload.clearErrors();c.btnSubmitFirst.spin(‘enable’);},success:function(response){c.btnSubmitFirst.spin(‘disable’);if(!response.success){if(response.message){c.panelAlert.warningBlock(response.message);}else{c.formUpload.renderErrors(response);}
return;}
c.lookupId.val(response.data.lookupId);c.formUpload.clearErrors();c.btnSubmitFirst.tab(“show”);},error:function(response){if(response.status===413){c.formUpload.renderErrors({message:{file:”The maximum allowed file size is 20MB.”}});c.btnSubmitFirst.spin(‘disable’);}}});});c.btnSubmitSecond.click(function(e){e.preventDefault();e.stopPropagation();that.formSubmit(c.formSettings,{before:function(){c.btnSubmitSecond.spin(‘enable’);},success:function(response){var d=response.data;c.btnSubmitSecond.spin(‘disable’);if(!response.success){return;}
that.phoneColumnInx=d.phoneColumnInx<0?0:d.phoneColumnInx;c.panelPreview.toggle(!d.colFound);c.labelFileSize.text(d.fileSize);c.labelFileName.text(d.originalName);c.labelLinesCount.text(d.linesCount);c.labelPrice.text(d.price);c.labelCost.text(d.cost);c.labelCostFinish.text(d.cost);c.labelEstimatedTime.text(d.estimatedTime);that.estimated=d.estimatedSeconds<that.interval*2?that.interval*2:d.estimatedSeconds;that.buildPreviewTable(d.previewData);c.btnSubmitSecond.tab(“show”);}});});c.btnSubmitStart.click(function(e){e.preventDefault();e.stopPropagation();that.formSubmit(c.formPrivew,{before:function(){c.btnSubmitStart.spin(‘enable’);c.panelAlert.hide();},success:function(response){c.btnSubmitStart.spin(‘disable’);if(!response.success){if(response.message){c.panelAlert.warningBlock(response.message);}
return;}
c.btnSubmitStart.tab(“show”);c.progressBar.setSpeed(“2s”);that.timer=setInterval(function(){that.progress=that.progress+100/that.estimated;if(that.progress>=95){that.progress=95;}
c.progressBar.drawProgress();},1000);that.checkProgress();}});});};CarrierLookup.prototype.checkProgress=function(){var c=this.controls;var that=this;that.formSubmit(c.progressForm,{before:function(){},success:function(response){if(!response.success){if(response.message){c.panelAlert.warningBlock(response.message);}
return;}
if(response.data.status!=1){setTimeout(function(){that.checkProgress()},that.interval*1000);return;}
clearInterval(that.timer);that.progress=100;c.btnDownloadCsv.attr(‘href’,response.data.download);var hrefTemplate=c.btnImportToContacts.attr(‘href’);c.btnImportToContacts.attr(‘href’,hrefTemplate.replace(encodeURIComponent(‘{lookupId}’),response.data.lookupId));c.btnFinish.removeClass(‘disabled’);c.progressBar.setSpeed(“0.5s”);c.progressBar.drawProgress();c.labelImportStatus.html(‘<span class=“label label-success”>COMPLETED</span>’);setTimeout(function(){c.progressForm.hide();c.panelAlertSuccess.successBlock(“Carrier lookup completed successfully.”);c.panelSuccesBtns.removeClass(‘hidden’);},1000);}});};CarrierLookup.prototype.renderHeaderTh=function(inx,selected){return ‘<th class=“’+(!selected?’warning has-error’:’’)+’”>’+
‘<select class=“form-control mask-field” name=“import_preview[mask][‘+inx+’]”>’+
‘    <option ‘+(selected?’’:’selected’)+’ value=“0”>Do not check</option>’+
‘    <option ‘+(selected?’selected’:’’)+’ value=“1”>Phone number</option>’+
‘</select></th>’;};CarrierLookup.prototype.selectColumn=function(inx){var c=this.controls;var tblBody=c.panelPreviewTable.find(“tbody”);var tblHead=c.panelPreviewTable.find(“thead”);this.phoneColumnInx=inx;if(this.phoneColumnInx===-1)return;c.inputPhoneColumnInx.val(inx);var myCol=inx+1;tblBody.find(‘tr td’).removeClass(‘selected-col’);tblBody.find(‘tr td:nth-child(‘+myCol+’)’).addClass(‘selected-col’);tblHead.find(‘tr th select’).val(0);tblHead.find(‘tr th’).addClass(‘warning has-error’);tblHead.find(‘tr th:nth-child(‘+myCol+’)’).removeClass(‘warning has-error’);tblHead.find(‘tr th:nth-child(‘+myCol+’) select’).val(1);};CarrierLookup.prototype.buildPreviewTable=function(data){var that=this;var c=this.controls;c.panelPreviewTable.clear();var tblBody=c.panelPreviewTable.find(“tbody”);var tblHead=c.panelPreviewTable.find(“thead”);tblHead.append($(“<tr>”));$.each(data[0],function(index,cell){tblHead.find(“tr:last”).append(that.renderHeaderTh(index,that.phoneColumnInx==index));});$.each(data,function(index,row){tblBody.append($(“<tr>”));$.each(row,function(index,cell){tblBody.find(“tr:last”).append($(“<td>”,{text:cell?cell:’’}));});});c.panelPreviewTable.find(‘tr td’).click(function(){that.selectColumn($(this).index());});that.selectColumn(that.phoneColumnInx);};;var CarrierLookupSession=function(options){this.crudApi=null;this.init(options);};CarrierLookupSession.prototype.initCrudApi=function(){var $this=this;this.crudApi=$.prepareCrudPage({containerSelector:’#carrier-lookup-container’,itemSelector:’tr[data-widget=carrier_lookup]’,paginationCommand:’table’,searchFormSelector:’#import-sessions-search’,commandUrl:$this.commandUrl,direction:’desc’});};CarrierLookupSession.prototype.init=function(options){this.deleteBtn=‘[data-widget=“delete”]’;this.topAlert=$(‘[data-widget=“top-alert”]’);this.topDelBtn=$(‘#removeCheckedRows’);this.commandUrl=options.cmdUrl;this.initCrudApi();};CarrierLookupSession.prototype.deleteBtnClickHandler=function(ids){var that=this;if(ids===null){ids=this.crudApi.getCheckedItems();}
var message=‘Are you sure you would like to delete this file?’;var title=‘Delete file’;if($.isArray(ids)&&ids.length>1){message=‘Are you sure you would like to delete the selected files?’;title=‘Delete files’;}
$.confirm({title:title,message:message,buttons:{‘cancel’:{class:’btn btn-default’,text:’Cancel’},’ok’:{text:’Delete’,class:’btn btn-danger’,click:function(){var _this=this;var $deleteBtn=$(this).find(‘button.btn-danger’);var $cancelBtn=$deleteBtn.siblings(‘[data-dismiss]’);var callback=function(r){$(_this).modal(‘hide’);$deleteBtn.spin(‘disable’);that.crudApi.setCheckedItems([]);that.crudApi.getPaginationApi().reload();if(r.success){that.topAlert.successBlock(‘The selected file has been successfully deleted.’);that.updateCount();}else{that.topAlert.warningBlock(r.message);}
$cancelBtn.btn(‘disable’);};$deleteBtn.spin(‘enable’,’Deleting...’);$cancelBtn.btn(‘disable’);$.ajax({url:that.commandUrl,type:’POST’,data:{cmd:’remove’,ids:ids},dataType:’JSON’,success:function(xhr){callback(xhr);},error:function(xhr){that.topAlert.dangerBlock(‘Sorry, but it looks like something has gone wrong. Please try again or contact us at support@textmagic.com’);$(_this).modal(‘hide’);$deleteBtn.spin(‘disable’);$cancelBtn.btn(‘enable’);}});}}}});};var CarrierLookupSingle=function(options){this.init(options);};CarrierLookupSingle.prototype.init=function(options){this.form=$(‘form#single-lookup-form’);this.btnSubmit=$(‘[data-widget=“lookup-submit”]’);this.container=$(‘#single-result-container’);this.btnReset=$(‘[data-widget=“lookup-reset”]’);this.codes=options.codes;this.excludeSearchCountries=options.excludeSearchCountries;this.initEventListeners();this.initSelect2();};CarrierLookupSingle.prototype.initSelect2=function(){var that=this,formatState=function(state){if(!state.id){return state.text;}
var $state=jQuery(‘<span><img src=“/vendor/textmagic-ui/marketing/images/flags/24/‘+state.element.value.toUpperCase()+’.png” class=“img-flag” /> ‘
+state.text
+’</span>’);return $state;};this.form.find(“select[name=‘country’]”).each(function(){$(this).select2({templateResult:formatState,templateSelection:formatState,width:’100%’,height:’40px’});});};CarrierLookupSingle.prototype.initEventListeners=function(){var that=this;this.form.on(‘submit’,function(e){e.preventDefault();that.btnSubmitClickHandler();});this.btnReset.on(‘click’,function(e){e.preventDefault();that.btnResetClickHandler();});this.form.find(‘input[name=“phone”]’).on(‘keyup’,function(){that.inputKeyupHandler($(this));});};CarrierLookupSingle.prototype.btnResetClickHandler=function(){var $inp=this.form.find(‘input[data-field=“lookup-phone”]’);$inp.parent().parent().removeClass(‘has-error’);$inp.parent().find(‘.help-block.error’).remove();this.form[0].reset();this.container.html(‘’);};CarrierLookupSingle.prototype.inputKeyupHandler=function($inp){var that=this,text=$inp.val();if(text.substring(0,1)!=‘+’){return true;}
for(var c in that.codes){if(!that.codes.hasOwnProperty(c)){continue;}
var v=that.codes[c];if(text.substring(1,v.length+1)==v&&that.excludeSearchCountries.indexOf(c)==-1){that.form.find(‘select[name=“country”]’).val(c).change();break;}}};CarrierLookupSingle.prototype.btnSubmitClickHandler=function(){var that=this,url=that.form.attr(‘action’),$input=that.form.find(‘input[data-field=“lookup-phone”]’),$select=that.form.find(‘select[name=“country”]’),data={‘phone’:$input.val(),’country’:$select.val()};$input.parent().parent().removeClass(‘has-error’);$input.parent().find(‘.help-block.error’).remove();if($input.val().trim().length===0){parseAllErrors({‘lookup-phone’:’This field cannot be left blank’});return false;}
$.ajax({url:url,dataType:’HTML’,method:’POST’,data:data,beforeSend:function(){that.btnSubmit.spin(‘enable’);},success:function(xhr){that.container.html(xhr);return;},error:function(xhr){console.warn(xhr);},complete:function(xhr){that.btnSubmit.spin(‘disable’);}});};