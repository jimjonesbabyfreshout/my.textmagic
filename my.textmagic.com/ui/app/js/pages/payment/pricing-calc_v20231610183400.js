var Calc=function(){var $this=this;$this.init();$(document.body).on('change',$this.countrySelect,function(){$this.changeCountryHandler(this);});$(document.body).on('input','td#msgCount > input',function(){$this.changeCountHandler(this);});$(document.body).on('keydown','td#msgCount > input',function(e){$this.filterNumeric(e);});$this.addCountryLnk.on('click',function(){var $tr=$(this).closest('tr');$this.fieldInsert($tr.prev(),$tr);});$(document.body).on('click',$this.removeTrLnk,function(){var $tr=$(this).closest('tr');$this.removeClosestTr($tr);});};Calc.prototype.init=function(){this.countrySelect='#countryPricingTable .chosen-select';this.pricingTable=$('#countryPricingTable');this.totalTr='#priceCalcTotal';this.removeTrLnk='a#removeTrLnk';this.calcModal=$('#priceCalcModal');this.pricingCalcLnk=$('a#pricingCalcLnk');this.currencySymbol=$.parseJSON(currencySymbol);this.selectPriceBtn=$('a#selectPriceBtn');this.bundleSelect=$('select[data-field="price"]');this.totalAmountSpan=$('tr#priceCalcTotal span');this.addCountryLnk=$('tr#priceCalcTotal > td > a#addCountryLnk');this.nearestBundleSpan=$('p.total-line b');this.calculatorData=$.parseJSON(calculatorData);this.priceBundlesFormatted=$.parseJSON(priceBundles);this.priceBundles=this.convertPriceBundles(priceBundles);this.closestBundleIndex=-1;this.selectCountryHtml=$('td#tdCountry').html();this.countrySequenceObj=['GB','US','AU','DE','FR','IE','FI','SE','IT'];this.updateHandler=function(){return true;}};Calc.prototype.setNearestBundle=function(){this.calcModal.modal('hide');this.bundleSelect.val(this.closestBundleIndex);this.bundleSelect.change();};Calc.prototype.removeClosestTr=function($tr){var trLength=this.pricingTable.find('tbody > tr').length-1;if(trLength<=1){return false;}
$tr.remove();this.updateTotalNumbers();this.findClosestBundle();this.updateHandler();};Calc.prototype.convertPriceBundles=function(priceBundles){var priceBundles=$.parseJSON(priceBundles);$.each(priceBundles,function(index,value){priceBundles[index]=parseFloat(value.replace(/[^\d\.\-\ ]/g,'',''));});return priceBundles;};Calc.prototype.updateNumbers=function($tr,msgPrice,msgCount){var msgPriceSpan=$tr.find('td#msgPrice > span');var msgAmountSpan=$tr.find('td#msgAmount > span');msgPriceSpan.text(msgPrice.toFixed(3));msgAmountSpan.text((msgPrice*msgCount).formatMoney(2,'.',','));this.updateTotalNumbers();this.findClosestBundle();this.updateHandler();};Calc.prototype.findClosestBundle=function(){var totalAmount=parseFloat(this.totalAmountSpan.text().replace(/[^\d\.\-\ ]/g,'',''));var i=-1;var prices=[];$.each(this.priceBundles,function(key,value){prices.push({id:key,bundle:value});});prices.sort(function(a,b){return a.bundle-b.bundle;});$.each(prices,function(index,value){if(value.bundle/totalAmount>=1){i=value.id;return false;}else{i=value.id;}});var closestBundle=this.priceBundlesFormatted[i];this.closestBundleIndex=i;this.nearestBundleSpan.text(closestBundle);};Calc.prototype.changeCountryHandler=function(el){var selectedCountry=$(el).val();var $tr=$(el).closest('tr');var msgPrice=parseFloat(this.calculatorData[selectedCountry].price);var msgCount=parseInt($tr.find('td#msgCount > input').val());this.updateNumbers($tr,msgPrice,msgCount);};Calc.prototype.changeCountHandler=function(el){var $tr=$(el).closest('tr');var msgPrice=parseFloat($tr.find('td#msgPrice > span').text());var msgCount=$(el).val();this.updateNumbers($tr,msgPrice,msgCount);};Calc.prototype.fieldInsert=function(el){var lineHtml='<tr>'+
'<td>'+
this.selectCountryHtml+
'</td>'+
'<td class="text-center hidden-xs" id="msgPrice">'+this.currencySymbol+'<span></span></td>'+
'<td class="text-center" id="msgCount"><input class="form-control" type="text" value="1000" maxlength="6"></td>'+
'<td class="text-right" id="msgAmount">'+this.currencySymbol+'<span></span></td>'+
'<td class="text-right"><a href="javascript:void(0);" title="Remove this country" id="removeTrLnk" class="btn btn-aslink"><i class="fa fa-times text-muted"></i></a></td>'+
'</tr>';fieldInseart(lineHtml,this.totalTr);var lastTr=$(this.totalTr).prev().find('select.chosen-select');var seq=parseInt(this.pricingTable.find('tbody > tr').length-3)%this.countrySequenceObj.length;lastTr.val(this.countrySequenceObj[seq]);lastTr.change();lastTr.select2({width:'100%'});this.updateTotalNumbers();};Calc.prototype.updateTotalNumbers=function(){var total=0;this.pricingTable.find('td#msgAmount > span').each(function(){total+=parseFloat($(this).text().replace(/[^\d\.\-\ ]/g,'',''));});this.totalAmountSpan.text(total.formatMoney(2,'.',','));};Calc.prototype.filterNumeric=function(event){if($.inArray(event.keyCode,[46,8,9,27,13])!==-1||(event.keyCode==65&&event.ctrlKey===true)||(event.keyCode>=35&&event.keyCode<=39)){return;}
else{if(event.shiftKey||(event.keyCode<48||event.keyCode>57)&&(event.keyCode<96||event.keyCode>105)){event.preventDefault();}}};