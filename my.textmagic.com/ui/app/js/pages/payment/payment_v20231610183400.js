const PAY_AS_YOU_GO_BILLING_TYPE='pay_as_you_go_type';const MONTHLY_PLAN_BILLING_TYPE='monthly_billing_plan_type';var Payment=function(priceData,tmBankNewMethodId,showAutorechargeBlock,isVatExempt,isCountryInEU,monthlyBillingPlansViewData,selectedPlanId){var $this=this;$this.isVatExempt=isVatExempt;$this.isCountryInEU=isCountryInEU;$this.priceData=priceData;$this.monthlyBillingPlansViewData=monthlyBillingPlansViewData;$this.tmBankNewMethodId=tmBankNewMethodId;$this.isAutorechargeBlockAvailable=showAutorechargeBlock;$this.init();if(!showAutorechargeBlock){$this.hideAutorechargeBlock();}
$this.newMethodItems.find('input:radio').on('click',function(e){if($(this).val()==tmBankNewMethodId){$this.paymentBtn.text('Request Invoice').css('padding','');}else{$this.paymentBtn.html('<i class="fa fa-lock"></i> Pay Now').css('padding','0px 60px');}
$this.newMethodItems.find('.detail-block :input').each(function(){$(this).attr('disabled','disabled');});$(this).closest('.list-group-item').find('.detail-block :input').each(function(){$(this).removeAttr('disabled');});});$this.methodItems.find('input:radio').on('click',function(e){$this.paymentBtn.html('<i class="fa fa-lock"></i> Pay Now').css('padding','0px 60px');$this.newMethodItems.find('.detail-block :input').each(function(){$(this).attr('disabled','disabled');});});$($this.removePaymentMethodBtn).on('click',function(e){e.preventDefault();var methodId=$(this).parents('.list-group-item').find('span.check-item > :input').val();$this.removePaymentMethodConfirm(methodId);});$this.initSubmitForm();if(selectedPlanId){$this.updatePriceInfo(MONTHLY_PLAN_BILLING_TYPE);}else{$this.selectFirstActualItem();$this.updatePriceInfo(PAY_AS_YOU_GO_BILLING_TYPE);}
if(monthlyBillingPlansViewData){$this.initSelectBillingTypeAction();$this.initSelectMonthlyBillingPlanAction();$this.initBillingTooltipVisibility();}};Payment.prototype.init=function(){this.form=$('#paymentForm');this.alert=$('#payment-alert');this.paymentVatRate=$('#paymentVatRate');this.paymentVatValue=$('#paymentVatValue');this.paymentTotalValue=$('#paymentTotalValue');this.autorechargeBlock=$('.auto-recharge-block-wrapper');this.autorechargeTrigger=$("input[data-field='autoRecharge']");this.autorechargeMinBalance=$('#autorechargeMinBalance');this.autorechargeValue=$('#autorechargeValue');this.paymentTopupValue=$('#paymentTopupValue');this.paymentMethodsContainer=$('#payment-methods-content');this.removePaymentMethodBtn='[data-widget=removePaymentMethod]';this.methodItems=$('.methods-block .list-group-item.method-item');this.newMethodItems=$('.methods-block .list-group-item.new-method-item');this.addItem=$('.methods-block .list-group-item.add-item');this.backItem=$('.methods-block .list-group-item.back-item');this.billingDetailsInfoTrigger=$('.billing-details-block.block-trigger');this.billingDetailsInfoBlock=$('.billing-details-block.info-block');this.billingDetailsFormBlock=$('.billing-details-block.form-block');this.vatInfoTrigger=$('.vat-block.info-block .block-trigger');this.vatInfoBlock=$('.vat-block.info-block');this.vatFormBlock=$('.vat-block.form-block');this.vatItems=$('.vat-block .list-group-item.js-group-item');this.priceInfoBlock=$('.credit-total-table');this.paymentBtn=$('#paymentBtn');this.price=$('#form_price');this.vatNumber=$('#form_vatNumber');this.price.data('value',this.price.val());this.commandUrl='/payment/ajax';this.billingTypesBlock=$('#billing_types_block');this.monthlyBillingPlansBlock=$('#monthly_billing_plans_block');this.creditAmountBlock=$('#credit_amount_block');this.billingTypesPaymentDataBlock=$('#billing_types_payment_data_block');this.billintType=$('#form_billingType');this.billingQuestion=$('.billing-plans__advantages em.fa-question-circle');};Payment.prototype.renderAjaxErrors=function(errors){var $this=this;$.each(errors,function(key,value){key=(key.split('-').length>1?key.split('-')[1]:key);switch(key){case 'number':$('.ccjs-number-formatted').addClass('ccjs-error').closest('.form-group').addClass('has-error').find('.help-block.error').html(value);break;case 'verification_value':$('.ccjs-csc').closest('.form-group').addClass('has-error');break;case 'full_name':$('.ccjs-name').closest('.form-group').addClass('has-error');break;case 'month':$('.ccjs-expiration').addClass('ccjs-error');$('.ccjs-month').closest('.form-group').addClass('has-error');break;case 'year':$('.ccjs-expiration').addClass('ccjs-error');$('.ccjs-year').closest('.form-group').addClass('has-error');break;case 'paymentMethod':$this.showAjaxAlert(value);$("html, body").animate({scrollTop:0},"slow");break;case 'alert':return true;break;default:$('[data-field='+key+']').closest('.form-group').addClass('has-error').find('.help-block.error').html(value);}});};Payment.prototype.clearAjaxErrors=function(){$('.ccjs-card').find('.ccjs-error').removeClass('ccjs-error');$('.form-group').removeClass('has-error').find('.help-block.error').empty();};Payment.prototype.showAjaxAlert=function(message){this.alert.show().find('.message').html(message);};Payment.prototype.hideAjaxAlert=function(){this.alert.hide().find('.message').html('');};Payment.prototype.selectFirstActualItem=function(){if(this.methodItems.length>0){this.methodItems.first().find('input:radio').trigger('click');}}
Payment.prototype.showAutorechargeBlock=function(){this.autorechargeBlock.show();this.autorechargeTrigger.removeAttr('disabled');}
Payment.prototype.hideAutorechargeBlock=function(){this.autorechargeBlock.hide();this.autorechargeTrigger.attr('disabled','disabled');}
Payment.prototype.showMonthlyBillingPlansBlock=function(){this.monthlyBillingPlansBlock.show();}
Payment.prototype.hideMonthlyBillingPlansBlock=function(){let $this=this,$activeBillingPLan=$this.monthlyBillingPlansBlock.find('.billing-plans__item--active');$activeBillingPLan.removeClass('billing-plans__item--active');$activeBillingPLan.find('.btn').removeClass('disabled');$activeBillingPLan.find('.btn').html('Select');this.monthlyBillingPlansBlock.hide();}
Payment.prototype.showCreditAmountBlock=function(){this.creditAmountBlock.show();}
Payment.prototype.hideCreditAmountBlock=function(){this.creditAmountBlock.hide();}
Payment.prototype.showBillingTypesPaymentDataBlock=function(){this.billingTypesPaymentDataBlock.show();}
Payment.prototype.hideBillingTypesPaymentDataBlock=function(){this.billingTypesPaymentDataBlock.hide();}
Payment.prototype.showPaymentMethods=function(){var $this=this,showNewIsEmpty=true;if($this.newMethodItems.length>0){$this.newMethodItems.hide();$this.addItem.show();}else{$this.addItem.hide();showNewIsEmpty=false;}
$this.backItem.hide();if($this.methodItems.length>0){$this.methodItems.show();$this.methodItems.first().find('input:radio').trigger('click');}else if(showNewIsEmpty){$this.showNewPaymentMethods();}};Payment.prototype.showNewPaymentMethods=function(){var $this=this,showNewIsEmpty=true,$billingType=$this.billingTypesBlock.find('.billing-plans__item--active'),activeBillingTypeName=$billingType.attr('id');if($this.methodItems.length>0){$this.methodItems.hide();$this.backItem.show();}else{$this.backItem.hide();showNewIsEmpty=false;}
$this.addItem.hide();if($this.newMethodItems.length>0){$this.newMethodItems.each(function(){if(activeBillingTypeName===MONTHLY_PLAN_BILLING_TYPE&&$(this).find('input:radio').val()===$this.tmBankNewMethodId){return true;}
$(this).show();});$this.methodItems.find('input:radio').removeAttr("checked");}else if(showNewIsEmpty){$this.showPaymentMethods();}};Payment.prototype.ShowBillingDetailsInfo=function(){var $this=this;$this.billingDetailsFormBlock.hide();$this.billingDetailsInfoTrigger.show();$this.billingDetailsFormBlock.find('input:text.form-field').each(function(){$(this).attr('disabled','disabled');});$this.billingDetailsInfoBlock.show();};Payment.prototype.ShowBillingDetailsForm=function(){var $this=this;$this.billingDetailsInfoBlock.hide();$this.billingDetailsInfoTrigger.hide();$this.billingDetailsFormBlock.find('input:text.form-field').each(function(){$(this).removeAttr('disabled');});$this.billingDetailsFormBlock.show();};Payment.prototype.ShowVatPanel=function(){var $this=this;$this.vatFormBlock.hide();$this.vatFormBlock.find(':input').each(function(){$(this).attr('disabled','disabled');});$this.vatInfoBlock.show();};Payment.prototype.ShowVatGroup=function(){var $this=this;$this.vatInfoBlock.hide();$this.vatFormBlock.find(':input').each(function(){$(this).removeAttr('disabled');});$this.vatFormBlock.show();$this.vatItems.first().find('input:radio').trigger('click');};Payment.prototype.checkVat=function(billingType){var $this=this;if(!$this.vatNumber.length){if($this.isCountryInEU){if($this.isVatExempt){$this.updateVatInfo(true,billingType);}else{$this.updateVatInfo(false,billingType);}}else{$this.updateVatInfo(true,billingType);$this.paymentTopupValue.parent().parent().hide();$this.paymentVatValue.parent().parent().hide();}}else{if($this.vatNumber.is(':disabled')){$this.updateVatInfo(true,billingType);return;}
if($this.vatItems.find('input:radio:checked').val()=='0'){$this.updateVatInfo(false,billingType);return;}
var countryCode=$.trim($this.vatNumber.prev(".input-group-addon").text());var vatNumber=$.trim($this.vatNumber.val().toUpperCase().replace(/[^a-zA-Z0-9]/gi,''));if(vatNumber.length>=8){var checkVAT=checkVATNumber(countryCode+vatNumber,countryCode);if(checkVAT.valid_country&&checkVAT.valid_vat){$this.vatNumber.parent().parent().next('div').html('<span class="label label-success">VERIFIED</span>');$this.vatNumber.closest('.has-error').removeClass('has-error').find('.help-block.error').empty();$this.updateVatInfo(true,billingType);}else{$this.vatNumber.parent().parent().next('div').html('<span class="label label-warning">INVALID</span>');$this.updateVatInfo(false,billingType);}}else{$this.vatNumber.parent().parent().next('div').html('');$this.updateVatInfo(false,billingType);}}};Payment.prototype.updateVatInfo=function(isVatConfirmed,billingType=PAY_AS_YOU_GO_BILLING_TYPE){var $this=this,vatRate,vatRateFormat,vatValueFormat,TotalValueFormat;if(!$this.price.val()){return;}
if(isVatConfirmed){vatRate=$this.priceData.common.no_vat_rate;vatValue='VAT ZERO RATED';TotalValue=$this.getTotalPriceByType(isVatConfirmed,billingType);}else{vatRate=$this.priceData.common.vat_rate;vatValue=$this.getVatByType(billingType);TotalValue=$this.getTotalPriceByType(isVatConfirmed,billingType);}
if($this.paymentVatRate.length){$this.paymentVatRate.parent().removeClass();$this.paymentVatRate.text(vatRate+'%');if(vatRate==0){$this.paymentVatRate.parent().addClass('text-success');}}
if($this.paymentVatValue.length){$this.paymentVatValue.removeClass();$this.paymentVatValue.text(vatValue);if(vatRate==0){$this.paymentVatValue.addClass('label label-success');}}
if($this.paymentTotalValue.length){$this.paymentTotalValue.text(TotalValue);}};Payment.prototype.getVatByType=function(billingType){let $this=this;if(billingType===MONTHLY_PLAN_BILLING_TYPE){let activeBillingPLanId=$this.monthlyBillingPlansBlock.find('.billing-plans__item--active').attr('data-plan-id'),activeBillingPLanPrice=$this.monthlyBillingPlansViewData[activeBillingPLanId]['month_cost'],activeBillingPLanCurrency=$this.monthlyBillingPlansViewData[activeBillingPLanId]['plan_currency'];return(activeBillingPLanPrice*($this.priceData.common.vat_rate/100)).toFixed(2)+' '+activeBillingPLanCurrency;}else if(billingType===PAY_AS_YOU_GO_BILLING_TYPE){return $this.priceData.items[$this.price.val()].vat;}};Payment.prototype.getPriceByType=function(billingType){let $this=this;if(billingType===MONTHLY_PLAN_BILLING_TYPE){let activeBillingPLanId=$this.monthlyBillingPlansBlock.find('.billing-plans__item--active').attr('data-plan-id'),activeBillingPLanPrice=$this.monthlyBillingPlansViewData[activeBillingPLanId]['month_cost'],activeBillingPLanCurrency=$this.monthlyBillingPlansViewData[activeBillingPLanId]['plan_currency'];return parseFloat(activeBillingPLanPrice).toFixed(2)+' '+activeBillingPLanCurrency;}else if(billingType===PAY_AS_YOU_GO_BILLING_TYPE){return $this.priceData.items[$this.price.val()].bundle;}};Payment.prototype.getTotalPriceByType=function(isVatConfirmed,billingType){let $this=this;if(billingType===MONTHLY_PLAN_BILLING_TYPE){let activeBillingPLanId=$this.monthlyBillingPlansBlock.find('.billing-plans__item--active').attr('data-plan-id'),activeBillingPLanPrice=$this.monthlyBillingPlansViewData[activeBillingPLanId]['month_cost'],activeBillingPLanCurrency=$this.monthlyBillingPlansViewData[activeBillingPLanId]['plan_currency'];if(isVatConfirmed){return parseFloat(activeBillingPLanPrice).toFixed(2)+' '+activeBillingPLanCurrency;}else{let vatCost=activeBillingPLanPrice*($this.priceData.common.vat_rate/100);return(+activeBillingPLanPrice+ +vatCost).toFixed(2)+' '+activeBillingPLanCurrency;}}else if(billingType===PAY_AS_YOU_GO_BILLING_TYPE){if(isVatConfirmed){return $this.priceData.items[$this.price.val()].bundle;}else{return $this.priceData.items[$this.price.val()].inc;}}};Payment.prototype.updatePriceInfo=function(billingType=PAY_AS_YOU_GO_BILLING_TYPE){var $this=this;$this.checkVat(billingType);if($this.price.val()){if($this.autorechargeMinBalance.length){$this.autorechargeMinBalance.text($this.priceData.items[$this.price.val()].autorecharge_min_balance);}
if($this.autorechargeValue.length){$this.autorechargeValue.text($this.priceData.items[$this.price.val()].autorecharge_bundle);}
if($this.paymentTopupValue.length){$this.paymentTopupValue.text($this.getPriceByType(billingType));}
$this.priceInfoBlock.show();}else{if($this.autorechargeMinBalance.length){$this.autorechargeMinBalance.text('minimal value');}
if($this.autorechargeValue.length){$this.autorechargeValue.text('selected value');}
$this.priceInfoBlock.hide();}};Payment.prototype.makePaymentAction=function(){let $this=this;$.ajax({url:$this.form.attr('action'),type:'POST',dataType:'JSON',data:{'form':$this.getMakePaymentFormParams()},beforeSend:function(){$this.disablePaymentForm();},success:function(xhr){if(xhr.success){if(xhr.data.redirect){$(location).attr('href',xhr.data.redirect);}else{$this.paymentResponseCallback(xhr.data);}}else{$this.enablePaymentForm();$this.renderAjaxErrors(xhr.message);if(xhr.message['alert']){$this.showAjaxAlert(xhr.message['alert']);$("html, body").animate({scrollTop:0},"slow");}}},error:function(xhr){$this.enablePaymentForm();$this.showAjaxAlert('There was an unexpected payment processing error. Please try again. If you are still unable to pay please contact us at support@textmagic.com.');$("html, body").animate({scrollTop:0},"slow");}});};Payment.prototype.initSubmitForm=function(){var $this=this;$this.form.off('submit').on('submit',function(e){e.preventDefault();$this.makePaymentAction();});}
Payment.prototype.disablePaymentForm=function(){$('body').spin('enable','<p class="h1">Processing your payment. Please wait...</p>',{'length':17,'width':4,'radius':14,'top':'-46px','left':'-24px'});this.paymentBtn.attr('disabled','disabled');this.clearAjaxErrors();this.hideAjaxAlert();};Payment.prototype.enablePaymentForm=function(){$('body').spin('disable');this.paymentBtn.removeAttr('disabled');};Payment.prototype.getMakePaymentFormParams=function(){let $this=this,activeBillingTypeName=$this.billingTypesBlock.find('.billing-plans__item--active').attr('id'),formData=$this.form.serializeJSON().form;formData.billingType=activeBillingTypeName;if(activeBillingTypeName===MONTHLY_PLAN_BILLING_TYPE){delete formData.price;delete formData.autoRecharge;}else{delete formData.monthlyBillingPlans;}
return formData;};Payment.prototype.paymentResponseCallback=function(data){this.enablePaymentForm();};Payment.prototype.getSelectedPrice=function(){return this.price.find('option:selected').text();};Payment.prototype.removePaymentMethodConfirm=function(methodId){var $this=this;$.confirm({'title':'Delete payment method','message':($this.methodItems.length>=2?'The selected payment method will be deleted permanently. Are you sure you would like to delete it?':'Auto-recharge will no longer work if you remove all payment methods from your account. Are you sure you would like to delete it?'),'buttons':{'cancel':{'text':'Cancel','class':'btn btn-default'},'remove':{'text':'Delete','class':'btn btn-danger','click':function(){$this.removePaymentMethod(methodId);}}}});};Payment.prototype.removePaymentMethod=function(methodId){var $this=this;$.ajax({url:$this.commandUrl,type:'POST',dataType:'JSON',data:{'cmd':'paymentMethodRemove','paymentMethod':methodId},beforeSend:function(){$this.hideAjaxAlert();$('#confirmModal').find('.btn-danger').spin('enable','Deleting...');$('#confirmModal').find('.btn-default').hide();},complete:function(xhr){$('#confirmModal').modal('hide');},success:function(xhr){if(xhr.success){if(xhr.message['alert']){$this.showAjaxAlert(xhr.message['alert']);}
if(xhr.data.redirect){$(location).attr('href',xhr.data.redirect);}else{$this.methodItems.find("input[value='"+methodId+"']").parents('.method-item').remove();$this.init();if($this.methodItems.length==0){$this.showNewPaymentMethods();$this.backItem.hide();}else{$this.selectFirstActualItem();}
if(xhr.data.flag_label){switch(xhr.data.flag_label){case 'ACTIVE':$this.hideAutorechargeBlock();break;case 'INACTIVE':$this.showAutorechargeBlock();break;}}}}else{if(xhr.message['alert']){$this.showAjaxAlert(xhr.message['alert']);}else{$this.showAjaxAlert('Sorry, but it looks like something has gone wrong. Please try again or contact us at support@textmagic.com.');}}},error:function(xhr){$this.showAjaxAlert('Sorry, but it looks like something has gone wrong. Please try again or contact us at support@textmagic.com.');}});};Payment.prototype.initSelectBillingTypeAction=function(){let $this=this;$this.billingTypesBlock.find('.btn').click(function(){let $billingType=$(this).closest('.billing-plans__item'),activeBillingTypeName=$billingType.attr('id'),$activeBillingPLanType=$this.billingTypesBlock.find('.billing-plans__item--active');$activeBillingPLanType.removeClass('billing-plans__item--active');$activeBillingPLanType.find('.btn').removeClass('disabled');$activeBillingPLanType.find('.btn').html('Select');$billingType.addClass('billing-plans__item--active');$(this).html('Selected');$(this).addClass('disabled');if(activeBillingTypeName===PAY_AS_YOU_GO_BILLING_TYPE){$this.hideMonthlyBillingPlansBlock();$this.showCreditAmountBlock();$this.showBillingTypesPaymentDataBlock();if($this.isAutorechargeBlockAvailable){$this.showAutorechargeBlock();}
$this.updatePriceInfo(PAY_AS_YOU_GO_BILLING_TYPE);}else if(activeBillingTypeName===MONTHLY_PLAN_BILLING_TYPE){$this.hideBillingTypesPaymentDataBlock();$this.showMonthlyBillingPlansBlock();}
$this.showPaymentMethods();});};Payment.prototype.initSelectMonthlyBillingPlanAction=function(){let $this=this;$this.monthlyBillingPlansBlock.find('.btn').click(function(){let $billingPLan=$(this).closest('.billing-plans__item'),$activeBillingPLan=$this.monthlyBillingPlansBlock.find('.billing-plans__item--active');$activeBillingPLan.removeClass('billing-plans__item--active');$activeBillingPLan.find('.btn').removeClass('disabled');$activeBillingPLan.find('label.btn span').text('Select');$billingPLan.addClass('billing-plans__item--active');$(this).find('span').text('Selected');$(this).addClass('disabled');$this.hideAutorechargeBlock();$this.hideCreditAmountBlock();$this.showBillingTypesPaymentDataBlock();$this.updatePriceInfo(MONTHLY_PLAN_BILLING_TYPE);});};Payment.prototype.initBillingTooltipVisibility=function(){let $this=this;$this.billingQuestion.click(function(){$(this).next('div.tooltip').addClass('show');});$('body').on('mouseup',function(){$this.billingQuestion.next('div.tooltip').removeClass('show');});};