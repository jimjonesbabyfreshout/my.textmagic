function initSearchWidget(e,n,a,t,o,i,s){var r,d=$(a);d.on("submit",function(){s();var t=n.getRequestParams().params,e=$(this).find("input:text[name=search-query]").val(),a=d.data("last-text");return a&&a==e||(app.stopAjaxRequests(n.getOptions().url),d.data("last-text",e),t=$.extend({},t,{text:e}),n.setRequestParams({params:t}).reload()),!1}),$(".search-group a[data-field]").on("click",function(){$(".search-group button[data-field]").attr("data-field",$(this).data("field")),$(".search-group span#field-label").html($(this).html()),$('.search-group input:text[name="search-query"]').focus(),""!==$('.search-group input:text[name="search-query"]').val()&&n.reload()}),d.find('input[name="search-query"]').on("input change",function(t){clearTimeout(e),13==t.keyCode?(d.data("last-text",null),d.submit()):e=setTimeout(function(){d.submit()},500)}),$("#searchFilterClose").on("click",function(t){t.preventDefault(),$(this).parent().addClass("hidden"),$("#searchFilterBtn").removeClass("active"),$('input[name="search-query"]').val("").change()}),$("#searchFilterBtn").on("click",function(t){t.preventDefault();var t=$(this),e=t.closest(".btn-panel").parent().find(a);e.hasClass("hidden")?(t.addClass("active"),e.removeClass("hidden"),e.find('input[name="search-query"]').focus()):(t.removeClass("active"),e.addClass("hidden"),e.find('input[name="search-query"]').val("").change())}),t&&(t=$(t),$('input[name="date-filter-list"]',t).parent().on("click",function(t){t.preventDefault();t=$("input",this).val();if("Pick date range"==t)return!0;var e=n.getRequestParams().params,e=$.extend({},e,{date_pair:t});n.setRequestParams({params:e}).reload()})),o&&(r=$(o),$("#showDateRange",r).on("click",function(t){t.preventDefault();t=n.getRequestParams().params,t=$.extend({},t,{date_pair:"Pick date range",from:$("#dateFilterStart",r).val(),to:$("#dateFilterEnd",r).val()});n.setRequestParams({params:t}).reload()})),i&&d.submit()}function appendNoResults(t){var e,a,n,o;t&&(0==t.children("tbody").children("tr").length||1==t.children("tbody").children("tr").length&&t.children("tbody").children("tr").hasClass("table-data-select"))&&(o=t.children("thead"),e="100%",a=0==t.children("tbody").children("tr").length,n=t.children("thead").find("tr:first-child > th"),0!==o.length&&0!==n.length&&a&&(e=n.length),o=(o=t.data("empty-hint"))||"No search results found. Please try a different keyword or period.",t.children("tbody").append('<tr class="empty"><td colspan="'+e+'">'+o+"</td></tr>"))}!function(){function t(t){"use strict";function a(t){if(t.paused||t.ended||m)return!1;try{c.clearRect(0,0,d,r),c.drawImage(t,0,0,d,r)}catch(t){}setTimeout(a,$.duration,t),y.setIcon(l)}function e(t){t=t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(t,e,a,n){return e+e+a+a+n+n});t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return!!t&&{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}}function i(t,e){var a,n={};for(a in t)n[a]=t[a];for(a in e)n[a]=e[a];return n}function n(t){return t.n=Math.abs(t.n),t.x=d*t.x,t.y=r*t.y,t.w=d*t.w,t.h=r*t.h,t}t=t||{};var s,o,r,d,l,c,u,p,h,m,f={bgColor:"#d00",textColor:"#fff",fontFamily:"sans-serif",fontStyle:"bold",type:"circle",position:"down",animation:"slide",elementId:!1},g={},b=(g.ff=/firefox/i.test(navigator.userAgent.toLowerCase()),g.chrome=/chrome/i.test(navigator.userAgent.toLowerCase()),g.opera=/opera/i.test(navigator.userAgent.toLowerCase()),g.ie=/msie/i.test(navigator.userAgent.toLowerCase())||/trident/i.test(navigator.userAgent.toLowerCase()),g.supported=g.chrome||g.ff||g.opera,[]),v=function(){},C=m=!1,k={ready:function(){C=!0,k.reset(),v()},reset:function(){p=!(b=[]),c.clearRect(0,0,d,r),c.drawImage(u,0,0,d,r),y.setIcon(l)},start:function(){var t;C&&!h&&(t=function(){p=b[0],h=!1,0<b.length&&(b.shift(),k.start())},0<b.length&&(h=!0,p?$.run(p.options,function(){$.run(b[0].options,function(){t()},!1)},!0):$.run(b[0].options,function(){t()},!1)))}},w={},y=(w.circle=function(t){var e=!1;9<(t=n(t)).n&&t.n<100?(t.x=t.x-.4*t.w,t.w=1.4*t.w,e=!0):100<=t.n&&(t.x=t.x-.65*t.w,t.w=1.65*t.w,e=!0),c.clearRect(0,0,d,r),c.drawImage(u,0,0,d,r),c.beginPath(),c.font=s.fontStyle+" "+Math.floor(t.h*(99<t.n?.85:1))+"px "+s.fontFamily,c.textAlign="center",e?(c.moveTo(t.x+t.w/2,t.y),c.lineTo(t.x+t.w-t.h/2,t.y),c.quadraticCurveTo(t.x+t.w,t.y,t.x+t.w,t.y+t.h/2),c.lineTo(t.x+t.w,t.y+t.h-t.h/2),c.quadraticCurveTo(t.x+t.w,t.y+t.h,t.x+t.w-t.h/2,t.y+t.h),c.lineTo(t.x+t.h/2,t.y+t.h),c.quadraticCurveTo(t.x,t.y+t.h,t.x,t.y+t.h-t.h/2),c.lineTo(t.x,t.y+t.h/2),c.quadraticCurveTo(t.x,t.y,t.x+t.h/2,t.y)):c.arc(t.x+t.w/2,t.y+t.h/2,t.h/2,0,2*Math.PI),c.fillStyle="rgba("+s.bgColor.r+","+s.bgColor.g+","+s.bgColor.b+","+t.o+")",c.fill(),c.closePath(),c.beginPath(),c.stroke(),c.fillStyle="rgba("+s.textColor.r+","+s.textColor.g+","+s.textColor.b+","+t.o+")",999<t.n?c.fillText((9999<t.n?9:Math.floor(t.n/1e3))+"k+",Math.floor(t.x+t.w/2),Math.floor(t.y+t.h-.2*t.h)):c.fillText(t.n,Math.floor(t.x+t.w/2),Math.floor(t.y+t.h-.15*t.h)),c.closePath()},w.rectangle=function(t){9<(t=n(t)).n&&t.n<100?(t.x=t.x-.4*t.w,t.w=1.4*t.w):100<=t.n&&(t.x=t.x-.65*t.w,t.w=1.65*t.w),c.clearRect(0,0,d,r),c.drawImage(u,0,0,d,r),c.beginPath(),c.font="bold "+Math.floor(t.h*(99<t.n?.9:1))+"px sans-serif",c.textAlign="center",c.fillStyle="rgba("+s.bgColor.r+","+s.bgColor.g+","+s.bgColor.b+","+t.o+")",c.fillRect(t.x,t.y,t.w,t.h),c.fillStyle="rgba("+s.textColor.r+","+s.textColor.g+","+s.textColor.b+","+t.o+")",999<t.n?c.fillText((9999<t.n?9:Math.floor(t.n/1e3))+"k+",Math.floor(t.x+t.w/2),Math.floor(t.y+t.h-.2*t.h)):c.fillText(t.n,Math.floor(t.x+t.w/2),Math.floor(t.y+t.h-.15*t.h)),c.closePath()},{}),$=(y.getIcon=function(){var t=!1,e="";if(s.elementId?(t=document.getElementById(s.elementId)).setAttribute("href",t.getAttribute("src")):!1===(t=function(){for(var t=document.getElementsByTagName("head")[0].getElementsByTagName("link"),e=t.length-1;0<=e;e--)if(/icon/i.test(t[e].getAttribute("rel")))return t[e];return!1}())&&((t=document.createElement("link")).setAttribute("rel","icon"),document.getElementsByTagName("head")[0].appendChild(t)),-1===(e=s.elementId?t.src:t.href).indexOf(document.location.hostname))throw new Error("Error setting favicon. Favicon image is on different domain (Icon: "+e+", Domain: "+document.location.hostname+")");return t.setAttribute("type","image/png"),t},y.setIcon=function(t){var e,t=t.toDataURL("image/png");s.elementId?document.getElementById(s.elementId).setAttribute("src",t):g.ff||g.opera?(e=o,o=document.createElement("link"),g.opera&&o.setAttribute("rel","icon"),o.setAttribute("rel","icon"),o.setAttribute("type","image/png"),document.getElementsByTagName("head")[0].appendChild(o),o.setAttribute("href",t),e.parentNode&&e.parentNode.removeChild(e)):o.setAttribute("href",t)},{}),A=($.duration=40,$.types={},$.types.fade=[{x:.4,y:.4,w:.6,h:.6,o:0},{x:.4,y:.4,w:.6,h:.6,o:.1},{x:.4,y:.4,w:.6,h:.6,o:.2},{x:.4,y:.4,w:.6,h:.6,o:.3},{x:.4,y:.4,w:.6,h:.6,o:.4},{x:.4,y:.4,w:.6,h:.6,o:.5},{x:.4,y:.4,w:.6,h:.6,o:.6},{x:.4,y:.4,w:.6,h:.6,o:.7},{x:.4,y:.4,w:.6,h:.6,o:.8},{x:.4,y:.4,w:.6,h:.6,o:.9},{x:.4,y:.4,w:.6,h:.6,o:1}],$.types.none=[{x:.4,y:.4,w:.6,h:.6,o:1}],$.types.pop=[{x:1,y:1,w:0,h:0,o:1},{x:.9,y:.9,w:.1,h:.1,o:1},{x:.8,y:.8,w:.2,h:.2,o:1},{x:.7,y:.7,w:.3,h:.3,o:1},{x:.6,y:.6,w:.4,h:.4,o:1},{x:.5,y:.5,w:.5,h:.5,o:1},{x:.4,y:.4,w:.6,h:.6,o:1}],$.types.popFade=[{x:.75,y:.75,w:0,h:0,o:0},{x:.65,y:.65,w:.1,h:.1,o:.2},{x:.6,y:.6,w:.2,h:.2,o:.4},{x:.55,y:.55,w:.3,h:.3,o:.6},{x:.5,y:.5,w:.4,h:.4,o:.8},{x:.45,y:.45,w:.5,h:.5,o:.9},{x:.4,y:.4,w:.6,h:.6,o:1}],$.types.slide=[{x:.4,y:1,w:.6,h:.6,o:1},{x:.4,y:.9,w:.6,h:.6,o:1},{x:.4,y:.9,w:.6,h:.6,o:1},{x:.4,y:.8,w:.6,h:.6,o:1},{x:.4,y:.7,w:.6,h:.6,o:1},{x:.4,y:.6,w:.6,h:.6,o:1},{x:.4,y:.5,w:.6,h:.6,o:1},{x:.4,y:.4,w:.6,h:.6,o:1}],$.run=function(t,e,a,n){var o=$.types[document.hidden||document.msHidden||document.webkitHidden||document.mozHidden?"none":s.animation];return n=!0===a?void 0!==n?n:o.length-1:void 0!==n?n:0,e=e||function(){},n<o.length&&0<=n?(w[s.type](i(t,o[n])),setTimeout(function(){a?--n:n+=1,$.run(t,e,a,n)},$.duration),void y.setIcon(l)):void e()},(s=i(f,t)).bgColor=e(s.bgColor),s.textColor=e(s.textColor),s.position=s.position.toLowerCase(),s.animation=($.types[""+s.animation]?s:f).animation,-1<s.position.indexOf("up")),x=-1<s.position.indexOf("left");if(A||x)for(var I=0;I<$.types[""+s.animation].length;I++){var B=$.types[""+s.animation][I];A&&(B.y=B.y<.6?B.y-.4:B.y-2*B.y+(1-B.w)),x&&(B.x=B.x<.6?B.x-.4:B.x-2*B.x+(1-B.h)),$.types[""+s.animation][I]=B}s.type=(w[""+s.type]?s:f).type;try{o=y.getIcon(),l=document.createElement("canvas"),u=document.createElement("img"),o.hasAttribute("href")?(u.setAttribute("src",o.getAttribute("href")),u.onload=function(){r=0<u.height?u.height:32,d=0<u.width?u.width:32,l.height=r,l.width=d,c=l.getContext("2d"),k.ready()}):(u.setAttribute("src",""),d=r=32,u.height=r,u.width=d,l.height=r,l.width=d,c=l.getContext("2d"),k.ready())}catch(t){throw"Error initializing favico. Message: "+t.message}return{badge:function(t,e){v=function(){try{if(0<t){if($.types[""+e]&&(s.animation=e),b.push({type:"badge",options:{n:t}}),100<b.length)throw"Too many badges requests in queue.";k.start()}else k.reset()}catch(t){throw"Error setting badge. Message: "+t.message}},C&&v()},video:function(t){v=function(){try{if("stop"===t)return m=!0,k.reset(),void(m=!1);t.addEventListener("play",function(){a(this)},!1)}catch(t){throw"Error setting video. Message: "+t.message}},C&&v()},image:function(o){v=function(){try{var t=o.width,e=o.height,a=document.createElement("img"),n=t/d<e/r?t/d:e/r;a.setAttribute("src",o.getAttribute("src")),a.height=e/n,a.width=t/n,c.clearRect(0,0,d,r),c.drawImage(a,0,0,d,r),y.setIcon(l)}catch(t){throw"Error setting image. Message: "+t.message}},C&&v()},webcam:function(t){var e;window.URL&&window.URL.createObjectURL||(window.URL=window.URL||{},window.URL.createObjectURL=function(t){return t}),g.supported&&(e=!1,navigator.getUserMedia=navigator.getUserMedia||navigator.oGetUserMedia||navigator.msGetUserMedia||navigator.mozGetUserMedia||navigator.webkitGetUserMedia,v=function(){try{if("stop"===t)return m=!0,k.reset(),void(m=!1);(e=document.createElement("video")).width=d,e.height=r,navigator.getUserMedia({video:!0,audio:!1},function(t){e.src=URL.createObjectURL(t),e.play(),a(e)},function(){})}catch(t){throw"Error setting webcam. Message: "+t.message}},C&&v())},reset:k.reset}}"undefined"!=typeof define&&define.amd?define([],function(){return t}):"undefined"!=typeof module&&module.exports?module.exports=t:this.Favico=t}(),app.stopAjaxRequests=function(a){(a=void 0!==a&&a)?$(app.ajaxRequests).each(function(t,e){e.url==a&&e.xhr.abort()}):$(app.ajaxRequests).each(function(t,e){e.xhr.abort()}),app.ajaxRequests=[]},$(window).on("beforeunload.stopAjaxRequests",function(){app.stopAjaxRequests()}),$(document).ready(function(){0<app.notyMessages.length&&(app.notyMessages.forEach(function(t){notyMessage(t)}),app.notyMessages=[])});var msgExportDisabled="You do not have a permission to export. Please contact your company administrator.";function initExportWidget(i,t){$(t).on("click",function(t){var e=i.getRequestParams(),a=$("[data-crud-export-count]"),n=$('[data-widget="top-alert"]'),o=$('meta[name="csrf-token"]').attr("content");if(app.data.user&&app.data.user.exportDisabled)return n.warningBlock(msgExportDisabled),$(this).closest(".btn-group").removeClass("open"),!1;if(a.length&&1e6<parseInt(a.data("crud-export-count")))return notyMessage("Your exported file is too large. Please contact support to get the requested file.",{type:"warning"}),$(this).closest(".btn-group").removeClass("open"),!1;if("undefined"!=typeof itemsCount&&(500<parseInt(itemsCount)||(a=(n=i).getOptions().url,n=n.getRequestParams().cmd,void 0!==a&&void 0!==n&&"/online/messages/sent/ajax"===a&&"table"===n||"/online/account/ajax"===a&&"sentTable"===n)||(n=(a=i).getOptions().url,a=a.getRequestParams().cmd,void 0!==n&&void 0!==a&&"/online/reporting/ajax"===n&&"events"===a)))return n={last:e,exportLnk:$(this),maxExport:1e6},$.confirmDefferedExport(n),!1;delete e.page;a="?"+decodeURIComponent($.param(e));($(this).attr("href").includes("messages_sent_ajax")||$(this).attr("href").includes("contacts_ajax"))&&(a=a+"&_csrf_token="+encodeURIComponent(o)),$(this).attr("href",$(this).attr("href").replace(/\?.+/,"")+a)})}function initDateFilterWidget(){$('input:radio[name="date-filter-list"]').on("change",function(){$("#dateFilterValue").text($(this).parent().text()),"Pick date range"==this.value?$("#dateFilter").removeClass("hidden"):$("#dateFilter").addClass("hidden")}),$("#dateFilterClose").on("click",function(){$(this).parent().addClass("hidden");var t=$('input:radio[name="date-filter-list"][value="All"]').click();$("#dateFilterValue").text(t.parent().text())})}function parseErrors(t,e,a){void 0===t.data.selector?($(a).text(t.message),$(e).show()):($('<span class="help-block error">'+t.message+"</span>").insertAfter(t.data.selector),$(t.data.selector).closest(".form-group").addClass("has-error"))}function parseAllErrors(t){$.each(t,function(t,e){t="input[data-field="+t+"]:visible, textarea[data-field="+t+"]:visible, span[data-field="+t+"], div[data-field="+t+"]:visible";null!==e&&$('<span class="help-block error">'+e+"</span>").insertAfter(t),$(t).closest(".form-group").addClass("has-error")})}function spinIt(t,e){(1<t.find("table").length?t:t.find("table")).spin(e)}function hideErrors(t){$("span.error").not(".tag-item").remove(),$(".has-error").removeClass("has-error"),$(".has-success").removeClass("has-success"),$(t).hide()}function assignDeselect(e,t,a,n,o){t.find('a[data-options-deselect="'+a+'"]').off("click.textmagic").on("click.textmagic",function(t){o.deselectAllFunction(e),t.preventDefault(),optionsTableToggle(n,"uncheck"),n.data("checked",!1)})}Array.prototype.pushOnce=function(t){-1===$.inArray(t,this)&&this.push(t)},Array.prototype.popAll=function(t){for(var e=this.length-1;0<=e;e--)this[e]===t&&this.splice(e,1)},function(v){v.prepareCrudPage=function(m){var f,o,g,e,i=[],s=!1,a={},b={reloadAfterInit:!0,containerSelector:"#crud-container",itemSelector:'tr[data-crud="item"]',dateListSelector:!1,datePairSelector:!1,commandUrl:"/online/crud/ajax",paginationCommand:"table",paginationScroll:!1,paginationRecount:!1,removeCommand:"remove",updateCommand:"update",container:v(this.containerSelector),perPage:10,spin:!0,preSearchCallback:function(t){return!0},callbackRecount:function(t){var e=t.data.total,a=("function"==typeof v.fn.format&&(e=v.fn.format(e)),t.data.overlimit),a=void 0!==a&&a?"many":e,e=(g.container.find('[data-crud-count="count"]').text(a),t.data.export_total),a=(void 0!==e&&g.container.find("[data-crud-export-count]").attr("data-crud-export-count",e),g.container.find('[data-crud-max="max"]'));parseInt(a.text())>=t.data.total&&(a.text(t.data.total),g.container.find("ul.pager li.next").addClass("disabled").off("click")),buttonEnable(v("[data-options-recount]"))},removeFunction:function(t){"console"in window&&console.log("No remove function specified")},bulkRemoveFunction:function(t){"console"in window&&console.log("No bulk remove function specified")},updateFunction:function(t){"console"in window&&console.log("No update function specified")},bulkUpdateFunction:function(t){"console"in window&&console.log("No bulk update function specified")},updateCheckboxesFunction:function(t){var e=v(t).closest("tr").data("id");-1!==v.inArray(e,i)?v(t).attr("checked",!0):v(t).attr("checked",!1)},togglePager:function(){var t=v(g.containerSelector),e=t.find("ul.pager"),t=t.find(".pagin-panel select");!0===s?(e.addClass("disabled").addClass("text-muted"),t.prop("disabled","disabled")):(e.removeClass("disabled").removeClass("text-muted"),t.prop("disabled",!1))},checkboxChangeFunction:function(t){var e=v(t).closest("tr").data("id");v(t).is(":checked")?i.pushOnce(e):s?(s=!1,i=[],v(g.itemSelector).each(function(){v(this).find('input[type="checkbox"]').is(":checked")&&i.pushOnce(v(this).data("id"))})):i.popAll(e),this.togglePager()},topCheckboxChangeFunction:function(t){v(t).is(":checked")?v(g.itemSelector).each(function(){i.pushOnce(v(this).data("id"))}):(v(g.itemSelector).each(function(){i.popAll(v(this).data("id"))}),f.setCheckedAllItems(!1)),this.togglePager()},selectAllFunction:function(t){if(v('input[name="search-query"]').val())return!1;s=!0,i=[],this.togglePager()},deselectAllFunction:function(t){s=!1,i=[],this.togglePager()},afterReloadFunction:function(t){return!0},beforeReloadFunction:function(t){return!0},checkedItemsChangeFunction:function(){return!0}};function t(t){if((g=v.extend({},b,g,t)).container=v(g.containerSelector),0==g.container.length)return"console"in window&&console.log("No container found by "+g.containerSelector+", exiting"),!1;var h;!function(){if(m.commandUrl)paramsSection=m.commandUrl.replace(/\//gi,"_")+"_"+m.paginationCommand;else{if(!b.commandUrl)return"console"in window&&console.log("No section for load default params data");paramsSection=b.commandUrl.replace(/\//gi,"_")+"_"+b.paginationCommand}params=Cookies.getJSON(paramsSection),v.isPlainObject(params)&&(params.direction&&(a.direction=params.direction),params.orderBy&&(a.orderBy=params.orderBy),params.perPage&&(g.perPage=params.perPage))}(),v('[data-crud="bulk-remove"]').off("click.crud").on("click.crud",function(){g.bulkRemoveFunction(this)}),v('[data-crud="bulk-update"]').off("click.crud").on("click.crud",function(){g.bulkUpdateFunction(this)}),h=g.container,o=h.widgetPagination({page:1,perPage:g.perPage,requestParams:v.extend({},a,{cmd:g.paginationCommand}),scroll:g.paginationScroll,recount:g.paginationRecount,callbackRecount:g.callbackRecount,callbackReloadBefore:function(t,e){g.beforeReloadFunction(t),g.spin&&spinIt(h,"enable")},callbackReloadSuccess:function(n){var a=h.find("table"),o=(a.find('input[type="checkbox"]').each(function(){null!=v(this).closest("tr").data("id")&&g.updateCheckboxesFunction(this)}),a.attr("id")),i=a.find('tbody input[type="checkbox"]').not(":disabled"),s=i.filter(":checked").length,r=i.length,d=a.find('thead input[type="checkbox"]'),l=v('[data-options-table="'+o+'"]'),t=v('[data-options-empty-table="'+o+'"]'),c=v('[data-options-count="'+o+'"]'),e=a.find("tbody > tr[data-widget]").length,u=a.find("span.select-all"),p={All:"",items:"item",are:"is"};optionsTableButtons(t,e),optionsTableCheck(i),optionsTableCount(f,a,d,l,c,s,r),a.find('input[type="checkbox"]').off("change.crudapi").on("change.crudapi",function(){var t,e;null!=v(this).closest("tr").data("id")&&(g.checkboxChangeFunction(this),t=v('[data-options-select="'+o+'"]'),e=parseInt(t.find("span.value").text().replace(/\D/g,""),10),this.checked?s+=1:--s,f.getCheckedItems().length===e?(t.click(),1===e&&(rewriteSpanHtml(u,p),assignDeselect(this,h,o,a,g))):(optionsTableCheck(v(this)),optionsTableCount(f,a,d,l,c,s,r)))}),a.find('thead input[type="checkbox"]').on("change",function(){g.topCheckboxChangeFunction(this);var t=v('[data-options-select="'+o+'"]'),e=parseInt(t.find("span.value").text().replace(/\D/g,""),10);s=0,this.checked?(i.prop("checked",!0),s=i.length):i.prop("checked",!1),optionsTableCheck(i),optionsTableCount(f,a,v(this),l,c,s,r),f.getCheckedItems().length===e&&(t.click(),this.checked=!0,1===e&&(rewriteSpanHtml(u,p),assignDeselect(this,h,o,a,g)))}),h.find('a[data-crud="remove"]').on("click",function(){g.removeFunction(this)}),h.find('a[data-crud="update"]').on("click",function(){g.updateFunction(this)}),h.find('a[data-options-select="'+o+'"]').off("click.textmagic").on("click.textmagic",function(t){g.selectAllFunction(this),t.preventDefault(),optionsTableToggle(a,"check"),a.data("checked","all"),v(this).closest(l).addClass("selected")}),assignDeselect(this,h,o,a,g),h.find("th[data-field]").on("click.crudSort",function(t){t.preventDefault();var t=v(this).data("field"),e="asc",a=(t==n.getOptions().requestParams.orderBy&&(e=v(this).hasClass("headerSortUp")?"desc":"asc"),n.getOptions().requestParams.params);n.setOptions({requestParams:{cmd:g.paginationCommand,orderBy:t,direction:e,params:a}}).setRequestParams({}).reload()}),g.spin&&spinIt(h,"disable"),appendNoResults(a),function(t){if(m.commandUrl)paramsSection=m.commandUrl.replace(/\//gi,"_")+"_"+m.paginationCommand;else{if(!b.commandUrl)return"console"in window&&console.log("No section for save default params data");paramsSection=b.commandUrl.replace(/\//gi,"_")+"_"+b.paginationCommand}params={direction:t.requestParams.direction,orderBy:t.requestParams.orderBy,perPage:t.perPage},Cookies.set(paramsSection,params,{expires:365})}(n.getOptions()),g.afterReloadFunction(),syncOptionsTableButtons()},callbackReloadError:function(t,e){g.spin&&spinIt(h,"disable"),g.afterReloadFunction(t,e)}},function(t){initSearchWidget(e,t,g.searchFormSelector,g.dateListSelector,g.datePairSelector,g.searchAfterInit,g.preSearchCallback),g.dontInitExport||initExportWidget(t,"a.export-lnk"),initDateFilterWidget()}),g.reloadAfterInit&&o.reload()}return t(m),f={getPaginationApi:function(){return o},getOptions:function(){return g},setOptions:t,disableSpin:function(){g.spin=!1},enableSpin:function(){g.spin=!0},getCheckedItems:function(){return i},setCheckedItems:function(t){return i=[],this.addCheckedItems(t),g.checkedItemsChangeFunction(),this.getCheckedItems()},addCheckedItems:function(t){for(var e=0;e<t.length;e++)i.pushOnce(t[e]);return g.checkedItemsChangeFunction(),this.getCheckedItems()},removeCheckedItems:function(t){for(var e=0;e<t.length;e++)i.popAll(t[e]);return g.checkedItemsChangeFunction(),this.getCheckedItems()},getCheckedAllItems:function(){return s},setCheckedAllItems:function(t){return s=t,g.checkedItemsChangeFunction(),this.getCheckedAllItems()},post:function(t,e){v.post(g.commandUrl,t).done(function(t){return e&&e(t),t}).fail(function(){return!1})},removeItems:function(t,e){t={cmd:g.removeCommand,ids:t,params:o.getRequestParams().params};s=!(i=[]),e?this.post(t,e):v.when(this.post(t)).then(o.reload())},updateItems:function(t,e,a,n){t={cmd:g.updateCommand,ids:t,field:e,value:a};s=!(i=[]),n?this.post(t,n):v.when(this.post(t)).then(o.reload())}}},v.simpleEmailValidate=function(t){return/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(t)},v.confirmDefferedExport=function(r){var t=Math.floor(1e6*Math.random()),r=v.extend({},{title:"Send the download link to an email",message:"Export of data can take some time. Please enter email address, and we will send a download link as soon as possible."},r),d=v('meta[name="csrf-token"]').attr("content"),e=['<div id="defferedExportModal_'+t+'" class="modal modal-sm fade" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="false">','<div class="modal-dialog">','<div class="modal-content">','<div class="modal-body text-center">',"<h2>"+r.title+"</h2>","<p>"+r.message+"</p>",'<div class="form-group">','<input class="form-control" type="text" name="export_email"/>',"</div>",'<p class="confirmModalButtons">','<button class="btn btn-default" type="button" data-dismiss="modal" data-crud="export-cancel">Cancel</button>','<button class="btn btn-success btn-solid disabled" type="button" data-crud="send-export">Send</button>',"</p>","</div>","</div>","</div>","</div>"].join(""),l=(v(e).hide().appendTo("body").modal("show"),v("#defferedExportModal_"+t)),a=v('button[data-crud="send-export"]'),e=(a.btn("disable"),void 0!==app.u_email?app.u_email:"");l.find('input[name="export_email"]').val(e).focus(),l.find('button[data-crud="send-export"]').on("click",function(){var e=this,t=r.last,a=r.exportLnk,n=l.find('input[name="export_email"]').val(),o=v("[data-crud-export-count]"),i=v('[data-widget="top-alert"]'),s=v('[data-crud="export-cancel"]');if(app.data.user&&app.data.user.exportDisabled)return i.warningBlock(msgExportDisabled),l.modal("hide"),!1;if(o.length&&parseInt(o.attr("data-crud-export-count"))>r.maxExport)return i.warningBlock("Your exported file is too large. Please contact support to get the requested file."),l.modal("hide"),!1;t.defExport=!0,t.exportEmail=encodeURIComponent(n),delete t.page;o=decodeURIComponent(v.param(t)),n=a.attr("href"),t=0<n.indexOf("?")?"&":"?";((n=n+t+o).includes("messages_sent_ajax")||n.includes("contacts_ajax"))&&(n=n+"&_csrf_token="+encodeURIComponent(d)),v.ajax({beforeSend:function(){s.prop("disabled",!0),v(e).spin("enable","Sending...")},method:"GET",url:n,success:function(t){v(e).spin("disable"),s.prop("disabled",!1),l.modal("hide"),i.successBlock("Your data is now being prepared for download. We will send a download link to your email address as soon as possible.")},error:function(t){v(e).spin("disable"),s.prop("disabled",!1),l.modal("hide"),i.warningBlock("Sorry, but it looks like something has gone wrong. Please try again or contact us at support@textmagic.com.")}})}),l.find('input[name="export_email"]').on("input change click keyup blur focus",function(){var t=v(this).val();v.simpleEmailValidate(t)?a.btn("enable"):a.btn("disable")})},v.confirmDeleteAll=function(e){var t=Math.floor(1e6*Math.random()),a={title:"Delete all items",message:"To delete all items, please enter "+this.confirmText+" here",confirmText:"DELETE MY ITEMS",deleteButtonText:"Delete",cancelButtonText:"Cancel",deleteButtonCallback:function(){},cancelButtonCallback:function(){}},a=['<div id="confirmAllModal_'+t+'" class="modal modal-sm fade" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="false">','<div class="modal-dialog">','<div class="modal-content">','<div class="modal-body text-center">',"<h2>"+(e=v.extend({},a,e)).title+"</h2>","<p>"+e.message+"</p>",'<p class="confirmModalButtons">','<button class="btn btn-default" type="button" data-dismiss="modal" data-crud="cancel">'+e.cancelButtonText+"</button>",'<button class="btn btn-danger disabled" type="button" data-crud="remove-all-items">'+e.deleteButtonText+"</button>","</p>","</div>","</div>","</div>","</div>"].join(""),n=(v(a).hide().appendTo("body").modal("show"),v("#confirmAllModal_"+t));n.find('button[data-crud="remove-all-items"]').on("click.confirmDeleteAll",function(t){t.preventDefault(),v(this).spin("enable"),v(this).siblings("[data-dismiss]").btn("disable"),e.deleteButtonCallback(),void 0===e.preventModalHide&&(n.modal("hide"),n.remove())}),n.find('button[data-crud="cancel"]').on("click.confirmDeleteAll",function(t){t.preventDefault(),e.cancelButtonCallback(),n.modal("hide"),n.remove()})},v.confirmInp=function(e){var t,a={title:"Do action",message:"Are you sure you would like to do this action?",yesButtonText:"Do action",cancelButtonText:"Cancel",modalId:"confirmWithInput_"+Math.floor(1e6*Math.random()),inp_name:null,inp_placeholder:null,yesButtonCallback:function(){},cancelButtonCallback:function(){}},a=((e=v.extend({},a,e)).inp_name&&(t='<div class="form-group"><input class="form-control" type="text" name="'+e.inp_name+'" placeholder="'+e.inp_placeholder+'" /></div>'),['<div id="'+e.modalId+'" class="modal modal-sm fade" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="false">','<div class="modal-dialog">','<div class="modal-content">','<div class="modal-body text-center">',"<h2>"+e.title+"</h2>","<p>"+e.message+"</p>",'<div class="form-group">','<input class="form-control" type="text" name="confirmation_text" placeholder="Enter password" autocomplete="off"/>',"</div>",t,'<p class="confirmModalButtons">','<button class="btn btn-default" type="button" data-dismiss="modal" data-crud="confirm-cancel-btn">'+e.cancelButtonText+"</button>",'<button class="btn btn-danger" type="button" data-crud="confirm-yes-btn">'+e.yesButtonText+"</button>","</p>","</div>","</div>","</div>","</div>"].join("")),n=(v(a).hide().appendTo("body").modal("show"),v("#"+e.modalId));n.find('button[data-crud="confirm-yes-btn"]').on("click",function(t){t.preventDefault(),v(this).spin("enable","Processing..."),v(this).siblings("[data-dismiss]").btn("disable"),e.yesButtonCallback(),void 0===e.preventModalHide&&(n.modal("hide"),n.remove())}),n.find('button[data-crud="confirm-cancel-btn"]').on("click",function(t){t.preventDefault(),e.cancelButtonCallback(),n.modal("hide"),n.remove()})}}(jQuery);var templateCrudApi,templateId=!1,paginationCommand="table",paginationScroll=!1,ajaxUrl="/online/messages/templates/ajax",Contact=($(document).ready(function(){var i={smsLeft:6},s=$('[data-widget="top-alert"]'),r=$.prepareCrudPage({containerSelector:"#templates-content",itemSelector:"tr[data-widget=template]",commandUrl:ajaxUrl,paginationCommand:paginationCommand,paginationScroll:paginationScroll,removeFunction:function(t){var n=$(t).closest("tr").data("id");$.confirm({title:"Delete template",message:"Are you sure you would like to delete this template?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Delete",class:"btn btn-danger",click:function(){var e=this,a=$(this).find("button.btn-danger");a.spin("enable","Deleting..."),r.removeItems(n,function(t){a.spin("disable"),$(e).modal("hide"),r.setCheckedItems([]),r.getPaginationApi().reload(),t&&0==t.success?s.warningBlock(t.message):s.successBlock("The selected template has been successfully deleted.")});r.setCheckedItems([])}}}})},bulkRemoveFunction:function(t){var n=r.getCheckedItems(),e="template";return(1<n.length||r.getCheckedAllItems())&&(e+="s"),$.confirm({title:"Delete "+e,message:"Are you sure you would like to delete selected "+e+"?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Delete",class:"btn btn-danger",click:function(){var e=this,a=$(this).find("button.btn-danger");a.spin("enable","Deleting..."),r.removeItems(!1===r.getCheckedAllItems()?n:"all",function(t){a.spin("disable"),$(e).modal("hide"),r.getPaginationApi().reload(),t&&0==t.success?s.warningBlock(t.message):s.successBlock("The selected templates have been successfully deleted.")});r.setCheckedItems([])}}}}),!0},afterReloadFunction:function(){r.setCheckedAllItems(!1),"table"!=paginationCommand?$("#templatesTable").addClass("table-radio"):$("#templatesTable").removeClass("table-radio"),$('a[data-widget="edit"]').on("click",function(t){return t.preventDefault(),hideErrors(),templateId=$(this).closest("tr").data("id"),$("#addTemplateModal .modal-title").text("Edit template"),$('#addTemplateModal button[data-widget="submit-template"]'),$("#addListName").val($(this).closest("tr").find('[data-content="name"]').text().trim()),$("#editTmplText").val($(this).closest("tr").find("[data-content-body]").data("content-body")).msgCount(i).trigger("input").change(),!0})},checkboxChangeFunction:function(t){var e=$(t).closest("tr").data("id");return $(t).is(":checked")?r.addCheckedItems([e]):r.removeCheckedItems([e]),!0},checkedItemsChangeFunction:function(){},searchFormSelector:"#templates-search"});templateCrudApi=r,"undefined"!=typeof AHServiceContainer&&(t=AHServiceContainer.get("Textmagic::ModalBundle::App"))&&t.setCallbackSuccessTemplateForm(function(){r.getPaginationApi().reload()}),$('button[data-widget="submit-template"]').click(function(t){var e=$(this),a=templateId?"The selected template has been successfully edited.":"New template has been successfully created.",t=(t.preventDefault(),hideErrors(),e.spin("enable","Saving..."),{cmd:"updateTemplate",name:$("#addListName").val(),content:$("#editTmplText").val(),templateId:templateId});$.post(ajaxUrl,t).done(function(t){if(1==t.success)return e.spin("disable"),null!=r.getPaginationApi()&&(r.setOptions({refresh:!0}),r.getPaginationApi().reload()),$("#addTemplateModal").modal("hide"),$("#addTemplateModal2").length&&$("#addTemplateModal2").modal("show"),s.successBlock(a),!0;e.spin("disable"),t.message.body?($("[data-id=editTmplTextField]").closest("div").after("<span class='error help-block'>"+t.message.body+"</span>"),$("[data-id=editTmplTextFormGroup]").addClass("has-error")):parseAllErrors(t.message),e.spin("disable")}).fail(function(){return $(this).spin("disable"),!1})}),$('a[data-widget="new"]').on("click",function(t){return t.preventDefault(),templateId=!1,hideErrors(),$("#addTemplateModal .modal-title").text("Create new template"),$('#addTemplateModal button[data-widget="submit-template"]'),$("#addListName").val(""),$("#editTmplText").val("").msgCount(i).change(),!0}),$(document).on("click",'a[data-widget="save-as-template"]',function(){templateId=!1;var a,n,e,t=parseInt($(this).data("id")),o=$(this).data("source");t=t,o=o,a=$("#addListName"),n=$("#editTmplText"),e=$("#addTemplateBtn"),$.ajax({url:ajaxUrl,dataType:"JSON",method:"POST",data:{cmd:"fetchTemplateContent",id:t,source:o},beforeSend:function(){a.prop("disabled","disabled"),n.prop("disabled","disabled"),e.prop("disabled","disabled")},success:function(t){var e="";t.success&&(e=t.data.content),a.val(""),n.val(e).msgCount(i).change()},error:function(t){console.warn(t)},complete:function(t){a.prop("disabled",!1),n.prop("disabled",!1),e.prop("disabled",!1)}})}),$(document).on("click",'[data-widget="new-message-row"]',function(){var t=$(this).closest("tr").data("id");t=t,t=$('<form action="/online/messages/new" method="post" style="display: none;"><input type="text" name="templateId" value="'+t+'" /></form>'),$("body").append(t),$(t).submit()}),$(document).on("click",'[data-widget="set-opt-out-template"]',function(){parseInt($(this).closest("tr").data("id"))}),$(document).on("click",'[data-widget="unset-opt-out-template"]',function(){}),$(document).on("click",".duplicate-template",function(t){t.preventDefault();var a=$(t.target).data("template-id");$.confirm({title:"Duplicate template",message:"Are you sure you would like to duplicate the template?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Duplicate template",class:"btn btn-success",click:function(){var t=$(this).find("button.btn-success"),e=this;t.spin("enable","Duplication..."),r.post({cmd:"duplicateTemplate",templateId:a},function(){t.spin("disable"),$(e).modal("hide"),r.getPaginationApi().reload()})}}}})}),$('[data-widget="restore"]').on("click",function(t){$.confirm({title:"Restore templates",message:"Are you sure you would like to restore the selected templates?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Restore",class:"btn btn-danger",click:function(){function t(){s.successBlock("The selected templates have been successfully restored."),r.getPaginationApi().reload()}r.getCheckedAllItems()?r.updateItems("RESTORE MY TEMPLATES","archived",0,t):r.updateItems(r.getCheckedItems(),"archived",0,t),$(this).modal("hide")}}}})});var d,t=$('[data-widget="copy-templates"]'),e=$('[data-widget="copy-templates-pane"]'),l=$("#subAccountsModal"),c=null;$(document.body).on("click",'[data-widget="copy-templates-row"]',function(){c=parseInt($(this).closest("tr").data("id"))}),e.on("click",function(){c=null}),t.on("click",function(){var a,n,o=r.getCheckedItems(),i=r.getCheckedAllItems();c&&(i=!(o=[c])),window.saCrudApi&&(d=window.saCrudApi,a=d.getCheckedItems(),n=d.getCheckedAllItems()),$("#subaccounts-search").find('input[name="search-query"]').val().trim()&&(n=!1),$("#templates-search").find('input[name="search-query"]').val().trim()&&(i=!1),$.confirm({title:"Share with sub-accounts",message:"The selected templates will be copied to the selected sub-accounts. This action cannot be undone. Are you sure you would like to share the selected templates with the sub-accounts?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Share templates",class:"btn btn-success",click:function(){var e=$(this),t=e.find(".btn.btn-success");$.ajax({url:ajaxUrl,dataType:"JSON",method:"POST",data:{cmd:"copyToPeople",tIds:o,tAll:i,sIds:a,sAll:n},beforeSend:function(){t.spin("enable")},success:function(t){t.success&&(r.setCheckedItems([]),r.setCheckedAllItems(!1),r.getPaginationApi().reload(),s.successBlock(t.message),d&&(d.setCheckedAllItems(!1),d.setCheckedItems([]),d.getPaginationApi().reload()))},error:function(t){console.warn(t)},complete:function(t){c=null,e.modal("hide"),l.modal("hide")}})}}}})}),$(document.body).on("change",".table-radio input:checkbox",function(){var t=this;$(this).closest("table").find("input:checkbox").filter(function(){return this!==t}).prop("checked",!1),$(this).prop("checked")?r.setCheckedItems([$(this).closest("tr").data("id")]):r.setCheckedItems([])}),$("#addTemplateModal").on("shown.bs.modal",function(){$("#editTmplText").trigger("input")})}),!function(b){b.fn.tagsField=function(t){var m=b.extend({},{tags:["first_name","last_name","company_name","phone","email"],open:"{",close:"}",add_tag_link_selector:"a.add-tag-link",approximately_selector:!1,afterInsert:function(){}},t),f=this;function a(){for(var t,e,a,n=f.prev(),o=g(f.val()),i=0,s=m.open.length,r=m.close.length,d=o.indexOf(m.open),l=o.indexOf(m.close,d+1),c="",u=d<0||l<0?o:o.substring(0,d);-1!=d&&-1!=l;){i++;var p=l,c=o.substring(d+s,l),h=0<m.tags.filter(function(t){return g(t)===c}).length||"http"==c.substr(0,4).toLowerCase();h=h,a=e=void 0,a="","object"==typeof(e=t=c)&&(e=t.name,t.phone!=t.name&&void 0!==t.phone&&(a='<span class="hint">('+t.phone+")</span>")),u=(u+=c='<span class="tag-item '+(0==h?"error":"")+'">'+e+a+'<a href="#" class="close" onclick="removeTag(this.parentNode); return false;">&times;</a></span>')+((d=o.indexOf(m.open,l+r))<0?o.substring(l+r):(l=o.indexOf(m.close,d+s))<0?o.substring(p+r):o.substring(p+r,d))}0!=m.approximately_selector&&b(m.approximately_selector).text(0<i?"~":""),u=u.split("\n").join("</br>"),n.html(u)}function g(t){return t.replace(/[&"<>]/g,function(t){return{"&":"&amp;",'"':"&quot;","<":"&lt;",">":"&gt;"}[t]})}function e(t){var e=t;a(),e.prev().scrollTop(t[0].scrollTop),e.css("opacity",0)}return t=f.prop("placeholder"),f.wrap('<div style="position: relative;"></div>').before('<div data-placeholder="'+t+'" class="form-control editable" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>'),b(m.add_tag_link_selector).click(function(t){t.preventDefault();t=b(this).text(),t=m.open+t+m.close;f.textAtCaret(t),f.change().blur(),m.afterInsert(t)}),b(window).blur(function(){e(f)}),f.on("blur",function(){e(f)}).on("focus",function(){b(this).css("opacity",1)}).on("input.msg propertychange.msg",function(){var t=b(this);t.attr("rows",t.val().split("\n").length)}).on("change",function(){a()}).change().trigger("input.msg"),0<f.val().length&&f.blur(),{getOptions:function(){return m}}}}(jQuery),function(t){this.init(t)}),SelectContact=(Contact.prototype.init=function(n){var o=this;this.options=$.extend({},{paginationCommand:"table",paginationScroll:!1,itemSelector:"tr[data-widget=contact]",searchFormSelector:"#contacts-search",initExportLnk:1,paginationRecount:!0,beforeReloadFunction:function(t){var e=o.extractFids(n.fids,!0),a=t.getOptions().requestParams;e.cfids&&(a.params&&a.params.text&&(a.hasOwnProperty("params")?a.params=$.extend({},a.params,{cfids:e.cfids}):a.params={cfids:e.cfids},t.setOptions({requestParams:a})),hideErrors())},afterReloadFunction:function(t,e){if(!n.fids||"unsubscribers"===o.listid)return!1;var a=o.extractFids(n.fids,!0),a=(o.displayTableColumns(a.cfids,a.nfids),$(this.containerSelector).find("table"));1===a.find("tbody > tr.empty").length&&a.find("thead > tr > th").removeClass("hidden"),e&&e.responseText&&parseAllErrors(JSON.parse(e.responseText).message)}},n),this.updateContactSubmitBtn='button[data-widget="submit-contact"]',this.moveContactBtn=$('button[data-widget="move-contact"]'),this.removeContactBtn=$('button[data-widget="remove-contact"]'),this.moveContactLnk='a[data-widget="move-contact-lnk"]',this.updateForm=$("#updateContactForm"),this.addBlockedForm=$("#addBlockedNumberForm"),this.sendBtn=$("[data-widget=send]"),this.moveContactModal=$("#moveContacts"),this.removeContactModal=$("#removeContacts"),this.editContactBtn=$('[data-widget="contact_edit"]'),this.moveOptionsContainer=$("#moveContactOptions"),this.removeOptionsContainer=$("#removeContactOptions"),this.addListTagLnk='[data-widget="addtag"]',this.reloadContactLnk='[data-widget="reload-contact"]',this.unblockAndReloadLnk='[data-widget="unblock-and-reload"]',this.deleteBtn=$('[data-action="trash"]'),this.removeListTag="span.tag-item",this.contactListsContainer="#contact-lists-container",this.updateContactModal=$("#updateContactModal"),this.updateContactFormModal=$("#update-contact-form-modal"),this.profileHeaderFullname=$(".contact-profile.title > #fullname"),this.profileHeaderPhone=$(".contact-profile.title > .phone"),this.firstNameInput='#updateContactForm input[data-field="firstName"]',this.lastNameInput='#updateContactForm input[data-field="lastName"]',this.phoneInput='#updateContactForm input[data-field="phone"]',this.emailInput='#updateContactForm input[data-field="email"]',this.companyInput='#updateContactForm input[data-field="companyName"]',this.countrySelect='#updateContactForm select[data-field="country"]',this.phoneTypeSelect='#updateContactForm select[data-field="phoneType"]',this.addAnotherChk="#addAnother",this.tabListBadge=$("#contacts-tabs").find("li:nth-child(1)").find("span"),this.tabBadge=$("#contacts-tabs").find("li:nth-child(2)").find("span"),this.tabBlocked=$("#contacts-tabs").find("li:nth-child(6)").find("span"),this.tabNotes=$("#contact-profile-tabs").find("li:nth-child(2)").find("span"),this.headerBadge=$(".contacts-count"),this.contactDataEl=$("#contact-data"),this.removeProfileBtn=$('[data-widget="remove-profile"]'),this.restoreBtn=$('[data-widget="restore"]'),this.deletePermanentlyBtn=$('[data-widget="delete-permanently"]'),this.topAlert=$('[data-widget="top-alert"]'),this.addContactOneLnk=$("a.btn-add-people.one"),this.exportContactProfile=$(".export-contact-profile-lnk"),this.unsubscribeBtn=$("#unsubscribe-btn"),this.blockIncomingChk=$("#block-incoming-chk"),this.blockSingleNumberBtn=$("#block-single-number-btn"),this.unblockSingleNumberBtn=$("#unblock-single-number-btn"),this.unsubscribeModalBtn=$("#unsubscribe-modal-btn"),this.blockModalBtn=$("#block-modal-btn"),this.unsubscribeName=$("span#unsubscribed-contact-name"),this.blockedName=$("span#blocked-contact-name"),this.unsubscribePhone=$("span#unsubscribed-contact-phone"),this.contactDataSpan="#contact-data > span.badge",this.unsubscribeModal=$("#unsubscribeModal"),this.blockSingleNumberModal=$("#blockSingleNumberModal"),this.unblockSingleNumberModal=$("#unblockSingleNumberModal"),this.initExportLnk=this.options.initExportLnk,this.sendRowBtn='[data-widget="send-row"]',this.unsubscribeRowBtn='[data-widget="unsubscribe-row"]',this.deleteRowBtn='[data-widget="delete-row"]',this.editRowBtn='[data-widget="edit-row"]',this.saveContactRowBtn='[data-widget="save-contact-row"]',this.createListBtn='[data-widget="create-new-list"]',this.inpInlineListName='[data-widget="inline-list-name"]',this.inpInlineDropdown=".input-inline-dropdown",this.btnInlineCreateList='[data-widget="inline-submit"]',this.inpLiveSearch='[data-widget="live-search-dropdown"]',this.messageDetailModal=$("#messagedetailModal"),this.sfCallbackFlag=this.options.sfCallbackFlag,this.listsContainerImport=$("table#file-info-table td#import-lists-container"),this.avatar=$(".avatar-wrapper > .avatar"),this.avatarLabel=$(".avatar-wrapper .avatar-label"),this.avatarControl=this.avatar.find(".avatar-control"),this.avatarChangeBtn='[data-widget="change-avatar"]',this.avatarRemoveBtn='[data-widget="remove-avatar"]',this.avatarUploadForm=$("#form_avatar"),this.avatarFileInput=this.avatarUploadForm.find('input[type="file"]'),this.avatarUploadPreModal=$("#upload-preview-modal"),this.avatarCropForm=$("#contact-image-form"),this.contactFieldFilterModal=$("#contact-field-filter"),this.tableConfigureModal=$("#table-configure-modal"),this.applyContactFieldFilterBtn=this.contactFieldFilterModal.find('[data-action="apply-filter"]'),this.applyContactsPageSettingsBtn=this.tableConfigureModal.find('[data-action="apply-contact-page-settings"]'),this.addEditNoteModal=$("#addNoteModal"),this.addEditNoteModalTitle=this.addEditNoteModal.find(".modal-title"),this.addEditNoteModalText=this.addEditNoteModal.find("#note-text"),this.addEditNoteModalSubmitBtn=this.addEditNoteModal.find('[data-widget="submit-note"]'),this.modalAddBlockedNumber=$("#addBlockedNumberModal"),this.inpBlockedNumber='#addBlockedNumberForm input[data-field="phone"]',this.selectBlockedCountry='#addBlockedNumberForm select[data-field="country"]',this.btnAddBlockedNumberSubmit=$('[data-widget="submit-blocked-number"]'),this.notesEmptySearchScr=$(".notes-empty-search-screen"),this.btnRowRemoveUnsubscribers='[data-widget="remove-unsubscriber-row"]',this.btnUnsubscribersSwitchReason='[data-widget="switch-reason-unsubscriber-row"]',this.autoUnsubscribeModal=$("#autounsubModal"),this.autoUnsubscribeCheckbox=$('[data-field="autounsub"]'),this.autoUnsubscribeCounterContainer=$('[data-widget="after"]'),this.inpAutoUnsubscribeCounter=$('[data-field="after-input"]'),this.autoUnsubscribe=!1,this.autoUnsubscribeCounter=5,this.btnSaveAutoUnsubscribe=$('[data-widget="save-settings"]'),this.defaultReplyContainer=$('[data-widget="stop-reply-default"]'),this.customReplyContainer=$('[data-widget="stop-reply-custom"]'),this.selectReplyTemplateBtn=$('[data-widget="select-opt-out-template"]'),this.removeReplyTemplateBtn=$('[data-widget="unset-opt-out-template"]'),this.addTemplateModal=$("#addTemplateModal2"),this.useTemplateBtnSelector='[data-widget="set-opt-out-template"]',this.customReplyInp=$('[data-widget="stop-reply-text"]'),this.sendStopReply=!1,this.sendStopReplyOnManual=!1,this.stopReplyTemplateId=null,this.stopReplyTemplateName=null,this.sendStopReplyCheckbox=$('[data-field="stop-reply"]'),this.sendStopReplyOnManualCheckbox=$('[data-field="stop-reply-manual"]'),this.stopReplySettingsContainer=$('[data-widget="stop-reply-settings"]'),this.sendStopReplyRadios=$('[name="stop-reply"]'),this.autoUnsubscribeRadios=$('[name="autounsub"]'),this.skipCloseChatAfterUnsubscribe=!1,this.skipCloseChatAfterUnsubscribeRadiosOff=$('[name="skipCloseChatAfterUnsubscribe"][value="0"]'),this.skipCloseChatAfterUnsubscribeRadiosOn=$('[name="skipCloseChatAfterUnsubscribe"][value="1"]'),this.addNoteBtn=$('[data-widget="add-note"]'),this.noteContent=$(".contact-note-content"),this.btnNotesDelete=$('[data-widget="delete-all-notes"]'),this.notesEmptyScr=$(".notes-empty-screen"),this.btnNoteEdit='[data-widget="edit-note"]',this.btnNoteDelete='[data-widget="delete-note"]',this.btnNoteUndo='[data-widget="undo-change"]',this.btnNoteSave='[data-widget="save-change"]',this.notesContainer="#notes-wrapper",this.notesLoadMore='[data-widget="notes-load-more"]',this.formNoteSearch=$("form#notes-search"),this.btnFavTable='[data-widget="toggle-fav-contact"]',this.blockBtn=$('[data-widget="block"]'),this.btnToggleBlock='[data-widget="toggle-block"]',this.blockRowBtn='[data-widget="block-row"]',this.unblockBtn=$('[data-widget="unblock"]'),this.unblockRowBtn='[data-widget="unblock-row"]',this.noteCounter=$('[data-msg-count="note-text"]'),this.btnFavPanel=$('[data-widget="toggle-fav-panel"]'),this.moveLink=$("#contacts_move_to"),this.cfTableTbody="#custom_fields_table tbody",this.btnSaveInPrfl='[data-action="save-in-profile"]',this.btnEditInPrfl='[data-action="edit-in-profile"]',this.btnCncInPrfl='[data-action="cancel-in-profile"]',this.inpInPrfl='[data-widget="input-in-profile"]',this.textInPrfl='[data-widget="text-in-profile"]',this.listids=[],this.cid=null,this.mvToListId=null,this.listid=null,this.isSharedList=!1,this.xhrRunning=!1,this.noteId=null,this.noteOrigText={},this.noteSearchTimer=null,this.getNoteURI=this.options.getNoteURI||"/online/contacts/note",this.getNoteListURI=this.options.getNoteListURI||"/online/contacts/note/list",this.saveAutoUnsubscribeURI=this.options.saveAutoUnsubscribeURI||"/online/contacts/ajax",this.profileAjaxURI="/online/contacts/ajaxprofile",this.saveAutoUnsubscribeCmd="saveUnsubscribe",this.listCrudApi=null,0<this.moveLink.length&&(!app.data.user||0!=app.data.user.disallowedRules.length&&-1!=app.data.user.disallowedRules.indexOf("CREATE_LIST")||o.addCreateListOptToMenu(o.moveLink.next("ul.dropdown-menu"),"move-menu")),this.initListeners(),this.initCrudApi()},Contact.prototype.extractFids=function(t,e=!1){var a={},n={};return $.each(t,function(t,e){if(!parseInt(e))return n[t]=e,!0;a[t]=parseInt(e)}),{nfids:n=e?this.sortNfids(n):n,cfids:a}},Contact.prototype.sortNfids=function(t){var e,a={0:"Favorited",1:"First name",2:"Last name",3:"Phone",4:"Type",5:"Company",6:"Email",7:"Country"},n=Object.values(t),o={};for(e in a)0!==e&&0<=n.indexOf(a[e])&&(o[e]=a[e]);return o},Contact.prototype.initSortableElement=function(a){var t,n=this;window.sortable&&(t=a+" > tr > th",$(document.body).on("mousedown",t,function(t){sortable(a,{items:"tr",placeholder:'<tr><th class="col-sm-3"></th><td class="col-sm-7"></td><td class="col-sm-2"></td></tr>',forcePlaceholderSize:!0}),$(this).closest(a)[0].addEventListener("sortstop",function(t){var e=[];$(document.body).find(a+" tr").each(function(){var t=parseInt($(this).attr("data-cfid"));t&&e.pushOnce(t)}),$.ajax({url:n.options.commandUrl,dataType:"JSON",method:"POST",data:{cmd:"sortCustomFields",ids:e},beforeSend:function(){$(a).spin("enable")},success:function(t){},error:function(t){console.warn(t)},complete:function(t){$(a).spin("disable"),sortable(a,"destroy")}})})}))},Contact.prototype.initListeners=function(){var n=this;$(document.body).on("click",this.addListTagLnk,function(t){t.preventDefault();t=$(this).data("id");if($("span.tag-item[data-id="+t+"]").length)return!0;n.addTag(t,$(this).html())}),$(document.body).on("click","#update-contact-form-modal span.tag-item",function(t){t.preventDefault();t=$(this).data("id"),t=$(n.contactListsContainer).find('[data-id="'+t+'"]');removeTag(this),t.length&&t.closest("li").removeClass("hidden")}),$(document.body).off("click",this.createListBtn).on("click",this.createListBtn,function(t){return t.preventDefault(),t.stopPropagation(),n.createListInlineClickHandler(this),!1}),$(document.body).on("click",this.inpInlineDropdown,function(t){return t.stopPropagation(),!1}),$(document.body).on("click",this.btnInlineCreateList,function(t){return t.preventDefault(),n.btnInlineCreateListClickHandler(this),!1}),$(document.body).on("keyup",this.inpLiveSearch,function(t){var e="^(?=.*\\b"+$.trim($(this).val()).split(/\s+/).join("\\b)(?=.*\\b")+").*$",a=RegExp(e,"i"),e="search-hidden";$(this).closest("ul").find("li").not(".li-not-searchable").removeClass(e).filter(function(){var t=$(this).find("a").text().replace(/\s+/g," ");return!a.test(t)}).addClass(e)}),$(document.body).off("click",this.reloadContactLnk).on("click",this.reloadContactLnk,function(t){t.preventDefault();var t=$(this).data("id"),e={url:"/online/contacts/loadform/"+t,listid:n.listid};n.loadContactForm(e),n.cid=t}),$(document.body).on("click",this.unblockAndReloadLnk,function(t){t.preventDefault();var e=$(this).attr("data-id"),a=$(this).attr("data-blocked-phone");hideErrors(),n.updateContactFormModal.find("input, select").prop("disabled",!0),n.unblockSingleNumberHandler({phone:a,callback:function(){n.loadContactForm({url:"/online/contacts/loadform/"+e,callback:function(){var t=n.updateContactFormModal.find('input[data-field="phone"]');t.val()?n.cid=e:(t.val("+"+a).trigger("keyup"),n.cid=null)}})}})}),this.moveContactBtn.on("click",function(t){t.preventDefault(),n.moveBtnClickHandler()}),this.removeContactBtn.on("click",function(t){t.preventDefault(),n.removeBtnClickHandler()}),$(document.body).on("click",this.moveContactLnk,function(t){t.preventDefault(),n.mvToListId=parseInt($(this).data("id"))}),this.addNoteBtn.on("click",function(t){t.preventDefault(),n.addNoteBtnClickHandler()}),1===this.initExportLnk&&$("a.export-lnk").on("click",function(){n.crudApi.getPaginationApi().setOptions({refresh:!1}).setRequestParams({listId:n.listid})}),this.removeProfileBtn.on("click",function(t){t.preventDefault(),$.confirm({title:"Delete contact",message:"Contact will be deleted permanently<br>Are you sure you would like to delete it?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Delete",class:"btn btn-danger",click:function(){var t={cmd:"removeContact",contacts:[n.cid],profile:!0},e=($(this).find("button.btn-danger").spin("enable","Deleting..."),this);$.post(n.options.commandUrl,t).done(function(t){1==t.success?location.reload():(n.topAlert.warningBlock("An error occurred while removing."),$(e).modal("hide"))})}}}})}),this.restoreBtn.on("click",function(t){t.preventDefault(),n.restoreBtnClickHandler()}),this.blockBtn.on("click",function(t){t.preventDefault(),n.blockBtnClickHandler()}),this.unblockBtn.on("click",function(t){t.preventDefault(),n.unblockBtnClickHandler()}),$(document.body).on("shown.bs.dropdown","#contactsTable .dropdown",function(){var t,e,a=$(this).closest("#contact-table-wrapper");0!==a.length&&(t=a.height())<(e=parseInt(a.prop("scrollHeight")))&&a.data("delta-height",a=e-t+30).height(t+a)}),$(document.body).on("hide.bs.dropdown","#contactsTable .dropdown",function(){var t,e=$("#contact-table-wrapper");0!==e.length&&(t=parseInt(e.data("delta-height")))&&(e.height(e.height()-t),e.data("delta-height",null))}),this.updateContactModal.on("show.bs.modal",function(){var t=$(this).find('input[data-field="phone"]'),e=$(this).find('select[data-field="country"]');if(0===t.length||0===e.length)return!1;n.setPhoneAndCountry(t,e,t.val())}),this.modalAddBlockedNumber.on("show.bs.modal",function(){$(this).find('[data-field="country"]').val(app.u_country),n.changePhonePrefixHandler($(this))}),$(document.body).on("change",this.selectBlockedCountry+","+this.countrySelect,function(){var t=$(this).closest('.modal[role="dialog"]');n.changePhonePrefixHandler(t)}),$(document.body).on("keyup",this.phoneInput+","+this.inpBlockedNumber,function(){var t=$(this),e=$(this).closest("form").find('select[data-field="country"]');n.inputPhoneKeyupHandler(t,e)}),$(document.body).on("click",n.btnFavTable,function(t){t.preventDefault(),n.toggleFavBtnClickHandler(this)}),this.deletePermanentlyBtn.on("click",function(t){t.preventDefault(),n.deleteBtnClickHandler()}),this.removeContactModal.on("hide.bs.modal",function(){var t=n.removeContactBtn;t.siblings("[data-dismiss]").btn("enable"),t.spin("disable")}),this.messageDetailModal.on("hide.bs.modal",function(){$(this).find('[data-widget="top-alert"]').hide()}),this.avatarUploadPreModal.on("hide.bs.modal",function(){n.resetImageForms()}),this.modalAddBlockedNumber.on("show.bs.modal",function(){hideErrors()})},Contact.prototype.btnUnsubscribersSwitchReasonClickHandler=function(t,e){var a=this;$.ajax({url:a.options.commandUrl,method:"POST",dataType:"JSON",data:{cmd:"unsubscribeSwitchReason",id:t,reason:e},beforeSend:function(){},success:function(t){t.success?(a.topAlert.successBlock(t.message),a.crudApi.getPaginationApi().reload()):a.topAlert.warningBlock(t.message||"Sorry, but it looks like something has gone wrong.")},error:function(t){console.warn(t)},complete:function(t){}})},Contact.prototype.btnRowRemoveUnsubscribersClickHandler=function(t){var n=this;$.confirm({title:"Resubscribe contact",message:"Are you sure you want to resubscribe this contact?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Resubscribe",class:"btn btn-danger",click:function(){var e=this,a=$(this).find("button.btn-danger");$.ajax({url:n.options.commandUrl,method:"POST",dataType:"JSON",data:{cmd:"removeUnsubscriber",id:t},beforeSend:function(){a.spin("enable","Deleting...")},success:function(t){t.success?(n.topAlert.successBlock(t.message),n.crudApi.getPaginationApi().reload()):n.topAlert.warningBlock(t.message||"Sorry, but it looks like something has gone wrong.")},error:function(t){console.warn(t)},complete:function(t){a.spin("disable"),$(e).modal("hide")}})}}}})},Contact.prototype.setPhoneAndCountry=function(t,e,a){if(a)return t.val(a),void this.setCountryByPhone(a,e);this.setPhonePrefixByCountry(e.val(),t)},Contact.prototype.setCountryByPhone=function(t,e){t=this.getPhoneNumberCountry(t);null!==t&&e.val(t)},Contact.prototype.setPhonePrefixByCountry=function(t,e){if("ZZ"===t)e.val("+999");else if("object"==typeof i18n&&"object"==typeof i18n.phonenumbers){var a=i18n.phonenumbers.PhoneNumberUtil.getInstance();try{var n=a.getCountryCodeForRegion(t);e.val("+"+n)}catch(t){}}},Contact.prototype.saveContactRowBtnClickHandler=function(a){var n=this;a="+"+a,this.reset({callback:function(){var t=$('input[data-field="phone"]'),e=$('select[data-field="country"]');n.setPhoneAndCountry(t,e,a)}})},Contact.prototype.changePhonePrefixHandler=function(t){var e=t.find('input[data-field="phone"]'),t=t.find('select[data-field="country"]');if(0===e.length||0===t.length)return!1;this.setPhoneAndCountry(e,t)},Contact.prototype.inputPhoneKeyupHandler=function(t,e){var t=t.val();"+"===(t="00"===t.substring(0,2)?"+"+t.substring(2):t).substring(0,1)&&(t=this.getPhoneNumberCountryCode(t,[e.val(),app.u_country]))&&0<e.find('option[value="'+t.toUpperCase()+'"]').length&&e.val(t).trigger("chosen:updated")},Contact.prototype.getPhoneNumberCountryCode=function(t,e){var a=this.getPhoneNumberCountry(t);if("object"==typeof i18n&&"object"==typeof i18n.phonenumbers){var n=i18n.phonenumbers.PhoneNumberUtil.getInstance();if(null===a)for(var o=0;o<e.length;o++)try{n.parse(t,e[o]);a=e[o];break}catch(t){}}return a},Contact.prototype.getPhoneNumberCountry=function(t){var e=null;if("+999"===t.substr(0,4))return"ZZ";if("object"==typeof i18n&&"object"==typeof i18n.phonenumbers){var a=i18n.phonenumbers.PhoneNumberUtil.getInstance();try{var n=a.parse(t,"");e=(e=a.getRegionCodeForNumber(n))||a.getRegionCodeForCountryCode(n.getCountryCode())}catch(t){}}return e},Contact.prototype.btnNotesDeleteClickHandler=function(){var a=this;$.confirm({title:"Delete all contact's notes",message:"All contact's notes will be deleted permanently. Are you sure you want to delete all contact's notes?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Delete",class:"btn btn-danger",click:function(){var e=this,t=$(this).find("button.btn-danger");$.ajax({url:a.options.commandUrl,dataType:"JSON",method:"POST",data:{cmd:"removeAllNotes",cid:a.cid},beforeSend:function(){t.spin("enable","Deleting...")},success:function(t){t.success&&(a.topAlert.successBlock(t.message),$('[data-widget="note"][data-id!=""][data-id]').remove(),a.updateCountNotes(0),a.reloadNoteList({}))},error:function(t){console.warn(t)},complete:function(t){$(e).modal("hide")}})}}}})},Contact.prototype.formNoteSearchHandler=function(t){function e(){var t=$(a.notesContainer).find(".contact-note-content");$.each(t,function(t,e){e=$(e).find("a");$.each(e,function(t,e){var a=(a=$(e).attr("href")).replace("<span class='text-highlight'>","").replace("</span>","");$(e).attr("href",a)})})}var a=this,t=$.trim(t.toLowerCase()),n=$('[data-widget="note"][data-id=""][data-id]');$.each(n,function(t,e){if($(e).hasClass("hidden"))return!0;$(e).find(a.btnNoteUndo).trigger("click")});clearTimeout(a.noteSearchTimer),a.noteSearchTimer=setTimeout(function(){$(a.notesContainer).html(""),a.getNoteList({text:t,callback:e})},500)},Contact.prototype.checkNotesEmptyState=function(){0!==this.btnNotesDelete.length&&(0===$(this.notesContainer).find('[data-widget="note"][data-id!=""][data-id]').length?this.btnNotesDelete.addClass("disabled"):this.btnNotesDelete.removeClass("disabled"))},Contact.prototype.sendCheckedItemsHandler=function(){var n,t,o,i=this,s=!1,r=this.crudApi.getCheckedItems().length,s=this.crudApi.getCheckedAllItems()?"all":this.crudApi.getCheckedItems();1<r||"all"===s?(t={cmd:"createGroup",contacts:"all"===s||s.length<=100?s:[s[0]]},o=function(t,e){var a=$("div.progress-bar");a.data("aria-valuenow",t),a.data("aria-valuemax",e),a.css("width",parseInt(100*t/e)+"%"),a.find('span[data-widget="items-processed"]').text(t),a.find('span[data-widget="items-total"]').text(e)},100<r&&(o(0,r),$("#send-progress-modal button.cancel").click(function(){$("#send-progress-modal").modal("hide")}),$("#send-progress-modal").modal("show"),$("#send-progress-modal").on("hide.bs.modal",function(t){clearTimeout(n),i.crudApi.setCheckedItems([]),i.crudApi.getPaginationApi().reload()})),this.crudApi.post(t,function(a){100<r?function e(){var t={cmd:"getCreationGroupProcess",group_id:a.data.group_id,contacts:s.splice(0,100)};i.crudApi.post(t,function(t){t.success?t.data.processed>=r?(o(t.data.processed,r),clearTimeout(n),window.location.href="/online/messages/new?groups="+t.data.group_id):(o(t.data.processed,r),n=setTimeout(function(){e()},2e3)):(clearTimeout(n),$("#send-progress-modal").modal("hide"))})}():a.success&&(window.location.href="/online/messages/new?groups="+a.data.group_id)})):window.location.href="/online/messages/new?contacts="+this.crudApi.getCheckedItems()},Contact.prototype.sendBtnClickHandler=function(){var t=this.listid&&!0===this.crudApi.getCheckedAllItems(),e=this.listid&&!1===this.crudApi.getCheckedAllItems()&&0===this.crudApi.getCheckedItems().length;t||e?window.location.href="/online/messages/new?groups="+this.listid:this.sendCheckedItemsHandler()},Contact.prototype.addCreateListOptToMenu=function(t,e){e='<li><a href="javascript:void(0);" data-widget="create-new-list"><i class="fa fa-plus"></i>Create new list</a><div class="input-group input-group-dropdown"><input type="text" class="form-control input-inline-dropdown hidden" data-source="'+e+'" style="margin-top: 5px; margin-bottom: 5px; min-width: 190px; margin-left: 5px;" data-widget="inline-list-name" placeholder="Enter list name" maxlength="100" /><span class="input-group-btn"><button class="btn btn-success btn-solid hidden" style="margin-right: 5px; margin-left: 5px;" data-widget="inline-submit">Save</button></span></div></li>';0===$(t).length?(t='<ul class="dropdown-menu pull-left dropdown-caret add-new-dropdown">'+e+"</ul>",$(t).insertAfter(this.moveLink.attr("data-toggle","dropdown"))):$(t).prepend(e)},Contact.prototype.afterCreateListSuccessCallback=function(t,e,a){var n=this,o=e.g.id,e=e.g.name,i=null;a&&(i=$(a).attr("data-source")),1===n.sfCallbackFlag&&n.subscribeFormCallback(o,e),$(this.btnInlineCreateList).addClass("hidden"),n.updateGroupList(t),n.addItemToMoveMenu(o,e),0<n.tabListBadge.length&&n.tabListBadge.load("/online/messages/lists/ajaxcount"),n.listCrudApi&&n.listCrudApi.getPaginationApi().reload(),$(n.createListBtn).btn("enable"),$(document).trigger("list:created"),i||n.addTag(o,e)},Contact.prototype.addItemToMoveMenu=function(t,e){t='<li><a href="#moveContacts" data-id="'+t+'" data-toggle="modal" data-widget="move-contact-lnk" class=""><i class="tmi30 tmi30-person-two tmi30-12px"></i> '+e+"</a></li>",e=this.moveLink.next("ul").find(this.inpInlineListName).closest("li").next("li");$(t).insertBefore(e)},Contact.prototype.createList=function(t,e){var a=this,n={cmd:"updateList",name:t||"New List",type:!0,definedGroups:[this.listid]};$.ajax({url:"/online/messages/lists/ajax",dataType:"JSON",method:"POST",data:n,beforeSend:function(){$(a.createListBtn).btn("disable"),$(a.btnInlineCreateList).btn("disable"),e.prop("disabled",!0),e.closest(".dropdown-menu").find("a").addClass("disabled")},success:function(t){t.success&&a.afterCreateListSuccessCallback(n,t.data,e)},error:function(t){console.warn(t)},complete:function(t){$(a.createListBtn).btn("enable"),$(a.btnInlineCreateList).btn("enable"),a.resetParentDropdown(e)}})},Contact.prototype.resetParentDropdown=function(t){var e=t.closest(".dropdown.open");t.closest("li").find("a").removeClass("hidden"),t.addClass("hidden").prop("disabled",!1),"move-menu"===t.attr("data-source")?(e=t.closest(".btn-group.open")).find(".dropdown-menu").find("a").removeClass("disabled"):(e.find(".dropdown-menu").find("a").removeClass("disabled"),e.removeClass("open"))},Contact.prototype.btnInlineCreateListClickHandler=function(t){var t=$(t).closest(".input-group").find('input[type="text"]'),e=$.trim(t.val());if(!e)return!1;this.createList(e,t),t.val("")},Contact.prototype.createListInlineClickHandler=function(t){var e=$(t).next(".input-group");$(t).closest(".dropdown-menu");$(t).addClass("hidden"),e.find(this.btnInlineCreateList).removeClass("hidden"),e.find(this.inpInlineListName).removeClass("hidden").focus()},Contact.prototype.removeModalMessageFormatter=function(t){var e,t=t||1===this.crudApi.getCheckedItems().length?(e="Selected contact will be deleted permanently.<br>Are you sure you would like to delete it?","Delete contact"):(e="Selected contacts will be deleted permanently.<br>Are you sure you would like to delete them?","Delete contacts");this.removeContactModal.find("h2").text(t),this.removeContactModal.find("p.confirmModalMessage").html(e)},Contact.prototype.contactFieldFilterCheckboxClickHandler=function(t){10<this.contactFieldFilterModal.find("input[data-type-custom]:checked").length&&(this.contactFieldFilterModal.find(".alert").warningBlock("Maximum amount of visible custom fields must not exceed 10."),t.attr("checked",!1))},Contact.prototype.displayTableColumns=function(t,e){var a=$("#contacts-container").find("table"),n=a.find("tr[data-widget=contact]").length,o=a.find("th").length;"unsubscribers"!==this.listid&&(Object.keys(e).length<3&&(a.find("tr").find("th:eq(0)").css("width","2%"),a.find("tr").find("th:eq(1)").css("width","2%")),Object.keys(e).length<5&&2<Object.keys(e).length&&(a.find("tr").find("th:eq(0)").css("width","3%"),a.find("tr").find("th:eq(1)").css("width","3%")));for(var i=2;i<o-1;i++)void 0===e[i-1]?(a.find("tr").find("th:eq("+i+")").addClass("hidden"),a.find("tr").find("td:eq("+i+")").addClass("hidden")):(a.find("tr").find("th:eq("+i+")").removeClass("hidden"),a.find("tr").find("td:eq("+i+")").removeClass("hidden"));0<Object.keys(t).length&&0<n&&this.joinCustomFields(t);n=a.find("tbody > tr.table-data-select"),t=Object.keys(t).length+Object.keys(e).length+3;n.find("td").prop("colspan",t)},Contact.prototype.joinCustomFields=function(e){var a,n,o,t;this.xhrRunning||(a=this,n=$("#contacts-container"),o=[],n.find("table tbody tr").each(function(t,e){o.push($(this).data("id"))}),t={fids:e,cids:o},$.ajax({url:"/online/contacts/custom-field-data",dataType:"JSON",method:"POST",data:t,beforeSend:function(){n.spin("enable"),a.xhrRunning=!0},success:function(t){t.success&&a.insertColumns(e,t.data)},error:function(t){console.warn(t)},complete:function(t){n.spin("disable"),a.xhrRunning=!1}}))},Contact.prototype.insertColumns=function(t,e){var a=$("#contacts-container"),n=a.find("table"),r=e.data||{},e=($.each(t,function(t,e){t=t.substr(3),e=$("<th>",{class:"col-xs-2","data-id":e,title:t}).text(t),t=n.find("thead").find("tr").find("th").last(),e.insertBefore(t)}),n.find("thead").find("tr").find("th[data-id]")),d=(e.css({"max-width":"190px",overflow:"hidden","text-overflow":"ellipsis","white-space":"nowrap"}),$('input[name="search-query"]').val());e.each(function(t,e){var a=$(e).index(),s=parseInt($(e).data("id"));n.find("tbody").find("tr").each(function(t,e){var o=parseInt($(this).data("id")),i=$("<td>");$.each(r,function(t,e){var a=parseInt(e.contact_id)===o,n=parseInt(e.user_custom_field_id)===s;if(a&&n&&e.field_value)return a=e.field_value,d?(a=highlight(e.field_value.escapeHtml(),d),i.html(a).attr("title",a)):i.text(a).attr("title",a),!1}),$(this).find("td").eq(a-1).after(i)})}),7<n.find("thead").find("th").not(".hidden").length&&(t=$("<div>",{id:"contact-table-wrapper","data-delta-height":null}).addClass("table-shadow"),n.addClass("auto-width-table").wrap(t),(t=$("#contact-table-wrapper")).wrap($("<div/>",{class:"table-shadow-wrapper"})),$("<div/>",{class:"right-shadow"}).css({height:t.height()}).insertAfter(t),parseInt(n.width())>parseInt(a.width())&&a.find(".pagin-panel").css("margin-top","20px"))},Contact.prototype.applyContactsPageSettings=function(){var e=this,t=$("[name='withShared']:checked").val();return $.ajax({url:"/online/account/ajax",dataType:"JSON",method:"POST",data:{cmd:"updateContactsPageSettingShowShare",contact_page_setting_show_shared:t},beforeSend:function(){e.applyContactsPageSettingsBtn.spin("enable","Saving..."),hideErrors()},success:function(t){t.success?location.reload():(parseAllErrors(t.message),e.applyContactsPageSettingsBtn.spin("disable"))},error:function(t){console.warn(t)}}),!1},Contact.prototype.applyContactFieldFilter=function(){var e=this,a={fields:{}};return e.contactFieldFilterModal.find('input[type="checkbox"]:checked').each(function(t,e){a.fields[t]=$(e).attr("name")}),$.ajax({url:"/online/contacts/table/fields",data:a,dataType:"JSON",method:"POST",beforeSend:function(){e.applyContactFieldFilterBtn.spin("enable","Saving...")},success:function(t){t.success?location.reload():(e.contactFieldFilterModal.modal("hide"),e.applyContactFieldFilterBtn.spin("disable"),e.topAlert.warningBlock("Sorry, but it looks like something has gone wrong. Please try again or contact us at support@textmagic.com"))},error:function(t){console.warn(t),e.contactFieldFilterModal.modal("hide"),e.applyContactFieldFilterBtn.spin("disable")}}),!1},Contact.prototype.addTag=function(t,e){var a='<a href="/online/contacts/list/'+t+'" class="tag-item-link" data-id="'+t+'">'+e+"</a>";addTag(this.contactListsContainer,'<span class="tag-item resetable" data-id="'+t+'">'+e+'<a href="javascript:void(0);" class="close"></a></span>'),addTag(this.listsContainerImport,a),$(this.contactListsContainer).find('[data-id="'+t+'"]').closest("li").addClass("hidden"),this.updateContactFormModal.find('span[data-field="groups"]').next("span.help-block.error").remove()},Contact.prototype.loadContactForm=function(t){var e=this;this.updateContactFormModal.find("input, select").prop("disabled",!0),this.updateContactFormModal.load(t.url,t,function(){"function"==typeof t.callback&&t.callback(),e.initPhoneFieldHandler()})},Contact.prototype.unsubscribeClickHandler=function(t){var e=this,t={cmd:"unsubscribeContact",phone:t.phone,cid:null,blockIncoming:this.blockIncomingChk.is(":checked")};e.unsubscribeBtn.spin("enable"),$.post(e.options.commandUrl,t).done(function(t){e.unsubscribeModal.modal("hide"),1==t.success?(e.topAlert.successBlock("Contact has been successfully removed from your lists."),void 0!==e.crudApi.getPaginationApi()&&(e.crudApi.getPaginationApi().reload(),e.renderEl()),e.cid&&location.reload()):(e.topAlert.warningBlock(t.message),e.crudApi.getPaginationApi().reload()),e.unsubscribeBtn.spin("disable")}).fail(function(){return e.unsubscribeBtn.spin("disable"),e.topAlert.warningBlock("An error occurred while unsubscribing."),!1})},Contact.prototype.updateCountBlocked=function(){0!==this.tabBlocked.length&&this.tabBlocked.load("/online/contacts/blocked-count")},Contact.prototype.updateCountNotes=function(t){var e;0!==this.tabNotes.length&&(e=parseInt(this.tabNotes.text()),"+"===t?e++:"-"===t?e--:e=parseInt(t),this.tabNotes.text(e))},Contact.prototype.toggleViewContactModalBtn=function(t){var e=$('[data-widget="modal-view-contact"]');0!==e.length&&(t?e.attr("href",t).removeClass("hidden"):e.attr("href","javascript:void(0);").addClass("hidden"))},Contact.prototype.toggleBlockBtnHandler=function(t,e){0!==t.length&&("block"===(e||t.attr("data-action"))?t.attr("data-action","unblock").attr("href","#unblockSingleNumberModal").contents().filter(function(){return 3==this.nodeType}).each(function(){this.textContent=this.textContent.replace("Block contact","Unblock contact")}):t.attr("data-action","block").attr("href","#blockSingleNumberModal").contents().filter(function(){return 3==this.nodeType}).each(function(){this.textContent=this.textContent.replace("Unblock contact","Block contact")}))},Contact.prototype.blockSingleNumberHandler=function(e){var a=this,t={cmd:"blockSingleNumber",phone:e.phone};$.ajax({url:a.options.commandUrl,dataType:"JSON",method:"POST",data:t,beforeSend:function(){a.blockSingleNumberBtn.spin("enable")},success:function(t){1==t.success?(a.topAlert.successBlock("Contact has been successfully blocked."),void 0!==a.crudApi.getPaginationApi()&&(a.crudApi.setCheckedItems([]),a.crudApi.setCheckedAllItems(!1),a.crudApi.getPaginationApi().reload(),a.renderEl()),a.toggleBlockBtnHandler($(a.btnToggleBlock)),a.updateCountBlocked(),"function"==typeof e.callback&&e.callback()):$.each(t.message,function(t,e){a.topAlert.warningBlock(e)})},error:function(t){console.warn(t),a.topAlert.dangerBlock("An error occurred while blocking.")},complete:function(t){a.blockSingleNumberModal.modal("hide"),a.blockSingleNumberBtn.spin("disable")}})},Contact.prototype.unblockSingleNumberHandler=function(e){var a=this,t={cmd:"unblockSingleNumber",phone:e.phone};a.unblockSingleNumberBtn.spin("enable"),$.post(a.options.commandUrl,t).done(function(t){a.unblockSingleNumberModal.modal("hide"),1==t.success?(a.topAlert.successBlock("Contact has been successfully unblocked."),void 0!==a.crudApi.getPaginationApi()&&(a.crudApi.getPaginationApi().reload(),a.renderEl()),a.toggleBlockBtnHandler($(a.btnToggleBlock)),a.updateCountBlocked(),"function"==typeof e.callback&&e.callback()):a.topAlert.warningBlock(t.message),a.unblockSingleNumberBtn.spin("disable")}).fail(function(){return a.unblockSingleNumberBtn.spin("disable"),a.topAlert.dangerBlock("An error occurred while unblocking."),!1})},Contact.prototype.fillModalListContainer=function(t){var e=this;$(this.contactListsContainer).find("ul.dropdown-menu").find("li > a").each(function(){-1!==t.indexOf($(this).data("id"))&&e.addTag($(this).data("id"),$(this).html())})},Contact.prototype.blockedNumberAutocomplete=function(a){var n=this;this.phoneAutocomplete(a,n.selectBlockedCountry,"#"+this.addBlockedForm.attr("id"),function(t,e){return e.item.value&&"header"!==e.item.role&&n.setPhoneAndCountry($(a),$(n.selectBlockedCountry),"+"+e.item.value),!1})},Contact.prototype.updateContactAutocomplete=function(n){var o=this;this.phoneAutocomplete(n,o.countrySelect,"#"+this.updateForm.attr("id"),function(t,e){return e.item.value&&"header"!==e.item.role&&("contact"===e.item.entityType&&e.item.entityId?(a=e.item.entityId,o.loadContactForm({url:"/online/contacts/loadform/"+a}),o.cid=a):"Textmagic"===e.item.countryName?($(n).val("+"+e.item.value),$(o.countrySelect).val("ZZ"),$(o.phoneTypeSelect).val(1)):"object"==typeof i18n&&"object"==typeof i18n.phonenumbers&&(e=(a=i18n.phonenumbers.PhoneNumberUtil.getInstance()).transformPhoneNumber("+"+e.item.value,$(o.countrySelect).val())).isValid&&($(n).val(e.number),$(o.countrySelect).val(e.country),a=a.getNumberType(a.parseAndKeepRawInput(e.number,e.country)),0<$(o.phoneTypeSelect+" option[value="+a+"]").length&&$(o.phoneTypeSelect).val(a))),!1;var a})},Contact.prototype.phoneAutocomplete=function(t,e,a,n){function o(t,e){$.ajax({method:"GET",url:"/api/v2/contacts/autocomplete",data:{limit:10,query:t.term,lists:0},dataType:"json",headers:{"X-TM-Username":app.data.user.login,"X-TM-Key":app.data.user.api_key},cache:!1,success:function(t){e(t)}})}$(t).autocomplete({source:o,appendTo:a,select:n,delay:100}).data("ui-autocomplete")._renderItem=function(t,e){var a="",n="";switch(e.entityType){case"contact":a=e.label,n=e.value;break;case"reply":a="+"+e.label,n=e.countryName;break;default:return $("<li>").appendTo(t)}var o=getAvatarClass(n,a,e.avatar,e.entityType,e.favorited),i=getAvatarLabel(n,a,e.avatar,e.entityType),s="";return e.avatar&&(s="background-image: url(/"+e.avatar+")"),$("<li>").append('<a class="chat-contact-item clearfix"><i class="'+o+'" style="'+s+'">'+i+'</i><div class="name">'+highlight(a,this.term)+'</div><div class="last-message">'+highlight(n,this.term)+"</div></a>").appendTo(t)},$(e).off("change").on("change",function(){$(t).autocomplete("option","source",o)})},Contact.prototype.initPhoneFieldHandler=function(){0!==$(this.inpBlockedNumber).length&&this.blockedNumberAutocomplete(this.inpBlockedNumber),0!==$(this.phoneInput).length&&this.updateContactAutocomplete(this.phoneInput)},Contact.prototype.btnAddBlockedNumberSubmitClickHandler=function(){var e=this;$.ajax({url:e.options.commandUrl,dataType:"JSON",method:"POST",data:{cmd:"blockSingleNumber",phone:$(e.inpBlockedNumber).val(),country:$(e.selectBlockedCountry).val()},beforeSend:function(){e.btnAddBlockedNumberSubmit.spin("enable"),hideErrors()},success:function(t){t.success?(e.modalAddBlockedNumber.modal("hide"),e.topAlert.successBlock("Number has been successfully blocked."),e.crudApi&&"function"==typeof e.crudApi.getPaginationApi&&e.crudApi.getPaginationApi().reload(),e.updateCountBlocked(),e.updateCountContacts()):parseAllErrors(t.message)},error:function(t){console.warn(t)},complete:function(t){e.btnAddBlockedNumberSubmit.spin("disable")}})},Contact.prototype.initCrudApi=function(){this.crudApi=$.prepareCrudPage(this.options)},Contact.prototype.restoreBtnClickHandler=function(){var n=this;$.confirm({title:"Restore contacts",message:"Are you sure you would like to restore the selected contacts?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Restore",class:"btn btn-danger",click:function(){function t(){a.spin("disable"),$(e).modal("hide"),n.crudApi.getPaginationApi().reload(),n.topAlert.successBlock("The selected contacts have been successfully restored.")}var e=this,a=$(this).find("button.btn-danger");a.spin("enable","Restoring...");n.crudApi.getCheckedAllItems()?n.crudApi.updateItems("RESTORE MY CONTACTS","archived",0,t):n.crudApi.updateItems(n.crudApi.getCheckedItems(),"archived",0,t)}}}})},Contact.prototype.blockBtnClickHandler=function(){var n=this;$.confirm({title:"Block contacts",message:"Are you sure you would like to block the selected contacts?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Block",class:"btn btn-danger",click:function(){function t(){a.spin("disable"),$(e).modal("hide"),n.crudApi.getPaginationApi().reload(),n.topAlert.successBlock("The selected contacts have been successfully blocked.")}var e=this,a=$(this).find("button.btn-danger");a.spin("enable","Blocking...");n.crudApi.getCheckedAllItems()?n.crudApi.updateItems("BLOCK MY CONTACTS","archived",3,t):n.crudApi.updateItems(n.crudApi.getCheckedItems(),"archived",3,t)}}}})},Contact.prototype.unblockBtnClickHandler=function(n){var o=this,t=1<(n=n||o.crudApi.getCheckedItems()).length||o.crudApi.getCheckedAllItems()?"You will be able to exchange messages with contacts that are unblocked.":"You will be able to exchange messages with this contact once unblocked.";$.confirm({title:"Unblock confirmation",message:t,buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Unblock",class:"btn btn-success",click:function(){function t(){a.spin("disable"),$(e).modal("hide"),o.crudApi.setCheckedItems([]),o.crudApi.getPaginationApi().reload(),o.topAlert.successBlock("The selected contacts have been successfully unblocked."),o.updateCountBlocked(),o.updateCountContacts()}var e=this,a=$(this).find("button.btn-danger");a.spin("enable","Unblocking..."),!1===o.crudApi.getCheckedAllItems()?o.crudApi.updateItems(n,"archived",0,t):o.crudApi.updateItems("UNBLOCK MY CONTACTS","archived",0,t)}}}})},Contact.prototype.deleteBtnClickHandler=function(){var o=this;$.confirm({title:"Delete contacts",message:"The selected contacts will be deleted permanently.<br>Are you sure you want to delete the selected contacts?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Delete",class:"btn btn-danger",click:function(){function t(t){$(e).modal("hide"),a.spin("disable"),o.crudApi.getPaginationApi().reload(),o.topAlert.successBlock(n?"The selected contacts have been successfully deleted."+(t.data.hasOwnProperty("deferred")&&t.data.deferred?" It may take some minutes before they disappear from your account.":""):"All your contacts will be deleted shortly. It may take some minutes before they disappear from your account.")}var e=this,a=$(this).find("button.btn-danger"),n=o.crudApi.getCheckedAllItems();a.spin("enable","Deleting..."),n?o.crudApi.removeItems("DELETE MY CONTACTS",t):o.crudApi.removeItems(o.crudApi.getCheckedItems(),t)}}}})},Contact.prototype.customFields=function(){var n={},t=this.updateContactModal.find('input[data-type="custom"]');return $(t).each(function(t,e){var a=parseInt($(e).data("id"));n[a]=$(e).val()}),n},Contact.prototype.lists=function(){var a=[],t=this.updateContactModal.find("#shared-list");if(0!==t.length)return[parseInt(t.data("val"))];t=this.updateContactModal.find("span.tag-item");return $(t).each(function(t,e){a.push(parseInt($(e).data("id")))}),a},Contact.prototype.reset=function(t){var e={url:"/online/contacts/loadform/0",listid:this.listid},e=$.extend({},e,t);this.loadContactForm(e),this.cid=null},Contact.prototype.submitBtnClickHandler=function(a,n){var o=this,t=(hideErrors(),$(this.updateContactSubmitBtn).spin("enable","Saving..."),{cmd:"updateContact",firstName:$(this.firstNameInput).val(),lastName:$(this.lastNameInput).val(),phone:$(this.phoneInput).val(),companyName:$(this.companyInput).val(),email:$(this.emailInput).val(),country:$(this.countrySelect).val(),phoneType:$(this.phoneTypeSelect).val(),custom:this.customFields(),lists:this.lists(),isShared:parseInt(this.updateContactModal.find("#shared-list").length),sharedEdit:parseInt(this.updateContactModal.find("#shared-contact-edit").length),cid:this.cid}),i="New contact has been successfully added.";o.cid&&(i="Contact details have been successfully edited."),$.post(o.options.commandUrl,t).done(function(t){var e;if(1==t.success)return $(o.updateContactSubmitBtn).spin("disable"),null!=o.crudApi.getPaginationApi()?o.crudApi.getPaginationApi().reload():a&&a.getPaginationApi().reload(),0<(e=$("td.contact-info").find('a[data-toggle="modal"][class="one"]')).length&&e.addClass("hidden"),$(o.addAnotherChk).is(":checked")?o.reset({callback:function(){o.setPhoneAndCountry(o.updateContactFormModal.find('input[data-field="phone"]'),o.updateContactFormModal.find('select[data-field="country"]')),o.updateContactFormModal.find(o.addAnotherChk).attr("checked","checked")}}):(o.renderEl(),o.topAlert.successBlock(i),o.updateContactModal.modal("hide"),o.cid||((e=document.createEvent("Event")).initEvent("contact.add",!0,!0),e.phone=t.data.phone,document.dispatchEvent(e)),"function"==typeof n&&n()),!0;$(o.updateContactSubmitBtn).spin("disable"),parseAllErrors(t.message),$(o.updateContactSubmitBtn).spin("disable")}).fail(function(){return $(o).spin("disable"),!1})},Contact.prototype.loadEl=function(t,e){var a=this;if(0===t.length)return!1;t.load(e.url,e,function(){e.url==a.profileAjaxURI&&a.getNoteList({})})},Contact.prototype.updateCountContacts=function(){this.loadEl(this.tabBadge,{url:"/online/contacts/ajaxcount"})},Contact.prototype.renderEl=function(){var n=this,t=this.listid?this.headerBadge:this.tabBadge,e={listid:this.listid,url:"/online/contacts/ajaxcount"};if(this.loadEl(t,e),!this.cid||0===this.contactDataEl.length)return!1;e={contactid:this.cid,url:this.profileAjaxURI},this.loadEl(this.contactDataEl,e),this.loadContactForm({url:"/online/contacts/loadform/"+parseInt(this.cid),callback:function(){var t=n.updateContactFormModal.find('[data-field="firstName"]').val(),e=n.updateContactFormModal.find('[data-field="lastName"]').val(),a=n.updateContactFormModal.find('[data-field="phone"]').val();n.profileHeaderFullname.text(t+" "+e),n.profileHeaderPhone.text(a)}})},Contact.prototype.getMoveOption=function(){var t=this.moveOptionsContainer.find('input[name="moveMethod"]:checked');return(t=0===t.length?this.moveOptionsContainer.find('input[type="hidden"]'):t).val()},Contact.prototype.toggleMoveMethodHandler=function(){var t="cp"===this.getMoveOption()?"Copy":"Move";this.moveContactBtn.text(t)},Contact.prototype.moveBtnClickHandler=function(){var e=this,t="Moving...",t=("Copy"===this.moveContactBtn.text()&&(t="Copying..."),this.moveContactBtn.spin("enable",t),this.crudApi.getCheckedAllItems()),a=this.crudApi.getCheckedItems(),n={cmd:"moveContact",contacts:a=!0===t?[]:a,all:t,toListId:this.mvToListId,fromListId:this.listid,moveMethod:this.getMoveOption()};$.post(e.options.commandUrl,n).done(function(t){if(!0===t.success)return e.moveContactBtn.spin("disable"),e.crudApi.getPaginationApi().reload(),e.renderEl(),e.moveContactModal.modal("hide"),t="Selected contacts have been successfully copied to the new list.","mv"===n.moveMethod&&(t="Selected contacts have been successfully moved to the new list.",e.crudApi.setCheckedItems([])),e.topAlert.successBlock(t),!0;e.moveContactBtn.spin("disable")}).fail(function(){return $(e).spin("disable"),!1})},Contact.prototype.subscribeFormCallback=function(t,e){$("#formGroup").append($("<option></option>").attr("value",t).text(e)).prop("disabled",!1),$(this.createListBtn).hide()},Contact.prototype.updateGroupList=function(t){var n=this;$(n.contactListsContainer).find("ul.dropdown-menu").load("/online/messages/lists/update-list",t,function(){var a=this,t=$(a).closest(n.contactListsContainer).parent().find("span.tag-item"),e=$(a).find(n.inpLiveSearch);$.each(t,function(t,e){e=parseInt($(e).attr("data-id")),e=$(a).find('a[data-id="'+e+'"]');0!==e.length&&e.closest("li").addClass("hidden")}),e.val("").trigger("keyup")})},Contact.prototype.removeBtnClickHandler=function(){var a=this,n=this.removeContactBtn.siblings("button[data-dismiss]");if(this.removeContactBtn.spin("enable","Deleting..."),n.btn("disable"),!0===a.crudApi.getCheckedAllItems()&&null===a.listid)return a.crudApi.removeItems("all",function(t){t.success?(a.topAlert.successBlock("All your contacts will be deleted shortly. It may take some minutes before they disappear from your account."),a.renderEl(),a.crudApi.getPaginationApi().reload()):a.topAlert.warningBlock(t.message),a.removeContactBtn.spin("disable"),a.removeContactModal.modal("hide")}),!0;var t=this.crudApi.getCheckedAllItems(),e=this.crudApi.getCheckedItems(),o={cmd:"removeContact",contacts:e=!0===t?[]:e,all:t,fromListId:this.listid},o=$.extend({},o,app.removeContactOptions);$.post(a.options.commandUrl,o).done(function(t){var e;return 1==t.success?(a.renderEl(),a.crudApi.getPaginationApi().reload(),e=1!==o.contacts.length||o.all?"Selected contacts have been successfully removed":"Selected contact has been successfully removed",null!==a.listid&&"blocked"!==a.listid&&(e+=" from this list"),a.topAlert.successBlock(e),a.crudApi.setCheckedItems([])):a.topAlert.warningBlock(t.message),a.removeContactModal.modal("hide"),a.removeContactBtn.spin("disable"),n.btn("enable"),!0}).fail(function(){return a.removeContactBtn.spin("disable"),n.btn("enable"),!1})},Contact.prototype.contenteditableFocus=function(t){t.text();var e,a=t.prop("contenteditable",!0)[0];if(t.is(":empty"))return t.text(" "),void a.focus();a.focus(),void 0!==window.getSelection&&void 0!==document.createRange?((t=document.createRange()).selectNodeContents(a),t.collapse(!1),(e=window.getSelection()).removeAllRanges(),e.addRange(t)):void 0!==document.body.createTextRange&&((e=document.body.createTextRange()).moveToElementText(a),e.collapse(!1),e.select())},Contact.prototype.toggleNoteMode=function(t,e,a){var n=this,o=t.find(".contact-note-time"),t=t.find(".contact-note-content");"default"===a&&(e.find(this.btnNoteSave).attr("data-widget","edit-note").html('<i class="fa tmi30-pencil tmi30-12px"></i>Edit'),e.find(this.btnNoteUndo).html('<i class="fa tmi30-trash tmi30-12px"></i>Delete'),setTimeout(function(){e.find(n.btnNoteUndo).attr("data-widget","delete-note")},10),e.removeClass("active"),o.removeClass("hidden"),t.prop("contenteditable",!1)),"edit"===a&&(e.find(this.btnNoteEdit).attr("data-widget","save-change").html('<i class="fa tmi30-circle-checked tmi30-12px"></i>Save'),e.find(this.btnNoteDelete).attr("data-widget","undo-change").html('<i class="fa tmi30-circle-close tmi30-12px"></i>Cancel'),e.addClass("active"),o.addClass("hidden"),this.contenteditableFocus(t))},Contact.prototype.addNoteBtnClickHandler=function(){var t,e=$('.panel-contact-note[data-id=""]'),a=e.find(".contact-note-menu");1<e.length||(t=this.formNoteSearch.find('input[name="search-query"]'),$.trim(t.val())&&t.val("").trigger("input"),1===e.length&&e.clone().insertBefore(e),e.removeClass("hidden"),this.addNoteBtn.addClass("disabled"),$(this.notesContainer).find(".panel.panel-blank").addClass("hidden"),this.toggleNoteMode(e,a,"edit"))},Contact.prototype.editNoteBtnClickHandler=function(t){var e=$(t).closest(".panel-contact-note"),t=($(t).closest(".contact-note-menu"),{noteId:parseInt(e.attr("data-id")),contactId:this.cid,mode:"edit"});this.getNote(t,e,"edit")},Contact.prototype.undoChangeNoteBtnClickHandler=function(t){var t=$(t).closest(".panel-contact-note"),e=parseInt(t.attr("data-id"));if(hideErrors(this.topAlert),$(this.notesContainer).find(".panel.panel-blank").removeClass("hidden"),!e)return t.remove(),void this.addNoteBtn.removeClass("disabled");e={noteId:e,contactId:this.cid};this.getNote(e,t,"default")},Contact.prototype.getNote=function(t,n,o){var i=this,s=n.find(".contact-note-menu"),r=parseInt(n.attr("data-id"));$.ajax({url:i.getNoteURI,dataType:"HTML",method:"GET",data:t,beforeSend:function(){n.spin("enable")},success:function(t,e,a){a.success?(n.replaceWith(t),n=$('[data-widget="note"][data-id="'+r+'"]'),s=n.find(".contact-note-menu"),i.toggleNoteMode(n,s,o)):i.toggleNoteMode(n,s,"edit")},error:function(t){console.warn(t)},complete:function(t){n.spin("disable")}})},Contact.prototype.saveNoteBtnClickHandler=function(t){var n=this,o=$(t).closest(".panel-contact-note"),i=$(t).closest(".contact-note-menu"),t=o.find(".contact-note-content"),s=o.attr("data-id"),t={contactId:n.cid,note:$.trim(t.text()),noteId:s};$.ajax({url:n.getNoteURI,dataType:"HTML",method:"POST",data:t,beforeSend:function(){hideErrors(n.topAlert),o.spin("enable")},success:function(t,e,a){if(a.success){a=$(t).find(".errors .error");if(0<a.length)return $.each(a,function(t,e){n.topAlert.warningBlock($(e).text())}),void n.toggleNoteMode(o,i,"edit");o.replaceWith(t),s?n.topAlert.successBlock("Note has been updated."):(n.topAlert.successBlock("Note has been created."),n.updateCountNotes("+"),n.reloadNoteList({}))}else n.toggleNoteMode(o,i,"edit")},error:function(t){console.warn(t)},complete:function(t){o.spin("disable"),n.addNoteBtn.removeClass("disabled")}})},Contact.prototype.deleteNoteBtnClickHandler=function(t){var a=this,n=$(t).closest(".panel-contact-note"),o={url:"/online/contacts/ajax",cmd:"removeNote",noteId:n.attr("data-id")};if(!o.noteId)return n.remove(),a.topAlert.successBlock("Note has been deleted."),!1;$.confirm({title:"Delete note",message:"Are you sure you would like to delete note?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Delete",class:"btn btn-danger",click:function(){$(this).find("button.btn-danger").spin("enable","Deleting...");var e=this;$.post(o.url,o).done(function(t){if(1==t.success)return n.remove(),a.topAlert.successBlock("Note has been deleted."),$(e).modal("hide"),a.updateCountNotes("-"),a.reloadNoteList({}),!0;a.topAlert.warningBlock("An internal error has been occured.")}).fail(function(){return a.topAlert.warningBlock("An internal error has been occured."),!1})}}}})},Contact.prototype.reloadNoteList=function(t){hideErrors(this.topAlert),$(this.notesContainer).html(""),$(this.notesContainer).parent().find('[data-widget="note"]').not(".hidden").remove(),this.getNoteList(t)},Contact.prototype.getNoteList=function(n){var t,e,a,o=this;0!==$(this.notesContainer).length&&(a=n.pageNext||1,t=n.perPage||10,e=n.text||"",a={cid:this.cid,page:a,perPage:t,text:e},$.ajax({url:o.getNoteListURI,dataType:"html",method:"POST",data:a,beforeSend:function(){n.btn&&n.btn.spin("enable")},success:function(t,e,a){a.success&&(n.btn&&n.btn.remove(),$(o.notesContainer).append(t),"function"==typeof n.callback&&n.callback(),o.checkNotesEmptyState())},error:function(t){console.warn(t.status)},complete:function(t){}}))},Contact.prototype.contenteditablePaste=function(t){t=(t.originalEvent||t).clipboardData.getData("text/plain");document.execCommand("insertText",!1,t)},Contact.prototype.btnFavToggleClickHandler=function(){var a=this,n=parseInt(this.btnFavPanel.attr("data-state"));a.btnFavPanel.addClass("disabled"),a.crudApi.updateItems(this.cid,"favorited",Math.abs(n-1),function(t){a.btnFavPanel.removeClass("disabled");var e=$(".avatar-wrapper").find(".avatar");t.success&&(a.btnFavPanel.attr("data-state",Math.abs(n-1)),a.btnFavPanel.blur(),1===parseInt(a.btnFavPanel.attr("data-state"))?(a.btnFavPanel.html("<i class='fa tmi30-star-o tmi30-14px'></i>Unfavorite"),a.btnFavPanel.prop("title","Unfavorite contact"),e.addClass("starred")):(a.btnFavPanel.html("<i class='fa tmi30-star tmi30-14px'></i>Favorite"),a.btnFavPanel.prop("title","Favorite contact"),e.removeClass("starred")))})},Contact.prototype.toggleFavBtnClickHandler=function(t){var e=$(t),a=$(t).find("i.tmi30"),n=a.hasClass("tmi30-star-o");if(e.hasClass("loading"))return!1;e.spin("enable");this.crudApi.updateItems(e.closest("tr").data("id"),"favorited",n?1:0,function(){e.spin("disable"),n?a.removeClass("tmi30-star-o").addClass("tmi30-star"):a.removeClass("tmi30-star").addClass("tmi30-star-o")})},Contact.prototype.resetImageForms=function(){$.each(this.avatarCropForm.find('input[type="hidden"]'),function(t,e){$(e).val("")}),this.avatarUploadForm[0].reset()},Contact.prototype.initJcrop=function(t,e){var a=t.get(0).naturalWidth,n=t.get(0).naturalHeight;t.Jcrop({aspectRatio:1,minSize:[50,50],bgColor:"#666",bgOpacity:.5,allowSelect:!1,onSelect:function(t){e.find('[name="x1"]').val(t.x),e.find('[name="y1"]').val(t.y),e.find('[name="x2"]').val(t.x2),e.find('[name="y2"]').val(t.y2)},setSelect:[0,0,1e4,1e4],trueSize:[a,n]})},Contact.prototype.avatarUploadHandler=function(t){var e,i,s=this;return!(!window.FormData||!t.target)&&(!!(t=t.target.files[0])&&((e=new FormData).append("image",t),i=s.avatarUploadPreModal.find(".img-wrapper"),void $.ajax({url:"/online/contacts/avatar/upload/pre/"+parseInt(s.cid),cache:!1,contentType:!1,processData:!1,type:"POST",data:e,beforeSend:function(){hideErrors(s.topAlert),s.avatar.spin("enable","",{shadow:!0,top:"-2",left:"1"})},success:function(o){var t;o.success?(i.html(""),s.avatarUploadPreModal.off("shown.bs.modal").on("shown.bs.modal",function(){var t=o.data.tmpPath,e=o.data.originalName,a=$("<img>",{class:"img-preview",src:t}),n=s.avatarUploadPreModal.find("form");n.find('input[name="entityId"]').val(s.cid),n.find('input[name="tmpFile"]').val(t),n.find('input[name="originalName"]').val(e),i.prepend(a.load(function(){s.initJcrop($(this),n)}))}),s.avatarUploadPreModal.modal("show")):(t=o.data.errors,$.each(t,function(t,e){s.topAlert.warningBlock(e)}))},error:function(t){413===t.status&&s.topAlert.warningBlock("The maximum allowed file size is 10 MB.")},complete:function(t){s.avatar.spin("disable")}})))},Contact.prototype.avatarCropFormSubmitHandler=function(){var a,n=this,e=n.avatarCropForm.find('button[type="submit"]'),t={url:n.avatarCropForm.attr("action"),beforeSend:function(){e.spin("enable"),n.avatar.spin("enable","",{shadow:!0,top:"-2",left:"1"}),a=n.avatar.css("background-image"),n.avatar.css("background-image","none")},success:function(t){var e;t.success?(n.avatarUploadPreModal.modal("hide"),(e=t.data.newPath)&&(n.avatarLabel.addClass("hidden"),n.avatar.css("background-image","url("+e+")")),n.topAlert.successBlock(t.message),n.resetImageForms(),n.toggleAvatarState(!0)):(t.data&&(e=t.data.errors||{},$.each(e,function(t,e){n.topAlert.warningBlock(e)})),n.avatar.css("background-image",a))},error:function(t){console.warn(t)},complete:function(t){e.spin("disable"),n.avatar.spin("disable")}};n.avatarCropForm.ajaxForm().ajaxSubmit(t)},Contact.prototype.toggleAvatarState=function(t){this.avatarControl.html(t?'<a href="javascript:void(0);" class="avatar-overlay dropdown" data-toggle="dropdown"><i class="fa tmi30-camera"></i></a><ul class="dropdown-menu text-left"><li><a href="javascript:void(0);" data-widget="change-avatar" title="Upload contact\'s profile photo"><i class="fa tmi30-arrow-upload tmi30-10px"></i>Upload a new avatar</a></li><li><a href="javascript:void(0);" data-widget="remove-avatar" title="Remove contact\'s profile photo"><i class="fa tmi30-trash tmi30-12px"></i>Remove avatar</a></li></ul>':'<a href="javascript:void(0);" class="avatar-overlay" data-widget="change-avatar"><i class="fa tmi30-camera"></i></a>')},Contact.prototype.avatarRemoveHandler=function(){var n,o=this;$.confirm({title:"Remove avatar",message:"Are you sure you would like to remove contact's avatar?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Remove",class:"btn btn-danger",click:function(){var e=this,a=$(this).find("button.btn-danger");a.spin("enable","Removing...");$.ajax({url:o.options.commandUrl,dataType:"JSON",method:"POST",data:{cmd:"removeAvatar",cid:o.cid},beforeSend:function(){o.avatar.spin("enable","",{shadow:!0,top:"-2",left:"1"}),n=o.avatar.css("background-image")},success:function(t){t.success?(o.avatar.css("background-image","none"),o.avatarLabel.removeClass("hidden"),o.topAlert.successBlock(t.message),o.toggleAvatarState(!1)):(t=t.data.errors,$.each(t,function(t,e){o.topAlert.warningBlock(e)}),o.avatar.css("background-image",n))},error:function(t){console.warn(t)},complete:function(t){o.avatar.spin("disable"),a.spin("disable"),$(e).modal("hide")}})}}}})},Contact.prototype.copyToListSuccessCallback=function(){this.topAlert.successBlock("Selected contacts have been successfully copied."),this.renderEl(),this.crudApi.getPaginationApi().reload()},Contact.prototype.btnSaveAutoUnsubscribeClickHandler=function(){var n=this,t=this.autoUnsubscribeCheckbox.is(":checked"),e=this.inpAutoUnsubscribeCounter.val();this.skipCloseChatAfterUnsubscribe=$('[name="skipCloseChatAfterUnsubscribe"]:checked').val(),$.ajax({url:n.saveAutoUnsubscribeURI,method:"POST",data:{cmd:this.saveAutoUnsubscribeCmd,count:t?e:0,sendStopReply:+this.sendStopReply,replyTemplateId:this.stopReplyTemplateId,sendStopReplyOnManual:+this.sendStopReplyOnManual,skipCloseChatAfterUnsubscribe:+this.skipCloseChatAfterUnsubscribe},beforeSend:function(){n.btnSaveAutoUnsubscribe.spin("enable","Saving...")},success:function(t,e,a){a.success&&n.topAlert.successBlock("Unsubscribe settings have been updated.")},error:function(t){console.warn(t)},complete:function(t){n.btnSaveAutoUnsubscribe.spin("disable"),n.autoUnsubscribeModal.modal("hide")}})},Contact.prototype.btnCncInPrflOnClick=function(t){t.removeClass("visible"),t.closest("td").find(this.btnEditInPrfl).addClass("visible"),t.closest("tr").find(this.btnSaveInPrfl).removeClass("visible"),t.closest("tr").find(this.textInPrfl).addClass("visible"),t.closest("tr").find(this.inpInPrfl).removeClass("visible")},Contact.prototype.btnEditInPrflOnClick=function(t){var e=this;$("#contact-data table").find("tr").each(function(){var t=$(this);t.find(e.btnSaveInPrfl).removeClass("visible"),t.find(e.btnCncInPrfl).removeClass("visible"),t.find(e.textInPrfl).addClass("visible"),t.find(e.inpInPrfl).removeClass("visible"),t.find(e.btnEditInPrfl).addClass("visible")}),t.removeClass("visible"),t.closest("td").find(this.btnSaveInPrfl).addClass("visible"),t.closest("td").find(this.btnCncInPrfl).addClass("visible"),t.closest("tr").find(this.textInPrfl).removeClass("visible"),t.closest("tr").find(this.inpInPrfl).addClass("visible")},Contact.prototype.toggleDisableInlineProfileBtn=function(e){$("#contact-data table").find("tr").each(function(){var t=$(this);!0===e?(t.find("td.actions .btn-default").addClass("disabled"),t.find("td.actions .btn-success").addClass("disabled")):(t.find("td.actions .btn-default").removeClass("disabled"),t.find("td.actions .btn-success").removeClass("disabled"))})},Contact.prototype.btnSaveInPrflOnClick=function(t){var a=this,e=t.closest("tr").attr("data-name"),n=t.closest("tr").find(this.inpInPrfl).val(),t=parseInt(t.closest("tr").attr("data-cfid")),o={cmd:"patchContact",cid:this.cid,custom:{}};t?o.custom[t]=n:o[e]=n,$.ajax({url:a.options.commandUrl,dataType:"JSON",method:"POST",data:o,beforeSend:function(){hideErrors('[data-widget="top-alert"]'),a.toggleDisableInlineProfileBtn(!0)},success:function(t){if(t.success)a.renderEl(),a.topAlert.successBlock(t.message);else for(var e in t.message)a.topAlert.warningBlock(t.message[e])},error:function(t){console.warn(t)},complete:function(t){a.toggleDisableInlineProfileBtn()}})},function(t){this.init(t)}),List=(SelectContact.prototype.init=function(t){var o=this;this.options=$.extend({},{containerSelector:"#select-contacts-container",paginationCommand:"tableSelectContact",paginationScroll:!1,commandUrl:"/online/contacts/ajax/0",itemSelector:"tr[data-widget=select-contact]",searchFormSelector:"#select-contacts-search",paginationRecount:!0,dontInitExport:!0,beforeReloadFunction:function(t){var e=t.getOptions().requestParams,a="#select-contacts-container";e.hasOwnProperty("params")?e.params=$.extend({},e.params,{source:$(a).attr("data-source")}):e.params={source:$(a).attr("data-source")},t.setOptions({requestParams:e})},callbackRecount:function(t){var e=t.data.total,a=$(o.crudApi.getOptions().containerSelector),n=("function"==typeof $.fn.format&&(e=$.fn.format(e)),t.data.overlimit),n=void 0!==n&&n?"many":e,e=(a.find('[data-crud-count="count"]').text(n),t.data.export_total),n=(void 0!==e&&a.find("[data-crud-export-count]").attr("data-crud-export-count",e),a.find('[data-crud-max="max"]'));parseInt(n.text())>=t.data.total&&(n.text(t.data.total),a.find("ul.pager li.next").addClass("disabled").off("click")),0<o.lnkNewMsgAddContacts.length&&0===parseInt(t.data.total)&&o.lnkNewMsgAddContacts.attr("href","#addContactWayModal")},checkboxChangeFunction:function(t){var e=$(t).closest("tr").data("id"),a=o.crudApi.getOptions().itemSelector;void 0===window.checkedData&&(window.checkedData=[]),$(t).is(":checked")?(o.crudApi.addCheckedItems([e]),window.checkedData.push($(t).closest("tr").data())):!0===o.crudApi.getCheckedAllItems()?(o.crudApi.setCheckedAllItems(!1),o.crudApi.setCheckedItems([]),window.checkedData=[],$(a).each(function(){$(this).find('input[type="checkbox"]').is(":checked")&&(o.crudApi.addCheckedItems([$(this).data("id")]),window.checkedData.pushOnce($(this).data()))})):(o.crudApi.removeCheckedItems([e]),window.checkedData.popAll($(a+'[data-id="'+e+'"]').data())),o.toggleAddButton(),this.togglePager()},topCheckboxChangeFunction:function(t){var t=$(t).is(":checked"),e=o.crudApi.getOptions().itemSelector,t=(void 0===window.checkedData&&(window.checkedData=[]),t?$(e).each(function(){o.crudApi.addCheckedItems([$(this).data("id")]),window.checkedData.pushOnce($(this).data())}):($(e).each(function(){o.crudApi.removeCheckedItems([$(this).data("id")]),window.checkedData.popAll($(this).data())}),o.crudApi.setCheckedAllItems(!1)),null);o.crudApi.getCheckedAllItems()&&(e=o.crudApi.getOptions().containerSelector,t=parseInt($(e).find("[data-crud-export-count]").attr("data-crud-export-count"))),o.toggleAddButton(t),this.togglePager()},selectAllFunction:function(t){var e=o.crudApi.getOptions().containerSelector,e=$(e).find("[data-options-select]");parseInt(e.find("span.value").text().replace(/\D/g,""))<2||(window.checkedData=[],o.crudApi.setCheckedAllItems(!0),o.crudApi.setCheckedItems([]),this.togglePager())},getItemsCount:function(){return o.crudApi.getCheckedItems().length}},t),this.topAlert=$('[data-widget="top-alert"]'),this.modalAddressBook=$("#addressBookModal"),this.btnLetter=$("dl.sorting-list li a"),this.btnAdd=this.modalAddressBook.find("#addContactsButton"),this.lnkNewMsgAddContacts=$("#formNewMessage").find("a#add-contacts-to-message"),this.getItemsCount=this.options.getItemsCount,this.initCrudApi()},SelectContact.prototype.initCrudApi=function(){this.crudApi=$.prepareCrudPage(this.options)},SelectContact.prototype.btnLetterClickHandler=function(t){var e=t.parent().hasClass("active"),a=(t.parent().parent().find("li.active").removeClass("active"),this.crudApi.getPaginationApi()),n=a.getRequestParams().params,n=e?(t.parent().removeClass("active"),$.extend({},n,{first:"",text:""})):(t.parent().addClass("active"),$.extend({},n,{first:t.text(),text:""}));a.setRequestParams({params:n}).reload()},SelectContact.prototype.btnAddListClickHandler=function(t,e){var a,n,o;parseInt(t)&&(n=(a=this).crudApi.getCheckedItems(),o=this.crudApi.getCheckedAllItems(),this.modalAddressBook.find("dl.sorting-list li.active a").text(),this.modalAddressBook.find('input[name="search-query"]').val(),$.ajax({url:a.options.commandUrl,dataType:"JSON",method:"POST",data:{cmd:"moveContact",contacts:n,toListId:t,moveMethod:"cp",all:o},beforeSend:function(){a.btnAdd.spin("enable")},success:function(t){if(t.success)return a.modalAddressBook.modal("hide"),e.func.apply(e.context),!0},error:function(t){console.warn(t)},complete:function(t){a.btnAdd.spin("disable")}}))},SelectContact.prototype.modalAddressBookHiddenHandler=function(t){this.btnLetter.parent().parent().find("li.active").removeClass("active");var e=this.crudApi.getPaginationApi(),a=e.getRequestParams().params,a=$.extend({},a,{first:"",text:""});e.setRequestParams({params:a}),this.modalAddressBookReset(this,t)},SelectContact.prototype.modalAddressBookReset=function(t,e){e=$(e).find("input[name=search-query]");""!=e.val()&&e.val("").change(),t.crudApi.setCheckedAllItems(!1),t.crudApi.setCheckedItems([]),window.checkedData=[],t.crudApi.getPaginationApi().setOptions({page:1}),t.crudApi.getPaginationApi().reload(),this.toggleAddButton()},SelectContact.prototype.toggleAddButton=function(t){var t=t||this.getItemsCount(),e=$("span.plural",this.btnAdd),t=parseInt(t);e.text(1===t?"":"s"),1<=t?this.btnAdd.enableButton():this.btnAdd.disableButton(),"function"==typeof $.fn.format&&(t=$.fn.format(t)),$("span.value",this.btnAdd).text(t)},SelectContact.prototype.handleBulkItemsAdd=function(e){var a=this,t=this.modalAddressBook.find("dl.sorting-list li.active a").text(),n=this.modalAddressBook.find('input[name="search-query"]').val(),t={cmd:"createGroup",contacts:e.contacts,letter:t,text:n,shared:!0};$.ajax({url:a.options.commandUrl,dataType:"JSON",method:"POST",data:t,beforeSend:function(){a.btnAdd.spin("enable")},success:function(t){t.success&&(t=t.data,e.callbackAddContact&&e.callbackAddContact.func.apply(e.callbackAddContact.context,[{groupId:t.group_id,name:t.name,count:t.members},!0]),e.callbackTagEdit&&e.callbackTagEdit())},error:function(t){console.warn(t)},complete:function(t){a.btnAdd.spin("disable")}})},SelectContact.prototype.sendCheckedItemsHandler=function(n){var o,i,t,s=this,r=!1,d=this.crudApi.getCheckedItems().length,r=this.crudApi.getCheckedAllItems()?"all":this.crudApi.getCheckedItems();(1<d||"all"===r)&&(t={cmd:"createGroup"},"all"===r?(t.contacts=r,t.letter=this.modalAddressBook.find("dl.sorting-list li.active a").text(),t.text=this.modalAddressBook.find('input[name="search-query"]').val(),t.shared=!0):r.length<=100?t.contacts=r:t.contacts=[r[0]],i=function(t,e){var a=$("div.progress-bar");a.data("aria-valuenow",t),a.data("aria-valuemax",e),a.css("width",parseInt(100*t/e)+"%"),a.find('span[data-widget="items-processed"]').text(t),a.find('span[data-widget="items-total"]').text(e)},100<d&&"all"!==r&&(i(0,d),$("#send-progress-modal button.cancel").click(function(){n(!1,"cancel"),$("#send-progress-modal").modal("hide")}),$("#send-progress-modal").modal("show"),$("#send-progress-modal").on("hide.bs.modal",function(t){clearTimeout(o),s.crudApi.setCheckedItems([]),s.crudApi.getPaginationApi().reload()})),this.crudApi.post(t,function(a){"all"===r?n(a.data,!1):function e(){var t={cmd:"getCreationGroupProcess",group_id:a.data.group_id,contacts:r.splice(0,100)};s.crudApi.post(t,function(t){t.success?t.data.processed>=d?(i(t.data.processed,d),clearTimeout(o),$("#send-progress-modal").modal("hide"),n(t.data,!1)):(i(t.data.processed,d),o=setTimeout(function(){e()},2e3)):(clearTimeout(o),n(!1,t.message),$("#send-progress-modal").modal("hide"))})}()}))},function(t){this.crudApi=null,this.init(t)}),ListFilter=(List.prototype.initCrudApi=function(){var o=this;this.crudApi=$.prepareCrudPage({containerSelector:"#lists-content",itemSelector:"tr[data-widget=list]",paginationCommand:o.options.paginationCommand,paginationScroll:o.options.paginationScroll,paginationRecount:!0,searchFormSelector:"#lists-search",commandUrl:o.options.commandUrl,checkboxChangeFunction:o.options.checkboxChangeFunction,checkedItemsChangeFunction:o.options.checkedItemsChangeFunction,afterReloadFunction:function(){$(this.itemSelector).on("click",function(t){o.tableCheckboxClickHandler(this)}),o.btnSharedPanelState()},topCheckboxChangeFunction:function(t){var n=$(t).is(":checked");$(this.itemSelector).each(function(){var t=parseInt($(this).attr("data-type")),e=parseInt($(this).attr("data-shared-to-me")),a=$(this).data("id");if(n?o.crudApi.addCheckedItems([a]):o.crudApi.removeCheckedItems([a]),1===e)return!0;o.manageItem(a,t,n)}),n||o.crudApi.setCheckedAllItems(!1),o.btnSharedPanelState(),this.togglePager()}})},List.prototype.init=function(t){var e=this;this.updateListSubmitBtn=$('a[data-widget="submit-list"]'),this.listNameInput=$('[data-field="name"]'),this.topAlert=$('[data-widget="top-alert"]'),this.listTypeChk=$("#listType"),this.isDefaultChk=$("#isDefault"),this.updateListModal=$("#updateListModal"),this.addListBtn=$('a[data-widget="new"]'),this.editListIcon='a[data-widget="list_edit"]',this.tabCounter=$("#contacts-tabs > li.active span"),this.tabContacts=$("#contacts-tabs").find("li:nth-child(2)").find("span"),this.sendBtn=$("[data-widget=send]"),this.deletePermanentlyBtn='[data-widget="delete-permanently"]',this.addContactImportLnk=$("a.btn-add-people.import"),this.sendRowBtn='[data-widget="send-row"]',this.shareRowBtn="[data-share]",this.btnFavTable='[data-widget="toggle-fav-list"]',this.btnSharedPanel=$('[data-widget="toggle-shared"]'),this.btnFavPanel=$('[data-widget="toggle-fav-panel"]'),this.avatar=$(".avatar-wrapper > .avatar"),this.avatarLabel=$(".avatar-wrapper .avatar-label"),this.avatarControl=this.avatar.find(".avatar-control"),this.avatarChangeBtn='[data-widget="change-avatar"]',this.avatarRemoveBtn='[data-widget="remove-avatar"]',this.exportContactsBtn='[data-widget="export-contacts"]',this.avatarUploadForm=$("#form_avatar"),this.avatarFileInput=this.avatarUploadForm.find('input[type="file"]'),this.avatarUploadPreModal=$("#upload-preview-modal"),this.avatarCropForm=$("#list-image-form"),this.sharedItems=[],this.privateItems=[],this.options=$.extend({},{paginationCommand:"table",paginationScroll:!1},t),this.listid=null,this.updateContactModal=$("#updateContactModal"),this.initCrudApi(),$(document.body).on("click",e.btnFavTable,function(t){t.preventDefault(),e.toggleFavBtnClickHandler(this)}),this.avatarUploadPreModal.on("hide.bs.modal",function(){e.resetImageForms()})},List.prototype.resetImageForms=function(){$.each(this.avatarCropForm.find('input[type="hidden"]'),function(t,e){$(e).val("")}),this.avatarUploadForm[0].reset()},List.prototype.updateListCount=function(){this.tabCounter.load("/online/messages/lists/ajaxcount")},List.prototype.deleteBtnClickHandler=function(t){var i=this,e="Delete lists",a="Any contacts contained only in selected lists will be deleted permanently.<br>Are you sure you would like to delete selected lists?";(t=null===(t=t)?this.crudApi.getCheckedItems():t).length&&1!==t.length||(e="Delete list",a="Any contacts contained only in selected list will be deleted permanently.<br>Are you sure you would like to delete selected list?"),$.confirm({title:e,message:a,buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Delete",class:"btn btn-danger",click:function(){function e(t){i.crudApi.setCheckedItems([]),i.crudApi.setCheckedAllItems(!1),i.crudApi.getPaginationApi().reload(),t.success?(i.topAlert.successBlock(t.message),i.tabContacts.load("/online/contacts/ajaxcount")):i.topAlert.warningBlock(t.message),i.updateListCount(),i.updateGroupList()}var a=this,n=$(this).find("button.btn-danger"),o=n.siblings("[data-dismiss]");!1===i.crudApi.getCheckedAllItems()?$.ajax({url:i.options.commandUrl,type:"POST",data:{cmd:"removeList",ids:t},dataType:"JSON",beforeSend:function(){n.spin("enable","Deleting..."),o.btn("disable"),hideErrors(i.topAlert)},complete:function(t){$(a).modal("hide"),n.spin("disable"),o.btn("enable")},success:function(t){e(t)},error:function(t){i.topAlert.dangerBlock("Sorry, but it looks like something has gone wrong. Please try again or contact us at support@textmagic.com")}}):$.ajax({url:i.options.commandUrl,dataType:"JSON",method:"POST",data:{cmd:"removeListAll"},beforeSend:function(){},success:function(t){e(t)},error:function(t){console.warn(t)},complete:function(t){$(a).modal("hide")}})}}}})},List.prototype.fillForm=function(t){hideErrors(),this.listid=t.listid,this.updateListModal.find(".modal-title").text(t.modalTitle),this.updateListSubmitBtn.text(t.btnLabel),this.listNameInput.val(t.nameInputValue),this.listTypeChk.prop("checked",!t.typeChkValue),this.isDefaultChk.prop("checked",t.isDefaultChkValue)},List.prototype.editClickHandler=function(t){t={listid:t.id,modalTitle:"Edit list",btnLabel:"Save",nameInputValue:t.name,descAreaValue:t.desc,typeChkValue:t.type,isDefaultChkValue:t.isDefault};this.fillForm(t)},List.prototype.createClickHandler=function(){this.fillForm({listid:null,modalTitle:"Create new list",btnLabel:"Save",nameInputValue:null,descAreaValue:null})},List.prototype.updateGroupList=function(){this.updateContactModal.find("#contact-lists-container").find("ul.dropdown-menu").load("lists/update-list")},List.prototype.sendBtnClickHandler=function(){var t;!0===this.crudApi.getCheckedAllItems()?this.prepareSendToAllRequest():500<(t=this.crudApi.getCheckedItems()).length?this.topAlert.warningBlock("You cannot send a message to more than 500 lists at once. Please choose fewer lists and try again."):window.location.href="/online/messages/new?groups="+t},List.prototype.prepareSendToAllRequest=function(){var e=this;$.ajax({url:e.options.commandUrl,dataType:"JSON",method:"GET",data:{cmd:"prepareSendClick"},beforeSend:function(){e.sendBtn.prop("disabled","disabled")},success:function(t){t.success?window.location.href="/online/messages/new?groups="+t.data.items:e.topAlert.warningBlock(t.message)},error:function(t){console.warn(t)},complete:function(t){e.sendBtn.prop("disabled",!1)}})},List.prototype.submitBtnClickHandler=function(t){var a=this,n=(hideErrors(),this.updateListSubmitBtn.spin("enable","Saving..."),{cmd:"updateList",name:this.listNameInput.val(),type:this.listTypeChk.is(":checked"),listid:this.listid,isDefault:this.isDefaultChk.is(":checked")}),o=$.extend({},n,t);$.ajax({url:a.options.commandUrl,dataType:"JSON",method:"POST",data:o,beforeSend:function(){a.updateListSubmitBtn.spin("enable")},success:function(t){var e;t.success?(a.crudApi.getPaginationApi()&&(a.crudApi.getPaginationApi().reload(),o.listid||a.updateListCount(),a.updateGroupList()),0!==$(".list-profile-container").length&&((e=$(".list-profile")).attr("data-name",$.trim(n.name)),e.attr("data-type",n.type),e.find(".list-name").text($.trim(n.name))),app.track((o.listid?"Edited":"Created")+" a List","Contacts",{id:o.listid,name:o.name,shared:!o.type}),e="New list has been successfully created.",o.listid&&(e="List has been successfully edited."),a.topAlert.successBlock(e),a.updateListModal.modal("hide")):Array.isArray(t.message)?parseAllErrors(t.message):a.topAlert.warningBlock(t.message)},error:function(t){console.warn(t)},complete:function(t){a.updateListSubmitBtn.spin("disable")}})},List.prototype.toggleFavBtnClickHandler=function(t){var e=$(t),a=$(t).find("i.tmi30"),n=a.hasClass("tmi30-star-o");if(e.hasClass("loading"))return!1;e.spin("enable");this.crudApi.updateItems(e.closest("tr").data("id"),"favorited",n?1:0,function(){e.spin("disable"),n?a.removeClass("tmi30-star-o").addClass("tmi30-star"):a.removeClass("tmi30-star").addClass("tmi30-star-o")})},List.prototype.btnSharedPanelClickHandler=function(n){var o=this,i=this.crudApi.getCheckedItems(),t=this.crudApi.getCheckedAllItems(),e="Share lists with Sub-accounts",a="After sharing the selected lists, your sub-accounts will be able to view, edit and delete the contacts in these lists. Are you sure you want to continue?",s="Share lists";0===n&&(a="After making the selected lists private, your sub-accounts will not be able to view, edit or delete the contacts in these lists. Are you sure you want to continue?",s=e="Make lists private"),$.confirm({title:e,message:a,buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:s,class:"btn btn-success",click:function(){var e=this,a=$(this).find("button.btn-success");a.spin("enable","Processing...");$.ajax({url:o.options.commandUrl,dataType:"JSON",method:"POST",data:{cmd:"toggleShared",ids:i,value:n,all:t},beforeSend:function(){},success:function(t){t.success&&(o.crudApi.setCheckedItems([]),o.crudApi.setCheckedAllItems(!1),o.sharedItems=[],o.privateItems=[],o.crudApi.getPaginationApi().reload(),o.topAlert.successBlock(t.message),app.track("Edited Lists","Contacts",{ids:i,shared:!!n}))},error:function(t){console.warn(t)},complete:function(t){a.spin("disable"),$(e).modal("hide")}})}}}})},List.prototype.tableCheckboxClickHandler=function(t){var e=$(t).find('input[type="checkbox"]').is(":checked"),a=parseInt($(t).attr("data-type")),n=parseInt($(t).attr("data-shared-to-me")),t=$(t).attr("data-id");1!==n&&(this.manageItem(t,a,e),this.btnSharedPanelState())},List.prototype.manageItem=function(t,e,a){t=parseInt(t),e?a?this.sharedItems.pushOnce(t):this.sharedItems.popAll(t):a?this.privateItems.pushOnce(t):this.privateItems.popAll(t)},List.prototype.btnSharedPanelState=function(){var t=!0,e='<i class="fa tmi30-person-two-2 tmi30-12px"></i> Share',a="Share lists with sub-accounts",n=1;0<this.sharedItems.length+this.privateItems.length&&(t=!1,0===this.privateItems.length&&(e='<i class="fa tmi30-person tmi30-12px"></i> Make private',a="Make lists private",n=0)),t?this.btnSharedPanel.addClass("disabled"):this.btnSharedPanel.removeClass("disabled"),this.btnSharedPanel.html(e).attr("data-value",n).attr("title",a)},List.prototype.btnFavToggleClickHandler=function(){var a=this,n=parseInt(this.btnFavPanel.attr("data-state"));a.btnFavPanel.addClass("disabled"),a.crudApi.updateItems(this.listid,"favorited",Math.abs(n-1),function(t){a.btnFavPanel.removeClass("disabled");var e=$(".avatar-wrapper").find(".avatar");t.success&&(a.btnFavPanel.attr("data-state",Math.abs(n-1)),a.btnFavPanel.blur(),1===parseInt(a.btnFavPanel.attr("data-state"))?(a.btnFavPanel.html("<i class='fa tmi30-star-o tmi30-14px'></i>Make list unfavorite"),a.btnFavPanel.prop("title","Unfavorite list"),e.addClass("starred")):(a.btnFavPanel.html("<i class='fa tmi30-star tmi30-14px'></i>Make list favorite"),a.btnFavPanel.prop("title","Favorite list"),e.removeClass("starred")))})},List.prototype.avatarUploadHandler=function(t){var e,i,s=this;return!(!window.FormData||!t.target)&&(!!(t=t.target.files[0])&&((e=new FormData).append("image",t),i=s.avatarUploadPreModal.find(".img-wrapper"),void $.ajax({url:"/online/messages/lists/avatar/upload/pre/"+parseInt(s.listid),cache:!1,contentType:!1,processData:!1,type:"POST",data:e,beforeSend:function(){hideErrors(s.topAlert),s.avatar.spin("enable","",{shadow:!0,top:"-2",left:"1"})},success:function(o){var t;o.success?(i.html(""),s.avatarUploadPreModal.off("shown.bs.modal").on("shown.bs.modal",function(){var t=o.data.tmpPath,e=o.data.originalName,a=$("<img>",{class:"img-preview",src:t}),n=s.avatarUploadPreModal.find("form");n.find('input[name="entityId"]').val(s.listid),n.find('input[name="tmpFile"]').val(t),n.find('input[name="originalName"]').val(e),i.prepend(a.load(function(){s.initJcrop($(this),n)}))}),s.avatarUploadPreModal.modal("show")):(t=o.data.errors,$.each(t,function(t,e){s.topAlert.warningBlock(e)}))},error:function(t){413===t.status&&s.topAlert.warningBlock("The maximum allowed file size is 10 MB.")},complete:function(t){s.avatar.spin("disable")}})))},List.prototype.avatarCropFormSubmitHandler=function(){var a,n=this,e=n.avatarCropForm.find('button[type="submit"]'),t={url:n.avatarCropForm.attr("action"),beforeSend:function(){e.spin("enable"),n.avatar.spin("enable","",{shadow:!0,top:"-2",left:"1"}),a=n.avatar.css("background-image"),n.avatar.css("background-image","none")},success:function(t){var e;t.success?(n.avatarUploadPreModal.modal("hide"),(e=t.data.newPath)&&(n.avatarLabel.addClass("hidden"),n.avatar.css("background-image","url("+e+")")),n.topAlert.successBlock(t.message),n.resetImageForms(),n.toggleAvatarState(!0)):(t.data&&(e=t.data.errors||{},$.each(e,function(t,e){n.topAlert.warningBlock(e)})),n.avatar.css("background-image",a))},error:function(t){console.warn(t)},complete:function(t){e.spin("disable"),n.avatar.spin("disable")}};n.avatarCropForm.ajaxForm().ajaxSubmit(t)},List.prototype.avatarRemoveHandler=function(){var n,o=this;$.confirm({title:"Remove avatar",message:"Are you sure you would like to remove list's avatar?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Remove",class:"btn btn-danger",click:function(){var e=this,a=$(this).find("button.btn-danger");a.spin("enable","Removing...");$.ajax({url:o.options.commandUrl,dataType:"JSON",method:"POST",data:{cmd:"removeAvatar",lid:o.listid},beforeSend:function(){o.avatar.spin("enable","",{shadow:!0,top:"-2",left:"1"}),n=o.avatar.css("background-image")},success:function(t){t.success?(o.avatar.css("background-image","none"),o.avatarLabel.removeClass("hidden"),o.topAlert.successBlock(t.message),o.toggleAvatarState(!1)):(t=t.data.errors,$.each(t,function(t,e){o.topAlert.warningBlock(e)}),o.avatar.css("background-image",n))},error:function(t){console.warn(t)},complete:function(t){o.avatar.spin("disable"),a.spin("disable"),$(e).modal("hide")}})}}}})},List.prototype.toggleAvatarState=function(t){this.avatarControl.html(t?'<a href="javascript:void(0);" class="avatar-overlay dropdown" data-toggle="dropdown"><i class="fa tmi30-camera"></i></a><ul class="dropdown-menu text-left"><li><a href="javascript:void(0);" data-widget="change-avatar" title="Upload contact\'s profile photo"><i class="fa tmi30-arrow-upload tmi30-10px"></i>Upload a new avatar</a></li><li><a href="javascript:void(0);" data-widget="remove-avatar" title="Remove contact\'s profile photo"><i class="fa tmi30-trash tmi30-12px"></i>Remove avatar</a></li></ul>':'<a href="javascript:void(0);" class="avatar-overlay" data-widget="change-avatar"><i class="fa tmi30-camera"></i></a>')},List.prototype.initJcrop=function(t,e){var a=t.get(0).naturalWidth,n=t.get(0).naturalHeight;t.Jcrop({aspectRatio:1,minSize:[50,50],bgColor:"#666",bgOpacity:.5,allowSelect:!1,onSelect:function(t){e.find('[name="x1"]').val(t.x),e.find('[name="y1"]').val(t.y),e.find('[name="x2"]').val(t.x2),e.find('[name="y2"]').val(t.y2)},setSelect:[0,0,1e4,1e4],trueSize:[a,n]})},List.prototype.exportContactsBtnClickHandler=function(t,e){500<t?$.confirmDefferedExport(e):(t=$('meta[name="csrf-token"]').attr("content"),window.location=e.exportLnk.attr("href")+"&_csrf_token="+encodeURIComponent(t))},function(t){this.crudApi=null,this.init(t)}),SelectList=(ListFilter.prototype.initCrudApi=function(){if(1===this.ci)return!1;var a=this;this.crudApi=$.prepareCrudPage({containerSelector:"#lists-filter-content",itemSelector:'tr[data-widget="list-filter"]',paginationCommand:a.options.paginationCommand,paginationScroll:a.options.paginationScroll,searchFormSelector:"#lists-filter-search",commandUrl:a.options.commandUrl,afterReloadFunction:function(){$(this.itemSelector).on("click",function(t){a.tableCheckboxClickHandler(this)}),a.checkButtonsEnabled()},topCheckboxChangeFunction:function(t){$(t).is(":checked")?$(this.itemSelector).each(function(){var t=parseInt($(this).attr("data-hidden")),e=$(this).data("id");a.crudApi.addCheckedItems([e]),a.manageItem(e,t,!0)}):($(this.itemSelector).each(function(){var t=parseInt($(this).attr("data-hidden")),e=$(this).data("id");a.crudApi.removeCheckedItems([e]),a.manageItem(e,t,!1)}),a.crudApi.setCheckedAllItems(!1)),a.checkButtonsEnabled()}}),this.ci=1},ListFilter.prototype.tableCheckboxClickHandler=function(t){var e=$(t).find('input[type="checkbox"]').is(":checked"),a=parseInt($(t).attr("data-hidden")),t=$(t).attr("data-id");this.manageItem(t,a,e),this.checkButtonsEnabled()},ListFilter.prototype.manageItem=function(t,e,a){t=parseInt(t),e?a?this.unvisibleItems.pushOnce(t):this.unvisibleItems.popAll(t):a?this.visibleItems.pushOnce(t):this.visibleItems.popAll(t)},ListFilter.prototype.checkButtonsEnabled=function(){0===this.unvisibleItems.length?this.unhideBtn.addClass("disabled"):this.unhideBtn.removeClass("disabled"),0===this.visibleItems.length?this.hideBtn.addClass("disabled"):this.hideBtn.removeClass("disabled")},ListFilter.prototype.init=function(t){var e=this;this.ci=0,this.unvisibleItems=[],this.visibleItems=[],this.mainCrudApi=t.mainCrudApi,this.showFilterBtn=$("#filter-group"),this.hideBtn=$('[data-widget="hide"]'),this.singleHideBtn='[data-widget="single-hide"]',this.unhideBtn=$('[data-widget="show"]'),this.unhideAllBtn=$('[data-widget="show-all"]'),this.filterModal=$("#filterGroupModal"),this.hiddenCounter=$("#hidden-counter"),this.topAlert=$('[data-widget="top-alert"]'),this.options=$.extend({},{paginationCommand:"tableFilter",paginationScroll:!1},t),this.filterModal.on("show.bs.modal",function(){e.crudApi.getPaginationApi().reload()})},ListFilter.prototype.renderHiddenCount=function(){var t=this;this.hiddenCounter.load("/online/messages/lists/ajaxcount-hidden",function(){parseInt($(this).text())?t.unhideAllBtn.removeClass("disabled"):t.unhideAllBtn.addClass("disabled")})},ListFilter.prototype.hideBtnClickHandler=function(e){var a=this;e=e||this.crudApi.getCheckedItems(),$.ajax({url:a.options.commandUrl,type:"POST",data:{cmd:"hideItems",ids:e},dataType:"JSON",beforeSend:function(){a.hideBtn.spin("enable"),a.unhideBtn.addClass("disabled"),a.unhideAllBtn.addClass("disabled")},complete:function(){a.hideBtn.spin("disable"),a.unhideBtn.removeClass("disabled"),a.unhideAllBtn.removeClass("disabled")},success:function(t){a.crudApi.setCheckedItems([]),a.unvisibleItems=[],a.visibleItems=[],a.crudApi.getPaginationApi().reload(),a.filterModal.modal("hide"),a.renderHiddenCount(),a.mainCrudApi.setCheckedItems([]),a.mainCrudApi.getPaginationApi().reload(),a.topAlert.successBlock(1<e.length?"Lists has been successfully hidden.":"List has been successfully hidden.")},error:function(t){console.log(t)}})},ListFilter.prototype.unhideBtnClickHandler=function(t){var e=this,a={cmd:"unhideItems",ids:t=t||this.crudApi.getCheckedItems()};"all"===t&&(a.all=!0),$.ajax({url:e.options.commandUrl,type:"POST",data:a,dataType:"JSON",beforeSend:function(){"all"===t?(e.unhideAllBtn.spin("enable"),e.unhideBtn.addClass("disabled")):(e.unhideBtn.spin("enable"),e.unhideAllBtn.addClass("disabled")),e.hideBtn.addClass("disabled")},complete:function(){("all"===t?e.unhideAllBtn:e.unhideBtn).spin("disable"),e.unhideAllBtn.removeClass("disabled"),e.hideBtn.removeClass("disabled")},success:function(t){e.crudApi.setCheckedItems([]),e.unvisibleItems=[],e.visibleItems=[],e.crudApi.getPaginationApi().reload(),e.filterModal.modal("hide"),e.renderHiddenCount(),e.mainCrudApi.getPaginationApi().reload()},error:function(t){console.log(t)}})},function(t){this.init(t)}),MessagePreview=(SelectList.prototype.init=function(t){var n=this;this.options=$.extend({},{containerSelector:"#select-lists-content",paginationCommand:"tableSelectGroup",paginationScroll:!1,commandUrl:"/online/messages/lists/ajax",itemSelector:"tr[data-widget=select-list]",searchFormSelector:"#select-lists-search",checkboxChangeFunction:function(t){var e=$(t).closest("tr").data("id"),a=n.crudApi.getOptions().itemSelector;void 0===window.checkedData&&(window.checkedData=[]),$(t).is(":checked")?(n.crudApi.addCheckedItems([e]),window.checkedData.push($(t).closest("tr").data())):!0===n.crudApi.getCheckedAllItems()?(n.crudApi.setCheckedAllItems(!1),n.crudApi.setCheckedItems([]),window.checkedData=[],$(a).each(function(){$(this).find('input[type="checkbox"]').is(":checked")&&(n.crudApi.addCheckedItems([$(this).data("id")]),window.checkedData.pushOnce($(this).data()))})):(n.crudApi.removeCheckedItems([e]),window.checkedData.popAll($(a+'[data-id="'+e+'"]').data())),n.toggleAddButton(),this.togglePager()},topCheckboxChangeFunction:function(t){var t=$(t).is(":checked"),e=n.crudApi.getOptions().itemSelector,t=(t?$(e).each(function(){void 0===window.checkedData&&(window.checkedData=[]),n.crudApi.addCheckedItems([$(this).data("id")]),window.checkedData.pushOnce($(this).data())}):(void 0===window.checkedData&&(window.checkedData=[]),$(e).each(function(){n.crudApi.removeCheckedItems([$(this).data("id")]),window.checkedData.popAll($(this).data())}),n.crudApi.setCheckedAllItems(!1)),null);n.crudApi.getCheckedAllItems()&&(e=n.crudApi.getOptions().containerSelector,t=parseInt($(e).find("[data-crud-export-count]").attr("data-crud-export-count"))),n.toggleAddButton(t),this.togglePager()},selectAllFunction:function(t){window.checkedData=[],n.crudApi.setCheckedAllItems(!0),n.crudApi.setCheckedItems([]),this.togglePager()},getItemsCount:function(){return n.crudApi.getCheckedItems().length}},t),this.topAlert=$('[data-widget="top-alert"]'),this.modalGroups=$("#groupsModal"),this.btnAdd=this.modalGroups.find("#addGroupsButton"),this.getItemsCount=n.options.getItemsCount,this.initCrudApi()},SelectList.prototype.initCrudApi=function(){this.crudApi=$.prepareCrudPage(this.options)},SelectList.prototype.modalGroupsHiddenHandler=function(t){this.modalGroupsReset(this,t)},SelectList.prototype.modalGroupsReset=function(t,e){e=$(e).find("input[name=search-query]");""!=e.val()&&e.val("").change(),t.crudApi.setCheckedAllItems(!1),t.crudApi.setCheckedItems([]),window.checkedData=[],t.crudApi.getPaginationApi().setOptions({page:1}),t.crudApi.getPaginationApi().reload(),this.toggleAddButton()},SelectList.prototype.toggleAddButton=function(t){var t=t||this.getItemsCount(),e=$("span.plural",this.btnAdd),t=parseInt(t);e.text(1===t?"":"s"),1<=t?this.btnAdd.enableButton():this.btnAdd.disableButton(),"function"==typeof $.fn.format&&(t=$.fn.format(t)),$("span.value",this.btnAdd).text(t)},SelectList.prototype.handleBulkItemsAdd=function(a){var e=this,t=this.modalGroups.find('input[name="search-query"]').val();$.ajax({url:e.options.commandUrl,dataType:"JSON",method:"POST",data:{cmd:"prepareSendClick",format:"obj",text:t},beforeSend:function(){e.btnAdd.spin("enable")},success:function(t){t.success?(a.callbackAddGroup&&$.each(t.data.items,function(t,e){a.callbackAddGroup.func.apply(a.callbackAddGroup.context,[{groupId:e.id,name:e.name,count:e.members},!0])}),a.callbackTagEdit&&a.callbackTagEdit()):e.topAlert.warningBlock(t.message)},error:function(t){console.warn(t)},complete:function(t){e.btnAdd.spin("disable")}})},function(t){t=$.extend({},{showPrevNextBar:!0,forcedSingleMessage:!1},t);this.init(t)}),ForwardingSettings=(MessagePreview.prototype.init=function(t){var e=this;this.previewModal=$("#messagePreviewModal"),this.previewModalTable=$("#message-preview-table-content table"),this.forced=!1,this.topAlert=$("#message-new-alert"),this.totalRecipients=$('[data-widget="total-recipients"]'),this.forcedAlert=$('[data-widget="forced-alert"]'),this.previewPrevNextBar=$('[data-widget="preview-prev-next-bar"]'),this.previewPreviousBtn=$('[data-widget="preview-prev"]'),this.previewNextBtn=$('[data-widget="preview-next"]'),this.senderId=$('[data-widget="sender-id"]'),this.recipient=$('[data-widget="recipient"]'),this.messageText=$('[data-widget="message-text"]'),this.totalChars=$('[data-widget="total-chars"]'),this.totalParts=$('[data-widget="total-parts"]'),this.singleCost=$('[data-widget="single-cost"]'),this.totalCost=$('[data-widget="total-cost"]'),this.totalCostRow=$('[data-widget="total-cost-row"]'),this.approxWarning=$('[data-widget="approx-warning"]'),this.approxPrefix=$('[data-widget="approx-prefix"]'),this.parentApprox=$(".approximately"),this.confirmBtn=$('[data-widget="confirm-send"]'),this.sendingForm=$("#formNewMessage"),this.previewData=[],this.msgIndex=0,this.routes={send:"/online/messages/send"},this.previewPreviousBtn.on("click.preview",function(){e.prevBtnClickHandler()}),this.previewNextBtn.on("click.preview",function(){e.nextBtnClickHandler()}),this.confirmBtn.on("click.preview",function(){e.confirmBtnClickHandler()}),t.showPrevNextBar||this.previewPrevNextBar.hide(),this.forcedSingleMessage=t.forcedSingleMessage},MessagePreview.prototype.previewBtnClickHandler=function(t,e){var o=this,i=$(t.target),t=(t.preventDefault(),t.hasOwnProperty("source")||"chat"==t.source),a=$.extend({},e,{preview:!0}),e=[{key:"message",text:"Please enter a message.",hasViolation:0==e.message.text.trim().length}];if(0<(e=e.filter(function(t){return t.hasViolation})).length)return showFormErrors(e.reduce(function(t,e){return t[e.key]=e.text,t},{length:e.length})),!1;i.spin("enable"),t&&(o.previewModal.modal("show"),o.previewModalTable.hide());e={data:a,url:this.routes.send,dataType:"JSON",type:"POST",success:function(t,e,a,n){i.spin("disable"),$(".form-group").removeClass("has-error"),$(".error").remove(),t.success?t.data.hasOwnProperty("previewData")&&(o.setPreviewData(t.data.previewData),o.updateModalTable(),o.previewModalTable.show(),o.previewModal.modal("show")):(t.message.alert&&(o.topAlert.warningBlock(t.message.alert),scrollToView(o.topAlert)),$.each(t.message,function(t,e){if("alert"==t)return!0;t=$("#"+t+"-group");t.find(".input-control").parent().after("<span class='error help-block'>"+e+"</span>"),t.addClass("has-error")}))},error:function(){return i.spin("disable"),!1}};return $.ajax(e)},MessagePreview.prototype.setPreviewData=function(t){this.previewData=t,this.msgIndex=0},MessagePreview.prototype.updateModalTable=function(){this.updateNavigationButtons();var t=this.previewData.messages[this.msgIndex],e=this,a=(e.forced?(e.forcedAlert.show(),e.confirmBtn.show()):(e.forcedAlert.hide(),e.confirmBtn.hide()),e.senderId.text(/^\d+$/.test(t.from_number)?"+"+t.from_number:t.from_number),e.recipient.text(t.first_name==t.phone||null==t.first_name&&null==t.last_name?"+"+t.phone:(null==t.first_name?"":t.first_name)+" "+(null==t.last_name?"":t.last_name)+" (+"+t.phone+")"),e.messageText.text(t.text).html());e.messageText.html(this.linkify(a.replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1<br/>$2"))),e.totalChars.text(t.characters+" character"+(1!=t.characters?"s":"")),e.totalParts.text(t.parts_count+" part"+(1!=t.parts_count?"s":"")),e.singleCost.text(t.credits_price.toFixed(3)),e.approxPrefix.text(e.parentApprox.text().trim()),e.approxPrefix.text()?e.approxWarning.show():e.approxWarning.hide(),this.forcedSingleMessage&&this.totalCostRow.hide()},MessagePreview.prototype.updateNavigationButtons=function(){var t=this;t.msgIndex-1 in t.previewData.messages?t.previewPreviousBtn.removeClass("disabled"):t.previewPreviousBtn.addClass("disabled"),t.msgIndex+1 in t.previewData.messages?t.previewNextBtn.removeClass("disabled"):t.previewNextBtn.addClass("disabled")},MessagePreview.prototype.nextBtnClickHandler=function(){this.msgIndex+=1,this.updateModalTable()},MessagePreview.prototype.prevBtnClickHandler=function(){--this.msgIndex,this.updateModalTable()},MessagePreview.prototype.confirmBtnClickHandler=function(){this.previewModal.modal("hide"),this.sendingForm.submit()},MessagePreview.prototype.linkify=function(t){var e=" "+Math.random().toString(36).substr(2,10)+(new Date).getTime()+" ";return(t=t.split("&nbsp;").join(e)).replace(/(http:\/\/www\.|https:\/\/www\.|http:\/\/|https:\/\/)?[A-Za-z0-9\-]+([\-\.]{1}[A-Za-z0-9]+)*\.[A-Za-z]{2,4}(:[0-9]{1,5})?(\/[A-Za-z?=%0-9-_&~.+;:"']*){0,20}(\s*)/gim,function(e,t,a,n,o,i,s,r){if("@"===r.substr(s-1,1))return e;var d=!1;if(".gle|.ly|.page|.app|.biz|.bot|.com|.org|.net|.int|.edu|.gov|.mil|.au|.uk|.us|.jp|.cn|.ca|.ru|.ch|.de|.fr|.ee|.eg|.es|.fi|gr|.hr|.hu|.il|.in|.it|.kr|.kz|.nl|.no|.nz|.pr|.pt|.py|.sa|.se|.sg|.si|.sk|.th|.tr|.tt|.vn".split("|").map(function(t){-1<e.indexOf(t)&&(d=!0)}),!d)return e;r=e.trim(),s=(s="http"==r.substring(0,4)?r:"http://"+r).replace("<br/>",""),s='<a href="$1" target="_blank">$2</a>'.replace("$1",s).replace("$2",r);return null==i?s:s+i}).replace(/(([a-zA-Z0-9\+\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,10})+)/gim,'<a href="mailto:$1">$1</a>').split(e).join("&nbsp;")},function(t){this.init(t)});ForwardingSettings.prototype.init=function(t){var n=this,t=(this.searchTimer=!1,this.uiId=!1,this.voiceAvailable=app.data.user.voiceAvailable,this.forwardPhone=!1,this.options=$.extend({},{afterSavingCallback:function(t){return!1},afterUnsuccessfulSavingCallback:function(){return!1},allowEmptyNumber:!1},t),this.form=$("#form-forwarding"),this.table=$("#addGreetingTable"),this.forwardEnable=$('input[data-field="forward-number-enable"]'),this.forwardNumberInput=$('input[data-field="forward-number"]'),this.costHelpBlock=$('[data-widget="cost"]'),this.costLabel=$('[data-widget="forwarding-cost"]'),this.costLabelHundred=$('[data-widget="forwarding-cost-hundred"]'),this.countryLabel=$('[data-widget="forwarding-country"]'),this.continueButton=$("#update-forwarding-button"),this.forwardDirection=$("#forwardDirection"),this.forwardAudioId=!1,this.forwardAudioName=!1,this.forwardAudioLink=!1,this.forwardAudioLength=!1,this.forwardAudioCrudApi=!1,this.playPauseButtonsSelector='[data-widget="play-pause"]',this.filepicker=$('[data-widget="filepicker"]'),this.filepickerForm=this.filepicker.closest("form"),this.filepickerButton=$('[data-widget="open-filepicker"]'),this.topAlert=$('[data-widget="top-alert"]'),this.addGreetingButton=$("#addGreetingButton"),this.itemSelector="tr[data-widget=audio]",this.forwardAudioNameLabel=$('[data-widget="audio-label"]'),this.addEditAudioLink=$('a[data-widget="add-edit-audio"]'),this.clearAudioLink=$('a[data-widget="clear-audio"]'),this.searchInput=$('#audio-form-search [name="search-query"]'),this.modal=this.filepicker.closest(".modal"),this.internalErrorText="An internal error has occurred. Please try again later or contact support",this.route={price:"/online/reply-options/forwarding/price/",save:"/online/reply-options/forwarding/save/",contacts:"/online/messages/conversation/contacts/true"},this.forwardNumberInput.on("input change",function(t){t.preventDefault(),n.forwardNumberInputHandler(t,$(this).val())}).on("blur",function(t){t.preventDefault(),n.forwardNumberInputBlurHandler(t,$(this).val())}).autocomplete({source:n.route.contacts,select:function(t,e){return e.item.value&&"header"!==e.item.role&&n.forwardNumberInput.val("+"+e.item.value).trigger("blur"),!1},delay:500}).data("ui-autocomplete")),t=(t&&(t._renderItem=function(t,e){return $("<li>").append('<a><span class="title"><b class="name">'+e.label+"</b>"+(e.shared_by?'<span class="shared-by pull-right">Shared by '+e.shared_by+"</span>":"")+'</span><span class="value">+'+e.value+"</span></a>").appendTo(t)}),this.continueButton.on("click",function(t){t.preventDefault(),n.saveForwardingSettings()}),this.addGreetingButton.on("click",function(){n.addGreetingButtonClickHandler()}),this.forwardAudioCrudApi=$.prepareCrudPage({commandUrl:"/online/reply-options/dedicated/ajax",containerSelector:"#greetings-content",paginationCommand:"audioTable",paginationScroll:!1,itemSelector:n.itemSelector,searchFormSelector:"#audio-form-search",removeCommand:"removeAudio",afterReloadFunction:function(){$(n.playPauseButtonsSelector).on("click",function(t){t.preventDefault(),n.playPauseButtonsHandler($(this))}),$.each($(n.playPauseButtonsSelector),function(){var t=$(this);t.parent().find("audio").on("ended",function(){t.find("i").removeClass("fa-pause").addClass("fa-play")})})},removeFunction:function(t){var a=$(t).closest("tr").data("id");$.confirm({title:"Delete recording",message:"Are you sure you would like to delete this recording? This action cannot be undone.",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Delete",class:"btn btn-danger",click:function(){var e=$(this);n.forwardAudioCrudApi.removeItems(a,function(t){a==n.forwardAudioId&&n.clearAudioLinkClickHandler(),e.modal("hide"),n.forwardAudioCrudApi.getPaginationApi().reload(),n.topAlert.successBlock("The audio file has been successfully deleted.")})}}}})},bulkRemoveFunction:function(t){return $.confirm({title:"Delete recordings",message:"Are you sure you would like to delete these recordings? This action cannot be undone.",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Delete",class:"btn btn-danger",click:function(){var e=$(this);$(this).find("button.btn-danger").spin("enable","Deleting..."),n.forwardAudioCrudApi.removeItems(!1===n.forwardAudioCrudApi.getCheckedAllItems()?n.forwardAudioCrudApi.getCheckedItems():"all",function(t){-1!==n.forwardAudioCrudApi.getCheckedItems().indexOf(n.forwardAudioId)&&n.clearAudioLinkClickHandler(),e.modal("hide"),n.forwardAudioCrudApi.getPaginationApi().reload(),1<t.data.count?n.topAlert.successBlock("The audio files have been successfully deleted."):n.topAlert.successBlock("The audio file has been successfully deleted.")})}}}}),!0}}),this.filepickerButton.on("click",function(t){t.preventDefault(),n.topAlert.hide(),n.filepickerButtonClickHandler()}),this.filepickerForm.ajaxForm({dataType:"json",beforeSubmit:function(t,e,a){n.filepickerButton.spin("enable","Please wait...")},success:function(t){n.filepickerButton.spin("disable"),t.success?n.forwardAudioCrudApi.getPaginationApi().reload():(n.filepickerButton.spin("disable"),t=t.message.alert,n.topAlert.warningBlock(t))},error:function(){n.filepickerButton.spin("disable"),n.topAlert.warningBlock("Something went wrong while uploading, please try again or pick another file.")}}),this.filepicker.on("change",function(t){n.filepickerForm.submit()}),this.clearAudioLink.on("click",function(t){n.clearAudioLinkClickHandler()}),this.modal);t.on("hide.bs.modal",function(){var t=n.filepickerForm.data("jqxhr");t&&(t.abort(),n.filepickerForm.data("jqxhr",null)),n.searchInput.val("").change()}),t.on("show.bs.modal",function(){n.topAlert.hide()}),$(document.body).on("change",".table-radio input:checkbox",function(){var t=this;$(this).closest("table").find("input:checkbox").filter(function(){return this!==t}).prop("checked",!1),$(this).prop("checked")?n.forwardAudioCrudApi.setCheckedItems([$(this).closest("tr").data("id")]):n.forwardAudioCrudApi.setCheckedItems([])})},ForwardingSettings.prototype.setAllowEmptyNumber=function(t){this.options.allowEmptyNumber=t},ForwardingSettings.prototype.saveUiId=function(t){this.uiId=t},ForwardingSettings.prototype.saveUiVoice=function(t){this.voiceAvailable=t},ForwardingSettings.prototype.requestForwardingPrice=function(t,e){function a(){hideErrors(),n.costHelpBlock.hide(),n.resetCostLabels(),n.continueButton.addClass("disabled"),n.forwardPhone=!1}var n=this;return 0==t.trim().length?(a(),n.options.allowEmptyNumber&&n.continueButton.removeClass("disabled"),!1):(n.costLabel.spin("enable"),n.continueButton.addClass("disabled"),hideErrors(),$.getJSON(n.route.price+t+(e?"/true":""),!1,function(t){if(n.costLabel.spin("disable"),hideErrors(),!t.success)return n.costHelpBlock.hide(),n.resetCostLabels(),n.continueButton.addClass("disabled"),n.forwardPhone=!1,parseAllErrors(t.message),!1;n.costLabel.text(+parseFloat(t.data.price).toFixed(4)),n.costLabelHundred.text(+parseFloat(100*t.data.price).toFixed(3)),n.countryLabel.text(t.data.countryName),n.costHelpBlock.show(),n.forwardPhone=t.data.phone,n.continueButton.removeClass("disabled")}).fail(function(){a(),parseAllErrors({"forward-number":n.internalErrorText})}),!0)},ForwardingSettings.prototype.resetCostLabels=function(){var t=+parseFloat(app.data.user.defaultForwardingPrice),e=+parseFloat(100*app.data.user.defaultForwardingPrice);this.costLabel.text(t.toFixed(4)),this.costLabelHundred.text(e.toFixed(3)),this.costHelpBlock.show(),this.countryLabel.text(app.data.user.countryName)},ForwardingSettings.prototype.forwardNumberInputHandler=function(t,e){clearTimeout(this.searchTimer),13==t.keyCode?this.requestForwardingPrice(e):"object"==typeof i18n&&"object"==typeof i18n.phonenumbers&&i18n.phonenumbers.PhoneNumberUtil.getInstance().transformPhoneNumber(e.replace(/^00/,"+"),this.forwardNumberInput.data("country")).isValid&&this.forwardNumberInput.trigger("blur")},ForwardingSettings.prototype.forwardNumberInputBlurHandler=function(t,e){this.requestForwardingPrice(e)},ForwardingSettings.prototype.saveForwardingSettings=function(){var e=this;return e.form.spin("enable"),e.uiId?(hideErrors(),$.getJSON(e.route.save+e.forwardPhone+"/"+e.uiId+"/"+e.forwardDirection.val()+"/"+e.forwardAudioId,!1,function(t){if(e.form.spin("disable"),hideErrors(),!t.success)return e.costHelpBlock.hide(),parseAllErrors(t.message),e.options.afterUnsuccessfulSavingCallback(),!1;e.options.afterSavingCallback(t)}).fail(function(){return e.form.spin("disable"),hideErrors(),e.costHelpBlock.hide(),parseAllErrors({"forward-number":e.internalErrorText}),e.options.afterUnsuccessfulSavingCallback(),!1}),!0):(e.options.afterUnsuccessfulSavingCallback(),!1)},ForwardingSettings.prototype.playPauseButtonsHandler=function(t){var e=t.parent().find("audio");e.prop("paused")?($.each($("audio"),function(){var t=$(this);t.trigger("pause"),t.trigger("ended")}),e.trigger("play"),t.find("i").removeClass("fa-play").addClass("fa-pause")):(e.trigger("pause"),t.find("i").removeClass("fa-pause").addClass("fa-play"))},ForwardingSettings.prototype.filepickerButtonClickHandler=function(){this.filepickerForm.trigger("reset"),this.filepicker.click()},ForwardingSettings.prototype.addGreetingButtonClickHandler=function(){var t=this,e=(t.forwardAudioCrudApi.getCheckedItems().length||t.clearAudioLinkClickHandler(),t.forwardAudioCrudApi.getCheckedItems()[0]),a=$(t.itemSelector+"[data-id="+e+"]");t.forwardAudioId=e,t.forwardAudioName=a.data("original-name"),t.forwardAudioLink=a.data("real-href"),t.forwardAudioLength=a.data("length"),t.forwardAudioNameLabel.text(t.forwardAudioName),t.addEditAudioLink.html('<i class="fa tmi30-pencil tmi30-12px"></i>Edit greeting'),t.clearAudioLink.show()},ForwardingSettings.prototype.clearAudioLinkClickHandler=function(){var t=this;t.forwardAudioId=!1,t.forwardAudioName=!1,t.forwardAudioLink=!1,t.forwardAudioLength=!1,t.forwardAudioNameLabel.html("<i>(No greeting)</i>"),t.addEditAudioLink.html('<i class="fa fa-plus"></i>Add greeting'),t.clearAudioLink.hide()};