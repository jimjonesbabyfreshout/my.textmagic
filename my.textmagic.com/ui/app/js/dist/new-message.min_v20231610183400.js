function initSearchWidget(e,a,n,t,i,o,s){var r,d=$(n);d.on("submit",function(){s();var t=a.getRequestParams().params,e=$(this).find("input:text[name=search-query]").val(),n=d.data("last-text");return n&&n==e||(app.stopAjaxRequests(a.getOptions().url),d.data("last-text",e),t=$.extend({},t,{text:e}),a.setRequestParams({params:t}).reload()),!1}),$(".search-group a[data-field]").on("click",function(){$(".search-group button[data-field]").attr("data-field",$(this).data("field")),$(".search-group span#field-label").html($(this).html()),$('.search-group input:text[name="search-query"]').focus(),""!==$('.search-group input:text[name="search-query"]').val()&&a.reload()}),d.find('input[name="search-query"]').on("input change",function(t){clearTimeout(e),13==t.keyCode?(d.data("last-text",null),d.submit()):e=setTimeout(function(){d.submit()},500)}),$("#searchFilterClose").on("click",function(t){t.preventDefault(),$(this).parent().addClass("hidden"),$("#searchFilterBtn").removeClass("active"),$('input[name="search-query"]').val("").change()}),$("#searchFilterBtn").on("click",function(t){t.preventDefault();var t=$(this),e=t.closest(".btn-panel").parent().find(n);e.hasClass("hidden")?(t.addClass("active"),e.removeClass("hidden"),e.find('input[name="search-query"]').focus()):(t.removeClass("active"),e.addClass("hidden"),e.find('input[name="search-query"]').val("").change())}),t&&(t=$(t),$('input[name="date-filter-list"]',t).parent().on("click",function(t){t.preventDefault();t=$("input",this).val();if("Pick date range"==t)return!0;var e=a.getRequestParams().params,e=$.extend({},e,{date_pair:t});a.setRequestParams({params:e}).reload()})),i&&(r=$(i),$("#showDateRange",r).on("click",function(t){t.preventDefault();t=a.getRequestParams().params,t=$.extend({},t,{date_pair:"Pick date range",from:$("#dateFilterStart",r).val(),to:$("#dateFilterEnd",r).val()});a.setRequestParams({params:t}).reload()})),o&&d.submit()}function appendNoResults(t){var e,n,a,i;t&&(0==t.children("tbody").children("tr").length||1==t.children("tbody").children("tr").length&&t.children("tbody").children("tr").hasClass("table-data-select"))&&(i=t.children("thead"),e="100%",n=0==t.children("tbody").children("tr").length,a=t.children("thead").find("tr:first-child > th"),0!==i.length&&0!==a.length&&n&&(e=a.length),i=(i=t.data("empty-hint"))||"No search results found. Please try a different keyword or period.",t.children("tbody").append('<tr class="empty"><td colspan="'+e+'">'+i+"</td></tr>"))}!function(t,e){"object"==typeof module&&module.exports?module.exports=e():"function"==typeof define&&define.amd?define([],e):(t.RRule=e(t),t.RRuleSet=t.RRule.RRuleSet,t.rrulestr=t.RRule.rrulestr)}("object"==typeof window?window:this,function(t){function a(t,e){1===arguments.length&&(e=t,t=0);for(var n=[],a=t;a<e;a++)n.push(a);return n}function y(t,e){var n=0,a=[];if(t instanceof Array)for(;n<e;n++)a[n]=[].concat(t);else for(;n<e;n++)a[n]=t;return a}function K(t,e){return(t%=e)*e<0?t+e:t}function Q(t,e){return{div:Math.floor(t/e),mod:K(t,e)}}function X(t){return!(t instanceof Array&&0===t.length)&&Boolean(t)}function tt(t,e){return-1!==t.indexOf(e)}function v(t,e){if(0===e)throw new Error("Can't create weekday with n == 0");this.weekday=t,this.n=e}function et(e,t){e=e||{},this._string=null,this._cache=t?null:{all:!1,before:[],after:[],between:[]},this.origOptions={},this.options={};var n=[],a=Object.keys(e),i=Object.keys(et.DEFAULT_OPTIONS);if(a.forEach(function(t){this.origOptions[t]=e[t],this.options[t]=e[t],tt(i,t)||n.push(t)},this),n.length)throw new Error("Invalid options: "+n.join(", "));if(!et.FREQUENCIES[e.freq]&&null===e.byeaster)throw new Error("Invalid frequency: "+String(e.freq));i.forEach(function(t){tt(a,t)||(this.options[t]=et.DEFAULT_OPTIONS[t])},this);var o=this.options,s=(null!==o.byeaster&&(o.freq=et.YEARLY),o.dtstart||(o.dtstart=new Date((new Date).setMilliseconds(0))),o.dtstart.getTime()%1e3);if(null===o.wkst?o.wkst=et.MO.weekday:"number"!=typeof o.wkst&&(o.wkst=o.wkst.weekday),null!==o.bysetpos){"number"==typeof o.bysetpos&&(o.bysetpos=[o.bysetpos]);for(var r=0;r<o.bysetpos.length;r++){var d=o.bysetpos[r];if(0===d||!(-366<=d&&d<=366))throw new Error("bysetpos must be between 1 and 366, or between -366 and -1")}}if(!(X(o.byweekno)||X(o.byyearday)||X(o.bymonthday)||null!==o.byweekday||null!==o.byeaster))switch(o.freq){case et.YEARLY:o.bymonth||(o.bymonth=o.dtstart.getMonth()+1),o.bymonthday=o.dtstart.getDate();break;case et.MONTHLY:o.bymonthday=o.dtstart.getDate();break;case et.WEEKLY:o.byweekday=nt.getWeekday(o.dtstart)}if(null===o.bymonth||o.bymonth instanceof Array||(o.bymonth=[o.bymonth]),null===o.byyearday||o.byyearday instanceof Array||(o.byyearday=[o.byyearday]),null===o.bymonthday)o.bymonthday=[],o.bynmonthday=[];else if(o.bymonthday instanceof Array){for(var l=[],c=[],r=0;r<o.bymonthday.length;r++)0<(d=o.bymonthday[r])?l.push(d):d<0&&c.push(d);o.bymonthday=l,o.bynmonthday=c}else o.bymonthday<0?(o.bynmonthday=[o.bymonthday],o.bymonthday=[]):(o.bynmonthday=[],o.bymonthday=[o.bymonthday]);if(null===o.byweekno||o.byweekno instanceof Array||(o.byweekno=[o.byweekno]),null===o.byweekday)o.bynweekday=null;else if("number"==typeof o.byweekday)o.byweekday=[o.byweekday],o.bynweekday=null;else if(o.byweekday instanceof v)!o.byweekday.n||o.freq>et.MONTHLY?(o.byweekday=[o.byweekday.weekday],o.bynweekday=null):(o.bynweekday=[[o.byweekday.weekday,o.byweekday.n]],o.byweekday=null);else{var u=[],h=[];for(r=0;r<o.byweekday.length;r++){var p=o.byweekday[r];"number"==typeof p?u.push(p):!p.n||o.freq>et.MONTHLY?u.push(p.weekday):h.push([p.weekday,p.n])}o.byweekday=X(u)?u:null,o.bynweekday=X(h)?h:null}if(null===o.byhour?o.byhour=o.freq<et.HOURLY?[o.dtstart.getHours()]:null:"number"==typeof o.byhour&&(o.byhour=[o.byhour]),null===o.byminute?o.byminute=o.freq<et.MINUTELY?[o.dtstart.getMinutes()]:null:"number"==typeof o.byminute&&(o.byminute=[o.byminute]),null===o.bysecond?o.bysecond=o.freq<et.SECONDLY?[o.dtstart.getSeconds()]:null:"number"==typeof o.bysecond&&(o.bysecond=[o.bysecond]),o.freq>=et.HOURLY)this.timeset=null;else{for(this.timeset=[],r=0;r<o.byhour.length;r++)for(var m=o.byhour[r],f=0;f<o.byminute.length;f++)for(var g=o.byminute[f],b=0;b<o.bysecond.length;b++){var y=o.bysecond[b];this.timeset.push(new nt.Time(m,g,y,s))}nt.sort(this.timeset)}}function w(t){this._cache=t?null:{all:!1,before:[],after:[],between:[]},this._rrule=[],this._rdate=[],this._exrule=[],this._exdate=[]}function h(){}var nt={MONTH_DAYS:[31,28,31,30,31,30,31,31,30,31,30,31],ONE_DAY:864e5,MAXYEAR:9999,ORDINAL_BASE:new Date(1900,0,1),PY_WEEKDAYS:[6,0,1,2,3,4,5],getYearDay:function(t){var e=new Date(t.getFullYear(),t.getMonth(),t.getDate());return Math.ceil((e-new Date(t.getFullYear(),0,1))/nt.ONE_DAY)+1},isLeapYear:function(t){return t%4==0&&t%100!=0||t%400==0},tzOffset:function(t){return 60*t.getTimezoneOffset()*1e3},daysBetween:function(t,e){t=t.getTime()-nt.tzOffset(t),e=e.getTime()-nt.tzOffset(e);return Math.round((t-e)/nt.ONE_DAY)},toOrdinal:function(t){if(t<nt.ORDINAL_BASE)throw new Error("dates lower than "+nt.ORDINAL_BASE+" are not supported");return nt.daysBetween(t,nt.ORDINAL_BASE)},fromOrdinal:function(t){t*=nt.ONE_DAY;return new Date(nt.ORDINAL_BASE.getTime()-nt.tzOffset(nt.ORDINAL_BASE)+t+nt.tzOffset(new Date(t)))},monthRange:function(t,e){t=new Date(t,e,1);return[nt.getWeekday(t),nt.getMonthDays(t)]},getMonthDays:function(t){var e=t.getMonth();return 1===e&&nt.isLeapYear(t.getFullYear())?29:nt.MONTH_DAYS[e]},getWeekday:function(t){return nt.PY_WEEKDAYS[t.getDay()]},combine:function(t,e){return e=e||t,new Date(t.getFullYear(),t.getMonth(),t.getDate(),e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds())},clone:function(t){return new Date(t.getTime())},cloneDates:function(t){for(var e=[],n=0;n<t.length;n++)e.push(nt.clone(t[n]));return e},sort:function(t){t.sort(function(t,e){return t.getTime()-e.getTime()})},timeToUntilString:function(t){for(var e,t=new Date(t),n=[t.getUTCFullYear(),t.getUTCMonth()+1,t.getUTCDate(),"T",t.getUTCHours(),t.getUTCMinutes(),t.getUTCSeconds(),"Z"],a=0;a<n.length;a++)e=n[a],!/[TZ]/.test(e)&&e<10&&(n[a]="0"+String(e));return n.join("")},untilStringToDate:function(t){var e=/^(\d{4})(\d{2})(\d{2})(T(\d{2})(\d{2})(\d{2})Z?)?$/.exec(t);if(e)return new Date(Date.UTC(e[1],e[2]-1,e[3],e[5]||0,e[6]||0,e[7]||0));throw new Error("Invalid UNTIL value: "+t)},Time:function(t,e,n,a){this.hour=t,this.minute=e,this.second=n,this.millisecond=a||0}},k=(nt.Time.prototype={constructor:nt.Time,getHours:function(){return this.hour},getMinutes:function(){return this.minute},getSeconds:function(){return this.second},getMilliseconds:function(){return this.millisecond},getTime:function(){return 1e3*(60*this.hour*60+60*this.minute+this.second)+this.millisecond}},[].concat(y(1,31),y(2,28),y(3,31),y(4,30),y(5,31),y(6,30),y(7,31),y(8,31),y(9,30),y(10,31),y(11,30),y(12,31),y(1,7))),C=[].concat(y(1,31),y(2,29),y(3,31),y(4,30),y(5,31),y(6,30),y(7,31),y(8,31),y(9,30),y(10,31),y(11,30),y(12,31),y(1,7)),e=a(1,29),n=a(1,30),i=a(1,31),o=a(1,32),$=[].concat(o,n,o,i,o,i,o,o,i,o,i,o,o.slice(0,7)),x=[].concat(o,e,o,i,o,i,o,o,i,o,i,o,o.slice(0,7)),e=a(-28,0),n=a(-29,0),i=a(-30,0),o=a(-31,0),A=[].concat(o,n,o,i,o,i,o,o,i,o,i,o,o.slice(0,7)),S=[].concat(o,e,o,i,o,i,o,o,i,o,i,o,o.slice(0,7)),I=[0,31,60,91,121,152,182,213,244,274,305,335,366],T=[0,31,59,90,120,151,181,212,243,273,304,334,365],D=function(){for(var t=[],e=0;e<55;e++)t=t.concat(a(7));return t}(),s=["MO","TU","WE","TH","FR","SA","SU"],at=(v.prototype={constructor:v,nth:function(t){return this.n===t?this:new v(this.weekday,t)},equals:function(t){return this.weekday===t.weekday&&this.n===t.n},toString:function(){var t=s[this.weekday];return t=this.n?(0<this.n?"+":"")+String(this.n)+t:t},getJsWeekday:function(){return 6===this.weekday?0:this.weekday+1}},et.FREQUENCIES=["YEARLY","MONTHLY","WEEKLY","DAILY","HOURLY","MINUTELY","SECONDLY"],et.YEARLY=0,et.MONTHLY=1,et.WEEKLY=2,et.DAILY=3,et.HOURLY=4,et.MINUTELY=5,et.SECONDLY=6,et.MO=new v(0),et.TU=new v(1),et.WE=new v(2),et.TH=new v(3),et.FR=new v(4),et.SA=new v(5),et.SU=new v(6),et.DEFAULT_OPTIONS={freq:null,dtstart:null,interval:1,wkst:et.MO,count:null,until:null,bysetpos:null,bymonth:null,bymonthday:null,bynmonthday:null,byyearday:null,byweekno:null,byweekday:null,bynweekday:null,byhour:null,byminute:null,bysecond:null,byeaster:null},et.parseText=function(t,e){return c().parseText(t,e)},et.fromText=function(t,e){return c().fromText(t,e)},et.optionsToString=function(t){for(var e,n,a,i=[],o=Object.keys(t),s=Object.keys(et.DEFAULT_OPTIONS),r=0;r<o.length;r++)if(tt(s,o[r])&&(e=o[r].toUpperCase(),a=[],!(null===(n=t[o[r]])||n instanceof Array&&!n.length))){switch(e){case"FREQ":n=et.FREQUENCIES[t.freq];break;case"WKST":n instanceof v||(n=new v(n));break;case"BYWEEKDAY":e="BYDAY",n instanceof Array||(n=[n]);for(var d,l=0;l<n.length;l++)(d=n[l])instanceof v||(d=d instanceof Array?new v(d[0],d[1]):new v(d)),a[l]=d.toString();n=a;break;case"DTSTART":case"UNTIL":n=nt.timeToUntilString(n);break;default:if(n instanceof Array){for(l=0;l<n.length;l++)a[l]=String(n[l]);n=a}else n=String(n)}i.push([e,n])}for(var c=[],r=0;r<i.length;r++){var u=i[r];c.push(u[0]+"="+u[1].toString())}return c.join(";")},et.prototype={constructor:et,all:function(t){return t?this._iter(new d("all",{},t)):(!1===(t=this._cacheGet("all"))&&(t=this._iter(new r("all",{})),this._cacheAdd("all",t)),t)},between:function(t,e,n,a){e={before:e,after:t,inc:n};if(a)return this._iter(new d("between",e,a));t=this._cacheGet("between",e);return!1===t&&(t=this._iter(new r("between",e)),this._cacheAdd("between",t,e)),t},before:function(t,e){t={dt:t,inc:e},e=this._cacheGet("before",t);return!1===e&&(e=this._iter(new r("before",t)),this._cacheAdd("before",e,t)),e},after:function(t,e){t={dt:t,inc:e},e=this._cacheGet("after",t);return!1===e&&(e=this._iter(new r("after",t)),this._cacheAdd("after",e,t)),e},count:function(){return this.all().length},toString:function(){return et.optionsToString(this.origOptions)},toText:function(t,e){return c().toText(this,t,e)},isFullyConvertibleToText:function(){return c().isFullyConvertible(this)},_cacheAdd:function(t,e,n){this._cache&&(e=e&&(e instanceof Date?nt.clone(e):nt.cloneDates(e)),"all"===t?this._cache.all=e:(n._value=e,this._cache[t].push(n)))},_cacheGet:function(t,a){if(!this._cache)return!1;var e=!1,i=a?Object.keys(a):[];if("all"===t)e=this._cache.all;else for(var n,o=0;o<this._cache[t].length;o++)if(n=this._cache[t][o],!i.length||!function(t){for(var e,n=0;n<i.length;n++)if(e=i[n],String(a[e])!==String(t[e]))return!0;return!1}(n)){e=n._value;break}if(!e&&this._cache.all){for(var s=new r(t,a),o=0;o<this._cache.all.length&&s.accept(this._cache.all[o]);o++);e=s.getValue(),this._cacheAdd(t,e,a)}return e instanceof Array?nt.cloneDates(e):e instanceof Date?nt.clone(e):e},clone:function(){return new et(this.origOptions)},_iter:function(t){for(var e,n,a,i,o,s,r,d,l,c,u,h,p=this.options.dtstart,L=this.options.dtstart%1e3,m=p.getFullYear(),f=p.getMonth()+1,g=p.getDate(),b=p.getHours(),y=p.getMinutes(),v=p.getSeconds(),w=nt.getWeekday(p),k=this.options.freq,C=this.options.interval,$=this.options.wkst,F=this.options.until,O=this.options.bymonth,R=this.options.byweekno,x=this.options.byyearday,U=this.options.byweekday,Y=this.options.byeaster,H=this.options.bymonthday,j=this.options.bynmonthday,q=this.options.bysetpos,A=this.options.byhour,S=this.options.byminute,W=this.options.bysecond,I=new at(this),T=(I.rebuild(m,f),{}),D=(T[et.YEARLY]=I.ydayset,T[et.MONTHLY]=I.mdayset,T[et.WEEKLY]=I.wdayset,T[et.DAILY]=I.ddayset,T[et.HOURLY]=I.ddayset,T[et.MINUTELY]=I.ddayset,T[et.SECONDLY]=I.ddayset,T=T[k],e=k<et.HOURLY?this.timeset:((n={})[et.HOURLY]=I.htimeset,n[et.MINUTELY]=I.mtimeset,n[et.SECONDLY]=I.stimeset,n=n[k],et.HOURLY<=k&&X(A)&&!tt(A,b)||et.MINUTELY<=k&&X(S)&&!tt(S,y)||et.SECONDLY<=k&&X(W)&&!tt(W,v)?[]:n.call(I,b,y,v,L)),0),V=this.options.count;;){for(d=(r=T.call(I,m,f,g))[0],l=r[1],c=r[2],h=!1,E=l;E<c;E++)P=d[E],(h=X(O)&&!tt(O,I.mmask[P])||X(R)&&!I.wnomask[P]||X(U)&&!tt(U,I.wdaymask[P])||X(I.nwdaymask)&&!I.nwdaymask[P]||null!==Y&&!tt(I.eastermask,P)||(X(H)||X(j))&&!tt(H,I.mdaymask[P])&&!tt(j,I.nmdaymask[P])||X(x)&&(P<I.yearlen&&!tt(x,P+1)&&!tt(x,-I.yearlen+P)||P>=I.yearlen&&!tt(x,P+1-I.yearlen)&&!tt(x,-I.nextyearlen+P-I.yearlen)))&&(d[P]=null);if(X(q)&&X(e)){for(var B,M,N=[],E=0;E<q.length;E++){M=(M=q[E])<0?(B=Math.floor(M/e.length),K(M,e.length)):(B=Math.floor((M-1)/e.length),K(M-1,e.length));try{for(r=[],a=l;a<c;a++){var z=d[a];null!==z&&r.push(z)}var P=B<0?r.slice(B)[0]:r[B],J=e[M],G=nt.fromOrdinal(I.yearordinal+P),_=nt.combine(G,J);tt(N,_)||N.push(_)}catch(t){}}for(nt.sort(N),E=0;E<N.length;E++){if(_=N[E],F&&F<_)return this._len=D,t.getValue();if(p<=_){if(++D,!t.accept(_))return t.getValue();if(V&&!--V)return this._len=D,t.getValue()}}}else for(E=l;E<c;E++)if(null!==(P=d[E]))for(G=nt.fromOrdinal(I.yearordinal+P),a=0;a<e.length;a++){if(J=e[a],_=nt.combine(G,J),F&&F<_)return this._len=D,t.getValue();if(p<=_){if(++D,!t.accept(_))return t.getValue();if(V&&!--V)return this._len=D,t.getValue()}}if(u=!1,k===et.YEARLY){if((m+=C)>nt.MAXYEAR)return this._len=D,t.getValue();I.rebuild(m,f)}else if(k===et.MONTHLY){if(12<(f+=C)&&(m+=o=Math.floor(f/12),0===(f=s=K(f,12))&&(f=12,--m),m>nt.MAXYEAR))return this._len=D,t.getValue();I.rebuild(m,f)}else if(k===et.WEEKLY)g+=w<$?7*C-(w+1+(6-$)):7*C-(w-$),w=$,u=!0;else if(k===et.DAILY)g+=C,u=!0;else if(k===et.HOURLY){for(h&&(b+=Math.floor((23-b)/C)*C);;)if(o=(i=Q(b+=C,24)).div,s=i.mod,o&&(b=s,g+=o,u=!0),!X(A)||tt(A,b))break;e=n.call(I,b,y,v)}else if(k===et.MINUTELY){for(h&&(y+=Math.floor((1439-(60*b+y))/C)*C);;)if(o=(i=Q(y+=C,60)).div,s=i.mod,o&&(y=s,o=(i=Q(b+=o,24)).div,s=i.mod,o&&(b=s,g+=o,h=!(u=!0))),(!X(A)||tt(A,b))&&(!X(S)||tt(S,y)))break;e=n.call(I,b,y,v)}else if(k===et.SECONDLY){for(h&&(v+=Math.floor((86399-(3600*b+60*y+v))/C)*C);;)if(o=(i=Q(v+=C,60)).div,s=i.mod,o&&(v=s,o=(i=Q(y+=o,60)).div,s=i.mod,o&&(y=s,o=(i=Q(b+=o,24)).div,s=i.mod,o&&(b=s,g+=o,u=!0))),(!X(A)||tt(A,b))&&(!X(S)||tt(S,y))&&(!X(W)||tt(W,v)))break;e=n.call(I,b,y,v)}if(u&&28<g){var Z=nt.monthRange(m,f-1)[1];if(Z<g){for(;Z<g;){if(g-=Z,13===++f&&(f=1,++m>nt.MAXYEAR))return this._len=D,t.getValue();Z=nt.monthRange(m,f-1)[1]}I.rebuild(m,f)}}}}},et.parseString=function(t){if(!(t=t.replace(/^\s+|\s+$/,"")).length)return null;for(var e,n,a,i,o=t.split(";"),s={},r=0;r<o.length;r++)switch(n=(i=o[r].split("="))[0],a=i[1],n){case"FREQ":s.freq=et[a];break;case"WKST":s.wkst=et[a];break;case"COUNT":case"INTERVAL":case"BYSETPOS":case"BYMONTH":case"BYMONTHDAY":case"BYYEARDAY":case"BYWEEKNO":case"BYHOUR":case"BYMINUTE":case"BYSECOND":if(-1!==a.indexOf(","))for(a=a.split(","),e=0;e<a.length;e++)/^[+-]?\d+$/.test(a[e])&&(a[e]=Number(a[e]));else/^[+-]?\d+$/.test(a)&&(a=Number(a));s[n=n.toLowerCase()]=a;break;case"BYDAY":var d,l,c,u=a.split(",");for(s.byweekday=[],e=0;e<u.length;e++)2===(c=u[e]).length?s.byweekday.push(l=et[c]):(c=c.match(/^([+-]?\d)([A-Z]{2})$/),d=Number(c[1]),l=c[2],l=et[l].weekday,s.byweekday.push(new v(l,d)));break;case"DTSTART":s.dtstart=nt.untilStringToDate(a);break;case"UNTIL":s.until=nt.untilStringToDate(a);break;case"BYEASTER":s.byeaster=Number(a);break;default:throw new Error("Unknown RRULE property '"+n+"'")}return s},et.fromString=function(t){return new et(et.parseString(t))},function(t){this.rrule=t,this.lastyear=null,this.lastmonth=null,this.yearlen=null,this.nextyearlen=null,this.yearordinal=null,this.yearweekday=null,this.mmask=null,this.mrange=null,this.mdaymask=null,this.nmdaymask=null,this.wdaymask=null,this.wnomask=null,this.nwdaymask=null,this.eastermask=null}),r=(at.prototype.easter=function(t,e){e=e||0;var n=t%19,a=Math.floor(t/100),i=t%100,o=Math.floor(a/4),s=a%4,r=Math.floor((a+8)/25),r=Math.floor((a-r+1)/3),a=Math.floor(19*n+a-o-r+15)%30,o=Math.floor(i/4),r=Math.floor(32+2*s+2*o-a-i%4)%7,s=Math.floor((n+11*a+22*r)/451),o=Math.floor((a+r-7*s+114)/31),i=Date.UTC(t,o-1,(a+r-7*s+114)%31+1+e),n=Date.UTC(t,0,1);return[Math.ceil((i-n)/864e5)]},at.prototype.rebuild=function(t,e){var n=this.rrule;if(t!==this.lastyear){this.yearlen=nt.isLeapYear(t)?366:365,this.nextyearlen=nt.isLeapYear(t+1)?366:365;var a=new Date(t,0,1),i=(this.yearordinal=nt.toOrdinal(a),this.yearweekday=nt.getWeekday(a),nt.getWeekday(new Date(t,0,1)));if(365===this.yearlen?(this.mmask=[].concat(k),this.mdaymask=[].concat(x),this.nmdaymask=[].concat(S),this.wdaymask=D.slice(i),this.mrange=[].concat(T)):(this.mmask=[].concat(C),this.mdaymask=[].concat($),this.nmdaymask=[].concat(A),this.wdaymask=D.slice(i),this.mrange=[].concat(I)),X(n.options.byweekno)){this.wnomask=y(0,this.yearlen+7),a=4<=(o=s=K(7-this.yearweekday+n.options.wkst,7))?(o=0,this.yearlen+K(this.yearweekday-n.options.wkst,7)):this.yearlen-o;for(var o,s,r,d,l,c=Math.floor(a/7),a=K(a,7),u=Math.floor(c+a/4),h=0;h<n.options.byweekno.length;h++)if((r=n.options.byweekno[h])<0&&(r+=u+1),0<r&&r<=u){1<r?(d=o+7*(r-1),o!==s&&(d-=7-s)):d=o;for(var p=0;p<7&&(this.wnomask[d]=1,d++,this.wdaymask[d]!==n.options.wkst);p++);}if(tt(n.options.byweekno,1)&&(d=o+7*u,o!==s&&(d-=7-s),d<this.yearlen))for(h=0;h<7&&(d+=this.wnomask[d]=1,this.wdaymask[d]!==n.options.wkst);h++);if(o)if(a=tt(n.options.byweekno,-1)?-1:(c=nt.getWeekday(new Date(t-1,0,1)),a=K(7-c+n.options.wkst,7),l=nt.isLeapYear(t-1)?366:365,4<=a?Math.floor(52+K(l+K(c-n.options.wkst,7),7)/4):Math.floor(52+K(this.yearlen-o,7)/4)),tt(n.options.byweekno,a))for(d=0;d<o;d++)this.wnomask[d]=1}else this.wnomask=null}if(X(n.options.bynweekday)&&(e!==this.lastmonth||t!==this.lastyear)){var m=[];if(n.options.freq===et.YEARLY)if(X(n.options.bymonth))for(h=0;h<n.options.bymonth.length;h++)e=n.options.bymonth[h],m.push(this.mrange.slice(e-1,e+1));else m=[[0,this.yearlen]];else n.options.freq===et.MONTHLY&&(m=[this.mrange.slice(e-1,e+1)]);if(X(m))for(this.nwdaymask=y(0,this.yearlen),h=0;h<m.length;h++){var f=m[h],g=f[0],b=f[1];for(--b,p=0;p<n.options.bynweekday.length;p++)i=n.options.bynweekday[p][0],(r=n.options.bynweekday[p][1])<0?(d=b+7*(r+1),d-=K(this.wdaymask[d]-i,7)):(d=g+7*(r-1),d+=K(7-this.wdaymask[d]+i,7)),g<=d&&d<=b&&(this.nwdaymask[d]=1)}this.lastyear=t,this.lastmonth=e}null!==n.options.byeaster&&(this.eastermask=this.easter(t,n.options.byeaster))},at.prototype.ydayset=function(t,e,n){return[a(this.yearlen),0,this.yearlen]},at.prototype.mdayset=function(t,e,n){for(var a=y(null,this.yearlen),i=this.mrange[e-1],o=this.mrange[e],s=i;s<o;s++)a[s]=s;return[a,i,o]},at.prototype.wdayset=function(t,e,n){for(var a=y(null,this.yearlen+7),i=nt.toOrdinal(new Date(t,e-1,n))-this.yearordinal,t=i,o=0;o<7&&(a[i]=i,this.wdaymask[++i]!==this.rrule.options.wkst);o++);return[a,t,i]},at.prototype.ddayset=function(t,e,n){var a=y(null,this.yearlen),t=nt.toOrdinal(new Date(t,e-1,n))-this.yearordinal;return a[t]=t,[a,t,1+t]},at.prototype.htimeset=function(t,e,n,a){for(var i=[],o=this.rrule,s=0;s<o.options.byminute.length;s++){e=o.options.byminute[s];for(var r=0;r<o.options.bysecond.length;r++)n=o.options.bysecond[r],i.push(new nt.Time(t,e,n,a))}return nt.sort(i),i},at.prototype.mtimeset=function(t,e,n,a){for(var i=[],o=this.rrule,s=0;s<o.options.bysecond.length;s++)n=o.options.bysecond[s],i.push(new nt.Time(t,e,n,a));return nt.sort(i),i},at.prototype.stimeset=function(t,e,n,a){return[new nt.Time(t,e,n,a)]},function(t,e){this.init(t,e)}),d=(r.prototype={constructor:r,init:function(t,e){this.method=t,this.args=e,this.minDate=null,this.maxDate=null,this._result=[],"between"===t?(this.maxDate=e.inc?e.before:new Date(e.before.getTime()-1),this.minDate=e.inc?e.after:new Date(e.after.getTime()+1)):"before"===t?this.maxDate=e.inc?e.dt:new Date(e.dt.getTime()-1):"after"===t&&(this.minDate=e.inc?e.dt:new Date(e.dt.getTime()+1))},accept:function(t){var e=this.minDate&&t<this.minDate,n=this.maxDate&&t>this.maxDate;if("between"===this.method){if(e)return!0;if(n)return!1}else if("before"===this.method){if(n)return!1}else if("after"===this.method)return!!e||(this.add(t),!1);return this.add(t)},add:function(t){return this._result.push(t),!0},getValue:function(){var t=this._result;switch(this.method){case"all":case"between":return t;case"before":case"after":return t.length?t[t.length-1]:null}},clone:function(){return new r(this.method,this.args)}},function(t,e,n){if(!tt(["all","between"],t))throw new Error('Invalid method "'+t+'". Only all and between works with iterator.');this.add=function(t){return!!n(t,this._result.length)&&(this._result.push(t),!0)},this.init(t,e)}),l=(d.prototype=r.prototype,w.prototype={constructor:w,rrule:function(t){if(!(t instanceof et))throw new TypeError(String(t)+" is not RRule instance");tt(this._rrule.map(String),String(t))||this._rrule.push(t)},rdate:function(t){if(!(t instanceof Date))throw new TypeError(String(t)+" is not Date instance");tt(this._rdate.map(Number),Number(t))||(this._rdate.push(t),nt.sort(this._rdate))},exrule:function(t){if(!(t instanceof et))throw new TypeError(String(t)+" is not RRule instance");tt(this._exrule.map(String),String(t))||this._exrule.push(t)},exdate:function(t){if(!(t instanceof Date))throw new TypeError(String(t)+" is not Date instance");tt(this._exdate.map(Number),Number(t))||(this._exdate.push(t),nt.sort(this._exdate))},valueOf:function(){var e=[];return this._rrule.length&&this._rrule.forEach(function(t){e.push("RRULE:"+t)}),this._rdate.length&&e.push("RDATE:"+this._rdate.map(function(t){return nt.timeToUntilString(t)}).join(",")),this._exrule.length&&this._exrule.forEach(function(t){e.push("EXRULE:"+t)}),this._exdate.length&&e.push("EXDATE:"+this._exdate.map(function(t){return nt.timeToUntilString(t)}).join(",")),e},toString:function(){return JSON.stringify(this.valueOf())},_iter:function(e){var a={},t=this._exrule,n=e.accept;function i(e,n){t.forEach(function(t){t.between(e,n,!0).forEach(function(t){a[Number(t)]=!0})})}this._exdate.forEach(function(t){a[Number(t)]=!0}),e.accept=function(t){var e=Number(t);return!(!a[e]&&(i(new Date(e-1),new Date(e+1)),!a[e]))||(a[e]=!0,n.call(this,t))},"between"===e.method&&(i(e.args.after,e.args.before),e.accept=function(t){var e=Number(t);return!!a[e]||(a[e]=!0,n.call(this,t))});for(var o=0;o<this._rdate.length&&e.accept(new Date(this._rdate[o]));o++);this._rrule.forEach(function(t){t._iter(e)});var s=e._result;switch(nt.sort(s),e.method){case"all":case"between":return s;case"before":return s.length&&s[s.length-1]||null;case"after":return s.length&&s[0]||null;default:return null}},clone:function(){for(var t=new w(!!this._cache),e=0;e<this._rrule.length;e++)t.rrule(this._rrule[e].clone());for(e=0;e<this._rdate.length;e++)t.rdate(new Date(this._rdate[e]));for(e=0;e<this._exrule.length;e++)t.exrule(this._exrule[e].clone());for(e=0;e<this._exdate.length;e++)t.exdate(new Date(this._exdate[e]));return t}},["all","between","before","after","count","_cacheAdd","_cacheGet"].forEach(function(t){w.prototype[t]=et.prototype[t]}),h.DEFAULT_OPTIONS={dtstart:null,cache:!1,unfold:!1,forceset:!1,compatible:!1,ignoretz:!1,tzinfos:null},h._freq_map={YEARLY:et.YEARLY,MONTHLY:et.MONTHLY,WEEKLY:et.WEEKLY,DAILY:et.DAILY,HOURLY:et.HOURLY,MINUTELY:et.MINUTELY,SECONDLY:et.SECONDLY},h._weekday_map={MO:0,TU:1,WE:2,TH:3,FR:4,SA:5,SU:6},(h.prototype={constructor:h,_handle_int:function(t,e,n,a){t[e.toLowerCase()]=parseInt(n,10)},_handle_int_list:function(t,e,n,a){t[e.toLowerCase()]=n.split(",").map(function(t){return parseInt(t,10)})},_handle_FREQ:function(t,e,n,a){t.freq=h._freq_map[n]},_handle_UNTIL:function(t,e,n,a){try{t.until=nt.untilStringToDate(n)}catch(t){throw new Error("invalid until date")}},_handle_WKST:function(t,e,n,a){t.wkst=h._weekday_map[n]},_handle_BYWEEKDAY:function(t,e,n,a){for(var i,o,s,r,d=[],l=n.split(","),c=0;c<l.length;c++){if(-1<(r=l[c]).indexOf("("))s=(o=r.split("("))[0],o=parseInt(o.slice(1,-1),10);else{for(i=0;i<r.length&&-1!=="+-0123456789".indexOf(r[i]);i++);o=r.slice(0,i)||null,s=r.slice(i),o=o&&parseInt(o,10)}var u=new v(h._weekday_map[s],o);d.push(u)}t.byweekday=d},_parseRfcRRule:function(t,e){var n,a,i;if((e=e||{}).dtstart=e.dtstart||null,e.cache=e.cache||!1,e.ignoretz=e.ignoretz||!1,e.tzinfos=e.tzinfos||null,-1!==t.indexOf(":")){if(n=(i=t.split(":"))[0],a=i[1],"RRULE"!==n)throw new Error("unknown parameter name")}else a=t;for(var o={},s=a.split(";"),r=0;r<s.length;r++){n=(i=s[r].split("="))[0].toUpperCase(),a=i[1].toUpperCase();try{this["_handle_"+n](o,n,a,{ignoretz:e.ignoretz,tzinfos:e.tzinfos})}catch(t){throw new Error("unknown parameter '"+n+"':"+a)}}return o.dtstart=o.dtstart||e.dtstart,new et(o,!e.cache)},_parseRfc:function(t,e){if(e.compatible&&(e.forceset=!0,e.unfold=!0),!(t=t&&t.toUpperCase().trim()))throw new Error("Invalid empty string");var n,a,i=0;if(e.unfold)for(a=t.split("\n");i<a.length;)(n=a[i]=a[i].replace(/\s+$/g,""))?0<i&&" "===n[0]?(a[i-1]+=n.slice(1),a.splice(i,1)):i+=1:a.splice(i,1);else a=t.split(/\s/);var o,s,r,d,l,c,u,h,p,m,f=[],g=[],b=[],y=[];if(e.forceset||1!==a.length||-1!==t.indexOf(":")&&0!==t.indexOf("RRULE:")){for(i=0;i<a.length;i++)if(n=a[i]){if(s=-1===n.indexOf(":")?(o="RRULE",n):(o=(s=function(t,e,n){t=t.split(e);return n?t.slice(0,n).concat([t.slice(n).join(e)]):t}(n,":",1))[0],s[1]),!(r=o.split(";")))throw new Error("empty property name");if(o=r[0],r=r.slice(1),"RRULE"===o){if((u=0)<r.length)throw d=r[u],new Error("unsupported RRULE parm: "+d);f.push(s)}else if("RDATE"===o){for(u=0;u<r.length;u++)if("VALUE=DATE-TIME"!==(d=r[u])&&"VALUE=DATE"!==d)throw new Error("unsupported RDATE parm: "+d);g.push(s)}else if("EXRULE"===o){if((u=0)<r.length)throw d=r[u],new Error("unsupported EXRULE parm: "+d);b.push(s)}else if("EXDATE"===o){for(u=0;u<r.length;u++)if("VALUE=DATE-TIME"!==(d=r[u])&&"VALUE=DATE"!==d)throw new Error("unsupported RDATE parm: "+d);y.push(s)}else{if("DTSTART"!==o)throw new Error("unsupported property: "+o);l=nt.untilStringToDate(s)}}if(e.forceset||1<f.length||g.length||b.length||y.length){for(c=new w(!e.cache),u=0;u<f.length;u++)c.rrule(this._parseRfcRRule(f[u],{dtstart:e.dtstart||l,ignoretz:e.ignoretz,tzinfos:e.tzinfos}));for(u=0;u<g.length;u++)for(p=g[u].split(","),h=0;h<p.length;h++)m=p[h],c.rdate(nt.untilStringToDate(m));for(u=0;u<b.length;u++)c.exrule(this._parseRfcRRule(b[u],{dtstart:e.dtstart||l,ignoretz:e.ignoretz,tzinfos:e.tzinfos}));for(u=0;u<y.length;u++)for(p=y[u].split(","),h=0;h<p.length;h++)m=p[h],c.exdate(nt.untilStringToDate(m));return e.campatiable&&e.dtstart&&c.rdate(l),c}return this._parseRfcRRule(f[0],{dtstart:e.dtstart||l,cache:e.cache,ignoretz:e.ignoretz,tzinfos:e.tzinfos})}return this._parseRfcRRule(a[0],{cache:e.cache,dtstart:e.dtstart,ignoretz:e.ignoretz,tzinfos:e.tzinfos})},parse:function(t,e){e=e||{};var n=[],a=Object.keys(e),i=Object.keys(h.DEFAULT_OPTIONS);if(a.forEach(function(t){tt(i,t)||n.push(t)},this),n.length)throw new Error("Invalid options: "+n.join(", "));return i.forEach(function(t){tt(a,t)||(e[t]=h.DEFAULT_OPTIONS[t])}),this._parseRfc(t,e)}})._handle_DTSTART=function(t,e,n,a){t[e.toLowerCase()]=nt.untilStringToDate(n)},h.prototype._handle_BYDAY=h.prototype._handle_BYWEEKDAY,h.prototype._handle_INTERVAL=h.prototype._handle_int,h.prototype._handle_COUNT=h.prototype._handle_int,["_handle_BYSETPOS","_handle_BYMONTH","_handle_BYMONTHDAY","_handle_BYYEARDAY","_handle_BYEASTER","_handle_BYWEEKNO","_handle_BYHOUR","_handle_BYMINUTE","_handle_BYSECOND"].forEach(function(t){h.prototype[t]=h.prototype._handle_int_list}),new h);return(et.RRule=et).RRuleSet=w,et.rrulestr=function(){return l.parse.apply(l,arguments)},et;function c(){if(!c._nlp)if(t&&t._getRRuleNLP)c._nlp=t._getRRuleNLP(et);else{if("function"!=typeof require)throw new Error("You need to include rrule/nlp.js for fromText/toText to work.");c._nlp=require("./nlp")(et)}return c._nlp}}),function(t,e){"object"==typeof module&&module.exports?module.exports=e():"function"==typeof define&&define.amd?define([],e):t._getRRuleNLP=e()}("object"==typeof window?window:this,function(){function i(t,e){return-1!==t.indexOf(e)}return function(c){function a(t,e,n){this.text="",this.language=n||h,this.gettext=e||function(t){return t},this.rrule=t,this.freq=t.options.freq,this.options=t.options,this.origOptions=t.origOptions,this.origOptions.bymonthday&&(n=[].concat(this.options.bymonthday),e=[].concat(this.options.bynmonthday),n.sort(),e.sort(),e.reverse(),this.bymonthday=n.concat(e),this.bymonthday.length||(this.bymonthday=null)),this.origOptions.byweekday?(t=this.origOptions.byweekday instanceof Array?this.origOptions.byweekday:[this.origOptions.byweekday],n=String(t),this.byweekday={allWeeks:t.filter(function(t){return!t.n}),someWeeks:t.filter(function(t){return Boolean(t.n)}),isWeekdays:-1!==n.indexOf("MO")&&-1!==n.indexOf("TU")&&-1!==n.indexOf("WE")&&-1!==n.indexOf("TH")&&-1!==n.indexOf("FR")&&-1===n.indexOf("SA")&&-1===n.indexOf("SU")},this.byweekday.allWeeks.sort(e=function(t,e){return t.weekday-e.weekday}),this.byweekday.someWeeks.sort(e),this.byweekday.allWeeks.length||(this.byweekday.allWeeks=null),this.byweekday.someWeeks.length||(this.byweekday.someWeeks=null)):this.byweekday=null}function n(t,e){var o={},s=new u((e||h).tokens);return s.start(t)?(function(){var t,e,n;s.expect("every"),(t=s.accept("number"))&&(o.interval=parseInt(t[0],10));if(s.isDone())throw new Error("Unexpected end");switch(s.symbol){case"day(s)":o.freq=c.DAILY,s.nextSymbol()&&(!function(){var t;if(s.accept("at"))do{if(!(t=s.accept("number")))throw new Error("Unexpected symbol "+s.symbol+", expected hour");for(o.byhour=[t[0]];s.accept("comma");){if(!(t=s.accept("number")))throw new Error("Unexpected symbol "+s.symbol+"; expected hour");o.byhour.push(t[0])}}while(s.accept("comma")||s.accept("at"))}(),i());break;case"weekday(s)":o.freq=c.WEEKLY,o.byweekday=[c.MO,c.TU,c.WE,c.TH,c.FR],s.nextSymbol(),i();break;case"week(s)":o.freq=c.WEEKLY,s.nextSymbol()&&(a(),i());break;case"hour(s)":o.freq=c.HOURLY,s.nextSymbol()&&(a(),i());break;case"minute(s)":o.freq=c.MINUTELY,s.nextSymbol()&&(a(),i());break;case"month(s)":o.freq=c.MONTHLY,s.nextSymbol()&&(a(),i());break;case"year(s)":o.freq=c.YEARLY,s.nextSymbol()&&(a(),i());break;case"monday":case"tuesday":case"wednesday":case"thursday":case"friday":case"saturday":case"sunday":if(o.freq=c.WEEKLY,o.byweekday=[c[s.symbol.substr(0,2).toUpperCase()]],!s.nextSymbol())return;for(;s.accept("comma");){if(s.isDone())throw new Error("Unexpected end");if(!(e=d()))throw new Error("Unexpected symbol "+s.symbol+", expected weekday");o.byweekday.push(c[e]),s.nextSymbol()}!function(){var t;if(s.accept("on"),s.accept("the"),t=l())for(o.bymonthday=[t],s.nextSymbol();s.accept("comma");){if(!(t=l()))throw new Error("Unexpected symbol "+s.symbol+"; expected monthday");o.bymonthday.push(t),s.nextSymbol()}}(),i();break;case"january":case"february":case"march":case"april":case"may":case"june":case"july":case"august":case"september":case"october":case"november":case"december":if(o.freq=c.YEARLY,o.bymonth=[r()],!s.nextSymbol())return;for(;s.accept("comma");){if(s.isDone())throw new Error("Unexpected end");if(!(n=r()))throw new Error("Unexpected symbol "+s.symbol+", expected month");o.bymonth.push(n),s.nextSymbol()}a(),i();break;default:throw new Error("Unknown symbol")}}(),o):null;function a(){var t,e,n,a=s.accept("on"),i=s.accept("the");if(a||i)do{if(e=l())(t=d())?(s.nextSymbol(),o.byweekday||(o.byweekday=[]),o.byweekday.push(c[t].nth(e))):(o.bymonthday||(o.bymonthday=[]),o.bymonthday.push(e),s.accept("day(s)"));else if(t=d())s.nextSymbol(),o.byweekday||(o.byweekday=[]),o.byweekday.push(c[t]);else if("weekday(s)"===s.symbol)s.nextSymbol(),o.byweekday||(o.byweekday=[]),o.byweekday.push(c.MO),o.byweekday.push(c.TU),o.byweekday.push(c.WE),o.byweekday.push(c.TH),o.byweekday.push(c.FR);else if("week(s)"===s.symbol){if(s.nextSymbol(),!(n=s.accept("number")))throw new Error("Unexpected symbol "+s.symbol+", expected week number");for(o.byweekno=[n[0]];s.accept("comma");){if(!(n=s.accept("number")))throw new Error("Unexpected symbol "+s.symbol+"; expected monthday");o.byweekno.push(n[0])}}else{if(!(e=r()))return;s.nextSymbol(),o.bymonth||(o.bymonth=[]),o.bymonth.push(e)}}while(s.accept("comma")||s.accept("the")||s.accept("on"))}function r(){switch(s.symbol){case"january":return 1;case"february":return 2;case"march":return 3;case"april":return 4;case"may":return 5;case"june":return 6;case"july":return 7;case"august":return 8;case"september":return 9;case"october":return 10;case"november":return 11;case"december":return 12;default:return!1}}function d(){switch(s.symbol){case"monday":case"tuesday":case"wednesday":case"thursday":case"friday":case"saturday":case"sunday":return s.symbol.substr(0,2).toUpperCase();default:return!1}}function l(){switch(s.symbol){case"last":return s.nextSymbol(),-1;case"first":return s.nextSymbol(),1;case"second":return s.nextSymbol(),s.accept("last")?-2:2;case"third":return s.nextSymbol(),s.accept("last")?-3:3;case"nth":var t=parseInt(s.value[1],10);if(t<-366||366<t)throw new Error("Nth out of range: "+t);return s.nextSymbol(),s.accept("last")?-t:t;default:return!1}}function i(){if("until"===s.symbol){var t=Date.parse(s.text);if(!t)throw new Error("Cannot parse until date:"+s.text);o.until=new Date(t)}else s.accept("for")&&(o.count=s.value[0],s.expect("number"))}}var t=["count","until","interval","byweekday","bymonthday","bymonth"],u=((a.IMPLEMENTED=[])[c.HOURLY]=t,a.IMPLEMENTED[c.MINUTELY]=t,a.IMPLEMENTED[c.DAILY]=["byhour"].concat(t),a.IMPLEMENTED[c.WEEKLY]=t,a.IMPLEMENTED[c.MONTHLY]=t,a.IMPLEMENTED[c.YEARLY]=["byweekno","byyearday"].concat(t),a.isFullyConvertible=function(t){if(!(t.options.freq in a.IMPLEMENTED))return!1;if(t.origOptions.until&&t.origOptions.count)return!1;for(var e in t.origOptions){if(i(["dtstart","wkst","freq"],e))return!0;if(!i(a.IMPLEMENTED[t.options.freq],e))return!1}return!0},a.prototype={constructor:a,isFullyConvertible:function(){return a.isFullyConvertible(this.rrule)},toString:function(){var t,e=this.gettext;return this.options.freq in a.IMPLEMENTED?(this.text=[e("every")],this[c.FREQUENCIES[this.options.freq]](),this.options.until?(this.add(e("until")),t=this.options.until,this.add(this.language.monthNames[t.getMonth()]).add(t.getDate()+",").add(t.getFullYear())):this.options.count&&this.add(e("for")).add(this.options.count).add(this.plural(this.options.count)?e("times"):e("time")),this.isFullyConvertible()||this.add(e("(~ approximate)")),this.text.join("")):e("RRule error: Unable to fully convert this rrule to text")},HOURLY:function(){var t=this.gettext;1!==this.options.interval&&this.add(this.options.interval),this.add(this.plural(this.options.interval)?t("hours"):t("hour"))},MINUTELY:function(){var t=this.gettext;1!==this.options.interval&&this.add(this.options.interval),this.add((this.plural(this.options.interval),t("minutes")))},DAILY:function(){var t=this.gettext;1!==this.options.interval&&this.add(this.options.interval),this.byweekday&&this.byweekday.isWeekdays?this.add(this.plural(this.options.interval)?t("weekdays"):t("weekday")):this.add(this.plural(this.options.interval)?t("days"):t("day")),this.origOptions.bymonth&&(this.add(t("in")),this._bymonth()),this.bymonthday?this._bymonthday():this.byweekday?this._byweekday():this.origOptions.byhour&&this._byhour()},WEEKLY:function(){var t=this.gettext;1!==this.options.interval&&this.add(this.options.interval).add(this.plural(this.options.interval)?t("weeks"):t("week")),this.byweekday&&this.byweekday.isWeekdays?1===this.options.interval?this.add(this.plural(this.options.interval)?t("weekdays"):t("weekday")):this.add(t("on")).add(t("weekdays")):(1===this.options.interval&&this.add(t("week")),this.origOptions.bymonth&&(this.add(t("in")),this._bymonth()),this.bymonthday?this._bymonthday():this.byweekday&&this._byweekday())},MONTHLY:function(){var t=this.gettext;this.origOptions.bymonth?(1!==this.options.interval&&(this.add(this.options.interval).add(t("months")),this.plural(this.options.interval)&&this.add(t("in"))),this._bymonth()):(1!==this.options.interval&&this.add(this.options.interval),this.add(this.plural(this.options.interval)?t("months"):t("month"))),this.bymonthday?this._bymonthday():this.byweekday&&this.byweekday.isWeekdays?this.add(t("on")).add(t("weekdays")):this.byweekday&&this._byweekday()},YEARLY:function(){var t=this.gettext;this.origOptions.bymonth?(1!==this.options.interval&&(this.add(this.options.interval),this.add(t("years"))),this._bymonth()):(1!==this.options.interval&&this.add(this.options.interval),this.add(this.plural(this.options.interval)?t("years"):t("year"))),this.bymonthday?this._bymonthday():this.byweekday&&this._byweekday(),this.options.byyearday&&this.add(t("on the")).add(this.list(this.options.byyearday,this.nth,t("and"))).add(t("day")),this.options.byweekno&&this.add(t("in")).add(this.plural(this.options.byweekno.length)?t("weeks"):t("week")).add(this.list(this.options.byweekno,null,t("and")))},_bymonthday:function(){var t=this.gettext;this.byweekday&&this.byweekday.allWeeks?this.add(t("on")).add(this.list(this.byweekday.allWeeks,this.weekdaytext,t("or"))).add(t("the")).add(this.list(this.bymonthday,this.nth,t("or"))):this.add(t("on the")).add(this.list(this.bymonthday,this.nth,t("and")))},_byweekday:function(){var t=this.gettext;this.byweekday.allWeeks&&!this.byweekday.isWeekdays&&this.add(t("on")).add(this.list(this.byweekday.allWeeks,this.weekdaytext)),this.byweekday.someWeeks&&(this.byweekday.allWeeks&&this.add(t("and")),this.add(t("on the")).add(this.list(this.byweekday.someWeeks,this.weekdaytext,t("and"))))},_byhour:function(){var t=this.gettext;this.add(t("at")).add(this.list(this.origOptions.byhour,null,t("and")))},_bymonth:function(){this.add(this.list(this.options.bymonth,this.monthtext,this.gettext("and")))},nth:function(t){var e,n,a=this.gettext;if(-1===t)return a("last");switch(n=Math.abs(t)){case 1:case 21:case 31:e=n+a("st");break;case 2:case 22:e=n+a("nd");break;case 3:case 23:e=n+a("rd");break;default:e=n+a("th")}return t<0?e+" "+a("last"):e},monthtext:function(t){return this.language.monthNames[t-1]},weekdaytext:function(t){var e="number"==typeof t?t:t.getJsWeekday();return(t.n?this.nth(t.n)+" ":"")+this.language.dayNames[e]},plural:function(t){return t%100!=1},add:function(t){return this.text.push(" "),this.text.push(t),this},list:function(t,e,n,a){t instanceof Array||(t=[t]);function i(t){return e.call(o,t)}a=a||",",e=e||function(t){return t};var o=this;if(n){for(var s=t.map(i),r=a,d=n,l="",c=0;c<s.length;c++)0!==c&&(c===s.length-1?l+=" "+d+" ":l+=r+" "),l+=s[c];return l}return t.map(i).join(a+" ")}},function(t){this.rules=t}),h=(u.prototype.start=function(t){return this.text=t,this.done=!1,this.nextSymbol()},u.prototype.isDone=function(){return this.done&&null==this.symbol},u.prototype.nextSymbol=function(){var t;this.symbol=null,this.value=null;do{if(this.done)return!1;var e,n,a=null;for(n in this.rules)(e=this.rules[n].exec(this.text))&&(null==a||e[0].length>a[0].length)&&(a=e,t=n);if(null!=a&&(this.text=this.text.substr(a[0].length),""===this.text&&(this.done=!0)),null==a)return this.done=!0,this.symbol=null,void(this.value=null)}while("SKIP"===t);return this.symbol=t,this.value=a,!0},u.prototype.accept=function(t){return this.symbol===t&&(this.value?(t=this.value,this.nextSymbol(),t):(this.nextSymbol(),!0))},u.prototype.expect=function(t){if(this.accept(t))return!0;throw new Error("expected "+t+" but found "+this.symbol)},{dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],tokens:{SKIP:/^[ \r\n\t]+|^\.$/,number:/^[1-9][0-9]*/,numberAsText:/^(one|two|three)/i,every:/^every/i,"day(s)":/^days?/i,"weekday(s)":/^weekdays?/i,"week(s)":/^weeks?/i,"hour(s)":/^hours?/i,"minute(s)":/^minutes?/i,"month(s)":/^months?/i,"year(s)":/^years?/i,on:/^(on|in)/i,at:/^(at)/i,the:/^the/i,first:/^first/i,second:/^second/i,third:/^third/i,nth:/^([1-9][0-9]*)(\.|th|nd|rd|st)/i,last:/^last/i,for:/^for/i,"time(s)":/^times?/i,until:/^(un)?til/i,monday:/^mo(n(day)?)?/i,tuesday:/^tu(e(s(day)?)?)?/i,wednesday:/^we(d(n(esday)?)?)?/i,thursday:/^th(u(r(sday)?)?)?/i,friday:/^fr(i(day)?)?/i,saturday:/^sa(t(urday)?)?/i,sunday:/^su(n(day)?)?/i,january:/^jan(uary)?/i,february:/^feb(ruary)?/i,march:/^mar(ch)?/i,april:/^apr(il)?/i,may:/^may/i,june:/^june?/i,july:/^july?/i,august:/^aug(ust)?/i,september:/^sep(t(ember)?)?/i,october:/^oct(ober)?/i,november:/^nov(ember)?/i,december:/^dec(ember)?/i,comma:/^(,\s*|(and|or)\s*)+/i}});return{fromText:function(t,e){return new c(n(t,e))},parseText:n,isFullyConvertible:a.isFullyConvertible,toText:function(t,e,n){return new a(t,e,n).toString()}}}}),app.stopAjaxRequests=function(n){(n=void 0!==n&&n)?$(app.ajaxRequests).each(function(t,e){e.url==n&&e.xhr.abort()}):$(app.ajaxRequests).each(function(t,e){e.xhr.abort()}),app.ajaxRequests=[]},$(window).on("beforeunload.stopAjaxRequests",function(){app.stopAjaxRequests()}),$(document).ready(function(){0<app.notyMessages.length&&(app.notyMessages.forEach(function(t){notyMessage(t)}),app.notyMessages=[])});var msgExportDisabled="You do not have a permission to export. Please contact your company administrator.";function initExportWidget(o,t){$(t).on("click",function(t){var e=o.getRequestParams(),n=$("[data-crud-export-count]"),a=$('[data-widget="top-alert"]'),i=$('meta[name="csrf-token"]').attr("content");if(app.data.user&&app.data.user.exportDisabled)return a.warningBlock(msgExportDisabled),$(this).closest(".btn-group").removeClass("open"),!1;if(n.length&&1e6<parseInt(n.data("crud-export-count")))return notyMessage("Your exported file is too large. Please contact support to get the requested file.",{type:"warning"}),$(this).closest(".btn-group").removeClass("open"),!1;if("undefined"!=typeof itemsCount&&(500<parseInt(itemsCount)||(n=(a=o).getOptions().url,a=a.getRequestParams().cmd,void 0!==n&&void 0!==a&&"/online/messages/sent/ajax"===n&&"table"===a||"/online/account/ajax"===n&&"sentTable"===a)||(a=(n=o).getOptions().url,n=n.getRequestParams().cmd,void 0!==a&&void 0!==n&&"/online/reporting/ajax"===a&&"events"===n)))return a={last:e,exportLnk:$(this),maxExport:1e6},$.confirmDefferedExport(a),!1;delete e.page;n="?"+decodeURIComponent($.param(e));($(this).attr("href").includes("messages_sent_ajax")||$(this).attr("href").includes("contacts_ajax"))&&(n=n+"&_csrf_token="+encodeURIComponent(i)),$(this).attr("href",$(this).attr("href").replace(/\?.+/,"")+n)})}function initDateFilterWidget(){$('input:radio[name="date-filter-list"]').on("change",function(){$("#dateFilterValue").text($(this).parent().text()),"Pick date range"==this.value?$("#dateFilter").removeClass("hidden"):$("#dateFilter").addClass("hidden")}),$("#dateFilterClose").on("click",function(){$(this).parent().addClass("hidden");var t=$('input:radio[name="date-filter-list"][value="All"]').click();$("#dateFilterValue").text(t.parent().text())})}function parseErrors(t,e,n){void 0===t.data.selector?($(n).text(t.message),$(e).show()):($('<span class="help-block error">'+t.message+"</span>").insertAfter(t.data.selector),$(t.data.selector).closest(".form-group").addClass("has-error"))}function parseAllErrors(t){$.each(t,function(t,e){t="input[data-field="+t+"]:visible, textarea[data-field="+t+"]:visible, span[data-field="+t+"], div[data-field="+t+"]:visible";null!==e&&$('<span class="help-block error">'+e+"</span>").insertAfter(t),$(t).closest(".form-group").addClass("has-error")})}function spinIt(t,e){(1<t.find("table").length?t:t.find("table")).spin(e)}function hideErrors(t){$("span.error").not(".tag-item").remove(),$(".has-error").removeClass("has-error"),$(".has-success").removeClass("has-success"),$(t).hide()}function assignDeselect(e,t,n,a,i){t.find('a[data-options-deselect="'+n+'"]').off("click.textmagic").on("click.textmagic",function(t){i.deselectAllFunction(e),t.preventDefault(),optionsTableToggle(a,"uncheck"),a.data("checked",!1)})}Array.prototype.pushOnce=function(t){-1===$.inArray(t,this)&&this.push(t)},Array.prototype.popAll=function(t){for(var e=this.length-1;0<=e;e--)this[e]===t&&this.splice(e,1)},function(y){y.prepareCrudPage=function(m){var f,i,g,e,o=[],s=!1,n={},b={reloadAfterInit:!0,containerSelector:"#crud-container",itemSelector:'tr[data-crud="item"]',dateListSelector:!1,datePairSelector:!1,commandUrl:"/online/crud/ajax",paginationCommand:"table",paginationScroll:!1,paginationRecount:!1,removeCommand:"remove",updateCommand:"update",container:y(this.containerSelector),perPage:10,spin:!0,preSearchCallback:function(t){return!0},callbackRecount:function(t){var e=t.data.total,n=("function"==typeof y.fn.format&&(e=y.fn.format(e)),t.data.overlimit),n=void 0!==n&&n?"many":e,e=(g.container.find('[data-crud-count="count"]').text(n),t.data.export_total),n=(void 0!==e&&g.container.find("[data-crud-export-count]").attr("data-crud-export-count",e),g.container.find('[data-crud-max="max"]'));parseInt(n.text())>=t.data.total&&(n.text(t.data.total),g.container.find("ul.pager li.next").addClass("disabled").off("click")),buttonEnable(y("[data-options-recount]"))},removeFunction:function(t){"console"in window&&console.log("No remove function specified")},bulkRemoveFunction:function(t){"console"in window&&console.log("No bulk remove function specified")},updateFunction:function(t){"console"in window&&console.log("No update function specified")},bulkUpdateFunction:function(t){"console"in window&&console.log("No bulk update function specified")},updateCheckboxesFunction:function(t){var e=y(t).closest("tr").data("id");-1!==y.inArray(e,o)?y(t).attr("checked",!0):y(t).attr("checked",!1)},togglePager:function(){var t=y(g.containerSelector),e=t.find("ul.pager"),t=t.find(".pagin-panel select");!0===s?(e.addClass("disabled").addClass("text-muted"),t.prop("disabled","disabled")):(e.removeClass("disabled").removeClass("text-muted"),t.prop("disabled",!1))},checkboxChangeFunction:function(t){var e=y(t).closest("tr").data("id");y(t).is(":checked")?o.pushOnce(e):s?(s=!1,o=[],y(g.itemSelector).each(function(){y(this).find('input[type="checkbox"]').is(":checked")&&o.pushOnce(y(this).data("id"))})):o.popAll(e),this.togglePager()},topCheckboxChangeFunction:function(t){y(t).is(":checked")?y(g.itemSelector).each(function(){o.pushOnce(y(this).data("id"))}):(y(g.itemSelector).each(function(){o.popAll(y(this).data("id"))}),f.setCheckedAllItems(!1)),this.togglePager()},selectAllFunction:function(t){if(y('input[name="search-query"]').val())return!1;s=!0,o=[],this.togglePager()},deselectAllFunction:function(t){s=!1,o=[],this.togglePager()},afterReloadFunction:function(t){return!0},beforeReloadFunction:function(t){return!0},checkedItemsChangeFunction:function(){return!0}};function t(t){if((g=y.extend({},b,g,t)).container=y(g.containerSelector),0==g.container.length)return"console"in window&&console.log("No container found by "+g.containerSelector+", exiting"),!1;var p;!function(){if(m.commandUrl)paramsSection=m.commandUrl.replace(/\//gi,"_")+"_"+m.paginationCommand;else{if(!b.commandUrl)return"console"in window&&console.log("No section for load default params data");paramsSection=b.commandUrl.replace(/\//gi,"_")+"_"+b.paginationCommand}params=Cookies.getJSON(paramsSection),y.isPlainObject(params)&&(params.direction&&(n.direction=params.direction),params.orderBy&&(n.orderBy=params.orderBy),params.perPage&&(g.perPage=params.perPage))}(),y('[data-crud="bulk-remove"]').off("click.crud").on("click.crud",function(){g.bulkRemoveFunction(this)}),y('[data-crud="bulk-update"]').off("click.crud").on("click.crud",function(){g.bulkUpdateFunction(this)}),p=g.container,i=p.widgetPagination({page:1,perPage:g.perPage,requestParams:y.extend({},n,{cmd:g.paginationCommand}),scroll:g.paginationScroll,recount:g.paginationRecount,callbackRecount:g.callbackRecount,callbackReloadBefore:function(t,e){g.beforeReloadFunction(t),g.spin&&spinIt(p,"enable")},callbackReloadSuccess:function(a){var n=p.find("table"),i=(n.find('input[type="checkbox"]').each(function(){null!=y(this).closest("tr").data("id")&&g.updateCheckboxesFunction(this)}),n.attr("id")),o=n.find('tbody input[type="checkbox"]').not(":disabled"),s=o.filter(":checked").length,r=o.length,d=n.find('thead input[type="checkbox"]'),l=y('[data-options-table="'+i+'"]'),t=y('[data-options-empty-table="'+i+'"]'),c=y('[data-options-count="'+i+'"]'),e=n.find("tbody > tr[data-widget]").length,u=n.find("span.select-all"),h={All:"",items:"item",are:"is"};optionsTableButtons(t,e),optionsTableCheck(o),optionsTableCount(f,n,d,l,c,s,r),n.find('input[type="checkbox"]').off("change.crudapi").on("change.crudapi",function(){var t,e;null!=y(this).closest("tr").data("id")&&(g.checkboxChangeFunction(this),t=y('[data-options-select="'+i+'"]'),e=parseInt(t.find("span.value").text().replace(/\D/g,""),10),this.checked?s+=1:--s,f.getCheckedItems().length===e?(t.click(),1===e&&(rewriteSpanHtml(u,h),assignDeselect(this,p,i,n,g))):(optionsTableCheck(y(this)),optionsTableCount(f,n,d,l,c,s,r)))}),n.find('thead input[type="checkbox"]').on("change",function(){g.topCheckboxChangeFunction(this);var t=y('[data-options-select="'+i+'"]'),e=parseInt(t.find("span.value").text().replace(/\D/g,""),10);s=0,this.checked?(o.prop("checked",!0),s=o.length):o.prop("checked",!1),optionsTableCheck(o),optionsTableCount(f,n,y(this),l,c,s,r),f.getCheckedItems().length===e&&(t.click(),this.checked=!0,1===e&&(rewriteSpanHtml(u,h),assignDeselect(this,p,i,n,g)))}),p.find('a[data-crud="remove"]').on("click",function(){g.removeFunction(this)}),p.find('a[data-crud="update"]').on("click",function(){g.updateFunction(this)}),p.find('a[data-options-select="'+i+'"]').off("click.textmagic").on("click.textmagic",function(t){g.selectAllFunction(this),t.preventDefault(),optionsTableToggle(n,"check"),n.data("checked","all"),y(this).closest(l).addClass("selected")}),assignDeselect(this,p,i,n,g),p.find("th[data-field]").on("click.crudSort",function(t){t.preventDefault();var t=y(this).data("field"),e="asc",n=(t==a.getOptions().requestParams.orderBy&&(e=y(this).hasClass("headerSortUp")?"desc":"asc"),a.getOptions().requestParams.params);a.setOptions({requestParams:{cmd:g.paginationCommand,orderBy:t,direction:e,params:n}}).setRequestParams({}).reload()}),g.spin&&spinIt(p,"disable"),appendNoResults(n),function(t){if(m.commandUrl)paramsSection=m.commandUrl.replace(/\//gi,"_")+"_"+m.paginationCommand;else{if(!b.commandUrl)return"console"in window&&console.log("No section for save default params data");paramsSection=b.commandUrl.replace(/\//gi,"_")+"_"+b.paginationCommand}params={direction:t.requestParams.direction,orderBy:t.requestParams.orderBy,perPage:t.perPage},Cookies.set(paramsSection,params,{expires:365})}(a.getOptions()),g.afterReloadFunction(),syncOptionsTableButtons()},callbackReloadError:function(t,e){g.spin&&spinIt(p,"disable"),g.afterReloadFunction(t,e)}},function(t){initSearchWidget(e,t,g.searchFormSelector,g.dateListSelector,g.datePairSelector,g.searchAfterInit,g.preSearchCallback),g.dontInitExport||initExportWidget(t,"a.export-lnk"),initDateFilterWidget()}),g.reloadAfterInit&&i.reload()}return t(m),f={getPaginationApi:function(){return i},getOptions:function(){return g},setOptions:t,disableSpin:function(){g.spin=!1},enableSpin:function(){g.spin=!0},getCheckedItems:function(){return o},setCheckedItems:function(t){return o=[],this.addCheckedItems(t),g.checkedItemsChangeFunction(),this.getCheckedItems()},addCheckedItems:function(t){for(var e=0;e<t.length;e++)o.pushOnce(t[e]);return g.checkedItemsChangeFunction(),this.getCheckedItems()},removeCheckedItems:function(t){for(var e=0;e<t.length;e++)o.popAll(t[e]);return g.checkedItemsChangeFunction(),this.getCheckedItems()},getCheckedAllItems:function(){return s},setCheckedAllItems:function(t){return s=t,g.checkedItemsChangeFunction(),this.getCheckedAllItems()},post:function(t,e){y.post(g.commandUrl,t).done(function(t){return e&&e(t),t}).fail(function(){return!1})},removeItems:function(t,e){t={cmd:g.removeCommand,ids:t,params:i.getRequestParams().params};s=!(o=[]),e?this.post(t,e):y.when(this.post(t)).then(i.reload())},updateItems:function(t,e,n,a){t={cmd:g.updateCommand,ids:t,field:e,value:n};s=!(o=[]),a?this.post(t,a):y.when(this.post(t)).then(i.reload())}}},y.simpleEmailValidate=function(t){return/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(t)},y.confirmDefferedExport=function(r){var t=Math.floor(1e6*Math.random()),r=y.extend({},{title:"Send the download link to an email",message:"Export of data can take some time. Please enter email address, and we will send a download link as soon as possible."},r),d=y('meta[name="csrf-token"]').attr("content"),e=['<div id="defferedExportModal_'+t+'" class="modal modal-sm fade" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="false">','<div class="modal-dialog">','<div class="modal-content">','<div class="modal-body text-center">',"<h2>"+r.title+"</h2>","<p>"+r.message+"</p>",'<div class="form-group">','<input class="form-control" type="text" name="export_email"/>',"</div>",'<p class="confirmModalButtons">','<button class="btn btn-default" type="button" data-dismiss="modal" data-crud="export-cancel">Cancel</button>','<button class="btn btn-success btn-solid disabled" type="button" data-crud="send-export">Send</button>',"</p>","</div>","</div>","</div>","</div>"].join(""),l=(y(e).hide().appendTo("body").modal("show"),y("#defferedExportModal_"+t)),n=y('button[data-crud="send-export"]'),e=(n.btn("disable"),void 0!==app.u_email?app.u_email:"");l.find('input[name="export_email"]').val(e).focus(),l.find('button[data-crud="send-export"]').on("click",function(){var e=this,t=r.last,n=r.exportLnk,a=l.find('input[name="export_email"]').val(),i=y("[data-crud-export-count]"),o=y('[data-widget="top-alert"]'),s=y('[data-crud="export-cancel"]');if(app.data.user&&app.data.user.exportDisabled)return o.warningBlock(msgExportDisabled),l.modal("hide"),!1;if(i.length&&parseInt(i.attr("data-crud-export-count"))>r.maxExport)return o.warningBlock("Your exported file is too large. Please contact support to get the requested file."),l.modal("hide"),!1;t.defExport=!0,t.exportEmail=encodeURIComponent(a),delete t.page;i=decodeURIComponent(y.param(t)),a=n.attr("href"),t=0<a.indexOf("?")?"&":"?";((a=a+t+i).includes("messages_sent_ajax")||a.includes("contacts_ajax"))&&(a=a+"&_csrf_token="+encodeURIComponent(d)),y.ajax({beforeSend:function(){s.prop("disabled",!0),y(e).spin("enable","Sending...")},method:"GET",url:a,success:function(t){y(e).spin("disable"),s.prop("disabled",!1),l.modal("hide"),o.successBlock("Your data is now being prepared for download. We will send a download link to your email address as soon as possible.")},error:function(t){y(e).spin("disable"),s.prop("disabled",!1),l.modal("hide"),o.warningBlock("Sorry, but it looks like something has gone wrong. Please try again or contact us at support@textmagic.com.")}})}),l.find('input[name="export_email"]').on("input change click keyup blur focus",function(){var t=y(this).val();y.simpleEmailValidate(t)?n.btn("enable"):n.btn("disable")})},y.confirmDeleteAll=function(e){var t=Math.floor(1e6*Math.random()),n={title:"Delete all items",message:"To delete all items, please enter "+this.confirmText+" here",confirmText:"DELETE MY ITEMS",deleteButtonText:"Delete",cancelButtonText:"Cancel",deleteButtonCallback:function(){},cancelButtonCallback:function(){}},n=['<div id="confirmAllModal_'+t+'" class="modal modal-sm fade" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="false">','<div class="modal-dialog">','<div class="modal-content">','<div class="modal-body text-center">',"<h2>"+(e=y.extend({},n,e)).title+"</h2>","<p>"+e.message+"</p>",'<p class="confirmModalButtons">','<button class="btn btn-default" type="button" data-dismiss="modal" data-crud="cancel">'+e.cancelButtonText+"</button>",'<button class="btn btn-danger disabled" type="button" data-crud="remove-all-items">'+e.deleteButtonText+"</button>","</p>","</div>","</div>","</div>","</div>"].join(""),a=(y(n).hide().appendTo("body").modal("show"),y("#confirmAllModal_"+t));a.find('button[data-crud="remove-all-items"]').on("click.confirmDeleteAll",function(t){t.preventDefault(),y(this).spin("enable"),y(this).siblings("[data-dismiss]").btn("disable"),e.deleteButtonCallback(),void 0===e.preventModalHide&&(a.modal("hide"),a.remove())}),a.find('button[data-crud="cancel"]').on("click.confirmDeleteAll",function(t){t.preventDefault(),e.cancelButtonCallback(),a.modal("hide"),a.remove()})},y.confirmInp=function(e){var t,n={title:"Do action",message:"Are you sure you would like to do this action?",yesButtonText:"Do action",cancelButtonText:"Cancel",modalId:"confirmWithInput_"+Math.floor(1e6*Math.random()),inp_name:null,inp_placeholder:null,yesButtonCallback:function(){},cancelButtonCallback:function(){}},n=((e=y.extend({},n,e)).inp_name&&(t='<div class="form-group"><input class="form-control" type="text" name="'+e.inp_name+'" placeholder="'+e.inp_placeholder+'" /></div>'),['<div id="'+e.modalId+'" class="modal modal-sm fade" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="false">','<div class="modal-dialog">','<div class="modal-content">','<div class="modal-body text-center">',"<h2>"+e.title+"</h2>","<p>"+e.message+"</p>",'<div class="form-group">','<input class="form-control" type="text" name="confirmation_text" placeholder="Enter password" autocomplete="off"/>',"</div>",t,'<p class="confirmModalButtons">','<button class="btn btn-default" type="button" data-dismiss="modal" data-crud="confirm-cancel-btn">'+e.cancelButtonText+"</button>",'<button class="btn btn-danger" type="button" data-crud="confirm-yes-btn">'+e.yesButtonText+"</button>","</p>","</div>","</div>","</div>","</div>"].join("")),a=(y(n).hide().appendTo("body").modal("show"),y("#"+e.modalId));a.find('button[data-crud="confirm-yes-btn"]').on("click",function(t){t.preventDefault(),y(this).spin("enable","Processing..."),y(this).siblings("[data-dismiss]").btn("disable"),e.yesButtonCallback(),void 0===e.preventModalHide&&(a.modal("hide"),a.remove())}),a.find('button[data-crud="confirm-cancel-btn"]').on("click",function(t){t.preventDefault(),e.cancelButtonCallback(),a.modal("hide"),a.remove()})}}(jQuery),function(f){f.fn.recipientsTag=function(t){var i,o=new Array,e={recipients:new Array,minLength:5,maxLength:15,classTag:"tag-item",classTagBlock:"tag-block",$counter:"",country:"ZZ",contactEdit:!0,callbackChanged:function(){},callbackAdd:function(){},callbackRemove:function(){},callbackReady:function(t){}},s=f.extend({},e,t),r=this,n="undefined"!=typeof AHServiceContainer?AHServiceContainer.get("Textmagic::FrameworkBundle::Entity")("Textmagic::ModalBundle::ContactForm"):null,d=i18n.phonenumbers.PhoneNumberUtil.getInstance();if(1==r.length)return i={removeRecipient:function(t){var e=(t=checkJquery(t)).data("contact");e&&a(e)&&t.remove()},getOptions:function(){return s},getRecipients:function(){return o},addContact:h,getContacts:function(){var n=new Array;return f.each(o,function(t,e){void 0!==e.contactId&&n.push(e.contactId)}),n},getGroups:function(){var n=new Array;return f.each(o,function(t,e){void 0!==e.groupId&&n.push(e.groupId)}),n},getPhones:function(){var n=new Array;return f.each(o,function(t,e){null==e.groupId&&null==e.contactId&&void 0!==e.phone&&n.push(e.phone)}),n},removeTagBySelector:function(t){f(t).each(function(t,e){u(f(e),!0)})}},r.addClass(s.classTagBlock),r.find("."+s.classTag).each(function(t,e){var n;n=e,e=(n=checkJquery(e)).data("contact"),n.remove(),e&&h(e)}),r.parent().click(function(){r.trigger("focus")}),app.isIE()&&app.isIE()<10||r.off(),r.on("keydown.tag",function(t){return r.closest(".form-group").removeClass("has-error").find("span.error").remove(),8!=t.keyCode&&46!=t.keyCode||""!=r.val()?188==t.keyCode&&""!=r.val()?(p(r),!1):void 0:(u(f(r).prev("."+s.classTag)),!1)}).on({"focus.tag":function(){r.parent().addClass("focus")},"blur.tag":function(){r.parent().removeClass("focus"),0<f(r).val().length&&p(r)},"paste.tag":function(){0<f(r).val().length&&p(r)}}),"function"==typeof r.autocomplete&&(!1===app.isIE()||9<app.isIE())&&(r.autocomplete({source:function(t,e){jQuery.ajax({method:"GET",url:"/api/v2/contacts/autocomplete",data:{limit:10,query:t.term,lists:1},dataType:"json",headers:{"X-TM-Username":app.data.user.login,"X-TM-Key":app.data.user.api_key},cache:!1,success:function(t){e(t)}})},select:function(t,e){var n={};switch(e.item.entityType){case"contact":n={phone:e.item.value,contactId:e.item.entityId,name:e.item.label};break;case"reply":n={phone:e.item.value};break;case"list":n={count:e.item.label,groupId:e.item.entityId,name:e.item.value}}return h(n),f(r).val(""),!1},delay:100}).data("ui-autocomplete")._renderItem=function(t,e){var n="",a="";switch(e.entityType){case"contact":n=e.label,a="+"+e.value;break;case"reply":n="+"+e.label,a=e.countryName;break;case"list":n=e.value,a=e.label+" contact"+(1!==parseInt(e.label,10)?"s":"")}var i=getAvatarClass(a,n,e.avatar,e.entityType,e.favorited),o=getAvatarLabel(a,n,e.avatar,e.entityType),s="";return e.avatar&&(s="background-image: url(/"+e.avatar+")"),f("<li>").append('<a class="chat-contact-item clearfix"><i class="'+i+'" style="'+s+'">'+o+"</i>"+(e.sharedBy?'<div class="pull-right text-muted shared-by">Shared by '+e.sharedBy+"</div>":"")+'<div class="name">'+highlight(n,this.term)+'</div><div class="last-message">'+highlight(a,this.term)+"</div></a>").appendTo(t)}),f(document).on("click","span.tag-item",function(t){t.preventDefault();var a=f(this);f(t.target).is("a.close")?u(a):n&&s.contactEdit&&(n.setCallbackSuccess(function(t){jQuery.ajax({method:"GET",url:t.href,data:{},dataType:"json",headers:{"X-TM-Username":app.data.user.login,"X-TM-Key":app.data.user.api_key},cache:!1,success:function(t){var e,n;e=a,t={phone:t.phone,contactId:t.id,name:(t.firstName||"")+" "+(t.lastName||"")},e=checkJquery(e),!1!==(index=l(e.data("contact")))&&(o[index]=t),e.data("contact",t),r.hasClass("tag-input")&&(e.html(m(JSON.parse(JSON.stringify(t)),!0)),r.parent().data("tag-block")&&r.parent().trigger("change.tag")),f.isFunction(s.callbackAdd)&&1!=n?s.callbackAdd.call(e,i):c(),s.callbackChanged()}})}),void 0!==(t=a.data("contact")).contactId&&t.contactId?n.initForm().fetchContact(t.contactId):void 0!==t.phone&&t.phone&&(n.initForm().loadForm(t),n.setCountryByPhone("+"+t.phone),n.toggleModal(!0,!0)))}),s.recipients&&f.each(s.recipients,function(t,e){h(e,!0)}),i;function l(t){for(var e in o)if(o.hasOwnProperty(e)){var n=o[e],a=n.phone==t.phone&&null!=n.phone,i=n.groupId==t.groupId&&null!=n.groupId;if(n.contactId==t.contactId&&null!=n.contactId||a||i)return e}return!1}function a(t){return!1!==(t=l(t))&&(delete o[t],o.splice(t,1),1)}function c(){var n;s.$counter&&((n=0)!=o.length&&f.each(o,function(t,e){null!=e.groupId&&null!=e.count?n+=parseInt(e.count):n++}),s.$counter.text(n))}function u(t,e){var n=(t=checkJquery(t)).data("contact");n&&a(n)&&(f.isFunction(s.callbackRemove)&&1!=e?s.callbackRemove.call(t,i):c(),t.remove(),s.callbackChanged())}function h(t,e){if(!1!==l(t=f.extend({},{phone:void 0,name:void 0,groupId:void 0,contactId:void 0},t)))return!1;o.push(t);var n=f(m(JSON.parse(JSON.stringify(t))));return n.data("contact",t),f.isFunction(s.callbackAdd)&&1!=e?s.callbackAdd.call(n,i):c(),r.hasClass("tag-input")&&(r.before(n),r.parent().data("tag-block")&&r.parent().trigger("change.tag")),s.callbackChanged(),!0}function p(t){var e,n,a=t.val().replace(") ",")-").replace(","," ").replace("."," ").replace(";"," ").replace(":"," ").replace("\n"," ").split(/[\s,]+/);1==a.length?(n=(e=t).val(),(n=d.transformPhoneNumber(n.replace(/^00/,"+"),s.country)).isValid?h({phone:n.number.substr(1)})&&e.val(""):(0==(e=(n=e.closest(".form-group")).find(".input-control").parent()).parent().find("span.error").length&&e.after("<span class='error help-block'>Please enter a valid mobile phone number.</span>"),n.addClass("has-error"))):(a.forEach(function(t){var e=d.transformPhoneNumber(t.replace(/^00/,"+"),s.country);e.isValid?h({phone:e.number.substr(1)},!0):0}),f.isFunction(s.callbackAdd)&&s.callbackAdd.call(null,i),t.val(""))}function m(t,e){var n="",a="";return void 0!==t.name&&(n=t.name),void 0!==t.phone&&t.phone&&(t.phone="+"+t.phone.replace("+","")),void 0!==t.name&&void 0!==t.phone&&(a='<span class="hint">('+t.phone+")</span>"),void 0!==t.name&&void 0!==t.count&&(a='<span class="hint">('+t.count+")</span>"),void 0!==t.name&&null!=t.name||void 0===t.phone||(a="",n=t.phone),(e?"":'<span class="'+s.classTag+'">')+(t.groupId?"":'<a href = "#" style="text-decoration:none;">')+n.escapeHtml()+(t.groupId?"":"</a>")+a+'<a href="#" class="close">&times;</a>'+(e?"":"</span>")}}}(jQuery),function(b){b.fn.tagsField=function(t){var m=b.extend({},{tags:["first_name","last_name","company_name","phone","email"],open:"{",close:"}",add_tag_link_selector:"a.add-tag-link",approximately_selector:!1,afterInsert:function(){}},t),f=this;function n(){for(var t,e,n,a=f.prev(),i=g(f.val()),o=0,s=m.open.length,r=m.close.length,d=i.indexOf(m.open),l=i.indexOf(m.close,d+1),c="",u=d<0||l<0?i:i.substring(0,d);-1!=d&&-1!=l;){o++;var h=l,c=i.substring(d+s,l),p=0<m.tags.filter(function(t){return g(t)===c}).length||"http"==c.substr(0,4).toLowerCase();p=p,n=e=void 0,n="","object"==typeof(e=t=c)&&(e=t.name,t.phone!=t.name&&void 0!==t.phone&&(n='<span class="hint">('+t.phone+")</span>")),u=(u+=c='<span class="tag-item '+(0==p?"error":"")+'">'+e+n+'<a href="#" class="close" onclick="removeTag(this.parentNode); return false;">&times;</a></span>')+((d=i.indexOf(m.open,l+r))<0?i.substring(l+r):(l=i.indexOf(m.close,d+s))<0?i.substring(h+r):i.substring(h+r,d))}0!=m.approximately_selector&&b(m.approximately_selector).text(0<o?"~":""),u=u.split("\n").join("</br>"),a.html(u)}function g(t){return t.replace(/[&"<>]/g,function(t){return{"&":"&amp;",'"':"&quot;","<":"&lt;",">":"&gt;"}[t]})}function e(t){var e=t;n(),e.prev().scrollTop(t[0].scrollTop),e.css("opacity",0)}return t=f.prop("placeholder"),f.wrap('<div style="position: relative;"></div>').before('<div data-placeholder="'+t+'" class="form-control editable" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>'),b(m.add_tag_link_selector).click(function(t){t.preventDefault();t=b(this).text(),t=m.open+t+m.close;f.textAtCaret(t),f.change().blur(),m.afterInsert(t)}),b(window).blur(function(){e(f)}),f.on("blur",function(){e(f)}).on("focus",function(){b(this).css("opacity",1)}).on("input.msg propertychange.msg",function(){var t=b(this);t.attr("rows",t.val().split("\n").length)}).on("change",function(){n()}).change().trigger("input.msg"),0<f.val().length&&f.blur(),{getOptions:function(){return m}}}}(jQuery);var templateCrudApi,templateId=!1,paginationCommand="table",paginationScroll=!1,ajaxUrl="/online/messages/templates/ajax",List=($(document).ready(function(){var o={smsLeft:6},s=$('[data-widget="top-alert"]'),r=$.prepareCrudPage({containerSelector:"#templates-content",itemSelector:"tr[data-widget=template]",commandUrl:ajaxUrl,paginationCommand:paginationCommand,paginationScroll:paginationScroll,removeFunction:function(t){var a=$(t).closest("tr").data("id");$.confirm({title:"Delete template",message:"Are you sure you would like to delete this template?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Delete",class:"btn btn-danger",click:function(){var e=this,n=$(this).find("button.btn-danger");n.spin("enable","Deleting..."),r.removeItems(a,function(t){n.spin("disable"),$(e).modal("hide"),r.setCheckedItems([]),r.getPaginationApi().reload(),t&&0==t.success?s.warningBlock(t.message):s.successBlock("The selected template has been successfully deleted.")});r.setCheckedItems([])}}}})},bulkRemoveFunction:function(t){var a=r.getCheckedItems(),e="template";return(1<a.length||r.getCheckedAllItems())&&(e+="s"),$.confirm({title:"Delete "+e,message:"Are you sure you would like to delete selected "+e+"?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Delete",class:"btn btn-danger",click:function(){var e=this,n=$(this).find("button.btn-danger");n.spin("enable","Deleting..."),r.removeItems(!1===r.getCheckedAllItems()?a:"all",function(t){n.spin("disable"),$(e).modal("hide"),r.getPaginationApi().reload(),t&&0==t.success?s.warningBlock(t.message):s.successBlock("The selected templates have been successfully deleted.")});r.setCheckedItems([])}}}}),!0},afterReloadFunction:function(){r.setCheckedAllItems(!1),"table"!=paginationCommand?$("#templatesTable").addClass("table-radio"):$("#templatesTable").removeClass("table-radio"),$('a[data-widget="edit"]').on("click",function(t){return t.preventDefault(),hideErrors(),templateId=$(this).closest("tr").data("id"),$("#addTemplateModal .modal-title").text("Edit template"),$('#addTemplateModal button[data-widget="submit-template"]'),$("#addListName").val($(this).closest("tr").find('[data-content="name"]').text().trim()),$("#editTmplText").val($(this).closest("tr").find("[data-content-body]").data("content-body")).msgCount(o).trigger("input").change(),!0})},checkboxChangeFunction:function(t){var e=$(t).closest("tr").data("id");return $(t).is(":checked")?r.addCheckedItems([e]):r.removeCheckedItems([e]),!0},checkedItemsChangeFunction:function(){},searchFormSelector:"#templates-search"});templateCrudApi=r,"undefined"!=typeof AHServiceContainer&&(t=AHServiceContainer.get("Textmagic::ModalBundle::App"))&&t.setCallbackSuccessTemplateForm(function(){r.getPaginationApi().reload()}),$('button[data-widget="submit-template"]').click(function(t){var e=$(this),n=templateId?"The selected template has been successfully edited.":"New template has been successfully created.",t=(t.preventDefault(),hideErrors(),e.spin("enable","Saving..."),{cmd:"updateTemplate",name:$("#addListName").val(),content:$("#editTmplText").val(),templateId:templateId});$.post(ajaxUrl,t).done(function(t){if(1==t.success)return e.spin("disable"),null!=r.getPaginationApi()&&(r.setOptions({refresh:!0}),r.getPaginationApi().reload()),$("#addTemplateModal").modal("hide"),$("#addTemplateModal2").length&&$("#addTemplateModal2").modal("show"),s.successBlock(n),!0;e.spin("disable"),t.message.body?($("[data-id=editTmplTextField]").closest("div").after("<span class='error help-block'>"+t.message.body+"</span>"),$("[data-id=editTmplTextFormGroup]").addClass("has-error")):parseAllErrors(t.message),e.spin("disable")}).fail(function(){return $(this).spin("disable"),!1})}),$('a[data-widget="new"]').on("click",function(t){return t.preventDefault(),templateId=!1,hideErrors(),$("#addTemplateModal .modal-title").text("Create new template"),$('#addTemplateModal button[data-widget="submit-template"]'),$("#addListName").val(""),$("#editTmplText").val("").msgCount(o).change(),!0}),$(document).on("click",'a[data-widget="save-as-template"]',function(){templateId=!1;var n,a,e,t=parseInt($(this).data("id")),i=$(this).data("source");t=t,i=i,n=$("#addListName"),a=$("#editTmplText"),e=$("#addTemplateBtn"),$.ajax({url:ajaxUrl,dataType:"JSON",method:"POST",data:{cmd:"fetchTemplateContent",id:t,source:i},beforeSend:function(){n.prop("disabled","disabled"),a.prop("disabled","disabled"),e.prop("disabled","disabled")},success:function(t){var e="";t.success&&(e=t.data.content),n.val(""),a.val(e).msgCount(o).change()},error:function(t){console.warn(t)},complete:function(t){n.prop("disabled",!1),a.prop("disabled",!1),e.prop("disabled",!1)}})}),$(document).on("click",'[data-widget="new-message-row"]',function(){var t=$(this).closest("tr").data("id");t=t,t=$('<form action="/online/messages/new" method="post" style="display: none;"><input type="text" name="templateId" value="'+t+'" /></form>'),$("body").append(t),$(t).submit()}),$(document).on("click",'[data-widget="set-opt-out-template"]',function(){parseInt($(this).closest("tr").data("id"))}),$(document).on("click",'[data-widget="unset-opt-out-template"]',function(){}),$(document).on("click",".duplicate-template",function(t){t.preventDefault();var n=$(t.target).data("template-id");$.confirm({title:"Duplicate template",message:"Are you sure you would like to duplicate the template?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Duplicate template",class:"btn btn-success",click:function(){var t=$(this).find("button.btn-success"),e=this;t.spin("enable","Duplication..."),r.post({cmd:"duplicateTemplate",templateId:n},function(){t.spin("disable"),$(e).modal("hide"),r.getPaginationApi().reload()})}}}})}),$('[data-widget="restore"]').on("click",function(t){$.confirm({title:"Restore templates",message:"Are you sure you would like to restore the selected templates?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Restore",class:"btn btn-danger",click:function(){function t(){s.successBlock("The selected templates have been successfully restored."),r.getPaginationApi().reload()}r.getCheckedAllItems()?r.updateItems("RESTORE MY TEMPLATES","archived",0,t):r.updateItems(r.getCheckedItems(),"archived",0,t),$(this).modal("hide")}}}})});var d,t=$('[data-widget="copy-templates"]'),e=$('[data-widget="copy-templates-pane"]'),l=$("#subAccountsModal"),c=null;$(document.body).on("click",'[data-widget="copy-templates-row"]',function(){c=parseInt($(this).closest("tr").data("id"))}),e.on("click",function(){c=null}),t.on("click",function(){var n,a,i=r.getCheckedItems(),o=r.getCheckedAllItems();c&&(o=!(i=[c])),window.saCrudApi&&(d=window.saCrudApi,n=d.getCheckedItems(),a=d.getCheckedAllItems()),$("#subaccounts-search").find('input[name="search-query"]').val().trim()&&(a=!1),$("#templates-search").find('input[name="search-query"]').val().trim()&&(o=!1),$.confirm({title:"Share with sub-accounts",message:"The selected templates will be copied to the selected sub-accounts. This action cannot be undone. Are you sure you would like to share the selected templates with the sub-accounts?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Share templates",class:"btn btn-success",click:function(){var e=$(this),t=e.find(".btn.btn-success");$.ajax({url:ajaxUrl,dataType:"JSON",method:"POST",data:{cmd:"copyToPeople",tIds:i,tAll:o,sIds:n,sAll:a},beforeSend:function(){t.spin("enable")},success:function(t){t.success&&(r.setCheckedItems([]),r.setCheckedAllItems(!1),r.getPaginationApi().reload(),s.successBlock(t.message),d&&(d.setCheckedAllItems(!1),d.setCheckedItems([]),d.getPaginationApi().reload()))},error:function(t){console.warn(t)},complete:function(t){c=null,e.modal("hide"),l.modal("hide")}})}}}})}),$(document.body).on("change",".table-radio input:checkbox",function(){var t=this;$(this).closest("table").find("input:checkbox").filter(function(){return this!==t}).prop("checked",!1),$(this).prop("checked")?r.setCheckedItems([$(this).closest("tr").data("id")]):r.setCheckedItems([])}),$("#addTemplateModal").on("shown.bs.modal",function(){$("#editTmplText").trigger("input")})}),!function(){var t,e,u,o,h,p,f,m,n,s;function r(t,e){var n,a,i,o,s,r,d,l,c,u,h=e&&e.split("/"),p=f.map,m=p&&p["*"]||{};if(t&&"."===t.charAt(0)&&e){for(t=(h=h.slice(0,h.length-1)).concat(t.split("/")),l=0;l<t.length;l+=1)if("."===(u=t[l]))t.splice(l,1),--l;else if(".."===u){if(1===l&&(".."===t[2]||".."===t[0]))break;0<l&&(t.splice(l-1,2),l-=2)}t=t.join("/")}if((h||m)&&p){for(l=(n=t.split("/")).length;0<l;--l){if(a=n.slice(0,l).join("/"),h)for(c=h.length;0<c;--c)if(i=(i=p[h.slice(0,c).join("/")])&&i[a]){o=i,s=l;break}if(o)break;!r&&m&&m[a]&&(r=m[a],d=l)}!o&&r&&(o=r,s=d),o&&(n.splice(0,s,o),t=n.join("/"))}return t}function g(t,e){return function(){return o.apply(u,n.call(arguments,0).concat([t,e]))}}function b(t){var e;if(p.hasOwnProperty(t)&&(e=p[t],delete p[t],m[t]=!0,s.apply(u,e)),h.hasOwnProperty(t))return h[t];throw new Error("No "+t)}function y(t,e){var n,a,i,o=t.indexOf("!");return t=-1!==o?(n=r(t.slice(0,o),e),t=t.slice(o+1),(a=b(n))&&a.normalize?a.normalize(t,(i=e,function(t){return r(t,i)})):r(t,e)):r(t,e),{f:n?n+"!"+t:t,n:t,p:a}}h={},p={},f={},m={},n=[].slice,s=function(t,e,n,a){var i,o,s,r,d,l,c=[];if(a=a||t,"function"==typeof n){for(e=!e.length&&n.length?["require","exports","module"]:e,d=0;d<e.length;d+=1)if("require"===(o=(r=y(e[d],a)).f))c[d]=g(t);else if("exports"===o)c[d]=h[t]={},l=!0;else if("module"===o)i=c[d]={id:t,uri:"",exports:h[t],config:function(t){return function(){return f&&f.config&&f.config[t]||{}}}(t)};else if(h.hasOwnProperty(o)||p.hasOwnProperty(o))c[d]=b(o);else if(r.p)r.p.load(r.n,g(a,!0),function(e){return function(t){h[e]=t}}(o),{}),c[d]=h[o];else if(!m[o])throw new Error(t+" missing "+o);s=n.apply(h[t],c),t&&(i&&i.exports!==u&&i.exports!==h[t]?h[t]=i.exports:s===u&&l||(h[t]=s))}else t&&(h[t]=n)},t=o=function(t,e,n,a,i){return"string"==typeof t?b(y(t,e).f):(t.splice||(f=t,e.splice?(t=e,e=n,n=null):t=u),e=e||function(){},"function"==typeof n&&(n=a,a=i),a?s(u,t,e,n):setTimeout(function(){s(u,t,e,n)},15),o)},o.config=function(t){return f=t,o},(e=function(t,e,n){e.splice||(n=e,e=[]),p[t]=[t,e,n]}).amd={jQuery:!0},e("almond",function(){}),e("fuelux/util",["require","jquery"],function(t){function a(t,e){return(t.textContent||t.innerText||n(t).text()||"").toLowerCase()===(e||"").toLowerCase()}var n=t("jquery");n.expr[":"].fuelTextExactCI=n.expr.createPseudo?n.expr.createPseudo(function(e){return function(t){return a(t,e)}}):function(t,e,n){return a(t,n[3])}}),e("fuelux/combobox",["require","jquery","./util"],function(t){function o(t,e){this.$element=s(t),this.options=s.extend({},s.fn.combobox.defaults,e),this.$element.on("click","a",s.proxy(this.itemclicked,this)),this.$element.on("change","input",s.proxy(this.inputchanged,this)),this.$input=this.$element.find("input"),this.$button=this.$element.find(".btn"),this.setDefaultSelection()}var s=t("jquery"),e=s.fn.combobox;t("./util");o.prototype={constructor:o,selectedItem:function(){var t;return this.$selectedItem?(t=this.$selectedItem.text(),s.extend({text:t},this.$selectedItem.data())):{text:this.$input.val()}},selectByText:function(t){this.selectBySelector("li:fuelTextExactCI("+t+")")},selectByValue:function(t){this.selectBySelector('li[data-value="'+t+'"]')},selectByIndex:function(t){this.selectBySelector("li:eq("+t+")")},selectBySelector:function(t){t=this.$element.find(t);void 0!==t[0]?(this.$selectedItem=t,this.$input.val(this.$selectedItem.text())):this.$selectedItem=null},setDefaultSelection:function(){var t="li[data-selected=true]:first",e=this.$element.find(t);0<e.length&&(this.selectBySelector(t),e.removeData("selected"),e.removeAttr("data-selected"))},enable:function(){this.$input.removeAttr("disabled"),this.$button.removeClass("disabled")},disable:function(){this.$input.attr("disabled",!0),this.$button.addClass("disabled")},itemclicked:function(t){this.$selectedItem=s(t.target).parent(),this.$input.val(this.$selectedItem.text()).trigger("change",{synthetic:!0});var e=this.selectedItem();this.$element.trigger("changed",e),t.preventDefault()},inputchanged:function(t,e){e&&e.synthetic||(e=s(t.target).val(),this.selectByText(e),0===(t=this.selectedItem()).text.length&&(t={text:e}),this.$element.trigger("changed",t))}},s.fn.combobox=function(n){var a,i=Array.prototype.slice.call(arguments,1),t=this.each(function(){var t=s(this),e=t.data("combobox");e||t.data("combobox",e=new o(this,"object"==typeof n&&n)),"string"==typeof n&&(a=e[n].apply(e,i))});return void 0===a?t:a},s.fn.combobox.defaults={},s.fn.combobox.Constructor=o,s.fn.combobox.noConflict=function(){return s.fn.combobox=e,this},s(function(){s(window).on("load",function(){s(".combobox").each(function(){var t=s(this);t.data("combobox")||t.combobox(t.data())})}),s("body").on("mousedown.combobox.data-api",".combobox",function(){var t=s(this);t.data("combobox")||t.combobox(t.data())})})}),e("fuelux/datepicker",["require","jquery"],function(t){function o(t,e){if(this.$element=s(t),this.options=s.extend(!0,{},s.fn.datepicker.defaults,e),this.formatDate=Boolean(this.options.createInput)&&Boolean(this.options.createInput.native)?this.formatNativeDate:this.options.formatDate||this.formatDate,this.parseDate=this.options.parseDate||this.parseDate,this.blackoutDates=this.options.blackoutDates||this.blackoutDates,this._checkForMomentJS()&&(n=n||window.moment,this.moment=!0,this.momentFormat=this.options.momentConfig.formatCode,this.setCulture(this.options.momentConfig.culture)),null!==this.options.date?(this.date=this.options.date||new Date,this.date=this.parseDate(this.date,!1),this.viewDate=new Date(this.date.valueOf()),this.stagedDate=new Date(this.date.valueOf())):(this.date=null,this.viewDate=new Date,this.stagedDate=new Date),this.inputParsingTarget=null,this.viewDate.setHours(0,0,0,0),this.stagedDate.setHours(0,0,0,0),this.done=!1,this.minDate=new Date,this.minDate.setDate(this.minDate.getDate()-1),this.minDate.setHours(0,0,0,0),this.maxDate=new Date,this.maxDate.setFullYear(this.maxDate.getFullYear()+10),this.maxDate.setHours(23,59,59,999),this.years=this._yearRange(this.viewDate),this.bindingsAdded=!1,this.options.dropdownWidth=this.options.dropdownWidth||170,this.options.monthNames=this.options.monthNames||["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],this.options.weekdays=this.options.weekdays||["Su","Mo","Tu","We","Th","Fr","Sa"],this.options.showYears=!1,this.options.showDays=!0,this.options.showMonths=!1,this.options.restrictLastMonth=Boolean(this.options.restrictDateSelection),this.options.restrictNextMonth=!1,this.months=[{abbreviation:this.options.monthNames[0],class:"",number:0},{abbreviation:this.options.monthNames[1],class:"",number:1},{abbreviation:this.options.monthNames[2],class:"",number:2},{abbreviation:this.options.monthNames[3],class:"",number:3},{abbreviation:this.options.monthNames[4],class:"",number:4},{abbreviation:this.options.monthNames[5],class:"",number:5},{abbreviation:this.options.monthNames[6],class:"",number:6},{abbreviation:this.options.monthNames[7],class:"",number:7},{abbreviation:this.options.monthNames[8],class:"",number:8},{abbreviation:this.options.monthNames[9],class:"",number:9},{abbreviation:this.options.monthNames[10],class:"",number:10},{abbreviation:this.options.monthNames[11],class:"",number:11}],Boolean(this.options.createInput)){if("boolean"==typeof this.options.createInput&&Boolean(this.options.createInput)&&(this.options.createInput={}),"object"!=typeof this.options.createInput||!isNaN(this.options.createInput.length))throw new Error("createInput option needs to be an object or boolean true");this.options.createInput.inputSize=this.options.createInput.inputSize||"span3",this._renderInput()}else this._render()}var s=t("jquery"),e=s.fn.datepicker,n=!1;t(["moment"],function(t){n=t},function(t){"moment"===(t.requireModules&&t.requireModules[0])&&void 0!==window.console&&window.navigator.userAgent.search("PhantomJS")<0&&(window.console.log("Don't worry if you're seeing a 404 that's looking for moment.js. The Fuel UX Datepicker is trying to use moment.js to give you extra features."),window.console.log("Checkout the Fuel UX docs (http://exacttarget.github.io/fuelux/#datepicker) to see how to integrate moment.js for more features"))});o.prototype={constructor:o,disable:function(){this.$element.find("input, button").attr("disabled",!0)},enable:function(){this.$element.find("input, button").attr("disabled",!1)},getFormattedDate:function(){return this.formatDate(this.date)},getDate:function(t){return Boolean(t)&&Boolean(t.unix)?this.date.getTime():this.date},setDate:function(t){return this.date=this.parseDate(t,!1),this.stagedDate=this.date,this.viewDate=this.date,this._render(),this.$element.trigger("changed",this.date),this.date},getCulture:function(){if(Boolean(this.moment))return n.lang();throw"moment.js is not available so you cannot use this function"},setCulture:function(t){if(!Boolean(t))return!1;if(!Boolean(this.moment))throw"moment.js is not available so you cannot use this function";n.lang(t)},getFormatCode:function(){if(Boolean(this.moment))return this.momentFormat;throw"moment.js is not available so you cannot use this function"},setFormatCode:function(t){if(!Boolean(t))return!1;if(!Boolean(this.moment))throw"moment.js is not available so you cannot use this function";this.momentFormat=t},formatDate:function(t){return this.padTwo(t.getMonth()+1)+"-"+this.padTwo(t.getDate())+"-"+t.getFullYear()},formatNativeDate:function(t){return t.getFullYear()+"-"+this.padTwo(t.getMonth()+1)+"-"+this.padTwo(t.getDate())},parseDate:function(t,e){var n,a,i;if(Boolean(t)&&"Invalid Date"!==new Date(t).toString())return"string"==typeof t?(t=t.split("T")[0],i=/^\s*(\d{4})-(\d\d)-(\d\d)\s*$/,n=new Date(NaN),(i=i.exec(t))&&(a=+i[2],n.setFullYear(i[1],a-1,i[3]),a!==n.getMonth()+1&&n.setTime(NaN)),n):new Date(t);throw new Error("could not parse date")},blackoutDates:function(t){return!1},padTwo:function(t){t="0"+t;return t.substr(t.length-2)},_setNullDate:function(t){this.date=null,this.viewDate=new Date,this.stagedDate=new Date,this._insertDateIntoInput(t||""),this._renderWithoutInputManipulation()},_restrictDateSelectionSetup:function(){var t,e;Boolean(this.options)&&(this.options.restrictDateSelection?(e=this.viewDate.getMonth()<(new Date).getMonth(),t=!(this.viewDate.getMonth()>(new Date).getMonth())):e=t=!1),this.options.restrictLastMonth=t,this.options.restrictNextMonth=e},_processDateRestriction:function(t,e){var n="",a=!1;return e=e||!1,t<=this.minDate||t>=this.maxDate?Boolean(this.blackoutDates(t))?(n+=" restrict blackout",a=!0):Boolean(this.options)&&Boolean(this.options.restrictDateSelection)?(n+=" restrict",a=!0):n+=" past":Boolean(this.blackoutDates(t))&&(n+=" restrict blackout",a=!0),Boolean(e)?n:a},_repeat:function(t,e,n,a){for(var i=t,o=0,s=e.length;o<s;o++)i+=n(e[o]);return i+=a},_getDaysInMonth:function(t,e){return 32-new Date(e,t,32).getDate()},_range:function(t,e){for(var n=[],a=t;a<e;a++)n[n.length]=a;return n},_yearRange:function(t){for(var t=10*Math.floor(t.getFullYear()/10)-1,e=this._range(t,12+t),n=[],a=0,i=e.length;a<i;a++){var o=0===a?"previous":"";a===e.length-1&&(o="next"),n[a]={number:e[a],class:o}}return n},_killEvent:function(t){return t.stopPropagation(),t.preventDefault(),!1},_applySize:function(t,e){for(var n=0;n<t.length;n++)s(t[n]).css({width:e,height:e,"line-height":e})},_show:function(t){return t?"":"display: none;"},_hide:function(t){return this._show(!t)},_showView:function(t){1===t?(this.options.showDays=!0,this.options.showMonths=!1,this.options.showYears=!1):2===t?(this.options.showDays=!1,this.options.showMonths=!0,this.options.showYears=!1):3===t&&(this.options.showDays=!1,this.options.showMonths=!1,this.options.showYears=!0)},_updateCalendarData:function(){var t=this.viewDate.getMonth(),e=this.viewDate.getFullYear(),n=this.stagedDate.getDate(),a=this.stagedDate.getMonth(),i=this.stagedDate.getFullYear(),o=new Date(e,t,1).getDay(),s=this._getDaysInMonth(t,e),r=this._getDaysInMonth(t-1,e),d=42-s-(o=0===o?7:o);this.daysOfLastMonth=this._range(r-o+1,r+1),this.daysOfNextMonth=this._range(1,1+d);for(var l=0,c=this.daysOfLastMonth.length;l<c;l++){var u={};u.number=this.daysOfLastMonth[l],u.class="",u.class=this._processDateRestriction(new Date(e,t+1,this.daysOfLastMonth[l],0,0,0,0),!0),u.class+=" past",this.daysOfLastMonth[l]=u}for(var h=0,p=this.daysOfNextMonth.length;h<p;h++){var m={};m.number=this.daysOfNextMonth[h],m.class="",m.class=this._processDateRestriction(new Date(e,t+1,this.daysOfNextMonth[h],0,0,0,0),!0),this.daysOfNextMonth[h]=m}var o=new Date,f=o.getDate(),g=o.getMonth(),b=o.getFullYear(),y=t===g,v=e===b,w=t===a,k=e===i,C=this._range(1,s+1);this.daysOfThisMonth=[];for(var $=0,x=C.length;$<x;$++){var A=new Date(e,t,C[$]).getDay(),S=1===A?"":6!==A&&0!==A?"weekday":"weekend",A=(S+=" weekday"+A,C[$]===n&&w&&k?S+=" selected":C[$]===f&&y&&v&&(S+=" today"),new Date(e,t,C[$],0,0,0,0));S+=this._processDateRestriction(A,!0),this.daysOfThisMonth[this.daysOfThisMonth.length]={number:C[$],class:S}}for(var I=this._getDaysInMonth(this.minDate.getFullYear(),this.minDate.getMonth()),T=0,D=this.months.length;T<D;T++){this.months[T].class="",v&&T===g&&(this.months[T].class+=" today"),T===a&&k&&(this.months[T].class+=" selected");var B=new Date(e,T,I,23,59,59,999),M=new Date(e,T,0,0,0,0,0);(B<=this.minDate||M>=this.maxDate)&&Boolean(this.options.restrictDateSelection)&&(this.months[T].class+=" restrict")}this.years=this._yearRange(this.viewDate);for(var I=this._getDaysInMonth(this.minDate.getFullYear(),11),N=0,E=this.years.length;N<E;N++){this.years[N].number===b&&(this.years[N].class+=" today"),this.years[N].number===i&&(this.years[N].class+=" selected");var P=new Date(this.years[N].number,11,I,23,59,59,999),_=new Date(this.years[N].number,0,0,0,0,0,0);(P<=this.minDate||_>=this.maxDate)&&Boolean(this.options.restrictDateSelection)&&(this.years[N].class+=" restrict")}},_updateCss:function(){for(;this.options.dropdownWidth%7!=0;)this.options.dropdownWidth++;this.$view.css("width",this.options.dropdownWidth+"px"),this.$header.css("width",this.options.dropdownWidth+"px"),this.$labelDiv.css("width",this.options.dropdownWidth-60+"px"),this.$footer.css("width",this.options.dropdownWidth+"px");for(var t=.25*this.options.dropdownWidth-2,e=Math.round((this.options.dropdownWidth-3*t)/2),n=e;n+e+3*t<this.options.dropdownWidth;)n+=.1;for(;n+e+3*t>this.options.dropdownWidth;)n-=.1;e=parseInt(e/2,10),n=parseInt(n/2,10),this.$calendar.css({float:"left"}),this.$monthsView.css({width:this.options.dropdownWidth+"px","padding-top":e+"px","padding-bottom":n+"px"}),this.$yearsView.css({width:this.options.dropdownWidth+"px","padding-top":e+"px","padding-bottom":n+"px"});var a=Math.round(this.options.dropdownWidth/7)-2+"px",i=Math.round(this.options.dropdownWidth/7)+"px";this._applySize(this.$yearsView.children(),t+"px"),this._applySize(this.$monthsView.children(),t+"px"),this._applySize(this.$weekdaysDiv.children(),i),this._applySize(this.$lastMonthDiv.children(),a),this._applySize(this.$thisMonthDiv.children(),a),this._applySize(this.$nextMonthDiv.children(),a)},_close:function(){this.$input.dropdown("toggle")},_select:function(t){if(this.inputParsingTarget=null,-1<t.target.className.indexOf("restrict"))return this._killEvent(t);this._killEvent(t),this._close(),this.stagedDate=this.viewDate,this.stagedDate.setDate(parseInt(t.target.innerHTML,10)),this.setDate(this.stagedDate),this.done=!0},_pickYear:function(t){var e=parseInt(s(t.target).data("yearNumber"),10);return-1<t.target.className.indexOf("restrict")||(this.viewDate=new Date(e,this.viewDate.getMonth(),1),this._showView(2),this._render()),this._killEvent(t)},_pickMonth:function(t){var e=parseInt(s(t.target).data("monthNumber"),10);return-1<t.target.className.indexOf("restrict")||(this.viewDate=new Date(this.viewDate.getFullYear(),e,1),this._showView(1),this._render()),this._killEvent(t)},_previousSet:function(t){this._previous(t,!0)},_previous:function(t,e){return-1<t.target.className.indexOf("restrict")||(this.options.showDays?this.viewDate=new Date(this.viewDate.getFullYear(),this.viewDate.getMonth()-1,1):this.options.showMonths?this.viewDate=new Date(this.viewDate.getFullYear()-1,this.viewDate.getMonth(),1):this.options.showYears&&(this.viewDate=new Date(this.viewDate.getFullYear()-10,this.viewDate.getMonth(),1)),Boolean(e)?this._select(t):this._render()),this._killEvent(t)},_nextSet:function(t){this._next(t,!0)},_next:function(t,e){return-1<t.target.className.indexOf("restrict")||(this.options.showDays?this.viewDate=new Date(this.viewDate.getFullYear(),this.viewDate.getMonth()+1,1):this.options.showMonths?this.viewDate=new Date(this.viewDate.getFullYear()+1,this.viewDate.getMonth(),1):this.options.showYears&&(this.viewDate=new Date(this.viewDate.getFullYear()+10,this.viewDate.getMonth(),1)),Boolean(e)?this._select(t):this._render()),this._killEvent(t)},_today:function(t){return this.viewDate=new Date,this._showView(1),this._render(),this._killEvent(t)},_emptySpace:function(t){return Boolean(this.done)&&(this.done=!1),this._killEvent(t)},_monthLabel:function(){return this.options.monthNames[this.viewDate.getMonth()]},_yearLabel:function(){return this.viewDate.getFullYear()},_monthYearLabel:function(){var t;return this.options.showDays?t=this._monthLabel()+" "+this._yearLabel():this.options.showMonths?t=this._yearLabel():this.options.showYears&&(t=this.years[0].number+" - "+this.years[this.years.length-1].number),t},_toggleMonthYearPicker:function(t){return this.options.showDays?this._showView(2):this.options.showMonths?this._showView(3):this.options.showYears&&this._showView(1),this._render(),this._killEvent(t)},_renderCalendar:function(){var e=this;return e._restrictDateSelectionSetup(),'<div class="calendar"><div class="header clearfix"><div class="left hover"><div class="leftArrow"></div></div><div class="right hover"><div class="rightArrow"></div></div><div class="center hover">'+e._monthYearLabel()+'</div></div><div class="daysView" style="'+e._show(e.options.showDays)+'">'+e._repeat('<div class="weekdays">',e.options.weekdays,function(t){return"<div >"+t+"</div>"},"</div>")+e._repeat('<div class="lastmonth">',e.daysOfLastMonth,function(t){return e.options.restrictLastMonth&&(t.class=t.class.replace("restrict","")+" restrict"),'<div class="'+t.class+'">'+t.number+"</div>"},"</div>")+e._repeat('<div class="thismonth">',e.daysOfThisMonth,function(t){return'<div class="'+t.class+'">'+t.number+"</div>"},"</div>")+e._repeat('<div class="nextmonth">',e.daysOfNextMonth,function(t){return e.options.restrictNextMonth&&(t.class=t.class.replace("restrict","")+" restrict"),'<div class="'+t.class+'">'+t.number+"</div>"},"</div>")+"</div>"+e._repeat('<div class="monthsView" style="'+e._show(e.options.showMonths)+'">',e.months,function(t){return'<div data-month-number="'+t.number+'" class="'+t.class+'">'+t.abbreviation+"</div>"},"</div>")+e._repeat('<div class="yearsView" style="'+e._show(e.options.showYears)+'">',e.years,function(t){return'<div data-year-number="'+t.number+'" class="'+t.class+'">'+t.number+"</div>"},"</div>")+'<div class="footer"><div class="center hover">Today</div></div></div>'},_render:function(){this._insertDateIntoInput(),this._updateCalendarData(),Boolean(this.bindingsAdded)&&this._removeBindings(),this.$element.find(".dropdown-menu").html(this._renderCalendar()),this._initializeCalendarElements(),this._addBindings(),this._updateCss()},_renderWithoutInputManipulation:function(){this._updateCalendarData(),Boolean(this.bindingsAdded)&&this._removeBindings(),this.$element.find(".dropdown-menu").html(this._renderCalendar()),this._initializeCalendarElements(),this._addBindings(),this._updateCss()},_renderInput:function(){var t=Boolean(this.options.createInput.native)?this._renderInputNative():this._renderInputHTML();this.$element.html(t),this._render()},_renderInputNative:function(){return'<input type="date" value="'+this.formatDate(this.date)+'"'+this._calculateInputSize(["native"])+">"},_renderInputHTML:function(){var t='<div class="'+(Boolean(this.options.createInput.dropDownBtn)?"input-append":"input-group")+'"><div class="dropdown-menu"></div><input type="text" '+this._calculateInputSize()+' value="'+this.formatDate(this.date)+'" data-toggle="dropdown">';return Boolean(this.options.createInput.dropDownBtn)&&(t+='<button type="button" class="btn" data-toggle="dropdown"><i class="icon-calendar"></i></button>'),'<div class="datepicker dropdown">'+(t+="</div>")+"</div>"},_calculateInputSize:function(t){return Boolean(parseInt(this.options.createInput.inputSize,10))?'style="width:'+this.options.createInput.inputSize+'px"':(t=Boolean(t)?" "+t.join(" "):"",'class="'+this.options.createInput.inputSize+t+'"')},_insertDateIntoInput:function(t){t=Boolean(t)?this.formatDate(this.stagedDate):null!==this.date?this.formatDate(this.date):"";this.$element.find('input[type="text"]').val(t)},_inputDateParsing:function(){var t=this.$input.val(),e=!0;8<=t.length&&t.length<=10?Boolean(this.parseDate(t,!0))&&!this._processDateRestriction(this.parseDate(t))&&(e=!1,this.setDate(t)):e=!1,e&&(this._setNullDate(!0),this.$element.trigger("inputParsingFailed"))},_checkForMomentJS:function(){return!!(s.isFunction(window.moment)||void 0!==n&&s.isFunction(n))&&(!!s.isPlainObject(this.options.momentConfig)&&!(!Boolean(this.options.momentConfig.culture)||!Boolean(this.options.momentConfig.formatCode)))},_initializeCalendarElements:function(){this.$input=this.$element.find('input[type="text"]'),this.$calendar=this.$element.find("div.calendar"),this.$header=this.$calendar.children().eq(0),this.$labelDiv=this.$header.children().eq(2),this.$view=this.$calendar.children().eq(1),this.$monthsView=this.$calendar.children().eq(2),this.$yearsView=this.$calendar.children().eq(3),this.$weekdaysDiv=this.$view.children().eq(0),this.$lastMonthDiv=this.$view.children().eq(1),this.$thisMonthDiv=this.$view.children().eq(2),this.$nextMonthDiv=this.$view.children().eq(3),this.$footer=this.$calendar.children().eq(4)},_addBindings:function(){var t=this;Boolean(this.moment)&&(this.$calendar.on("mouseover",function(){t.inputParsingTarget="calendar"}),this.$calendar.on("mouseout",function(){t.inputParsingTarget=null}),this.$input.on("blur",function(){null===t.inputParsingTarget&&t._inputDateParsing()})),this.$calendar.on("click",s.proxy(this._emptySpace,this)),this.$header.find(".left").on("click",s.proxy(this._previous,this)),this.$header.find(".right").on("click",s.proxy(this._next,this)),this.$header.find(".center").on("click",s.proxy(this._toggleMonthYearPicker,this)),this.$lastMonthDiv.find("div").on("click",s.proxy(this._previousSet,this)),this.$thisMonthDiv.find("div").on("click",s.proxy(this._select,this)),this.$nextMonthDiv.find("div").on("click",s.proxy(this._nextSet,this)),this.$monthsView.find("div").on("click",s.proxy(this._pickMonth,this)),this.$yearsView.find("div").on("click",s.proxy(this._pickYear,this)),this.$footer.find(".center").on("click",s.proxy(this._today,this)),this.bindingsAdded=!0},_removeBindings:function(){Boolean(this.moment)&&(this.$calendar.off("mouseover"),this.$calendar.off("mouseout"),this.$input.off("blur")),this.$calendar.off("click"),this.$header.find(".left").off("click"),this.$header.find(".right").off("click"),this.$header.find(".center").off("click"),this.$lastMonthDiv.find("div").off("click"),this.$thisMonthDiv.find("div").off("click"),this.$nextMonthDiv.find("div").off("click"),this.$monthsView.find("div").off("click"),this.$yearsView.find("div").off("click"),this.$footer.find(".center").off("click"),this.bindingsAdded=!1}},s.fn.datepicker=function(n){var a,i=Array.prototype.slice.call(arguments,1),t=this.each(function(){var t=s(this),e=t.data("datepicker");e||t.data("datepicker",e=new o(this,"object"==typeof n&&n)),"string"==typeof n&&(a=e[n].apply(e,i))});return void 0===a?t:a},s.fn.datepicker.defaults={date:new Date,momentConfig:{culture:"en",formatCode:"LL"},createInput:!1,dropdownWidth:170,restrictDateSelection:!0},s.fn.datepicker.Constructor=o,s.fn.datepicker.noConflict=function(){return s.fn.datepicker=e,this}}),e("fuelux/spinner",["require","jquery"],function(t){function o(t,e){this.$element=s(t),this.options=s.extend({},s.fn.spinner.defaults,e),this.$input=this.$element.find(".spinner-input"),this.$element.on("keyup",this.$input,s.proxy(this.change,this)),this.options.hold?(this.$element.on("mousedown",".spinner-up",s.proxy(function(){this.startSpin(!0)},this)),this.$element.on("mouseup",".spinner-up, .spinner-down",s.proxy(this.stopSpin,this)),this.$element.on("mouseout",".spinner-up, .spinner-down",s.proxy(this.stopSpin,this)),this.$element.on("mousedown",".spinner-down",s.proxy(function(){this.startSpin(!1)},this))):(this.$element.on("click",".spinner-up",s.proxy(function(){this.step(!0)},this)),this.$element.on("click",".spinner-down",s.proxy(function(){this.step(!1)},this))),this.switches={count:1,enabled:!0},"medium"===this.options.speed?this.switches.speed=300:"fast"===this.options.speed?this.switches.speed=100:this.switches.speed=500,this.lastValue=null,this.render(),this.options.disabled&&this.disable()}var s=t("jquery"),e=s.fn.spinner;o.prototype={constructor:o,render:function(){var t=this.$input.val();t?this.value(t):this.$input.val(this.options.value),this.$input.attr("maxlength",(this.options.max+"").split("").length)},change:function(){var t=this.$input.val();+t||(t=t.replace(/[^0-9]/g,"")||"",this.$input.val(t)),this.options.value=+t,this.triggerChangedEvent()},stopSpin:function(){void 0!==this.switches.timeout&&(clearTimeout(this.switches.timeout),this.switches.count=1,this.triggerChangedEvent())},triggerChangedEvent:function(){var t=this.value();t!==this.lastValue&&(this.lastValue=t,this.$element.trigger("changed",t),this.$element.trigger("change"))},startSpin:function(t){var e;this.options.disabled||(e=1===(e=this.switches.count)?(this.step(t),1):e<3?1.5:e<8?2.5:4,this.switches.timeout=setTimeout(s.proxy(function(){this.iterator(t)},this),this.switches.speed/e),this.switches.count++)},iterator:function(t){this.step(t),this.startSpin(t)},step:function(t){var e,n=this.options.value,a=t?this.options.max:this.options.min;(t?n<a:a<n)?(n=n+(t?1:-1)*this.options.step,this.options.step%1!=0&&(e=(this.options.step+"").split(".")[1].length,e=Math.pow(10,e),n=Math.round(n*e)/e),(t?a<n:n<a)?this.value(a):this.value(n)):this.options.cycle&&(e=t?this.options.min:this.options.max,this.value(e))},value:function(t){return!isNaN(parseFloat(t))&&isFinite(t)?(t=parseFloat(t),this.options.value=t,this.$input.val(t),this):this.options.value},disable:function(){this.options.disabled=!0,this.$input.attr("disabled",""),this.$element.find("button").addClass("disabled")},enable:function(){this.options.disabled=!1,this.$input.removeAttr("disabled"),this.$element.find("button").removeClass("disabled")}},s.fn.spinner=function(n){var a,i=Array.prototype.slice.call(arguments,1),t=this.each(function(){var t=s(this),e=t.data("spinner");e||t.data("spinner",e=new o(this,"object"==typeof n&&n)),"string"==typeof n&&(a=e[n].apply(e,i))});return void 0===a?t:a},s.fn.spinner.defaults={value:1,min:1,max:999,step:1,hold:!0,speed:"medium",disabled:!1},s.fn.spinner.Constructor=o,s.fn.spinner.noConflict=function(){return s.fn.spinner=e,this},s(function(){s("body").on("mousedown.spinner.data-api",".spinner",function(){var t=s(this);t.data("spinner")||t.spinner(t.data())})})}),e("fuelux/radio",["require","jquery"],function(t){function o(t,e){this.$element=s(t),this.options=s.extend({},s.fn.radio.defaults,e),this.$label=this.$element.parent(),this.$icon=this.$label.find("i"),this.$radio=this.$label.find("input[type=radio]"),this.groupName=this.$radio.attr("name"),this.setState(this.$radio),this.$radio.on("change",s.proxy(this.itemchecked,this))}var s=t("jquery"),e=s.fn.radio;o.prototype={constructor:o,setState:function(t){var e=(t=t||this.$radio).is(":checked"),t=!!t.prop("disabled");this.$icon.removeClass("checked disabled"),this.$label.removeClass("checked"),!0===e&&(this.$icon.addClass("checked"),this.$label.addClass("checked")),!0==t&&this.$icon.addClass("disabled")},resetGroup:function(){var t=s('input[name="'+this.groupName+'"]');t.next().removeClass("checked"),t.parent().removeClass("checked")},enable:function(){this.$radio.attr("disabled",!1),this.$icon.removeClass("disabled")},disable:function(){this.$radio.attr("disabled",!0),this.$icon.addClass("disabled")},itemchecked:function(t){t=s(t.target);this.resetGroup(),this.setState(t)},check:function(){this.resetGroup(),this.$radio.prop("checked",!0),this.setState(this.$radio)},uncheck:function(){this.$radio.prop("checked",!1),this.setState(this.$radio)},isChecked:function(){return this.$radio.is(":checked")}},s.fn.radio=function(n){var a,i=Array.prototype.slice.call(arguments,1),t=this.each(function(){var t=s(this),e=t.data("radio");e||t.data("radio",e=new o(this,"object"==typeof n&&n)),"string"==typeof n&&(a=e[n].apply(e,i))});return void 0===a?t:a},s.fn.radio.defaults={},s.fn.radio.Constructor=o,s.fn.radio.noConflict=function(){return s.fn.radio=e,this},s(function(){s(window).on("load",function(){s(".radio-custom > input[type=radio]").each(function(){var t=s(this);t.data("radio")||t.radio(t.data())})})})}),e("fuelux/select",["require","jquery","./util"],function(t){function o(t,e){this.$element=s(t),this.options=s.extend({},s.fn.select.defaults,e),this.$element.on("click","a",s.proxy(this.itemclicked,this)),this.$button=this.$element.find(".btn"),this.$hiddenField=this.$element.find(".hidden-field"),this.$label=this.$element.find(".dropdown-label"),this.setDefaultSelection(),"auto"===e.resize&&this.resize()}var s=t("jquery"),e=s.fn.select;t("./util");o.prototype={constructor:o,itemclicked:function(t){this.$selectedItem=s(t.target).parent(),this.$hiddenField.val(this.$selectedItem.attr("data-value")),this.$label.text(this.$selectedItem.text());var e=this.selectedItem();this.$element.trigger("changed",e),t.preventDefault()},resize:function(){var t,e=s("<div/>").addClass("select-sizer"),n=0;(Boolean(s(document).find("html").hasClass("fuelux"))?s(document.body):s(".fuelux:first")).append(e),this.$element.find("a").each(function(){e.text(s(this).text()),t=e.outerWidth(),n<t&&(n=t)}),e.remove(),this.$label.width(n)},selectedItem:function(){var t=this.$selectedItem.text();return s.extend({text:t},this.$selectedItem.data())},selectByText:function(t){this.selectBySelector("li a:fuelTextExactCI("+t+")")},selectByValue:function(t){this.selectBySelector('li[data-value="'+t+'"]')},selectByIndex:function(t){this.selectBySelector("li:eq("+t+")")},selectBySelector:function(t){t=this.$element.find(t);this.$selectedItem=t,this.$hiddenField.val(this.$selectedItem.attr("data-value")),this.$label.text(this.$selectedItem.text())},setDefaultSelection:function(){var t="li[data-selected=true]:first",e=this.$element.find(t);0===e.length?this.selectByIndex(0):(this.selectBySelector(t),e.removeData("selected"),e.removeAttr("data-selected"))},enable:function(){this.$button.removeClass("disabled")},disable:function(){this.$button.addClass("disabled")}},s.fn.select=function(n){var a,i=Array.prototype.slice.call(arguments,1),t=this.each(function(){var t=s(this),e=t.data("select");e||t.data("select",e=new o(this,"object"==typeof n&&n)),"string"==typeof n&&(a=e[n].apply(e,i))});return void 0===a?t:a},s.fn.select.defaults={},s.fn.select.Constructor=o,s.fn.select.noConflict=function(){return s.fn.select=e,this},s(function(){s(window).on("load",function(){s(".select").each(function(){var t=s(this);t.data("select")||t.select(t.data())})}),s("body").on("mousedown.select.data-api",".select",function(){var t=s(this);t.data("select")||t.select(t.data())})})}),e("fuelux/scheduler",["require","jquery","fuelux/combobox","fuelux/datepicker","fuelux/radio","fuelux/select","fuelux/spinner"],function(t){function o(t,e){var n=this;this.$element=p(t),this.options=p.extend({},p.fn.scheduler.defaults,e),this.$startDate=this.$element.find(".scheduler-start .datepicker"),this.$startTime=this.$element.find(".scheduler-start .combobox"),this.$timeZone=this.$element.find(".scheduler-timezone .select"),this.$repeatIntervalPanel=this.$element.find(".repeat-interval-panel"),this.$repeatIntervalSelect=this.$element.find(".repeat-interval .select"),this.$repeatIntervalSpinner=this.$element.find(".repeat-interval-panel .spinner"),this.$repeatIntervalTxt=this.$element.find(".repeat-interval-text"),this.$end=this.$element.find(".scheduler-end"),this.$endAfter=this.$end.find(".spinner"),this.$endSelect=this.$end.find(".select"),this.$endDate=this.$end.find(".datepicker"),this.$recurrencePanels=this.$element.find(".recurrence-panel"),this.$element.find(".scheduler-weekly .btn-group .btn").on("click",function(t,e){n.changed(t,e,!0)}),this.$element.find(".combobox").on("changed",p.proxy(this.changed,this)),this.$element.find(".datepicker").on("changed",p.proxy(this.changed,this)),this.$element.find(".select").on("changed",p.proxy(this.changed,this)),this.$element.find(".spinner").on("changed",p.proxy(this.changed,this)),this.$element.find(".scheduler-monthly label.radio, .scheduler-yearly label.radio").on("mouseup",p.proxy(this.changed,this)),this.$repeatIntervalSelect.on("changed",p.proxy(this.repeatIntervalSelectChanged,this)),this.$endSelect.on("changed",p.proxy(this.endSelectChanged,this)),this.$startDate.datepicker(),this.$startTime.combobox(),""===this.$startTime.find("input").val()&&this.$startTime.combobox("selectByIndex",0),this.$repeatIntervalSpinner.spinner(),this.$endAfter.spinner(),this.$endDate.datepicker()}var p=t("jquery"),e=p.fn.scheduler;t("fuelux/combobox"),t("fuelux/datepicker"),t("fuelux/radio"),t("fuelux/select"),t("fuelux/spinner");o.prototype={constructor:o,changed:function(t,e,n){n||t.stopPropagation(),this.$element.trigger("changed",{data:void 0!==e?e:p(t.currentTarget).data(),originalEvent:t,value:this.getValue()})},disable:function(){this.toggleState("disable")},enable:function(){this.toggleState("enable")},endSelectChanged:function(t,e){e=(e||this.$endSelect.select("selectedItem")).value;this.$endAfter.hide(),this.$endDate.hide(),"after"===e?this.$endAfter.show():"date"===e&&this.$endDate.show()},getValue:function(){function t(t,e){var n="";return n+t.getFullYear()+e+((n=t.getMonth()+1)<10?"0"+n:n)+e+((n=t.getDate())<10?"0"+n:n)}var e,n,a,i,o=this.$repeatIntervalSpinner.spinner("value"),s="",r=this.$repeatIntervalSelect.select("selectedItem").value,d=this.$startTime.combobox("selectedItem").text.toLowerCase(),l=this.$timeZone.select("selectedItem"),c=""+t(this.$startDate.datepicker("getDate"),"-"),u=(c+="T",u=0<=d.search("am"),h=0<=d.search("pm"),(d=p.trim(d.replace(/am/g,"").replace(/pm/g,"")).split(":"))[0]=parseInt(d[0],10),d[1]=parseInt(d[1],10),u&&11<d[0]?d[0]=0:h&&d[0]<12&&(d[0]+=12),c=(c=(c+=d[0]<10?"0"+d[0]:d[0])+":"+(d[1]<10?"0"+d[1]:d[1]))+("+00:00"===l.offset?"Z":l.offset),"none"===r?s="FREQ=DAILY;INTERVAL=1;COUNT=1;":"hourly"===r?(s="FREQ=HOURLY;",s+="INTERVAL="+o+";"):"daily"===r?s=s+"FREQ=DAILY;INTERVAL="+o+";":"weekdays"===r?s+="FREQ=DAILY;BYDAY=MO,TU,WE,TH,FR;INTERVAL=1;":"weekly"===r?(e=[],this.$element.find(".scheduler-weekly .btn-group button.active").each(function(){e.push(p(this).data().value)}),s=(s+="FREQ=WEEKLY;")+"BYDAY="+e.join(",")+";INTERVAL="+o+";"):"monthly"===r?(s=s+"FREQ=MONTHLY;INTERVAL="+o+";",1===(i=parseInt(this.$element.find("input[name=scheduler-month]:checked").val(),10))?s+="BYMONTHDAY="+parseInt(this.$element.find(".scheduler-monthly-date .select").select("selectedItem").text,10)+";":2===i&&(e=this.$element.find(".month-days").select("selectedItem").value,a=this.$element.find(".month-day-pos").select("selectedItem").value,s=s+"BYDAY="+e+";BYSETPOS="+a+";")):"yearly"===r&&(s+="FREQ=YEARLY;",1===(i=parseInt(this.$element.find("input[name=scheduler-year]:checked").val(),10))?s=s+("BYMONTH="+(n=this.$element.find(".scheduler-yearly-date .year-month").select("selectedItem").value))+";BYMONTHDAY="+this.$element.find(".year-month-day").select("selectedItem").text+";":2===i&&(e=this.$element.find(".year-month-days").select("selectedItem").value,a=this.$element.find(".year-month-day-pos").select("selectedItem").value,n=this.$element.find(".scheduler-yearly-day .year-month").select("selectedItem").value,s=(s+="BYDAY="+e+";")+"BYSETPOS="+a+";BYMONTH="+n+";")),this.$endSelect.select("selectedItem").value),h="";return"none"!==r&&("after"===u?h="COUNT="+this.$endAfter.spinner("value")+";":"date"===u&&(h="UNTIL="+t(this.$endDate.datepicker("getDate"),"")+";")),{startDateTime:c,timeZone:{name:l.name,offset:l.offset},recurrencePattern:s+=h}},repeatIntervalSelectChanged:function(t,e){var n,e=e?(n=e.value,e.text):(n=(e=this.$repeatIntervalSelect.select("selectedItem")).value,e.text);switch(this.$repeatIntervalTxt.text(e),n.toLowerCase()){case"hourly":case"daily":case"weekly":case"monthly":this.$repeatIntervalPanel.show();break;default:this.$repeatIntervalPanel.hide()}this.$recurrencePanels.hide(),this.$element.find(".scheduler-"+n).show(),"none"===n?this.$end.hide():this.$end.show()},setValue:function(t){var e,n,a,i,o,s,r;if(t.startDateTime&&(r=t.startDateTime.split("T"),this.$startDate.datepicker("setDate",r[0]),r[1]&&(r[1]=r[1].split(":"),o=(i=parseInt(r[1][0],10))<12?"AM":"PM",0===i?i=12:12<i&&(i-=12),r=i+":"+(i=(i=r[1][1]?parseInt(r[1][1].split("+")[0].split("-")[0].split("Z")[0],10):0)<10?"0"+i:i)+" "+o,this.$startTime.find("input").val(r),this.$startTime.combobox("selectByText",r))),n="li[data",t.timeZone?("string"==typeof t.timeZone?n+='-name="'+t.timeZone:t.timeZone.name?n+='-name="'+t.timeZone.name:n+='-offset="'+t.timeZone.offset,this.$timeZone.select("selectBySelector",n+='"]')):t.startDateTime&&(r=(r=t.startDateTime.split("T")[1])?-1<r.search(/\+/)?"+"+p.trim(r.split("+")[1]):-1<r.search(/\-/)?"-"+p.trim(r.split("-")[1]):"+00:00":"+00:00",this.$timeZone.select("selectBySelector",n+='-offset="'+r+'"]')),t.recurrencePattern){for(s={},e=0,a=(r=t.recurrencePattern.toUpperCase().split(";")).length;e<a;e++)""!==r[e]&&(s[(n=r[e].split("="))[0]]=n[1]);if("DAILY"===s.FREQ)n="MO,TU,WE,TH,FR"===s.BYDAY?"weekdays":"1"===s.INTERVAL&&"1"===s.COUNT?"none":"daily";else if("HOURLY"===s.FREQ)n="hourly";else if("WEEKLY"===s.FREQ){if(s.BYDAY)for((n=this.$element.find(".scheduler-weekly .btn-group")).find("button").removeClass("active"),e=0,a=(r=s.BYDAY.split(",")).length;e<a;e++)n.find('button[data-value="'+r[e]+'"]').addClass("active");n="weekly"}else n="MONTHLY"===s.FREQ?(this.$element.find(".scheduler-monthly input").removeClass("checked"),s.BYMONTHDAY?((r=this.$element.find(".scheduler-monthly-date")).find("input").addClass("checked"),r.find(".select").select("selectByValue",s.BYMONTHDAY)):s.BYDAY&&((r=this.$element.find(".scheduler-monthly-day")).find("input").addClass("checked"),s.BYSETPOS&&r.find(".month-day-pos").select("selectByValue",s.BYSETPOS),r.find(".month-days").select("selectByValue",s.BYDAY)),"monthly"):"YEARLY"===s.FREQ?(this.$element.find(".scheduler-yearly input").removeClass("checked"),s.BYMONTHDAY?((r=this.$element.find(".scheduler-yearly-date")).find("input").addClass("checked"),s.BYMONTH&&r.find(".year-month").select("selectByValue",s.BYMONTH),r.find(".year-month-day").select("selectByValue",s.BYMONTHDAY)):s.BYSETPOS&&((r=this.$element.find(".scheduler-yearly-day")).find("input").addClass("checked"),r.find(".year-month-day-pos").select("selectByValue",s.BYSETPOS),s.BYDAY&&r.find(".year-month-days").select("selectByValue",s.BYDAY),s.BYMONTH&&r.find(".year-month").select("selectByValue",s.BYMONTH)),"yearly"):"none";s.COUNT?(this.$endAfter.spinner("value",parseInt(s.COUNT,10)),this.$endSelect.select("selectByValue","after")):s.UNTIL&&(8===(r=s.UNTIL).length&&((r=r.split("")).splice(4,0,"-"),r.splice(7,0,"-"),r=r.join("")),this.$endDate.datepicker("setDate",r),this.$endSelect.select("selectByValue","date")),this.endSelectChanged(),s.INTERVAL&&this.$repeatIntervalSpinner.spinner("value",parseInt(s.INTERVAL,10)),this.$repeatIntervalSelect.select("selectByValue",n),this.repeatIntervalSelectChanged()}},toggleState:function(t){this.$element.find(".combobox").combobox(t),this.$element.find(".datepicker").datepicker(t),this.$element.find(".select").select(t),this.$element.find(".spinner").spinner(t),this.$element.find(".radio").radio(t),t="disable"===t?"addClass":"removeClass",this.$element.find(".scheduler-weekly .btn-group")[t]("disabled")},value:function(t){return t?this.setValue(t):this.getValue()}},p.fn.scheduler=function(n){var a,i=Array.prototype.slice.call(arguments,1),t=this.each(function(){var t=p(this),e=t.data("scheduler");e||t.data("scheduler",e=new o(this,"object"==typeof n&&n)),"string"==typeof n&&(a=e[n].apply(e,i))});return void 0===a?t:a},p.fn.scheduler.defaults={},p.fn.scheduler.Constructor=o,p.fn.scheduler.noConflict=function(){return p.fn.scheduler=e,this},p(function(){p("body").on("mousedown.scheduler.data-api",".scheduler",function(){var t=p(this);t.data("scheduler")||t.scheduler(t.data())})})}),e("fuelux/all",["require","jquery","fuelux/combobox","fuelux/datepicker","fuelux/radio","fuelux/scheduler","fuelux/spinner","fuelux/select"],function(t){t("jquery"),t("fuelux/combobox"),t("fuelux/datepicker"),t("fuelux/radio"),t("fuelux/scheduler"),t("fuelux/spinner"),t("fuelux/select")}),e("jquery",[],function(){return jQuery}),e("moment",[],function(){}),e("fuelux/loader",["fuelux/all"],function(){}),t("fuelux/loader")}(),function(t){this.crudApi=null,this.init(t)}),ListFilter=(List.prototype.initCrudApi=function(){var i=this;this.crudApi=$.prepareCrudPage({containerSelector:"#lists-content",itemSelector:"tr[data-widget=list]",paginationCommand:i.options.paginationCommand,paginationScroll:i.options.paginationScroll,paginationRecount:!0,searchFormSelector:"#lists-search",commandUrl:i.options.commandUrl,checkboxChangeFunction:i.options.checkboxChangeFunction,checkedItemsChangeFunction:i.options.checkedItemsChangeFunction,afterReloadFunction:function(){$(this.itemSelector).on("click",function(t){i.tableCheckboxClickHandler(this)}),i.btnSharedPanelState()},topCheckboxChangeFunction:function(t){var a=$(t).is(":checked");$(this.itemSelector).each(function(){var t=parseInt($(this).attr("data-type")),e=parseInt($(this).attr("data-shared-to-me")),n=$(this).data("id");if(a?i.crudApi.addCheckedItems([n]):i.crudApi.removeCheckedItems([n]),1===e)return!0;i.manageItem(n,t,a)}),a||i.crudApi.setCheckedAllItems(!1),i.btnSharedPanelState(),this.togglePager()}})},List.prototype.init=function(t){var e=this;this.updateListSubmitBtn=$('a[data-widget="submit-list"]'),this.listNameInput=$('[data-field="name"]'),this.topAlert=$('[data-widget="top-alert"]'),this.listTypeChk=$("#listType"),this.isDefaultChk=$("#isDefault"),this.updateListModal=$("#updateListModal"),this.addListBtn=$('a[data-widget="new"]'),this.editListIcon='a[data-widget="list_edit"]',this.tabCounter=$("#contacts-tabs > li.active span"),this.tabContacts=$("#contacts-tabs").find("li:nth-child(2)").find("span"),this.sendBtn=$("[data-widget=send]"),this.deletePermanentlyBtn='[data-widget="delete-permanently"]',this.addContactImportLnk=$("a.btn-add-people.import"),this.sendRowBtn='[data-widget="send-row"]',this.shareRowBtn="[data-share]",this.btnFavTable='[data-widget="toggle-fav-list"]',this.btnSharedPanel=$('[data-widget="toggle-shared"]'),this.btnFavPanel=$('[data-widget="toggle-fav-panel"]'),this.avatar=$(".avatar-wrapper > .avatar"),this.avatarLabel=$(".avatar-wrapper .avatar-label"),this.avatarControl=this.avatar.find(".avatar-control"),this.avatarChangeBtn='[data-widget="change-avatar"]',this.avatarRemoveBtn='[data-widget="remove-avatar"]',this.exportContactsBtn='[data-widget="export-contacts"]',this.avatarUploadForm=$("#form_avatar"),this.avatarFileInput=this.avatarUploadForm.find('input[type="file"]'),this.avatarUploadPreModal=$("#upload-preview-modal"),this.avatarCropForm=$("#list-image-form"),this.sharedItems=[],this.privateItems=[],this.options=$.extend({},{paginationCommand:"table",paginationScroll:!1},t),this.listid=null,this.updateContactModal=$("#updateContactModal"),this.initCrudApi(),$(document.body).on("click",e.btnFavTable,function(t){t.preventDefault(),e.toggleFavBtnClickHandler(this)}),this.avatarUploadPreModal.on("hide.bs.modal",function(){e.resetImageForms()})},List.prototype.resetImageForms=function(){$.each(this.avatarCropForm.find('input[type="hidden"]'),function(t,e){$(e).val("")}),this.avatarUploadForm[0].reset()},List.prototype.updateListCount=function(){this.tabCounter.load("/online/messages/lists/ajaxcount")},List.prototype.deleteBtnClickHandler=function(t){var o=this,e="Delete lists",n="Any contacts contained only in selected lists will be deleted permanently.<br>Are you sure you would like to delete selected lists?";(t=null===(t=t)?this.crudApi.getCheckedItems():t).length&&1!==t.length||(e="Delete list",n="Any contacts contained only in selected list will be deleted permanently.<br>Are you sure you would like to delete selected list?"),$.confirm({title:e,message:n,buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Delete",class:"btn btn-danger",click:function(){function e(t){o.crudApi.setCheckedItems([]),o.crudApi.setCheckedAllItems(!1),o.crudApi.getPaginationApi().reload(),t.success?(o.topAlert.successBlock(t.message),o.tabContacts.load("/online/contacts/ajaxcount")):o.topAlert.warningBlock(t.message),o.updateListCount(),o.updateGroupList()}var n=this,a=$(this).find("button.btn-danger"),i=a.siblings("[data-dismiss]");!1===o.crudApi.getCheckedAllItems()?$.ajax({url:o.options.commandUrl,type:"POST",data:{cmd:"removeList",ids:t},dataType:"JSON",beforeSend:function(){a.spin("enable","Deleting..."),i.btn("disable"),hideErrors(o.topAlert)},complete:function(t){$(n).modal("hide"),a.spin("disable"),i.btn("enable")},success:function(t){e(t)},error:function(t){o.topAlert.dangerBlock("Sorry, but it looks like something has gone wrong. Please try again or contact us at support@textmagic.com")}}):$.ajax({url:o.options.commandUrl,dataType:"JSON",method:"POST",data:{cmd:"removeListAll"},beforeSend:function(){},success:function(t){e(t)},error:function(t){console.warn(t)},complete:function(t){$(n).modal("hide")}})}}}})},List.prototype.fillForm=function(t){hideErrors(),this.listid=t.listid,this.updateListModal.find(".modal-title").text(t.modalTitle),this.updateListSubmitBtn.text(t.btnLabel),this.listNameInput.val(t.nameInputValue),this.listTypeChk.prop("checked",!t.typeChkValue),this.isDefaultChk.prop("checked",t.isDefaultChkValue)},List.prototype.editClickHandler=function(t){t={listid:t.id,modalTitle:"Edit list",btnLabel:"Save",nameInputValue:t.name,descAreaValue:t.desc,typeChkValue:t.type,isDefaultChkValue:t.isDefault};this.fillForm(t)},List.prototype.createClickHandler=function(){this.fillForm({listid:null,modalTitle:"Create new list",btnLabel:"Save",nameInputValue:null,descAreaValue:null})},List.prototype.updateGroupList=function(){this.updateContactModal.find("#contact-lists-container").find("ul.dropdown-menu").load("lists/update-list")},List.prototype.sendBtnClickHandler=function(){var t;!0===this.crudApi.getCheckedAllItems()?this.prepareSendToAllRequest():500<(t=this.crudApi.getCheckedItems()).length?this.topAlert.warningBlock("You cannot send a message to more than 500 lists at once. Please choose fewer lists and try again."):window.location.href="/online/messages/new?groups="+t},List.prototype.prepareSendToAllRequest=function(){var e=this;$.ajax({url:e.options.commandUrl,dataType:"JSON",method:"GET",data:{cmd:"prepareSendClick"},beforeSend:function(){e.sendBtn.prop("disabled","disabled")},success:function(t){t.success?window.location.href="/online/messages/new?groups="+t.data.items:e.topAlert.warningBlock(t.message)},error:function(t){console.warn(t)},complete:function(t){e.sendBtn.prop("disabled",!1)}})},List.prototype.submitBtnClickHandler=function(t){var n=this,a=(hideErrors(),this.updateListSubmitBtn.spin("enable","Saving..."),{cmd:"updateList",name:this.listNameInput.val(),type:this.listTypeChk.is(":checked"),listid:this.listid,isDefault:this.isDefaultChk.is(":checked")}),i=$.extend({},a,t);$.ajax({url:n.options.commandUrl,dataType:"JSON",method:"POST",data:i,beforeSend:function(){n.updateListSubmitBtn.spin("enable")},success:function(t){var e;t.success?(n.crudApi.getPaginationApi()&&(n.crudApi.getPaginationApi().reload(),i.listid||n.updateListCount(),n.updateGroupList()),0!==$(".list-profile-container").length&&((e=$(".list-profile")).attr("data-name",$.trim(a.name)),e.attr("data-type",a.type),e.find(".list-name").text($.trim(a.name))),app.track((i.listid?"Edited":"Created")+" a List","Contacts",{id:i.listid,name:i.name,shared:!i.type}),e="New list has been successfully created.",i.listid&&(e="List has been successfully edited."),n.topAlert.successBlock(e),n.updateListModal.modal("hide")):Array.isArray(t.message)?parseAllErrors(t.message):n.topAlert.warningBlock(t.message)},error:function(t){console.warn(t)},complete:function(t){n.updateListSubmitBtn.spin("disable")}})},List.prototype.toggleFavBtnClickHandler=function(t){var e=$(t),n=$(t).find("i.tmi30"),a=n.hasClass("tmi30-star-o");if(e.hasClass("loading"))return!1;e.spin("enable");this.crudApi.updateItems(e.closest("tr").data("id"),"favorited",a?1:0,function(){e.spin("disable"),a?n.removeClass("tmi30-star-o").addClass("tmi30-star"):n.removeClass("tmi30-star").addClass("tmi30-star-o")})},List.prototype.btnSharedPanelClickHandler=function(a){var i=this,o=this.crudApi.getCheckedItems(),t=this.crudApi.getCheckedAllItems(),e="Share lists with Sub-accounts",n="After sharing the selected lists, your sub-accounts will be able to view, edit and delete the contacts in these lists. Are you sure you want to continue?",s="Share lists";0===a&&(n="After making the selected lists private, your sub-accounts will not be able to view, edit or delete the contacts in these lists. Are you sure you want to continue?",s=e="Make lists private"),$.confirm({title:e,message:n,buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:s,class:"btn btn-success",click:function(){var e=this,n=$(this).find("button.btn-success");n.spin("enable","Processing...");$.ajax({url:i.options.commandUrl,dataType:"JSON",method:"POST",data:{cmd:"toggleShared",ids:o,value:a,all:t},beforeSend:function(){},success:function(t){t.success&&(i.crudApi.setCheckedItems([]),i.crudApi.setCheckedAllItems(!1),i.sharedItems=[],i.privateItems=[],i.crudApi.getPaginationApi().reload(),i.topAlert.successBlock(t.message),app.track("Edited Lists","Contacts",{ids:o,shared:!!a}))},error:function(t){console.warn(t)},complete:function(t){n.spin("disable"),$(e).modal("hide")}})}}}})},List.prototype.tableCheckboxClickHandler=function(t){var e=$(t).find('input[type="checkbox"]').is(":checked"),n=parseInt($(t).attr("data-type")),a=parseInt($(t).attr("data-shared-to-me")),t=$(t).attr("data-id");1!==a&&(this.manageItem(t,n,e),this.btnSharedPanelState())},List.prototype.manageItem=function(t,e,n){t=parseInt(t),e?n?this.sharedItems.pushOnce(t):this.sharedItems.popAll(t):n?this.privateItems.pushOnce(t):this.privateItems.popAll(t)},List.prototype.btnSharedPanelState=function(){var t=!0,e='<i class="fa tmi30-person-two-2 tmi30-12px"></i> Share',n="Share lists with sub-accounts",a=1;0<this.sharedItems.length+this.privateItems.length&&(t=!1,0===this.privateItems.length&&(e='<i class="fa tmi30-person tmi30-12px"></i> Make private',n="Make lists private",a=0)),t?this.btnSharedPanel.addClass("disabled"):this.btnSharedPanel.removeClass("disabled"),this.btnSharedPanel.html(e).attr("data-value",a).attr("title",n)},List.prototype.btnFavToggleClickHandler=function(){var n=this,a=parseInt(this.btnFavPanel.attr("data-state"));n.btnFavPanel.addClass("disabled"),n.crudApi.updateItems(this.listid,"favorited",Math.abs(a-1),function(t){n.btnFavPanel.removeClass("disabled");var e=$(".avatar-wrapper").find(".avatar");t.success&&(n.btnFavPanel.attr("data-state",Math.abs(a-1)),n.btnFavPanel.blur(),1===parseInt(n.btnFavPanel.attr("data-state"))?(n.btnFavPanel.html("<i class='fa tmi30-star-o tmi30-14px'></i>Make list unfavorite"),n.btnFavPanel.prop("title","Unfavorite list"),e.addClass("starred")):(n.btnFavPanel.html("<i class='fa tmi30-star tmi30-14px'></i>Make list favorite"),n.btnFavPanel.prop("title","Favorite list"),e.removeClass("starred")))})},List.prototype.avatarUploadHandler=function(t){var e,o,s=this;return!(!window.FormData||!t.target)&&(!!(t=t.target.files[0])&&((e=new FormData).append("image",t),o=s.avatarUploadPreModal.find(".img-wrapper"),void $.ajax({url:"/online/messages/lists/avatar/upload/pre/"+parseInt(s.listid),cache:!1,contentType:!1,processData:!1,type:"POST",data:e,beforeSend:function(){hideErrors(s.topAlert),s.avatar.spin("enable","",{shadow:!0,top:"-2",left:"1"})},success:function(i){var t;i.success?(o.html(""),s.avatarUploadPreModal.off("shown.bs.modal").on("shown.bs.modal",function(){var t=i.data.tmpPath,e=i.data.originalName,n=$("<img>",{class:"img-preview",src:t}),a=s.avatarUploadPreModal.find("form");a.find('input[name="entityId"]').val(s.listid),a.find('input[name="tmpFile"]').val(t),a.find('input[name="originalName"]').val(e),o.prepend(n.load(function(){s.initJcrop($(this),a)}))}),s.avatarUploadPreModal.modal("show")):(t=i.data.errors,$.each(t,function(t,e){s.topAlert.warningBlock(e)}))},error:function(t){413===t.status&&s.topAlert.warningBlock("The maximum allowed file size is 10 MB.")},complete:function(t){s.avatar.spin("disable")}})))},List.prototype.avatarCropFormSubmitHandler=function(){var n,a=this,e=a.avatarCropForm.find('button[type="submit"]'),t={url:a.avatarCropForm.attr("action"),beforeSend:function(){e.spin("enable"),a.avatar.spin("enable","",{shadow:!0,top:"-2",left:"1"}),n=a.avatar.css("background-image"),a.avatar.css("background-image","none")},success:function(t){var e;t.success?(a.avatarUploadPreModal.modal("hide"),(e=t.data.newPath)&&(a.avatarLabel.addClass("hidden"),a.avatar.css("background-image","url("+e+")")),a.topAlert.successBlock(t.message),a.resetImageForms(),a.toggleAvatarState(!0)):(t.data&&(e=t.data.errors||{},$.each(e,function(t,e){a.topAlert.warningBlock(e)})),a.avatar.css("background-image",n))},error:function(t){console.warn(t)},complete:function(t){e.spin("disable"),a.avatar.spin("disable")}};a.avatarCropForm.ajaxForm().ajaxSubmit(t)},List.prototype.avatarRemoveHandler=function(){var a,i=this;$.confirm({title:"Remove avatar",message:"Are you sure you would like to remove list's avatar?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Remove",class:"btn btn-danger",click:function(){var e=this,n=$(this).find("button.btn-danger");n.spin("enable","Removing...");$.ajax({url:i.options.commandUrl,dataType:"JSON",method:"POST",data:{cmd:"removeAvatar",lid:i.listid},beforeSend:function(){i.avatar.spin("enable","",{shadow:!0,top:"-2",left:"1"}),a=i.avatar.css("background-image")},success:function(t){t.success?(i.avatar.css("background-image","none"),i.avatarLabel.removeClass("hidden"),i.topAlert.successBlock(t.message),i.toggleAvatarState(!1)):(t=t.data.errors,$.each(t,function(t,e){i.topAlert.warningBlock(e)}),i.avatar.css("background-image",a))},error:function(t){console.warn(t)},complete:function(t){i.avatar.spin("disable"),n.spin("disable"),$(e).modal("hide")}})}}}})},List.prototype.toggleAvatarState=function(t){this.avatarControl.html(t?'<a href="javascript:void(0);" class="avatar-overlay dropdown" data-toggle="dropdown"><i class="fa tmi30-camera"></i></a><ul class="dropdown-menu text-left"><li><a href="javascript:void(0);" data-widget="change-avatar" title="Upload contact\'s profile photo"><i class="fa tmi30-arrow-upload tmi30-10px"></i>Upload a new avatar</a></li><li><a href="javascript:void(0);" data-widget="remove-avatar" title="Remove contact\'s profile photo"><i class="fa tmi30-trash tmi30-12px"></i>Remove avatar</a></li></ul>':'<a href="javascript:void(0);" class="avatar-overlay" data-widget="change-avatar"><i class="fa tmi30-camera"></i></a>')},List.prototype.initJcrop=function(t,e){var n=t.get(0).naturalWidth,a=t.get(0).naturalHeight;t.Jcrop({aspectRatio:1,minSize:[50,50],bgColor:"#666",bgOpacity:.5,allowSelect:!1,onSelect:function(t){e.find('[name="x1"]').val(t.x),e.find('[name="y1"]').val(t.y),e.find('[name="x2"]').val(t.x2),e.find('[name="y2"]').val(t.y2)},setSelect:[0,0,1e4,1e4],trueSize:[n,a]})},List.prototype.exportContactsBtnClickHandler=function(t,e){500<t?$.confirmDefferedExport(e):(t=$('meta[name="csrf-token"]').attr("content"),window.location=e.exportLnk.attr("href")+"&_csrf_token="+encodeURIComponent(t))},function(t){this.crudApi=null,this.init(t)}),SelectList=(ListFilter.prototype.initCrudApi=function(){if(1===this.ci)return!1;var n=this;this.crudApi=$.prepareCrudPage({containerSelector:"#lists-filter-content",itemSelector:'tr[data-widget="list-filter"]',paginationCommand:n.options.paginationCommand,paginationScroll:n.options.paginationScroll,searchFormSelector:"#lists-filter-search",commandUrl:n.options.commandUrl,afterReloadFunction:function(){$(this.itemSelector).on("click",function(t){n.tableCheckboxClickHandler(this)}),n.checkButtonsEnabled()},topCheckboxChangeFunction:function(t){$(t).is(":checked")?$(this.itemSelector).each(function(){var t=parseInt($(this).attr("data-hidden")),e=$(this).data("id");n.crudApi.addCheckedItems([e]),n.manageItem(e,t,!0)}):($(this.itemSelector).each(function(){var t=parseInt($(this).attr("data-hidden")),e=$(this).data("id");n.crudApi.removeCheckedItems([e]),n.manageItem(e,t,!1)}),n.crudApi.setCheckedAllItems(!1)),n.checkButtonsEnabled()}}),this.ci=1},ListFilter.prototype.tableCheckboxClickHandler=function(t){var e=$(t).find('input[type="checkbox"]').is(":checked"),n=parseInt($(t).attr("data-hidden")),t=$(t).attr("data-id");this.manageItem(t,n,e),this.checkButtonsEnabled()},ListFilter.prototype.manageItem=function(t,e,n){t=parseInt(t),e?n?this.unvisibleItems.pushOnce(t):this.unvisibleItems.popAll(t):n?this.visibleItems.pushOnce(t):this.visibleItems.popAll(t)},ListFilter.prototype.checkButtonsEnabled=function(){0===this.unvisibleItems.length?this.unhideBtn.addClass("disabled"):this.unhideBtn.removeClass("disabled"),0===this.visibleItems.length?this.hideBtn.addClass("disabled"):this.hideBtn.removeClass("disabled")},ListFilter.prototype.init=function(t){var e=this;this.ci=0,this.unvisibleItems=[],this.visibleItems=[],this.mainCrudApi=t.mainCrudApi,this.showFilterBtn=$("#filter-group"),this.hideBtn=$('[data-widget="hide"]'),this.singleHideBtn='[data-widget="single-hide"]',this.unhideBtn=$('[data-widget="show"]'),this.unhideAllBtn=$('[data-widget="show-all"]'),this.filterModal=$("#filterGroupModal"),this.hiddenCounter=$("#hidden-counter"),this.topAlert=$('[data-widget="top-alert"]'),this.options=$.extend({},{paginationCommand:"tableFilter",paginationScroll:!1},t),this.filterModal.on("show.bs.modal",function(){e.crudApi.getPaginationApi().reload()})},ListFilter.prototype.renderHiddenCount=function(){var t=this;this.hiddenCounter.load("/online/messages/lists/ajaxcount-hidden",function(){parseInt($(this).text())?t.unhideAllBtn.removeClass("disabled"):t.unhideAllBtn.addClass("disabled")})},ListFilter.prototype.hideBtnClickHandler=function(e){var n=this;e=e||this.crudApi.getCheckedItems(),$.ajax({url:n.options.commandUrl,type:"POST",data:{cmd:"hideItems",ids:e},dataType:"JSON",beforeSend:function(){n.hideBtn.spin("enable"),n.unhideBtn.addClass("disabled"),n.unhideAllBtn.addClass("disabled")},complete:function(){n.hideBtn.spin("disable"),n.unhideBtn.removeClass("disabled"),n.unhideAllBtn.removeClass("disabled")},success:function(t){n.crudApi.setCheckedItems([]),n.unvisibleItems=[],n.visibleItems=[],n.crudApi.getPaginationApi().reload(),n.filterModal.modal("hide"),n.renderHiddenCount(),n.mainCrudApi.setCheckedItems([]),n.mainCrudApi.getPaginationApi().reload(),n.topAlert.successBlock(1<e.length?"Lists has been successfully hidden.":"List has been successfully hidden.")},error:function(t){console.log(t)}})},ListFilter.prototype.unhideBtnClickHandler=function(t){var e=this,n={cmd:"unhideItems",ids:t=t||this.crudApi.getCheckedItems()};"all"===t&&(n.all=!0),$.ajax({url:e.options.commandUrl,type:"POST",data:n,dataType:"JSON",beforeSend:function(){"all"===t?(e.unhideAllBtn.spin("enable"),e.unhideBtn.addClass("disabled")):(e.unhideBtn.spin("enable"),e.unhideAllBtn.addClass("disabled")),e.hideBtn.addClass("disabled")},complete:function(){("all"===t?e.unhideAllBtn:e.unhideBtn).spin("disable"),e.unhideAllBtn.removeClass("disabled"),e.hideBtn.removeClass("disabled")},success:function(t){e.crudApi.setCheckedItems([]),e.unvisibleItems=[],e.visibleItems=[],e.crudApi.getPaginationApi().reload(),e.filterModal.modal("hide"),e.renderHiddenCount(),e.mainCrudApi.getPaginationApi().reload()},error:function(t){console.log(t)}})},function(t){this.init(t)}),MessagePreview=(SelectList.prototype.init=function(t){var a=this;this.options=$.extend({},{containerSelector:"#select-lists-content",paginationCommand:"tableSelectGroup",paginationScroll:!1,commandUrl:"/online/messages/lists/ajax",itemSelector:"tr[data-widget=select-list]",searchFormSelector:"#select-lists-search",checkboxChangeFunction:function(t){var e=$(t).closest("tr").data("id"),n=a.crudApi.getOptions().itemSelector;void 0===window.checkedData&&(window.checkedData=[]),$(t).is(":checked")?(a.crudApi.addCheckedItems([e]),window.checkedData.push($(t).closest("tr").data())):!0===a.crudApi.getCheckedAllItems()?(a.crudApi.setCheckedAllItems(!1),a.crudApi.setCheckedItems([]),window.checkedData=[],$(n).each(function(){$(this).find('input[type="checkbox"]').is(":checked")&&(a.crudApi.addCheckedItems([$(this).data("id")]),window.checkedData.pushOnce($(this).data()))})):(a.crudApi.removeCheckedItems([e]),window.checkedData.popAll($(n+'[data-id="'+e+'"]').data())),a.toggleAddButton(),this.togglePager()},topCheckboxChangeFunction:function(t){var t=$(t).is(":checked"),e=a.crudApi.getOptions().itemSelector,t=(t?$(e).each(function(){void 0===window.checkedData&&(window.checkedData=[]),a.crudApi.addCheckedItems([$(this).data("id")]),window.checkedData.pushOnce($(this).data())}):(void 0===window.checkedData&&(window.checkedData=[]),$(e).each(function(){a.crudApi.removeCheckedItems([$(this).data("id")]),window.checkedData.popAll($(this).data())}),a.crudApi.setCheckedAllItems(!1)),null);a.crudApi.getCheckedAllItems()&&(e=a.crudApi.getOptions().containerSelector,t=parseInt($(e).find("[data-crud-export-count]").attr("data-crud-export-count"))),a.toggleAddButton(t),this.togglePager()},selectAllFunction:function(t){window.checkedData=[],a.crudApi.setCheckedAllItems(!0),a.crudApi.setCheckedItems([]),this.togglePager()},getItemsCount:function(){return a.crudApi.getCheckedItems().length}},t),this.topAlert=$('[data-widget="top-alert"]'),this.modalGroups=$("#groupsModal"),this.btnAdd=this.modalGroups.find("#addGroupsButton"),this.getItemsCount=a.options.getItemsCount,this.initCrudApi()},SelectList.prototype.initCrudApi=function(){this.crudApi=$.prepareCrudPage(this.options)},SelectList.prototype.modalGroupsHiddenHandler=function(t){this.modalGroupsReset(this,t)},SelectList.prototype.modalGroupsReset=function(t,e){e=$(e).find("input[name=search-query]");""!=e.val()&&e.val("").change(),t.crudApi.setCheckedAllItems(!1),t.crudApi.setCheckedItems([]),window.checkedData=[],t.crudApi.getPaginationApi().setOptions({page:1}),t.crudApi.getPaginationApi().reload(),this.toggleAddButton()},SelectList.prototype.toggleAddButton=function(t){var t=t||this.getItemsCount(),e=$("span.plural",this.btnAdd),t=parseInt(t);e.text(1===t?"":"s"),1<=t?this.btnAdd.enableButton():this.btnAdd.disableButton(),"function"==typeof $.fn.format&&(t=$.fn.format(t)),$("span.value",this.btnAdd).text(t)},SelectList.prototype.handleBulkItemsAdd=function(n){var e=this,t=this.modalGroups.find('input[name="search-query"]').val();$.ajax({url:e.options.commandUrl,dataType:"JSON",method:"POST",data:{cmd:"prepareSendClick",format:"obj",text:t},beforeSend:function(){e.btnAdd.spin("enable")},success:function(t){t.success?(n.callbackAddGroup&&$.each(t.data.items,function(t,e){n.callbackAddGroup.func.apply(n.callbackAddGroup.context,[{groupId:e.id,name:e.name,count:e.members},!0])}),n.callbackTagEdit&&n.callbackTagEdit()):e.topAlert.warningBlock(t.message)},error:function(t){console.warn(t)},complete:function(t){e.btnAdd.spin("disable")}})},function(t){t=$.extend({},{showPrevNextBar:!0,forcedSingleMessage:!1},t);this.init(t)}),modeSchedule=(MessagePreview.prototype.init=function(t){var e=this;this.previewModal=$("#messagePreviewModal"),this.previewModalTable=$("#message-preview-table-content table"),this.forced=!1,this.topAlert=$("#message-new-alert"),this.totalRecipients=$('[data-widget="total-recipients"]'),this.forcedAlert=$('[data-widget="forced-alert"]'),this.previewPrevNextBar=$('[data-widget="preview-prev-next-bar"]'),this.previewPreviousBtn=$('[data-widget="preview-prev"]'),this.previewNextBtn=$('[data-widget="preview-next"]'),this.senderId=$('[data-widget="sender-id"]'),this.recipient=$('[data-widget="recipient"]'),this.messageText=$('[data-widget="message-text"]'),this.totalChars=$('[data-widget="total-chars"]'),this.totalParts=$('[data-widget="total-parts"]'),this.singleCost=$('[data-widget="single-cost"]'),this.totalCost=$('[data-widget="total-cost"]'),this.totalCostRow=$('[data-widget="total-cost-row"]'),this.approxWarning=$('[data-widget="approx-warning"]'),this.approxPrefix=$('[data-widget="approx-prefix"]'),this.parentApprox=$(".approximately"),this.confirmBtn=$('[data-widget="confirm-send"]'),this.sendingForm=$("#formNewMessage"),this.previewData=[],this.msgIndex=0,this.routes={send:"/online/messages/send"},this.previewPreviousBtn.on("click.preview",function(){e.prevBtnClickHandler()}),this.previewNextBtn.on("click.preview",function(){e.nextBtnClickHandler()}),this.confirmBtn.on("click.preview",function(){e.confirmBtnClickHandler()}),t.showPrevNextBar||this.previewPrevNextBar.hide(),this.forcedSingleMessage=t.forcedSingleMessage},MessagePreview.prototype.previewBtnClickHandler=function(t,e){var i=this,o=$(t.target),t=(t.preventDefault(),t.hasOwnProperty("source")||"chat"==t.source),n=$.extend({},e,{preview:!0}),e=[{key:"message",text:"Please enter a message.",hasViolation:0==e.message.text.trim().length}];if(0<(e=e.filter(function(t){return t.hasViolation})).length)return showFormErrors(e.reduce(function(t,e){return t[e.key]=e.text,t},{length:e.length})),!1;o.spin("enable"),t&&(i.previewModal.modal("show"),i.previewModalTable.hide());e={data:n,url:this.routes.send,dataType:"JSON",type:"POST",success:function(t,e,n,a){o.spin("disable"),$(".form-group").removeClass("has-error"),$(".error").remove(),t.success?t.data.hasOwnProperty("previewData")&&(i.setPreviewData(t.data.previewData),i.updateModalTable(),i.previewModalTable.show(),i.previewModal.modal("show")):(t.message.alert&&(i.topAlert.warningBlock(t.message.alert),scrollToView(i.topAlert)),$.each(t.message,function(t,e){if("alert"==t)return!0;t=$("#"+t+"-group");t.find(".input-control").parent().after("<span class='error help-block'>"+e+"</span>"),t.addClass("has-error")}))},error:function(){return o.spin("disable"),!1}};return $.ajax(e)},MessagePreview.prototype.setPreviewData=function(t){this.previewData=t,this.msgIndex=0},MessagePreview.prototype.updateModalTable=function(){this.updateNavigationButtons();var t=this.previewData.messages[this.msgIndex],e=this,n=(e.forced?(e.forcedAlert.show(),e.confirmBtn.show()):(e.forcedAlert.hide(),e.confirmBtn.hide()),e.senderId.text(/^\d+$/.test(t.from_number)?"+"+t.from_number:t.from_number),e.recipient.text(t.first_name==t.phone||null==t.first_name&&null==t.last_name?"+"+t.phone:(null==t.first_name?"":t.first_name)+" "+(null==t.last_name?"":t.last_name)+" (+"+t.phone+")"),e.messageText.text(t.text).html());e.messageText.html(this.linkify(n.replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1<br/>$2"))),e.totalChars.text(t.characters+" character"+(1!=t.characters?"s":"")),e.totalParts.text(t.parts_count+" part"+(1!=t.parts_count?"s":"")),e.singleCost.text(t.credits_price.toFixed(3)),e.approxPrefix.text(e.parentApprox.text().trim()),e.approxPrefix.text()?e.approxWarning.show():e.approxWarning.hide(),this.forcedSingleMessage&&this.totalCostRow.hide()},MessagePreview.prototype.updateNavigationButtons=function(){var t=this;t.msgIndex-1 in t.previewData.messages?t.previewPreviousBtn.removeClass("disabled"):t.previewPreviousBtn.addClass("disabled"),t.msgIndex+1 in t.previewData.messages?t.previewNextBtn.removeClass("disabled"):t.previewNextBtn.addClass("disabled")},MessagePreview.prototype.nextBtnClickHandler=function(){this.msgIndex+=1,this.updateModalTable()},MessagePreview.prototype.prevBtnClickHandler=function(){--this.msgIndex,this.updateModalTable()},MessagePreview.prototype.confirmBtnClickHandler=function(){this.previewModal.modal("hide"),this.sendingForm.submit()},!(MessagePreview.prototype.linkify=function(t){var e=" "+Math.random().toString(36).substr(2,10)+(new Date).getTime()+" ";return(t=t.split("&nbsp;").join(e)).replace(/(http:\/\/www\.|https:\/\/www\.|http:\/\/|https:\/\/)?[A-Za-z0-9\-]+([\-\.]{1}[A-Za-z0-9]+)*\.[A-Za-z]{2,4}(:[0-9]{1,5})?(\/[A-Za-z?=%0-9-_&~.+;:"']*){0,20}(\s*)/gim,function(e,t,n,a,i,o,s,r){if("@"===r.substr(s-1,1))return e;var d=!1;if(".gle|.ly|.page|.app|.biz|.bot|.com|.org|.net|.int|.edu|.gov|.mil|.au|.uk|.us|.jp|.cn|.ca|.ru|.ch|.de|.fr|.ee|.eg|.es|.fi|gr|.hr|.hu|.il|.in|.it|.kr|.kz|.nl|.no|.nz|.pr|.pt|.py|.sa|.se|.sg|.si|.sk|.th|.tr|.tt|.vn".split("|").map(function(t){-1<e.indexOf(t)&&(d=!0)}),!d)return e;r=e.trim(),s=(s="http"==r.substring(0,4)?r:"http://"+r).replace("<br/>",""),s='<a href="$1" target="_blank">$2</a>'.replace("$1",s).replace("$2",r);return null==o?s:s+o}).replace(/(([a-zA-Z0-9\+\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,10})+)/gim,'<a href="mailto:$1">$1</a>').split(e).join("&nbsp;")})),paginationCommand="tableSelectTemplate",paginationScroll=!0,forcePreview=!1,ForwardingSettings=($(document).ready(function(){app.forwardAudioId=null;var n,t="/online/messages/lists/ajax",F="/online/messages/success",s="/online/messages/schedulesuccess",e="/online/messages/send",O="/online/messages/new",o={dropdown:$('[data-widget="schedule-time"]'),hours:$('[data-widget="schedule-time-hours"]'),minutes:$('[data-widget="schedule-time-minutes"]'),ampm:$('[data-widget="schedule-ampm"]')},R="1"==$("#scheduleStartDate").data("ampm");function a(t){t=String(t);return t=1===t.length?"0"+t:t}function i(t,e){this.self=$(".fuelux-select-replacer",t),this.dropdown=this.self.prev(".dropdown-menu").find("li"),this.list=[],this.options=[],this.dataAttr=e||"name"}o.hours.on("blur",function(){R?/^(0?[1-9]|1[0-2])?$/.test($(this).val())||$(this).val("12"):/^([0-1]?[0-9]|2[0-3])?$/.test($(this).val())||$(this).val("00"),v()}),o.minutes.on("blur",function(){/^([0-5][0-9])(:[0-5][0-9])?$/.test($(this).val())||$(this).val("00"),v()}),o.ampm.on("change",function(){v()}),Date.prototype.toRruleString||(Date.prototype.toRruleString=function(){return this.getUTCFullYear()+a(this.getUTCMonth()+1)+a(this.getUTCDate())+"T"+a(this.getUTCHours())+a(this.getUTCMinutes())+a(this.getUTCSeconds())+"Z"}),c=new Date("2011-06-02T09:34:29+02:00"),Date.fromISO=c&&1307000069e3==+c?function(t){return new Date(t)}:function(t){var e,t=/^(\d{4}\-\d\d\-\d\d([tT ][\d:\.]*)?)([zZ]|([+\-])(\d\d):(\d\d))?$/.exec(t)||[];if(t[1]){for(var n,a=0,i=(n=t[1].split(/\D/)).length;a<i;a++)n[a]=parseInt(n[a],10)||0;return(--n[1],(n=new Date(Date.UTC.apply(Date,n))).getDate())?(t[5]&&(e=60*parseInt(t[5],10),t[6]&&(e+=parseInt(t[6],10)),"+"==t[4]&&(e*=-1),e&&n.setUTCMinutes(n.getUTCMinutes()+e)),n):NaN}return NaN},i.prototype.init=function(){var i=this;i.dropdown.each(function(){var t=$(this).data("tzid"),e=$(this).data("name"),n=$(this).data("offset"),a=void 0!==app.data.tzid&&app.data.tzid===e||void 0===app.data.tzid&&app.data.userTimeZone.name===e?'selected="selected"':"";i.options.push('<option value="'+e+'" data-offset="'+n+'" data-tzid="'+t+'" '+a+">"+e+"</option>")}),i.self.empty().append(i.options.join("")),i.self.on("change",function(){var t=this.value,e=i.self.find("option:selected").data("tzid");n=e,i.self.parent().select("selectBySelector","[data-"+i.dataAttr+'="'+t+'"]')}),$.fn.chosen&&i.self.chosen({width:"22.3em",search_contains:!0}),i.self.change()},new i(".scheduler-timezone").init();function r(){var c=l.getOptions();$(".messages-costs").spin("enable"),c.$counter.spin("enable"),$("#recipients-group").removeClass("has-error").find("span.error.help-block").remove(),m(),app.ajaxRequests.push({url:"/online/messages/price",xhr:$.ajax({type:"POST",url:"/online/messages/price",data:A(),success:function(t){$(".messages-costs").spin("disable"),c.$counter.spin("disable"),u.msgCount({smsLeft:6,msgFormat:"Unicode",rate:t.data.prices,lowBalanceCallback:Y,counterUpdated:L});var e,n=t.data.prices,a=0,i=0;for(e in app.data.recipientsCountries=[],n)n.hasOwnProperty(e)&&(app.data.recipientsCountries.push(e),a+=parseInt(n[e].count),i+=parseInt(n[e].landline));S(u.val()),function(t){var e=$('[data-widget="ca-recipients-warning"]');if(t.CA&&500<=t.CA.count)return e.show();e.hide()}(n),c.$counter.text(a),0<i&&"disable"==app.data.userTextToSpeech?$('div[data-msg-landline="newMsgText"]').show().find("strong").text(i):$('div[data-msg-landline="newMsgText"]').hide(),p();var o=a,s=$('[data-widget="bulk-warning"]'),r=$("#messagePreviewBtn"),d=$("#sendNowBtn"),l=$("#sheduleNowBtn");100<o?(s.show(),r.addClass("hidden"),d.add(l).removeClass("btn-success").addClass("btn-default message-preview-forced").html('<i class="fa tmi30-eye tmi30-12px"></i> Preview message'),forcePreview=!0):(s.hide(),r.removeClass("hidden"),d.add(l).addClass("btn-success").removeClass("btn-default message-preview-forced").html('Schedule <i class="fa fa-caret-right"></i>').data("widget",""),d.html('Send <i class="fa fa-caret-right"></i>'),forcePreview=!1);o=a,0!==(s=$('[data-widget="message-preview"]')).length&&(0<o&&0<u.val().trim().length?s.removeClass("disabled"):s.addClass("disabled"));r=n;1e3<a&&(r.hasOwnProperty("US")&&0<r.US.count||r.hasOwnProperty("CA")&&0<r.CA.count)?$('[data-widget="unverified-tollfree-alert"]').show():$('[data-widget="unverified-tollfree-alert"]').hide();c.callbackReady(t)},dataType:"json"})})}function d(){Cookies.remove("messageDraft",{domain:app.getCookieDomain()})}var l,u=$("#newMsgText"),c=$("#editTmplText"),h=(0<u.length&&u.is("textarea")&&u.tagsField({tags:app.data.tagsValid,add_tag_link_selector:"a.add-tag-link",approximately_selector:"span.approximately",afterInsert:function(t){u.trigger("input.count").trigger("input.preview")}}),u.off("change.replaceTabs").on("change.replaceTabs",function(){u.val(u.val().replace(/(\t|\r)/g," ")),u.trigger("input.count")}),u.off("changed.preview input.preview").on("changed.preview input.preview",function(){var t=$('[data-widget="message-preview"]'),e=$('[data-tags-count="newMsgRecipient"]').text();0<u.val().trim().length&&e&&0<parseInt(e,10)?t.removeClass("disabled"):t.addClass("disabled")}),u.on("keyup",function(){S($(this).val())}),u.on("change",function(){S($(this).val())}),0<c.length&&c.tagsField({tags:app.data.tagsValid,add_tag_link_selector:"a.template-add-tag-link",afterInsert:function(t){$("#editTmplText").trigger("input.count")}}),$("#reset-recipients").on("click",function(){$(".input-control .tag-item").each(function(t,e){app.apiRecipientTags.removeRecipient(e)}),app.apiRecipientTags.getOptions().$counter.text(0),app.apiRecipientTags.getOptions().callbackRemove()}),"#copy-tag-phones"),U=$("#recipients-group").find(".tags-block"),p=("function"==typeof Clipboard&&(h=new Clipboard(h,{text:function(t){var a=[];return U.find(".tag-item").each(function(t,e){var n=$(e).find(".hint"),n=0!==n.length&&n.text().match(/\+[0-9]+/g)?n.text().match(/\+[0-9]+/g):$(e).clone().children().remove().end().text();n&&a.push($.trim(n))}),a.join("\n")}}),C=function(e){return function(t){e=e||$(t.trigger),t.clearSelection(),e.blur().tooltip("destroy").tooltip({trigger:"manual",container:"#recipients-group .editable-info-bar"}).tooltip("show"),setTimeout(function(){e.tooltip("hide")},2e3)}},0<$("#recipientsDropdown").length?h.on("success",C($("#recipientsDropdown"))):h.on("success",C())),function(){var t=$('[data-msg-voice-countries="newMsgText"]');if(""!==$("select#newMsgFrom").val())t.hide();else{var e=Object.keys(app.data.ssiUnusedVoiceCountries),n=app.data.recipientsCountries.filter(function(t){return-1!=e.indexOf(t)});if(0==n.length)t.hide();else{var a,i=3<n.length?n.length-3:0,o=(0==i?t.find("span.other-countries").hide():(1==i?t.find("span.other-countries-word").text(" country"):t.find("span.other-countries-word").text(" countries"),t.find("span.other-countries").show(),t.find("strong.other-countries-count").text(i)),n.slice(0,3)),s=" ";for(a in o)o.hasOwnProperty(a)&&(s=s+' <strong class="">'+app.data.ssiUnusedVoiceCountries[o[a]]+"</strong>,");s=s.substring(0,s.length-1),t.find("span.countries-tag").html(s),t.show()}}}),m=($("select#newMsgFrom").change(p),function(){if(-1!==["survey"].indexOf(currentPage))return!1;d();var t=A();t.message.text=encodeURIComponent(t.message.text),Cookies.set("messageDraft",t,{expires:7,domain:app.getCookieDomain()})});function f(t,e){var n,a,i=!1;function o(){if(i)return n=arguments,void(a=this);t.apply(this,arguments),i=!0,setTimeout(function(){i=!1,n&&(o.apply(a,n),n=a=null)},e)}return o}function g(t){t=b(t);return t.hours+":"+t.minutes+" "+t.ampm}function b(t){var e=t.getHours(),t=t.getMinutes(),n=12<=e?"PM":"AM";return{hours:e=(e%=12)||12,minutes:t=t<10?"0"+t:t,ampm:n}}function y(){var t,e=function(){var t=new Date;t.getMinutes()<30?t.setMinutes(0):t.setMinutes(30);return new Date(t.getTime()+18e5)}();"1"==$("#scheduleStartDate").data("ampm")?(t=b(e),o.dropdown.val(g(e)),o.dropdown.blur(),o.hours.val(t.hours),o.minutes.val(t.minutes),o.ampm.val(t.ampm)):(t=e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes(),e=e.getHours()<10?"0"+e.getHours():e.getHours(),o.dropdown.val(e+":"+t),o.dropdown.blur(),o.hours.val(e),o.minutes.val(t))}function v(){var t=o.hours.val()+":"+o.minutes.val();/^([0-1]?[0-9]|2[0-3]):([0-5][0-9])(:[0-5][0-9])?$/.test(t)?"1"==$("#scheduleStartDate").data("ampm")?o.dropdown.val(t+" "+o.ampm.val()):o.dropdown.val(t):o.dropdown.val("00:00"),o.dropdown.blur(),o.dropdown.trigger("change")}"undefined"!=typeof currentPage&&("edit-distribution-list"!=currentPage&&"edit-schedule"!=currentPage||(m=function(){return!1}),"voice-broadcast"==currentPage&&(m=function(){var t=Cookies.get("messageDraft"),e=A();t?(console.log(t),(t=$.parseJSON(t)).message.text&&-1!==t.message.text.indexOf("<audio")?e.message.text=t.message.text:e.message.text=""):e.message.text="",d(),Cookies.set("messageDraft",e,{expires:7,domain:app.getCookieDomain()})}),"voice-broadcast"!=currentPage&&"text-to-speech"!=currentPage&&(p=function(){return!1})),"automation"!=currentPage&&(l=$("#newMsgRecipient").recipientsTag({recipients:app.data.contacts,country:app.data.userCountry,$counter:$('[data-tags-count="newMsgRecipient"]'),callbackAdd:f(r,1e3),callbackRemove:f(r,1e3)}),r(),app.apiRecipientTags=l),u.msgCount({smsLeft:6,msgFormat:"Unicode",rate:{},lowBalanceCallback:Y,counterUpdated:L}),c.msgCount({smsLeft:6,msgFormat:"Unicode",rate:{},counterUpdated:L}),y(),$("#scheduleStartDate").val($("#scheduleStartDate").data("value")),$('input[data-widget="schedule-time"]').prop("readonly","readonly"),$("#scheduleStartDate").prop("readonly","readonly"),$("input.spinner-input").on("keydown.spinnerInput",function(t){if(t.ctrlKey||t.altKey||47<t.keyCode&&t.keyCode<58&&0==t.shiftKey||95<t.keyCode&&t.keyCode<106||8==t.keyCode||9==t.keyCode||34<t.keyCode&&t.keyCode<40||46==t.keyCode)return!0;t.preventDefault()});var w=new SelectList,k=(w.modalGroups.on("hidden.bs.modal",function(){w.modalGroupsHiddenHandler(this)}),w.btnAdd.on("click",function(t){var e=w.crudApi.getOptions();$(e.containerSelector);t.preventDefault(),!0===w.crudApi.getCheckedAllItems()?w.handleBulkItemsAdd({callbackAddGroup:{context:l,func:l.addContact},callbackTagEdit:function(){r(),w.modalGroups.modal("hide")}}):($.each(checkedData,function(t,e){void 0!==e&&0<e.members&&l.addContact({groupId:e.id,name:e.name,count:e.members},!0)}),r(),w.modalGroups.modal("hide"))}),new List({commandUrl:t}),new SelectContact),h=(k.btnLetter.click(function(t){t.preventDefault(),k.btnLetterClickHandler($(this))}),k.btnAdd.on("click",function(t){var e=k.crudApi.getOptions();$(e.containerSelector);t.preventDefault(),!0===k.crudApi.getCheckedAllItems()||100<k.crudApi.getCheckedItems().length?k.sendCheckedItemsHandler(function(t,e){if(e&&"cancel"==e)return k.crudApi.setCheckedItems([]),void k.toggleAddButton(0);t&&l.addContact({groupId:t.group_id,name:"Custom list",count:t.processed||t.members||null},!0),r(),k.modalAddressBook.modal("hide")}):($.each(checkedData,function(t,e){void 0!==e&&l.addContact({contactId:e.id,name:e.name,phone:new String(e.phone)},!0)}),r(),k.modalAddressBook.modal("hide"))}),k.modalAddressBook.on("hidden.bs.modal",function(){k.modalAddressBookHiddenHandler(this)}),document.addEventListener("contact.add",function(t){0<k.lnkNewMsgAddContacts.length&&"#addContactWayModal"===k.lnkNewMsgAddContacts.attr("href")&&(k.lnkNewMsgAddContacts.attr("href","#addressBookModal"),k.crudApi&&k.crudApi.getPaginationApi()&&k.crudApi.getPaginationApi().reload())},!1),$(document).off("click",'[data-widget="new-message-row"]').on("click",'[data-widget="new-message-row"]',function(){var t=$(this).closest("tr").data("id"),e=$("#templatesTable").find("tr").filter(function(){return this.getAttribute("data-id")===t+""}).find("[data-content-body]").data("content-body");u.textAtCaret(e).change().blur().trigger("input.count").trigger("input.preview")}),$("#recently-drop-down").click(function(){var e;app.data.recentlySent||((e=$(this).next()).empty().append("<li></li>").find("li").append('<a href="#" class="recently-contact">&nbsp; </a>').find("a").spin("enable"),app.ajaxRequests.push({url:"/online/messages/recently-sent",xhr:$.ajax({type:"POST",url:"/online/messages/recently-sent",data:{},success:function(t){t=t.data.recentlySent;if(0===(app.data.recentlySent=t).length)return e.empty(),void e.append('<li role="presentation" class="text-muted text-center info-item">No recipients</li>');e.empty(),e.append(t.map(function(t){return"string"==typeof t?'<li><a href="#" class="recently-contact" '+('data-phone="'+t+'" data-contact-id="false" data-first-name="false" data-last-name="false"')+">"+t+"</a></li>":"object"==typeof t?(t.firstName=null===t.firstName?"":t.firstName.replace("null","").trim(),t.lastName=null===t.lastName?"":t.lastName.replace("null","").trim(),'<li><a href="#" class="recently-contact" '+('data-phone="'+t.phone+'" data-contact-id="'+t.id+'" data-first-name="'+t.firstName+'" data-last-name="'+t.lastName+'"')+">"+t.firstName+" "+t.lastName+"</a></li>"):void 0}))},dataType:"json"})}))}),$(document).on("click","a.recently-contact",function(t){t.preventDefault();t=$(this).data();!1!==t.contactId?l.addContact({contactId:t.contactId,name:t.firstName+" "+t.lastName,phone:new String(t.phone)}):l.addContact({phone:new String(t.phone)})}),$("#sheduleBlock").find(".datepicker")),C=h.first().find("input"),c=h.last().find("input"),t=new Date,h=(new Date).addDays(1),x=("function"==typeof t.format&&(C.bootstrapDP("update",t.format("d mmm yyyy")),c.bootstrapDP("setDate",h),c.bootstrapDP("update",h.format("d mmm yyyy")),c.val(h.format("d mmm yyyy"))),$("#message-new-alert"));function A(){var t={schedule:{mode:modeSchedule,params:q(),tzid:n},message:{text:$(".new-message-text").val()},from:$("#newMsgFrom").val(),serviceType:$("input[name=serviceType]").val(),audioId:app.forwardAudioId};return"automation"!=currentPage&&(t.recipients={groups:l.getGroups(),contacts:l.getContacts(),numbers:l.getPhones()}),t}function S(t){var e=$('[data-widget="shortener-warning"]');if(void 0!==app.data.shorteners_domain_to_avoid&&0<app.data.shorteners_domain_to_avoid.length&&0<t.length&&("automation"===currentPage&&"undefined"!=typeof automation&&automation.hasUsOrCaOrPrNumbers()||void 0!==app.data.recipientsCountries&&(-1<app.data.recipientsCountries.indexOf("US")||-1<app.data.recipientsCountries.indexOf("CA")||-1<app.data.recipientsCountries.indexOf("PR")))){var n=new RegExp("\\b"+app.data.shorteners_domain_to_avoid.join("\\b|\\b")+"\\b","gmi"),t=t.match(n);if(t&&0<t.length)return $('div[data-widget="shortener-warning"] .shortener-warning-host').text(t[0].toLowerCase()),void e.show()}e.hide()}window.getSubmitData=A;function I(t){$('#sendNowBtn, [data-widget="confirm-send"]').spin("enable","Sending..."),$("#sheduleNowBtn").spin("enable","Scheduling...");var o=!1,e={data:A(),dataType:"JSON",beforeSubmit:function(){x.hide(),x.html(""),o=!1,$(".form-group").removeClass("has-error"),$(".error").remove()},success:function(e,t,n,a){if(e.success){var i=F;if(d(),void 0!==e.data.redirect&&e.data.redirect)return window.location.href=e.data.redirect_url,!0;e.data.schedule&&(i=s),void 0!==e.data.id?$(".content-new-message").load(i,{session:e.data.id},function(){var t=window.location.pathname+"?session_id="+e.data.id;$('#sendNowBtn, [data-widget="confirm-send"]').spin("disable"),$("#resend-message-btn").attr("href",t)}):e.data.schedule&&$(".content-new-message").load(i,{event:e.data.event},function(){$('#sendNowBtn, [data-widget="confirm-send"]').spin("disable")}),replaceTagsInTables(".has-replaceable-tags")}else void 0!==e.data.removeDraft&&e.data.removeDraft&&d(),e.message.alert&&($("#message-new-alert").warningBlock(e.message.alert),$("div.alert-bar").hide(),scrollToView("#message-new-alert")),$.each(e.message,function(t,e){if("alert"==t)return!0;t=$("#"+t+"-group");t.find(".input-control").parent().after("<span class='error help-block'>"+e+"</span>"),t.addClass("has-error")}),$('#sendNowBtn, [data-widget="confirm-send"]').spin("disable"),$("#sheduleNowBtn").spin("disable");o=!1},error:function(){$('#sendNowBtn, [data-widget="confirm-send"]').spin("disable"),$("#sheduleNowBtn").spin("disable")}};return t.preventDefault(),o||$("#formNewMessage").ajaxSubmit(e),!1}window.showFormErrors=function(t){$(".form-group").removeClass("has-error"),$(".error").remove(),$.each(t,function(t,e){if("alert"==t)return!0;t=$("#"+t+"-group");t.find(".input-control").parent().after("<span class='error help-block'>"+e+"</span>"),t.addClass("has-error")})};var T,D,B,M,N,E,P,_,Y=function(t){$("#form_price").val(t.id),app.data.notEnoughMoney=!0},L=function(t){t.msgCurr>t.msgMax?$('[data-widget="too-long-message"]').show():$('[data-widget="too-long-message"]').hide()};function H(t){t=$(t);i=app.data.ics,n=i.recurrencePattern,a=/UNTIL=(\d+)T(\d+)Z/,(e=n.match(a))&&(n=n.replace(a,"UNTIL="+e[1]+";")),i.recurrencePattern=n,app.isIeOrSafari()&&-1===i.startDateTime.indexOf("Z")&&(a=(a=i.startDateTime).substr(0,a.length-2)+":"+a.substr(a.length-2),i.startDateTime=a);var e=i,n=(t.scheduler("value",e),app.data.ics.startDateTime);void 0!==app.data.nextSend&&app.data.nextSend&&(n=app.data.nextSend),n=-1!==(n=app.isIeOrSafari()?n:n.replace("T"," ")).indexOf("Z")?n.replace("Z",""):n.replace(/([-+\s]\d{2}:?\d{2}$)/,""),e=app.isIeOrSafari()?(a=(new Date).getTimezoneOffset(),i=Math.abs(a),a=(a<0?"+":"-")+("00"+Math.floor(i/60)).slice(-2)+":"+("00"+i%60).slice(-2),Date.fromISO(n+a)):new Date(n),console.log(n),console.log(e),"1"==$("#scheduleStartDate").data("ampm")?(i=b(e),o.dropdown.val(g(e)),o.hours.val(i.hours),o.minutes.val(i.minutes),o.ampm.val(i.ampm)):(o.hours.val(e.getHours()),o.minutes.val(e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes()),o.dropdown.val((e.getHours()<10?"0"+e.getHours():e.getHours())+":"+(e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes()))),o.dropdown.blur();var a=$("#scheduleEndDate").val().match(/(\d{2})-(\d{2})-(\d{4})/),i=(a&&(n=new Date(a[3],a[1]-1,a[2]),$("#scheduleEndDate").bootstrapDP("setDate",n),$("#scheduleEndDate").bootstrapDP("update",n.format("d mmm yyyy"))),$("#scheduleStartDate").bootstrapDP("setDate",e),$("#scheduleStartDate").bootstrapDP("update",e.format("d mmm yyyy")),app.data.ics.recurrencePattern);-1!==i.indexOf("BYDAY")&&(-1!==i.indexOf("BYMONTH")?$('[name="scheduler-year"]').trigger("click"):-1!==i.indexOf("BYDAY")&&$('[name="scheduler-month"]').trigger("click")),t.off("changed.editScheduled").on("changed.editScheduled",function(){var t=$("#sheduleBlock").scheduler("value").recurrencePattern.slice(0,-1).replace("BYDAY=;","");new RRule(RRule.parseString(t))})}function j(t,e){t.closest(".js-group-item").children('input:radio[name="newmsg-group"]').prop("checked",e).trigger("change")}function q(){if(0===$("#sheduleBlock").length||!$.isFunction($("#sheduleBlock").scheduler))return"";var t=$("#sheduleBlock").scheduler("value"),e=(e=t.recurrencePattern).replace("INTERVAL=0","INTERVAL=1"),n=/;UNTIL=(\d+)/,a=n.exec(e);if(!a||void 0===a[1])return t.recurrencePattern=e,t;a=(a=a[1]).substring(0,4)+"-"+a.substring(4,6)+"-"+a.substring(6,a.length)+"T23:59:59"+t.timeZone.offset,a=(a=app.isIeOrSafari()?Date.fromISO(a):new Date(a)).toRruleString();return e=e.replace(n,";UNTIL="+a),t.recurrencePattern=e,t}$("#formNewMessage").on("submit",function(t){$(this);return forcePreview?(t.preventDefault(),!1):app.data.showPaymentModal&&1==app.data.notEnoughMoney?($("#paymentModal").modal("show"),!1):I(t)}),$("#modalPayButton").click(function(e){$("#modalPayButton").spin("enable","Processing..."),$.ajax({url:"/payment",type:"POST",dataType:"JSON",data:$("#paymentModalForm").serializeJSON(),success:function(t){return $("#modalPayButton").spin("disable"),t.success?($("#paymentModal").modal("hide"),I(e)):t.data.redirect?($("#paymentModal").modal("hide"),$("div.alert-bar").hide(),app.data.showPaymentModal=!1,x.warningBlock(t.message.alert),void setTimeout($("#paymentModal").remove,500)):void(t.message.alert&&$("#payment-modal-alert").warningBlock(t.message.alert))},error:function(t){$("#modalPayButton").spin("disable"),$("#payment-modal-alert").warningBlock("There was an unexpected payment processing error. Please try again. If you are still unable to pay please contact us at support@textmagic.com.")}})}),$('[data-widget="validate-step-1"]').on("click",function(t){t.preventDefault();var i=$(this),t={data:$.extend({},A(),{validateOnly:!0}),url:e,dataType:"JSON",type:"POST",beforeSend:function(){x.hide(),i.spin("enable")},success:function(t,e,n,a){return $(".form-group").removeClass("has-error"),$(".error").remove(),i.spin("disable"),t.success?($("#add-details").removeClass("active"),$("#edit-occurrence").addClass("active"),H($("#sheduleBlock")),!0):($.each(t.message,function(t,e){t=$("#"+t+"-group");t.find(".input-control").parent().after("<span class='error help-block'>"+e+"</span>"),t.addClass("has-error")}),!1)},error:function(){return i.spin("disable"),!1}};return $.ajax(t)}),$('[data-widget="save-schedule"]').on("click",function(t){t.preventDefault();var i=$(this);modeSchedule=!0;t={data:$.extend({},A(),{oldIcsId:app.data.oldIcsId}),url:e,dataType:"JSON",type:"POST",beforeSend:function(){x.hide(),i.spin("enable")},success:function(t,e,n,a){return $(".form-group").removeClass("has-error"),$(".error").remove(),t.success?($(".content-new-message").load(s,{session:t.data.id,headless:!0},function(t){if(t.includes("<html>"))return window.location.href=O,!1;i.spin("disable"),$("#edit-occurrence").removeClass("active"),$("#finish-it").addClass("active")}),!0):(i.spin("disable"),void 0!==t.message.alert&&x.warningBlock(t.message.alert),$.each(t.data,function(t,e){t=$("#"+t+"-group");t.find(".input-control").parent().after("<span class='error help-block'>"+e+"</span>"),t.addClass("has-error")}),!1)},error:function(){return i.spin("disable"),!1}};$.ajax(t)}),"automation"!=currentPage&&$("#newMsgRecipient, #newMsgFrom, #newMsgText").on({focus:function(){j($(this),!0)},blur:function(){j($(this),!1),m()}}),T=$("#sheduleBlock"),D=$("#sheduleLaterBtn"),B=$("#sheduleCancelBtn"),M=$("#sendNowBtn"),N=$("#sheduleNowBtn"),E=$("#shedulePreviewBtn"),D.on("click",function(t){t.preventDefault(),T.fadeIn(300,function(){D.add(M).addClass("hidden"),B.add(N).removeClass("hidden"),E.removeClass("hidden")}),$('[data-widget="preview-action-name"]').text("Schedule"),modeSchedule=!0}),B.on("click",function(t){t.preventDefault(),T.fadeOut(300,function(){D.add(M).removeClass("hidden"),B.add(N).addClass("hidden"),E.addClass("hidden")}),$('[data-widget="preview-action-name"]').text("Send"),modeSchedule=!1}),P=$("#sheduleCalendar"),_=!1,$("#shedulePreviewModal").on({"show.bs.modal":function(){""==$('[data-widget="schedule-time"]').val().trim()&&y(),"undefined"==typeof AHServiceContainer||_?_.$forceUpdate():(P.get(0).classList.add("tm-calendar"),_=AHServiceContainer.get("Textmagic::CalendarBundle::AppPreview").run({user:app.data.user,el:P.get(0)}))}}),window.location.hash&&"schedule"==window.location.hash.substring(1)&&$("#sheduleLaterBtn").trigger("click");C=parseQuery(window.location.search);C.scheduleDate&&C.scheduleTime&&(t=parseQuery(window.location.search).scheduleTime.split(":"),o.hours.val(t[0]),o.minutes.val(t[1]),0<o.ampm.length&&C.scheduleAmPm&&o.ampm.val(C.scheduleAmPm),"Invalid Date"!==(c=new Date(parseQuery(window.location.search).scheduleDate)).toString()&&$("#scheduleStartDate").datepicker("setDate",c),v()),$(".year-month li > a").off("click.textmagic").on("click.textmagic",function(){var t=parseInt($(this).closest("li").data("value"),10),e=new Date(2e3,t,0).getDate(),t=($(".year-month-day li").each(function(){parseInt($(this).data("value"),10)>e?$(this).addClass("hidden"):$(this).removeClass("hidden")}),$(".year-month-day span.dropdown-label"));parseInt(t.text(),10)>e&&$('.year-month-day li[data-value="'+e+'"] a').click()}),u.trigger("change"),$(".repeat-interval input").on("change.tmSchedule",function(){"0"==$(this).val()&&$(this).val("1")}),S(u.val()),$(document).ajaxSend(function(t,e,n){n=n.url;void 0!==n&&"undefined"!=n||e.abort()})}),$(document).ready(function(){var n,a,i,e=$("#newMsgText"),t=("function"==typeof jQuery.fn.ajaxForm&&$("#attachFileForm").ajaxForm({dataType:"json",beforeSubmit:function(){i=!1,$("#progressButton").addClass("disabled").val("Attaching...")},success:function(t){var e;$("#progressButton").removeClass("disabled").val("Attach file"),1!=t.success||i?$("#upload-alert").warningBlock(t.message.alert||"File uploading was cancelled."):($("#attachFileModal").modal("hide"),(e=$("#attachFileModal2")).find("[data-file=name]").text(t.data.name),e.find("[data-file=link]").html(t.data.link),e.find("[data-file=tag]").html(t.data.tag),e.find("[data-file=characters]").text(t.data.charactersTaken+" characters"),e.find("[data-file=size]").text(Math.ceil(parseInt(t.data.size)/1024*2)/2+" kb"),e.find("[data-file=preview]").html(t.data.resource),n=t.data.id,a=t.data.tag,e.modal("show"))},error:function(t){413===t.status?$("#upload-alert").warningBlock("The selected file size exceeds the allowed limit. File size can be up to 10MB."):$("#upload-alert").warningBlock("Server unexpectedly closed the connection. Possible reasons are: the file is too large (>10 MB) or server is temporary down."),$("#progressButton").removeClass("disabled").val("Attach file")}}),$(document.body).on("click","#attachButton",function(t){t.preventDefault(),$.ajax({url:"/online/messages/file/update",type:"post",dataType:"json",data:{id:n},success:function(t){t.success&&("undefined"!=typeof wsChatDefined&&wsChatDefined?e.val(e.val()+" "+a).change():e.textAtCaret(a).change().blur()),e.trigger("input.count")}}),$("#attachFileModal2").modal("hide")}),$("#attachFileModal"));t.on({"show.bs.modal":function(){$("#attachFileChoose").val(""),$("#upload-alert").html("").hide()}}),t.on({"hide.bs.modal":function(){i=!0,$("#progressButton").removeClass("disabled").val("Attach file")}})}),function(t){this.init(t)}),Contact=(ForwardingSettings.prototype.init=function(t){var a=this,t=(this.searchTimer=!1,this.uiId=!1,this.voiceAvailable=app.data.user.voiceAvailable,this.forwardPhone=!1,this.options=$.extend({},{afterSavingCallback:function(t){return!1},afterUnsuccessfulSavingCallback:function(){return!1},allowEmptyNumber:!1},t),this.form=$("#form-forwarding"),this.table=$("#addGreetingTable"),this.forwardEnable=$('input[data-field="forward-number-enable"]'),this.forwardNumberInput=$('input[data-field="forward-number"]'),this.costHelpBlock=$('[data-widget="cost"]'),this.costLabel=$('[data-widget="forwarding-cost"]'),this.costLabelHundred=$('[data-widget="forwarding-cost-hundred"]'),this.countryLabel=$('[data-widget="forwarding-country"]'),this.continueButton=$("#update-forwarding-button"),this.forwardDirection=$("#forwardDirection"),this.forwardAudioId=!1,this.forwardAudioName=!1,this.forwardAudioLink=!1,this.forwardAudioLength=!1,this.forwardAudioCrudApi=!1,this.playPauseButtonsSelector='[data-widget="play-pause"]',this.filepicker=$('[data-widget="filepicker"]'),this.filepickerForm=this.filepicker.closest("form"),this.filepickerButton=$('[data-widget="open-filepicker"]'),this.topAlert=$('[data-widget="top-alert"]'),this.addGreetingButton=$("#addGreetingButton"),this.itemSelector="tr[data-widget=audio]",this.forwardAudioNameLabel=$('[data-widget="audio-label"]'),this.addEditAudioLink=$('a[data-widget="add-edit-audio"]'),this.clearAudioLink=$('a[data-widget="clear-audio"]'),this.searchInput=$('#audio-form-search [name="search-query"]'),this.modal=this.filepicker.closest(".modal"),this.internalErrorText="An internal error has occurred. Please try again later or contact support",this.route={price:"/online/reply-options/forwarding/price/",save:"/online/reply-options/forwarding/save/",contacts:"/online/messages/conversation/contacts/true"},this.forwardNumberInput.on("input change",function(t){t.preventDefault(),a.forwardNumberInputHandler(t,$(this).val())}).on("blur",function(t){t.preventDefault(),a.forwardNumberInputBlurHandler(t,$(this).val())}).autocomplete({source:a.route.contacts,select:function(t,e){return e.item.value&&"header"!==e.item.role&&a.forwardNumberInput.val("+"+e.item.value).trigger("blur"),!1},delay:500}).data("ui-autocomplete")),t=(t&&(t._renderItem=function(t,e){return $("<li>").append('<a><span class="title"><b class="name">'+e.label+"</b>"+(e.shared_by?'<span class="shared-by pull-right">Shared by '+e.shared_by+"</span>":"")+'</span><span class="value">+'+e.value+"</span></a>").appendTo(t)}),this.continueButton.on("click",function(t){t.preventDefault(),a.saveForwardingSettings()}),this.addGreetingButton.on("click",function(){a.addGreetingButtonClickHandler()}),this.forwardAudioCrudApi=$.prepareCrudPage({commandUrl:"/online/reply-options/dedicated/ajax",containerSelector:"#greetings-content",paginationCommand:"audioTable",paginationScroll:!1,itemSelector:a.itemSelector,searchFormSelector:"#audio-form-search",removeCommand:"removeAudio",afterReloadFunction:function(){$(a.playPauseButtonsSelector).on("click",function(t){t.preventDefault(),a.playPauseButtonsHandler($(this))}),$.each($(a.playPauseButtonsSelector),function(){var t=$(this);t.parent().find("audio").on("ended",function(){t.find("i").removeClass("fa-pause").addClass("fa-play")})})},removeFunction:function(t){var n=$(t).closest("tr").data("id");$.confirm({title:"Delete recording",message:"Are you sure you would like to delete this recording? This action cannot be undone.",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Delete",class:"btn btn-danger",click:function(){var e=$(this);a.forwardAudioCrudApi.removeItems(n,function(t){n==a.forwardAudioId&&a.clearAudioLinkClickHandler(),e.modal("hide"),a.forwardAudioCrudApi.getPaginationApi().reload(),a.topAlert.successBlock("The audio file has been successfully deleted.")})}}}})},bulkRemoveFunction:function(t){return $.confirm({title:"Delete recordings",message:"Are you sure you would like to delete these recordings? This action cannot be undone.",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Delete",class:"btn btn-danger",click:function(){var e=$(this);$(this).find("button.btn-danger").spin("enable","Deleting..."),a.forwardAudioCrudApi.removeItems(!1===a.forwardAudioCrudApi.getCheckedAllItems()?a.forwardAudioCrudApi.getCheckedItems():"all",function(t){-1!==a.forwardAudioCrudApi.getCheckedItems().indexOf(a.forwardAudioId)&&a.clearAudioLinkClickHandler(),e.modal("hide"),a.forwardAudioCrudApi.getPaginationApi().reload(),1<t.data.count?a.topAlert.successBlock("The audio files have been successfully deleted."):a.topAlert.successBlock("The audio file has been successfully deleted.")})}}}}),!0}}),this.filepickerButton.on("click",function(t){t.preventDefault(),a.topAlert.hide(),a.filepickerButtonClickHandler()}),this.filepickerForm.ajaxForm({dataType:"json",beforeSubmit:function(t,e,n){a.filepickerButton.spin("enable","Please wait...")},success:function(t){a.filepickerButton.spin("disable"),t.success?a.forwardAudioCrudApi.getPaginationApi().reload():(a.filepickerButton.spin("disable"),t=t.message.alert,a.topAlert.warningBlock(t))},error:function(){a.filepickerButton.spin("disable"),a.topAlert.warningBlock("Something went wrong while uploading, please try again or pick another file.")}}),this.filepicker.on("change",function(t){a.filepickerForm.submit()}),this.clearAudioLink.on("click",function(t){a.clearAudioLinkClickHandler()}),this.modal);t.on("hide.bs.modal",function(){var t=a.filepickerForm.data("jqxhr");t&&(t.abort(),a.filepickerForm.data("jqxhr",null)),a.searchInput.val("").change()}),t.on("show.bs.modal",function(){a.topAlert.hide()}),$(document.body).on("change",".table-radio input:checkbox",function(){var t=this;$(this).closest("table").find("input:checkbox").filter(function(){return this!==t}).prop("checked",!1),$(this).prop("checked")?a.forwardAudioCrudApi.setCheckedItems([$(this).closest("tr").data("id")]):a.forwardAudioCrudApi.setCheckedItems([])})},ForwardingSettings.prototype.setAllowEmptyNumber=function(t){this.options.allowEmptyNumber=t},ForwardingSettings.prototype.saveUiId=function(t){this.uiId=t},ForwardingSettings.prototype.saveUiVoice=function(t){this.voiceAvailable=t},ForwardingSettings.prototype.requestForwardingPrice=function(t,e){function n(){hideErrors(),a.costHelpBlock.hide(),a.resetCostLabels(),a.continueButton.addClass("disabled"),a.forwardPhone=!1}var a=this;return 0==t.trim().length?(n(),a.options.allowEmptyNumber&&a.continueButton.removeClass("disabled"),!1):(a.costLabel.spin("enable"),a.continueButton.addClass("disabled"),hideErrors(),$.getJSON(a.route.price+t+(e?"/true":""),!1,function(t){if(a.costLabel.spin("disable"),hideErrors(),!t.success)return a.costHelpBlock.hide(),a.resetCostLabels(),a.continueButton.addClass("disabled"),a.forwardPhone=!1,parseAllErrors(t.message),!1;a.costLabel.text(+parseFloat(t.data.price).toFixed(4)),a.costLabelHundred.text(+parseFloat(100*t.data.price).toFixed(3)),a.countryLabel.text(t.data.countryName),a.costHelpBlock.show(),a.forwardPhone=t.data.phone,a.continueButton.removeClass("disabled")}).fail(function(){n(),parseAllErrors({"forward-number":a.internalErrorText})}),!0)},ForwardingSettings.prototype.resetCostLabels=function(){var t=+parseFloat(app.data.user.defaultForwardingPrice),e=+parseFloat(100*app.data.user.defaultForwardingPrice);this.costLabel.text(t.toFixed(4)),this.costLabelHundred.text(e.toFixed(3)),this.costHelpBlock.show(),this.countryLabel.text(app.data.user.countryName)},ForwardingSettings.prototype.forwardNumberInputHandler=function(t,e){clearTimeout(this.searchTimer),13==t.keyCode?this.requestForwardingPrice(e):"object"==typeof i18n&&"object"==typeof i18n.phonenumbers&&i18n.phonenumbers.PhoneNumberUtil.getInstance().transformPhoneNumber(e.replace(/^00/,"+"),this.forwardNumberInput.data("country")).isValid&&this.forwardNumberInput.trigger("blur")},ForwardingSettings.prototype.forwardNumberInputBlurHandler=function(t,e){this.requestForwardingPrice(e)},ForwardingSettings.prototype.saveForwardingSettings=function(){var e=this;return e.form.spin("enable"),e.uiId?(hideErrors(),$.getJSON(e.route.save+e.forwardPhone+"/"+e.uiId+"/"+e.forwardDirection.val()+"/"+e.forwardAudioId,!1,function(t){if(e.form.spin("disable"),hideErrors(),!t.success)return e.costHelpBlock.hide(),parseAllErrors(t.message),e.options.afterUnsuccessfulSavingCallback(),!1;e.options.afterSavingCallback(t)}).fail(function(){return e.form.spin("disable"),hideErrors(),e.costHelpBlock.hide(),parseAllErrors({"forward-number":e.internalErrorText}),e.options.afterUnsuccessfulSavingCallback(),!1}),!0):(e.options.afterUnsuccessfulSavingCallback(),!1)},ForwardingSettings.prototype.playPauseButtonsHandler=function(t){var e=t.parent().find("audio");e.prop("paused")?($.each($("audio"),function(){var t=$(this);t.trigger("pause"),t.trigger("ended")}),e.trigger("play"),t.find("i").removeClass("fa-play").addClass("fa-pause")):(e.trigger("pause"),t.find("i").removeClass("fa-pause").addClass("fa-play"))},ForwardingSettings.prototype.filepickerButtonClickHandler=function(){this.filepickerForm.trigger("reset"),this.filepicker.click()},ForwardingSettings.prototype.addGreetingButtonClickHandler=function(){var t=this,e=(t.forwardAudioCrudApi.getCheckedItems().length||t.clearAudioLinkClickHandler(),t.forwardAudioCrudApi.getCheckedItems()[0]),n=$(t.itemSelector+"[data-id="+e+"]");t.forwardAudioId=e,t.forwardAudioName=n.data("original-name"),t.forwardAudioLink=n.data("real-href"),t.forwardAudioLength=n.data("length"),t.forwardAudioNameLabel.text(t.forwardAudioName),t.addEditAudioLink.html('<i class="fa tmi30-pencil tmi30-12px"></i>Edit greeting'),t.clearAudioLink.show()},ForwardingSettings.prototype.clearAudioLinkClickHandler=function(){var t=this;t.forwardAudioId=!1,t.forwardAudioName=!1,t.forwardAudioLink=!1,t.forwardAudioLength=!1,t.forwardAudioNameLabel.html("<i>(No greeting)</i>"),t.addEditAudioLink.html('<i class="fa fa-plus"></i>Add greeting'),t.clearAudioLink.hide()},function(t){this.init(t)}),SelectContact=(Contact.prototype.init=function(a){var i=this;this.options=$.extend({},{paginationCommand:"table",paginationScroll:!1,itemSelector:"tr[data-widget=contact]",searchFormSelector:"#contacts-search",initExportLnk:1,paginationRecount:!0,beforeReloadFunction:function(t){var e=i.extractFids(a.fids,!0),n=t.getOptions().requestParams;e.cfids&&(n.params&&n.params.text&&(n.hasOwnProperty("params")?n.params=$.extend({},n.params,{cfids:e.cfids}):n.params={cfids:e.cfids},t.setOptions({requestParams:n})),hideErrors())},afterReloadFunction:function(t,e){if(!a.fids||"unsubscribers"===i.listid)return!1;var n=i.extractFids(a.fids,!0),n=(i.displayTableColumns(n.cfids,n.nfids),$(this.containerSelector).find("table"));1===n.find("tbody > tr.empty").length&&n.find("thead > tr > th").removeClass("hidden"),e&&e.responseText&&parseAllErrors(JSON.parse(e.responseText).message)}},a),this.updateContactSubmitBtn='button[data-widget="submit-contact"]',this.moveContactBtn=$('button[data-widget="move-contact"]'),this.removeContactBtn=$('button[data-widget="remove-contact"]'),this.moveContactLnk='a[data-widget="move-contact-lnk"]',this.updateForm=$("#updateContactForm"),this.addBlockedForm=$("#addBlockedNumberForm"),this.sendBtn=$("[data-widget=send]"),this.moveContactModal=$("#moveContacts"),this.removeContactModal=$("#removeContacts"),this.editContactBtn=$('[data-widget="contact_edit"]'),this.moveOptionsContainer=$("#moveContactOptions"),this.removeOptionsContainer=$("#removeContactOptions"),this.addListTagLnk='[data-widget="addtag"]',this.reloadContactLnk='[data-widget="reload-contact"]',this.unblockAndReloadLnk='[data-widget="unblock-and-reload"]',this.deleteBtn=$('[data-action="trash"]'),this.removeListTag="span.tag-item",this.contactListsContainer="#contact-lists-container",this.updateContactModal=$("#updateContactModal"),this.updateContactFormModal=$("#update-contact-form-modal"),this.profileHeaderFullname=$(".contact-profile.title > #fullname"),this.profileHeaderPhone=$(".contact-profile.title > .phone"),this.firstNameInput='#updateContactForm input[data-field="firstName"]',this.lastNameInput='#updateContactForm input[data-field="lastName"]',this.phoneInput='#updateContactForm input[data-field="phone"]',this.emailInput='#updateContactForm input[data-field="email"]',this.companyInput='#updateContactForm input[data-field="companyName"]',this.countrySelect='#updateContactForm select[data-field="country"]',this.phoneTypeSelect='#updateContactForm select[data-field="phoneType"]',this.addAnotherChk="#addAnother",this.tabListBadge=$("#contacts-tabs").find("li:nth-child(1)").find("span"),this.tabBadge=$("#contacts-tabs").find("li:nth-child(2)").find("span"),this.tabBlocked=$("#contacts-tabs").find("li:nth-child(6)").find("span"),this.tabNotes=$("#contact-profile-tabs").find("li:nth-child(2)").find("span"),this.headerBadge=$(".contacts-count"),this.contactDataEl=$("#contact-data"),this.removeProfileBtn=$('[data-widget="remove-profile"]'),this.restoreBtn=$('[data-widget="restore"]'),this.deletePermanentlyBtn=$('[data-widget="delete-permanently"]'),this.topAlert=$('[data-widget="top-alert"]'),this.addContactOneLnk=$("a.btn-add-people.one"),this.exportContactProfile=$(".export-contact-profile-lnk"),this.unsubscribeBtn=$("#unsubscribe-btn"),this.blockIncomingChk=$("#block-incoming-chk"),this.blockSingleNumberBtn=$("#block-single-number-btn"),this.unblockSingleNumberBtn=$("#unblock-single-number-btn"),this.unsubscribeModalBtn=$("#unsubscribe-modal-btn"),this.blockModalBtn=$("#block-modal-btn"),this.unsubscribeName=$("span#unsubscribed-contact-name"),this.blockedName=$("span#blocked-contact-name"),this.unsubscribePhone=$("span#unsubscribed-contact-phone"),this.contactDataSpan="#contact-data > span.badge",this.unsubscribeModal=$("#unsubscribeModal"),this.blockSingleNumberModal=$("#blockSingleNumberModal"),this.unblockSingleNumberModal=$("#unblockSingleNumberModal"),this.initExportLnk=this.options.initExportLnk,this.sendRowBtn='[data-widget="send-row"]',this.unsubscribeRowBtn='[data-widget="unsubscribe-row"]',this.deleteRowBtn='[data-widget="delete-row"]',this.editRowBtn='[data-widget="edit-row"]',this.saveContactRowBtn='[data-widget="save-contact-row"]',this.createListBtn='[data-widget="create-new-list"]',this.inpInlineListName='[data-widget="inline-list-name"]',this.inpInlineDropdown=".input-inline-dropdown",this.btnInlineCreateList='[data-widget="inline-submit"]',this.inpLiveSearch='[data-widget="live-search-dropdown"]',this.messageDetailModal=$("#messagedetailModal"),this.sfCallbackFlag=this.options.sfCallbackFlag,this.listsContainerImport=$("table#file-info-table td#import-lists-container"),this.avatar=$(".avatar-wrapper > .avatar"),this.avatarLabel=$(".avatar-wrapper .avatar-label"),this.avatarControl=this.avatar.find(".avatar-control"),this.avatarChangeBtn='[data-widget="change-avatar"]',this.avatarRemoveBtn='[data-widget="remove-avatar"]',this.avatarUploadForm=$("#form_avatar"),this.avatarFileInput=this.avatarUploadForm.find('input[type="file"]'),this.avatarUploadPreModal=$("#upload-preview-modal"),this.avatarCropForm=$("#contact-image-form"),this.contactFieldFilterModal=$("#contact-field-filter"),this.tableConfigureModal=$("#table-configure-modal"),this.applyContactFieldFilterBtn=this.contactFieldFilterModal.find('[data-action="apply-filter"]'),this.applyContactsPageSettingsBtn=this.tableConfigureModal.find('[data-action="apply-contact-page-settings"]'),this.addEditNoteModal=$("#addNoteModal"),this.addEditNoteModalTitle=this.addEditNoteModal.find(".modal-title"),this.addEditNoteModalText=this.addEditNoteModal.find("#note-text"),this.addEditNoteModalSubmitBtn=this.addEditNoteModal.find('[data-widget="submit-note"]'),this.modalAddBlockedNumber=$("#addBlockedNumberModal"),this.inpBlockedNumber='#addBlockedNumberForm input[data-field="phone"]',this.selectBlockedCountry='#addBlockedNumberForm select[data-field="country"]',this.btnAddBlockedNumberSubmit=$('[data-widget="submit-blocked-number"]'),this.notesEmptySearchScr=$(".notes-empty-search-screen"),this.btnRowRemoveUnsubscribers='[data-widget="remove-unsubscriber-row"]',this.btnUnsubscribersSwitchReason='[data-widget="switch-reason-unsubscriber-row"]',this.autoUnsubscribeModal=$("#autounsubModal"),this.autoUnsubscribeCheckbox=$('[data-field="autounsub"]'),this.autoUnsubscribeCounterContainer=$('[data-widget="after"]'),this.inpAutoUnsubscribeCounter=$('[data-field="after-input"]'),this.autoUnsubscribe=!1,this.autoUnsubscribeCounter=5,this.btnSaveAutoUnsubscribe=$('[data-widget="save-settings"]'),this.defaultReplyContainer=$('[data-widget="stop-reply-default"]'),this.customReplyContainer=$('[data-widget="stop-reply-custom"]'),this.selectReplyTemplateBtn=$('[data-widget="select-opt-out-template"]'),this.removeReplyTemplateBtn=$('[data-widget="unset-opt-out-template"]'),this.addTemplateModal=$("#addTemplateModal2"),this.useTemplateBtnSelector='[data-widget="set-opt-out-template"]',this.customReplyInp=$('[data-widget="stop-reply-text"]'),this.sendStopReply=!1,this.sendStopReplyOnManual=!1,this.stopReplyTemplateId=null,this.stopReplyTemplateName=null,this.sendStopReplyCheckbox=$('[data-field="stop-reply"]'),this.sendStopReplyOnManualCheckbox=$('[data-field="stop-reply-manual"]'),this.stopReplySettingsContainer=$('[data-widget="stop-reply-settings"]'),this.sendStopReplyRadios=$('[name="stop-reply"]'),this.autoUnsubscribeRadios=$('[name="autounsub"]'),this.skipCloseChatAfterUnsubscribe=!1,this.skipCloseChatAfterUnsubscribeRadiosOff=$('[name="skipCloseChatAfterUnsubscribe"][value="0"]'),this.skipCloseChatAfterUnsubscribeRadiosOn=$('[name="skipCloseChatAfterUnsubscribe"][value="1"]'),this.addNoteBtn=$('[data-widget="add-note"]'),this.noteContent=$(".contact-note-content"),this.btnNotesDelete=$('[data-widget="delete-all-notes"]'),this.notesEmptyScr=$(".notes-empty-screen"),this.btnNoteEdit='[data-widget="edit-note"]',this.btnNoteDelete='[data-widget="delete-note"]',this.btnNoteUndo='[data-widget="undo-change"]',this.btnNoteSave='[data-widget="save-change"]',this.notesContainer="#notes-wrapper",this.notesLoadMore='[data-widget="notes-load-more"]',this.formNoteSearch=$("form#notes-search"),this.btnFavTable='[data-widget="toggle-fav-contact"]',this.blockBtn=$('[data-widget="block"]'),this.btnToggleBlock='[data-widget="toggle-block"]',this.blockRowBtn='[data-widget="block-row"]',this.unblockBtn=$('[data-widget="unblock"]'),this.unblockRowBtn='[data-widget="unblock-row"]',this.noteCounter=$('[data-msg-count="note-text"]'),this.btnFavPanel=$('[data-widget="toggle-fav-panel"]'),this.moveLink=$("#contacts_move_to"),this.cfTableTbody="#custom_fields_table tbody",this.btnSaveInPrfl='[data-action="save-in-profile"]',this.btnEditInPrfl='[data-action="edit-in-profile"]',this.btnCncInPrfl='[data-action="cancel-in-profile"]',this.inpInPrfl='[data-widget="input-in-profile"]',this.textInPrfl='[data-widget="text-in-profile"]',this.listids=[],this.cid=null,this.mvToListId=null,this.listid=null,this.isSharedList=!1,this.xhrRunning=!1,this.noteId=null,this.noteOrigText={},this.noteSearchTimer=null,this.getNoteURI=this.options.getNoteURI||"/online/contacts/note",this.getNoteListURI=this.options.getNoteListURI||"/online/contacts/note/list",this.saveAutoUnsubscribeURI=this.options.saveAutoUnsubscribeURI||"/online/contacts/ajax",this.profileAjaxURI="/online/contacts/ajaxprofile",this.saveAutoUnsubscribeCmd="saveUnsubscribe",this.listCrudApi=null,0<this.moveLink.length&&(!app.data.user||0!=app.data.user.disallowedRules.length&&-1!=app.data.user.disallowedRules.indexOf("CREATE_LIST")||i.addCreateListOptToMenu(i.moveLink.next("ul.dropdown-menu"),"move-menu")),this.initListeners(),this.initCrudApi()},Contact.prototype.extractFids=function(t,e=!1){var n={},a={};return $.each(t,function(t,e){if(!parseInt(e))return a[t]=e,!0;n[t]=parseInt(e)}),{nfids:a=e?this.sortNfids(a):a,cfids:n}},Contact.prototype.sortNfids=function(t){var e,n={0:"Favorited",1:"First name",2:"Last name",3:"Phone",4:"Type",5:"Company",6:"Email",7:"Country"},a=Object.values(t),i={};for(e in n)0!==e&&0<=a.indexOf(n[e])&&(i[e]=n[e]);return i},Contact.prototype.initSortableElement=function(n){var t,a=this;window.sortable&&(t=n+" > tr > th",$(document.body).on("mousedown",t,function(t){sortable(n,{items:"tr",placeholder:'<tr><th class="col-sm-3"></th><td class="col-sm-7"></td><td class="col-sm-2"></td></tr>',forcePlaceholderSize:!0}),$(this).closest(n)[0].addEventListener("sortstop",function(t){var e=[];$(document.body).find(n+" tr").each(function(){var t=parseInt($(this).attr("data-cfid"));t&&e.pushOnce(t)}),$.ajax({url:a.options.commandUrl,dataType:"JSON",method:"POST",data:{cmd:"sortCustomFields",ids:e},beforeSend:function(){$(n).spin("enable")},success:function(t){},error:function(t){console.warn(t)},complete:function(t){$(n).spin("disable"),sortable(n,"destroy")}})})}))},Contact.prototype.initListeners=function(){var a=this;$(document.body).on("click",this.addListTagLnk,function(t){t.preventDefault();t=$(this).data("id");if($("span.tag-item[data-id="+t+"]").length)return!0;a.addTag(t,$(this).html())}),$(document.body).on("click","#update-contact-form-modal span.tag-item",function(t){t.preventDefault();t=$(this).data("id"),t=$(a.contactListsContainer).find('[data-id="'+t+'"]');removeTag(this),t.length&&t.closest("li").removeClass("hidden")}),$(document.body).off("click",this.createListBtn).on("click",this.createListBtn,function(t){return t.preventDefault(),t.stopPropagation(),a.createListInlineClickHandler(this),!1}),$(document.body).on("click",this.inpInlineDropdown,function(t){return t.stopPropagation(),!1}),$(document.body).on("click",this.btnInlineCreateList,function(t){return t.preventDefault(),a.btnInlineCreateListClickHandler(this),!1}),$(document.body).on("keyup",this.inpLiveSearch,function(t){var e="^(?=.*\\b"+$.trim($(this).val()).split(/\s+/).join("\\b)(?=.*\\b")+").*$",n=RegExp(e,"i"),e="search-hidden";$(this).closest("ul").find("li").not(".li-not-searchable").removeClass(e).filter(function(){var t=$(this).find("a").text().replace(/\s+/g," ");return!n.test(t)}).addClass(e)}),$(document.body).off("click",this.reloadContactLnk).on("click",this.reloadContactLnk,function(t){t.preventDefault();var t=$(this).data("id"),e={url:"/online/contacts/loadform/"+t,listid:a.listid};a.loadContactForm(e),a.cid=t}),$(document.body).on("click",this.unblockAndReloadLnk,function(t){t.preventDefault();var e=$(this).attr("data-id"),n=$(this).attr("data-blocked-phone");hideErrors(),a.updateContactFormModal.find("input, select").prop("disabled",!0),a.unblockSingleNumberHandler({phone:n,callback:function(){a.loadContactForm({url:"/online/contacts/loadform/"+e,callback:function(){var t=a.updateContactFormModal.find('input[data-field="phone"]');t.val()?a.cid=e:(t.val("+"+n).trigger("keyup"),a.cid=null)}})}})}),this.moveContactBtn.on("click",function(t){t.preventDefault(),a.moveBtnClickHandler()}),this.removeContactBtn.on("click",function(t){t.preventDefault(),a.removeBtnClickHandler()}),$(document.body).on("click",this.moveContactLnk,function(t){t.preventDefault(),a.mvToListId=parseInt($(this).data("id"))}),this.addNoteBtn.on("click",function(t){t.preventDefault(),a.addNoteBtnClickHandler()}),1===this.initExportLnk&&$("a.export-lnk").on("click",function(){a.crudApi.getPaginationApi().setOptions({refresh:!1}).setRequestParams({listId:a.listid})}),this.removeProfileBtn.on("click",function(t){t.preventDefault(),$.confirm({title:"Delete contact",message:"Contact will be deleted permanently<br>Are you sure you would like to delete it?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Delete",class:"btn btn-danger",click:function(){var t={cmd:"removeContact",contacts:[a.cid],profile:!0},e=($(this).find("button.btn-danger").spin("enable","Deleting..."),this);$.post(a.options.commandUrl,t).done(function(t){1==t.success?location.reload():(a.topAlert.warningBlock("An error occurred while removing."),$(e).modal("hide"))})}}}})}),this.restoreBtn.on("click",function(t){t.preventDefault(),a.restoreBtnClickHandler()}),this.blockBtn.on("click",function(t){t.preventDefault(),a.blockBtnClickHandler()}),this.unblockBtn.on("click",function(t){t.preventDefault(),a.unblockBtnClickHandler()}),$(document.body).on("shown.bs.dropdown","#contactsTable .dropdown",function(){var t,e,n=$(this).closest("#contact-table-wrapper");0!==n.length&&(t=n.height())<(e=parseInt(n.prop("scrollHeight")))&&n.data("delta-height",n=e-t+30).height(t+n)}),$(document.body).on("hide.bs.dropdown","#contactsTable .dropdown",function(){var t,e=$("#contact-table-wrapper");0!==e.length&&(t=parseInt(e.data("delta-height")))&&(e.height(e.height()-t),e.data("delta-height",null))}),this.updateContactModal.on("show.bs.modal",function(){var t=$(this).find('input[data-field="phone"]'),e=$(this).find('select[data-field="country"]');if(0===t.length||0===e.length)return!1;a.setPhoneAndCountry(t,e,t.val())}),this.modalAddBlockedNumber.on("show.bs.modal",function(){$(this).find('[data-field="country"]').val(app.u_country),a.changePhonePrefixHandler($(this))}),$(document.body).on("change",this.selectBlockedCountry+","+this.countrySelect,function(){var t=$(this).closest('.modal[role="dialog"]');a.changePhonePrefixHandler(t)}),$(document.body).on("keyup",this.phoneInput+","+this.inpBlockedNumber,function(){var t=$(this),e=$(this).closest("form").find('select[data-field="country"]');a.inputPhoneKeyupHandler(t,e)}),$(document.body).on("click",a.btnFavTable,function(t){t.preventDefault(),a.toggleFavBtnClickHandler(this)}),this.deletePermanentlyBtn.on("click",function(t){t.preventDefault(),a.deleteBtnClickHandler()}),this.removeContactModal.on("hide.bs.modal",function(){var t=a.removeContactBtn;t.siblings("[data-dismiss]").btn("enable"),t.spin("disable")}),this.messageDetailModal.on("hide.bs.modal",function(){$(this).find('[data-widget="top-alert"]').hide()}),this.avatarUploadPreModal.on("hide.bs.modal",function(){a.resetImageForms()}),this.modalAddBlockedNumber.on("show.bs.modal",function(){hideErrors()})},Contact.prototype.btnUnsubscribersSwitchReasonClickHandler=function(t,e){var n=this;$.ajax({url:n.options.commandUrl,method:"POST",dataType:"JSON",data:{cmd:"unsubscribeSwitchReason",id:t,reason:e},beforeSend:function(){},success:function(t){t.success?(n.topAlert.successBlock(t.message),n.crudApi.getPaginationApi().reload()):n.topAlert.warningBlock(t.message||"Sorry, but it looks like something has gone wrong.")},error:function(t){console.warn(t)},complete:function(t){}})},Contact.prototype.btnRowRemoveUnsubscribersClickHandler=function(t){var a=this;$.confirm({title:"Resubscribe contact",message:"Are you sure you want to resubscribe this contact?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Resubscribe",class:"btn btn-danger",click:function(){var e=this,n=$(this).find("button.btn-danger");$.ajax({url:a.options.commandUrl,method:"POST",dataType:"JSON",data:{cmd:"removeUnsubscriber",id:t},beforeSend:function(){n.spin("enable","Deleting...")},success:function(t){t.success?(a.topAlert.successBlock(t.message),a.crudApi.getPaginationApi().reload()):a.topAlert.warningBlock(t.message||"Sorry, but it looks like something has gone wrong.")},error:function(t){console.warn(t)},complete:function(t){n.spin("disable"),$(e).modal("hide")}})}}}})},Contact.prototype.setPhoneAndCountry=function(t,e,n){if(n)return t.val(n),void this.setCountryByPhone(n,e);this.setPhonePrefixByCountry(e.val(),t)},Contact.prototype.setCountryByPhone=function(t,e){t=this.getPhoneNumberCountry(t);null!==t&&e.val(t)},Contact.prototype.setPhonePrefixByCountry=function(t,e){if("ZZ"===t)e.val("+999");else if("object"==typeof i18n&&"object"==typeof i18n.phonenumbers){var n=i18n.phonenumbers.PhoneNumberUtil.getInstance();try{var a=n.getCountryCodeForRegion(t);e.val("+"+a)}catch(t){}}},Contact.prototype.saveContactRowBtnClickHandler=function(n){var a=this;n="+"+n,this.reset({callback:function(){var t=$('input[data-field="phone"]'),e=$('select[data-field="country"]');a.setPhoneAndCountry(t,e,n)}})},Contact.prototype.changePhonePrefixHandler=function(t){var e=t.find('input[data-field="phone"]'),t=t.find('select[data-field="country"]');if(0===e.length||0===t.length)return!1;this.setPhoneAndCountry(e,t)},Contact.prototype.inputPhoneKeyupHandler=function(t,e){var t=t.val();"+"===(t="00"===t.substring(0,2)?"+"+t.substring(2):t).substring(0,1)&&(t=this.getPhoneNumberCountryCode(t,[e.val(),app.u_country]))&&0<e.find('option[value="'+t.toUpperCase()+'"]').length&&e.val(t).trigger("chosen:updated")},Contact.prototype.getPhoneNumberCountryCode=function(t,e){var n=this.getPhoneNumberCountry(t);if("object"==typeof i18n&&"object"==typeof i18n.phonenumbers){var a=i18n.phonenumbers.PhoneNumberUtil.getInstance();if(null===n)for(var i=0;i<e.length;i++)try{a.parse(t,e[i]);n=e[i];break}catch(t){}}return n},Contact.prototype.getPhoneNumberCountry=function(t){var e=null;if("+999"===t.substr(0,4))return"ZZ";if("object"==typeof i18n&&"object"==typeof i18n.phonenumbers){var n=i18n.phonenumbers.PhoneNumberUtil.getInstance();try{var a=n.parse(t,"");e=(e=n.getRegionCodeForNumber(a))||n.getRegionCodeForCountryCode(a.getCountryCode())}catch(t){}}return e},Contact.prototype.btnNotesDeleteClickHandler=function(){var n=this;$.confirm({title:"Delete all contact's notes",message:"All contact's notes will be deleted permanently. Are you sure you want to delete all contact's notes?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Delete",class:"btn btn-danger",click:function(){var e=this,t=$(this).find("button.btn-danger");$.ajax({url:n.options.commandUrl,dataType:"JSON",method:"POST",data:{cmd:"removeAllNotes",cid:n.cid},beforeSend:function(){t.spin("enable","Deleting...")},success:function(t){t.success&&(n.topAlert.successBlock(t.message),$('[data-widget="note"][data-id!=""][data-id]').remove(),n.updateCountNotes(0),n.reloadNoteList({}))},error:function(t){console.warn(t)},complete:function(t){$(e).modal("hide")}})}}}})},Contact.prototype.formNoteSearchHandler=function(t){function e(){var t=$(n.notesContainer).find(".contact-note-content");$.each(t,function(t,e){e=$(e).find("a");$.each(e,function(t,e){var n=(n=$(e).attr("href")).replace("<span class='text-highlight'>","").replace("</span>","");$(e).attr("href",n)})})}var n=this,t=$.trim(t.toLowerCase()),a=$('[data-widget="note"][data-id=""][data-id]');$.each(a,function(t,e){if($(e).hasClass("hidden"))return!0;$(e).find(n.btnNoteUndo).trigger("click")});clearTimeout(n.noteSearchTimer),n.noteSearchTimer=setTimeout(function(){$(n.notesContainer).html(""),n.getNoteList({text:t,callback:e})},500)},Contact.prototype.checkNotesEmptyState=function(){0!==this.btnNotesDelete.length&&(0===$(this.notesContainer).find('[data-widget="note"][data-id!=""][data-id]').length?this.btnNotesDelete.addClass("disabled"):this.btnNotesDelete.removeClass("disabled"))},Contact.prototype.sendCheckedItemsHandler=function(){var a,t,i,o=this,s=!1,r=this.crudApi.getCheckedItems().length,s=this.crudApi.getCheckedAllItems()?"all":this.crudApi.getCheckedItems();1<r||"all"===s?(t={cmd:"createGroup",contacts:"all"===s||s.length<=100?s:[s[0]]},i=function(t,e){var n=$("div.progress-bar");n.data("aria-valuenow",t),n.data("aria-valuemax",e),n.css("width",parseInt(100*t/e)+"%"),n.find('span[data-widget="items-processed"]').text(t),n.find('span[data-widget="items-total"]').text(e)},100<r&&(i(0,r),$("#send-progress-modal button.cancel").click(function(){$("#send-progress-modal").modal("hide")}),$("#send-progress-modal").modal("show"),$("#send-progress-modal").on("hide.bs.modal",function(t){clearTimeout(a),o.crudApi.setCheckedItems([]),o.crudApi.getPaginationApi().reload()})),this.crudApi.post(t,function(n){100<r?function e(){var t={cmd:"getCreationGroupProcess",group_id:n.data.group_id,contacts:s.splice(0,100)};o.crudApi.post(t,function(t){t.success?t.data.processed>=r?(i(t.data.processed,r),clearTimeout(a),window.location.href="/online/messages/new?groups="+t.data.group_id):(i(t.data.processed,r),a=setTimeout(function(){e()},2e3)):(clearTimeout(a),$("#send-progress-modal").modal("hide"))})}():n.success&&(window.location.href="/online/messages/new?groups="+n.data.group_id)})):window.location.href="/online/messages/new?contacts="+this.crudApi.getCheckedItems()},Contact.prototype.sendBtnClickHandler=function(){var t=this.listid&&!0===this.crudApi.getCheckedAllItems(),e=this.listid&&!1===this.crudApi.getCheckedAllItems()&&0===this.crudApi.getCheckedItems().length;t||e?window.location.href="/online/messages/new?groups="+this.listid:this.sendCheckedItemsHandler()},Contact.prototype.addCreateListOptToMenu=function(t,e){e='<li><a href="javascript:void(0);" data-widget="create-new-list"><i class="fa fa-plus"></i>Create new list</a><div class="input-group input-group-dropdown"><input type="text" class="form-control input-inline-dropdown hidden" data-source="'+e+'" style="margin-top: 5px; margin-bottom: 5px; min-width: 190px; margin-left: 5px;" data-widget="inline-list-name" placeholder="Enter list name" maxlength="100" /><span class="input-group-btn"><button class="btn btn-success btn-solid hidden" style="margin-right: 5px; margin-left: 5px;" data-widget="inline-submit">Save</button></span></div></li>';0===$(t).length?(t='<ul class="dropdown-menu pull-left dropdown-caret add-new-dropdown">'+e+"</ul>",$(t).insertAfter(this.moveLink.attr("data-toggle","dropdown"))):$(t).prepend(e)},Contact.prototype.afterCreateListSuccessCallback=function(t,e,n){var a=this,i=e.g.id,e=e.g.name,o=null;n&&(o=$(n).attr("data-source")),1===a.sfCallbackFlag&&a.subscribeFormCallback(i,e),$(this.btnInlineCreateList).addClass("hidden"),a.updateGroupList(t),a.addItemToMoveMenu(i,e),0<a.tabListBadge.length&&a.tabListBadge.load("/online/messages/lists/ajaxcount"),a.listCrudApi&&a.listCrudApi.getPaginationApi().reload(),$(a.createListBtn).btn("enable"),$(document).trigger("list:created"),o||a.addTag(i,e)},Contact.prototype.addItemToMoveMenu=function(t,e){t='<li><a href="#moveContacts" data-id="'+t+'" data-toggle="modal" data-widget="move-contact-lnk" class=""><i class="tmi30 tmi30-person-two tmi30-12px"></i> '+e+"</a></li>",e=this.moveLink.next("ul").find(this.inpInlineListName).closest("li").next("li");$(t).insertBefore(e)},Contact.prototype.createList=function(t,e){var n=this,a={cmd:"updateList",name:t||"New List",type:!0,definedGroups:[this.listid]};$.ajax({url:"/online/messages/lists/ajax",dataType:"JSON",method:"POST",data:a,beforeSend:function(){$(n.createListBtn).btn("disable"),$(n.btnInlineCreateList).btn("disable"),e.prop("disabled",!0),e.closest(".dropdown-menu").find("a").addClass("disabled")},success:function(t){t.success&&n.afterCreateListSuccessCallback(a,t.data,e)},error:function(t){console.warn(t)},complete:function(t){$(n.createListBtn).btn("enable"),$(n.btnInlineCreateList).btn("enable"),n.resetParentDropdown(e)}})},Contact.prototype.resetParentDropdown=function(t){var e=t.closest(".dropdown.open");t.closest("li").find("a").removeClass("hidden"),t.addClass("hidden").prop("disabled",!1),"move-menu"===t.attr("data-source")?(e=t.closest(".btn-group.open")).find(".dropdown-menu").find("a").removeClass("disabled"):(e.find(".dropdown-menu").find("a").removeClass("disabled"),e.removeClass("open"))},Contact.prototype.btnInlineCreateListClickHandler=function(t){var t=$(t).closest(".input-group").find('input[type="text"]'),e=$.trim(t.val());if(!e)return!1;this.createList(e,t),t.val("")},Contact.prototype.createListInlineClickHandler=function(t){var e=$(t).next(".input-group");$(t).closest(".dropdown-menu");$(t).addClass("hidden"),e.find(this.btnInlineCreateList).removeClass("hidden"),e.find(this.inpInlineListName).removeClass("hidden").focus()},Contact.prototype.removeModalMessageFormatter=function(t){var e,t=t||1===this.crudApi.getCheckedItems().length?(e="Selected contact will be deleted permanently.<br>Are you sure you would like to delete it?","Delete contact"):(e="Selected contacts will be deleted permanently.<br>Are you sure you would like to delete them?","Delete contacts");this.removeContactModal.find("h2").text(t),this.removeContactModal.find("p.confirmModalMessage").html(e)},Contact.prototype.contactFieldFilterCheckboxClickHandler=function(t){10<this.contactFieldFilterModal.find("input[data-type-custom]:checked").length&&(this.contactFieldFilterModal.find(".alert").warningBlock("Maximum amount of visible custom fields must not exceed 10."),t.attr("checked",!1))},Contact.prototype.displayTableColumns=function(t,e){var n=$("#contacts-container").find("table"),a=n.find("tr[data-widget=contact]").length,i=n.find("th").length;"unsubscribers"!==this.listid&&(Object.keys(e).length<3&&(n.find("tr").find("th:eq(0)").css("width","2%"),n.find("tr").find("th:eq(1)").css("width","2%")),Object.keys(e).length<5&&2<Object.keys(e).length&&(n.find("tr").find("th:eq(0)").css("width","3%"),n.find("tr").find("th:eq(1)").css("width","3%")));for(var o=2;o<i-1;o++)void 0===e[o-1]?(n.find("tr").find("th:eq("+o+")").addClass("hidden"),n.find("tr").find("td:eq("+o+")").addClass("hidden")):(n.find("tr").find("th:eq("+o+")").removeClass("hidden"),n.find("tr").find("td:eq("+o+")").removeClass("hidden"));0<Object.keys(t).length&&0<a&&this.joinCustomFields(t);a=n.find("tbody > tr.table-data-select"),t=Object.keys(t).length+Object.keys(e).length+3;a.find("td").prop("colspan",t)},Contact.prototype.joinCustomFields=function(e){var n,a,i,t;this.xhrRunning||(n=this,a=$("#contacts-container"),i=[],a.find("table tbody tr").each(function(t,e){i.push($(this).data("id"))}),t={fids:e,cids:i},$.ajax({url:"/online/contacts/custom-field-data",dataType:"JSON",method:"POST",data:t,beforeSend:function(){a.spin("enable"),n.xhrRunning=!0},success:function(t){t.success&&n.insertColumns(e,t.data)},error:function(t){console.warn(t)},complete:function(t){a.spin("disable"),n.xhrRunning=!1}}))},Contact.prototype.insertColumns=function(t,e){var n=$("#contacts-container"),a=n.find("table"),r=e.data||{},e=($.each(t,function(t,e){t=t.substr(3),e=$("<th>",{class:"col-xs-2","data-id":e,title:t}).text(t),t=a.find("thead").find("tr").find("th").last(),e.insertBefore(t)}),a.find("thead").find("tr").find("th[data-id]")),d=(e.css({"max-width":"190px",overflow:"hidden","text-overflow":"ellipsis","white-space":"nowrap"}),$('input[name="search-query"]').val());e.each(function(t,e){var n=$(e).index(),s=parseInt($(e).data("id"));a.find("tbody").find("tr").each(function(t,e){var i=parseInt($(this).data("id")),o=$("<td>");$.each(r,function(t,e){var n=parseInt(e.contact_id)===i,a=parseInt(e.user_custom_field_id)===s;if(n&&a&&e.field_value)return n=e.field_value,d?(n=highlight(e.field_value.escapeHtml(),d),o.html(n).attr("title",n)):o.text(n).attr("title",n),!1}),$(this).find("td").eq(n-1).after(o)})}),7<a.find("thead").find("th").not(".hidden").length&&(t=$("<div>",{id:"contact-table-wrapper","data-delta-height":null}).addClass("table-shadow"),a.addClass("auto-width-table").wrap(t),(t=$("#contact-table-wrapper")).wrap($("<div/>",{class:"table-shadow-wrapper"})),$("<div/>",{class:"right-shadow"}).css({height:t.height()}).insertAfter(t),parseInt(a.width())>parseInt(n.width())&&n.find(".pagin-panel").css("margin-top","20px"))},Contact.prototype.applyContactsPageSettings=function(){var e=this,t=$("[name='withShared']:checked").val();return $.ajax({url:"/online/account/ajax",dataType:"JSON",method:"POST",data:{cmd:"updateContactsPageSettingShowShare",contact_page_setting_show_shared:t},beforeSend:function(){e.applyContactsPageSettingsBtn.spin("enable","Saving..."),hideErrors()},success:function(t){t.success?location.reload():(parseAllErrors(t.message),e.applyContactsPageSettingsBtn.spin("disable"))},error:function(t){console.warn(t)}}),!1},Contact.prototype.applyContactFieldFilter=function(){var e=this,n={fields:{}};return e.contactFieldFilterModal.find('input[type="checkbox"]:checked').each(function(t,e){n.fields[t]=$(e).attr("name")}),$.ajax({url:"/online/contacts/table/fields",data:n,dataType:"JSON",method:"POST",beforeSend:function(){e.applyContactFieldFilterBtn.spin("enable","Saving...")},success:function(t){t.success?location.reload():(e.contactFieldFilterModal.modal("hide"),e.applyContactFieldFilterBtn.spin("disable"),e.topAlert.warningBlock("Sorry, but it looks like something has gone wrong. Please try again or contact us at support@textmagic.com"))},error:function(t){console.warn(t),e.contactFieldFilterModal.modal("hide"),e.applyContactFieldFilterBtn.spin("disable")}}),!1},Contact.prototype.addTag=function(t,e){var n='<a href="/online/contacts/list/'+t+'" class="tag-item-link" data-id="'+t+'">'+e+"</a>";addTag(this.contactListsContainer,'<span class="tag-item resetable" data-id="'+t+'">'+e+'<a href="javascript:void(0);" class="close"></a></span>'),addTag(this.listsContainerImport,n),$(this.contactListsContainer).find('[data-id="'+t+'"]').closest("li").addClass("hidden"),this.updateContactFormModal.find('span[data-field="groups"]').next("span.help-block.error").remove()},Contact.prototype.loadContactForm=function(t){var e=this;this.updateContactFormModal.find("input, select").prop("disabled",!0),this.updateContactFormModal.load(t.url,t,function(){"function"==typeof t.callback&&t.callback(),e.initPhoneFieldHandler()})},Contact.prototype.unsubscribeClickHandler=function(t){var e=this,t={cmd:"unsubscribeContact",phone:t.phone,cid:null,blockIncoming:this.blockIncomingChk.is(":checked")};e.unsubscribeBtn.spin("enable"),$.post(e.options.commandUrl,t).done(function(t){e.unsubscribeModal.modal("hide"),1==t.success?(e.topAlert.successBlock("Contact has been successfully removed from your lists."),void 0!==e.crudApi.getPaginationApi()&&(e.crudApi.getPaginationApi().reload(),e.renderEl()),e.cid&&location.reload()):(e.topAlert.warningBlock(t.message),e.crudApi.getPaginationApi().reload()),e.unsubscribeBtn.spin("disable")}).fail(function(){return e.unsubscribeBtn.spin("disable"),e.topAlert.warningBlock("An error occurred while unsubscribing."),!1})},Contact.prototype.updateCountBlocked=function(){0!==this.tabBlocked.length&&this.tabBlocked.load("/online/contacts/blocked-count")},Contact.prototype.updateCountNotes=function(t){var e;0!==this.tabNotes.length&&(e=parseInt(this.tabNotes.text()),"+"===t?e++:"-"===t?e--:e=parseInt(t),this.tabNotes.text(e))},Contact.prototype.toggleViewContactModalBtn=function(t){var e=$('[data-widget="modal-view-contact"]');0!==e.length&&(t?e.attr("href",t).removeClass("hidden"):e.attr("href","javascript:void(0);").addClass("hidden"))},Contact.prototype.toggleBlockBtnHandler=function(t,e){0!==t.length&&("block"===(e||t.attr("data-action"))?t.attr("data-action","unblock").attr("href","#unblockSingleNumberModal").contents().filter(function(){return 3==this.nodeType}).each(function(){this.textContent=this.textContent.replace("Block contact","Unblock contact")}):t.attr("data-action","block").attr("href","#blockSingleNumberModal").contents().filter(function(){return 3==this.nodeType}).each(function(){this.textContent=this.textContent.replace("Unblock contact","Block contact")}))},Contact.prototype.blockSingleNumberHandler=function(e){var n=this,t={cmd:"blockSingleNumber",phone:e.phone};$.ajax({url:n.options.commandUrl,dataType:"JSON",method:"POST",data:t,beforeSend:function(){n.blockSingleNumberBtn.spin("enable")},success:function(t){1==t.success?(n.topAlert.successBlock("Contact has been successfully blocked."),void 0!==n.crudApi.getPaginationApi()&&(n.crudApi.setCheckedItems([]),n.crudApi.setCheckedAllItems(!1),n.crudApi.getPaginationApi().reload(),n.renderEl()),n.toggleBlockBtnHandler($(n.btnToggleBlock)),n.updateCountBlocked(),"function"==typeof e.callback&&e.callback()):$.each(t.message,function(t,e){n.topAlert.warningBlock(e)})},error:function(t){console.warn(t),n.topAlert.dangerBlock("An error occurred while blocking.")},complete:function(t){n.blockSingleNumberModal.modal("hide"),n.blockSingleNumberBtn.spin("disable")}})},Contact.prototype.unblockSingleNumberHandler=function(e){var n=this,t={cmd:"unblockSingleNumber",phone:e.phone};n.unblockSingleNumberBtn.spin("enable"),$.post(n.options.commandUrl,t).done(function(t){n.unblockSingleNumberModal.modal("hide"),1==t.success?(n.topAlert.successBlock("Contact has been successfully unblocked."),void 0!==n.crudApi.getPaginationApi()&&(n.crudApi.getPaginationApi().reload(),n.renderEl()),n.toggleBlockBtnHandler($(n.btnToggleBlock)),n.updateCountBlocked(),"function"==typeof e.callback&&e.callback()):n.topAlert.warningBlock(t.message),n.unblockSingleNumberBtn.spin("disable")}).fail(function(){return n.unblockSingleNumberBtn.spin("disable"),n.topAlert.dangerBlock("An error occurred while unblocking."),!1})},Contact.prototype.fillModalListContainer=function(t){var e=this;$(this.contactListsContainer).find("ul.dropdown-menu").find("li > a").each(function(){-1!==t.indexOf($(this).data("id"))&&e.addTag($(this).data("id"),$(this).html())})},Contact.prototype.blockedNumberAutocomplete=function(n){var a=this;this.phoneAutocomplete(n,a.selectBlockedCountry,"#"+this.addBlockedForm.attr("id"),function(t,e){return e.item.value&&"header"!==e.item.role&&a.setPhoneAndCountry($(n),$(a.selectBlockedCountry),"+"+e.item.value),!1})},Contact.prototype.updateContactAutocomplete=function(a){var i=this;this.phoneAutocomplete(a,i.countrySelect,"#"+this.updateForm.attr("id"),function(t,e){return e.item.value&&"header"!==e.item.role&&("contact"===e.item.entityType&&e.item.entityId?(n=e.item.entityId,i.loadContactForm({url:"/online/contacts/loadform/"+n}),i.cid=n):"Textmagic"===e.item.countryName?($(a).val("+"+e.item.value),$(i.countrySelect).val("ZZ"),$(i.phoneTypeSelect).val(1)):"object"==typeof i18n&&"object"==typeof i18n.phonenumbers&&(e=(n=i18n.phonenumbers.PhoneNumberUtil.getInstance()).transformPhoneNumber("+"+e.item.value,$(i.countrySelect).val())).isValid&&($(a).val(e.number),$(i.countrySelect).val(e.country),n=n.getNumberType(n.parseAndKeepRawInput(e.number,e.country)),0<$(i.phoneTypeSelect+" option[value="+n+"]").length&&$(i.phoneTypeSelect).val(n))),!1;var n})},Contact.prototype.phoneAutocomplete=function(t,e,n,a){function i(t,e){$.ajax({method:"GET",url:"/api/v2/contacts/autocomplete",data:{limit:10,query:t.term,lists:0},dataType:"json",headers:{"X-TM-Username":app.data.user.login,"X-TM-Key":app.data.user.api_key},cache:!1,success:function(t){e(t)}})}$(t).autocomplete({source:i,appendTo:n,select:a,delay:100}).data("ui-autocomplete")._renderItem=function(t,e){var n="",a="";switch(e.entityType){case"contact":n=e.label,a=e.value;break;case"reply":n="+"+e.label,a=e.countryName;break;default:return $("<li>").appendTo(t)}var i=getAvatarClass(a,n,e.avatar,e.entityType,e.favorited),o=getAvatarLabel(a,n,e.avatar,e.entityType),s="";return e.avatar&&(s="background-image: url(/"+e.avatar+")"),$("<li>").append('<a class="chat-contact-item clearfix"><i class="'+i+'" style="'+s+'">'+o+'</i><div class="name">'+highlight(n,this.term)+'</div><div class="last-message">'+highlight(a,this.term)+"</div></a>").appendTo(t)},$(e).off("change").on("change",function(){$(t).autocomplete("option","source",i)})},Contact.prototype.initPhoneFieldHandler=function(){0!==$(this.inpBlockedNumber).length&&this.blockedNumberAutocomplete(this.inpBlockedNumber),0!==$(this.phoneInput).length&&this.updateContactAutocomplete(this.phoneInput)},Contact.prototype.btnAddBlockedNumberSubmitClickHandler=function(){var e=this;$.ajax({url:e.options.commandUrl,dataType:"JSON",method:"POST",data:{cmd:"blockSingleNumber",phone:$(e.inpBlockedNumber).val(),country:$(e.selectBlockedCountry).val()},beforeSend:function(){e.btnAddBlockedNumberSubmit.spin("enable"),hideErrors()},success:function(t){t.success?(e.modalAddBlockedNumber.modal("hide"),e.topAlert.successBlock("Number has been successfully blocked."),e.crudApi&&"function"==typeof e.crudApi.getPaginationApi&&e.crudApi.getPaginationApi().reload(),e.updateCountBlocked(),e.updateCountContacts()):parseAllErrors(t.message)},error:function(t){console.warn(t)},complete:function(t){e.btnAddBlockedNumberSubmit.spin("disable")}})},Contact.prototype.initCrudApi=function(){this.crudApi=$.prepareCrudPage(this.options)},Contact.prototype.restoreBtnClickHandler=function(){var a=this;$.confirm({title:"Restore contacts",message:"Are you sure you would like to restore the selected contacts?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Restore",class:"btn btn-danger",click:function(){function t(){n.spin("disable"),$(e).modal("hide"),a.crudApi.getPaginationApi().reload(),a.topAlert.successBlock("The selected contacts have been successfully restored.")}var e=this,n=$(this).find("button.btn-danger");n.spin("enable","Restoring...");a.crudApi.getCheckedAllItems()?a.crudApi.updateItems("RESTORE MY CONTACTS","archived",0,t):a.crudApi.updateItems(a.crudApi.getCheckedItems(),"archived",0,t)}}}})},Contact.prototype.blockBtnClickHandler=function(){var a=this;$.confirm({title:"Block contacts",message:"Are you sure you would like to block the selected contacts?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Block",class:"btn btn-danger",click:function(){function t(){n.spin("disable"),$(e).modal("hide"),a.crudApi.getPaginationApi().reload(),a.topAlert.successBlock("The selected contacts have been successfully blocked.")}var e=this,n=$(this).find("button.btn-danger");n.spin("enable","Blocking...");a.crudApi.getCheckedAllItems()?a.crudApi.updateItems("BLOCK MY CONTACTS","archived",3,t):a.crudApi.updateItems(a.crudApi.getCheckedItems(),"archived",3,t)}}}})},Contact.prototype.unblockBtnClickHandler=function(a){var i=this,t=1<(a=a||i.crudApi.getCheckedItems()).length||i.crudApi.getCheckedAllItems()?"You will be able to exchange messages with contacts that are unblocked.":"You will be able to exchange messages with this contact once unblocked.";$.confirm({title:"Unblock confirmation",message:t,buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Unblock",class:"btn btn-success",click:function(){function t(){n.spin("disable"),$(e).modal("hide"),i.crudApi.setCheckedItems([]),i.crudApi.getPaginationApi().reload(),i.topAlert.successBlock("The selected contacts have been successfully unblocked."),i.updateCountBlocked(),i.updateCountContacts()}var e=this,n=$(this).find("button.btn-danger");n.spin("enable","Unblocking..."),!1===i.crudApi.getCheckedAllItems()?i.crudApi.updateItems(a,"archived",0,t):i.crudApi.updateItems("UNBLOCK MY CONTACTS","archived",0,t)}}}})},Contact.prototype.deleteBtnClickHandler=function(){var i=this;$.confirm({title:"Delete contacts",message:"The selected contacts will be deleted permanently.<br>Are you sure you want to delete the selected contacts?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Delete",class:"btn btn-danger",click:function(){function t(t){$(e).modal("hide"),n.spin("disable"),i.crudApi.getPaginationApi().reload(),i.topAlert.successBlock(a?"The selected contacts have been successfully deleted."+(t.data.hasOwnProperty("deferred")&&t.data.deferred?" It may take some minutes before they disappear from your account.":""):"All your contacts will be deleted shortly. It may take some minutes before they disappear from your account.")}var e=this,n=$(this).find("button.btn-danger"),a=i.crudApi.getCheckedAllItems();n.spin("enable","Deleting..."),a?i.crudApi.removeItems("DELETE MY CONTACTS",t):i.crudApi.removeItems(i.crudApi.getCheckedItems(),t)}}}})},Contact.prototype.customFields=function(){var a={},t=this.updateContactModal.find('input[data-type="custom"]');return $(t).each(function(t,e){var n=parseInt($(e).data("id"));a[n]=$(e).val()}),a},Contact.prototype.lists=function(){var n=[],t=this.updateContactModal.find("#shared-list");if(0!==t.length)return[parseInt(t.data("val"))];t=this.updateContactModal.find("span.tag-item");return $(t).each(function(t,e){n.push(parseInt($(e).data("id")))}),n},Contact.prototype.reset=function(t){var e={url:"/online/contacts/loadform/0",listid:this.listid},e=$.extend({},e,t);this.loadContactForm(e),this.cid=null},Contact.prototype.submitBtnClickHandler=function(n,a){var i=this,t=(hideErrors(),$(this.updateContactSubmitBtn).spin("enable","Saving..."),{cmd:"updateContact",firstName:$(this.firstNameInput).val(),lastName:$(this.lastNameInput).val(),phone:$(this.phoneInput).val(),companyName:$(this.companyInput).val(),email:$(this.emailInput).val(),country:$(this.countrySelect).val(),phoneType:$(this.phoneTypeSelect).val(),custom:this.customFields(),lists:this.lists(),isShared:parseInt(this.updateContactModal.find("#shared-list").length),sharedEdit:parseInt(this.updateContactModal.find("#shared-contact-edit").length),cid:this.cid}),o="New contact has been successfully added.";i.cid&&(o="Contact details have been successfully edited."),$.post(i.options.commandUrl,t).done(function(t){var e;if(1==t.success)return $(i.updateContactSubmitBtn).spin("disable"),null!=i.crudApi.getPaginationApi()?i.crudApi.getPaginationApi().reload():n&&n.getPaginationApi().reload(),0<(e=$("td.contact-info").find('a[data-toggle="modal"][class="one"]')).length&&e.addClass("hidden"),$(i.addAnotherChk).is(":checked")?i.reset({callback:function(){i.setPhoneAndCountry(i.updateContactFormModal.find('input[data-field="phone"]'),i.updateContactFormModal.find('select[data-field="country"]')),i.updateContactFormModal.find(i.addAnotherChk).attr("checked","checked")}}):(i.renderEl(),i.topAlert.successBlock(o),i.updateContactModal.modal("hide"),i.cid||((e=document.createEvent("Event")).initEvent("contact.add",!0,!0),e.phone=t.data.phone,document.dispatchEvent(e)),"function"==typeof a&&a()),!0;$(i.updateContactSubmitBtn).spin("disable"),parseAllErrors(t.message),$(i.updateContactSubmitBtn).spin("disable")}).fail(function(){return $(i).spin("disable"),!1})},Contact.prototype.loadEl=function(t,e){var n=this;if(0===t.length)return!1;t.load(e.url,e,function(){e.url==n.profileAjaxURI&&n.getNoteList({})})},Contact.prototype.updateCountContacts=function(){this.loadEl(this.tabBadge,{url:"/online/contacts/ajaxcount"})},Contact.prototype.renderEl=function(){var a=this,t=this.listid?this.headerBadge:this.tabBadge,e={listid:this.listid,url:"/online/contacts/ajaxcount"};if(this.loadEl(t,e),!this.cid||0===this.contactDataEl.length)return!1;e={contactid:this.cid,url:this.profileAjaxURI},this.loadEl(this.contactDataEl,e),this.loadContactForm({url:"/online/contacts/loadform/"+parseInt(this.cid),callback:function(){var t=a.updateContactFormModal.find('[data-field="firstName"]').val(),e=a.updateContactFormModal.find('[data-field="lastName"]').val(),n=a.updateContactFormModal.find('[data-field="phone"]').val();a.profileHeaderFullname.text(t+" "+e),a.profileHeaderPhone.text(n)}})},Contact.prototype.getMoveOption=function(){var t=this.moveOptionsContainer.find('input[name="moveMethod"]:checked');return(t=0===t.length?this.moveOptionsContainer.find('input[type="hidden"]'):t).val()},Contact.prototype.toggleMoveMethodHandler=function(){var t="cp"===this.getMoveOption()?"Copy":"Move";this.moveContactBtn.text(t)},Contact.prototype.moveBtnClickHandler=function(){var e=this,t="Moving...",t=("Copy"===this.moveContactBtn.text()&&(t="Copying..."),this.moveContactBtn.spin("enable",t),this.crudApi.getCheckedAllItems()),n=this.crudApi.getCheckedItems(),a={cmd:"moveContact",contacts:n=!0===t?[]:n,all:t,toListId:this.mvToListId,fromListId:this.listid,moveMethod:this.getMoveOption()};$.post(e.options.commandUrl,a).done(function(t){if(!0===t.success)return e.moveContactBtn.spin("disable"),e.crudApi.getPaginationApi().reload(),e.renderEl(),e.moveContactModal.modal("hide"),t="Selected contacts have been successfully copied to the new list.","mv"===a.moveMethod&&(t="Selected contacts have been successfully moved to the new list.",e.crudApi.setCheckedItems([])),e.topAlert.successBlock(t),!0;e.moveContactBtn.spin("disable")}).fail(function(){return $(e).spin("disable"),!1})},Contact.prototype.subscribeFormCallback=function(t,e){$("#formGroup").append($("<option></option>").attr("value",t).text(e)).prop("disabled",!1),$(this.createListBtn).hide()},Contact.prototype.updateGroupList=function(t){var a=this;$(a.contactListsContainer).find("ul.dropdown-menu").load("/online/messages/lists/update-list",t,function(){var n=this,t=$(n).closest(a.contactListsContainer).parent().find("span.tag-item"),e=$(n).find(a.inpLiveSearch);$.each(t,function(t,e){e=parseInt($(e).attr("data-id")),e=$(n).find('a[data-id="'+e+'"]');0!==e.length&&e.closest("li").addClass("hidden")}),e.val("").trigger("keyup")})},Contact.prototype.removeBtnClickHandler=function(){var n=this,a=this.removeContactBtn.siblings("button[data-dismiss]");if(this.removeContactBtn.spin("enable","Deleting..."),a.btn("disable"),!0===n.crudApi.getCheckedAllItems()&&null===n.listid)return n.crudApi.removeItems("all",function(t){t.success?(n.topAlert.successBlock("All your contacts will be deleted shortly. It may take some minutes before they disappear from your account."),n.renderEl(),n.crudApi.getPaginationApi().reload()):n.topAlert.warningBlock(t.message),n.removeContactBtn.spin("disable"),n.removeContactModal.modal("hide")}),!0;var t=this.crudApi.getCheckedAllItems(),e=this.crudApi.getCheckedItems(),i={cmd:"removeContact",contacts:e=!0===t?[]:e,all:t,fromListId:this.listid},i=$.extend({},i,app.removeContactOptions);$.post(n.options.commandUrl,i).done(function(t){var e;return 1==t.success?(n.renderEl(),n.crudApi.getPaginationApi().reload(),e=1!==i.contacts.length||i.all?"Selected contacts have been successfully removed":"Selected contact has been successfully removed",null!==n.listid&&"blocked"!==n.listid&&(e+=" from this list"),n.topAlert.successBlock(e),n.crudApi.setCheckedItems([])):n.topAlert.warningBlock(t.message),n.removeContactModal.modal("hide"),n.removeContactBtn.spin("disable"),a.btn("enable"),!0}).fail(function(){return n.removeContactBtn.spin("disable"),a.btn("enable"),!1})},Contact.prototype.contenteditableFocus=function(t){t.text();var e,n=t.prop("contenteditable",!0)[0];if(t.is(":empty"))return t.text(" "),void n.focus();n.focus(),void 0!==window.getSelection&&void 0!==document.createRange?((t=document.createRange()).selectNodeContents(n),t.collapse(!1),(e=window.getSelection()).removeAllRanges(),e.addRange(t)):void 0!==document.body.createTextRange&&((e=document.body.createTextRange()).moveToElementText(n),e.collapse(!1),e.select())},Contact.prototype.toggleNoteMode=function(t,e,n){var a=this,i=t.find(".contact-note-time"),t=t.find(".contact-note-content");"default"===n&&(e.find(this.btnNoteSave).attr("data-widget","edit-note").html('<i class="fa tmi30-pencil tmi30-12px"></i>Edit'),e.find(this.btnNoteUndo).html('<i class="fa tmi30-trash tmi30-12px"></i>Delete'),setTimeout(function(){e.find(a.btnNoteUndo).attr("data-widget","delete-note")},10),e.removeClass("active"),i.removeClass("hidden"),t.prop("contenteditable",!1)),"edit"===n&&(e.find(this.btnNoteEdit).attr("data-widget","save-change").html('<i class="fa tmi30-circle-checked tmi30-12px"></i>Save'),e.find(this.btnNoteDelete).attr("data-widget","undo-change").html('<i class="fa tmi30-circle-close tmi30-12px"></i>Cancel'),e.addClass("active"),i.addClass("hidden"),this.contenteditableFocus(t))},Contact.prototype.addNoteBtnClickHandler=function(){var t,e=$('.panel-contact-note[data-id=""]'),n=e.find(".contact-note-menu");1<e.length||(t=this.formNoteSearch.find('input[name="search-query"]'),$.trim(t.val())&&t.val("").trigger("input"),1===e.length&&e.clone().insertBefore(e),e.removeClass("hidden"),this.addNoteBtn.addClass("disabled"),$(this.notesContainer).find(".panel.panel-blank").addClass("hidden"),this.toggleNoteMode(e,n,"edit"))},Contact.prototype.editNoteBtnClickHandler=function(t){var e=$(t).closest(".panel-contact-note"),t=($(t).closest(".contact-note-menu"),{noteId:parseInt(e.attr("data-id")),contactId:this.cid,mode:"edit"});this.getNote(t,e,"edit")},Contact.prototype.undoChangeNoteBtnClickHandler=function(t){var t=$(t).closest(".panel-contact-note"),e=parseInt(t.attr("data-id"));if(hideErrors(this.topAlert),$(this.notesContainer).find(".panel.panel-blank").removeClass("hidden"),!e)return t.remove(),void this.addNoteBtn.removeClass("disabled");e={noteId:e,contactId:this.cid};this.getNote(e,t,"default")},Contact.prototype.getNote=function(t,a,i){var o=this,s=a.find(".contact-note-menu"),r=parseInt(a.attr("data-id"));$.ajax({url:o.getNoteURI,dataType:"HTML",method:"GET",data:t,beforeSend:function(){a.spin("enable")},success:function(t,e,n){n.success?(a.replaceWith(t),a=$('[data-widget="note"][data-id="'+r+'"]'),s=a.find(".contact-note-menu"),o.toggleNoteMode(a,s,i)):o.toggleNoteMode(a,s,"edit")},error:function(t){console.warn(t)},complete:function(t){a.spin("disable")}})},Contact.prototype.saveNoteBtnClickHandler=function(t){var a=this,i=$(t).closest(".panel-contact-note"),o=$(t).closest(".contact-note-menu"),t=i.find(".contact-note-content"),s=i.attr("data-id"),t={contactId:a.cid,note:$.trim(t.text()),noteId:s};$.ajax({url:a.getNoteURI,dataType:"HTML",method:"POST",data:t,beforeSend:function(){hideErrors(a.topAlert),i.spin("enable")},success:function(t,e,n){if(n.success){n=$(t).find(".errors .error");if(0<n.length)return $.each(n,function(t,e){a.topAlert.warningBlock($(e).text())}),void a.toggleNoteMode(i,o,"edit");i.replaceWith(t),s?a.topAlert.successBlock("Note has been updated."):(a.topAlert.successBlock("Note has been created."),a.updateCountNotes("+"),a.reloadNoteList({}))}else a.toggleNoteMode(i,o,"edit")},error:function(t){console.warn(t)},complete:function(t){i.spin("disable"),a.addNoteBtn.removeClass("disabled")}})},Contact.prototype.deleteNoteBtnClickHandler=function(t){var n=this,a=$(t).closest(".panel-contact-note"),i={url:"/online/contacts/ajax",cmd:"removeNote",noteId:a.attr("data-id")};if(!i.noteId)return a.remove(),n.topAlert.successBlock("Note has been deleted."),!1;$.confirm({title:"Delete note",message:"Are you sure you would like to delete note?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Delete",class:"btn btn-danger",click:function(){$(this).find("button.btn-danger").spin("enable","Deleting...");var e=this;$.post(i.url,i).done(function(t){if(1==t.success)return a.remove(),n.topAlert.successBlock("Note has been deleted."),$(e).modal("hide"),n.updateCountNotes("-"),n.reloadNoteList({}),!0;n.topAlert.warningBlock("An internal error has been occured.")}).fail(function(){return n.topAlert.warningBlock("An internal error has been occured."),!1})}}}})},Contact.prototype.reloadNoteList=function(t){hideErrors(this.topAlert),$(this.notesContainer).html(""),$(this.notesContainer).parent().find('[data-widget="note"]').not(".hidden").remove(),this.getNoteList(t)},Contact.prototype.getNoteList=function(a){var t,e,n,i=this;0!==$(this.notesContainer).length&&(n=a.pageNext||1,t=a.perPage||10,e=a.text||"",n={cid:this.cid,page:n,perPage:t,text:e},$.ajax({url:i.getNoteListURI,dataType:"html",method:"POST",data:n,beforeSend:function(){a.btn&&a.btn.spin("enable")},success:function(t,e,n){n.success&&(a.btn&&a.btn.remove(),$(i.notesContainer).append(t),"function"==typeof a.callback&&a.callback(),i.checkNotesEmptyState())},error:function(t){console.warn(t.status)},complete:function(t){}}))},Contact.prototype.contenteditablePaste=function(t){t=(t.originalEvent||t).clipboardData.getData("text/plain");document.execCommand("insertText",!1,t)},Contact.prototype.btnFavToggleClickHandler=function(){var n=this,a=parseInt(this.btnFavPanel.attr("data-state"));n.btnFavPanel.addClass("disabled"),n.crudApi.updateItems(this.cid,"favorited",Math.abs(a-1),function(t){n.btnFavPanel.removeClass("disabled");var e=$(".avatar-wrapper").find(".avatar");t.success&&(n.btnFavPanel.attr("data-state",Math.abs(a-1)),n.btnFavPanel.blur(),1===parseInt(n.btnFavPanel.attr("data-state"))?(n.btnFavPanel.html("<i class='fa tmi30-star-o tmi30-14px'></i>Unfavorite"),n.btnFavPanel.prop("title","Unfavorite contact"),e.addClass("starred")):(n.btnFavPanel.html("<i class='fa tmi30-star tmi30-14px'></i>Favorite"),n.btnFavPanel.prop("title","Favorite contact"),e.removeClass("starred")))})},Contact.prototype.toggleFavBtnClickHandler=function(t){var e=$(t),n=$(t).find("i.tmi30"),a=n.hasClass("tmi30-star-o");if(e.hasClass("loading"))return!1;e.spin("enable");this.crudApi.updateItems(e.closest("tr").data("id"),"favorited",a?1:0,function(){e.spin("disable"),a?n.removeClass("tmi30-star-o").addClass("tmi30-star"):n.removeClass("tmi30-star").addClass("tmi30-star-o")})},Contact.prototype.resetImageForms=function(){$.each(this.avatarCropForm.find('input[type="hidden"]'),function(t,e){$(e).val("")}),this.avatarUploadForm[0].reset()},Contact.prototype.initJcrop=function(t,e){var n=t.get(0).naturalWidth,a=t.get(0).naturalHeight;t.Jcrop({aspectRatio:1,minSize:[50,50],bgColor:"#666",bgOpacity:.5,allowSelect:!1,onSelect:function(t){e.find('[name="x1"]').val(t.x),e.find('[name="y1"]').val(t.y),e.find('[name="x2"]').val(t.x2),e.find('[name="y2"]').val(t.y2)},setSelect:[0,0,1e4,1e4],trueSize:[n,a]})},Contact.prototype.avatarUploadHandler=function(t){var e,o,s=this;return!(!window.FormData||!t.target)&&(!!(t=t.target.files[0])&&((e=new FormData).append("image",t),o=s.avatarUploadPreModal.find(".img-wrapper"),void $.ajax({url:"/online/contacts/avatar/upload/pre/"+parseInt(s.cid),cache:!1,contentType:!1,processData:!1,type:"POST",data:e,beforeSend:function(){hideErrors(s.topAlert),s.avatar.spin("enable","",{shadow:!0,top:"-2",left:"1"})},success:function(i){var t;i.success?(o.html(""),s.avatarUploadPreModal.off("shown.bs.modal").on("shown.bs.modal",function(){var t=i.data.tmpPath,e=i.data.originalName,n=$("<img>",{class:"img-preview",src:t}),a=s.avatarUploadPreModal.find("form");a.find('input[name="entityId"]').val(s.cid),a.find('input[name="tmpFile"]').val(t),a.find('input[name="originalName"]').val(e),o.prepend(n.load(function(){s.initJcrop($(this),a)}))}),s.avatarUploadPreModal.modal("show")):(t=i.data.errors,$.each(t,function(t,e){s.topAlert.warningBlock(e)}))},error:function(t){413===t.status&&s.topAlert.warningBlock("The maximum allowed file size is 10 MB.")},complete:function(t){s.avatar.spin("disable")}})))},Contact.prototype.avatarCropFormSubmitHandler=function(){var n,a=this,e=a.avatarCropForm.find('button[type="submit"]'),t={url:a.avatarCropForm.attr("action"),beforeSend:function(){e.spin("enable"),a.avatar.spin("enable","",{shadow:!0,top:"-2",left:"1"}),n=a.avatar.css("background-image"),a.avatar.css("background-image","none")},success:function(t){var e;t.success?(a.avatarUploadPreModal.modal("hide"),(e=t.data.newPath)&&(a.avatarLabel.addClass("hidden"),a.avatar.css("background-image","url("+e+")")),a.topAlert.successBlock(t.message),a.resetImageForms(),a.toggleAvatarState(!0)):(t.data&&(e=t.data.errors||{},$.each(e,function(t,e){a.topAlert.warningBlock(e)})),a.avatar.css("background-image",n))},error:function(t){console.warn(t)},complete:function(t){e.spin("disable"),a.avatar.spin("disable")}};a.avatarCropForm.ajaxForm().ajaxSubmit(t)},Contact.prototype.toggleAvatarState=function(t){this.avatarControl.html(t?'<a href="javascript:void(0);" class="avatar-overlay dropdown" data-toggle="dropdown"><i class="fa tmi30-camera"></i></a><ul class="dropdown-menu text-left"><li><a href="javascript:void(0);" data-widget="change-avatar" title="Upload contact\'s profile photo"><i class="fa tmi30-arrow-upload tmi30-10px"></i>Upload a new avatar</a></li><li><a href="javascript:void(0);" data-widget="remove-avatar" title="Remove contact\'s profile photo"><i class="fa tmi30-trash tmi30-12px"></i>Remove avatar</a></li></ul>':'<a href="javascript:void(0);" class="avatar-overlay" data-widget="change-avatar"><i class="fa tmi30-camera"></i></a>')},Contact.prototype.avatarRemoveHandler=function(){var a,i=this;$.confirm({title:"Remove avatar",message:"Are you sure you would like to remove contact's avatar?",buttons:{cancel:{class:"btn btn-default",text:"Cancel"},ok:{text:"Remove",class:"btn btn-danger",click:function(){var e=this,n=$(this).find("button.btn-danger");n.spin("enable","Removing...");$.ajax({url:i.options.commandUrl,dataType:"JSON",method:"POST",data:{cmd:"removeAvatar",cid:i.cid},beforeSend:function(){i.avatar.spin("enable","",{shadow:!0,top:"-2",left:"1"}),a=i.avatar.css("background-image")},success:function(t){t.success?(i.avatar.css("background-image","none"),i.avatarLabel.removeClass("hidden"),i.topAlert.successBlock(t.message),i.toggleAvatarState(!1)):(t=t.data.errors,$.each(t,function(t,e){i.topAlert.warningBlock(e)}),i.avatar.css("background-image",a))},error:function(t){console.warn(t)},complete:function(t){i.avatar.spin("disable"),n.spin("disable"),$(e).modal("hide")}})}}}})},Contact.prototype.copyToListSuccessCallback=function(){this.topAlert.successBlock("Selected contacts have been successfully copied."),this.renderEl(),this.crudApi.getPaginationApi().reload()},Contact.prototype.btnSaveAutoUnsubscribeClickHandler=function(){var a=this,t=this.autoUnsubscribeCheckbox.is(":checked"),e=this.inpAutoUnsubscribeCounter.val();this.skipCloseChatAfterUnsubscribe=$('[name="skipCloseChatAfterUnsubscribe"]:checked').val(),$.ajax({url:a.saveAutoUnsubscribeURI,method:"POST",data:{cmd:this.saveAutoUnsubscribeCmd,count:t?e:0,sendStopReply:+this.sendStopReply,replyTemplateId:this.stopReplyTemplateId,sendStopReplyOnManual:+this.sendStopReplyOnManual,skipCloseChatAfterUnsubscribe:+this.skipCloseChatAfterUnsubscribe},beforeSend:function(){a.btnSaveAutoUnsubscribe.spin("enable","Saving...")},success:function(t,e,n){n.success&&a.topAlert.successBlock("Unsubscribe settings have been updated.")},error:function(t){console.warn(t)},complete:function(t){a.btnSaveAutoUnsubscribe.spin("disable"),a.autoUnsubscribeModal.modal("hide")}})},Contact.prototype.btnCncInPrflOnClick=function(t){t.removeClass("visible"),t.closest("td").find(this.btnEditInPrfl).addClass("visible"),t.closest("tr").find(this.btnSaveInPrfl).removeClass("visible"),t.closest("tr").find(this.textInPrfl).addClass("visible"),t.closest("tr").find(this.inpInPrfl).removeClass("visible")},Contact.prototype.btnEditInPrflOnClick=function(t){var e=this;$("#contact-data table").find("tr").each(function(){var t=$(this);t.find(e.btnSaveInPrfl).removeClass("visible"),t.find(e.btnCncInPrfl).removeClass("visible"),t.find(e.textInPrfl).addClass("visible"),t.find(e.inpInPrfl).removeClass("visible"),t.find(e.btnEditInPrfl).addClass("visible")}),t.removeClass("visible"),t.closest("td").find(this.btnSaveInPrfl).addClass("visible"),t.closest("td").find(this.btnCncInPrfl).addClass("visible"),t.closest("tr").find(this.textInPrfl).removeClass("visible"),t.closest("tr").find(this.inpInPrfl).addClass("visible")},Contact.prototype.toggleDisableInlineProfileBtn=function(e){$("#contact-data table").find("tr").each(function(){var t=$(this);!0===e?(t.find("td.actions .btn-default").addClass("disabled"),t.find("td.actions .btn-success").addClass("disabled")):(t.find("td.actions .btn-default").removeClass("disabled"),t.find("td.actions .btn-success").removeClass("disabled"))})},Contact.prototype.btnSaveInPrflOnClick=function(t){var n=this,e=t.closest("tr").attr("data-name"),a=t.closest("tr").find(this.inpInPrfl).val(),t=parseInt(t.closest("tr").attr("data-cfid")),i={cmd:"patchContact",cid:this.cid,custom:{}};t?i.custom[t]=a:i[e]=a,$.ajax({url:n.options.commandUrl,dataType:"JSON",method:"POST",data:i,beforeSend:function(){hideErrors('[data-widget="top-alert"]'),n.toggleDisableInlineProfileBtn(!0)},success:function(t){if(t.success)n.renderEl(),n.topAlert.successBlock(t.message);else for(var e in t.message)n.topAlert.warningBlock(t.message[e])},error:function(t){console.warn(t)},complete:function(t){n.toggleDisableInlineProfileBtn()}})},function(t){this.init(t)}),dateFormat=(SelectContact.prototype.init=function(t){var i=this;this.options=$.extend({},{containerSelector:"#select-contacts-container",paginationCommand:"tableSelectContact",paginationScroll:!1,commandUrl:"/online/contacts/ajax/0",itemSelector:"tr[data-widget=select-contact]",searchFormSelector:"#select-contacts-search",paginationRecount:!0,dontInitExport:!0,beforeReloadFunction:function(t){var e=t.getOptions().requestParams,n="#select-contacts-container";e.hasOwnProperty("params")?e.params=$.extend({},e.params,{source:$(n).attr("data-source")}):e.params={source:$(n).attr("data-source")},t.setOptions({requestParams:e})},callbackRecount:function(t){var e=t.data.total,n=$(i.crudApi.getOptions().containerSelector),a=("function"==typeof $.fn.format&&(e=$.fn.format(e)),t.data.overlimit),a=void 0!==a&&a?"many":e,e=(n.find('[data-crud-count="count"]').text(a),t.data.export_total),a=(void 0!==e&&n.find("[data-crud-export-count]").attr("data-crud-export-count",e),n.find('[data-crud-max="max"]'));parseInt(a.text())>=t.data.total&&(a.text(t.data.total),n.find("ul.pager li.next").addClass("disabled").off("click")),0<i.lnkNewMsgAddContacts.length&&0===parseInt(t.data.total)&&i.lnkNewMsgAddContacts.attr("href","#addContactWayModal")},checkboxChangeFunction:function(t){var e=$(t).closest("tr").data("id"),n=i.crudApi.getOptions().itemSelector;void 0===window.checkedData&&(window.checkedData=[]),$(t).is(":checked")?(i.crudApi.addCheckedItems([e]),window.checkedData.push($(t).closest("tr").data())):!0===i.crudApi.getCheckedAllItems()?(i.crudApi.setCheckedAllItems(!1),i.crudApi.setCheckedItems([]),window.checkedData=[],$(n).each(function(){$(this).find('input[type="checkbox"]').is(":checked")&&(i.crudApi.addCheckedItems([$(this).data("id")]),window.checkedData.pushOnce($(this).data()))})):(i.crudApi.removeCheckedItems([e]),window.checkedData.popAll($(n+'[data-id="'+e+'"]').data())),i.toggleAddButton(),this.togglePager()},topCheckboxChangeFunction:function(t){var t=$(t).is(":checked"),e=i.crudApi.getOptions().itemSelector,t=(void 0===window.checkedData&&(window.checkedData=[]),t?$(e).each(function(){i.crudApi.addCheckedItems([$(this).data("id")]),window.checkedData.pushOnce($(this).data())}):($(e).each(function(){i.crudApi.removeCheckedItems([$(this).data("id")]),window.checkedData.popAll($(this).data())}),i.crudApi.setCheckedAllItems(!1)),null);i.crudApi.getCheckedAllItems()&&(e=i.crudApi.getOptions().containerSelector,t=parseInt($(e).find("[data-crud-export-count]").attr("data-crud-export-count"))),i.toggleAddButton(t),this.togglePager()},selectAllFunction:function(t){var e=i.crudApi.getOptions().containerSelector,e=$(e).find("[data-options-select]");parseInt(e.find("span.value").text().replace(/\D/g,""))<2||(window.checkedData=[],i.crudApi.setCheckedAllItems(!0),i.crudApi.setCheckedItems([]),this.togglePager())},getItemsCount:function(){return i.crudApi.getCheckedItems().length}},t),this.topAlert=$('[data-widget="top-alert"]'),this.modalAddressBook=$("#addressBookModal"),this.btnLetter=$("dl.sorting-list li a"),this.btnAdd=this.modalAddressBook.find("#addContactsButton"),this.lnkNewMsgAddContacts=$("#formNewMessage").find("a#add-contacts-to-message"),this.getItemsCount=this.options.getItemsCount,this.initCrudApi()},SelectContact.prototype.initCrudApi=function(){this.crudApi=$.prepareCrudPage(this.options)},SelectContact.prototype.btnLetterClickHandler=function(t){var e=t.parent().hasClass("active"),n=(t.parent().parent().find("li.active").removeClass("active"),this.crudApi.getPaginationApi()),a=n.getRequestParams().params,a=e?(t.parent().removeClass("active"),$.extend({},a,{first:"",text:""})):(t.parent().addClass("active"),$.extend({},a,{first:t.text(),text:""}));n.setRequestParams({params:a}).reload()},SelectContact.prototype.btnAddListClickHandler=function(t,e){var n,a,i;parseInt(t)&&(a=(n=this).crudApi.getCheckedItems(),i=this.crudApi.getCheckedAllItems(),this.modalAddressBook.find("dl.sorting-list li.active a").text(),this.modalAddressBook.find('input[name="search-query"]').val(),$.ajax({url:n.options.commandUrl,dataType:"JSON",method:"POST",data:{cmd:"moveContact",contacts:a,toListId:t,moveMethod:"cp",all:i},beforeSend:function(){n.btnAdd.spin("enable")},success:function(t){if(t.success)return n.modalAddressBook.modal("hide"),e.func.apply(e.context),!0},error:function(t){console.warn(t)},complete:function(t){n.btnAdd.spin("disable")}}))},SelectContact.prototype.modalAddressBookHiddenHandler=function(t){this.btnLetter.parent().parent().find("li.active").removeClass("active");var e=this.crudApi.getPaginationApi(),n=e.getRequestParams().params,n=$.extend({},n,{first:"",text:""});e.setRequestParams({params:n}),this.modalAddressBookReset(this,t)},SelectContact.prototype.modalAddressBookReset=function(t,e){e=$(e).find("input[name=search-query]");""!=e.val()&&e.val("").change(),t.crudApi.setCheckedAllItems(!1),t.crudApi.setCheckedItems([]),window.checkedData=[],t.crudApi.getPaginationApi().setOptions({page:1}),t.crudApi.getPaginationApi().reload(),this.toggleAddButton()},SelectContact.prototype.toggleAddButton=function(t){var t=t||this.getItemsCount(),e=$("span.plural",this.btnAdd),t=parseInt(t);e.text(1===t?"":"s"),1<=t?this.btnAdd.enableButton():this.btnAdd.disableButton(),"function"==typeof $.fn.format&&(t=$.fn.format(t)),$("span.value",this.btnAdd).text(t)},SelectContact.prototype.handleBulkItemsAdd=function(e){var n=this,t=this.modalAddressBook.find("dl.sorting-list li.active a").text(),a=this.modalAddressBook.find('input[name="search-query"]').val(),t={cmd:"createGroup",contacts:e.contacts,letter:t,text:a,shared:!0};$.ajax({url:n.options.commandUrl,dataType:"JSON",method:"POST",data:t,beforeSend:function(){n.btnAdd.spin("enable")},success:function(t){t.success&&(t=t.data,e.callbackAddContact&&e.callbackAddContact.func.apply(e.callbackAddContact.context,[{groupId:t.group_id,name:t.name,count:t.members},!0]),e.callbackTagEdit&&e.callbackTagEdit())},error:function(t){console.warn(t)},complete:function(t){n.btnAdd.spin("disable")}})},SelectContact.prototype.sendCheckedItemsHandler=function(a){var i,o,t,s=this,r=!1,d=this.crudApi.getCheckedItems().length,r=this.crudApi.getCheckedAllItems()?"all":this.crudApi.getCheckedItems();(1<d||"all"===r)&&(t={cmd:"createGroup"},"all"===r?(t.contacts=r,t.letter=this.modalAddressBook.find("dl.sorting-list li.active a").text(),t.text=this.modalAddressBook.find('input[name="search-query"]').val(),t.shared=!0):r.length<=100?t.contacts=r:t.contacts=[r[0]],o=function(t,e){var n=$("div.progress-bar");n.data("aria-valuenow",t),n.data("aria-valuemax",e),n.css("width",parseInt(100*t/e)+"%"),n.find('span[data-widget="items-processed"]').text(t),n.find('span[data-widget="items-total"]').text(e)},100<d&&"all"!==r&&(o(0,d),$("#send-progress-modal button.cancel").click(function(){a(!1,"cancel"),$("#send-progress-modal").modal("hide")}),$("#send-progress-modal").modal("show"),$("#send-progress-modal").on("hide.bs.modal",function(t){clearTimeout(i),s.crudApi.setCheckedItems([]),s.crudApi.getPaginationApi().reload()})),this.crudApi.post(t,function(n){"all"===r?a(n.data,!1):function e(){var t={cmd:"getCreationGroupProcess",group_id:n.data.group_id,contacts:r.splice(0,100)};s.crudApi.post(t,function(t){t.success?t.data.processed>=d?(o(t.data.processed,d),clearTimeout(i),$("#send-progress-modal").modal("hide"),a(t.data,!1)):(o(t.data.processed,d),i=setTimeout(function(){e()},2e3)):(clearTimeout(i),a(!1,t.message),$("#send-progress-modal").modal("hide"))})}()}))},function(){function m(t,e){for(t=String(t),e=e||2;t.length<e;)t="0"+t;return t}var f=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,g=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,b=/[^-+\dA-Z]/g;return function(t,e,n){var a=dateFormat;if(1!=arguments.length||"[object String]"!=Object.prototype.toString.call(t)||/\d/.test(t)||(e=t,t=void 0),t=t?new Date(t):new Date,isNaN(t))throw SyntaxError("invalid date");"UTC:"==(e=String(a.masks[e]||e||a.masks.default)).slice(0,4)&&(e=e.slice(4),n=!0);var i=n?"getUTC":"get",o=t[i+"Date"](),s=t[i+"Day"](),r=t[i+"Month"](),d=t[i+"FullYear"](),l=t[i+"Hours"](),c=t[i+"Minutes"](),u=t[i+"Seconds"](),i=t[i+"Milliseconds"](),h=n?0:t.getTimezoneOffset(),p={d:o,dd:m(o),ddd:a.i18n.dayNames[s],dddd:a.i18n.dayNames[s+7],m:r+1,mm:m(r+1),mmm:a.i18n.monthNames[r],mmmm:a.i18n.monthNames[r+12],yy:String(d).slice(2),yyyy:d,h:l%12||12,hh:m(l%12||12),H:l,HH:m(l),M:c,MM:m(c),s:u,ss:m(u),l:m(i,3),L:m(99<i?Math.round(i/10):i),t:l<12?"a":"p",tt:l<12?"am":"pm",T:l<12?"A":"P",TT:l<12?"AM":"PM",Z:n?"UTC":(String(t).match(g)||[""]).pop().replace(b,""),o:(0<h?"-":"+")+m(100*Math.floor(Math.abs(h)/60)+Math.abs(h)%60,4),S:["th","st","nd","rd"][3<o%10?0:(o%100-o%10!=10)*o%10]};return e.replace(f,function(t){return t in p?p[t]:t.slice(1,t.length-1)})}}());dateFormat.masks={default:"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"},dateFormat.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]},Date.prototype.format=function(t,e){return dateFormat(this,t,e)};