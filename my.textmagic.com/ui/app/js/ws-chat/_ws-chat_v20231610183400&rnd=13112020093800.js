!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.SIP=t():e.SIP=t()}(this,function(){return function(e){var t={};function i(s){if(t[s])return t[s].exports;var r=t[s]={i:s,l:!1,exports:{}};return e[s].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=e,i.c=t,i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)i.d(s,r,function(t){return e[t]}.bind(null,r));return s},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=2)}([function(e,t){var i;i=function(){return this}();try{i=i||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(i=window)}e.exports=i},function(e,t,i){"use strict";e.exports=function(e){var t=function(e,t){};return t.prototype=Object.create(e.EventEmitter.prototype,{connect:{writable:!0,value:function(e){return e=e||{},this.connectPromise(e).then(function(e){!e.overrideEvent&&this.emit("connected")}.bind(this))}},connectPromise:{writable:!0,value:function(e){}},isConnected:{writable:!0,value:function(){}},send:{writable:!0,value:function(e,t){return t=t||{},this.sendPromise(e).then(function(e){!e.overrideEvent&&this.emit("messageSent",e.msg)}.bind(this))}},sendPromise:{writable:!0,value:function(e,t){}},onMessage:{writable:!0,value:function(e){}},disconnect:{writable:!0,value:function(e){return e=e||{},this.disconnectPromise(e).then(function(e){!e.overrideEvent&&this.emit("disconnected")}.bind(this))}},disconnectPromise:{writable:!0,value:function(e){}},afterConnected:{writable:!0,value:function(e){this.isConnected()?e():this.once("connected",e)}},waitForConnected:{writable:!0,value:function(){return console.warn("DEPRECATION WARNING Transport.waitForConnected(): use afterConnected() instead"),new e.Utils.Promise(function(e){this.afterConnected(e)}.bind(this))}}}),t}},function(e,t,i){"use strict";e.exports=i(3)(i(40))},function(e,t,i){"use strict";e.exports=function(e){var t=i(4),s=t.version,r=t.title,n=Object.defineProperties({},{version:{get:function(){return s}},name:{get:function(){return r}}});return i(5)(n,e),n.LoggerFactory=i(6)(e.console),n.EventEmitter=i(7)(),n.C=i(9)(n.name,n.version),n.Exceptions=i(10),n.Timers=i(11)(e.timers),n.Transport=i(1)(n),i(12)(n),i(13)(n),i(14)(n),i(15)(n),i(16)(n),i(17)(n),i(19)(n),i(20)(n),n.SessionDescriptionHandler=i(21)(n.EventEmitter),i(22)(n),i(23)(n),i(24)(n),i(26)(n),i(27)(n),i(28)(n,e),i(32)(n),n.DigestAuthentication=i(33)(n.Utils),n.Grammar=i(36)(n),n.Web={Modifiers:i(38)(n),Simple:i(39)(n)},n}},function(e){e.exports={name:"sip.js",title:"SIP.js",description:"A simple, intuitive, and powerful JavaScript signaling library",version:"0.11.14",main:"dist/sip.js",browser:{"./src/environment.js":"./src/environment_browser.js"},homepage:"https://sipjs.com",author:"OnSIP <developer@onsip.com> (https://sipjs.com/aboutus/)",contributors:[{url:"https://github.com/onsip/SIP.js/blob/master/THANKS.md"}],repository:{type:"git",url:"https://github.com/onsip/SIP.js.git"},keywords:["sip","websocket","webrtc","library","javascript"],devDependencies:{"babel-core":"^6.26.0","babel-loader":"^7.1.2","babel-preset-env":"^1.6.1",eslint:"^4.9.0","jasmine-core":"^3.1.0",karma:"^2.0.2","karma-chrome-launcher":"^2.2.0","karma-cli":"^1.0.1","karma-jasmine":"^1.1.0","karma-jasmine-html-reporter":"^1.2.0","karma-mocha-reporter":"^2.2.5","karma-webpack":"^3.0.0",pegjs:"^0.10.0","pegjs-loader":"^0.5.4","uglifyjs-webpack-plugin":"^1.2.5",webpack:"^4.16.0","webpack-cli":"^3.0.8"},engines:{node:">=6.0"},license:"MIT",scripts:{prebuild:"eslint src/*.js src/**/*.js","build-dev":"webpack --progress --env.buildType dev","build-prod":"webpack --progress --env.buildType prod","copy-dist-files":"cp dist/sip.js dist/sip-$npm_package_version.js && cp dist/sip.min.js  dist/sip-$npm_package_version.min.js",build:"npm run build-dev && npm run build-prod && npm run copy-dist-files",browserTest:"sleep 2 && open http://0.0.0.0:9876/debug.html & karma start --reporters kjhtml --no-single-run",commandLineTest:"karma start --reporters mocha --browsers ChromeHeadless --single-run",buildAndTest:"npm run build && npm run commandLineTest",buildAndBrowserTest:"npm run build && npm run browserTest"},dependencies:{"crypto-js":"^3.1.9-1"},optionalDependencies:{promiscuous:"^0.6.0"}}},function(e,t,i){"use strict";e.exports=function(e,t){var i;i={Promise:t.Promise,defer:function(){var e={};return e.promise=new i.Promise(function(t,i){e.resolve=t,e.reject=i}),e},reducePromises:function(t,i){return t.reduce(function(e,t){return e=e.then(t)},e.Utils.Promise.resolve(i))},augment:function(e,t,i,s){var r,n;for(r in n=t.prototype)(s||void 0===e[r])&&(e[r]=n[r]);t.apply(e,i)},defaultOptions:function(e,t){return e=e||{},t=t||{},Object.assign({},e,t)},optionsOverride:function(e,t,i,s,r,n){s&&e[i]&&r.warn(i+" is deprecated, please use "+t+" instead"),e[t]&&e[i]&&r.warn(t+" overriding "+i),e[t]=e[t]||e[i]||n},str_utf8_length:function(e){return encodeURIComponent(e).replace(/%[A-F\d]{2}/g,"U").length},generateFakeSDP:function(e){if(e){var t=e.indexOf("o="),i=e.indexOf("\r\n",t);return"v=0\r\n"+e.slice(t,i)+"\r\ns=-\r\nt=0 0\r\nc=IN IP4 0.0.0.0"}},isFunction:function(e){return void 0!==e&&"[object Function]"===Object.prototype.toString.call(e)},isDecimal:function(e){return!isNaN(e)&&parseFloat(e)===parseInt(e,10)},createRandomToken:function(e,t){var i,s="";for(t=t||32,i=0;i<e;i++)s+=(Math.random()*t|0).toString(t);return s},newTag:function(){return e.Utils.createRandomToken(e.UA.C.TAG_LENGTH)},newUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})},hostType:function(t){if(t)return-1!==(t=e.Grammar.parse(t,"host"))?t.host_type:void 0},normalizeTarget:function(t,i){var s,r,n;if(t){if(t instanceof e.URI)return t;if("string"==typeof t){switch((s=t.split("@")).length){case 1:if(!i)return;r=t,n=i;break;case 2:r=s[0],n=s[1];break;default:r=s.slice(0,s.length-1).join("@"),n=s[s.length-1]}return r=r.replace(/^(sips?|tel):/i,""),/^[\-\.\(\)]*\+?[0-9\-\.\(\)]+$/.test(r)&&(r=r.replace(/[\-\.\(\)]/g,"")),t=e.C.SIP+":"+e.Utils.escapeUser(r)+"@"+n,e.URI.parse(t)}}else;},escapeUser:function(e){return encodeURIComponent(decodeURIComponent(e)).replace(/%3A/gi,":").replace(/%2B/gi,"+").replace(/%3F/gi,"?").replace(/%2F/gi,"/")},headerize:function(e){var t,i={"Call-Id":"Call-ID",Cseq:"CSeq","Min-Se":"Min-SE",Rack:"RAck",Rseq:"RSeq","Www-Authenticate":"WWW-Authenticate"},s=e.toLowerCase().replace(/_/g,"-").split("-"),r="",n=s.length;for(t=0;t<n;t++)0!==t&&(r+="-"),r+=s[t].charAt(0).toUpperCase()+s[t].substring(1);return i[r]&&(r=i[r]),r},sipErrorCause:function(t){var i;for(i in e.C.SIP_ERROR_CAUSES)if(-1!==e.C.SIP_ERROR_CAUSES[i].indexOf(t))return e.C.causes[i];return e.C.causes.SIP_FAILURE_CODE},getReasonPhrase:function(t,i){return i||e.C.REASON_PHRASE[t]||""},getReasonHeaderValue:function(t,i){return"SIP;cause="+t+';text="'+(i=e.Utils.getReasonPhrase(t,i))+'"'},getCancelReason:function(t,i){if(t&&t<200||t>699)throw new TypeError("Invalid status_code: "+t);if(t)return e.Utils.getReasonHeaderValue(t,i)},buildStatusLine:function(e,t){if(e=e||null,t=t||null,!e||e<100||e>699)throw new TypeError("Invalid status_code: "+e);if(t&&"string"!=typeof t&&!(t instanceof String))throw new TypeError("Invalid reason_phrase: "+t);return"SIP/2.0 "+e+" "+(t=i.getReasonPhrase(e,t))+"\r\n"},getRandomTestNetIP:function(){return"192.0.2."+function(e,t){return Math.floor(Math.random()*(t-e+1)+e)}(1,254)}},e.Utils=i}},function(e,t,i){"use strict";var s={error:0,warn:1,log:2,debug:3};e.exports=function(e){var t=function(){var e,t=2,i=!0,r=null;this.loggers={},e=this.getLogger("sip.loggerfactory"),Object.defineProperties(this,{builtinEnabled:{get:function(){return i},set:function(t){"boolean"==typeof t?i=t:e.error('invalid "builtinEnabled" parameter value: '+JSON.stringify(t))}},level:{get:function(){return t},set:function(i){i>=0&&i<=3?t=i:i>3?t=3:s.hasOwnProperty(i)?t=s[i]:e.error('invalid "level" parameter value: '+JSON.stringify(i))}},connector:{get:function(){return r},set:function(t){null===t||""===t||void 0===t?r=null:"function"==typeof t?r=t:e.error('invalid "connector" parameter value: '+JSON.stringify(t))}}})};function i(e,t,i){this.logger=e,this.category=t,this.label=i}return t.prototype.print=function(t,i,s,r){if("string"==typeof r){var n=[new Date,i];s&&n.push(s),r=n.concat(r).join(" | ")}t.call(e,r)},Object.keys(s).forEach(function(r){i.prototype[r]=function(e){this.logger[r](this.category,this.label,e)},t.prototype[r]=function(t,i,n){this.level>=s[r]&&(this.builtinEnabled&&this.print(e[r],t,i,n),this.connector&&this.connector(r,t,i,n))}}),t.prototype.getLogger=function(e,t){var s;return t&&3===this.level?new i(this,e,t):this.loggers[e]?this.loggers[e]:(s=new i(this,e),this.loggers[e]=s,s)},t}},function(e,t,i){"use strict";var s=i(8).EventEmitter;e.exports=function(){function e(){s.call(this)}return e.prototype=Object.create(s.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),e}},function(e,t){function i(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function s(e){return"function"==typeof e}function r(e){return"object"==typeof e&&null!==e}function n(e){return void 0===e}e.exports=i,i.EventEmitter=i,i.prototype._events=void 0,i.prototype._maxListeners=void 0,i.defaultMaxListeners=10,i.prototype.setMaxListeners=function(e){if(!function(e){return"number"==typeof e}(e)||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},i.prototype.emit=function(e){var t,i,o,a,c,h;if(this._events||(this._events={}),"error"===e&&(!this._events.error||r(this._events.error)&&!this._events.error.length)){if((t=arguments[1])instanceof Error)throw t;var u=new Error('Uncaught, unspecified "error" event. ('+t+")");throw u.context=t,u}if(n(i=this._events[e]))return!1;if(s(i))switch(arguments.length){case 1:i.call(this);break;case 2:i.call(this,arguments[1]);break;case 3:i.call(this,arguments[1],arguments[2]);break;default:a=Array.prototype.slice.call(arguments,1),i.apply(this,a)}else if(r(i))for(a=Array.prototype.slice.call(arguments,1),o=(h=i.slice()).length,c=0;c<o;c++)h[c].apply(this,a);return!0},i.prototype.addListener=function(e,t){var o;if(!s(t))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,s(t.listener)?t.listener:t),this._events[e]?r(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,r(this._events[e])&&!this._events[e].warned&&(o=n(this._maxListeners)?i.defaultMaxListeners:this._maxListeners)&&o>0&&this._events[e].length>o&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace()),this},i.prototype.on=i.prototype.addListener,i.prototype.once=function(e,t){if(!s(t))throw TypeError("listener must be a function");var i=!1;function r(){this.removeListener(e,r),i||(i=!0,t.apply(this,arguments))}return r.listener=t,this.on(e,r),this},i.prototype.removeListener=function(e,t){var i,n,o,a;if(!s(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(o=(i=this._events[e]).length,n=-1,i===t||s(i.listener)&&i.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(r(i)){for(a=o;a-->0;)if(i[a]===t||i[a].listener&&i[a].listener===t){n=a;break}if(n<0)return this;1===i.length?(i.length=0,delete this._events[e]):i.splice(n,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},i.prototype.removeAllListeners=function(e){var t,i;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(s(i=this._events[e]))this.removeListener(e,i);else if(i)for(;i.length;)this.removeListener(e,i[i.length-1]);return delete this._events[e],this},i.prototype.listeners=function(e){return this._events&&this._events[e]?s(this._events[e])?[this._events[e]]:this._events[e].slice():[]},i.prototype.listenerCount=function(e){if(this._events){var t=this._events[e];if(s(t))return 1;if(t)return t.length}return 0},i.listenerCount=function(e,t){return e.listenerCount(t)}},function(e,t,i){"use strict";e.exports=function(e,t){return{USER_AGENT:e+"/"+t,SIP:"sip",SIPS:"sips",causes:{CONNECTION_ERROR:"Connection Error",REQUEST_TIMEOUT:"Request Timeout",SIP_FAILURE_CODE:"SIP Failure Code",INTERNAL_ERROR:"Internal Error",BUSY:"Busy",REJECTED:"Rejected",REDIRECTED:"Redirected",UNAVAILABLE:"Unavailable",NOT_FOUND:"Not Found",ADDRESS_INCOMPLETE:"Address Incomplete",INCOMPATIBLE_SDP:"Incompatible SDP",AUTHENTICATION_ERROR:"Authentication Error",DIALOG_ERROR:"Dialog Error",WEBRTC_NOT_SUPPORTED:"WebRTC Not Supported",WEBRTC_ERROR:"WebRTC Error",CANCELED:"Canceled",NO_ANSWER:"No Answer",EXPIRES:"Expires",NO_ACK:"No ACK",NO_PRACK:"No PRACK",USER_DENIED_MEDIA_ACCESS:"User Denied Media Access",BAD_MEDIA_DESCRIPTION:"Bad Media Description",RTP_TIMEOUT:"RTP Timeout"},supported:{UNSUPPORTED:"none",SUPPORTED:"supported",REQUIRED:"required"},SIP_ERROR_CAUSES:{REDIRECTED:[300,301,302,305,380],BUSY:[486,600],REJECTED:[403,603],NOT_FOUND:[404,604],UNAVAILABLE:[480,410,408,430],ADDRESS_INCOMPLETE:[484],INCOMPATIBLE_SDP:[488,606],AUTHENTICATION_ERROR:[401,407]},ACK:"ACK",BYE:"BYE",CANCEL:"CANCEL",INFO:"INFO",INVITE:"INVITE",MESSAGE:"MESSAGE",NOTIFY:"NOTIFY",OPTIONS:"OPTIONS",REGISTER:"REGISTER",UPDATE:"UPDATE",SUBSCRIBE:"SUBSCRIBE",PUBLISH:"PUBLISH",REFER:"REFER",PRACK:"PRACK",REASON_PHRASE:{100:"Trying",180:"Ringing",181:"Call Is Being Forwarded",182:"Queued",183:"Session Progress",199:"Early Dialog Terminated",200:"OK",202:"Accepted",204:"No Notification",300:"Multiple Choices",301:"Moved Permanently",302:"Moved Temporarily",305:"Use Proxy",380:"Alternative Service",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",410:"Gone",412:"Conditional Request Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Unsupported URI Scheme",417:"Unknown Resource-Priority",420:"Bad Extension",421:"Extension Required",422:"Session Interval Too Small",423:"Interval Too Brief",428:"Use Identity Header",429:"Provide Referrer Identity",430:"Flow Failed",433:"Anonymity Disallowed",436:"Bad Identity-Info",437:"Unsupported Certificate",438:"Invalid Identity Header",439:"First Hop Lacks Outbound Support",440:"Max-Breadth Exceeded",469:"Bad Info Package",470:"Consent Needed",478:"Unresolvable Destination",480:"Temporarily Unavailable",481:"Call/Transaction Does Not Exist",482:"Loop Detected",483:"Too Many Hops",484:"Address Incomplete",485:"Ambiguous",486:"Busy Here",487:"Request Terminated",488:"Not Acceptable Here",489:"Bad Event",491:"Request Pending",493:"Undecipherable",494:"Security Agreement Required",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Server Time-out",505:"Version Not Supported",513:"Message Too Large",580:"Precondition Failure",600:"Busy Everywhere",603:"Decline",604:"Does Not Exist Anywhere",606:"Not Acceptable"},OPTION_TAGS:{"100rel":!0,199:!0,answermode:!0,"early-session":!0,eventlist:!0,explicitsub:!0,"from-change":!0,"geolocation-http":!0,"geolocation-sip":!0,gin:!0,gruu:!0,histinfo:!0,ice:!0,join:!0,"multiple-refer":!0,norefersub:!0,nosub:!0,outbound:!0,path:!0,policy:!0,precondition:!0,pref:!0,privacy:!0,"recipient-list-invite":!0,"recipient-list-message":!0,"recipient-list-subscribe":!0,replaces:!0,"resource-priority":!0,"sdp-anat":!0,"sec-agree":!0,tdialog:!0,timer:!0,uui:!0},dtmfType:{INFO:"info",RTP:"rtp"}}}},function(e,t,i){"use strict";e.exports={ConfigurationError:function(){var e=function(e,t){this.code=1,this.name="CONFIGURATION_ERROR",this.parameter=e,this.value=t,this.message=this.value?"Invalid value "+JSON.stringify(this.value)+' for parameter "'+this.parameter+'"':"Missing parameter: "+this.parameter};return e.prototype=new Error,e}(),InvalidStateError:function(){var e=function(e){this.code=2,this.name="INVALID_STATE_ERROR",this.status=e,this.message="Invalid status: "+e};return e.prototype=new Error,e}(),NotSupportedError:function(){var e=function(e){this.code=3,this.name="NOT_SUPPORTED_ERROR",this.message=e};return e.prototype=new Error,e}(),GetDescriptionError:function(){var e=function(e){this.code=4,this.name="GET_DESCRIPTION_ERROR",this.message=e};return e.prototype=new Error,e}(),RenegotiationError:function(){var e=function(e){this.code=5,this.name="RENEGOTIATION_ERROR",this.message=e};return e.prototype=new Error,e}(),MethodParameterError:function(){var e=function(e,t,i){this.code=6,this.name="METHOD_PARAMETER_ERROR",this.method=e,this.parameter=t,this.value=i,this.message=this.value?"Invalid value "+JSON.stringify(this.value)+' for parameter "'+this.parameter+'"':"Missing parameter: "+this.parameter};return e.prototype=new Error,e}(),TransportError:function(){var e=function(e){this.code=7,this.name="TRANSPORT_ERROR",this.message=e};return e.prototype=new Error,e}()}},function(e,t,i){"use strict";var s=500;e.exports=function(e){var t={T1:s,T2:4e3,T4:5e3,TIMER_B:32e3,TIMER_D:0,TIMER_F:32e3,TIMER_H:32e3,TIMER_I:0,TIMER_J:0,TIMER_K:0,TIMER_L:32e3,TIMER_M:32e3,TIMER_N:32e3,PROVISIONAL_RESPONSE_INTERVAL:6e4};return["setTimeout","clearTimeout","setInterval","clearInterval"].forEach(function(i){t[i]=function(){return e[i].apply(e,arguments)}}),t}},function(e,t,i){"use strict";e.exports=function(e){var t;function i(e,t){var i=t,s=0,r=0;if(e.substring(i,i+2).match(/(^\r\n)/))return-2;for(;0===s;){if(-1===(r=e.indexOf("\r\n",i)))return r;!e.substring(r+2,r+4).match(/(^\r\n)/)&&e.charAt(r+2).match(/(^\s+)/)?i=r+2:s=r}return s}function s(t,i,s,r){var n,o,a,c,h=i.indexOf(":",s),u=i.substring(s,h).trim(),l=i.substring(h+1,r).trim();switch(u.toLowerCase()){case"via":case"v":t.addHeader("via",l),1===t.getHeaders("via").length?(c=t.parseHeader("Via"))&&(t.via=c,t.via_branch=c.branch):c=0;break;case"from":case"f":t.setHeader("from",l),(c=t.parseHeader("from"))&&(t.from=c,t.from_tag=c.getParam("tag"));break;case"to":case"t":t.setHeader("to",l),(c=t.parseHeader("to"))&&(t.to=c,t.to_tag=c.getParam("tag"));break;case"record-route":if(-1===(c=e.Grammar.parse(l,"Record_Route"))){c=void 0;break}for(a=c.length,o=0;o<a;o++)n=c[o],t.addHeader("record-route",l.substring(n.position,n.offset)),t.headers["Record-Route"][t.getHeaders("record-route").length-1].parsed=n.parsed;break;case"call-id":case"i":t.setHeader("call-id",l),(c=t.parseHeader("call-id"))&&(t.call_id=l);break;case"contact":case"m":if(-1===(c=e.Grammar.parse(l,"Contact"))){c=void 0;break}for(a=c.length,o=0;o<a;o++)n=c[o],t.addHeader("contact",l.substring(n.position,n.offset)),t.headers.Contact[t.getHeaders("contact").length-1].parsed=n.parsed;break;case"content-length":case"l":t.setHeader("content-length",l),c=t.parseHeader("content-length");break;case"content-type":case"c":t.setHeader("content-type",l),c=t.parseHeader("content-type");break;case"cseq":t.setHeader("cseq",l),(c=t.parseHeader("cseq"))&&(t.cseq=c.value),t instanceof e.IncomingResponse&&(t.method=c.method);break;case"max-forwards":t.setHeader("max-forwards",l),c=t.parseHeader("max-forwards");break;case"www-authenticate":t.setHeader("www-authenticate",l),c=t.parseHeader("www-authenticate");break;case"proxy-authenticate":t.setHeader("proxy-authenticate",l),c=t.parseHeader("proxy-authenticate");break;case"refer-to":case"r":t.setHeader("refer-to",l),(c=t.parseHeader("refer-to"))&&(t.refer_to=c);break;default:t.setHeader(u,l),c=0}return void 0!==c||{error:'error parsing header "'+u+'"'}}(t={}).parseMessage=function(t,r){var n,o,a,c,h,u=0,l=t.indexOf("\r\n"),d=r.getLogger("sip.parser");if(-1!==l){if(o=t.substring(0,l),-1!==(h=e.Grammar.parse(o,"Request_Response"))){for(h.status_code?((n=new e.IncomingResponse(r)).status_code=h.status_code,n.reason_phrase=h.reason_phrase):((n=new e.IncomingRequest(r)).method=h.method,n.ruri=h.uri),n.data=t,u=l+2;;){if(-2===(l=i(t,u))){c=u+2;break}if(-1===l)return void d.error("malformed message");if(!0!==(h=s(n,t,u,l)))return void d.error(h.error);u=l+2}return n.hasHeader("content-length")?(a=n.getHeader("content-length"),n.body=t.substr(c,a)):n.body=t.substring(c),n}d.warn('error parsing first line of SIP message: "'+o+'"')}else d.warn("no CRLF found, not a SIP message, discarded")},e.Parser=t}},function(e,t,i){"use strict";e.exports=function(e){var t,i,s,r;function n(t){var i=t.ua.configuration.hackAllowUnregisteredOptionTags,s=[],r={};return t.method===e.C.REGISTER?s.push("path","gruu"):t.method===e.C.INVITE&&(t.ua.contact.pub_gruu||t.ua.contact.temp_gruu)&&s.push("gruu"),t.ua.configuration.rel100===e.C.supported.SUPPORTED&&s.push("100rel"),t.ua.configuration.replaces===e.C.supported.SUPPORTED&&s.push("replaces"),s.push("outbound"),"Supported: "+(s=(s=s.concat(t.ua.configuration.extraSupported)).filter(function(t){var s=e.C.OPTION_TAGS[t],n=!r[t];return r[t]=!0,(s||i)&&n})).join(", ")+"\r\n"}(t=function(t,i,s,r,n,o){var a,c,h,u,l,d;if(r=r||{},!t||!i||!s)return null;this.logger=s.getLogger("sip.sipmessage"),this.ua=s,this.headers={},this.method=t,this.ruri=i,this.body=o,this.extraHeaders=(n||[]).slice(),this.statusCode=r.status_code,this.reasonPhrase=r.reason_phrase,r.route_set?this.setHeader("route",r.route_set):s.configuration.usePreloadedRoute&&this.setHeader("route",s.transport.server.sip_uri),this.setHeader("via",""),this.setHeader("max-forwards",e.UA.C.MAX_FORWARDS),l=r.to_uri||i,a=r.to_displayName||0===r.to_displayName?'"'+r.to_displayName+'" ':"",a+="<"+(l&&l.toRaw?l.toRaw():l)+">",a+=r.to_tag?";tag="+r.to_tag:"",this.to=new e.NameAddrHeader.parse(a),this.setHeader("to",a),d=r.from_uri||s.configuration.uri,c=r.from_displayName||0===r.from_displayName?'"'+r.from_displayName+'" ':s.configuration.displayName?'"'+s.configuration.displayName+'" ':"",c+="<"+(d&&d.toRaw?d.toRaw():d)+">;tag=",c+=r.from_tag||e.Utils.newTag(),this.from=new e.NameAddrHeader.parse(c),this.setHeader("from",c),h=r.call_id||s.configuration.sipjsId+e.Utils.createRandomToken(15),this.call_id=h,this.setHeader("call-id",h),u=r.cseq||Math.floor(1e4*Math.random()),this.cseq=u,this.setHeader("cseq",u+" "+t)}).prototype={setHeader:function(t,i){this.headers[e.Utils.headerize(t)]=i instanceof Array?i:[i]},getHeader:function(t){var i,s,r=this.extraHeaders.length,n=this.headers[e.Utils.headerize(t)];if(n){if(n[0])return n[0]}else for(i=new RegExp("^\\s*"+t+"\\s*:","i"),s=0;s<r;s++)if(n=this.extraHeaders[s],i.test(n))return n.substring(n.indexOf(":")+1).trim()},getHeaders:function(t){var i,s,r,n=this.headers[e.Utils.headerize(t)],o=[];if(n){for(s=n.length,i=0;i<s;i++)o.push(n[i]);return o}for(s=this.extraHeaders.length,r=new RegExp("^\\s*"+t+"\\s*:","i"),i=0;i<s;i++)n=this.extraHeaders[i],r.test(n)&&o.push(n.substring(n.indexOf(":")+1).trim());return o},hasHeader:function(t){var i,s,r=this.extraHeaders.length;if(this.headers[e.Utils.headerize(t)])return!0;for(i=new RegExp("^\\s*"+t+"\\s*:","i"),s=0;s<r;s++)if(i.test(this.extraHeaders[s]))return!0;return!1},toString:function(){var t,i,s,r="";for(t in r+=this.method+" "+(this.ruri.toRaw?this.ruri.toRaw():this.ruri)+" SIP/2.0\r\n",this.headers)for(i=this.headers[t].length,s=0;s<i;s++)r+=t+": "+this.headers[t][s]+"\r\n";for(i=this.extraHeaders.length,s=0;s<i;s++)r+=this.extraHeaders[s].trim()+"\r\n";return r+=n(this),r+="User-Agent: "+this.ua.configuration.userAgentString+"\r\n",this.body?"string"==typeof this.body?(r+="Content-Length: "+(i=e.Utils.str_utf8_length(this.body))+"\r\n\r\n",r+=this.body):this.body.body&&this.body.contentType?(i=e.Utils.str_utf8_length(this.body.body),r+="Content-Type: "+this.body.contentType+"\r\n",r+="Content-Length: "+i+"\r\n\r\n",r+=this.body.body):r+="Content-Length: 0\r\n\r\n":r+="Content-Length: 0\r\n\r\n",r}},(i=function(){this.data=null,this.headers=null,this.method=null,this.via=null,this.via_branch=null,this.call_id=null,this.cseq=null,this.from=null,this.from_tag=null,this.to=null,this.to_tag=null,this.body=null}).prototype={addHeader:function(t,i){var s={raw:i};t=e.Utils.headerize(t),this.headers[t]?this.headers[t].push(s):this.headers[t]=[s]},getHeader:function(t){var i=this.headers[e.Utils.headerize(t)];if(i)return i[0]?i[0].raw:void 0},getHeaders:function(t){var i,s,r=this.headers[e.Utils.headerize(t)],n=[];if(!r)return[];for(s=r.length,i=0;i<s;i++)n.push(r[i].raw);return n},hasHeader:function(t){return!!this.headers[e.Utils.headerize(t)]},parseHeader:function(t,i){var s,r,n;if(t=e.Utils.headerize(t),i=i||0,this.headers[t]){if(!(i>=this.headers[t].length))return r=(s=this.headers[t][i]).raw,s.parsed?s.parsed:-1===(n=e.Grammar.parse(r,t.replace(/-/g,"_")))?(this.headers[t].splice(i,1),void this.logger.warn('error parsing "'+t+'" header field with value "'+r+'"')):(s.parsed=n,n);this.logger.log('not so many "'+t+'" headers present')}else this.logger.log('header "'+t+'" not present')},s:function(e,t){return this.parseHeader(e,t)},setHeader:function(t,i){var s={raw:i};this.headers[e.Utils.headerize(t)]=[s]},toString:function(){return this.data}},((s=function(e){this.logger=e.getLogger("sip.sipmessage"),this.ua=e,this.headers={},this.ruri=null,this.transport=null,this.server_transaction=null}).prototype=new i).reply=function(t,i,s,r,o,a){var c,h,u,l,d,p=this.getHeader("To"),g=0,f=0;if(d=e.Utils.buildStatusLine(t,i),s=(s||[]).slice(),this.method===e.C.INVITE&&t>100&&t<=200)for(u=(c=this.getHeaders("record-route")).length;g<u;g++)d+="Record-Route: "+c[g]+"\r\n";for(u=(h=this.getHeaders("via")).length;f<u;f++)d+="Via: "+h[f]+"\r\n";for(!this.to_tag&&t>100?p+=";tag="+e.Utils.newTag():this.to_tag&&!this.s("to").hasParam("tag")&&(p+=";tag="+this.to_tag),d+="To: "+p+"\r\n",d+="From: "+this.getHeader("From")+"\r\n",d+="Call-ID: "+this.call_id+"\r\n",d+="CSeq: "+this.cseq+" "+this.method+"\r\n",u=s.length,l=0;l<u;l++)d+=s[l].trim()+"\r\n";return d+=n(this),d+="User-Agent: "+this.ua.configuration.userAgentString+"\r\n",r?"string"==typeof r?(d+="Content-Type: application/sdp\r\n",d+="Content-Length: "+(u=e.Utils.str_utf8_length(r))+"\r\n\r\n",d+=r):r.body&&r.contentType?(u=e.Utils.str_utf8_length(r.body),d+="Content-Type: "+r.contentType+"\r\n",d+="Content-Length: "+u+"\r\n\r\n",d+=r.body):d+="Content-Length: 0\r\n\r\n":d+="Content-Length: 0\r\n\r\n",this.server_transaction.receiveResponse(t,d).then(o,a),d},s.prototype.reply_sl=function(t,i){var s,r,n=0,o=this.getHeaders("via"),a=o.length;for(r=e.Utils.buildStatusLine(t,i);n<a;n++)r+="Via: "+o[n]+"\r\n";s=this.getHeader("To"),!this.to_tag&&t>100?s+=";tag="+e.Utils.newTag():this.to_tag&&!this.s("to").hasParam("tag")&&(s+=";tag="+this.to_tag),r+="To: "+s+"\r\n",r+="From: "+this.getHeader("From")+"\r\n",r+="Call-ID: "+this.call_id+"\r\n",r+="CSeq: "+this.cseq+" "+this.method+"\r\n",r+="User-Agent: "+this.ua.configuration.userAgentString+"\r\n",r+="Content-Length: 0\r\n\r\n",this.transport.send(r)},(r=function(e){this.logger=e.getLogger("sip.sipmessage"),this.headers={},this.status_code=null,this.reason_phrase=null}).prototype=new i,e.OutgoingRequest=t,e.IncomingRequest=s,e.IncomingResponse=r}},function(e,t,i){"use strict";e.exports=function(e){var t;(t=function(t,i,s,r,n,o){var a,c,h,u;if(!s)throw new TypeError('missing or invalid "host" parameter');for(a in t=t||e.C.SIP,this.parameters={},this.headers={},n)this.setParam(a,n[a]);for(c in o)this.setHeader(c,o[c]);h={scheme:t,user:i,host:s,port:r},u={scheme:t.toLowerCase(),user:i,host:s.toLowerCase(),port:r},Object.defineProperties(this,{_normal:{get:function(){return u}},_raw:{get:function(){return h}},scheme:{get:function(){return u.scheme},set:function(e){h.scheme=e,u.scheme=e.toLowerCase()}},user:{get:function(){return u.user},set:function(e){u.user=h.user=e}},host:{get:function(){return u.host},set:function(e){h.host=e,u.host=e.toLowerCase()}},aor:{get:function(){return u.user+"@"+u.host}},port:{get:function(){return u.port},set:function(e){u.port=h.port=0===e?e:parseInt(e,10)||null}}})}).prototype={setParam:function(e,t){e&&(this.parameters[e.toLowerCase()]=void 0===t||null===t?null:t.toString().toLowerCase())},getParam:function(e){if(e)return this.parameters[e.toLowerCase()]},hasParam:function(e){if(e)return!!this.parameters.hasOwnProperty(e.toLowerCase())},deleteParam:function(e){var t;if(e=e.toLowerCase(),this.parameters.hasOwnProperty(e))return t=this.parameters[e],delete this.parameters[e],t},clearParams:function(){this.parameters={}},setHeader:function(t,i){this.headers[e.Utils.headerize(t)]=i instanceof Array?i:[i]},getHeader:function(t){if(t)return this.headers[e.Utils.headerize(t)]},hasHeader:function(t){if(t)return!!this.headers.hasOwnProperty(e.Utils.headerize(t))},deleteHeader:function(t){var i;if(t=e.Utils.headerize(t),this.headers.hasOwnProperty(t))return i=this.headers[t],delete this.headers[t],i},clearHeaders:function(){this.headers={}},clone:function(){return new t(this._raw.scheme,this._raw.user,this._raw.host,this._raw.port,JSON.parse(JSON.stringify(this.parameters)),JSON.parse(JSON.stringify(this.headers)))},toRaw:function(){return this._toString(this._raw)},toString:function(){return this._toString(this._normal)},_toString:function(t){var i,s,r,n,o=[];for(s in n=t.scheme+":",t.scheme.toLowerCase().match("^sips?$")||(n+="//"),t.user&&(n+=e.Utils.escapeUser(t.user)+"@"),n+=t.host,(t.port||0===t.port)&&(n+=":"+t.port),this.parameters)n+=";"+s,null!==this.parameters[s]&&(n+="="+this.parameters[s]);for(i in this.headers)for(r in this.headers[i])o.push(i+"="+this.headers[i][r]);return o.length>0&&(n+="?"+o.join("&")),n}},t.parse=function(t){return-1!==(t=e.Grammar.parse(t,"SIP_URI"))?t:void 0},e.URI=t}},function(e,t,i){"use strict";e.exports=function(e){var t;(t=function(t,i,s){var r;if(!(t&&t instanceof e.URI))throw new TypeError('missing or invalid "uri" parameter');for(r in this.uri=t,this.parameters={},s)this.setParam(r,s[r]);Object.defineProperties(this,{friendlyName:{get:function(){return this.displayName||t.aor}},displayName:{get:function(){return i},set:function(e){i=0===e?"0":e}}})}).prototype={setParam:function(e,t){e&&(this.parameters[e.toLowerCase()]=void 0===t||null===t?null:t.toString())},getParam:e.URI.prototype.getParam,hasParam:e.URI.prototype.hasParam,deleteParam:e.URI.prototype.deleteParam,clearParams:e.URI.prototype.clearParams,clone:function(){return new t(this.uri.clone(),this.displayName,JSON.parse(JSON.stringify(this.parameters)))},toString:function(){var e,t;for(t in e=this.displayName||0===this.displayName?'"'+this.displayName+'" ':"",e+="<"+this.uri.toString()+">",this.parameters)e+=";"+t,null!==this.parameters[t]&&(e+="="+this.parameters[t]);return e}},t.parse=function(t){return-1!==(t=e.Grammar.parse(t,"Name_Addr_Header"))?t:void 0},e.NameAddrHeader=t}},function(e,t,i){"use strict";e.exports=function(e){var t={STATUS_TRYING:1,STATUS_PROCEEDING:2,STATUS_CALLING:3,STATUS_ACCEPTED:4,STATUS_COMPLETED:5,STATUS_TERMINATED:6,STATUS_CONFIRMED:7,NON_INVITE_CLIENT:"nict",NON_INVITE_SERVER:"nist",INVITE_CLIENT:"ict",INVITE_SERVER:"ist"};function i(e,t,i){var s;return s="SIP/2.0/"+(e.ua.configuration.hackViaTcp?"TCP":t.server.scheme),s+=" "+e.ua.configuration.viaHost+";branch="+i,e.ua.configuration.forceRport&&(s+=";rport"),s}var s=function(e,s,r){var n;this.type=t.NON_INVITE_CLIENT,this.transport=r,this.id="z9hG4bK"+Math.floor(1e7*Math.random()),this.request_sender=e,this.request=s,this.logger=e.ua.getLogger("sip.transaction.nict",this.id),n=i(e,r,this.id),this.request.setHeader("via",n),this.request_sender.ua.newTransaction(this)};(s.prototype=Object.create(e.EventEmitter.prototype)).stateChanged=function(e){this.state=e,this.emit("stateChanged")},s.prototype.send=function(){this.stateChanged(t.STATUS_TRYING),this.F=e.Timers.setTimeout(this.timer_F.bind(this),e.Timers.TIMER_F),this.transport.send(this.request).catch(function(){this.onTransportError()}.bind(this))},s.prototype.onTransportError=function(){this.logger.log("transport error occurred, deleting non-INVITE client transaction "+this.id),e.Timers.clearTimeout(this.F),e.Timers.clearTimeout(this.K),this.stateChanged(t.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this),this.request_sender.onTransportError()},s.prototype.timer_F=function(){this.logger.debug("Timer F expired for non-INVITE client transaction "+this.id),this.stateChanged(t.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this),this.request_sender.onRequestTimeout()},s.prototype.timer_K=function(){this.stateChanged(t.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this)},s.prototype.receiveResponse=function(i){var s=i.status_code;if(s<200)switch(this.state){case t.STATUS_TRYING:case t.STATUS_PROCEEDING:this.stateChanged(t.STATUS_PROCEEDING),this.request_sender.receiveResponse(i)}else switch(this.state){case t.STATUS_TRYING:case t.STATUS_PROCEEDING:this.stateChanged(t.STATUS_COMPLETED),e.Timers.clearTimeout(this.F),408===s?this.request_sender.onRequestTimeout():this.request_sender.receiveResponse(i),this.K=e.Timers.setTimeout(this.timer_K.bind(this),e.Timers.TIMER_K)}};var r=function(e,s,r){var n,o=this;this.type=t.INVITE_CLIENT,this.transport=r,this.id="z9hG4bK"+Math.floor(1e7*Math.random()),this.request_sender=e,this.request=s,this.logger=e.ua.getLogger("sip.transaction.ict",this.id),n=i(e,r,this.id),this.request.setHeader("via",n),this.request_sender.ua.newTransaction(this),this.request.cancel=function(e,t){for(var i=(t=(t||[]).slice()).length,s=null,r=0;r<i;r++)s=(s||"")+t[r].trim()+"\r\n";o.cancel_request(o,e,s)}};(r.prototype=Object.create(e.EventEmitter.prototype)).stateChanged=function(e){this.state=e,this.emit("stateChanged")},r.prototype.send=function(){this.stateChanged(t.STATUS_CALLING),this.B=e.Timers.setTimeout(this.timer_B.bind(this),e.Timers.TIMER_B),this.transport.send(this.request).catch(function(){this.onTransportError()}.bind(this))},r.prototype.onTransportError=function(){this.logger.log("transport error occurred, deleting INVITE client transaction "+this.id),e.Timers.clearTimeout(this.B),e.Timers.clearTimeout(this.D),e.Timers.clearTimeout(this.M),this.stateChanged(t.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this),this.state!==t.STATUS_ACCEPTED&&this.request_sender.onTransportError()},r.prototype.timer_M=function(){this.logger.debug("Timer M expired for INVITE client transaction "+this.id),this.state===t.STATUS_ACCEPTED&&(e.Timers.clearTimeout(this.B),this.stateChanged(t.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this))},r.prototype.timer_B=function(){this.logger.debug("Timer B expired for INVITE client transaction "+this.id),this.state===t.STATUS_CALLING&&(this.stateChanged(t.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this),this.request_sender.onRequestTimeout())},r.prototype.timer_D=function(){this.logger.debug("Timer D expired for INVITE client transaction "+this.id),e.Timers.clearTimeout(this.B),this.stateChanged(t.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this)},r.prototype.sendACK=function(t){var i,s=this;t=t||{},i=this.response.getHeader("contact")?this.response.parseHeader("contact").uri:this.request.ruri;var r=new e.OutgoingRequest("ACK",i,this.request.ua,{cseq:this.response.cseq,call_id:this.response.call_id,from_uri:this.response.from.uri,from_tag:this.response.from_tag,to_uri:this.response.to.uri,to_tag:this.response.to_tag,route_set:this.response.getHeaders("record-route").reverse()},t.extraHeaders||[],t.body);return this.ackSender=new e.RequestSender({request:r,onRequestTimeout:this.request_sender.applicant.applicant?this.request_sender.applicant.applicant.onRequestTimeout:function(){s.logger.warn("ACK Request timed out")},onTransportError:this.request_sender.applicant.applicant?this.request_sender.applicant.applicant.onRequestTransportError:function(){s.logger.warn("ACK Request had a transport error")},receiveResponse:t.receiveResponse||function(){s.logger.warn("Received a response to an ACK which was unexpected. Dropping Response.")}},this.request.ua).send(),r},r.prototype.cancel_request=function(i,s,r){var n=i.request;this.cancel=e.C.CANCEL+" "+n.ruri+" SIP/2.0\r\n",this.cancel+="Via: "+n.headers.Via.toString()+"\r\n",this.request.headers.Route&&(this.cancel+="Route: "+n.headers.Route.toString()+"\r\n"),this.cancel+="To: "+n.headers.To.toString()+"\r\n",this.cancel+="From: "+n.headers.From.toString()+"\r\n",this.cancel+="Call-ID: "+n.headers["Call-ID"].toString()+"\r\n",this.cancel+="Max-Forwards: "+e.UA.C.MAX_FORWARDS+"\r\n",this.cancel+="CSeq: "+n.headers.CSeq.toString().split(" ")[0]+" CANCEL\r\n",s&&(this.cancel+="Reason: "+s+"\r\n"),r&&(this.cancel+=r),this.cancel+="Content-Length: 0\r\n\r\n",this.state===t.STATUS_PROCEEDING&&this.transport.send(this.cancel)},r.prototype.receiveResponse=function(i){var s=i.status_code;if(i.transaction=this,this.response&&this.response.status_code===i.status_code&&this.response.cseq===i.cseq)return this.logger.debug("ICT Received a retransmission for cseq: "+i.cseq),void(this.ackSender&&this.ackSender.send());if(this.response=i,s>=100&&s<=199)switch(this.state){case t.STATUS_CALLING:this.stateChanged(t.STATUS_PROCEEDING),this.request_sender.receiveResponse(i),this.cancel&&this.transport.send(this.cancel);break;case t.STATUS_PROCEEDING:this.request_sender.receiveResponse(i)}else if(s>=200&&s<=299)switch(this.state){case t.STATUS_CALLING:case t.STATUS_PROCEEDING:this.stateChanged(t.STATUS_ACCEPTED),this.M=e.Timers.setTimeout(this.timer_M.bind(this),e.Timers.TIMER_M),this.request_sender.receiveResponse(i);break;case t.STATUS_ACCEPTED:this.request_sender.receiveResponse(i)}else if(s>=300&&s<=699)switch(this.state){case t.STATUS_CALLING:case t.STATUS_PROCEEDING:this.stateChanged(t.STATUS_COMPLETED),this.sendACK(),this.request_sender.receiveResponse(i);break;case t.STATUS_COMPLETED:this.sendACK()}};var n=function(e,t,s){var r;this.transport=s,this.id="z9hG4bK"+Math.floor(1e7*Math.random()),this.request_sender=e,this.request=t,this.logger=e.ua.getLogger("sip.transaction.nict",this.id),r=i(e,s,this.id),this.request.setHeader("via",r)};(n.prototype=Object.create(e.EventEmitter.prototype)).send=function(){this.transport.send(this.request).catch(function(){this.onTransportError()}.bind(this))},n.prototype.onTransportError=function(){this.logger.log("transport error occurred, for an ACK client transaction "+this.id),this.request_sender.onTransportError()};var o=function(e,i){this.type=t.NON_INVITE_SERVER,this.id=e.via_branch,this.request=e,this.transport=i.transport,this.ua=i,this.last_response="",e.server_transaction=this,this.logger=i.getLogger("sip.transaction.nist",this.id),this.state=t.STATUS_TRYING,i.newTransaction(this)};(o.prototype=Object.create(e.EventEmitter.prototype)).stateChanged=function(e){this.state=e,this.emit("stateChanged")},o.prototype.timer_J=function(){this.logger.debug("Timer J expired for non-INVITE server transaction "+this.id),this.stateChanged(t.STATUS_TERMINATED),this.ua.destroyTransaction(this)},o.prototype.onTransportError=function(){this.transportError||(this.transportError=!0,this.logger.log("transport error occurred, deleting non-INVITE server transaction "+this.id),e.Timers.clearTimeout(this.J),this.stateChanged(t.STATUS_TERMINATED),this.ua.destroyTransaction(this))},o.prototype.receiveResponse=function(i,s){var r=e.Utils.defer();if(100===i)switch(this.state){case t.STATUS_TRYING:this.stateChanged(t.STATUS_PROCEEDING),this.transport.send(s).catch(function(){this.onTransportError()}.bind(this));break;case t.STATUS_PROCEEDING:this.last_response=s,this.transport.send(s).then(function(){r.resolve()}).catch(function(){this.onTransportError(),r.reject()}.bind(this))}else if(i>=200&&i<=699)switch(this.state){case t.STATUS_TRYING:case t.STATUS_PROCEEDING:this.stateChanged(t.STATUS_COMPLETED),this.last_response=s,this.J=e.Timers.setTimeout(this.timer_J.bind(this),e.Timers.TIMER_J),this.transport.send(s).then(function(){r.resolve()}).catch(function(){this.onTransportError(),r.reject()}.bind(this))}return r.promise};var a=function(e,i){this.type=t.INVITE_SERVER,this.id=e.via_branch,this.request=e,this.transport=i.transport,this.ua=i,this.last_response="",e.server_transaction=this,this.logger=i.getLogger("sip.transaction.ist",this.id),this.state=t.STATUS_PROCEEDING,i.newTransaction(this),this.resendProvisionalTimer=null,e.reply(100)};(a.prototype=Object.create(e.EventEmitter.prototype)).stateChanged=function(e){this.state=e,this.emit("stateChanged")},a.prototype.timer_H=function(){this.logger.debug("Timer H expired for INVITE server transaction "+this.id),this.state===t.STATUS_COMPLETED&&this.logger.warn("transactions","ACK for INVITE server transaction was never received, call will be terminated"),this.stateChanged(t.STATUS_TERMINATED),this.ua.destroyTransaction(this)},a.prototype.timer_I=function(){this.stateChanged(t.STATUS_TERMINATED),this.ua.destroyTransaction(this)},a.prototype.timer_L=function(){this.logger.debug("Timer L expired for INVITE server transaction "+this.id),this.state===t.STATUS_ACCEPTED&&(this.stateChanged(t.STATUS_TERMINATED),this.ua.destroyTransaction(this))},a.prototype.onTransportError=function(){this.transportError||(this.transportError=!0,this.logger.log("transport error occurred, deleting INVITE server transaction "+this.id),null!==this.resendProvisionalTimer&&(e.Timers.clearInterval(this.resendProvisionalTimer),this.resendProvisionalTimer=null),e.Timers.clearTimeout(this.L),e.Timers.clearTimeout(this.H),e.Timers.clearTimeout(this.I),this.stateChanged(t.STATUS_TERMINATED),this.ua.destroyTransaction(this))},a.prototype.resend_provisional=function(){this.transport.send(this.request).catch(function(){this.onTransportError()}.bind(this))},a.prototype.receiveResponse=function(i,s){var r=this,n=e.Utils.defer();if(i>=100&&i<=199)switch(this.state){case t.STATUS_PROCEEDING:this.transport.send(s).catch(function(){this.onTransportError()}.bind(this)),this.last_response=s}if(i>100&&i<=199&&this.state===t.STATUS_PROCEEDING)null===this.resendProvisionalTimer&&(this.resendProvisionalTimer=e.Timers.setInterval(r.resend_provisional.bind(r),e.Timers.PROVISIONAL_RESPONSE_INTERVAL));else if(i>=200&&i<=299)switch(this.state){case t.STATUS_PROCEEDING:this.stateChanged(t.STATUS_ACCEPTED),this.last_response=s,this.L=e.Timers.setTimeout(r.timer_L.bind(r),e.Timers.TIMER_L),null!==this.resendProvisionalTimer&&(e.Timers.clearInterval(this.resendProvisionalTimer),this.resendProvisionalTimer=null);case t.STATUS_ACCEPTED:this.transport.send(s).then(function(){n.resolve()}).catch(function(e){this.logger.error(e),this.onTransportError(),n.reject()}.bind(this))}else if(i>=300&&i<=699)switch(this.state){case t.STATUS_PROCEEDING:null!==this.resendProvisionalTimer&&(e.Timers.clearInterval(this.resendProvisionalTimer),this.resendProvisionalTimer=null),this.transport.send(s).then(function(){this.stateChanged(t.STATUS_COMPLETED),this.H=e.Timers.setTimeout(r.timer_H.bind(r),e.Timers.TIMER_H),n.resolve()}.bind(this)).catch(function(e){this.logger.error(e),this.onTransportError(),n.reject()}.bind(this))}return n.promise};e.Transactions={C:t,checkTransaction:function(i,s){var r;switch(s.method){case e.C.INVITE:if(r=i.transactions.ist[s.via_branch]){switch(r.state){case t.STATUS_PROCEEDING:r.transport.send(r.last_response)}return!0}break;case e.C.ACK:if(!(r=i.transactions.ist[s.via_branch]))return!1;if(r.state===t.STATUS_ACCEPTED)return!1;if(r.state===t.STATUS_COMPLETED)return r.stateChanged(t.STATUS_CONFIRMED),r.I=e.Timers.setTimeout(r.timer_I.bind(r),e.Timers.TIMER_I),!0;break;case e.C.CANCEL:return(r=i.transactions.ist[s.via_branch])?(s.reply_sl(200),r.state!==t.STATUS_PROCEEDING):(s.reply_sl(481),!0);default:if(r=i.transactions.nist[s.via_branch]){switch(r.state){case t.STATUS_TRYING:break;case t.STATUS_PROCEEDING:case t.STATUS_COMPLETED:r.transport.send(r.last_response)}return!0}}},NonInviteClientTransaction:s,InviteClientTransaction:r,AckClientTransaction:n,NonInviteServerTransaction:o,InviteServerTransaction:a}}},function(e,t,i){"use strict";e.exports=function(e){var t,s=i(18)(e),r={STATUS_EARLY:1,STATUS_CONFIRMED:2};(t=function(t,i,s,n){var o;if(this.uac_pending_reply=!1,this.uas_pending_reply=!1,!i.hasHeader("contact"))return{error:"unable to create a Dialog without Contact header field"};n=i instanceof e.IncomingResponse?i.status_code<200?r.STATUS_EARLY:r.STATUS_CONFIRMED:n||r.STATUS_CONFIRMED,o=i.parseHeader("contact"),"UAS"===s?(this.id={call_id:i.call_id,local_tag:i.to_tag,remote_tag:i.from_tag,toString:function(){return this.call_id+this.local_tag+this.remote_tag}},this.state=n,this.remote_seqnum=i.cseq,this.local_uri=i.parseHeader("to").uri,this.remote_uri=i.parseHeader("from").uri,this.remote_target=o.uri,this.route_set=i.getHeaders("record-route"),this.invite_seqnum=i.cseq,this.local_seqnum=i.cseq):"UAC"===s&&(this.id={call_id:i.call_id,local_tag:i.from_tag,remote_tag:i.to_tag,toString:function(){return this.call_id+this.local_tag+this.remote_tag}},this.state=n,this.invite_seqnum=i.cseq,this.local_seqnum=i.cseq,this.local_uri=i.parseHeader("from").uri,this.pracked=[],this.remote_uri=i.parseHeader("to").uri,this.remote_target=o.uri,this.route_set=i.getHeaders("record-route").reverse()),this.logger=t.ua.getLogger("sip.dialog",this.id.toString()),this.owner=t,t.ua.dialogs[this.id.toString()]=this,this.logger.log("new "+s+" dialog created with status "+(this.state===r.STATUS_EARLY?"EARLY":"CONFIRMED")),t.emit("dialog",this)}).prototype={update:function(e,t){this.state=r.STATUS_CONFIRMED,this.logger.log("dialog "+this.id.toString()+"  changed to CONFIRMED state"),"UAC"===t&&(this.route_set=e.getHeaders("record-route").reverse())},terminate:function(){this.logger.log("dialog "+this.id.toString()+" deleted"),this.sessionDescriptionHandler&&this.state!==r.STATUS_CONFIRMED&&this.sessionDescriptionHandler.close(),delete this.owner.ua.dialogs[this.id.toString()]},createRequest:function(t,i,s){var r,n;return i=(i||[]).slice(),this.local_seqnum||(this.local_seqnum=Math.floor(1e4*Math.random())),r=t===e.C.CANCEL||t===e.C.ACK?this.invite_seqnum:this.local_seqnum+=1,(n=new e.OutgoingRequest(t,this.remote_target,this.owner.ua,{cseq:r,call_id:this.id.call_id,from_uri:this.local_uri,from_tag:this.id.local_tag,to_uri:this.remote_uri,to_tag:this.id.remote_tag,route_set:this.route_set},i,s)).dialog=this,n},checkInDialogRequest:function(t){var i=this;if(this.remote_seqnum){if(t.cseq<this.remote_seqnum)return t.method!==e.C.ACK&&t.reply(500),t.cseq===this.invite_seqnum}else this.remote_seqnum=t.cseq;switch(t.method){case e.C.INVITE:if(!0===this.uac_pending_reply)t.reply(491);else{if(!0===this.uas_pending_reply&&t.cseq>this.remote_seqnum){var s=1+(10*Math.random()|0);return t.reply(500,null,["Retry-After:"+s]),this.remote_seqnum=t.cseq,!1}this.uas_pending_reply=!0,t.server_transaction.on("stateChanged",function t(){this.state!==e.Transactions.C.STATUS_ACCEPTED&&this.state!==e.Transactions.C.STATUS_COMPLETED&&this.state!==e.Transactions.C.STATUS_TERMINATED||(this.removeListener("stateChanged",t),i.uas_pending_reply=!1)})}t.hasHeader("contact")&&t.server_transaction.on("stateChanged",function(){this.state===e.Transactions.C.STATUS_ACCEPTED&&(i.remote_target=t.parseHeader("contact").uri)});break;case e.C.NOTIFY:t.hasHeader("contact")&&t.server_transaction.on("stateChanged",function(){this.state===e.Transactions.C.STATUS_COMPLETED&&(i.remote_target=t.parseHeader("contact").uri)})}return t.cseq>this.remote_seqnum&&(this.remote_seqnum=t.cseq),!0},sendRequest:function(e,t,i){var r=((i=i||{}).extraHeaders||[]).slice(),n=null;i.body&&(i.body.body?n=i.body:((n={}).body=i.body,i.contentType&&(n.contentType=i.contentType)));var o=this.createRequest(t,r,n);return new s(this,e,o).send(),o},receiveRequest:function(e){this.checkInDialogRequest(e)&&this.owner.receiveRequest(e)}},t.C=r,e.Dialog=t}},function(e,t,i){"use strict";e.exports=function(e){var t;return(t=function(e,t,i){this.dialog=e,this.applicant=t,this.request=i,this.reattempt=!1,this.reattemptTimer=null}).prototype={send:function(){var t=this,i=new e.RequestSender(this,this.dialog.owner.ua);i.send(),this.request.method===e.C.INVITE&&i.clientTransaction.state!==e.Transactions.C.STATUS_TERMINATED&&(this.dialog.uac_pending_reply=!0,i.clientTransaction.on("stateChanged",function i(){this.state!==e.Transactions.C.STATUS_ACCEPTED&&this.state!==e.Transactions.C.STATUS_COMPLETED&&this.state!==e.Transactions.C.STATUS_TERMINATED||(this.removeListener("stateChanged",i),t.dialog.uac_pending_reply=!1)}))},onRequestTimeout:function(){this.applicant.onRequestTimeout()},onTransportError:function(){this.applicant.onTransportError()},receiveResponse:function(t){var i=this;408===t.status_code||481===t.status_code?this.applicant.onDialogError(t):t.method===e.C.INVITE&&491===t.status_code?this.reattempt?this.applicant.receiveResponse(t):(this.request.cseq.value=this.dialog.local_seqnum+=1,this.reattemptTimer=e.Timers.setTimeout(function(){i.applicant.owner.status!==e.Session.C.STATUS_TERMINATED&&(i.reattempt=!0,i.request_sender.send())},this.getReattemptTimeout())):this.applicant.receiveResponse(t)}},t}},function(e,t,i){"use strict";e.exports=function(e){var t;(t=function(t,i){this.logger=i.getLogger("sip.requestsender"),this.ua=i,this.applicant=t,this.method=t.request.method,this.request=t.request,this.credentials=null,this.challenged=!1,this.staled=!1,i.status!==e.UA.C.STATUS_USER_CLOSED||this.method===e.C.BYE&&this.method===e.C.ACK||this.onTransportError()}).prototype={send:function(){switch(this.method){case"INVITE":this.clientTransaction=new e.Transactions.InviteClientTransaction(this,this.request,this.ua.transport);break;case"ACK":this.clientTransaction=new e.Transactions.AckClientTransaction(this,this.request,this.ua.transport);break;default:this.clientTransaction=new e.Transactions.NonInviteClientTransaction(this,this.request,this.ua.transport)}return this.clientTransaction.send(),this.clientTransaction},onRequestTimeout:function(){this.applicant.onRequestTimeout()},onTransportError:function(){this.applicant.onTransportError()},receiveResponse:function(t){var i,s,r,n=t.status_code;if(401===n||407===n){if(401===t.status_code?(s=t.parseHeader("www-authenticate"),r="authorization"):(s=t.parseHeader("proxy-authenticate"),r="proxy-authorization"),!s)return this.logger.warn(t.status_code+" with wrong or missing challenge, cannot authenticate"),void this.applicant.receiveResponse(t);if(!this.challenged||!this.staled&&!0===s.stale){if(this.credentials||(this.credentials=this.ua.configuration.authenticationFactory(this.ua)),!this.credentials.authenticate(this.request,s))return void this.applicant.receiveResponse(t);this.challenged=!0,s.stale&&(this.staled=!0),t.method===e.C.REGISTER?i=this.applicant.cseq+=1:this.request.dialog?i=this.request.dialog.local_seqnum+=1:(i=this.request.cseq+1,this.request.cseq=i),this.request.setHeader("cseq",i+" "+this.method),this.request.setHeader(r,this.credentials.toString()),this.send()}else this.applicant.receiveResponse(t)}else this.applicant.receiveResponse(t)}},e.RequestSender=t}},function(e,t,i){"use strict";e.exports=function(e){var t;(t=function(t){var i={};this.registrar=t.configuration.registrarServer,this.expires=t.configuration.registerExpires,this.contact=t.contact.toString(),this.contact+=";reg-id=1",this.contact+=';+sip.instance="<urn:uuid:'+t.configuration.instanceId+'>"',this.call_id=e.Utils.createRandomToken(22),this.cseq=Math.floor(1e4*Math.random()),this.to_uri=t.configuration.uri,i.to_uri=this.to_uri,i.to_displayName=t.configuration.displayName,i.call_id=this.call_id,i.cseq=this.cseq,e.Utils.augment(this,e.ClientContext,[t,"REGISTER",this.registrar,{params:i}]),this.registrationTimer=null,this.registrationExpiredTimer=null,this.registered=!1,this.logger=t.getLogger("sip.registercontext"),t.on("transportCreated",function(e){e.on("disconnected",this.onTransportDisconnected.bind(this))}.bind(this))}).prototype=Object.create({},{register:{writable:!0,value:function(t){var i,s=this;this.options=t||{},(i=(this.options.extraHeaders||[]).slice()).push("Contact: "+this.contact+";expires="+this.expires),i.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),this.closeHeaders=this.options.closeWithHeaders?(this.options.extraHeaders||[]).slice():[],this.receiveResponse=function(t){var i,r,n,o=t.getHeaders("contact").length;if(t.cseq===this.cseq)switch(null!==this.registrationTimer&&(e.Timers.clearTimeout(this.registrationTimer),this.registrationTimer=null),!0){case/^1[0-9]{2}$/.test(t.status_code):this.emit("progress",t);break;case/^2[0-9]{2}$/.test(t.status_code):if(this.emit("accepted",t),t.hasHeader("expires")&&(r=t.getHeader("expires")),null!==this.registrationExpiredTimer&&(e.Timers.clearTimeout(this.registrationExpiredTimer),this.registrationExpiredTimer=null),!o){this.logger.warn("no Contact header in response to REGISTER, response ignored");break}for(;o--;){if((i=t.parseHeader("contact",o)).uri.user===this.ua.contact.uri.user){r=i.getParam("expires");break}i=null}if(!i){this.logger.warn("no Contact header pointing to us, response ignored");break}r||(r=this.expires),this.registrationTimer=e.Timers.setTimeout(function(){s.registrationTimer=null,s.register(s.options)},1e3*r-3e3),this.registrationExpiredTimer=e.Timers.setTimeout(function(){s.logger.warn("registration expired"),s.registered&&s.unregistered(null,e.C.causes.EXPIRES)},1e3*r),i.hasParam("temp-gruu")&&(this.ua.contact.temp_gruu=e.URI.parse(i.getParam("temp-gruu").replace(/"/g,""))),i.hasParam("pub-gruu")&&(this.ua.contact.pub_gruu=e.URI.parse(i.getParam("pub-gruu").replace(/"/g,""))),this.registered=!0,this.emit("registered",t||null);break;case/^423$/.test(t.status_code):t.hasHeader("min-expires")?(this.expires=t.getHeader("min-expires"),this.register(this.options)):(this.logger.warn("423 response received for REGISTER without Min-Expires"),this.registrationFailure(t,e.C.causes.SIP_FAILURE_CODE));break;default:n=e.Utils.sipErrorCause(t.status_code),this.registrationFailure(t,n)}},this.onRequestTimeout=function(){this.registrationFailure(null,e.C.causes.REQUEST_TIMEOUT)},this.onTransportError=function(){this.registrationFailure(null,e.C.causes.CONNECTION_ERROR)},this.cseq++,this.request.cseq=this.cseq,this.request.setHeader("cseq",this.cseq+" REGISTER"),this.request.extraHeaders=i,this.send()}},registrationFailure:{writable:!0,value:function(e,t){this.emit("failed",e||null,t||null)}},onTransportDisconnected:{writable:!0,value:function(){this.registered_before=this.registered,null!==this.registrationTimer&&(e.Timers.clearTimeout(this.registrationTimer),this.registrationTimer=null),null!==this.registrationExpiredTimer&&(e.Timers.clearTimeout(this.registrationExpiredTimer),this.registrationExpiredTimer=null),this.registered&&this.unregistered(null,e.C.causes.CONNECTION_ERROR)}},onTransportConnected:{writable:!0,value:function(){this.register(this.options)}},close:{writable:!0,value:function(){var e={all:!1,extraHeaders:this.closeHeaders};this.registered_before=this.registered,this.registered&&this.unregister(e)}},unregister:{writable:!0,value:function(t){var i;t=t||{},this.registered||t.all||this.logger.warn("Already unregistered, but sending an unregister anyways."),i=(t.extraHeaders||[]).slice(),this.registered=!1,null!==this.registrationTimer&&(e.Timers.clearTimeout(this.registrationTimer),this.registrationTimer=null),t.all?(i.push("Contact: *"),i.push("Expires: 0")):i.push("Contact: "+this.contact+";expires=0"),this.receiveResponse=function(t){var i;switch(!0){case/^1[0-9]{2}$/.test(t.status_code):this.emit("progress",t);break;case/^2[0-9]{2}$/.test(t.status_code):this.emit("accepted",t),null!==this.registrationExpiredTimer&&(e.Timers.clearTimeout(this.registrationExpiredTimer),this.registrationExpiredTimer=null),this.unregistered(t);break;default:i=e.Utils.sipErrorCause(t.status_code),this.unregistered(t,i)}},this.onRequestTimeout=function(){},this.cseq++,this.request.cseq=this.cseq,this.request.setHeader("cseq",this.cseq+" REGISTER"),this.request.extraHeaders=i,this.send()}},unregistered:{writable:!0,value:function(e,t){this.registered=!1,this.emit("unregistered",e||null,t||null)}}}),e.RegisterContext=t}},function(e,t,i){"use strict";e.exports=function(e){var t=function(){};return t.prototype=Object.create(e.prototype,{close:{value:function(){}},getDescription:{value:function(e,t){}},hasDescription:{value:function(e){}},holdModifier:{value:function(e){}},setDescription:{value:function(e,t,i){}},sendDtmf:{value:function(e,t){}},getDirection:{value:function(){}}}),t}},function(e,t,i){"use strict";e.exports=function(e){var t;((t=function(t,i,s,r){var n=s;if(void 0===s)throw new TypeError("Not enough arguments");if(this.ua=t,this.logger=t.getLogger("sip.clientcontext"),this.method=i,!(s=t.normalizeTarget(s)))throw new TypeError("Invalid target: "+n);(r=Object.create(r||Object.prototype)).extraHeaders=(r.extraHeaders||[]).slice(),this.request=new e.OutgoingRequest(this.method,s,this.ua,r.params,r.extraHeaders),r.body&&(this.body={},this.body.body=r.body,r.contentType&&(this.body.contentType=r.contentType),this.request.body=this.body),this.localIdentity=this.request.from,this.remoteIdentity=this.request.to,this.data={}}).prototype=Object.create(e.EventEmitter.prototype)).send=function(){return new e.RequestSender(this,this.ua).send(),this},t.prototype.cancel=function(t){(t=t||{}).extraHeaders=(t.extraHeaders||[]).slice();var i=e.Utils.getCancelReason(t.status_code,t.reason_phrase);this.request.cancel(i,t.extraHeaders),this.emit("cancel")},t.prototype.receiveResponse=function(t){var i=e.Utils.getReasonPhrase(t.status_code);switch(!0){case/^1[0-9]{2}$/.test(t.status_code):this.emit("progress",t,i);break;case/^2[0-9]{2}$/.test(t.status_code):this.ua.applicants[this]&&delete this.ua.applicants[this],this.emit("accepted",t,i);break;default:this.ua.applicants[this]&&delete this.ua.applicants[this],this.emit("rejected",t,i),this.emit("failed",t,i)}},t.prototype.onRequestTimeout=function(){this.emit("failed",null,e.C.causes.REQUEST_TIMEOUT)},t.prototype.onTransportError=function(){this.emit("failed",null,e.C.causes.CONNECTION_ERROR)},e.ClientContext=t}},function(e,t,i){"use strict";e.exports=function(e){var t;((t=function(t,i){this.ua=t,this.logger=t.getLogger("sip.servercontext"),this.request=i,i.method===e.C.INVITE?this.transaction=new e.Transactions.InviteServerTransaction(i,t):this.transaction=new e.Transactions.NonInviteServerTransaction(i,t),i.body&&(this.body=i.body),i.hasHeader("Content-Type")&&(this.contentType=i.getHeader("Content-Type")),this.method=i.method,this.data={},this.localIdentity=i.to,this.remoteIdentity=i.from,i.hasHeader("P-Asserted-Identity")&&(this.assertedIdentity=new e.NameAddrHeader.parse(i.getHeader("P-Asserted-Identity")))}).prototype=Object.create(e.EventEmitter.prototype)).progress=function(e){return(e=Object.create(e||Object.prototype)).statusCode||(e.statusCode=180),e.minCode=100,e.maxCode=199,e.events=["progress"],this.reply(e)},t.prototype.accept=function(e){return(e=Object.create(e||Object.prototype)).statusCode||(e.statusCode=200),e.minCode=200,e.maxCode=299,e.events=["accepted"],this.reply(e)},t.prototype.reject=function(e){return(e=Object.create(e||Object.prototype)).statusCode||(e.statusCode=480),e.minCode=300,e.maxCode=699,e.events=["rejected","failed"],this.reply(e)},t.prototype.reply=function(t){var i,s=(t=t||{}).statusCode||100,r=t.minCode||100,n=t.maxCode||699,o=e.Utils.getReasonPhrase(s,t.reasonPhrase),a=t.extraHeaders||[],c=t.body,h=t.events||[];if(s<r||s>n)throw new TypeError("Invalid statusCode: "+s);return i=this.request.reply(s,o,a,c),h.forEach(function(e){this.emit(e,i,o)},this),this},t.prototype.onRequestTimeout=function(){this.emit("failed",null,e.C.causes.REQUEST_TIMEOUT)},t.prototype.onTransportError=function(){this.emit("failed",null,e.C.causes.CONNECTION_ERROR)},e.ServerContext=t}},function(e,t,i){"use strict";e.exports=function(e){var t,s,r,n,o,a=i(25)(e),c={STATUS_NULL:0,STATUS_INVITE_SENT:1,STATUS_1XX_RECEIVED:2,STATUS_INVITE_RECEIVED:3,STATUS_WAITING_FOR_ANSWER:4,STATUS_ANSWERED:5,STATUS_WAITING_FOR_PRACK:6,STATUS_WAITING_FOR_ACK:7,STATUS_CANCELED:8,STATUS_TERMINATED:9,STATUS_ANSWERED_WAITING_FOR_PRACK:10,STATUS_EARLY_MEDIA:11,STATUS_CONFIRMED:12};(t=function(t){if(this.status=c.STATUS_NULL,this.dialog=null,this.pendingReinvite=!1,this.earlyDialogs={},!t)throw new e.Exceptions.SessionDescriptionHandlerMissing("A session description handler is required for the session to function");this.sessionDescriptionHandlerFactory=t,this.hasOffer=!1,this.hasAnswer=!1,this.timers={ackTimer:null,expiresTimer:null,invite2xxTimer:null,userNoAnswerTimer:null,rel1xxTimer:null,prackTimer:null},this.startTime=null,this.endTime=null,this.tones=null,this.local_hold=!1,this.early_sdp=null,this.rel100=e.C.supported.UNSUPPORTED}).prototype={dtmf:function(t,i){var s=[],r=this,n=this.ua.configuration.dtmfType;if(i=i||{},void 0===t)throw new TypeError("Not enough arguments");if(this.status!==c.STATUS_CONFIRMED&&this.status!==c.STATUS_WAITING_FOR_ACK)throw new e.Exceptions.InvalidStateError(this.status);if("string"!=typeof t&&"number"!=typeof t||!t.toString().match(/^[0-9A-D#*,]+$/i))throw new TypeError("Invalid tones: "+t);(t=t.toString(),n===e.C.dtmfType.RTP)&&(this.sessionDescriptionHandler.sendDtmf(t,i)||(this.logger.warn("Attempt to use dtmfType 'RTP' has failed, falling back to INFO packet method"),n=e.C.dtmfType.INFO));if(n===e.C.dtmfType.INFO){for(t=t.split("");t.length>0;)s.push(new a(this,t.shift(),i));if(this.tones)return this.tones=this.tones.concat(s),this;this.tones=s,function t(){var s,n;if(r.status===c.STATUS_TERMINATED||!r.tones||0===r.tones.length)return r.tones=null,this;(s=r.tones.shift()).on("failed",function(){r.tones=null}),s.send(i),n=s.duration+s.interToneGap,e.Timers.setTimeout(t,n)}()}return this},bye:function(t){var i=(t=Object.create(t||Object.prototype)).statusCode;if(this.status===c.STATUS_TERMINATED)return this.logger.error("Error: Attempted to send BYE in a terminated session."),this;if(this.logger.log("terminating Session"),i&&(i<200||i>=700))throw new TypeError("Invalid statusCode: "+i);return t.receiveResponse=function(){},this.sendRequest(e.C.BYE,t).terminated()},refer:function(t,i){if(i=i||{},this.status!==c.STATUS_CONFIRMED)throw new e.Exceptions.InvalidStateError(this.status);this.referContext=new e.ReferClientContext(this.ua,this,t,i),this.emit("referRequested",this.referContext),this.referContext.refer(i)},sendRequest:function(t,i){i=i||{};var s=this,r=new e.OutgoingRequest(t,this.dialog.remote_target,this.ua,{cseq:i.cseq||(this.dialog.local_seqnum+=1),call_id:this.dialog.id.call_id,from_uri:this.dialog.local_uri,from_tag:this.dialog.id.local_tag,to_uri:this.dialog.remote_uri,to_tag:this.dialog.id.remote_tag,route_set:this.dialog.route_set,statusCode:i.statusCode,reasonPhrase:i.reasonPhrase},i.extraHeaders||[],i.body);return new e.RequestSender({request:r,onRequestTimeout:function(){s.onRequestTimeout()},onTransportError:function(){s.onTransportError()},receiveResponse:i.receiveResponse||function(e){s.receiveNonInviteResponse(e)}},this.ua).send(),this.emit(t.toLowerCase(),r),this},close:function(){var t;if(this.status===c.STATUS_TERMINATED)return this;for(t in this.logger.log("closing INVITE session "+this.id),this.sessionDescriptionHandler&&this.sessionDescriptionHandler.close(),this.timers)e.Timers.clearTimeout(this.timers[t]);for(t in this.dialog&&(this.dialog.terminate(),delete this.dialog),this.earlyDialogs)this.earlyDialogs[t].terminate(),delete this.earlyDialogs[t];return this.status=c.STATUS_TERMINATED,this.ua.transport.removeListener("transportError",this.errorListener),delete this.ua.sessions[this.id],this},createDialog:function(t,i,s){var r,n,o=t["UAS"===i?"to_tag":"from_tag"],a=t["UAS"===i?"from_tag":"to_tag"],c=t.call_id+o+a;if(n=this.earlyDialogs[c],s)return!!n||((n=new e.Dialog(this,t,i,e.Dialog.C.STATUS_EARLY)).error?(this.logger.error(n.error),this.failed(t,e.C.causes.INTERNAL_ERROR),!1):(this.earlyDialogs[c]=n,!0));if(n){for(var h in n.update(t,i),this.dialog=n,delete this.earlyDialogs[c],this.earlyDialogs)this.earlyDialogs[h].terminate(),delete this.earlyDialogs[h];return!0}return(r=new e.Dialog(this,t,i)).error?(this.logger.error(r.error),this.failed(t,e.C.causes.INTERNAL_ERROR),!1):(this.to_tag=t.to_tag,this.dialog=r,!0)},hold:function(t,i){if(this.status!==c.STATUS_WAITING_FOR_ACK&&this.status!==c.STATUS_CONFIRMED)throw new e.Exceptions.InvalidStateError(this.status);this.local_hold?this.logger.log("Session is already on hold, cannot put it on hold again"):((t=t||{}).modifiers=i||[],t.modifiers.push(this.sessionDescriptionHandler.holdModifier),this.local_hold=!0,this.sendReinvite(t))},unhold:function(t,i){if(this.status!==c.STATUS_WAITING_FOR_ACK&&this.status!==c.STATUS_CONFIRMED)throw new e.Exceptions.InvalidStateError(this.status);this.local_hold?(t=t||{},i&&(t.modifiers=i),this.local_hold=!1,this.sendReinvite(t)):this.logger.log("Session is not on hold, cannot unhold it")},reinvite:function(e,t){return e=e||{},t&&(e.modifiers=t),this.sendReinvite(e)},receiveReinvite:function(t){var i,s=this;if(s.emit("reinvite",this),t.hasHeader("P-Asserted-Identity")&&(this.assertedIdentity=new e.NameAddrHeader.parse(t.getHeader("P-Asserted-Identity"))),"0"!==t.getHeader("Content-Length")||t.getHeader("Content-Type")){if(!this.sessionDescriptionHandler.hasDescription(t.getHeader("Content-Type")))return t.reply(415),void this.emit("reinviteFailed",s);i=this.sessionDescriptionHandler.setDescription(t.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(this.sessionDescriptionHandler.getDescription.bind(this.sessionDescriptionHandler,this.sessionDescriptionHandlerOptions,this.modifiers))}else i=this.sessionDescriptionHandler.getDescription(this.sessionDescriptionHandlerOptions,this.modifiers);this.receiveRequest=function(t){t.method===e.C.ACK&&this.status===c.STATUS_WAITING_FOR_ACK?this.sessionDescriptionHandler.hasDescription(t.getHeader("Content-Type"))?(this.hasAnswer=!0,this.sessionDescriptionHandler.setDescription(t.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(function(){e.Timers.clearTimeout(this.timers.ackTimer),e.Timers.clearTimeout(this.timers.invite2xxTimer),this.status=c.STATUS_CONFIRMED,this.emit("confirmed",t)}.bind(this))):(e.Timers.clearTimeout(this.timers.ackTimer),e.Timers.clearTimeout(this.timers.invite2xxTimer),this.status=c.STATUS_CONFIRMED,this.emit("confirmed",t)):e.Session.prototype.receiveRequest.apply(this,[t])}.bind(this),i.catch(function(i){var r;i instanceof e.Exceptions.GetDescriptionError?r=500:i instanceof e.Exceptions.RenegotiationError?(s.emit("renegotiationError",i),s.logger.warn(i),r=488):(s.logger.error(i),r=488),t.reply(r),s.emit("reinviteFailed",s)}).then(function(e){var i=["Contact: "+s.contact];t.reply(200,null,i,e,function(){s.status=c.STATUS_WAITING_FOR_ACK,s.setACKTimer(),s.emit("reinviteAccepted",s)})})},sendReinvite:function(t){if(this.pendingReinvite)this.logger.warn("Reinvite in progress. Please wait until complete, then try again.");else{this.pendingReinvite=!0,(t=t||{}).modifiers=t.modifiers||[];var i=this,s=(t.extraHeaders||[]).slice();s.push("Contact: "+this.contact),s.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),this.sessionDescriptionHandler.getDescription(t.sessionDescriptionHandlerOptions,t.modifiers).then(function(t){i.sendRequest(e.C.INVITE,{extraHeaders:s,body:t,receiveResponse:i.receiveReinviteResponse.bind(i)})}).catch(function(t){if(t instanceof e.Exceptions.RenegotiationError)return i.pendingReinvite=!1,i.emit("renegotiationError",t),i.logger.warn("Renegotiation Error"),void i.logger.warn(t);i.logger.error("sessionDescriptionHandler error"),i.logger.error(t)})}},receiveRequest:function(t){switch(t.method){case e.C.BYE:t.reply(200),this.status===c.STATUS_CONFIRMED&&(this.emit("bye",t),this.terminated(t,e.C.causes.BYE));break;case e.C.INVITE:this.status===c.STATUS_CONFIRMED&&(this.logger.log("re-INVITE received"),this.receiveReinvite(t));break;case e.C.INFO:if(this.status===c.STATUS_CONFIRMED||this.status===c.STATUS_WAITING_FOR_ACK){if(this.onInfo)return this.onInfo(t);var i,s,r,n=t.getHeader("content-type"),o=/^(Signal\s*?=\s*?)([0-9A-D#*]{1})(\s)?.*/,h=/^(Duration\s?=\s?)([0-9]{1,4})(\s)?.*/;n&&(n.match(/^application\/dtmf-relay/i)?(t.body&&2===(i=t.body.split("\r\n",2)).length&&(o.test(i[0])&&(s=i[0].replace(o,"$2")),h.test(i[1])&&(r=parseInt(i[1].replace(h,"$2"),10))),new a(this,s,{duration:r}).init_incoming(t)):t.reply(415,null,["Accept: application/dtmf-relay"]))}break;case e.C.REFER:if(this.status===c.STATUS_CONFIRMED)if(this.logger.log("REFER received"),this.referContext=new e.ReferServerContext(this.ua,t),this.listeners("referRequested").length)this.emit("referRequested",this.referContext);else{this.logger.log("No referRequested listeners, automatically accepting and following the refer");var u={followRefer:!0};this.passedOptions&&(u.inviteOptions=this.passedOptions),this.referContext.accept(u,this.modifiers)}break;case e.C.NOTIFY:if(this.referContext&&this.referContext instanceof e.ReferClientContext&&t.hasHeader("event")&&/^refer(;.*)?$/.test(t.getHeader("event")))return void this.referContext.receiveNotify(t);t.reply(200,"OK"),this.emit("notify",t)}},receiveReinviteResponse:function(t){var i=this;if(this.status!==c.STATUS_TERMINATED)switch(!0){case/^1[0-9]{2}$/.test(t.status_code):break;case/^2[0-9]{2}$/.test(t.status_code):if(this.status=c.STATUS_CONFIRMED,this.emit("ack",t.transaction.sendACK()),this.pendingReinvite=!1,e.Timers.clearTimeout(i.timers.invite2xxTimer),!this.sessionDescriptionHandler.hasDescription(t.getHeader("Content-Type"))){this.logger.error("2XX response received to re-invite but did not have a description"),this.emit("reinviteFailed",i),this.emit("renegotiationError",new e.Exceptions.RenegotiationError("2XX response received to re-invite but did not have a description"));break}this.sessionDescriptionHandler.setDescription(t.body,this.sessionDescriptionHandlerOptions,this.modifiers).catch(function(t){i.logger.error("Could not set the description in 2XX response"),i.logger.error(t),i.emit("reinviteFailed",i),i.emit("renegotiationError",t),i.sendRequest(e.C.BYE,{extraHeaders:["Reason: "+e.Utils.getReasonHeaderValue(488,"Not Acceptable Here")]}),i.terminated(null,e.C.causes.INCOMPATIBLE_SDP)}).then(function(){i.emit("reinviteAccepted",i)});break;default:this.pendingReinvite=!1,this.logger.log("Received a non 1XX or 2XX response to a re-invite"),this.emit("reinviteFailed",i),this.emit("renegotiationError",new e.Exceptions.RenegotiationError("Invalid response to a re-invite"))}},acceptAndTerminate:function(t,i,s){var r=[];return i&&r.push("Reason: "+e.Utils.getReasonHeaderValue(i,s)),(this.dialog||this.createDialog(t,"UAC"))&&(this.emit("ack",t.transaction.sendACK()),this.sendRequest(e.C.BYE,{extraHeaders:r})),this},setInvite2xxTimer:function(t,i){var s=this,r=e.Timers.T1;this.timers.invite2xxTimer=e.Timers.setTimeout(function n(){if(s.status===c.STATUS_WAITING_FOR_ACK){s.logger.log("no ACK received, attempting to retransmit OK");var o=["Contact: "+s.contact];t.reply(200,null,o,i),r=Math.min(2*r,e.Timers.T2),s.timers.invite2xxTimer=e.Timers.setTimeout(n,r)}},r)},setACKTimer:function(){var t=this;this.timers.ackTimer=e.Timers.setTimeout(function(){t.status===c.STATUS_WAITING_FOR_ACK&&(t.logger.log("no ACK received for an extended period of time, terminating the call"),e.Timers.clearTimeout(t.timers.invite2xxTimer),t.sendRequest(e.C.BYE),t.terminated(null,e.C.causes.NO_ACK))},e.Timers.TIMER_H)},onTransportError:function(){this.status!==c.STATUS_CONFIRMED&&this.status!==c.STATUS_TERMINATED&&this.failed(null,e.C.causes.CONNECTION_ERROR)},onRequestTimeout:function(){this.status===c.STATUS_CONFIRMED?this.terminated(null,e.C.causes.REQUEST_TIMEOUT):this.status!==c.STATUS_TERMINATED&&(this.failed(null,e.C.causes.REQUEST_TIMEOUT),this.terminated(null,e.C.causes.REQUEST_TIMEOUT))},onDialogError:function(t){this.status===c.STATUS_CONFIRMED?this.terminated(t,e.C.causes.DIALOG_ERROR):this.status!==c.STATUS_TERMINATED&&(this.failed(t,e.C.causes.DIALOG_ERROR),this.terminated(t,e.C.causes.DIALOG_ERROR))},failed:function(e,t){return this.status===c.STATUS_TERMINATED?this:(this.emit("failed",e||null,t||null),this)},rejected:function(e,t){return this.emit("rejected",e||null,t||null),this},canceled:function(){return this.sessionDescriptionHandler&&this.sessionDescriptionHandler.close(),this.emit("cancel"),this},accepted:function(t,i){return i=e.Utils.getReasonPhrase(t&&t.status_code,i),this.startTime=new Date,this.replacee&&(this.replacee.emit("replaced",this),this.replacee.terminate()),this.emit("accepted",t,i),this},terminated:function(e,t){return this.status===c.STATUS_TERMINATED?this:(this.endTime=new Date,this.close(),this.emit("terminated",e||null,t||null),this)},connecting:function(e){return this.emit("connecting",{request:e}),this}},t.C=c,e.Session=t,(s=function(t,i){var s,r=this,n=i.getHeader("Content-Type"),o=i.parseHeader("Content-Disposition");function a(e,t){i.hasHeader(e)&&i.getHeader(e).toLowerCase().indexOf("100rel")>=0&&(r.rel100=t)}if(e.Utils.augment(this,e.ServerContext,[t,i]),e.Utils.augment(this,e.Session,[t.configuration.sessionDescriptionHandlerFactory]),o&&"render"===o.type&&(this.renderbody=i.body,this.rendertype=n),this.status=c.STATUS_INVITE_RECEIVED,this.from_tag=i.from_tag,this.id=i.call_id+this.from_tag,this.request=i,this.contact=this.ua.contact.toString(),this.receiveNonInviteResponse=function(){},this.logger=t.getLogger("sip.inviteservercontext",this.id),this.ua.sessions[this.id]=this,i.hasHeader("expires")&&(s=1e3*i.getHeader("expires")),a("require",e.C.supported.REQUIRED),a("supported",e.C.supported.SUPPORTED),i.to_tag=e.Utils.newTag(),this.createDialog(i,"UAS",!0)){var h={extraHeaders:["Contact: "+r.contact]};r.rel100!==e.C.supported.REQUIRED&&r.progress(h),r.status=c.STATUS_WAITING_FOR_ANSWER,r.timers.userNoAnswerTimer=e.Timers.setTimeout(function(){i.reply(408),r.failed(i,e.C.causes.NO_ANSWER),r.terminated(i,e.C.causes.NO_ANSWER)},r.ua.configuration.noAnswerTimeout),s&&(r.timers.expiresTimer=e.Timers.setTimeout(function(){r.status===c.STATUS_WAITING_FOR_ANSWER&&(i.reply(487),r.failed(i,e.C.causes.EXPIRES),r.terminated(i,e.C.causes.EXPIRES))},s)),this.errorListener=this.onTransportError.bind(this),t.transport.on("transportError",this.errorListener)}else i.reply(500,"Missing Contact header field")}).prototype=Object.create({},{reject:{writable:!0,value:function(t){if(this.status===c.STATUS_TERMINATED)throw new e.Exceptions.InvalidStateError(this.status);return this.logger.log("rejecting RTCSession"),e.ServerContext.prototype.reject.call(this,t),this.terminated()}},terminate:{writable:!0,value:function(t){var i,s=((t=t||{}).extraHeaders||[]).slice(),r=t.body,n=this;return this.status===c.STATUS_WAITING_FOR_ACK&&this.request.server_transaction.state!==e.Transactions.C.STATUS_TERMINATED?(i=this.dialog,this.receiveRequest=function(t){t.method===e.C.ACK&&(this.sendRequest(e.C.BYE,{extraHeaders:s,body:r}),i.terminate())},this.request.server_transaction.on("stateChanged",function(){this.state===e.Transactions.C.STATUS_TERMINATED&&this.dialog&&(this.request=new e.OutgoingRequest(e.C.BYE,this.dialog.remote_target,this.ua,{cseq:this.dialog.local_seqnum+=1,call_id:this.dialog.id.call_id,from_uri:this.dialog.local_uri,from_tag:this.dialog.id.local_tag,to_uri:this.dialog.remote_uri,to_tag:this.dialog.id.remote_tag,route_set:this.dialog.route_set},s,r),new e.RequestSender({request:this.request,onRequestTimeout:function(){n.onRequestTimeout()},onTransportError:function(){n.onTransportError()},receiveResponse:function(){}},this.ua).send(),i.terminate())}),this.emit("bye",this.request),this.terminated(),this.dialog=i,this.ua.dialogs[i.id.toString()]=i):this.status===c.STATUS_CONFIRMED?this.bye(t):this.reject(t),this}},progress:{writable:!0,value:function(t){var i,s=(t=t||{}).statusCode||180,r=t.reasonPhrase,n=(t.extraHeaders||[]).slice(),o=t.body;if(s<100||s>199)throw new TypeError("Invalid statusCode: "+s);if(this.isCanceled||this.status===c.STATUS_TERMINATED)return this;function a(){s=t.statusCode||183,this.status=c.STATUS_WAITING_FOR_PRACK,n.push("Contact: "+this.contact),n.push("Require: 100rel"),n.push("RSeq: "+Math.floor(1e4*Math.random())),this.sessionDescriptionHandler.getDescription(t.sessionDescriptionHandlerOptions,t.modifiers).then(function(t){if(!this.isCanceled&&this.status!==c.STATUS_TERMINATED){this.early_sdp=t.body,this[this.hasOffer?"hasAnswer":"hasOffer"]=!0;var o=e.Timers.T1;this.timers.rel1xxTimer=e.Timers.setTimeout(function i(){this.request.reply(s,null,n,t),o*=2,this.timers.rel1xxTimer=e.Timers.setTimeout(i.bind(this),o)}.bind(this),o),this.timers.prackTimer=e.Timers.setTimeout(function(){this.status===c.STATUS_WAITING_FOR_PRACK&&(this.logger.log("no PRACK received, rejecting the call"),e.Timers.clearTimeout(this.timers.rel1xxTimer),this.request.reply(504),this.terminated(null,e.C.causes.NO_PRACK))}.bind(this),64*e.Timers.T1),i=this.request.reply(s,r,n,t),this.emit("progress",i,r)}}.bind(this),function(){this.request.reply(480),this.failed(null,e.C.causes.WEBRTC_ERROR),this.terminated(null,e.C.causes.WEBRTC_ERROR)}.bind(this))}return 100!==t.statusCode&&(this.rel100===e.C.supported.REQUIRED||this.rel100===e.C.supported.SUPPORTED&&t.rel100||this.rel100===e.C.supported.SUPPORTED&&this.ua.configuration.rel100===e.C.supported.REQUIRED)?(this.sessionDescriptionHandler=this.setupSessionDescriptionHandler(),this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),this.sessionDescriptionHandler.hasDescription(this.request.getHeader("Content-Type"))?(this.hasOffer=!0,this.sessionDescriptionHandler.setDescription(this.request.body,t.sessionDescriptionHandlerOptions,t.modifiers).then(a.apply(this)).catch(function(t){this.logger.warn("invalid description"),this.logger.warn(t),this.failed(null,e.C.causes.WEBRTC_ERROR),this.terminated(null,e.C.causes.WEBRTC_ERROR)}.bind(this))):a.apply(this)):function(){i=this.request.reply(s,r,n,o),this.emit("progress",i,r)}.apply(this),this}},accept:{writable:!0,value:function(t){t=t||{},this.onInfo=t.onInfo;var i=this,s=this.request,r=(t.extraHeaders||[]).slice(),n=function(t){var n;r.push("Contact: "+i.contact),r.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),i.hasOffer?i.hasAnswer=!0:i.hasOffer=!0,n=s.reply(200,null,r,t,function(){i.status=c.STATUS_WAITING_FOR_ACK,i.setInvite2xxTimer(s,t),i.setACKTimer()},function(){i.failed(null,e.C.causes.CONNECTION_ERROR),i.terminated(null,e.C.causes.CONNECTION_ERROR)}),i.status!==c.STATUS_TERMINATED&&i.accepted(n,e.Utils.getReasonPhrase(200))},o=function(){i.status!==c.STATUS_TERMINATED&&(i.request.reply(480),i.failed(null,e.C.causes.WEBRTC_ERROR),i.terminated(null,e.C.causes.WEBRTC_ERROR))};if(this.status===c.STATUS_WAITING_FOR_PRACK)return this.status=c.STATUS_ANSWERED_WAITING_FOR_PRACK,this;if(this.status===c.STATUS_WAITING_FOR_ANSWER)this.status=c.STATUS_ANSWERED;else if(this.status!==c.STATUS_EARLY_MEDIA)throw new e.Exceptions.InvalidStateError(this.status);if(!this.createDialog(s,"UAS"))return s.reply(500,"Missing Contact header field"),this;if(e.Timers.clearTimeout(this.timers.userNoAnswerTimer),this.status===c.STATUS_EARLY_MEDIA)n({});else if(this.sessionDescriptionHandler=this.setupSessionDescriptionHandler(),this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),"0"!==this.request.getHeader("Content-Length")||this.request.getHeader("Content-Type")){if(!this.sessionDescriptionHandler.hasDescription(this.request.getHeader("Content-Type")))return void this.request.reply(415);this.hasOffer=!0,this.sessionDescriptionHandler.setDescription(this.request.body,t.sessionDescriptionHandlerOptions,t.modifiers).then(function(){return this.sessionDescriptionHandler.getDescription(t.sessionDescriptionHandlerOptions,t.modifiers)}.bind(this)).catch(o).then(n)}else this.sessionDescriptionHandler.getDescription(t.sessionDescriptionHandlerOptions,t.modifiers).catch(o).then(n);return this}},receiveRequest:{writable:!0,value:function(i){function s(){var t,s;e.Timers.clearTimeout(this.timers.ackTimer),e.Timers.clearTimeout(this.timers.invite2xxTimer),this.status=c.STATUS_CONFIRMED,t=i.getHeader("Content-Type"),(s=i.getHeader("Content-Disposition"))&&"render"===s.type&&(this.renderbody=i.body,this.rendertype=t),this.emit("confirmed",i)}switch(i.method){case e.C.CANCEL:this.status!==c.STATUS_WAITING_FOR_ANSWER&&this.status!==c.STATUS_WAITING_FOR_PRACK&&this.status!==c.STATUS_ANSWERED_WAITING_FOR_PRACK&&this.status!==c.STATUS_EARLY_MEDIA&&this.status!==c.STATUS_ANSWERED||(this.status=c.STATUS_CANCELED,this.request.reply(487),this.canceled(i),this.rejected(i,e.C.causes.CANCELED),this.failed(i,e.C.causes.CANCELED),this.terminated(i,e.C.causes.CANCELED));break;case e.C.ACK:this.status===c.STATUS_WAITING_FOR_ACK&&(this.sessionDescriptionHandler.hasDescription(i.getHeader("Content-Type"))?(this.hasAnswer=!0,this.sessionDescriptionHandler.setDescription(i.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(s.bind(this),function(t){this.logger.warn(t),this.terminate({statusCode:"488",reasonPhrase:"Bad Media Description"}),this.failed(i,e.C.causes.BAD_MEDIA_DESCRIPTION),this.terminated(i,e.C.causes.BAD_MEDIA_DESCRIPTION)}.bind(this))):s.apply(this));break;case e.C.PRACK:this.status===c.STATUS_WAITING_FOR_PRACK||this.status===c.STATUS_ANSWERED_WAITING_FOR_PRACK?this.hasAnswer?(e.Timers.clearTimeout(this.timers.rel1xxTimer),e.Timers.clearTimeout(this.timers.prackTimer),i.reply(200),this.status===c.STATUS_ANSWERED_WAITING_FOR_PRACK&&(this.status=c.STATUS_EARLY_MEDIA,this.accept()),this.status=c.STATUS_EARLY_MEDIA):(this.sessionDescriptionHandler=this.setupSessionDescriptionHandler(),this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),this.sessionDescriptionHandler.hasDescription(i.getHeader("Content-Type"))?(this.hasAnswer=!0,this.sessionDescriptionHandler.setDescription(i.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(function(){e.Timers.clearTimeout(this.timers.rel1xxTimer),e.Timers.clearTimeout(this.timers.prackTimer),i.reply(200),this.status===c.STATUS_ANSWERED_WAITING_FOR_PRACK&&(this.status=c.STATUS_EARLY_MEDIA,this.accept()),this.status=c.STATUS_EARLY_MEDIA}.bind(this),function(t){this.logger.warn(t),this.terminate({statusCode:"488",reasonPhrase:"Bad Media Description"}),this.failed(i,e.C.causes.BAD_MEDIA_DESCRIPTION),this.terminated(i,e.C.causes.BAD_MEDIA_DESCRIPTION)}.bind(this))):(this.terminate({statusCode:"488",reasonPhrase:"Bad Media Description"}),this.failed(i,e.C.causes.BAD_MEDIA_DESCRIPTION),this.terminated(i,e.C.causes.BAD_MEDIA_DESCRIPTION))):this.status===c.STATUS_EARLY_MEDIA&&i.reply(200);break;default:t.prototype.receiveRequest.apply(this,[i])}}},setupSessionDescriptionHandler:{writable:!0,value:function(){return this.sessionDescriptionHandler?this.sessionDescriptionHandler:this.sessionDescriptionHandlerFactory(this,this.ua.configuration.sessionDescriptionHandlerFactoryOptions)}},onTransportError:{writable:!0,value:function(){this.status!==c.STATUS_CONFIRMED&&this.status!==c.STATUS_TERMINATED&&this.failed(null,e.C.causes.CONNECTION_ERROR)}},onRequestTimeout:{writable:!0,value:function(){this.status===c.STATUS_CONFIRMED?this.terminated(null,e.C.causes.REQUEST_TIMEOUT):this.status!==c.STATUS_TERMINATED&&(this.failed(null,e.C.causes.REQUEST_TIMEOUT),this.terminated(null,e.C.causes.REQUEST_TIMEOUT))}}}),e.InviteServerContext=s,(r=function(t,i,s,r){s=s||{},this.passedOptions=s,s.params=Object.create(s.params||Object.prototype);var n=(s.extraHeaders||[]).slice(),o=t.configuration.sessionDescriptionHandlerFactory;if(this.sessionDescriptionHandlerFactoryOptions=t.configuration.sessionDescriptionHandlerFactoryOptions||{},this.sessionDescriptionHandlerOptions=s.sessionDescriptionHandlerOptions||{},this.modifiers=r,this.inviteWithoutSdp=s.inviteWithoutSdp||!1,this.anonymous=s.anonymous||!1,this.renderbody=s.renderbody||null,this.rendertype=s.rendertype||"text/plain",this.from_tag=e.Utils.newTag(),s.params.from_tag=this.from_tag,this.contact=t.contact.toString({anonymous:this.anonymous,outbound:this.anonymous?!t.contact.temp_gruu:!t.contact.pub_gruu}),this.anonymous&&(s.params.from_displayName="Anonymous",s.params.from_uri="sip:anonymous@anonymous.invalid",n.push("P-Preferred-Identity: "+t.configuration.uri.toString()),n.push("Privacy: id")),n.push("Contact: "+this.contact),n.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),this.inviteWithoutSdp&&this.renderbody&&(n.push("Content-Type: "+this.rendertype),n.push("Content-Disposition: render;handling=optional")),t.configuration.rel100===e.C.supported.REQUIRED&&n.push("Require: 100rel"),t.configuration.replaces===e.C.supported.REQUIRED&&n.push("Require: replaces"),s.extraHeaders=n,e.Utils.augment(this,e.ClientContext,[t,e.C.INVITE,i,s]),e.Utils.augment(this,e.Session,[o]),this.status!==c.STATUS_NULL)throw new e.Exceptions.InvalidStateError(this.status);this.isCanceled=!1,this.received_100=!1,this.method=e.C.INVITE,this.receiveNonInviteResponse=this.receiveResponse,this.receiveResponse=this.receiveInviteResponse,this.logger=t.getLogger("sip.inviteclientcontext"),t.applicants[this]=this,this.id=this.request.call_id+this.from_tag,this.onInfo=s.onInfo,this.errorListener=this.onTransportError.bind(this),t.transport.on("transportError",this.errorListener)}).prototype=Object.create({},{invite:{writable:!0,value:function(){var t=this;return this.ua.sessions[this.id]=this,e.Utils.Promise.resolve().then(function(){this.inviteWithoutSdp?(this.request.body=t.renderbody,this.status=c.STATUS_INVITE_SENT,this.send()):(this.sessionDescriptionHandler=this.sessionDescriptionHandlerFactory(this,this.sessionDescriptionHandlerFactoryOptions),this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),this.sessionDescriptionHandler.getDescription(this.sessionDescriptionHandlerOptions,this.modifiers).then(function(e){t.isCanceled||t.status===c.STATUS_TERMINATED||(t.hasOffer=!0,t.request.body=e,t.status=c.STATUS_INVITE_SENT,t.send())},function(){t.status!==c.STATUS_TERMINATED&&(t.failed(null,e.C.causes.WEBRTC_ERROR),t.terminated(null,e.C.causes.WEBRTC_ERROR))}))}.bind(this)),this}},receiveInviteResponse:{writable:!0,value:function(t){var i,s=this,r=t.call_id+t.from_tag+t.to_tag,n=[],o={};if(this.status!==c.STATUS_TERMINATED&&t.method===e.C.INVITE){if(this.dialog&&t.status_code>=200&&t.status_code<=299){if(r!==this.dialog.id.toString()){if(!this.createDialog(t,"UAC",!0))return;return this.emit("ack",t.transaction.sendACK({body:e.Utils.generateFakeSDP(t.body)})),this.earlyDialogs[r].sendRequest(this,e.C.BYE),void(this.status!==c.STATUS_CONFIRMED&&(this.failed(t,e.C.causes.WEBRTC_ERROR),this.terminated(t,e.C.causes.WEBRTC_ERROR)))}if(this.status===c.STATUS_CONFIRMED)return void this.emit("ack",t.transaction.sendACK());if(!this.hasAnswer)return}if(this.dialog&&t.status_code<200){if(-1!==this.dialog.pracked.indexOf(t.getHeader("rseq"))||this.dialog.pracked[this.dialog.pracked.length-1]>=t.getHeader("rseq")&&this.dialog.pracked.length>0)return;if(!this.earlyDialogs[r]&&!this.createDialog(t,"UAC",!0))return;if(-1!==this.earlyDialogs[r].pracked.indexOf(t.getHeader("rseq"))||this.earlyDialogs[r].pracked[this.earlyDialogs[r].pracked.length-1]>=t.getHeader("rseq")&&this.earlyDialogs[r].pracked.length>0)return;return n.push("RAck: "+t.getHeader("rseq")+" "+t.getHeader("cseq")),this.earlyDialogs[r].pracked.push(t.getHeader("rseq")),void this.earlyDialogs[r].sendRequest(this,e.C.PRACK,{extraHeaders:n,body:e.Utils.generateFakeSDP(t.body)})}if(this.isCanceled)t.status_code>=100&&t.status_code<200?(this.request.cancel(this.cancelReason,n),this.canceled(null)):t.status_code>=200&&t.status_code<299?(this.acceptAndTerminate(t),this.emit("bye",this.request)):t.status_code>=300&&(i=e.C.REASON_PHRASE[t.status_code]||e.C.causes.CANCELED,this.rejected(t,i),this.failed(t,i),this.terminated(t,i));else switch(!0){case/^100$/.test(t.status_code):this.received_100=!0,this.emit("progress",t);break;case/^1[0-9]{2}$/.test(t.status_code):if(!t.to_tag){this.logger.warn("1xx response received without to tag");break}if(t.hasHeader("contact")&&!this.createDialog(t,"UAC",!0))break;if(this.status=c.STATUS_1XX_RECEIVED,t.hasHeader("P-Asserted-Identity")&&(this.assertedIdentity=new e.NameAddrHeader.parse(t.getHeader("P-Asserted-Identity"))),t.hasHeader("require")&&-1!==t.getHeader("require").indexOf("100rel")){if(this.dialog||!this.earlyDialogs[r])break;if(-1!==this.earlyDialogs[r].pracked.indexOf(t.getHeader("rseq"))||this.earlyDialogs[r].pracked[this.earlyDialogs[r].pracked.length-1]>=t.getHeader("rseq")&&this.earlyDialogs[r].pracked.length>0)return;if(this.sessionDescriptionHandler=this.sessionDescriptionHandlerFactory(this,this.sessionDescriptionHandlerFactoryOptions),this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),this.sessionDescriptionHandler.hasDescription(t.getHeader("Content-Type")))if(this.hasOffer){if(!this.createDialog(t,"UAC"))break;this.hasAnswer=!0,this.dialog.pracked.push(t.getHeader("rseq")),this.sessionDescriptionHandler.setDescription(t.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(function(){n.push("RAck: "+t.getHeader("rseq")+" "+t.getHeader("cseq")),s.sendRequest(e.C.PRACK,{extraHeaders:n,receiveResponse:function(){}}),s.status=c.STATUS_EARLY_MEDIA,s.emit("progress",t)},function(i){s.logger.warn(i),s.acceptAndTerminate(t,488,"Not Acceptable Here"),s.failed(t,e.C.causes.BAD_MEDIA_DESCRIPTION)})}else{var a=this.earlyDialogs[r],h=a.sessionDescriptionHandler=this.sessionDescriptionHandlerFactory(this,this.sessionDescriptionHandlerFactoryOptions);this.emit("SessionDescriptionHandler-created",h),a.pracked.push(t.getHeader("rseq")),h.setDescription(t.body,s.sessionDescriptionHandlerOptions,s.modifers).then(h.getDescription.bind(h,s.sessionDescriptionHandlerOptions,s.modifiers)).then(function(i){n.push("RAck: "+t.getHeader("rseq")+" "+t.getHeader("cseq")),a.sendRequest(s,e.C.PRACK,{extraHeaders:n,body:i}),s.status=c.STATUS_EARLY_MEDIA,s.emit("progress",t)}).catch(function(i){if(i instanceof e.Exceptions.GetDescriptionError){if(a.pracked.push(t.getHeader("rseq")),s.status===c.STATUS_TERMINATED)return;s.failed(null,e.C.causes.WEBRTC_ERROR),s.terminated(null,e.C.causes.WEBRTC_ERROR)}else a.pracked.splice(a.pracked.indexOf(t.getHeader("rseq")),1),s.logger.warn("invalid description"),s.logger.warn(i)})}else n.push("RAck: "+t.getHeader("rseq")+" "+t.getHeader("cseq")),this.earlyDialogs[r].pracked.push(t.getHeader("rseq")),this.earlyDialogs[r].sendRequest(this,e.C.PRACK,{extraHeaders:n}),this.emit("progress",t)}else this.emit("progress",t);break;case/^2[0-9]{2}$/.test(t.status_code):if(this.request.cseq+" "+this.request.method!==t.getHeader("cseq"))break;if(t.hasHeader("P-Asserted-Identity")&&(this.assertedIdentity=new e.NameAddrHeader.parse(t.getHeader("P-Asserted-Identity"))),this.status===c.STATUS_EARLY_MEDIA&&this.dialog){this.status=c.STATUS_CONFIRMED,o={},this.renderbody&&(n.push("Content-Type: "+this.rendertype),o.extraHeaders=n,o.body=this.renderbody),this.emit("ack",t.transaction.sendACK(o)),this.accepted(t);break}if(this.dialog)break;if(this.hasOffer)if(this.hasAnswer)this.renderbody&&(n.push("Content-Type: "+s.rendertype),o.extraHeaders=n,o.body=this.renderbody),this.emit("ack",t.transaction.sendACK(o));else{if(!this.sessionDescriptionHandler.hasDescription(t.getHeader("Content-Type"))){this.acceptAndTerminate(t,400,"Missing session description"),this.failed(t,e.C.causes.BAD_MEDIA_DESCRIPTION);break}if(!this.createDialog(t,"UAC"))break;this.hasAnswer=!0,this.sessionDescriptionHandler.setDescription(t.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(function(){var e={};s.status=c.STATUS_CONFIRMED,s.renderbody&&(n.push("Content-Type: "+s.rendertype),e.extraHeaders=n,e.body=s.renderbody),s.emit("ack",t.transaction.sendACK(e)),s.accepted(t)},function(i){s.logger.warn(i),s.acceptAndTerminate(t,488,"Not Acceptable Here"),s.failed(t,e.C.causes.BAD_MEDIA_DESCRIPTION)})}else if(this.earlyDialogs[r]&&this.earlyDialogs[r].sessionDescriptionHandler){if(this.hasOffer=!0,this.hasAnswer=!0,this.sessionDescriptionHandler=this.earlyDialogs[r].sessionDescriptionHandler,!this.createDialog(t,"UAC"))break;this.status=c.STATUS_CONFIRMED,this.emit("ack",t.transaction.sendACK()),this.accepted(t)}else{if(this.sessionDescriptionHandler=this.sessionDescriptionHandlerFactory(this,this.sessionDescriptionHandlerFactoryOptions),this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),!this.sessionDescriptionHandler.hasDescription(t.getHeader("Content-Type"))){this.acceptAndTerminate(t,400,"Missing session description"),this.failed(t,e.C.causes.BAD_MEDIA_DESCRIPTION);break}if(!this.createDialog(t,"UAC"))break;this.hasOffer=!0,this.sessionDescriptionHandler.setDescription(t.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(this.sessionDescriptionHandler.getDescription.bind(this.sessionDescriptionHandler,this.sessionDescriptionHandlerOptions,this.modifiers)).then(function(e){s.isCanceled||s.status===c.STATUS_TERMINATED||(s.status=c.STATUS_CONFIRMED,s.hasAnswer=!0,s.emit("ack",t.transaction.sendACK({body:e})),s.accepted(t))}).catch(function(i){i instanceof e.Exceptions.GetDescriptionError?s.logger.warn("there was a problem"):(s.logger.warn("invalid description"),s.logger.warn(i),s.acceptAndTerminate(t,488,"Invalid session description"),s.failed(t,e.C.causes.BAD_MEDIA_DESCRIPTION))})}break;default:i=e.Utils.sipErrorCause(t.status_code),this.rejected(t,i),this.failed(t,i),this.terminated(t,i)}}}},cancel:{writable:!0,value:function(t){if((t=t||{}).extraHeaders=(t.extraHeaders||[]).slice(),this.status===c.STATUS_TERMINATED||this.status===c.STATUS_CONFIRMED)throw new e.Exceptions.InvalidStateError(this.status);this.logger.log("canceling RTCSession");var i=e.Utils.getCancelReason(t.status_code,t.reason_phrase);return this.status===c.STATUS_NULL||this.status===c.STATUS_INVITE_SENT&&!this.received_100?(this.isCanceled=!0,this.cancelReason=i):this.status!==c.STATUS_INVITE_SENT&&this.status!==c.STATUS_1XX_RECEIVED&&this.status!==c.STATUS_EARLY_MEDIA||this.request.cancel(i,t.extraHeaders),this.canceled()}},terminate:{writable:!0,value:function(e){return this.status===c.STATUS_TERMINATED?this:(this.status===c.STATUS_WAITING_FOR_ACK||this.status===c.STATUS_CONFIRMED?this.bye(e):this.cancel(e),this)}},receiveRequest:{writable:!0,value:function(i){return i.method,e.C.CANCEL,i.method===e.C.ACK&&this.status===c.STATUS_WAITING_FOR_ACK&&(e.Timers.clearTimeout(this.timers.ackTimer),e.Timers.clearTimeout(this.timers.invite2xxTimer),this.status=c.STATUS_CONFIRMED,this.accepted()),t.prototype.receiveRequest.apply(this,[i])}},onTransportError:{writable:!0,value:function(){this.status!==c.STATUS_CONFIRMED&&this.status!==c.STATUS_TERMINATED&&this.failed(null,e.C.causes.CONNECTION_ERROR)}},onRequestTimeout:{writable:!0,value:function(){this.status===c.STATUS_CONFIRMED?this.terminated(null,e.C.causes.REQUEST_TIMEOUT):this.status!==c.STATUS_TERMINATED&&(this.failed(null,e.C.causes.REQUEST_TIMEOUT),this.terminated(null,e.C.causes.REQUEST_TIMEOUT))}}}),e.InviteClientContext=r,(o=function(t,i,s,r){if(this.options=r||{},this.extraHeaders=(this.options.extraHeaders||[]).slice(),void 0===t||void 0===i||void 0===s)throw new TypeError("Not enough arguments");if(e.Utils.augment(this,e.ClientContext,[t,e.C.REFER,i.remoteIdentity.uri.toString(),r]),this.applicant=i,s instanceof e.InviteServerContext||s instanceof e.InviteClientContext)this.target='"'+s.remoteIdentity.friendlyName+'" <'+s.dialog.remote_target.toString()+"?Replaces="+s.dialog.id.call_id+"%3Bto-tag%3D"+s.dialog.id.remote_tag+"%3Bfrom-tag%3D"+s.dialog.id.local_tag+">";else{try{this.target=e.Grammar.parse(s,"Refer_To").uri||s}catch(e){this.logger.debug(".refer() cannot parse Refer_To from",s),this.logger.debug("...falling through to normalizeTarget()")}if(this.target=this.ua.normalizeTarget(this.target),!this.target)throw new TypeError("Invalid target: "+s)}this.ua&&this.extraHeaders.push("Referred-By: <"+this.ua.configuration.uri+">"),this.extraHeaders.push("Contact: "+i.contact),this.extraHeaders.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),this.extraHeaders.push("Refer-To: "+this.target),this.errorListener=this.onTransportError.bind(this),t.transport.on("transportError",this.errorListener)}).prototype=Object.create({},{refer:{writable:!0,value:function(t){t=t||{};var i=(this.extraHeaders||[]).slice();return t.extraHeaders&&i.concat(t.extraHeaders),this.applicant.sendRequest(e.C.REFER,{extraHeaders:this.extraHeaders,receiveResponse:function(e){/^1[0-9]{2}$/.test(e.status_code)?this.emit("referRequestProgress",this):/^2[0-9]{2}$/.test(e.status_code)?this.emit("referRequestAccepted",this):/^[4-6][0-9]{2}$/.test(e.status_code)&&this.emit("referRequestRejected",this),t.receiveResponse&&t.receiveResponse(e)}.bind(this)}),this}},receiveNotify:{writable:!0,value:function(t){if(t.hasHeader("Content-Type")&&-1!==t.getHeader("Content-Type").search(/^message\/sipfrag/)){var i=e.Grammar.parse(t.body,"sipfrag");if(-1===i)return void t.reply(489,"Bad Event");switch(!0){case/^1[0-9]{2}$/.test(i.status_code):this.emit("referProgress",this);break;case/^2[0-9]{2}$/.test(i.status_code):this.emit("referAccepted",this),!this.options.activeAfterTransfer&&this.applicant.terminate&&this.applicant.terminate();break;default:this.emit("referRejected",this)}return t.reply(200),void this.emit("notify",t)}t.reply(489,"Bad Event")}}}),e.ReferClientContext=o,(n=function(t,i){if(e.Utils.augment(this,e.ServerContext,[t,i]),this.ua=t,this.status=c.STATUS_INVITE_RECEIVED,this.from_tag=i.from_tag,this.id=i.call_id+this.from_tag,this.request=i,this.contact=this.ua.contact.toString(),this.logger=t.getLogger("sip.referservercontext",this.id),!this.request.hasHeader("refer-to"))return this.logger.warn("Invalid REFER packet. A refer-to header is required. Rejecting refer."),void this.reject();this.referTo=this.request.parseHeader("refer-to"),this.referredSession=this.ua.findSession(i),this.cseq=Math.floor(1e4*Math.random()),this.call_id=this.request.call_id,this.from_uri=this.request.to.uri,this.from_tag=this.request.to.parameters.tag,this.remote_target=this.request.headers.Contact[0].parsed.uri,this.to_uri=this.request.from.uri,this.to_tag=this.request.from_tag,this.route_set=this.request.getHeaders("record-route"),this.receiveNonInviteResponse=function(){},this.request.hasHeader("referred-by")&&(this.referredBy=this.request.getHeader("referred-by")),this.referTo.uri.hasHeader("replaces")&&(this.replaces=this.referTo.uri.getHeader("replaces")),this.errorListener=this.onTransportError.bind(this),t.transport.on("transportError",this.errorListener),this.status=c.STATUS_WAITING_FOR_ANSWER}).prototype=Object.create({},{progress:{writable:!0,value:function(){if(this.status!==c.STATUS_WAITING_FOR_ANSWER)throw new e.Exceptions.InvalidStateError(this.status);this.request.reply(100)}},reject:{writable:!0,value:function(t){if(this.status===c.STATUS_TERMINATED)throw new e.Exceptions.InvalidStateError(this.status);this.logger.log("Rejecting refer"),this.status=c.STATUS_TERMINATED,e.ServerContext.prototype.reject.call(this,t),this.emit("referRequestRejected",this)}},accept:{writable:!0,value:function(t,i){if(t=t||{},this.status!==c.STATUS_WAITING_FOR_ANSWER)throw new e.Exceptions.InvalidStateError(this.status);if(this.status=c.STATUS_ANSWERED,this.request.reply(202,"Accepted"),this.emit("referRequestAccepted",this),t.followRefer){this.logger.log("Accepted refer, attempting to automatically follow it");var s=this.referTo.uri;if(!s.scheme.match("^sips?$"))return this.logger.error("SIP.js can only automatically follow SIP refer target"),void this.reject();var r=t.inviteOptions||{},n=(r.extraHeaders||[]).slice();this.replaces&&n.push("Replaces: "+decodeURIComponent(this.replaces)),this.referredBy&&n.push("Referred-By: "+this.referredBy),r.extraHeaders=n,s.clearHeaders(),this.targetSession=this.ua.invite(s,r,i),this.emit("referInviteSent",this),this.targetSession.once("progress",function(){this.sendNotify("SIP/2.0 100 Trying"),this.emit("referProgress",this),this.referredSession&&this.referredSession.emit("referProgress",this)}.bind(this)),this.targetSession.once("accepted",function(){this.logger.log("Successfully followed the refer"),this.sendNotify("SIP/2.0 200 OK"),this.emit("referAccepted",this),this.referredSession&&this.referredSession.emit("referAccepted",this)}.bind(this));var o=function(e){if(this.status!==c.STATUS_TERMINATED){if(this.logger.log("Refer was not successful. Resuming session"),e&&429===e.status_code)return this.logger.log("Alerting referrer that identity is required."),void this.sendNotify("SIP/2.0 429 Provide Referrer Identity");this.sendNotify("SIP/2.0 603 Declined"),this.status=c.STATUS_TERMINATED,this.emit("referRejected",this),this.referredSession&&this.referredSession.emit("referRejected")}};this.targetSession.once("rejected",o.bind(this)),this.targetSession.once("failed",o.bind(this))}else this.logger.log("Accepted refer, but did not automatically follow it"),this.sendNotify("SIP/2.0 200 OK"),this.emit("referAccepted",this),this.referredSession&&this.referredSession.emit("referAccepted",this)}},sendNotify:{writable:!0,value:function(t){if(this.status!==c.STATUS_ANSWERED)throw new e.Exceptions.InvalidStateError(this.status);if(-1===e.Grammar.parse(t,"sipfrag"))throw new Error("sipfrag body is required to send notify for refer");var i=new e.OutgoingRequest(e.C.NOTIFY,this.remote_target,this.ua,{cseq:this.cseq+=1,call_id:this.call_id,from_uri:this.from_uri,from_tag:this.from_tag,to_uri:this.to_uri,to_tag:this.to_tag,route_set:this.route_set},["Event: refer","Subscription-State: terminated","Content-Type: message/sipfrag"],t);new e.RequestSender({request:i,onRequestTimeout:function(){},onTransportError:function(){},receiveResponse:function(){}},this.ua).send()}}}),e.ReferServerContext=n}},function(e,t,i){"use strict";e.exports=function(e){var t;return(t=function(i,s,r){var n,o;if(void 0===s)throw new TypeError("Not enough arguments");if(this.logger=i.ua.getLogger("sip.invitecontext.dtmf",i.id),this.owner=i,this.direction=null,n=(r=r||{}).duration||null,o=r.interToneGap||null,"string"==typeof s)s=s.toUpperCase();else{if("number"!=typeof s)throw new TypeError("Invalid tone: "+s);s=s.toString()}if(!s.match(/^[0-9A-D#*]$/))throw new TypeError("Invalid tone: "+s);if(this.tone=s,n&&!e.Utils.isDecimal(n))throw new TypeError("Invalid tone duration: "+n);if(n?n<t.C.MIN_DURATION?(this.logger.warn('"duration" value is lower than the minimum allowed, setting it to '+t.C.MIN_DURATION+" milliseconds"),n=t.C.MIN_DURATION):n>t.C.MAX_DURATION?(this.logger.warn('"duration" value is greater than the maximum allowed, setting it to '+t.C.MAX_DURATION+" milliseconds"),n=t.C.MAX_DURATION):n=Math.abs(n):n=t.C.DEFAULT_DURATION,this.duration=n,o&&!e.Utils.isDecimal(o))throw new TypeError("Invalid interToneGap: "+o);o?o<t.C.MIN_INTER_TONE_GAP?(this.logger.warn('"interToneGap" value is lower than the minimum allowed, setting it to '+t.C.MIN_INTER_TONE_GAP+" milliseconds"),o=t.C.MIN_INTER_TONE_GAP):o=Math.abs(o):o=t.C.DEFAULT_INTER_TONE_GAP,this.interToneGap=o}).prototype=Object.create(e.EventEmitter.prototype),t.prototype.send=function(t){var i,s={};if(this.direction="outgoing",this.owner.status!==e.Session.C.STATUS_CONFIRMED&&this.owner.status!==e.Session.C.STATUS_WAITING_FOR_ACK)throw new e.Exceptions.InvalidStateError(this.owner.status);i=(t=t||{}).extraHeaders?t.extraHeaders.slice():[],s.contentType="application/dtmf-relay",s.body="Signal= "+this.tone+"\r\n",s.body+="Duration= "+this.duration,this.request=this.owner.dialog.sendRequest(this,e.C.INFO,{extraHeaders:i,body:s}),this.owner.emit("dtmf",this.request,this)},t.prototype.receiveResponse=function(t){var i;switch(!0){case/^1[0-9]{2}$/.test(t.status_code):break;case/^2[0-9]{2}$/.test(t.status_code):this.emit("succeeded",{originator:"remote",response:t});break;default:i=e.Utils.sipErrorCause(t.status_code),this.emit("failed",t,i)}},t.prototype.onRequestTimeout=function(){this.emit("failed",null,e.C.causes.REQUEST_TIMEOUT),this.owner.onRequestTimeout()},t.prototype.onTransportError=function(){this.emit("failed",null,e.C.causes.CONNECTION_ERROR),this.owner.onTransportError()},t.prototype.onDialogError=function(t){this.emit("failed",t,e.C.causes.DIALOG_ERROR),this.owner.onDialogError(t)},t.prototype.init_incoming=function(e){this.direction="incoming",this.request=e,e.reply(200),this.tone&&this.duration?this.owner.emit("dtmf",e,this):this.logger.warn("invalid INFO DTMF received, discarded")},t.C={MIN_DURATION:70,MAX_DURATION:6e3,DEFAULT_DURATION:100,MIN_INTER_TONE_GAP:50,DEFAULT_INTER_TONE_GAP:500},t}},function(e,t,i){"use strict";e.exports=function(e){e.Subscription=function(t,i,s,r){if(r=Object.create(r||Object.prototype),this.extraHeaders=r.extraHeaders=(r.extraHeaders||[]).slice(),this.id=null,this.state="init",!s)throw new TypeError("Event necessary to create a subscription.");this.event=s,"number"!=typeof r.expires?(t.logger.warn("expires must be a number. Using default of 3600."),this.expires=3600):this.expires=r.expires,this.requestedExpires=this.expires,r.extraHeaders.push("Event: "+this.event),r.extraHeaders.push("Expires: "+this.expires),r.body&&(this.body=r.body),this.contact=t.contact.toString(),r.extraHeaders.push("Contact: "+this.contact),r.extraHeaders.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),e.Utils.augment(this,e.ClientContext,[t,e.C.SUBSCRIBE,i,r]),this.logger=t.getLogger("sip.subscription"),this.dialog=null,this.timers={N:null,sub_duration:null},this.errorCodes=[404,405,410,416,480,481,482,483,484,485,489,501,604]},e.Subscription.prototype={subscribe:function(){return"active"===this.state?(this.refresh(),this):"notify_wait"===this.state?this:(e.Timers.clearTimeout(this.timers.sub_duration),e.Timers.clearTimeout(this.timers.N),this.timers.N=e.Timers.setTimeout(this.timer_fire.bind(this),e.Timers.TIMER_N),this.ua.earlySubscriptions[this.request.call_id+this.request.from.parameters.tag+this.event]=this,this.send(),this.state="notify_wait",this)},refresh:function(){"terminated"!==this.state&&"pending"!==this.state&&"notify_wait"!==this.state&&this.dialog.sendRequest(this,e.C.SUBSCRIBE,{extraHeaders:this.extraHeaders,body:this.body})},receiveResponse:function(t){var i,s=e.Utils.getReasonPhrase(t.status_code);"notify_wait"===this.state&&t.status_code>=300||"notify_wait"!==this.state&&-1!==this.errorCodes.indexOf(t.status_code)?this.failed(t,null):/^2[0-9]{2}$/.test(t.status_code)?(this.emit("accepted",t,s),(i=t.getHeader("Expires"))&&i<=this.requestedExpires?(this.expires=i,this.timers.sub_duration=e.Timers.setTimeout(this.refresh.bind(this),900*i)):i?(this.logger.warn("Expires header in a 200-class response to SUBSCRIBE with a higher value than the one in the request"),this.failed(t,e.C.INVALID_EXPIRES_HEADER)):(this.logger.warn("Expires header missing in a 200-class response to SUBSCRIBE"),this.failed(t,e.C.EXPIRES_HEADER_MISSING))):t.statusCode>300&&(this.emit("failed",t,s),this.emit("rejected",t,s))},unsubscribe:function(){var t=[];this.state="terminated",t.push("Event: "+this.event),t.push("Expires: 0"),t.push("Contact: "+this.contact),t.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),this.receiveResponse=function(){},this.dialog.sendRequest(this,this.method,{extraHeaders:t,body:this.body}),e.Timers.clearTimeout(this.timers.sub_duration),e.Timers.clearTimeout(this.timers.N),this.timers.N=e.Timers.setTimeout(this.timer_fire.bind(this),e.Timers.TIMER_N)},timer_fire:function(){"terminated"===this.state?(this.terminateDialog(),e.Timers.clearTimeout(this.timers.N),e.Timers.clearTimeout(this.timers.sub_duration),delete this.ua.subscriptions[this.id]):"notify_wait"===this.state||"pending"===this.state?this.close():this.refresh()},close:function(){"notify_wait"===this.state?(this.state="terminated",e.Timers.clearTimeout(this.timers.N),e.Timers.clearTimeout(this.timers.sub_duration),this.receiveResponse=function(){},delete this.ua.earlySubscriptions[this.request.call_id+this.request.from.parameters.tag+this.event]):"terminated"!==this.state&&this.unsubscribe()},createConfirmedDialog:function(t,i){var s;return this.terminateDialog(),(s=new e.Dialog(this,t,i)).invite_seqnum=this.request.cseq,s.local_seqnum=this.request.cseq,!s.error&&(this.dialog=s,!0)},terminateDialog:function(){this.dialog&&(delete this.ua.subscriptions[this.id],this.dialog.terminate(),delete this.dialog)},receiveRequest:function(t){var i,s=this;function r(){i.expires&&(e.Timers.clearTimeout(s.timers.sub_duration),i.expires=Math.min(s.expires,Math.max(i.expires,0)),s.timers.sub_duration=e.Timers.setTimeout(s.refresh.bind(s),900*i.expires))}if(this.matchEvent(t))if(this.dialog||this.createConfirmedDialog(t,"UAS")&&(this.id=this.dialog.id.toString(),delete this.ua.earlySubscriptions[this.request.call_id+this.request.from.parameters.tag+this.event],this.ua.subscriptions[this.id]=this),i=t.parseHeader("Subscription-State"),t.reply(200,e.C.REASON_200),e.Timers.clearTimeout(this.timers.N),this.emit("notify",{request:t}),"terminated"!==this.state)switch(i.state){case"active":this.state="active",r();break;case"pending":"notify_wait"===this.state&&r(),this.state="pending";break;case"terminated":if(e.Timers.clearTimeout(this.timers.sub_duration),i.reason)switch(this.logger.log("terminating subscription with reason "+i.reason),i.reason){case"deactivated":case"timeout":return void this.subscribe();case"probation":case"giveup":return void(i.params&&i.params["retry-after"]?this.timers.sub_duration=e.Timers.setTimeout(s.subscribe.bind(s),i.params["retry-after"]):this.subscribe())}this.close()}else"terminated"===i.state&&(this.terminateDialog(),e.Timers.clearTimeout(this.timers.N),e.Timers.clearTimeout(this.timers.sub_duration),delete this.ua.subscriptions[this.id]);else t.reply(489)},failed:function(e,t){return this.close(),this.emit("failed",e,t),this.emit("rejected",e,t),this},onDialogError:function(t){this.failed(t,e.C.causes.DIALOG_ERROR)},matchEvent:function(e){var t;return e.hasHeader("Event")?e.hasHeader("Subscription-State")?(t=e.parseHeader("event").event,this.event===t||(this.logger.warn("event match failed"),e.reply(481,"Event Match Failed"),!1)):(this.logger.warn("missing Subscription-State header"),!1):(this.logger.warn("missing Event header"),!1)}}}},function(e,t,i){"use strict";e.exports=function(e){var t;((t=function(t,i,s,r){if(this.options=r=r||{},this.options.extraHeaders=(r.extraHeaders||[]).slice(),this.options.contentType=r.contentType||"text/plain","number"!=typeof r.expires||r.expires%1!=0?this.options.expires=3600:this.options.expires=Number(r.expires),"boolean"!=typeof r.unpublishOnClose?this.options.unpublishOnClose=!0:this.options.unpublishOnClose=r.unpublishOnClose,void 0===i||null===i||""===i)throw new e.Exceptions.MethodParameterError("Publish","Target",i);if(this.target=t.normalizeTarget(i),void 0===s||null===s||""===s)throw new e.Exceptions.MethodParameterError("Publish","Event",s);this.event=s,e.ClientContext.call(this,t,e.C.PUBLISH,this.target,this.options),this.logger=this.ua.getLogger("sip.publish"),this.pubRequestBody=null,this.pubRequestExpires=this.options.expires,this.pubRequestEtag=null,this.publish_refresh_timer=null,t.on("transportCreated",function(e){e.on("transportError",this.onTransportError.bind(this))}.bind(this))}).prototype=Object.create(e.ClientContext.prototype)).constructor=t,t.prototype.publish=function(t){if(this.request=null,e.Timers.clearTimeout(this.publish_refresh_timer),void 0!==t&&null!==t&&""!==t)this.options.body=t,this.pubRequestBody=this.options.body,0===this.pubRequestExpires&&(this.pubRequestExpires=this.options.expires,this.pubRequestEtag=null),this.ua.publishers[this.target.toString()+":"+this.event]||(this.ua.publishers[this.target.toString()+":"+this.event]=this);else{if(this.pubRequestBody=null,null===this.pubRequestEtag)throw new e.Exceptions.MethodParameterError("Publish","Body",t);if(0===this.pubRequestExpires)throw new e.Exceptions.MethodParameterError("Publish","Expire",this.pubRequestExpires)}this.sendPublishRequest()},t.prototype.unpublish=function(){this.request=null,e.Timers.clearTimeout(this.publish_refresh_timer),this.pubRequestBody=null,this.pubRequestExpires=0,null!==this.pubRequestEtag&&this.sendPublishRequest()},t.prototype.close=function(){this.options.unpublishOnClose?this.unpublish():(this.request=null,e.Timers.clearTimeout(this.publish_refresh_timer),this.pubRequestBody=null,this.pubRequestExpires=0,this.pubRequestEtag=null),this.ua.publishers[this.target.toString()+":"+this.event]&&delete this.ua.publishers[this.target.toString()+":"+this.event]},t.prototype.sendPublishRequest=function(){var t;(t=Object.create(this.options||Object.prototype)).extraHeaders=(this.options.extraHeaders||[]).slice(),t.extraHeaders.push("Event: "+this.event),t.extraHeaders.push("Expires: "+this.pubRequestExpires),null!==this.pubRequestEtag&&t.extraHeaders.push("SIP-If-Match: "+this.pubRequestEtag),this.request=new e.OutgoingRequest(e.C.PUBLISH,this.target,this.ua,this.options.params,t.extraHeaders),null!==this.pubRequestBody&&(this.request.body={},this.request.body.body=this.pubRequestBody,this.request.body.contentType=this.options.contentType),this.send()},t.prototype.receiveResponse=function(t){var i,s,r=e.Utils.getReasonPhrase(t.status_code);switch(!0){case/^1[0-9]{2}$/.test(t.status_code):this.emit("progress",t,r);break;case/^2[0-9]{2}$/.test(t.status_code):t.hasHeader("SIP-ETag")?this.pubRequestEtag=t.getHeader("SIP-ETag"):this.logger.warn("SIP-ETag header missing in a 200-class response to PUBLISH"),t.hasHeader("Expires")?"number"==typeof(i=Number(t.getHeader("Expires")))&&i>=0&&i<=this.pubRequestExpires?this.pubRequestExpires=i:this.logger.warn("Bad Expires header in a 200-class response to PUBLISH"):this.logger.warn("Expires header missing in a 200-class response to PUBLISH"),0!==this.pubRequestExpires?(this.publish_refresh_timer=e.Timers.setTimeout(this.publish.bind(this),900*this.pubRequestExpires),this.emit("published",t,r)):this.emit("unpublished",t,r);break;case/^412$/.test(t.status_code):null!==this.pubRequestEtag&&0!==this.pubRequestExpires?(this.logger.warn("412 response to PUBLISH, recovering"),this.pubRequestEtag=null,this.emit("progress",t,r),this.publish(this.options.body)):(this.logger.warn("412 response to PUBLISH, recovery failed"),this.pubRequestExpires=0,this.emit("failed",t,r),this.emit("unpublished",t,r));break;case/^423$/.test(t.status_code):0!==this.pubRequestExpires&&t.hasHeader("Min-Expires")?"number"==typeof(s=Number(t.getHeader("Min-Expires")))||s>this.pubRequestExpires?(this.logger.warn("423 code in response to PUBLISH, adjusting the Expires value and trying to recover"),this.pubRequestExpires=s,this.emit("progress",t,r),this.publish(this.options.body)):(this.logger.warn("Bad 423 response Min-Expires header received for PUBLISH"),this.pubRequestExpires=0,this.emit("failed",t,r),this.emit("unpublished",t,r)):(this.logger.warn("423 response to PUBLISH, recovery failed"),this.pubRequestExpires=0,this.emit("failed",t,r),this.emit("unpublished",t,r));break;default:this.pubRequestExpires=0,this.emit("failed",t,r),this.emit("unpublished",t,r)}0===this.pubRequestExpires&&(e.Timers.clearTimeout(this.publish_refresh_timer),this.pubRequestBody=null,this.pubRequestEtag=null)},t.prototype.onRequestTimeout=function(){e.ClientContext.prototype.onRequestTimeout.call(this),this.emit("unpublished",null,e.C.causes.REQUEST_TIMEOUT)},t.prototype.onTransportError=function(){e.ClientContext.prototype.onTransportError.call(this),this.emit("unpublished",null,e.C.causes.CONNECTION_ERROR)},e.PublishContext=t}},function(e,t,i){"use strict";(function(t){var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};e.exports=function(e,r){var n,o={STATUS_INIT:0,STATUS_STARTING:1,STATUS_READY:2,STATUS_USER_CLOSED:3,STATUS_NOT_READY:4,CONFIGURATION_ERROR:1,NETWORK_ERROR:2,ALLOWED_METHODS:["ACK","CANCEL","INVITE","MESSAGE","BYE","OPTIONS","INFO","NOTIFY","REFER"],ACCEPTED_BODY_TYPES:["application/sdp","application/dtmf-relay"],MAX_FORWARDS:70,TAG_LENGTH:10};function a(t){if(t instanceof Function)return t.initialize||(t.initialize=function(){return e.Utils.Promise.resolve()}),t}((n=function(t){var i=this;function s(e){return i.emit.bind(i,e)}o.ACCEPTED_BODY_TYPES=o.ACCEPTED_BODY_TYPES.toString(),this.log=new e.LoggerFactory,this.logger=this.getLogger("sip.ua"),this.cache={credentials:{}},this.configuration={},this.dialogs={},this.applicants={},this.data={},this.sessions={},this.subscriptions={},this.earlySubscriptions={},this.publishers={},this.transport=null,this.contact=null,this.status=o.STATUS_INIT,this.error=null,this.transactions={nist:{},nict:{},ist:{},ict:{}},Object.defineProperties(this,{transactionsCount:{get:function(){var e,t=["nist","nict","ist","ict"],i=0;for(e in t)i+=Object.keys(this.transactions[t[e]]).length;return i}},nictTransactionsCount:{get:function(){return Object.keys(this.transactions.nict).length}},nistTransactionsCount:{get:function(){return Object.keys(this.transactions.nist).length}},ictTransactionsCount:{get:function(){return Object.keys(this.transactions.ict).length}},istTransactionsCount:{get:function(){return Object.keys(this.transactions.ist).length}}}),void 0===t?t={}:("string"==typeof t||t instanceof String)&&(t={uri:t}),t.log&&(t.log.hasOwnProperty("builtinEnabled")&&(this.log.builtinEnabled=t.log.builtinEnabled),t.log.hasOwnProperty("level")&&(this.log.level=t.log.level),t.log.hasOwnProperty("connector")&&(this.log.connector=t.log.connector));try{this.loadConfig(t)}catch(e){throw this.status=o.STATUS_NOT_READY,this.error=o.CONFIGURATION_ERROR,e}this.registerContext=new e.RegisterContext(this),this.registerContext.on("failed",s("registrationFailed")),this.registerContext.on("registered",s("registered")),this.registerContext.on("unregistered",s("unregistered")),this.configuration.autostart&&this.start()}).prototype=Object.create(e.EventEmitter.prototype)).register=function(e){return this.configuration.register=!0,this.registerContext.register(e),this},n.prototype.unregister=function(e){this.configuration.register=!1;var t=this.registerContext;return this.transport.afterConnected(t.unregister.bind(t,e)),this},n.prototype.isRegistered=function(){return this.registerContext.registered},n.prototype.invite=function(t,i,s){var r=new e.InviteClientContext(this,t,i,s);return this.transport.afterConnected(function(){r.invite(),this.emit("inviteSent",r)}.bind(this)),r},n.prototype.subscribe=function(t,i,s){var r=new e.Subscription(this,t,i,s);return this.transport.afterConnected(r.subscribe.bind(r)),r},n.prototype.publish=function(t,i,s,r){var n=new e.PublishContext(this,t,i,r);return this.transport.afterConnected(n.publish.bind(n,s)),n},n.prototype.message=function(t,i,s){if(void 0===i)throw new TypeError("Not enough arguments");return(s=Object.create(s||Object.prototype)).contentType||(s.contentType="text/plain"),s.body=i,this.request(e.C.MESSAGE,t,s)},n.prototype.request=function(t,i,s){var r=new e.ClientContext(this,t,i,s);return this.transport.afterConnected(r.send.bind(r)),r},n.prototype.stop=function(){var e,i,s,n,a=this;if(this.logger.log("user requested closure..."),this.status===o.STATUS_USER_CLOSED)return this.logger.warn("UA already closed"),this;for(e in this.logger.log("closing registerContext"),this.registerContext.close(),this.sessions)this.logger.log("closing session "+e),this.sessions[e].terminate();for(i in this.subscriptions)this.logger.log("unsubscribing from subscription "+i),this.subscriptions[i].close();for(i in this.earlySubscriptions)this.logger.log("unsubscribing from early subscription "+i),this.earlySubscriptions[i].close();for(n in this.publishers)this.logger.log("unpublish "+n),this.publishers[n].close();for(s in this.applicants)this.applicants[s].close();return this.status=o.STATUS_USER_CLOSED,0===this.nistTransactionsCount&&0===this.nictTransactionsCount?this.transport.disconnect():this.on("transactionDestroyed",function e(){0===a.nistTransactionsCount&&0===a.nictTransactionsCount&&(a.removeListener("transactionDestroyed",e),a.transport.disconnect())}),"function"==typeof r.removeEventListener&&(t.chrome&&t.chrome.app&&t.chrome.app.runtime||r.removeEventListener("unload",this.environListener)),this},n.prototype.start=function(){if(this.logger.log("user requested startup..."),this.status===o.STATUS_INIT){if(this.status=o.STATUS_STARTING,!this.configuration.transportConstructor)throw new e.Exceptions.TransportError("Transport constructor not set");this.transport=new this.configuration.transportConstructor(this.getLogger("sip.transport"),this.configuration.transportOptions),this.setTransportListeners(),this.emit("transportCreated",this.transport),this.transport.connect()}else this.status===o.STATUS_USER_CLOSED?(this.logger.log("resuming"),this.status=o.STATUS_READY,this.transport.connect()):this.status===o.STATUS_STARTING?this.logger.log("UA is in STARTING status, not opening new connection"):this.status===o.STATUS_READY?this.logger.log("UA is in READY status, not resuming"):this.logger.error("Connection is down. Auto-Recovery system is trying to connect");return this.configuration.autostop&&"function"==typeof r.addEventListener&&(t.chrome&&t.chrome.app&&t.chrome.app.runtime||(this.environListener=this.stop.bind(this),r.addEventListener("unload",this.environListener))),this},n.prototype.normalizeTarget=function(t){return e.Utils.normalizeTarget(t,this.configuration.hostportParams)},n.prototype.saveCredentials=function(e){return this.cache.credentials[e.realm]=this.cache.credentials[e.realm]||{},this.cache.credentials[e.realm][e.uri]=e,this},n.prototype.getCredentials=function(e){var t,i;return t=e.ruri.host,this.cache.credentials[t]&&this.cache.credentials[t][e.ruri]&&((i=this.cache.credentials[t][e.ruri]).method=e.method),i},n.prototype.getLogger=function(e,t){return this.log.getLogger(e,t)},n.prototype.onTransportError=function(){this.status!==o.STATUS_USER_CLOSED&&(this.error&&this.error===o.NETWORK_ERROR||(this.status=o.STATUS_NOT_READY,this.error=o.NETWORK_ERROR))},n.prototype.setTransportListeners=function(){this.transport.on("connected",this.onTransportConnected.bind(this)),this.transport.on("message",this.onTransportReceiveMsg.bind(this)),this.transport.on("transportError",this.onTransportError.bind(this))},n.prototype.onTransportConnected=function(){this.configuration.register&&this.configuration.authenticationFactory.initialize().then(function(){this.registerContext.onTransportConnected()}.bind(this))},n.prototype.onTransportReceiveMsg=function(t){var i;if(t=e.Parser.parseMessage(t,this),this.status===e.UA.C.STATUS_USER_CLOSED&&t instanceof e.IncomingRequest)this.logger.warn("UA received message when status = USER_CLOSED - aborting");else if(e.sanityCheck(t,this,this.transport))if(t instanceof e.IncomingRequest)t.transport=this.transport,this.receiveRequest(t);else if(t instanceof e.IncomingResponse)switch(t.method){case e.C.INVITE:(i=this.transactions.ict[t.via_branch])&&i.receiveResponse(t);break;case e.C.ACK:break;default:(i=this.transactions.nict[t.via_branch])&&i.receiveResponse(t)}},n.prototype.newTransaction=function(e){this.transactions[e.type][e.id]=e,this.emit("newTransaction",{transaction:e})},n.prototype.destroyTransaction=function(e){delete this.transactions[e.type][e.id],this.emit("transactionDestroyed",{transaction:e})},n.prototype.receiveRequest=function(t){var i,s,r,n,a,c,h=t.method;function u(e){return e&&e.user===t.ruri.user}if(!(u(this.configuration.uri)||u(this.contact.uri)||u(this.contact.pub_gruu)||u(this.contact.temp_gruu)))return this.logger.warn("Request-URI does not point to us"),void(t.method!==e.C.ACK&&t.reply_sl(404));if(t.ruri.scheme!==e.C.SIPS){if(!e.Transactions.checkTransaction(this,t))if(h===e.C.OPTIONS?(new e.Transactions.NonInviteServerTransaction(t,this),t.reply(200,null,["Allow: "+e.UA.C.ALLOWED_METHODS.toString(),"Accept: "+o.ACCEPTED_BODY_TYPES])):h===e.C.MESSAGE?((r=new e.ServerContext(this,t)).body=t.body,r.content_type=t.getHeader("Content-Type")||"text/plain",t.reply(200,null),this.emit("message",r)):h!==e.C.INVITE&&h!==e.C.ACK&&new e.ServerContext(this,t),t.to_tag)(i=this.findDialog(t))?(h===e.C.INVITE&&new e.Transactions.InviteServerTransaction(t,this),i.receiveRequest(t)):h===e.C.NOTIFY?(s=this.findSession(t),n=this.findEarlySubscription(t),s?s.receiveRequest(t):n?n.receiveRequest(t):(this.logger.warn("received NOTIFY request for a non existent session or subscription"),t.reply(481,"Subscription does not exist"))):h!==e.C.ACK&&t.reply(481);else switch(h){case e.C.INVITE:if(a=this.configuration.replaces!==e.C.supported.UNSUPPORTED&&t.parseHeader("replaces")){if(!(c=this.dialogs[a.call_id+a.replaces_to_tag+a.replaces_from_tag]))return void t.reply_sl(481,null);if(c.owner.status===e.Session.C.STATUS_TERMINATED)return void t.reply_sl(603,null);if(c.state===e.Dialog.C.STATUS_CONFIRMED&&a.early_only)return void t.reply_sl(486,null)}(s=new e.InviteServerContext(this,t)).replacee=c&&c.owner,this.emit("invite",s);break;case e.C.BYE:t.reply(481);break;case e.C.CANCEL:(s=this.findSession(t))?s.receiveRequest(t):this.logger.warn("received CANCEL request for a non existent session");break;case e.C.ACK:break;case e.C.NOTIFY:this.configuration.allowLegacyNotifications&&this.listeners("notify").length>0?(t.reply(200,null),this.emit("notify",{request:t})):t.reply(481,"Subscription does not exist");break;case e.C.REFER:if(this.logger.log("Received an out of dialog refer"),this.configuration.allowOutOfDialogRefers){this.logger.log("Allow out of dialog refers is enabled on the UA");var l=new e.ReferServerContext(this,t);this.listeners("outOfDialogReferRequested").length?this.emit("outOfDialogReferRequested",l):(this.logger.log("No outOfDialogReferRequest listeners, automatically accepting and following the out of dialog refer"),l.accept({followRefer:!0}));break}t.reply(405);break;default:t.reply(405)}}else t.reply_sl(416)},n.prototype.findSession=function(e){return this.sessions[e.call_id+e.from_tag]||this.sessions[e.call_id+e.to_tag]||null},n.prototype.findDialog=function(e){return this.dialogs[e.call_id+e.from_tag+e.to_tag]||this.dialogs[e.call_id+e.to_tag+e.from_tag]||null},n.prototype.findEarlySubscription=function(e){return this.earlySubscriptions[e.call_id+e.to_tag+e.getHeader("event")]||null},n.prototype.loadConfig=function(t){var s,r,n,o,c,h={viaHost:e.Utils.createRandomToken(12)+".invalid",uri:new e.URI("sip","anonymous."+e.Utils.createRandomToken(6),"anonymous.invalid",null,null),custom:{},displayName:"",password:null,registerExpires:600,register:!0,registrarServer:null,transportConstructor:i(29)(e),transportOptions:{},userAgentString:e.C.USER_AGENT,noAnswerTimeout:60,hackViaTcp:!1,hackIpInContact:!1,hackWssInTransport:!1,hackAllowUnregisteredOptionTags:!1,sessionDescriptionHandlerFactoryOptions:{constraints:{},peerConnectionOptions:{}},contactName:e.Utils.createRandomToken(8),contactTransport:"ws",forceRport:!1,autostart:!0,autostop:!0,rel100:e.C.supported.UNSUPPORTED,dtmfType:e.C.dtmfType.INFO,replaces:e.C.supported.UNSUPPORTED,sessionDescriptionHandlerFactory:i(30)(e).defaultFactory,authenticationFactory:a(function(t){return new e.DigestAuthentication(t)}),allowLegacyNotifications:!1,allowOutOfDialogRefers:!1};function u(e,i){var s=e.replace(/([a-z][A-Z])/g,function(e){return e[0]+"_"+e[1].toLowerCase()});if(e!==s){var r=t.hasOwnProperty(e);t.hasOwnProperty(s)&&(i.warn(s+" is deprecated, please use "+e),r&&i.warn(e+" overriding "+s)),t[e]=r?t[e]:t[s]}}var l=this.getConfigurationCheck();for(s in l.mandatory){if(u(s,this.logger),!t.hasOwnProperty(s))throw new e.Exceptions.ConfigurationError(s);if(r=t[s],void 0===(n=l.mandatory[s](r)))throw new e.Exceptions.ConfigurationError(s,r);h[s]=n}for(s in l.optional)if(u(s,this.logger),t.hasOwnProperty(s)){if((r=t[s])instanceof Array&&0===r.length)continue;if(null===r||""===r||void 0===r)continue;if("number"==typeof r&&isNaN(r))continue;if(void 0===(n=l.optional[s](r)))throw new e.Exceptions.ConfigurationError(s,r);h[s]=n}0===h.displayName&&(h.displayName="0"),h.instanceId||(h.instanceId=e.Utils.newUUID()),h.sipjsId=e.Utils.createRandomToken(5),(o=h.uri.clone()).user=null,h.hostportParams=o.toRaw().replace(/^sip:/i,""),h.authorizationUser||(h.authorizationUser=h.uri.user),h.registrarServer||((c=h.uri.clone()).user=null,h.registrarServer=c),h.noAnswerTimeout=1e3*h.noAnswerTimeout,h.hackIpInContact&&("boolean"==typeof h.hackIpInContact?h.viaHost=e.Utils.getRandomTestNetIP():"string"==typeof h.hackIpInContact&&(h.viaHost=h.hackIpInContact)),h.hackWssInTransport&&(h.contactTransport="wss"),this.contact={pub_gruu:null,temp_gruu:null,uri:new e.URI("sip",h.contactName,h.viaHost,null,{transport:h.contactTransport}),toString:function(e){var t=(e=e||{}).anonymous||null,i=e.outbound||null,s="<";return s+=t?(this.temp_gruu||"sip:anonymous@anonymous.invalid;transport="+h.contactTransport).toString():(this.pub_gruu||this.uri).toString(),i&&(s+=";ob"),s+=">"}};var d={};for(s in h)d[s]=h[s];for(s in Object.assign(this.configuration,d),this.logger.log("configuration parameters after validation:"),h)switch(s){case"uri":case"registrarServer":case"sessionDescriptionHandlerFactory":this.logger.log("\xb7 "+s+": "+h[s]);break;case"password":this.logger.log("\xb7 "+s+": NOT SHOWN");break;case"transportConstructor":this.logger.log("\xb7 "+s+": "+h[s].name);break;default:this.logger.log("\xb7 "+s+": "+JSON.stringify(h[s]))}},n.prototype.getConfigurationCheck=function(){return{mandatory:{},optional:{uri:function(t){var i;return/^sip:/i.test(t)||(t=e.C.SIP+":"+t),(i=e.URI.parse(t))&&i.user?i:void 0},transportConstructor:function(e){if(e instanceof Function)return e},transportOptions:function(e){if("object"===(void 0===e?"undefined":s(e)))return e},authorizationUser:function(t){return-1===e.Grammar.parse('"'+t+'"',"quoted_string")?void 0:t},displayName:function(t){return-1===e.Grammar.parse('"'+t+'"',"displayName")?void 0:t},dtmfType:function(t){switch(t){case e.C.dtmfType.RTP:return e.C.dtmfType.RTP;case e.C.dtmfType.INFO:default:return e.C.dtmfType.INFO}},hackViaTcp:function(e){if("boolean"==typeof e)return e},hackIpInContact:function(t){return"boolean"==typeof t?t:"string"==typeof t&&-1!==e.Grammar.parse(t,"host")?t:void 0},hackWssInTransport:function(e){if("boolean"==typeof e)return e},hackAllowUnregisteredOptionTags:function(e){if("boolean"==typeof e)return e},contactTransport:function(e){if("string"==typeof e)return e},forceRport:function(e){if("boolean"==typeof e)return e},instanceId:function(t){if("string"==typeof t)return/^uuid:/i.test(t)&&(t=t.substr(5)),-1===e.Grammar.parse(t,"uuid")?void 0:t},noAnswerTimeout:function(t){var i;if(e.Utils.isDecimal(t)&&(i=Number(t))>0)return i},password:function(e){return String(e)},rel100:function(t){return t===e.C.supported.REQUIRED?e.C.supported.REQUIRED:t===e.C.supported.SUPPORTED?e.C.supported.SUPPORTED:e.C.supported.UNSUPPORTED},replaces:function(t){return t===e.C.supported.REQUIRED?e.C.supported.REQUIRED:t===e.C.supported.SUPPORTED?e.C.supported.SUPPORTED:e.C.supported.UNSUPPORTED},register:function(e){if("boolean"==typeof e)return e},registerExpires:function(t){var i;if(e.Utils.isDecimal(t)&&(i=Number(t))>0)return i},registrarServer:function(t){var i;if("string"==typeof t)return/^sip:/i.test(t)||(t=e.C.SIP+":"+t),(i=e.URI.parse(t))?i.user?void 0:i:void 0},userAgentString:function(e){if("string"==typeof e)return e},autostart:function(e){if("boolean"==typeof e)return e},autostop:function(e){if("boolean"==typeof e)return e},sessionDescriptionHandlerFactory:function(e){if(e instanceof Function)return e},sessionDescriptionHandlerFactoryOptions:function(e){if("object"===(void 0===e?"undefined":s(e)))return e},authenticationFactory:a,allowLegacyNotifications:function(e){if("boolean"==typeof e)return e},custom:function(e){if("object"===(void 0===e?"undefined":s(e)))return e},contactName:function(e){if("string"==typeof e)return e}}}},n.C=o,e.UA=n}}).call(this,i(0))},function(e,t,i){"use strict";(function(t){e.exports=function(e){var i,s={STATUS_CONNECTING:0,STATUS_OPEN:1,STATUS_CLOSING:2,STATUS_CLOSED:3},r=(t.window||t).WebSocket;return(i=function(t,i){i=e.Utils.defaultOptions({},i),this.logger=t,this.ws=null,this.server=null,this.connectionPromise=null,this.connectDeferredResolve=null,this.connectionTimeout=null,this.disconnectionPromise=null,this.disconnectDeferredResolve=null,this.boundOnOpen=null,this.boundOnMessage=null,this.boundOnClose=null,this.reconnectionAttempts=0,this.reconnectTimer=null,this.keepAliveInterval=null,this.keepAliveDebounceTimeout=null,this.status=s.STATUS_CONNECTING,this.configuration={},this.loadConfig(i)}).prototype=Object.create(e.Transport.prototype,{isConnected:{writable:!0,value:function(){return this.status===s.STATUS_OPEN}},sendPromise:{writable:!0,value:function(t,i){if(i=i||{},!this.statusAssert(s.STATUS_OPEN,i.force))return this.onError("unable to send message - WebSocket not open"),e.Utils.Promise.reject();var r=t.toString();return this.ws?(!0===this.configuration.traceSip&&this.logger.log("sending WebSocket message:\n\n"+r+"\n"),this.ws.send(r),e.Utils.Promise.resolve({msg:r})):(this.onError("unable to send message - WebSocket does not exist"),e.Utils.Promise.reject())}},disconnectPromise:{writable:!0,value:function(t){return this.disconnectionPromise?this.disconnectionPromise:(t=t||{},this.statusTransition(s.STATUS_CLOSING,t.force)?(this.disconnectionPromise=new e.Utils.Promise(function(i,s){this.disconnectDeferredResolve=i,this.reconnectTimer&&(e.Timers.clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.ws?(this.stopSendingKeepAlives(),this.logger.log("closing WebSocket "+this.server.ws_uri),this.ws.close(t.code,t.reason)):s("Attempted to disconnect but the websocket doesn't exist")}.bind(this)),this.disconnectionPromise):e.Utils.Promise.reject("Failed status transition - attempted to disconnect a socket that was not open"))}},connectPromise:{writable:!0,value:function(t){return this.connectionPromise?this.connectionPromise:(t=t||{},this.server=this.server||this.getNextWsServer(t.force),this.connectionPromise=new e.Utils.Promise(function(i,n){if((this.status===s.STATUS_OPEN||this.status===s.STATUS_CLOSING)&&!t.force)return this.logger.warn("WebSocket "+this.server.ws_uri+" is already connected"),void n("Failed status check - attempted to open a connection but already open/closing");this.connectDeferredResolve=i,this.status=s.STATUS_CONNECTING,this.logger.log("connecting to WebSocket "+this.server.ws_uri),this.disposeWs();try{this.ws=new r(this.server.ws_uri,"sip")}catch(e){return this.ws=null,this.status=s.STATUS_CLOSED,this.onError("error connecting to WebSocket "+this.server.ws_uri+":"+e),void n("Failed to create a websocket")}this.ws?(this.connectionTimeout=e.Timers.setTimeout(function(){this.onError("took too long to connect - exceeded time set in configuration.connectionTimeout: "+this.configuration.connectionTimeout+"s")}.bind(this),1e3*this.configuration.connectionTimeout),this.boundOnOpen=this.onOpen.bind(this),this.boundOnMessage=this.onMessage.bind(this),this.boundOnClose=this.onClose.bind(this),this.ws.addEventListener("open",this.boundOnOpen),this.ws.addEventListener("message",this.boundOnMessage),this.ws.addEventListener("close",this.boundOnClose)):n("Unexpected instance websocket not set")}.bind(this)),this.connectionPromise)}},onOpen:{writable:!0,value:function(){this.status=s.STATUS_OPEN,this.emit("connected"),e.Timers.clearTimeout(this.connectionTimeout),this.logger.log("WebSocket "+this.server.ws_uri+" connected"),null!==this.reconnectTimer&&(e.Timers.clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.reconnectionAttempts=0,this.disconnectionPromise=null,this.disconnectDeferredResolve=null,this.startSendingKeepAlives(),this.connectDeferredResolve?this.connectDeferredResolve({overrideEvent:!0}):this.logger.warn("Unexpected websocket.onOpen with no connectDeferredResolve")}},onClose:{writable:!0,value:function(t){if(this.logger.log("WebSocket disconnected (code: "+t.code+(t.reason?"| reason: "+t.reason:"")+")"),this.emit("disconnected",{code:t.code,reason:t.reason}),this.status!==s.STATUS_CLOSING&&(this.logger.warn("WebSocket abrupt disconnection"),this.emit("transportError")),this.stopSendingKeepAlives(),e.Timers.clearTimeout(this.connectionTimeout),this.connectionTimeout=null,this.connectionPromise=null,this.connectDeferredResolve=null,this.disconnectDeferredResolve)return this.disconnectDeferredResolve({overrideEvent:!0}),this.statusTransition(s.STATUS_CLOSED),void(this.disconnectDeferredResolve=null);this.status=s.STATUS_CLOSED,this.reconnect()}},disposeWs:{writable:!0,value:function(){this.ws&&(this.ws.removeEventListener("open",this.boundOnOpen),this.ws.removeEventListener("message",this.boundOnMessage),this.ws.removeEventListener("close",this.boundOnClose),this.boundOnOpen=null,this.boundOnMessage=null,this.boundOnClose=null,this.ws=null)}},onMessage:{writable:!0,value:function(e){var t=e.data;if("\r\n"===t)return this.clearKeepAliveTimeout(),void(!0===this.configuration.traceSip&&this.logger.log("received WebSocket message with CRLF Keep Alive response"));if(t){if("string"!=typeof t){try{t=String.fromCharCode.apply(null,new Uint8Array(t))}catch(e){return void this.logger.warn("received WebSocket binary message failed to be converted into string, message discarded")}!0===this.configuration.traceSip&&this.logger.log("received WebSocket binary message:\n\n"+t+"\n")}else!0===this.configuration.traceSip&&this.logger.log("received WebSocket text message:\n\n"+t+"\n");this.emit("message",t)}else this.logger.warn("received empty message, message discarded")}},onError:{writable:!0,value:function(e){this.logger.warn("Transport error: "+e),this.emit("transportError")}},reconnect:{writable:!0,value:function(){if(this.reconnectionAttempts>0&&this.logger.log("Reconnection attempt "+this.reconnectionAttempts+" failed"),this.noAvailableServers())return this.logger.warn("no available ws servers left - going to closed state"),this.status=s.STATUS_CLOSED,void this.resetServerErrorStatus();this.isConnected()&&(this.logger.warn("attempted to reconnect while connected - forcing disconnect"),this.disconnect({force:!0})),this.reconnectionAttempts+=1,this.reconnectionAttempts>this.configuration.maxReconnectionAttempts?(this.logger.warn("maximum reconnection attempts for WebSocket "+this.server.ws_uri),this.logger.log("transport "+this.server.ws_uri+" failed | connection state set to 'error'"),this.server.isError=!0,this.emit("transportError"),this.server=this.getNextWsServer(),this.reconnectionAttempts=0,this.reconnect()):(this.logger.log("trying to reconnect to WebSocket "+this.server.ws_uri+" (reconnection attempt "+this.reconnectionAttempts+")"),this.reconnectTimer=e.Timers.setTimeout(function(){this.connect(),this.reconnectTimer=null}.bind(this),1===this.reconnectionAttempts?0:1e3*this.configuration.reconnectionTimeout))}},resetServerErrorStatus:{writable:!0,value:function(){var e,t=this.configuration.wsServers.length;for(e=0;e<t;e++)this.configuration.wsServers[e].isError=!1}},getNextWsServer:{writable:!0,value:function(e){if(!this.noAvailableServers()){var t,i,s,r=[];for(i=this.configuration.wsServers.length,t=0;t<i;t++)(s=this.configuration.wsServers[t]).isError&&!e||(0===r.length?r.push(s):s.weight>r[0].weight?r=[s]:s.weight===r[0].weight&&r.push(s));return r[t=Math.floor(Math.random()*r.length)]}this.logger.warn("attempted to get next ws server but there are no available ws servers left")}},noAvailableServers:{writable:!0,value:function(){var e;for(e in this.configuration.wsServers)if(!this.configuration.wsServers[e].isError)return!1;return!0}},sendKeepAlive:{writable:!0,value:function(){if(!this.keepAliveDebounceTimeout)return this.keepAliveDebounceTimeout=e.Timers.setTimeout(function(){this.emit("keepAliveDebounceTimeout"),this.clearKeepAliveTimeout()}.bind(this),1e3*this.configuration.keepAliveDebounce),this.send("\r\n\r\n")}},clearKeepAliveTimeout:{writable:!0,value:function(){e.Timers.clearTimeout(this.keepAliveDebounceTimeout),this.keepAliveDebounceTimeout=null}},startSendingKeepAlives:{writable:!0,value:function(){this.configuration.keepAliveInterval&&!this.keepAliveInterval&&(this.keepAliveInterval=e.Timers.setInterval(function(){this.sendKeepAlive(),this.startSendingKeepAlives()}.bind(this),function(e){var t=.8*e;return 1e3*(Math.random()*(e-t)+t)}(this.configuration.keepAliveInterval)))}},stopSendingKeepAlives:{writable:!0,value:function(){e.Timers.clearInterval(this.keepAliveInterval),e.Timers.clearTimeout(this.keepAliveDebounceTimeout),this.keepAliveInterval=null,this.keepAliveDebounceTimeout=null}},statusAssert:{writable:!0,value:function(e,t){return e===this.status||(t?(this.logger.warn("Attempted to assert "+Object.keys(s)[this.status]+" as "+Object.keys(s)[e]+"- continuing with option: 'force'"),!0):(this.logger.warn("Tried to assert "+Object.keys(s)[e]+" but is currently "+Object.keys(s)[this.status]),!1))}},statusTransition:{writable:!0,value:function(e,t){return this.logger.log("Attempting to transition status from "+Object.keys(s)[this.status]+" to "+Object.keys(s)[e]),e===s.STATUS_OPEN&&this.statusAssert(s.STATUS_CONNECTING,t)||e===s.STATUS_CLOSING&&this.statusAssert(s.STATUS_OPEN,t)||e===s.STATUS_CLOSED&&this.statusAssert(s.STATUS_CLOSING,t)?(this.status=e,!0):(this.logger.warn("Status transition failed - result: no-op - reason: either gave an nonexistent status or attempted illegal transition"),!1)}},loadConfig:{writable:!0,value:function(t){var i,s,r,n={wsServers:[{scheme:"WSS",sip_uri:"<sip:edge.sip.onsip.com;transport=ws;lr>",weight:0,ws_uri:"wss://edge.sip.onsip.com",isError:!1}],connectionTimeout:5,maxReconnectionAttempts:3,reconnectionTimeout:4,keepAliveInterval:0,keepAliveDebounce:10,traceSip:!1};function o(e,i){var s=e.replace(/([a-z][A-Z])/g,function(e){return e[0]+"_"+e[1].toLowerCase()});if(e!==s){var r=t.hasOwnProperty(e);t.hasOwnProperty(s)&&(i.warn(s+" is deprecated, please use "+e),r&&i.warn(e+" overriding "+s)),t[e]=r?t[e]:t[s]}}var a=this.getConfigurationCheck();for(i in a.mandatory){if(o(i,this.logger),!t.hasOwnProperty(i))throw new e.Exceptions.ConfigurationError(i);if(s=t[i],void 0===(r=a.mandatory[i](s)))throw new e.Exceptions.ConfigurationError(i,s);n[i]=r}for(i in a.optional)if(o(i,this.logger),t.hasOwnProperty(i)){if((s=t[i])instanceof Array&&0===s.length)continue;if(null===s||""===s||void 0===s)continue;if("number"==typeof s&&isNaN(s))continue;if(void 0===(r=a.optional[i](s)))throw new e.Exceptions.ConfigurationError(i,s);n[i]=r}var c={};for(i in n)c[i]={value:n[i]};for(i in Object.defineProperties(this.configuration,c),this.logger.log("configuration parameters after validation:"),n)this.logger.log("\xb7 "+i+": "+JSON.stringify(n[i]))}},getConfigurationCheck:{writable:!0,value:function(){return{mandatory:{},optional:{wsServers:function(t){var i,s,r;if("string"==typeof t)t=[{ws_uri:t}];else{if(!(t instanceof Array))return;for(s=t.length,i=0;i<s;i++)"string"==typeof t[i]&&(t[i]={ws_uri:t[i]})}if(0===t.length)return!1;for(s=t.length,i=0;i<s;i++){if(!t[i].ws_uri)return;if(t[i].weight&&!Number(t[i].weight))return;if(-1===(r=e.Grammar.parse(t[i].ws_uri,"absoluteURI")))return;if(["wss","ws","udp"].indexOf(r.scheme)<0)return;t[i].sip_uri="<sip:"+r.host+(r.port?":"+r.port:"")+";transport="+r.scheme.replace(/^wss$/i,"ws")+";lr>",t[i].weight||(t[i].weight=0),t[i].isError=!1,t[i].scheme=r.scheme.toUpperCase()}return t},keepAliveInterval:function(t){var i;if(e.Utils.isDecimal(t)&&(i=Number(t))>0)return i},keepAliveDebounce:function(t){var i;if(e.Utils.isDecimal(t)&&(i=Number(t))>0)return i},traceSip:function(e){if("boolean"==typeof e)return e},connectionTimeout:function(t){var i;if(e.Utils.isDecimal(t)&&(i=Number(t))>0)return i},maxReconnectionAttempts:function(t){var i;if(e.Utils.isDecimal(t)&&(i=Number(t))>=0)return i},reconnectionTimeout:function(t){var i;if(e.Utils.isDecimal(t)&&(i=Number(t))>0)return i}}}}}}),i.C=s,e.Web.Transport=i,i}}).call(this,i(0))},function(e,t,i){"use strict";(function(t){e.exports=function(e){var s=function(e,i,s){this.options=s||{},this.logger=e,this.observer=i,this.dtmfSender=null,this.shouldAcquireMedia=!0,this.CONTENT_TYPE="application/sdp",this.C={},this.C.DIRECTION={NULL:null,SENDRECV:"sendrecv",SENDONLY:"sendonly",RECVONLY:"recvonly",INACTIVE:"inactive"},this.logger.log("SessionDescriptionHandlerOptions: "+JSON.stringify(this.options)),this.direction=this.C.DIRECTION.NULL,this.modifiers=this.options.modifiers||[],Array.isArray(this.modifiers)||(this.modifiers=[this.modifiers]);var r=t.window||t;this.WebRTC={MediaStream:r.MediaStream,getUserMedia:r.navigator.mediaDevices.getUserMedia.bind(r.navigator.mediaDevices),RTCPeerConnection:r.RTCPeerConnection},this.iceGatheringDeferred=null,this.iceGatheringTimeout=!1,this.iceGatheringTimer=null,this.initPeerConnection(this.options.peerConnectionOptions),this.constraints=this.checkAndDefaultConstraints(this.options.constraints)};return s.defaultFactory=function(e,t){var r=e.ua.getLogger("sip.invitecontext.sessionDescriptionHandler",e.id),n=new(i(31))(e,t);return new s(r,n,t)},s.prototype=Object.create(e.SessionDescriptionHandler.prototype,{close:{writable:!0,value:function(){this.logger.log("closing PeerConnection"),this.peerConnection&&"closed"!==this.peerConnection.signalingState&&(this.peerConnection.getSenders?this.peerConnection.getSenders().forEach(function(e){e.track&&e.track.stop()}):(this.logger.warn("Using getLocalStreams which is deprecated"),this.peerConnection.getLocalStreams().forEach(function(e){e.getTracks().forEach(function(e){e.stop()})})),this.peerConnection.getReceivers?this.peerConnection.getReceivers().forEach(function(e){e.track&&e.track.stop()}):(this.logger.warn("Using getRemoteStreams which is deprecated"),this.peerConnection.getRemoteStreams().forEach(function(e){e.getTracks().forEach(function(e){e.stop()})})),this.resetIceGatheringComplete(),this.peerConnection.close())}},getDescription:{writable:!0,value:function(t,i){(t=t||{}).peerConnectionOptions&&this.initPeerConnection(t.peerConnectionOptions);var s=Object.assign({},this.constraints,t.constraints);return s=this.checkAndDefaultConstraints(s),JSON.stringify(s)!==JSON.stringify(this.constraints)&&(this.constraints=s,this.shouldAcquireMedia=!0),i=i||[],Array.isArray(i)||(i=[i]),i=i.concat(this.modifiers),e.Utils.Promise.resolve().then(function(){if(this.shouldAcquireMedia)return this.acquire(this.constraints).then(function(){this.shouldAcquireMedia=!1}.bind(this))}.bind(this)).then(function(){return this.createOfferOrAnswer(t.RTCOfferOptions,i)}.bind(this)).then(function(e){return this.emit("getDescription",e),{body:e.sdp,contentType:this.CONTENT_TYPE}}.bind(this))}},hasDescription:{writable:!0,value:function(e){return e===this.CONTENT_TYPE}},holdModifier:{writable:!0,value:function(t){return/a=(sendrecv|sendonly|recvonly|inactive)/.test(t.sdp)?(t.sdp=t.sdp.replace(/a=sendrecv\r\n/g,"a=sendonly\r\n"),t.sdp=t.sdp.replace(/a=recvonly\r\n/g,"a=inactive\r\n")):t.sdp=t.sdp.replace(/(m=[^\r]*\r\n)/g,"$1a=sendonly\r\n"),e.Utils.Promise.resolve(t)}},setDescription:{writable:!0,value:function(t,i,s){var r=this;(i=i||{}).peerConnectionOptions&&this.initPeerConnection(i.peerConnectionOptions),s=s||[],Array.isArray(s)||(s=[s]),s=s.concat(this.modifiers);var n={type:this.hasOffer("local")?"answer":"offer",sdp:t};return e.Utils.Promise.resolve().then(function(){if(this.shouldAcquireMedia&&this.options.alwaysAcquireMediaFirst)return this.acquire(this.constraints).then(function(){this.shouldAcquireMedia=!1}.bind(this))}.bind(this)).then(function(){return e.Utils.reducePromises(s,n)}).catch(function(e){throw r.logger.error("The modifiers did not resolve successfully"),r.logger.error(e),e}).then(function(e){return r.emit("setDescription",e),r.peerConnection.setRemoteDescription(e)}).catch(function(e){throw r.logger.error(e),r.emit("peerConnection-setRemoteDescriptionFailed",e),e}).then(function(){r.peerConnection.getReceivers?r.emit("setRemoteDescription",r.peerConnection.getReceivers()):r.emit("setRemoteDescription",r.peerConnection.getRemoteStreams()),r.emit("confirmed",r)})}},sendDtmf:{writable:!0,value:function(e,t){if(!this.dtmfSender&&this.hasBrowserGetSenderSupport()){var i=this.peerConnection.getSenders();i.length>0&&(this.dtmfSender=i[0].dtmf)}if(!this.dtmfSender&&this.hasBrowserTrackSupport()){var s=this.peerConnection.getLocalStreams();if(s.length>0){var r=s[0].getAudioTracks();r.length>0&&(this.dtmfSender=this.peerConnection.createDTMFSender(r[0]))}}if(!this.dtmfSender)return!1;try{this.dtmfSender.insertDTMF(e,t.duration,t.interToneGap)}catch(e){if("InvalidStateError"===e.type||"InvalidCharacterError"===e.type)return this.logger.error(e),!1;throw e}return this.logger.log("DTMF sent via RTP: "+e.toString()),!0}},getDirection:{writable:!0,value:function(){return this.direction}},createOfferOrAnswer:{writable:!0,value:function(t,i){var s,r=this,n=this.peerConnection;return t=t||{},s=r.hasOffer("remote")?"createAnswer":"createOffer",n[s](t).catch(function(e){throw r.emit("peerConnection-"+s+"Failed",e),e}).then(function(t){return e.Utils.reducePromises(i,r.createRTCSessionDescriptionInit(t))}).then(function(e){return r.resetIceGatheringComplete(),n.setLocalDescription(e)}).catch(function(e){throw r.emit("peerConnection-SetLocalDescriptionFailed",e),e}).then(function(){return r.waitForIceGatheringComplete()}).then(function(){var t=r.createRTCSessionDescriptionInit(r.peerConnection.localDescription);return e.Utils.reducePromises(i,t)}).then(function(e){return r.setDirection(e.sdp),e}).catch(function(t){throw r.logger.error(t),new e.Exceptions.GetDescriptionError(t)})}},createRTCSessionDescriptionInit:{writable:!0,value:function(e){return{type:e.type,sdp:e.sdp}}},addDefaultIceCheckingTimeout:{writable:!0,value:function(e){return void 0===e.iceCheckingTimeout&&(e.iceCheckingTimeout=5e3),e}},addDefaultIceServers:{writable:!0,value:function(e){return e.iceServers||(e.iceServers=[{urls:"stun:stun.l.google.com:19302"}]),e}},checkAndDefaultConstraints:{writable:!0,value:function(e){var t={audio:!0,video:!this.options.alwaysAcquireMediaFirst};return e=e||t,0===Object.keys(e).length&&e.constructor===Object?t:e}},hasBrowserTrackSupport:{writable:!0,value:function(){return Boolean(this.peerConnection.addTrack)}},hasBrowserGetSenderSupport:{writable:!0,value:function(){return Boolean(this.peerConnection.getSenders)}},initPeerConnection:{writable:!0,value:function(t){var i=this;t=t||{},(t=this.addDefaultIceCheckingTimeout(t)).rtcConfiguration=t.rtcConfiguration||{},t.rtcConfiguration=this.addDefaultIceServers(t.rtcConfiguration),this.logger.log("initPeerConnection"),this.peerConnection&&(this.logger.log("Already have a peer connection for this session. Tearing down."),this.resetIceGatheringComplete(),this.peerConnection.close()),this.peerConnection=new this.WebRTC.RTCPeerConnection(t.rtcConfiguration),this.logger.log("New peer connection created"),"ontrack"in this.peerConnection?this.peerConnection.addEventListener("track",function(e){i.logger.log("track added"),i.observer.trackAdded(),i.emit("addTrack",e)}):(this.logger.warn("Using onaddstream which is deprecated"),this.peerConnection.onaddstream=function(e){i.logger.log("stream added"),i.emit("addStream",e)}),this.peerConnection.onicecandidate=function(e){i.emit("iceCandidate",e),e.candidate&&i.logger.log("ICE candidate received: "+(null===e.candidate.candidate?null:e.candidate.candidate.trim()))},this.peerConnection.onicegatheringstatechange=function(){switch(i.logger.log("RTCIceGatheringState changed: "+this.iceGatheringState),this.iceGatheringState){case"gathering":i.emit("iceGathering",this),!i.iceGatheringTimer&&t.iceCheckingTimeout&&(i.iceGatheringTimeout=!1,i.iceGatheringTimer=e.Timers.setTimeout(function(){i.logger.log("RTCIceChecking Timeout Triggered after "+t.iceCheckingTimeout+" milliseconds"),i.iceGatheringTimeout=!0,i.triggerIceGatheringComplete()},t.iceCheckingTimeout));break;case"complete":i.triggerIceGatheringComplete()}},this.peerConnection.oniceconnectionstatechange=function(){var e;switch(this.iceConnectionState){case"new":e="iceConnection";break;case"checking":e="iceConnectionChecking";break;case"connected":e="iceConnectionConnected";break;case"completed":e="iceConnectionCompleted";break;case"failed":e="iceConnectionFailed";break;case"disconnected":e="iceConnectionDisconnected";break;case"closed":e="iceConnectionClosed";break;default:return void i.logger.warn("Unknown iceConnection state:",this.iceConnectionState)}i.emit(e,this)}}},acquire:{writable:!0,value:function(t){return t=this.checkAndDefaultConstraints(t),new e.Utils.Promise(function(e,i){this.logger.log("acquiring local media"),this.emit("userMediaRequest",t),t.audio||t.video?this.WebRTC.getUserMedia(t).then(function(t){this.observer.trackAdded(),this.emit("userMedia",t),e(t)}.bind(this)).catch(function(e){this.emit("userMediaFailed",e),i(e)}.bind(this)):e([])}.bind(this)).catch(function(t){return this.logger.error("unable to acquire streams"),this.logger.error(t),e.Utils.Promise.reject(t)}.bind(this)).then(function(t){this.logger.log("acquired local media streams");try{return this.peerConnection.removeTrack&&this.peerConnection.getSenders().forEach(function(e){this.peerConnection.removeTrack(e)},this),t}catch(t){return e.Utils.Promise.reject(t)}}.bind(this)).catch(function(t){return this.logger.error("error removing streams"),this.logger.error(t),e.Utils.Promise.reject(t)}.bind(this)).then(function(t){try{(t=[].concat(t)).forEach(function(e){this.peerConnection.addTrack?e.getTracks().forEach(function(t){this.peerConnection.addTrack(t,e)},this):this.peerConnection.addStream(e)},this)}catch(t){return e.Utils.Promise.reject(t)}return e.Utils.Promise.resolve()}.bind(this)).catch(function(t){return this.logger.error("error adding stream"),this.logger.error(t),e.Utils.Promise.reject(t)}.bind(this))}},hasOffer:{writable:!0,value:function(e){var t="have-"+e+"-offer";return this.peerConnection.signalingState===t}},isIceGatheringComplete:{writable:!0,value:function(){return"complete"===this.peerConnection.iceGatheringState||this.iceGatheringTimeout}},resetIceGatheringComplete:{writable:!0,value:function(){this.iceGatheringTimeout=!1,this.iceGatheringTimer&&(e.Timers.clearTimeout(this.iceGatheringTimer),this.iceGatheringTimer=null),this.iceGatheringDeferred&&(this.iceGatheringDeferred.reject(),this.iceGatheringDeferred=null)}},setDirection:{writable:!0,value:function(e){var t=e.match(/a=(sendrecv|sendonly|recvonly|inactive)/);if(null===t)return this.direction=this.C.DIRECTION.NULL,void this.observer.directionChanged();var i=t[1];switch(i){case this.C.DIRECTION.SENDRECV:case this.C.DIRECTION.SENDONLY:case this.C.DIRECTION.RECVONLY:case this.C.DIRECTION.INACTIVE:this.direction=i;break;default:this.direction=this.C.DIRECTION.NULL}this.observer.directionChanged()}},triggerIceGatheringComplete:{writable:!0,value:function(){this.isIceGatheringComplete()&&(this.emit("iceGatheringComplete",this),this.iceGatheringTimer&&(e.Timers.clearTimeout(this.iceGatheringTimer),this.iceGatheringTimer=null),this.iceGatheringDeferred&&(this.iceGatheringDeferred.resolve(),this.iceGatheringDeferred=null))}},waitForIceGatheringComplete:{writable:!0,value:function(){return this.isIceGatheringComplete()?e.Utils.Promise.resolve():(this.isIceGatheringDeferred||(this.iceGatheringDeferred=e.Utils.defer()),this.iceGatheringDeferred.promise)}}}),s}}).call(this,i(0))},function(e,t,i){"use strict";var s=function(e,t){this.session=e||{},this.options=t||{}};s.prototype={trackAdded:function(){this.session.emit("trackAdded")},directionChanged:function(){this.session.emit("directionChanged")}},e.exports=s},function(e,t,i){"use strict";e.exports=function(e){var t,i=[],s=[],r=[];function n(t,i,s){for(var r,n=e.Utils.buildStatusLine(t),o=i.getHeaders("via"),a=o.length,c=0;c<a;c++)n+="Via: "+o[c]+"\r\n";r=i.getHeader("To"),i.to_tag||(r+=";tag="+e.Utils.newTag()),n+="To: "+r+"\r\n",n+="From: "+i.getHeader("From")+"\r\n",n+="Call-ID: "+i.call_id+"\r\n",n+="CSeq: "+i.cseq+" "+i.method+"\r\n",n+="\r\n",s.send(n)}i.push(function(e,t,i){if(!e.ruri||"sip"!==e.ruri.scheme)return n(416,e,i),!1}),i.push(function(e,t,i){if(!e.to_tag&&e.call_id.substr(0,5)===t.configuration.sipjsId)return n(482,e,i),!1}),i.push(function(t,i,s){if(e.Utils.str_utf8_length(t.body)<t.getHeader("content-length"))return n(400,t,s),!1}),i.push(function(t,i,s){var r,o,a=t.from_tag,c=t.call_id,h=t.cseq;if(!t.to_tag)if(t.method===e.C.INVITE){if(r=i.transactions.ist[t.via_branch])return;for(o in i.transactions.ist)if((r=i.transactions.ist[o]).request.from_tag===a&&r.request.call_id===c&&r.request.cseq===h)return n(482,t,s),!1}else{if(r=i.transactions.nist[t.via_branch])return;for(o in i.transactions.nist)if((r=i.transactions.nist[o]).request.from_tag===a&&r.request.call_id===c&&r.request.cseq===h)return n(482,t,s),!1}}),s.push(function(e,t){if(e.getHeaders("via").length>1)return t.getLogger("sip.sanitycheck").warn("More than one Via header field present in the response. Dropping the response"),!1}),s.push(function(e,t){var i=t.configuration.viaHost;if(e.via.host!==i||void 0!==e.via.port)return t.getLogger("sip.sanitycheck").warn("Via sent-by in the response does not match UA Via host value. Dropping the response"),!1}),s.push(function(t,i){if(e.Utils.str_utf8_length(t.body)<t.getHeader("content-length"))return i.getLogger("sip.sanitycheck").warn("Message body length is lower than the value in Content-Length header field. Dropping the response"),!1}),r.push(function(e,t){for(var i=["from","to","call_id","cseq","via"],s=i.length;s--;)if(!e.hasHeader(i[s]))return t.getLogger("sip.sanitycheck").warn("Missing mandatory header field : "+i[s]+". Dropping the response"),!1}),t=function(t,n,o){var a;for(a=r.length;a--;)if(!1===r[a](t,n,o))return!1;if(t instanceof e.IncomingRequest){for(a=i.length;a--;)if(!1===i[a](t,n,o))return!1}else if(t instanceof e.IncomingResponse)for(a=s.length;a--;)if(!1===s[a](t,n,o))return!1;return!0},e.sanityCheck=t}},function(e,t,i){"use strict";var s=i(34);e.exports=function(e){var t;return(t=function(e){this.logger=e.getLogger("sipjs.digestauthentication"),this.username=e.configuration.authorizationUser,this.password=e.configuration.password,this.cnonce=null,this.nc=0,this.ncHex="00000000",this.response=null}).prototype.authenticate=function(t,i){if(this.algorithm=i.algorithm,this.realm=i.realm,this.nonce=i.nonce,this.opaque=i.opaque,this.stale=i.stale,this.algorithm){if("MD5"!==this.algorithm)return this.logger.warn('challenge with Digest algorithm different than "MD5", authentication aborted'),!1}else this.algorithm="MD5";if(!this.realm)return this.logger.warn("challenge without Digest realm, authentication aborted"),!1;if(!this.nonce)return this.logger.warn("challenge without Digest nonce, authentication aborted"),!1;if(i.qop)if(i.qop.indexOf("auth")>-1)this.qop="auth";else{if(!(i.qop.indexOf("auth-int")>-1))return this.logger.warn('challenge without Digest qop different than "auth" or "auth-int", authentication aborted'),!1;this.qop="auth-int"}else this.qop=null;return this.method=t.method,this.uri=t.ruri,this.cnonce=e.createRandomToken(12),this.nc+=1,this.updateNcHex(),4294967296===this.nc&&(this.nc=1,this.ncHex="00000001"),this.calculateResponse(),!0},t.prototype.calculateResponse=function(){var e,t;e=s(this.username+":"+this.realm+":"+this.password),"auth"===this.qop?(t=s(this.method+":"+this.uri),this.response=s(e+":"+this.nonce+":"+this.ncHex+":"+this.cnonce+":auth:"+t)):"auth-int"===this.qop?(t=s(this.method+":"+this.uri+":"+s(this.body?this.body:"")),this.response=s(e+":"+this.nonce+":"+this.ncHex+":"+this.cnonce+":auth-int:"+t)):null===this.qop&&(t=s(this.method+":"+this.uri),this.response=s(e+":"+this.nonce+":"+t))},t.prototype.toString=function(){var e=[];if(!this.response)throw new Error("response field does not exist, cannot generate Authorization header");return e.push("algorithm="+this.algorithm),e.push('username="'+this.username+'"'),e.push('realm="'+this.realm+'"'),e.push('nonce="'+this.nonce+'"'),e.push('uri="'+this.uri+'"'),e.push('response="'+this.response+'"'),this.opaque&&e.push('opaque="'+this.opaque+'"'),this.qop&&(e.push("qop="+this.qop),e.push('cnonce="'+this.cnonce+'"'),e.push("nc="+this.ncHex)),"Digest "+e.join(", ")},t.prototype.updateNcHex=function(){var e=Number(this.nc).toString(16);this.ncHex="00000000".substr(0,8-e.length)+e},t}},function(e,t,i){e.exports=function(e){return function(t){var i=e,s=i.lib,r=s.WordArray,n=s.Hasher,o=i.algo,a=[];!function(){for(var e=0;e<64;e++)a[e]=4294967296*t.abs(t.sin(e+1))|0}();var c=o.MD5=n.extend({_doReset:function(){this._hash=new r.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(e,t){for(var i=0;i<16;i++){var s=t+i,r=e[s];e[s]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8)}var n=this._hash.words,o=e[t+0],c=e[t+1],p=e[t+2],g=e[t+3],f=e[t+4],m=e[t+5],T=e[t+6],E=e[t+7],_=e[t+8],S=e[t+9],v=e[t+10],C=e[t+11],R=e[t+12],A=e[t+13],y=e[t+14],b=e[t+15],I=n[0],w=n[1],D=n[2],N=n[3];w=d(w=d(w=d(w=d(w=l(w=l(w=l(w=l(w=u(w=u(w=u(w=u(w=h(w=h(w=h(w=h(w,D=h(D,N=h(N,I=h(I,w,D,N,o,7,a[0]),w,D,c,12,a[1]),I,w,p,17,a[2]),N,I,g,22,a[3]),D=h(D,N=h(N,I=h(I,w,D,N,f,7,a[4]),w,D,m,12,a[5]),I,w,T,17,a[6]),N,I,E,22,a[7]),D=h(D,N=h(N,I=h(I,w,D,N,_,7,a[8]),w,D,S,12,a[9]),I,w,v,17,a[10]),N,I,C,22,a[11]),D=h(D,N=h(N,I=h(I,w,D,N,R,7,a[12]),w,D,A,12,a[13]),I,w,y,17,a[14]),N,I,b,22,a[15]),D=u(D,N=u(N,I=u(I,w,D,N,c,5,a[16]),w,D,T,9,a[17]),I,w,C,14,a[18]),N,I,o,20,a[19]),D=u(D,N=u(N,I=u(I,w,D,N,m,5,a[20]),w,D,v,9,a[21]),I,w,b,14,a[22]),N,I,f,20,a[23]),D=u(D,N=u(N,I=u(I,w,D,N,S,5,a[24]),w,D,y,9,a[25]),I,w,g,14,a[26]),N,I,_,20,a[27]),D=u(D,N=u(N,I=u(I,w,D,N,A,5,a[28]),w,D,p,9,a[29]),I,w,E,14,a[30]),N,I,R,20,a[31]),D=l(D,N=l(N,I=l(I,w,D,N,m,4,a[32]),w,D,_,11,a[33]),I,w,C,16,a[34]),N,I,y,23,a[35]),D=l(D,N=l(N,I=l(I,w,D,N,c,4,a[36]),w,D,f,11,a[37]),I,w,E,16,a[38]),N,I,v,23,a[39]),D=l(D,N=l(N,I=l(I,w,D,N,A,4,a[40]),w,D,o,11,a[41]),I,w,g,16,a[42]),N,I,T,23,a[43]),D=l(D,N=l(N,I=l(I,w,D,N,S,4,a[44]),w,D,R,11,a[45]),I,w,b,16,a[46]),N,I,p,23,a[47]),D=d(D,N=d(N,I=d(I,w,D,N,o,6,a[48]),w,D,E,10,a[49]),I,w,y,15,a[50]),N,I,m,21,a[51]),D=d(D,N=d(N,I=d(I,w,D,N,R,6,a[52]),w,D,g,10,a[53]),I,w,v,15,a[54]),N,I,c,21,a[55]),D=d(D,N=d(N,I=d(I,w,D,N,_,6,a[56]),w,D,b,10,a[57]),I,w,T,15,a[58]),N,I,A,21,a[59]),D=d(D,N=d(N,I=d(I,w,D,N,f,6,a[60]),w,D,C,10,a[61]),I,w,p,15,a[62]),N,I,S,21,a[63]),n[0]=n[0]+I|0,n[1]=n[1]+w|0,n[2]=n[2]+D|0,n[3]=n[3]+N|0},_doFinalize:function(){var e=this._data,i=e.words,s=8*this._nDataBytes,r=8*e.sigBytes;i[r>>>5]|=128<<24-r%32;var n=t.floor(s/4294967296),o=s;i[15+(r+64>>>9<<4)]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8),i[14+(r+64>>>9<<4)]=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),e.sigBytes=4*(i.length+1),this._process();for(var a=this._hash,c=a.words,h=0;h<4;h++){var u=c[h];c[h]=16711935&(u<<8|u>>>24)|4278255360&(u<<24|u>>>8)}return a},clone:function(){var e=n.clone.call(this);return e._hash=this._hash.clone(),e}});function h(e,t,i,s,r,n,o){var a=e+(t&i|~t&s)+r+o;return(a<<n|a>>>32-n)+t}function u(e,t,i,s,r,n,o){var a=e+(t&s|i&~s)+r+o;return(a<<n|a>>>32-n)+t}function l(e,t,i,s,r,n,o){var a=e+(t^i^s)+r+o;return(a<<n|a>>>32-n)+t}function d(e,t,i,s,r,n,o){var a=e+(i^(t|~s))+r+o;return(a<<n|a>>>32-n)+t}i.MD5=n._createHelper(c),i.HmacMD5=n._createHmacHelper(c)}(Math),e.MD5}(i(35))},function(e,t,i){e.exports=function(){var e=e||function(e,t){var i=Object.create||function(){function e(){}return function(t){var i;return e.prototype=t,i=new e,e.prototype=null,i}}(),s={},r=s.lib={},n=r.Base={extend:function(e){var t=i(this);return e&&t.mixIn(e),t.hasOwnProperty("init")&&this.init!==t.init||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},o=r.WordArray=n.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=void 0!=t?t:4*e.length},toString:function(e){return(e||c).stringify(this)},concat:function(e){var t=this.words,i=e.words,s=this.sigBytes,r=e.sigBytes;if(this.clamp(),s%4)for(var n=0;n<r;n++){var o=i[n>>>2]>>>24-n%4*8&255;t[s+n>>>2]|=o<<24-(s+n)%4*8}else for(var n=0;n<r;n+=4)t[s+n>>>2]=i[n>>>2];return this.sigBytes+=r,this},clamp:function(){var t=this.words,i=this.sigBytes;t[i>>>2]&=4294967295<<32-i%4*8,t.length=e.ceil(i/4)},clone:function(){var e=n.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var i,s=[],r=function(t){var t=t,i=987654321,s=4294967295;return function(){var r=((i=36969*(65535&i)+(i>>16)&s)<<16)+(t=18e3*(65535&t)+(t>>16)&s)&s;return r/=4294967296,(r+=.5)*(e.random()>.5?1:-1)}},n=0;n<t;n+=4){var a=r(4294967296*(i||e.random()));i=987654071*a(),s.push(4294967296*a()|0)}return new o.init(s,t)}}),a=s.enc={},c=a.Hex={stringify:function(e){for(var t=e.words,i=e.sigBytes,s=[],r=0;r<i;r++){var n=t[r>>>2]>>>24-r%4*8&255;s.push((n>>>4).toString(16)),s.push((15&n).toString(16))}return s.join("")},parse:function(e){for(var t=e.length,i=[],s=0;s<t;s+=2)i[s>>>3]|=parseInt(e.substr(s,2),16)<<24-s%8*4;return new o.init(i,t/2)}},h=a.Latin1={stringify:function(e){for(var t=e.words,i=e.sigBytes,s=[],r=0;r<i;r++){var n=t[r>>>2]>>>24-r%4*8&255;s.push(String.fromCharCode(n))}return s.join("")},parse:function(e){for(var t=e.length,i=[],s=0;s<t;s++)i[s>>>2]|=(255&e.charCodeAt(s))<<24-s%4*8;return new o.init(i,t)}},u=a.Utf8={stringify:function(e){try{return decodeURIComponent(escape(h.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return h.parse(unescape(encodeURIComponent(e)))}},l=r.BufferedBlockAlgorithm=n.extend({reset:function(){this._data=new o.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=u.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var i=this._data,s=i.words,r=i.sigBytes,n=this.blockSize,a=4*n,c=r/a,h=(c=t?e.ceil(c):e.max((0|c)-this._minBufferSize,0))*n,u=e.min(4*h,r);if(h){for(var l=0;l<h;l+=n)this._doProcessBlock(s,l);var d=s.splice(0,h);i.sigBytes-=u}return new o.init(d,u)},clone:function(){var e=n.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0}),d=(r.Hasher=l.extend({cfg:n.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){l.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){e&&this._append(e);var t=this._doFinalize();return t},blockSize:16,_createHelper:function(e){return function(t,i){return new e.init(i).finalize(t)}},_createHmacHelper:function(e){return function(t,i){return new d.HMAC.init(e,i).finalize(t)}}}),s.algo={});return s}(Math);return e}()},function(e,t,i){"use strict";var s=i(37);e.exports=function(e){return{parse:function(t,i){var r={startRule:i,SIP:e};try{s.parse(t,r)}catch(e){r.data=-1}return r.data}}}},function(e,t,i){"use strict";function s(e,t,i,r){this.message=e,this.expected=t,this.found=i,this.location=r,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,s)}!function(e,t){function i(){this.constructor=e}i.prototype=t.prototype,e.prototype=new i}(s,Error),s.buildMessage=function(e,t){var i={literal:function(e){return'"'+r(e.text)+'"'},class:function(e){var t,i="";for(t=0;t<e.parts.length;t++)i+=e.parts[t]instanceof Array?n(e.parts[t][0])+"-"+n(e.parts[t][1]):n(e.parts[t]);return"["+(e.inverted?"^":"")+i+"]"},any:function(e){return"any character"},end:function(e){return"end of input"},other:function(e){return e.description}};function s(e){return e.charCodeAt(0).toString(16).toUpperCase()}function r(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+s(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+s(e)})}function n(e){return e.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+s(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+s(e)})}function o(e){return i[e.type](e)}return"Expected "+function(e){var t,i,s=new Array(e.length);for(t=0;t<e.length;t++)s[t]=o(e[t]);if(s.sort(),s.length>0){for(t=1,i=1;t<s.length;t++)s[t-1]!==s[t]&&(s[i]=s[t],i++);s.length=i}switch(s.length){case 1:return s[0];case 2:return s[0]+" or "+s[1];default:return s.slice(0,-1).join(", ")+", or "+s[s.length-1]}}(e)+" but "+function(e){return e?'"'+r(e)+'"':"end of input"}(t)+" found."},e.exports={SyntaxError:s,parse:function(e,t){t=void 0!==t?t:{};var i,r={},n={Contact:119,Name_Addr_Header:156,Record_Route:176,Request_Response:81,SIP_URI:45,Subscription_State:186,Supported:191,Require:182,Via:194,absoluteURI:84,Call_ID:118,Content_Disposition:130,Content_Length:135,Content_Type:136,CSeq:146,displayName:122,Event:149,From:151,host:52,Max_Forwards:154,Min_SE:213,Proxy_Authenticate:157,quoted_string:40,Refer_To:178,Replaces:179,Session_Expires:210,stun_URI:217,To:192,turn_URI:223,uuid:226,WWW_Authenticate:209,challenge:158,sipfrag:230,Referred_By:231},o=119,a=["\r\n",T("\r\n",!1),/^[0-9]/,E([["0","9"]],!1,!1),/^[a-zA-Z]/,E([["a","z"],["A","Z"]],!1,!1),/^[0-9a-fA-F]/,E([["0","9"],["a","f"],["A","F"]],!1,!1),/^[\0-\xFF]/,E([["\0","\xff"]],!1,!1),/^["]/,E(['"'],!1,!1)," ",T(" ",!1),"\t",T("\t",!1),/^[a-zA-Z0-9]/,E([["a","z"],["A","Z"],["0","9"]],!1,!1),";",T(";",!1),"/",T("/",!1),"?",T("?",!1),":",T(":",!1),"@",T("@",!1),"&",T("&",!1),"=",T("=",!1),"+",T("+",!1),"$",T("$",!1),",",T(",",!1),"-",T("-",!1),"_",T("_",!1),".",T(".",!1),"!",T("!",!1),"~",T("~",!1),"*",T("*",!1),"'",T("'",!1),"(",T("(",!1),")",T(")",!1),"%",T("%",!1),function(){return" "},function(){return":"},/^[!-~]/,E([["!","~"]],!1,!1),/^[\x80-\uFFFF]/,E([["\x80","\uffff"]],!1,!1),/^[\x80-\xBF]/,E([["\x80","\xbf"]],!1,!1),/^[a-f]/,E([["a","f"]],!1,!1),"`",T("`",!1),"<",T("<",!1),">",T(">",!1),"\\",T("\\",!1),"[",T("[",!1),"]",T("]",!1),"{",T("{",!1),"}",T("}",!1),function(){return"*"},function(){return"/"},function(){return"="},function(){return"("},function(){return")"},function(){return">"},function(){return"<"},function(){return","},function(){return";"},function(){return":"},function(){return'"'},/^[!-']/,E([["!","'"]],!1,!1),/^[*-[]/,E([["*","["]],!1,!1),/^[\]-~]/,E([["]","~"]],!1,!1),function(e){return e},/^[#-[]/,E([["#","["]],!1,!1),/^[\0-\t]/,E([["\0","\t"]],!1,!1),/^[\x0B-\f]/,E([["\v","\f"]],!1,!1),/^[\x0E-\x7F]/,E([["\x0e","\x7f"]],!1,!1),function(){t.data.uri=new t.SIP.URI(t.data.scheme,t.data.user,t.data.host,t.data.port),delete t.data.scheme,delete t.data.user,delete t.data.host,delete t.data.host_type,delete t.data.port},function(){t.data.uri=new t.SIP.URI(t.data.scheme,t.data.user,t.data.host,t.data.port,t.data.uri_params,t.data.uri_headers),delete t.data.scheme,delete t.data.user,delete t.data.host,delete t.data.host_type,delete t.data.port,delete t.data.uri_params,"SIP_URI"===t.startRule&&(t.data=t.data.uri)},"sips",T("sips",!0),"sip",T("sip",!0),function(e){t.data.scheme=e},function(){t.data.user=decodeURIComponent(f().slice(0,-1))},function(){t.data.password=f()},function(){return t.data.host=f(),t.data.host},function(){return t.data.host_type="domain",f()},/^[a-zA-Z0-9_\-]/,E([["a","z"],["A","Z"],["0","9"],"_","-"],!1,!1),/^[a-zA-Z0-9\-]/,E([["a","z"],["A","Z"],["0","9"],"-"],!1,!1),function(){return t.data.host_type="IPv6",f()},"::",T("::",!1),function(){return t.data.host_type="IPv6",f()},function(){return t.data.host_type="IPv4",f()},"25",T("25",!1),/^[0-5]/,E([["0","5"]],!1,!1),"2",T("2",!1),/^[0-4]/,E([["0","4"]],!1,!1),"1",T("1",!1),/^[1-9]/,E([["1","9"]],!1,!1),function(e){return e=parseInt(e.join("")),t.data.port=e,e},"transport=",T("transport=",!0),"udp",T("udp",!0),"tcp",T("tcp",!0),"sctp",T("sctp",!0),"tls",T("tls",!0),function(e){t.data.uri_params||(t.data.uri_params={}),t.data.uri_params.transport=e.toLowerCase()},"user=",T("user=",!0),"phone",T("phone",!0),"ip",T("ip",!0),function(e){t.data.uri_params||(t.data.uri_params={}),t.data.uri_params.user=e.toLowerCase()},"method=",T("method=",!0),function(e){t.data.uri_params||(t.data.uri_params={}),t.data.uri_params.method=e},"ttl=",T("ttl=",!0),function(e){t.data.params||(t.data.params={}),t.data.params.ttl=e},"maddr=",T("maddr=",!0),function(e){t.data.uri_params||(t.data.uri_params={}),t.data.uri_params.maddr=e},"lr",T("lr",!0),function(){t.data.uri_params||(t.data.uri_params={}),t.data.uri_params.lr=void 0},function(e,i){t.data.uri_params||(t.data.uri_params={}),i=null===i?void 0:i[1],t.data.uri_params[e.toLowerCase()]=i&&i.toLowerCase()},function(e,i){e=e.join("").toLowerCase(),i=i.join(""),t.data.uri_headers||(t.data.uri_headers={}),t.data.uri_headers[e]?t.data.uri_headers[e].push(i):t.data.uri_headers[e]=[i]},function(){"Refer_To"===t.startRule&&(t.data.uri=new t.SIP.URI(t.data.scheme,t.data.user,t.data.host,t.data.port,t.data.uri_params,t.data.uri_headers),delete t.data.scheme,delete t.data.user,delete t.data.host,delete t.data.host_type,delete t.data.port,delete t.data.uri_params)},"//",T("//",!1),function(){t.data.scheme=f()},T("SIP",!0),function(){t.data.sip_version=f()},"INVITE",T("INVITE",!1),"ACK",T("ACK",!1),"VXACH",T("VXACH",!1),"OPTIONS",T("OPTIONS",!1),"BYE",T("BYE",!1),"CANCEL",T("CANCEL",!1),"REGISTER",T("REGISTER",!1),"SUBSCRIBE",T("SUBSCRIBE",!1),"NOTIFY",T("NOTIFY",!1),"REFER",T("REFER",!1),"PUBLISH",T("PUBLISH",!1),function(){return t.data.method=f(),t.data.method},function(e){t.data.status_code=parseInt(e.join(""))},function(){t.data.reason_phrase=f()},function(){t.data=f()},function(){var e,i;for(i=t.data.multi_header.length,e=0;e<i;e++)if(null===t.data.multi_header[e].parsed){t.data=null;break}null!==t.data?t.data=t.data.multi_header:t.data=-1},function(){var e;t.data.multi_header||(t.data.multi_header=[]);try{e=new t.SIP.NameAddrHeader(t.data.uri,t.data.displayName,t.data.params),delete t.data.uri,delete t.data.displayName,delete t.data.params}catch(t){e=null}t.data.multi_header.push({position:h,offset:m().start.offset,parsed:e})},function(e){'"'===(e=f().trim())[0]&&(e=e.substring(1,e.length-1)),t.data.displayName=e},"q",T("q",!0),function(e){t.data.params||(t.data.params={}),t.data.params.q=e},"expires",T("expires",!0),function(e){t.data.params||(t.data.params={}),t.data.params.expires=e},function(e){return parseInt(e.join(""))},"0",T("0",!1),function(){return parseFloat(f())},function(e,i){t.data.params||(t.data.params={}),i=null===i?void 0:i[1],t.data.params[e.toLowerCase()]=i},"render",T("render",!0),"session",T("session",!0),"icon",T("icon",!0),"alert",T("alert",!0),function(){"Content_Disposition"===t.startRule&&(t.data.type=f().toLowerCase())},"handling",T("handling",!0),"optional",T("optional",!0),"required",T("required",!0),function(e){t.data=parseInt(e.join(""))},function(){t.data=f()},"text",T("text",!0),"image",T("image",!0),"audio",T("audio",!0),"video",T("video",!0),"application",T("application",!0),"message",T("message",!0),"multipart",T("multipart",!0),"x-",T("x-",!0),function(e){t.data.value=parseInt(e.join(""))},function(e){t.data=e},function(e){t.data.event=e.toLowerCase()},function(){var e=t.data.tag;t.data=new t.SIP.NameAddrHeader(t.data.uri,t.data.displayName,t.data.params),e&&t.data.setParam("tag",e)},"tag",T("tag",!0),function(e){t.data.tag=e},function(e){t.data=parseInt(e.join(""))},function(e){t.data=e},function(){t.data=new t.SIP.NameAddrHeader(t.data.uri,t.data.displayName,t.data.params)},"digest",T("Digest",!0),"realm",T("realm",!0),function(e){t.data.realm=e},"domain",T("domain",!0),"nonce",T("nonce",!0),function(e){t.data.nonce=e},"opaque",T("opaque",!0),function(e){t.data.opaque=e},"stale",T("stale",!0),"true",T("true",!0),function(){t.data.stale=!0},"false",T("false",!0),function(){t.data.stale=!1},"algorithm",T("algorithm",!0),"md5",T("MD5",!0),"md5-sess",T("MD5-sess",!0),function(e){t.data.algorithm=e.toUpperCase()},"qop",T("qop",!0),"auth-int",T("auth-int",!0),"auth",T("auth",!0),function(e){t.data.qop||(t.data.qop=[]),t.data.qop.push(e.toLowerCase())},function(e){t.data.value=parseInt(e.join(""))},function(){var e,i;for(i=t.data.multi_header.length,e=0;e<i;e++)if(null===t.data.multi_header[e].parsed){t.data=null;break}null!==t.data?t.data=t.data.multi_header:t.data=-1},function(){var e;t.data.multi_header||(t.data.multi_header=[]);try{e=new t.SIP.NameAddrHeader(t.data.uri,t.data.displayName,t.data.params),delete t.data.uri,delete t.data.displayName,delete t.data.params}catch(t){e=null}t.data.multi_header.push({position:h,offset:m().start.offset,parsed:e})},function(){t.data=new t.SIP.NameAddrHeader(t.data.uri,t.data.displayName,t.data.params)},function(){t.data.replaces_from_tag&&t.data.replaces_to_tag||(t.data=-1)},function(){t.data={call_id:t.data}},"from-tag",T("from-tag",!0),function(e){t.data.replaces_from_tag=e},"to-tag",T("to-tag",!0),function(e){t.data.replaces_to_tag=e},"early-only",T("early-only",!0),function(){t.data.early_only=!0},function(e,t){return t},function(e,t){return function(e,t){return[e].concat(t)}(e,t)},function(e){"Require"===t.startRule&&(t.data=e||[])},function(e){t.data.value=parseInt(e.join(""))},"active",T("active",!0),"pending",T("pending",!0),"terminated",T("terminated",!0),function(){t.data.state=f()},"reason",T("reason",!0),function(e){void 0!==e&&(t.data.reason=e)},function(e){void 0!==e&&(t.data.expires=e)},"retry_after",T("retry_after",!0),function(e){void 0!==e&&(t.data.retry_after=e)},"deactivated",T("deactivated",!0),"probation",T("probation",!0),"rejected",T("rejected",!0),"timeout",T("timeout",!0),"giveup",T("giveup",!0),"noresource",T("noresource",!0),"invariant",T("invariant",!0),function(e){"Supported"===t.startRule&&(t.data=e||[])},function(){var e=t.data.tag;t.data=new t.SIP.NameAddrHeader(t.data.uri,t.data.displayName,t.data.params),e&&t.data.setParam("tag",e)},"ttl",T("ttl",!0),function(e){t.data.ttl=e},"maddr",T("maddr",!0),function(e){t.data.maddr=e},"received",T("received",!0),function(e){t.data.received=e},"branch",T("branch",!0),function(e){t.data.branch=e},"rport",T("rport",!0),function(){"undefined"!=typeof response_port&&(t.data.rport=response_port.join(""))},function(e){t.data.protocol=e},T("UDP",!0),T("TCP",!0),T("TLS",!0),T("SCTP",!0),function(e){t.data.transport=e},function(){t.data.host=f()},function(e){t.data.port=parseInt(e.join(""))},function(e){return parseInt(e.join(""))},function(e){"Session_Expires"===t.startRule&&(t.data.deltaSeconds=e)},"refresher",T("refresher",!1),"uas",T("uas",!1),"uac",T("uac",!1),function(e){"Session_Expires"===t.startRule&&(t.data.refresher=e)},function(e){"Min_SE"===t.startRule&&(t.data=e)},"stuns",T("stuns",!0),"stun",T("stun",!0),function(e){t.data.scheme=e},function(e){t.data.host=e},"?transport=",T("?transport=",!1),"turns",T("turns",!0),"turn",T("turn",!0),function(){t.data.transport=transport},function(){t.data=f()},"Referred-By",T("Referred-By",!1),"b",T("b",!1),"cid",T("cid",!1)],c=[R('2 ""6 7!'),R('4"""5!7#'),R('4$""5!7%'),R('4&""5!7\''),R(";'.# &;("),R('4(""5!7)'),R('4*""5!7+'),R('2,""6,7-'),R('2.""6.7/'),R('40""5!71'),R('22""6273.\x89 &24""6475.} &26""6677.q &28""6879.e &2:""6:7;.Y &2<""6<7=.M &2>""6>7?.A &2@""6@7A.5 &2B""6B7C.) &2D""6D7E'),R(";).# &;,"),R('2F""6F7G.} &2H""6H7I.q &2J""6J7K.e &2L""6L7M.Y &2N""6N7O.M &2P""6P7Q.A &2R""6R7S.5 &2T""6T7U.) &2V""6V7W'),R('%%2X""6X7Y/5#;#/,$;#/#$+#)(#\'#("\'#&\'#/"!&,)'),R('%%$;$0#*;$&/,#; /#$+")("\'#&\'#." &"/=#$;$/&#0#*;$&&&#/\'$8":Z" )("\'#&\'#'),R(';.." &"'),R("%$;'.# &;(0)*;'.# &;(&/?#28\"\"6879/0$;//'$8#:[# )(#'#(\"'#&'#"),R('%%$;2/&#0#*;2&&&#/g#$%$;.0#*;.&/,#;2/#$+")("\'#&\'#0=*%$;.0#*;.&/,#;2/#$+")("\'#&\'#&/#$+")("\'#&\'#/"!&,)'),R('4\\""5!7].# &;3'),R('4^""5!7_'),R('4`""5!7a'),R(';!.) &4b""5!7c'),R('%$;).\x95 &2F""6F7G.\x89 &2J""6J7K.} &2L""6L7M.q &2X""6X7Y.e &2P""6P7Q.Y &2H""6H7I.M &2@""6@7A.A &2d""6d7e.5 &2R""6R7S.) &2N""6N7O/\x9e#0\x9b*;).\x95 &2F""6F7G.\x89 &2J""6J7K.} &2L""6L7M.q &2X""6X7Y.e &2P""6P7Q.Y &2H""6H7I.M &2@""6@7A.A &2d""6d7e.5 &2R""6R7S.) &2N""6N7O&&&#/"!&,)'),R('%$;).\x89 &2F""6F7G.} &2L""6L7M.q &2X""6X7Y.e &2P""6P7Q.Y &2H""6H7I.M &2@""6@7A.A &2d""6d7e.5 &2R""6R7S.) &2N""6N7O/\x92#0\x8f*;).\x89 &2F""6F7G.} &2L""6L7M.q &2X""6X7Y.e &2P""6P7Q.Y &2H""6H7I.M &2@""6@7A.A &2d""6d7e.5 &2R""6R7S.) &2N""6N7O&&&#/"!&,)'),R('2T""6T7U.\xe3 &2V""6V7W.\xd7 &2f""6f7g.\xcb &2h""6h7i.\xbf &2:""6:7;.\xb3 &2D""6D7E.\xa7 &22""6273.\x9b &28""6879.\x8f &2j""6j7k.\x83 &;&.} &24""6475.q &2l""6l7m.e &2n""6n7o.Y &26""6677.M &2>""6>7?.A &2p""6p7q.5 &2r""6r7s.) &;\'.# &;('),R('%$;).\u012b &2F""6F7G.\u011f &2J""6J7K.\u0113 &2L""6L7M.\u0107 &2X""6X7Y.\xfb &2P""6P7Q.\xef &2H""6H7I.\xe3 &2@""6@7A.\xd7 &2d""6d7e.\xcb &2R""6R7S.\xbf &2N""6N7O.\xb3 &2T""6T7U.\xa7 &2V""6V7W.\x9b &2f""6f7g.\x8f &2h""6h7i.\x83 &28""6879.w &2j""6j7k.k &;&.e &24""6475.Y &2l""6l7m.M &2n""6n7o.A &26""6677.5 &2p""6p7q.) &2r""6r7s/\u0134#0\u0131*;).\u012b &2F""6F7G.\u011f &2J""6J7K.\u0113 &2L""6L7M.\u0107 &2X""6X7Y.\xfb &2P""6P7Q.\xef &2H""6H7I.\xe3 &2@""6@7A.\xd7 &2d""6d7e.\xcb &2R""6R7S.\xbf &2N""6N7O.\xb3 &2T""6T7U.\xa7 &2V""6V7W.\x9b &2f""6f7g.\x8f &2h""6h7i.\x83 &28""6879.w &2j""6j7k.k &;&.e &24""6475.Y &2l""6l7m.M &2n""6n7o.A &26""6677.5 &2p""6p7q.) &2r""6r7s&&&#/"!&,)'),R("%;//?#2P\"\"6P7Q/0$;//'$8#:t# )(#'#(\"'#&'#"),R("%;//?#24\"\"6475/0$;//'$8#:u# )(#'#(\"'#&'#"),R("%;//?#2>\"\"6>7?/0$;//'$8#:v# )(#'#(\"'#&'#"),R("%;//?#2T\"\"6T7U/0$;//'$8#:w# )(#'#(\"'#&'#"),R("%;//?#2V\"\"6V7W/0$;//'$8#:x# )(#'#(\"'#&'#"),R('%2h""6h7i/0#;//\'$8":y" )("\'#&\'#'),R('%;//6#2f""6f7g/\'$8":z" )("\'#&\'#'),R("%;//?#2D\"\"6D7E/0$;//'$8#:{# )(#'#(\"'#&'#"),R("%;//?#22\"\"6273/0$;//'$8#:|# )(#'#(\"'#&'#"),R("%;//?#28\"\"6879/0$;//'$8#:}# )(#'#(\"'#&'#"),R("%;//0#;&/'$8\":~\" )(\"'#&'#"),R("%;&/0#;//'$8\":~\" )(\"'#&'#"),R("%;=/T#$;G.) &;K.# &;F0/*;G.) &;K.# &;F&/,$;>/#$+#)(#'#(\"'#&'#"),R('4\x7f""5!7\x80.A &4\x81""5!7\x82.5 &4\x83""5!7\x84.) &;3.# &;.'),R("%%;//Q#;&/H$$;J.# &;K0)*;J.# &;K&/,$;&/#$+$)($'#(#'#(\"'#&'#/\"!&,)"),R("%;//]#;&/T$%$;J.# &;K0)*;J.# &;K&/\"!&,)/1$;&/($8$:\x85$!!)($'#(#'#(\"'#&'#"),R(';..G &2L""6L7M.; &4\x86""5!7\x87./ &4\x83""5!7\x84.# &;3'),R('%2j""6j7k/J#4\x88""5!7\x89.5 &4\x8a""5!7\x8b.) &4\x8c""5!7\x8d/#$+")("\'#&\'#'),R("%;N/M#28\"\"6879/>$;O.\" &\"/0$;S/'$8$:\x8e$ )($'#(#'#(\"'#&'#"),R("%;N/d#28\"\"6879/U$;O.\" &\"/G$;S/>$;_/5$;l.\" &\"/'$8&:\x8f& )(&'#(%'#($'#(#'#(\"'#&'#"),R('%3\x90""5$7\x91.) &3\x92""5#7\x93/\' 8!:\x94!! )'),R('%;P/]#%28""6879/,#;R/#$+")("\'#&\'#." &"/6$2:""6:7;/\'$8#:\x95# )(#\'#("\'#&\'#'),R("$;+.) &;-.# &;Q/2#0/*;+.) &;-.# &;Q&&&#"),R('2<""6<7=.q &2>""6>7?.e &2@""6@7A.Y &2B""6B7C.M &2D""6D7E.A &22""6273.5 &26""6677.) &24""6475'),R('%$;+._ &;-.Y &2<""6<7=.M &2>""6>7?.A &2@""6@7A.5 &2B""6B7C.) &2D""6D7E0e*;+._ &;-.Y &2<""6<7=.M &2>""6>7?.A &2@""6@7A.5 &2B""6B7C.) &2D""6D7E&/& 8!:\x96! )'),R('%;T/J#%28""6879/,#;^/#$+")("\'#&\'#." &"/#$+")("\'#&\'#'),R("%;U.) &;\\.# &;X/& 8!:\x97! )"),R('%$%;V/2#2J""6J7K/#$+")("\'#&\'#0<*%;V/2#2J""6J7K/#$+")("\'#&\'#&/D#;W/;$2J""6J7K." &"/\'$8#:\x98# )(#\'#("\'#&\'#'),R('$4\x99""5!7\x9a/,#0)*4\x99""5!7\x9a&&&#'),R('%4$""5!7%/?#$4\x9b""5!7\x9c0)*4\x9b""5!7\x9c&/#$+")("\'#&\'#'),R('%2l""6l7m/?#;Y/6$2n""6n7o/\'$8#:\x9d# )(#\'#("\'#&\'#'),R('%%;Z/\xb3#28""6879/\xa4$;Z/\x9b$28""6879/\x8c$;Z/\x83$28""6879/t$;Z/k$28""6879/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+-)(-\'#(,\'#(+\'#(*\'#()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.\u0790 &%2\x9e""6\x9e7\x9f/\xa4#;Z/\x9b$28""6879/\x8c$;Z/\x83$28""6879/t$;Z/k$28""6879/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+,)(,\'#(+\'#(*\'#()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.\u06f9 &%2\x9e""6\x9e7\x9f/\x8c#;Z/\x83$28""6879/t$;Z/k$28""6879/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+*)(*\'#()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.\u067a &%2\x9e""6\x9e7\x9f/t#;Z/k$28""6879/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+()((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.\u0613 &%2\x9e""6\x9e7\x9f/\\#;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+&)(&\'#(%\'#($\'#(#\'#("\'#&\'#.\u05c4 &%2\x9e""6\x9e7\x9f/D#;Z/;$28""6879/,$;[/#$+$)($\'#(#\'#("\'#&\'#.\u058d &%2\x9e""6\x9e7\x9f/,#;[/#$+")("\'#&\'#.\u056e &%2\x9e""6\x9e7\x9f/,#;Z/#$+")("\'#&\'#.\u054f &%;Z/\x9b#2\x9e""6\x9e7\x9f/\x8c$;Z/\x83$28""6879/t$;Z/k$28""6879/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$++)(+\'#(*\'#()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.\u04c7 &%;Z/\xaa#%28""6879/,#;Z/#$+")("\'#&\'#." &"/\x83$2\x9e""6\x9e7\x9f/t$;Z/k$28""6879/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+*)(*\'#()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.\u0430 &%;Z/\xb9#%28""6879/,#;Z/#$+")("\'#&\'#." &"/\x92$%28""6879/,#;Z/#$+")("\'#&\'#." &"/k$2\x9e""6\x9e7\x9f/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+))()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.\u038a &%;Z/\xc8#%28""6879/,#;Z/#$+")("\'#&\'#." &"/\xa1$%28""6879/,#;Z/#$+")("\'#&\'#." &"/z$%28""6879/,#;Z/#$+")("\'#&\'#." &"/S$2\x9e""6\x9e7\x9f/D$;Z/;$28""6879/,$;[/#$+()((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.\u02d5 &%;Z/\xd7#%28""6879/,#;Z/#$+")("\'#&\'#." &"/\xb0$%28""6879/,#;Z/#$+")("\'#&\'#." &"/\x89$%28""6879/,#;Z/#$+")("\'#&\'#." &"/b$%28""6879/,#;Z/#$+")("\'#&\'#." &"/;$2\x9e""6\x9e7\x9f/,$;[/#$+\')(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.\u0211 &%;Z/\xfe#%28""6879/,#;Z/#$+")("\'#&\'#." &"/\xd7$%28""6879/,#;Z/#$+")("\'#&\'#." &"/\xb0$%28""6879/,#;Z/#$+")("\'#&\'#." &"/\x89$%28""6879/,#;Z/#$+")("\'#&\'#." &"/b$%28""6879/,#;Z/#$+")("\'#&\'#." &"/;$2\x9e""6\x9e7\x9f/,$;Z/#$+()((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.\u0126 &%;Z/\u011c#%28""6879/,#;Z/#$+")("\'#&\'#." &"/\xf5$%28""6879/,#;Z/#$+")("\'#&\'#." &"/\xce$%28""6879/,#;Z/#$+")("\'#&\'#." &"/\xa7$%28""6879/,#;Z/#$+")("\'#&\'#." &"/\x80$%28""6879/,#;Z/#$+")("\'#&\'#." &"/Y$%28""6879/,#;Z/#$+")("\'#&\'#." &"/2$2\x9e""6\x9e7\x9f/#$+()((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#/& 8!:\xa0! )'),R('%;#/M#;#." &"/?$;#." &"/1$;#." &"/#$+$)($\'#(#\'#("\'#&\'#'),R("%;Z/;#28\"\"6879/,$;Z/#$+#)(#'#(\"'#&'#.# &;\\"),R("%;]/o#2J\"\"6J7K/`$;]/W$2J\"\"6J7K/H$;]/?$2J\"\"6J7K/0$;]/'$8':\xa1' )(''#(&'#(%'#($'#(#'#(\"'#&'#"),R('%2\xa2""6\xa27\xa3/2#4\xa4""5!7\xa5/#$+")("\'#&\'#.\x98 &%2\xa6""6\xa67\xa7/;#4\xa8""5!7\xa9/,$;!/#$+#)(#\'#("\'#&\'#.j &%2\xaa""6\xaa7\xab/5#;!/,$;!/#$+#)(#\'#("\'#&\'#.B &%4\xac""5!7\xad/,#;!/#$+")("\'#&\'#.# &;!'),R('%%;!." &"/[#;!." &"/M$;!." &"/?$;!." &"/1$;!." &"/#$+%)(%\'#($\'#(#\'#("\'#&\'#/\' 8!:\xae!! )'),R('$%22""6273/,#;`/#$+")("\'#&\'#0<*%22""6273/,#;`/#$+")("\'#&\'#&'),R(";a.A &;b.; &;c.5 &;d./ &;e.) &;f.# &;g"),R('%3\xaf""5*7\xb0/a#3\xb1""5#7\xb2.G &3\xb3""5#7\xb4.; &3\xb5""5$7\xb6./ &3\xb7""5#7\xb8.# &;6/($8":\xb9"! )("\'#&\'#'),R('%3\xba""5%7\xbb/I#3\xbc""5%7\xbd./ &3\xbe""5"7\xbf.# &;6/($8":\xc0"! )("\'#&\'#'),R('%3\xc1""5\'7\xc2/1#;\x90/($8":\xc3"! )("\'#&\'#'),R('%3\xc4""5$7\xc5/1#;\xf0/($8":\xc6"! )("\'#&\'#'),R('%3\xc7""5&7\xc8/1#;T/($8":\xc9"! )("\'#&\'#'),R('%3\xca""5"7\xcb/N#%2>""6>7?/,#;6/#$+")("\'#&\'#." &"/\'$8":\xcc" )("\'#&\'#'),R('%;h/P#%2>""6>7?/,#;i/#$+")("\'#&\'#." &"/)$8":\xcd""! )("\'#&\'#'),R('%$;j/&#0#*;j&&&#/"!&,)'),R('%$;j/&#0#*;j&&&#/"!&,)'),R(";k.) &;+.# &;-"),R('2l""6l7m.e &2n""6n7o.Y &24""6475.M &28""6879.A &2<""6<7=.5 &2@""6@7A.) &2B""6B7C'),R('%26""6677/n#;m/e$$%2<""6<7=/,#;m/#$+")("\'#&\'#0<*%2<""6<7=/,#;m/#$+")("\'#&\'#&/#$+#)(#\'#("\'#&\'#'),R('%;n/A#2>""6>7?/2$;o/)$8#:\xce#"" )(#\'#("\'#&\'#'),R("$;p.) &;+.# &;-/2#0/*;p.) &;+.# &;-&&&#"),R("$;p.) &;+.# &;-0/*;p.) &;+.# &;-&"),R('2l""6l7m.e &2n""6n7o.Y &24""6475.M &26""6677.A &28""6879.5 &2@""6@7A.) &2B""6B7C'),R(";\x91.# &;r"),R("%;\x90/G#;'/>$;s/5$;'/,$;\x84/#$+%)(%'#($'#(#'#(\"'#&'#"),R(";M.# &;t"),R("%;\x7f/E#28\"\"6879/6$;u.# &;x/'$8#:\xcf# )(#'#(\"'#&'#"),R('%;v.# &;w/J#%26""6677/,#;\x83/#$+")("\'#&\'#." &"/#$+")("\'#&\'#'),R('%2\xd0""6\xd07\xd1/:#;\x80/1$;w." &"/#$+#)(#\'#("\'#&\'#'),R('%24""6475/,#;{/#$+")("\'#&\'#'),R("%;z/3#$;y0#*;y&/#$+\")(\"'#&'#"),R(";*.) &;+.# &;-"),R(';+.\x8f &;-.\x89 &22""6273.} &26""6677.q &28""6879.e &2:""6:7;.Y &2<""6<7=.M &2>""6>7?.A &2@""6@7A.5 &2B""6B7C.) &2D""6D7E'),R('%;|/e#$%24""6475/,#;|/#$+")("\'#&\'#0<*%24""6475/,#;|/#$+")("\'#&\'#&/#$+")("\'#&\'#'),R('%$;~0#*;~&/e#$%22""6273/,#;}/#$+")("\'#&\'#0<*%22""6273/,#;}/#$+")("\'#&\'#&/#$+")("\'#&\'#'),R("$;~0#*;~&"),R(';+.w &;-.q &28""6879.e &2:""6:7;.Y &2<""6<7=.M &2>""6>7?.A &2@""6@7A.5 &2B""6B7C.) &2D""6D7E'),R('%%;"/\x87#$;".G &;!.A &2@""6@7A.5 &2F""6F7G.) &2J""6J7K0M*;".G &;!.A &2@""6@7A.5 &2F""6F7G.) &2J""6J7K&/#$+")("\'#&\'#/& 8!:\xd2! )'),R(";\x81.# &;\x82"),R('%%;O/2#2:""6:7;/#$+")("\'#&\'#." &"/,#;S/#$+")("\'#&\'#." &"'),R('$;+.\x83 &;-.} &2B""6B7C.q &2D""6D7E.e &22""6273.Y &28""6879.M &2:""6:7;.A &2<""6<7=.5 &2>""6>7?.) &2@""6@7A/\x8c#0\x89*;+.\x83 &;-.} &2B""6B7C.q &2D""6D7E.e &22""6273.Y &28""6879.M &2:""6:7;.A &2<""6<7=.5 &2>""6>7?.) &2@""6@7A&&&#'),R("$;y0#*;y&"),R('%3\x92""5#7\xd3/q#24""6475/b$$;!/&#0#*;!&&&#/L$2J""6J7K/=$$;!/&#0#*;!&&&#/\'$8%:\xd4% )(%\'#($\'#(#\'#("\'#&\'#'),R('2\xd5""6\xd57\xd6'),R('2\xd7""6\xd77\xd8'),R('2\xd9""6\xd97\xda'),R('2\xdb""6\xdb7\xdc'),R('2\xdd""6\xdd7\xde'),R('2\xdf""6\xdf7\xe0'),R('2\xe1""6\xe17\xe2'),R('2\xe3""6\xe37\xe4'),R('2\xe5""6\xe57\xe6'),R('2\xe7""6\xe77\xe8'),R('2\xe9""6\xe97\xea'),R("%;\x85.Y &;\x86.S &;\x88.M &;\x89.G &;\x8a.A &;\x8b.; &;\x8c.5 &;\x8f./ &;\x8d.) &;\x8e.# &;6/& 8!:\xeb! )"),R("%;\x84/G#;'/>$;\x92/5$;'/,$;\x94/#$+%)(%'#($'#(#'#(\"'#&'#"),R("%;\x93/' 8!:\xec!! )"),R("%;!/5#;!/,$;!/#$+#)(#'#(\"'#&'#"),R("%$;*.A &;+.; &;-.5 &;3./ &;4.) &;'.# &;(0G*;*.A &;+.; &;-.5 &;3./ &;4.) &;'.# &;(&/& 8!:\xed! )"),R("%;\xb6/Y#$%;A/,#;\xb6/#$+\")(\"'#&'#06*%;A/,#;\xb6/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),R('%;9/N#%2:""6:7;/,#;9/#$+")("\'#&\'#." &"/\'$8":\xee" )("\'#&\'#'),R("%;:.c &%;\x98/Y#$%;A/,#;\x98/#$+\")(\"'#&'#06*%;A/,#;\x98/#$+\")(\"'#&'#&/#$+\")(\"'#&'#/& 8!:\xef! )"),R("%;L.# &;\x99/]#$%;B/,#;\x9b/#$+\")(\"'#&'#06*%;B/,#;\x9b/#$+\")(\"'#&'#&/'$8\":\xf0\" )(\"'#&'#"),R("%;\x9a.\" &\"/>#;@/5$;M/,$;?/#$+$)($'#(#'#(\"'#&'#"),R("%%;6/Y#$%;./,#;6/#$+\")(\"'#&'#06*%;./,#;6/#$+\")(\"'#&'#&/#$+\")(\"'#&'#.# &;H/' 8!:\xf1!! )"),R(";\x9c.) &;\x9d.# &;\xa0"),R("%3\xf2\"\"5!7\xf3/:#;</1$;\x9f/($8#:\xf4#! )(#'#(\"'#&'#"),R("%3\xf5\"\"5'7\xf6/:#;</1$;\x9e/($8#:\xf7#! )(#'#(\"'#&'#"),R("%$;!/&#0#*;!&&&#/' 8!:\xf8!! )"),R('%2\xf9""6\xf97\xfa/o#%2J""6J7K/M#;!." &"/?$;!." &"/1$;!." &"/#$+$)($\'#(#\'#("\'#&\'#." &"/\'$8":\xfb" )("\'#&\'#'),R('%;6/J#%;</,#;\xa1/#$+")("\'#&\'#." &"/)$8":\xfc""! )("\'#&\'#'),R(";6.) &;T.# &;H"),R("%;\xa3/Y#$%;B/,#;\xa4/#$+\")(\"'#&'#06*%;B/,#;\xa4/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),R('%3\xfd""5&7\xfe.G &3\xff""5\'7\u0100.; &3\u0101""5$7\u0102./ &3\u0103""5%7\u0104.# &;6/& 8!:\u0105! )'),R(";\xa5.# &;\xa0"),R('%3\u0106""5(7\u0107/M#;</D$3\u0108""5(7\u0109./ &3\u010a""5(7\u010b.# &;6/#$+#)(#\'#("\'#&\'#'),R("%;6/Y#$%;A/,#;6/#$+\")(\"'#&'#06*%;A/,#;6/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),R("%$;!/&#0#*;!&&&#/' 8!:\u010c!! )"),R("%;\xa9/& 8!:\u010d! )"),R("%;\xaa/k#;;/b$;\xaf/Y$$%;B/,#;\xb0/#$+\")(\"'#&'#06*%;B/,#;\xb0/#$+\")(\"'#&'#&/#$+$)($'#(#'#(\"'#&'#"),R(";\xab.# &;\xac"),R('3\u010e""5$7\u010f.S &3\u0110""5%7\u0111.G &3\u0112""5%7\u0113.; &3\u0114""5%7\u0115./ &3\u0116""5+7\u0117.# &;\xad'),R('3\u0118""5\'7\u0119./ &3\u011a""5)7\u011b.# &;\xad'),R(";6.# &;\xae"),R('%3\u011c""5"7\u011d/,#;6/#$+")("\'#&\'#'),R(";\xad.# &;6"),R("%;6/5#;</,$;\xb1/#$+#)(#'#(\"'#&'#"),R(";6.# &;H"),R("%;\xb3/5#;./,$;\x90/#$+#)(#'#(\"'#&'#"),R("%$;!/&#0#*;!&&&#/' 8!:\u011e!! )"),R("%;\x9e/' 8!:\u011f!! )"),R('%;\xb6/^#$%;B/,#;\xa0/#$+")("\'#&\'#06*%;B/,#;\xa0/#$+")("\'#&\'#&/($8":\u0120"!!)("\'#&\'#'),R('%%;7/e#$%2J""6J7K/,#;7/#$+")("\'#&\'#0<*%2J""6J7K/,#;7/#$+")("\'#&\'#&/#$+")("\'#&\'#/"!&,)'),R("%;L.# &;\x99/]#$%;B/,#;\xb8/#$+\")(\"'#&'#06*%;B/,#;\xb8/#$+\")(\"'#&'#&/'$8\":\u0121\" )(\"'#&'#"),R(";\xb9.# &;\xa0"),R("%3\u0122\"\"5#7\u0123/:#;</1$;6/($8#:\u0124#! )(#'#(\"'#&'#"),R("%$;!/&#0#*;!&&&#/' 8!:\u0125!! )"),R("%;\x9e/' 8!:\u0126!! )"),R("%$;\x9a0#*;\x9a&/x#;@/o$;M/f$;?/]$$%;B/,#;\xa0/#$+\")(\"'#&'#06*%;B/,#;\xa0/#$+\")(\"'#&'#&/'$8%:\u0127% )(%'#($'#(#'#(\"'#&'#"),R(";\xbe"),R("%3\u0128\"\"5&7\u0129/k#;./b$;\xc1/Y$$%;A/,#;\xc1/#$+\")(\"'#&'#06*%;A/,#;\xc1/#$+\")(\"'#&'#&/#$+$)($'#(#'#(\"'#&'#.# &;\xbf"),R("%;6/k#;./b$;\xc0/Y$$%;A/,#;\xc0/#$+\")(\"'#&'#06*%;A/,#;\xc0/#$+\")(\"'#&'#&/#$+$)($'#(#'#(\"'#&'#"),R("%;6/;#;</2$;6.# &;H/#$+#)(#'#(\"'#&'#"),R(";\xc2.G &;\xc4.A &;\xc6.; &;\xc8.5 &;\xc9./ &;\xca.) &;\xcb.# &;\xc0"),R("%3\u012a\"\"5%7\u012b/5#;</,$;\xc3/#$+#)(#'#(\"'#&'#"),R("%;I/' 8!:\u012c!! )"),R("%3\u012d\"\"5&7\u012e/\x97#;</\x8e$;D/\x85$;\xc5/|$$%$;'/&#0#*;'&&&#/,#;\xc5/#$+\")(\"'#&'#0C*%$;'/&#0#*;'&&&#/,#;\xc5/#$+\")(\"'#&'#&/,$;E/#$+&)(&'#(%'#($'#(#'#(\"'#&'#"),R(";t.# &;w"),R("%3\u012f\"\"5%7\u0130/5#;</,$;\xc7/#$+#)(#'#(\"'#&'#"),R("%;I/' 8!:\u0131!! )"),R("%3\u0132\"\"5&7\u0133/:#;</1$;I/($8#:\u0134#! )(#'#(\"'#&'#"),R('%3\u0135""5%7\u0136/]#;</T$%3\u0137""5$7\u0138/& 8!:\u0139! ).4 &%3\u013a""5%7\u013b/& 8!:\u013c! )/#$+#)(#\'#("\'#&\'#'),R('%3\u013d""5)7\u013e/R#;</I$3\u013f""5#7\u0140./ &3\u0141""5(7\u0142.# &;6/($8#:\u0143#! )(#\'#("\'#&\'#'),R('%3\u0144""5#7\u0145/\x93#;</\x8a$;D/\x81$%;\xcc/e#$%2D""6D7E/,#;\xcc/#$+")("\'#&\'#0<*%2D""6D7E/,#;\xcc/#$+")("\'#&\'#&/#$+")("\'#&\'#/,$;E/#$+%)(%\'#($\'#(#\'#("\'#&\'#'),R('%3\u0146""5(7\u0147./ &3\u0148""5$7\u0149.# &;6/\' 8!:\u014a!! )'),R("%;6/Y#$%;A/,#;6/#$+\")(\"'#&'#06*%;A/,#;6/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),R("%;\xcf/G#;./>$;\xcf/5$;./,$;\x90/#$+%)(%'#($'#(#'#(\"'#&'#"),R("%$;!/&#0#*;!&&&#/' 8!:\u014b!! )"),R("%;\xd1/]#$%;A/,#;\xd1/#$+\")(\"'#&'#06*%;A/,#;\xd1/#$+\")(\"'#&'#&/'$8\":\u014c\" )(\"'#&'#"),R("%;\x99/]#$%;B/,#;\xa0/#$+\")(\"'#&'#06*%;B/,#;\xa0/#$+\")(\"'#&'#&/'$8\":\u014d\" )(\"'#&'#"),R('%;L.O &;\x99.I &%;@." &"/:#;t/1$;?." &"/#$+#)(#\'#("\'#&\'#/]#$%;B/,#;\xa0/#$+")("\'#&\'#06*%;B/,#;\xa0/#$+")("\'#&\'#&/\'$8":\u014e" )("\'#&\'#'),R("%;\xd4/]#$%;B/,#;\xd5/#$+\")(\"'#&'#06*%;B/,#;\xd5/#$+\")(\"'#&'#&/'$8\":\u014f\" )(\"'#&'#"),R("%;\x96/& 8!:\u0150! )"),R('%3\u0151""5(7\u0152/:#;</1$;6/($8#:\u0153#! )(#\'#("\'#&\'#.g &%3\u0154""5&7\u0155/:#;</1$;6/($8#:\u0156#! )(#\'#("\'#&\'#.: &%3\u0157""5*7\u0158/& 8!:\u0159! ).# &;\xa0'),R('%%;6/k#$%;A/2#;6/)$8":\u015a""$ )("\'#&\'#0<*%;A/2#;6/)$8":\u015a""$ )("\'#&\'#&/)$8":\u015b""! )("\'#&\'#." &"/\' 8!:\u015c!! )'),R("%;\xd8/Y#$%;A/,#;\xd8/#$+\")(\"'#&'#06*%;A/,#;\xd8/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),R("%;\x99/Y#$%;B/,#;\xa0/#$+\")(\"'#&'#06*%;B/,#;\xa0/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),R("%$;!/&#0#*;!&&&#/' 8!:\u015d!! )"),R("%;\xdb/Y#$%;B/,#;\xdc/#$+\")(\"'#&'#06*%;B/,#;\xdc/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),R('%3\u015e""5&7\u015f.; &3\u0160""5\'7\u0161./ &3\u0162""5*7\u0163.# &;6/& 8!:\u0164! )'),R("%3\u0165\"\"5&7\u0166/:#;</1$;\xdd/($8#:\u0167#! )(#'#(\"'#&'#.} &%3\xf5\"\"5'7\xf6/:#;</1$;\x9e/($8#:\u0168#! )(#'#(\"'#&'#.P &%3\u0169\"\"5+7\u016a/:#;</1$;\x9e/($8#:\u016b#! )(#'#(\"'#&'#.# &;\xa0"),R('3\u016c""5+7\u016d.k &3\u016e""5)7\u016f._ &3\u0170""5(7\u0171.S &3\u0172""5\'7\u0173.G &3\u0174""5&7\u0175.; &3\u0176""5*7\u0177./ &3\u0178""5)7\u0179.# &;6'),R(';1." &"'),R('%%;6/k#$%;A/2#;6/)$8":\u015a""$ )("\'#&\'#0<*%;A/2#;6/)$8":\u015a""$ )("\'#&\'#&/)$8":\u015b""! )("\'#&\'#." &"/\' 8!:\u017a!! )'),R("%;L.# &;\x99/]#$%;B/,#;\xe1/#$+\")(\"'#&'#06*%;B/,#;\xe1/#$+\")(\"'#&'#&/'$8\":\u017b\" )(\"'#&'#"),R(";\xb9.# &;\xa0"),R("%;\xe3/Y#$%;A/,#;\xe3/#$+\")(\"'#&'#06*%;A/,#;\xe3/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),R("%;\xea/k#;./b$;\xed/Y$$%;B/,#;\xe4/#$+\")(\"'#&'#06*%;B/,#;\xe4/#$+\")(\"'#&'#&/#$+$)($'#(#'#(\"'#&'#"),R(";\xe5.; &;\xe6.5 &;\xe7./ &;\xe8.) &;\xe9.# &;\xa0"),R("%3\u017c\"\"5#7\u017d/:#;</1$;\xf0/($8#:\u017e#! )(#'#(\"'#&'#"),R("%3\u017f\"\"5%7\u0180/:#;</1$;T/($8#:\u0181#! )(#'#(\"'#&'#"),R("%3\u0182\"\"5(7\u0183/@#;</7$;\\.# &;Y/($8#:\u0184#! )(#'#(\"'#&'#"),R("%3\u0185\"\"5&7\u0186/:#;</1$;6/($8#:\u0187#! )(#'#(\"'#&'#"),R('%3\u0188""5%7\u0189/O#%;</3#$;!0#*;!&/#$+")("\'#&\'#." &"/\'$8":\u018a" )("\'#&\'#'),R("%;\xeb/G#;;/>$;6/5$;;/,$;\xec/#$+%)(%'#($'#(#'#(\"'#&'#"),R('%3\x92""5#7\xd3.# &;6/\' 8!:\u018b!! )'),R('%3\xb1""5#7\u018c.G &3\xb3""5#7\u018d.; &3\xb7""5#7\u018e./ &3\xb5""5$7\u018f.# &;6/\' 8!:\u0190!! )'),R('%;\xee/D#%;C/,#;\xef/#$+")("\'#&\'#." &"/#$+")("\'#&\'#'),R("%;U.) &;\\.# &;X/& 8!:\u0191! )"),R('%%;!." &"/[#;!." &"/M$;!." &"/?$;!." &"/1$;!." &"/#$+%)(%\'#($\'#(#\'#("\'#&\'#/\' 8!:\u0192!! )'),R('%%;!/?#;!." &"/1$;!." &"/#$+#)(#\'#("\'#&\'#/\' 8!:\u0193!! )'),R(";\xbe"),R('%;\x9e/^#$%;B/,#;\xf3/#$+")("\'#&\'#06*%;B/,#;\xf3/#$+")("\'#&\'#&/($8":\u0194"!!)("\'#&\'#'),R(";\xf4.# &;\xa0"),R('%2\u0195""6\u01957\u0196/L#;</C$2\u0197""6\u01977\u0198.) &2\u0199""6\u01997\u019a/($8#:\u019b#! )(#\'#("\'#&\'#'),R('%;\x9e/^#$%;B/,#;\xa0/#$+")("\'#&\'#06*%;B/,#;\xa0/#$+")("\'#&\'#&/($8":\u019c"!!)("\'#&\'#'),R("%;6/5#;0/,$;\xf7/#$+#)(#'#(\"'#&'#"),R("$;2.) &;4.# &;.0/*;2.) &;4.# &;.&"),R("$;%0#*;%&"),R("%;\xfa/;#28\"\"6879/,$;\xfb/#$+#)(#'#(\"'#&'#"),R('%3\u019d""5%7\u019e.) &3\u019f""5$7\u01a0/\' 8!:\u01a1!! )'),R('%;\xfc/J#%28""6879/,#;^/#$+")("\'#&\'#." &"/#$+")("\'#&\'#'),R("%;\\.) &;X.# &;\x82/' 8!:\u01a2!! )"),R(';".S &;!.M &2F""6F7G.A &2J""6J7K.5 &2H""6H7I.) &2N""6N7O'),R('2L""6L7M.\x95 &2B""6B7C.\x89 &2<""6<7=.} &2R""6R7S.q &2T""6T7U.e &2V""6V7W.Y &2P""6P7Q.M &2@""6@7A.A &2D""6D7E.5 &22""6273.) &2>""6>7?'),R('%;\u0100/b#28""6879/S$;\xfb/J$%2\u01a3""6\u01a37\u01a4/,#;\xec/#$+")("\'#&\'#." &"/#$+$)($\'#(#\'#("\'#&\'#'),R('%3\u01a5""5%7\u01a6.) &3\u01a7""5$7\u01a8/\' 8!:\u01a1!! )'),R('%;\xec/O#3\xb1""5#7\xb2.6 &3\xb3""5#7\xb4.* &$;+0#*;+&/\'$8":\u01a9" )("\'#&\'#'),R("%;\u0104/\x87#2F\"\"6F7G/x$;\u0103/o$2F\"\"6F7G/`$;\u0103/W$2F\"\"6F7G/H$;\u0103/?$2F\"\"6F7G/0$;\u0105/'$8):\u01aa) )()'#(('#(''#(&'#(%'#($'#(#'#(\"'#&'#"),R("%;#/>#;#/5$;#/,$;#/#$+$)($'#(#'#(\"'#&'#"),R("%;\u0103/,#;\u0103/#$+\")(\"'#&'#"),R("%;\u0103/5#;\u0103/,$;\u0103/#$+#)(#'#(\"'#&'#"),R("%;\x84/U#;'/L$;\x92/C$;'/:$;\x90/1$; .\" &\"/#$+&)(&'#(%'#($'#(#'#(\"'#&'#"),R('%2\u01ab""6\u01ab7\u01ac.) &2\u01ad""6\u01ad7\u01ae/w#;0/n$;\u0108/e$$%;B/2#;\u0109.# &;\xa0/#$+")("\'#&\'#0<*%;B/2#;\u0109.# &;\xa0/#$+")("\'#&\'#&/#$+$)($\'#(#\'#("\'#&\'#'),R(";\x99.# &;L"),R("%2\u01af\"\"6\u01af7\u01b0/5#;</,$;\u010a/#$+#)(#'#(\"'#&'#"),R("%;D/S#;,/J$2:\"\"6:7;/;$;,.# &;T/,$;E/#$+%)(%'#($'#(#'#(\"'#&'#")],h=0,u=0,l=[{line:1,column:1}],d=0,p=[],g=0;if("startRule"in t){if(!(t.startRule in n))throw new Error("Can't start parsing from rule \""+t.startRule+'".');o=n[t.startRule]}function f(){return e.substring(u,h)}function m(){return S(u,h)}function T(e,t){return{type:"literal",text:e,ignoreCase:t}}function E(e,t,i){return{type:"class",parts:e,inverted:t,ignoreCase:i}}function _(t){var i,s=l[t];if(s)return s;for(i=t-1;!l[i];)i--;for(s={line:(s=l[i]).line,column:s.column};i<t;)10===e.charCodeAt(i)?(s.line++,s.column=1):s.column++,i++;return l[t]=s,s}function S(e,t){var i=_(e),s=_(t);return{start:{offset:e,line:i.line,column:i.column},end:{offset:t,line:s.line,column:s.column}}}function v(e){h<d||(h>d&&(d=h,p=[]),p.push(e))}function C(e,t,i){return new s(s.buildMessage(e,t),e,t,i)}function R(e){var t,i=new Array(e.length);for(t=0;t<e.length;t++)i[t]=e.charCodeAt(t)-32;return i}if(t.data={},(i=function t(i){for(var s,n,o=c[i],l=0,d=[],p=o.length,f=[],m=[];;){for(;l<p;)switch(o[l]){case 0:m.push(a[o[l+1]]),l+=2;break;case 1:m.push(void 0),l++;break;case 2:m.push(null),l++;break;case 3:m.push(r),l++;break;case 4:m.push([]),l++;break;case 5:m.push(h),l++;break;case 6:m.pop(),l++;break;case 7:h=m.pop(),l++;break;case 8:m.length-=o[l+1],l+=2;break;case 9:m.splice(-2,1),l++;break;case 10:m[m.length-2].push(m.pop()),l++;break;case 11:m.push(m.splice(m.length-o[l+1],o[l+1])),l+=2;break;case 12:m.push(e.substring(m.pop(),h)),l++;break;case 13:f.push(p),d.push(l+3+o[l+1]+o[l+2]),m[m.length-1]?(p=l+3+o[l+1],l+=3):(p=l+3+o[l+1]+o[l+2],l+=3+o[l+1]);break;case 14:f.push(p),d.push(l+3+o[l+1]+o[l+2]),m[m.length-1]===r?(p=l+3+o[l+1],l+=3):(p=l+3+o[l+1]+o[l+2],l+=3+o[l+1]);break;case 15:f.push(p),d.push(l+3+o[l+1]+o[l+2]),m[m.length-1]!==r?(p=l+3+o[l+1],l+=3):(p=l+3+o[l+1]+o[l+2],l+=3+o[l+1]);break;case 16:m[m.length-1]!==r?(f.push(p),d.push(l),p=l+2+o[l+1],l+=2):l+=2+o[l+1];break;case 17:f.push(p),d.push(l+3+o[l+1]+o[l+2]),e.length>h?(p=l+3+o[l+1],l+=3):(p=l+3+o[l+1]+o[l+2],l+=3+o[l+1]);break;case 18:f.push(p),d.push(l+4+o[l+2]+o[l+3]),e.substr(h,a[o[l+1]].length)===a[o[l+1]]?(p=l+4+o[l+2],l+=4):(p=l+4+o[l+2]+o[l+3],l+=4+o[l+2]);break;case 19:f.push(p),d.push(l+4+o[l+2]+o[l+3]),e.substr(h,a[o[l+1]].length).toLowerCase()===a[o[l+1]]?(p=l+4+o[l+2],l+=4):(p=l+4+o[l+2]+o[l+3],l+=4+o[l+2]);break;case 20:f.push(p),d.push(l+4+o[l+2]+o[l+3]),a[o[l+1]].test(e.charAt(h))?(p=l+4+o[l+2],l+=4):(p=l+4+o[l+2]+o[l+3],l+=4+o[l+2]);break;case 21:m.push(e.substr(h,o[l+1])),h+=o[l+1],l+=2;break;case 22:m.push(a[o[l+1]]),h+=a[o[l+1]].length,l+=2;break;case 23:m.push(r),0===g&&v(a[o[l+1]]),l+=2;break;case 24:u=m[m.length-1-o[l+1]],l+=2;break;case 25:u=h,l++;break;case 26:for(s=o.slice(l+4,l+4+o[l+3]),n=0;n<o[l+3];n++)s[n]=m[m.length-1-s[n]];m.splice(m.length-o[l+2],o[l+2],a[o[l+1]].apply(null,s)),l+=4+o[l+3];break;case 27:m.push(t(o[l+1])),l+=2;break;case 28:g++,l++;break;case 29:g--,l++;break;default:throw new Error("Invalid opcode: "+o[l]+".")}if(!(f.length>0))break;p=f.pop(),l=d.pop()}return m[0]}(o))!==r&&h===e.length)return i;throw i!==r&&h<e.length&&v({type:"end"}),C(p,d<e.length?e.charAt(d):null,d<e.length?S(d,d+1):S(d,d))}}},function(e,t,i){"use strict";e.exports=function(e){function t(e,t){var i,s,r=[],n=e.split(/\r\n/);for(i=0;i<n.length;){var o=n[i];if(/^m=(?:audio|video)/.test(o))s={index:i,stripped:[]},r.push(s);else if(s){var a=/^a=rtpmap:(\d+) ([^/]+)\//.exec(o);if(a&&t===a[2]){n.splice(i,1),s.stripped.push(a[1]);continue}}i++}for(i=0;i<r.length;i++){for(var c=n[r[i].index].split(" "),h=3;h<c.length;)-1===r[i].stripped.indexOf(c[h])?h++:c.splice(h,1);n[r[i].index]=c.join(" ")}return n.join("\r\n")}return{stripTcpCandidates:function(t){return t.sdp=t.sdp.replace(/^a=candidate:\d+ \d+ tcp .*?\r\n/gim,""),e.Utils.Promise.resolve(t)},stripTelephoneEvent:function(i){return i.sdp=t(i.sdp,"telephone-event"),e.Utils.Promise.resolve(i)},cleanJitsiSdpImageattr:function(t){return t.sdp=t.sdp.replace(/^(a=imageattr:.*?)(x|y)=\[0-/gm,"$1$2=[1:"),e.Utils.Promise.resolve(t)},stripG722:function(i){return i.sdp=t(i.sdp,"G722"),e.Utils.Promise.resolve(i)},stripRtpPayload:function(i){return function(s){return s.sdp=t(s.sdp,i),e.Utils.Promise.resolve(s)}}}}},function(e,t,i){"use strict";(function(t){e.exports=function(e){var i={STATUS_NULL:0,STATUS_NEW:1,STATUS_CONNECTING:2,STATUS_CONNECTED:3,STATUS_COMPLETED:4},s=function(s){if(s.media.remote.video?this.video=!0:this.video=!1,s.media.remote.audio?this.audio=!0:this.audio=!1,!this.audio&&!this.video)throw new Error("At least one remote audio or video element is required for Simple.");this.options=s;var r=t.navigator.userAgent.toLowerCase(),n=!1,o=!1;r.indexOf("safari")>-1&&r.indexOf("chrome")<0?n=!0:r.indexOf("firefox")>-1&&r.indexOf("chrome")<0&&(o=!0);var a={constraints:{},peerConnectionOptions:{rtcConfiguration:{iceTransportPolicy:"all",iceCandidatePoolSize:10,iceServers:[{urls:["stun:stun.voipcheap.co.uk:3478"]}]}}};return n&&(a.modifiers=[e.Web.Modifiers.stripG722]),o&&(a.alwaysAcquireMediaFirst=!0),this.options.ua.uri||(this.anonymous=!0),this.ua=new e.UA({uri:this.options.ua.uri,authorizationUser:this.options.ua.authorizationUser,password:this.options.ua.password,displayName:this.options.ua.displayName,userAgentString:this.options.ua.userAgentString,register:!0,registerExpires:this.options.ua.registerExpires,sessionDescriptionHandlerFactoryOptions:a,transportOptions:{traceSip:this.options.ua.traceSip,wsServers:this.options.ua.wsServers}}),this.state=i.STATUS_NULL,this.logger=this.ua.getLogger("sip.simple"),this.ua.on("registered",function(){this.emit("registered",this.ua)}.bind(this)),this.ua.on("unregistered",function(){this.emit("unregistered",this.ua)}.bind(this)),this.ua.on("failed",function(){this.emit("unregistered",this.ua)}.bind(this)),this.ua.on("invite",function(e){if(this.state!==i.STATUS_NULL&&this.state!==i.STATUS_COMPLETED)return this.logger.warn("Rejecting incoming call. Simple only supports 1 call at a time"),void e.reject();this.session=e,this.setupSession(),this.emit("ringing",this.session)}.bind(this)),this.ua.on("message",function(e){this.emit("message",e)}.bind(this)),this};return s.prototype=Object.create(e.EventEmitter.prototype),s.C=i,s.prototype.call=function(e){if(this.ua&&this.checkRegistration()){if(this.state===i.STATUS_NULL||this.state===i.STATUS_COMPLETED)return this.options.media.remote.audio&&(this.options.media.remote.audio.autoplay=!0),this.options.media.remote.video&&(this.options.media.remote.video.autoplay=!0),this.options.media.local&&this.options.media.local.video&&(this.options.media.local.video.autoplay=!0,this.options.media.local.video.volume=0),this.session=this.ua.invite(e,{sessionDescriptionHandlerOptions:{constraints:{audio:this.audio,video:this.video}}}),this.setupSession(),this.session;this.logger.warn("Cannot make more than a single call with Simple")}else this.logger.warn("A registered UA is required for calling")},s.prototype.answer=function(){if(this.state===i.STATUS_NEW||this.state===i.STATUS_CONNECTING)return this.options.media.remote.audio&&(this.options.media.remote.audio.autoplay=!0),this.options.media.remote.video&&(this.options.media.remote.video.autoplay=!0),this.session.accept({sessionDescriptionHandlerOptions:{constraints:{audio:this.audio,video:this.video}}});this.logger.warn("No call to answer")},s.prototype.reject=function(){if(this.state===i.STATUS_NEW||this.state===i.STATUS_CONNECTING)return this.session.reject();this.logger.warn("Call is already answered")},s.prototype.hangup=function(){if(this.state===i.STATUS_CONNECTED||this.state===i.STATUS_CONNECTING||this.state===i.STATUS_NEW)return this.state!==i.STATUS_CONNECTED?this.session.cancel():this.session.bye();this.logger.warn("No active call to hang up on")},s.prototype.hold=function(){if(this.state===i.STATUS_CONNECTED&&!this.session.local_hold)return this.mute(),this.logger.log("Placing session on hold"),this.session.hold();this.logger.warn("Cannot put call on hold")},s.prototype.unhold=function(){if(this.state===i.STATUS_CONNECTED&&this.session.local_hold)return this.unmute(),this.logger.log("Placing call off hold"),this.session.unhold();this.logger.warn("Cannot unhold a call that is not on hold")},s.prototype.mute=function(){this.state===i.STATUS_CONNECTED?(this.logger.log("Muting Audio"),this.toggleMute(!0),this.emit("mute",this)):this.logger.warn("An acitve call is required to mute audio")},s.prototype.unmute=function(){this.state===i.STATUS_CONNECTED?(this.logger.log("Unmuting Audio"),this.toggleMute(!1),this.emit("unmute",this)):this.logger.warn("An active call is required to unmute audio")},s.prototype.sendDTMF=function(e){this.state===i.STATUS_CONNECTED?(this.logger.log("Sending DTMF tone: "+e),this.session.dtmf(e)):this.logger.warn("An active call is required to send a DTMF tone")},s.prototype.message=function(e,t){this.ua&&this.checkRegistration()?e&&t?this.ua.message(e,t):this.logger.warn("A destination and message are required to send a message"):this.logger.warn("A registered UA is required to send a message")},s.prototype.checkRegistration=function(){return this.anonymous||this.ua&&this.ua.isRegistered()},s.prototype.setupRemoteMedia=function(){var e,i=this.session.sessionDescriptionHandler.peerConnection;i.getReceivers?(e=new t.window.MediaStream,i.getReceivers().forEach(function(t){var i=t.track;i&&e.addTrack(i)})):e=i.getRemoteStreams()[0],this.video?(this.options.media.remote.video.srcObject=e,this.options.media.remote.video.play().catch(function(){this.logger.log("play was rejected")}.bind(this))):this.audio&&(this.options.media.remote.audio.srcObject=e,this.options.media.remote.audio.play().catch(function(){this.logger.log("play was rejected")}.bind(this)))},s.prototype.setupLocalMedia=function(){if(this.video&&this.options.media.local&&this.options.media.local.video){var e,i=this.session.sessionDescriptionHandler.peerConnection;i.getSenders?(e=new t.window.MediaStream,i.getSenders().forEach(function(t){var i=t.track;i&&"video"===i.kind&&e.addTrack(i)})):e=i.getLocalStreams()[0],this.options.media.local.video.srcObject=e,this.options.media.local.video.volume=0,this.options.media.local.video.play()}},s.prototype.cleanupMedia=function(){this.video&&(this.options.media.remote.video.srcObject=null,this.options.media.remote.video.pause(),this.options.media.local&&this.options.media.local.video&&(this.options.media.local.video.srcObject=null,this.options.media.local.video.pause())),this.audio&&(this.options.media.remote.audio.srcObject=null,this.options.media.remote.audio.pause())},s.prototype.setupSession=function(){this.state=i.STATUS_NEW,this.emit("new",this.session),this.session.on("progress",this.onProgress.bind(this)),this.session.on("accepted",this.onAccepted.bind(this)),this.session.on("rejected",this.onEnded.bind(this)),this.session.on("failed",this.onFailed.bind(this)),this.session.on("terminated",this.onEnded.bind(this))},s.prototype.destroyMedia=function(){this.session.sessionDescriptionHandler.close()},s.prototype.toggleMute=function(e){var t=this.session.sessionDescriptionHandler.peerConnection;t.getSenders?t.getSenders().forEach(function(t){t.track&&(t.track.enabled=!e)}):t.getLocalStreams().forEach(function(t){t.getAudioTracks().forEach(function(t){t.enabled=!e}),t.getVideoTracks().forEach(function(t){t.enabled=!e})})},s.prototype.onAccepted=function(){this.state=i.STATUS_CONNECTED,this.emit("connected",this.session),this.setupLocalMedia(),this.setupRemoteMedia(),this.session.sessionDescriptionHandler.on("addTrack",function(){this.logger.log("A track has been added, triggering new remoteMedia setup"),this.setupRemoteMedia()}.bind(this)),this.session.sessionDescriptionHandler.on("addStream",function(){this.logger.log("A stream has been added, trigger new remoteMedia setup"),this.setupRemoteMedia()}.bind(this)),this.session.on("hold",function(){this.emit("hold",this.session)}.bind(this)),this.session.on("unhold",function(){this.emit("unhold",this.session)}.bind(this)),this.session.on("dtmf",function(e){this.emit("dtmf",e)}.bind(this)),this.session.on("bye",this.onEnded.bind(this))},s.prototype.onProgress=function(){this.state=i.STATUS_CONNECTING,this.emit("connecting",this.session)},s.prototype.onFailed=function(){this.onEnded()},s.prototype.onEnded=function(){this.state=i.STATUS_COMPLETED,this.emit("ended",this.session),this.cleanupMedia()},s}}).call(this,i(0))},function(e,t,i){"use strict";(function(t){var s=t.window||t;function r(e,t){if(null!=e){var i=t.charAt(0).toUpperCase()+t.slice(1),s=[t,"webkit"+i,"moz"+i];for(var r in s){var n=e[s[r]];if(n)return n.bind(e)}}}e.exports={WebSocket:s.WebSocket,Transport:i(1),open:s.open,Promise:s.Promise,timers:s,console:s.console||{debug:function(){},log:function(){},warn:function(){},error:function(){}},addEventListener:r(s,"addEventListener"),removeEventListener:r(s,"removeEventListener")}}).call(this,i(0))}])});(function(container){var entity,apiCalls,apiHandler,external;var exports={init:function(){entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');apiHandler=container.get('Textmagic::ChatBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);external=container.get('Textmagic::ChatBundle::Component::External');},methods:{markAsRead:function(id){entity('Chats').findById(id).set('unread',0);apiCalls().Chats.markAsRead(id);},markAsUnRead:function(id){var chat=entity('Chats').findById(id);if(chat.get('unread').raw==0){chat.set('unread',1);apiCalls().Chats.markAsUnRead(id);}},mute:function(id){entity('Chats').findById(id).set('mute',1);apiCalls().Chats.mute(id)},unmute:function(id){entity('Chats').findById(id).set('mute',0).set('mutedUntil',null);apiCalls().Chats.unmute({ids:id.toString(),all:0});},pin:function(id){entity('Chats').findById(id).set('pinned',true);apiCalls().Chats.pin(id);entity('Chats').sortByDateTimeDesc();},pinoff:function(id){entity('Chats').findById(id).set('pinned',false);apiCalls().Chats.pinoff(id);entity('Chats').sortByDateTimeDesc();},remove:function(id){external.acceptModal('Delete chat confirmation','All messages contained in this chat will be <b>deleted permanently from all pages<\/b> and cannot be restored in future.','Delete',function(){apiCalls().Chats.remove({ids:id.toString(),all:0},{chatId:id});});},close:function(id){apiCalls().Chats.close(id);},reopen:function(id){external.acceptModal('Reopen chat confirmation','Are you sure you want to reopen this chat?','Reopen',function(){apiCalls().Chats.reopen(id);});}}};container.register('Textmagic::ChatBundle::Actions::Chat',exports);})(global.AHServiceContainer);(function(container){var entity,apiCalls,sync;var exports={};var showAuthFailureError=function(){entity('AppState').authFailureWarning();}
exports.initHandlers=function(options){var user=entity('Textmagic::CoreBundle::User');sync.setAuthFailureHandler(function(failureCount){if(failureCount>1){showAuthFailureError();return;}
apiCalls.getToken(function(token){user.set('token',token);sync.reconnect(options.sync.url,user.getUsername(),token,'textmagic_ws_chat');},showAuthFailureError);});apiCalls.setAuthFailureHandler(function(params,handler,opt,requestKey){apiCalls.getToken(function(token){user.set('token',token);params['headers']['X-TM-Key']=token;var jqxhr=apiCalls.replayAction(params,requestKey);if(handler.hasOwnProperty('done')){jqxhr.done(function(r){handler.done(r,opt)});}
jqxhr.fail(showAuthFailureError);if(handler.hasOwnProperty('always')){jqxhr.always(function(){jqxhr.requestKey=null;handler.always(opt)});}},showAuthFailureError);});}
exports.init=function(){entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls');sync=container.get('Textmagic::ChatBundle::Api::Sync');};container.register('Textmagic::ChatBundle::Api::AuthFailureHandler',exports);})(global.AHServiceContainer);(function(container){var entity,apiCalls,apiHandler,external,dateFormat,externalCore,mmsService,textSetter,file;var nop=function(){};var echo=function(){console.log(this.toString(),arguments)};var nopHandler={done:nop,fail:nop,always:nop};var echoHandler=function(name){var n='API Handler '+name;return{done:echo.bind(n+'::done'),fail:echo.bind(n+'::fail'),always:echo.bind(n+'::always')}};var chatsListHandler={done:function(res,opt){var appState=entity('AppState');var chats=entity('Chats');var statusPanel=appState.get('visibility.chatPanel.closed').raw?'c':'a';if(opt.status!=statusPanel){return;}
appState.set('spinner',false);chats.load(res);if(!res.resources.length&&!chats.get('resources').raw.length){appState.resetChatPanelVisibility({newChat:true,closed:appState.get('visibility.chatPanel.closed').raw,subline:!appState.get('unreadOnly').raw});appState.resetCheckedChats();global.Vue.nextTick(function(){document.getElementById('input-chat-new-contact-serach').focus();});}
if(res.page>1){return;}
appState.setActiveChat(opt.id);if(opt.id&&opt.id>0){var chatRaw=chats.findById(opt.id).raw;var voice=entity('VoiceCall');voice.set('chat',JSON.parse(JSON.stringify(chatRaw)));}},fail:function(res){if(res.status==401){var appState=entity('AppState');appState.showAlert('warning',res.responseJSON.message);}},always:function(res){entity('Chats').set('spinner',false);}};var messagesListHandler={done:function(res,opt){var appState=entity('AppState');var messages=entity('Messages');var ownedBy={ownedBy:'Chats',key:opt.chat.id};var isCheckedAllMessages=appState.isCheckedAllMessages();if(opt.reset){messages.reset(ownedBy);}
messages.load(res,ownedBy);if(res.page==1&&!opt.reset){appState.setActiveChat(opt.chat.id);}
if(isCheckedAllMessages){var chatId=appState.getActiveChatId();var ids=messages.messagesIds(chatId);appState.resetCheckedMessages(ids);}
appState.messagesChanged();},fail:function(res){},always:function(res){entity('Messages').set('spinner',false);}};var chatsGetByPhoneHandler={done:function(res,status){var appState=entity('AppState');var chats=entity('Chats');var id=res.id;var ownedBy={ownedBy:'Chats',key:id};var chat=chats.findById(id).raw;var isCrossStatusPanelState=(!appState.isClosedChatMode()&&status=='c')||(appState.isClosedChatMode()&&status=='a');if(isCrossStatusPanelState){entity('Chats').reset().fetch(status,id);}else{entity('Chats').refreshList(status,id);}
entity('AppState').setMessagesScrollDown(true).resetChatPanelVisibility({newChat:true,closed:status=='c'}).resetCheckedChats().cancelChatSearch();appState.toggleSubline(false);},fail:function(res){},always:function(res){}};var refreshChatDataHandler={done:function(res){var chats=entity('Chats');var chat=chats.findById(res.id);if(!chat.raw){return;};chat.merge(res,{deep:true});chats.sortByDateTimeDesc();},fail:nop,always:nop};var refreshListHandler={done:function(res,chatId){var appState=entity('AppState');var chats=entity('Chats');if(!res.hasOwnProperty('resources')||chats.get('spinner').raw){return;}
var oldIds=[];var newIds=[];var idsToAdd=[];var idsToDelete=[];var rowsLoaded=entity('Chats').rowsLoaded();oldIds=chats.getResources().map(function(chat){return chat.id});newIds=res.resources.map(function(chat){return chat.id});var difference=function(source,target){return source.filter(function(current){return target.indexOf(current)===-1;});};idsToAdd=difference(newIds,oldIds);idsToDelete=difference(oldIds,newIds);var i=0;res.resources.every(function(newChat,index){i++;if(idsToAdd.indexOf(newChat.id)!==-1){chats.get('resources').insert(newChat,index);return true;}
if(idsToDelete.indexOf(newChat.id)!==-1){chats.removeById(newChat.id);return true;}
var chat=chats.findById(newChat.id);if(!chat.raw){return true;}
chat.merge(newChat,{deep:true});return true;});var prohibitedDeletionId=null;if(appState.get('unreadOnly')){prohibitedDeletionId=appState.getActiveChatId();}
idsToDelete.forEach(function(id){if(prohibitedDeletionId!=id){chats.removeById(id);}});chats.sortByDateTimeDesc();chats.set('pageLoaded',1);if(chatId){appState.setActiveChat(chatId);appState.set('messagesScrollUp',true);var chatRaw=chats.findById(chatId).raw;var voice=entity('VoiceCall');voice.set('chat',JSON.parse(JSON.stringify(chatRaw)));}},fail:nop,always:nop};var changeStatusHandler={done:function(res,opt){var chats=entity('Chats');var appState=entity('AppState');chats.removeById(opt.chatId);var ownedBy={ownedBy:'Chats',key:opt.chatId};entity('Messages').reset(ownedBy);if(opt.chatId==appState.getActiveChatId()){appState.setActiveChat(-1);}},fail:nop,always:nop};var chatsRemoveHandler={done:function(res,opt){if(!opt||(opt.ids&&opt.ids.length==1&&!opt.all)||opt.chatId){notyMessage('Chat has been deleted.');}else{notyMessage('Chats have been deleted.');}
if(opt.chatId){entity('Chats').removeById(opt.chatId);entity('Messages').reset({ownedBy:'Chats',key:opt.chatId});}
var chats=entity('Chats');var appState=entity('AppState');if(opt.chatId==appState.getActiveChatId()){appState.setActiveChat(-1);}},fail:function(res){var appState=entity('AppState');appState.showAlert('warning',res.responseJSON.message);},always:nop};var messsagesRemoveHandler={done:function(res,opt){var state=entity('AppState');opt.map(function(id){entity('Messages').removeById(id);if(state.isSearchResult()){entity('MessagesSearchResult').removeById(id);}});var status=(state.isClosedChatMode()?'c':null);entity('Chats').refreshList(status);state.messagesChanged();var chatId=state.getActiveChatId();var messages=entity('Messages');var ownedBy={ownedBy:'Chats',key:chatId};if(messages.resourcesLength(ownedBy)==0){var prev=state.get('visibility.prevPanel').raw;var panels={};panels[prev]=true;state.resetMessagesPanelVisibility(panels);}},fail:function(res){var appState=entity('AppState');appState.showAlert('warning',res.responseJSON.message);},always:nop};var messagesSendHandler={done:function(res,message){var chatId=message.chatId;var chat=entity('Chats').findById(chatId).raw;if(chat){chat.lastMessage=message.text;}
entity('Chats').refreshList();entity('AttachList').removeAll();apiCalls().Messages.refreshSentMessage(res.messageId,message);},fail:function(xhr,message){var messages=entity('Messages');var state=entity('AppState');var text='Unknown error';var chatId=message.chatId;var chat=entity('Chats').findById(chatId).raw;if(chat&&chat.contact&&xhr.status!=0){text=parseFormErrors(xhr.responseJSON);if(text.substr(0,13)=='Invalid phone'){entity('Chats').findById(chatId).set('contact',null);apiCalls().Chats.refreshChatData(chatId);messages.removeById(message.id);apiCalls().Messages.send(chatId,message.text);state.messagesChanged();state.set('sendButtonDisabled',false);return;}}
var message=messages.findById(message.id);if(message.raw){message.set('status','ff');}
state.messagesChanged();state.set('sendButtonDisabled',false);if(xhr.status==0){text='Network error. Could not connect to the server!';}else{text=parseFormErrors(xhr.responseJSON);}
state.showAlert('warning',text);},always:nop};var muteHandler={done:function(res,message){if(!res)return;var chatId=res.id;apiCalls().Chats.refreshChatData(chatId);},fail:nop,always:nop};var messagesScheduleHandler={done:function(res,opt){var state=entity('AppState'),attachList=entity('AttachList');state.showAlert('success','Message is scheduled. Next send date is on '
+opt.labelTime
+'.  <a target="_blank" href="\/online\/messages\/scheduled\/detail\/'+res.id+'">View details<\/a>');attachList.removeAll();opt.component.$emit('clearTextarea');},fail:function(xhr,message){var state=entity('AppState');var text='Unknown error';if(xhr.status==0){text='Network error. Could not connect to the server!';}else{text=xhr.responseJSON.errors.common[0];}
state.showAlert('warning',text);},always:function(){var state=entity('AppState');state.set('sendButtonDisabled',false);}};var refreshSentMessageHandler={done:function(res,message){var messages=entity('Messages');var message=messages.findById(message.id);entity('AppState').set('sendButtonDisabled',false);if(!message.raw){return;};message.merge(res,{deep:true});entity('AppState').messagesChanged();},fail:nop,always:nop};var refreshUnreadCountHandler={done:function(res,opt){var value=parseInt(res.total,10);if(isNaN(value)){return;}
external.updateChatBadge(res.total);},fail:nop,always:nop};var pingHandler={done:function(res){var user=entity('Textmagic::CoreBundle::User');var nowLocal=dateFormat.getTimeUTC();var nowServer=dateFormat.getTimeUTC(res.utcDateTime);user.set('serverTimeVariance',nowLocal-nowServer);},fail:nop,always:nop};var messagesPricesHandler={done:function(res,opt){var appState=entity('AppState');appState.setPrices(res);}};var unblockContactHandler={done:function(res,opt){var state=entity('AppState');state.updateBlockedContactWarning(state.getActiveChatRaw());notyMessage('Contact has been unblocked.');},fail:nop,always:nop};var blockContactHandler={done:function(res,opt){var state=entity('AppState');var chat=entity('Chats').findById(opt.chatId).raw;if(chat&&chat.contact){chat.contact.blocked=true;}
state.updateBlockedContactWarning(state.getActiveChatRaw());notyMessage('Contact has been blocked.');},fail:nop,always:nop};var noteSaveHandler={done:function(res,message){externalCore.alert('success','Note has been created.');},fail:function(xhr,message){externalCore.alert('warning',xhr.responseJSON.errors.fields.note[0]);},always:nop};var noteUpdateHandler={done:function(res,message){externalCore.alert('success','Note has been updated.');},fail:function(xhr,message){externalCore.alert('warning',xhr.responseJSON.errors.fields.note[0]);},always:nop};var noteDeleteHandler={done:function(res,message){externalCore.alert('success','Note has been deleted.');},fail:function(xhr,message){externalCore.alert('warning','Error has been occurred while deleting note.');},always:nop};var unsubscribeContactHandler={done:function(res,opt){var state=entity('AppState');var chat=entity('Chats').findById(opt.chatId).raw;if(chat&&chat.contact){apiCalls().Chats.refreshChatData(chat.id);}
notyMessage('Contact has been successfully removed from your lists.');},fail:nop,always:nop};var parseFormErrors=function(xhr){if(typeof(xhr)!=='object'){return xhr;}
if(!xhr.hasOwnProperty('message')){return '';}
if(xhr.message==='Validation Failed'){var text='';if(xhr.hasOwnProperty('errors')){if(xhr.errors.hasOwnProperty('common')){text+=xhr.errors.common.join(' ');}
if(xhr.errors.hasOwnProperty('fields')){xhr.errors.fields.forEach(function(k,v){text+=v.join(' ');});}}
return text;}
return xhr.message;};var progress=function(e){var progress=0;if(!e.lengthComputable){progress=0;entity('AppState').set('progress',progress);return;}
var max=e.total;var current=e.loaded;var Percentage=(current*100)/max;progress=Math.round(Percentage);if(Percentage>=100){progress=0;}
entity('AppState').set('progress',progress);return;};var uploadAttachFileWithProgressHandler={progress:progress,done:function(data,opt){var link=window.location.protocol+'//'+window.location.host+'/'+data.href;textSetter('{'+link+'}');},fail:function(res,opt){var text;if(res.status==413){text='The selected file size exceeds the allowed limit. File size can be up to 10MB.';}
if(res.status==400){text=res.responseJSON.errors.fields.file[0];}
entity('AppState').showAlert('warning',text);},always:function(xhr,opt){entity('AppState').set('progress',0);}};var uploadMmsAttachFileWithProgressHandler={progress:progress,done:function(data,opt){var filePreviewUpload=entity('FilePreviewUpload');filePreviewUpload.set('type','mms');filePreviewUpload.set('file',data);if(entity('AttachList').sizeAll()+filePreviewUpload.getFileRaw().size>537600){entity('AppState').showAlert('warning','The maximum allowed file size is 525KB in total.');return;}
entity('AttachList').append(filePreviewUpload.getFileRaw());},fail:function(res,opt){var text;if(res.status==413){text='The selected file size exceeds the allowed limit. File size can be up to 525KB.';}
if(res.status==400){text=res.responseJSON.errors.fields.file[0];}
entity('AppState').showAlert('warning',text);},always:function(xhr,opt){entity('AppState').set('progress',0);}};var uploadAttachFileHandler={done:function(data,opt){entity('AttachUpload').set('alert.text','');entity('AttachUpload').set('alert.show',false);entity('AttachUpload').toggleModal(false,false);entity('FilePreviewUpload').set('type','attach');entity('FilePreviewUpload').set('file',data);entity('FilePreviewUpload').showModal();},fail:function(res,opt){var text;if(res.status==413){text='The selected file size exceeds the allowed limit. File size can be up to 10MB.';}
if(res.status==400){text=res.responseJSON.errors.fields.file[0];}
entity('AttachUpload').set('alert.text',text);entity('AttachUpload').set('alert.show',true);},always:function(xhr,opt){entity('AttachUpload').set('loader',false);}};var uploadMmsAttachFileHandler={done:function(data,opt){if(entity('AttachList').sizeAll()+data.size>537600){entity('MmsUpload').set('alert.text','The maximum allowed file size is 525KB in total.');entity('MmsUpload').set('alert.show',true);return;}
entity('MmsUpload').set('alert.text','');entity('MmsUpload').set('alert.show',false);entity('MmsUpload').toggleModal(false,false);entity('FilePreviewUpload').set('type','mms');entity('FilePreviewUpload').set('file',data);entity('FilePreviewUpload').showModal();},fail:function(res,opt){var text;if(res.status==413){text='The selected file size exceeds the allowed limit. File size can be up to 525KB.';}
if(res.status==400){text=res.responseJSON.errors.fields.file[0];}
entity('MmsUpload').set('alert.text',text);entity('MmsUpload').set('alert.show',true);},always:function(xhr,opt){entity('MmsUpload').set('loader',false);}};var exports={setInsertLinkDependency:function(setter){textSetter=setter;},nop:nopHandler,ping:pingHandler,Chats:{Bulk:{reopen:{done:function(){entity('Chats').reset().fetch('c');},fail:nop,always:nop},close:{done:function(){entity('Chats').reset().fetch();},fail:nop,always:nop},remove:{done:function(){var closed=entity('AppState').get('visibility.chatPanel.closed').raw;entity('Chats').reset().fetch(closed?'c':'a');},fail:function(res){var appState=entity('AppState');appState.showAlert('warning',res.responseJSON.message);},always:nop}},list:chatsListHandler,remove:chatsRemoveHandler,pin:nopHandler,pinoff:nopHandler,mute:muteHandler,unmute:nopHandler,markAsRead:nopHandler,markAsUnRead:nopHandler,close:changeStatusHandler,reopen:changeStatusHandler,getByPhone:chatsGetByPhoneHandler,search:{done:function(res){entity('ChatsSearchResult').reset().load(res);if(res.resources.length==0){entity('AppState').set('visibility.chatList','empty');}else{entity('AppState').set('visibility.chatList','search-results');}},fail:nop,always:nop},messagesRemove:messsagesRemoveHandler,downloadPdf:echoHandler('downloadPdf'),refreshUnreadCount:refreshUnreadCountHandler,refreshChatData:refreshChatDataHandler,refreshList:refreshListHandler},Messages:{uploadAttachFileWithProgress:uploadAttachFileWithProgressHandler,uploadMmsAttachFileWithProgress:uploadMmsAttachFileWithProgressHandler,uploadAttachFile:uploadAttachFileHandler,uploadMmsAttachFile:uploadMmsAttachFileHandler,list:messagesListHandler,prices:messagesPricesHandler,send:messagesSendHandler,schedule:messagesScheduleHandler,refreshSentMessage:refreshSentMessageHandler,search:{done:function(res){var messages=entity('MessagesSearchResult');var state=entity('AppState');var isCheckedAllMessages=state.isCheckedAllMessages();messages.load(res);if(isCheckedAllMessages){var ids=messages.messagesIds();state.resetCheckedMessages(ids);}
if(res.resources.length==0){state.set('visibility.messagesList','empty');}else{state.set('visibility.messagesList','search-results');}},fail:nop,always:function(res){entity('MessagesSearchResult').set('spinner',false);}}},Contacts:{Bulk:{unblock:unblockContactHandler},block:blockContactHandler,unsubscribe:unsubscribeContactHandler},CustomFields:{list:false},Countries:{list:false},Autocomplete:{get:false},User:{setNotifications:{done:function(res,data){var user=entity('Textmagic::CoreBundle::User');user.set('dnPlaySound',data.playSound);user.set('dnShowNotifications',data.showNotifications);user.set('dnShowText',data.showText);user.set('dnSoundId',data.soundId);user.set('dnSoundUrl',data.soundId?global.jQuery('#notificationSettingsForm input[name="sound"][value="custom"]').data('path'):null);external.initSounds({message:{forwardAudioId:user.get('dnSoundId').raw,path:user.get('dnSoundUrl').raw}});},fail:nop,always:nop}},Calls:{},Notes:{add:noteSaveHandler,put:noteUpdateHandler,delete:noteDeleteHandler}};exports.init=function(){entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(this);external=container.get('Textmagic::ChatBundle::Component::External');file=container.get('Textmagic::CoreBundle::Utils::File');externalCore=container.get('Textmagic::CoreBundle::Component::External');mmsService=container.get('Textmagic::CoreBundle::Services::MMS');dateFormat=container.get('Textmagic::ChatBundle::Utils::Date');apiHandler=container.get('Textmagic::CoreBundle::Api::DefaultHandler');exports.CustomFields.list=apiHandler.CustomFields.list;exports.Countries.list=apiHandler.Countries.list;exports.Autocomplete.get=apiHandler.Autocomplete.get;exports.Calls.price=apiHandler.Calls.price;};container.register('Textmagic::ChatBundle::Api::Handlers',exports);})(global.AHServiceContainer);(function(container){var exports={};var io;var socket;var entity;var external;var apiCalls,apiHandler;var authFailureCount=0;var authFailureHandler;var lastSignalsTime={'messageSent':0};var lastSignalsTerminationCall={'messageSent':false};exports.init=function(){entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');apiHandler=container.get('Textmagic::ChatBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);external=container.get('Textmagic::ChatBundle::Component::External');io=external.getSocketIo();};exports.connect=function(url,username,token,appId){if(socket||!io){return false;}
socket=io.connect(url,{query:'login='+username
+'&appId='+appId,forceNew:true,auth:{token:token,}});socket.on('internal',function(data){exports.parseSignal(data);});socket.on('connect',function(data){authFailureCount=0;entity('AppState').setSyncConnected(true);});socket.on("connect_error",function(error){if(error.message=='Unauthorized'){authFailureCount++;authFailureHandler(authFailureCount);}});};exports.disconnect=function(){socket.disconnect();socket=null;entity('AppState').setSyncConnected(false);};exports.reconnect=function(url,username,token,appId){exports.disconnect();exports.connect(url,username,token,appId);}
exports.setAuthFailureHandler=function(handler){authFailureHandler=handler;}
var switchTabToOpenChats=function(id){var state=entity('AppState');entity('Chats').reset().fetch('a',id);state.cancelChatSearch();state.cancelMessagesSearch();state.resetChatPanelVisibility({newChat:true});state.resetCheckedChats();state.messagesChanged();};var isLastSuccessSignalTimeoutExpire=function(signal,timeout){var now=Date.now();return now-lastSignalsTime[signal]>timeout;};var setSuccessSignalTime=function(signal){lastSignalsTime[signal]=Date.now();};var needTerminationCall=function(signal){return lastSignalsTerminationCall[signal];};var setTerminationCall=function(signal,value){return lastSignalsTerminationCall[signal]=value;};var throttle=function(signal,timeout,callable){if(!isLastSuccessSignalTimeoutExpire(signal,timeout)){setTerminationCall(signal,true);return;}
setTerminationCall(signal,false);setSuccessSignalTime(signal);callable();setTimeout(function(){if(needTerminationCall(signal)){throttle(signal,timeout,callable);}},timeout);};exports.parseSignal=function(data){if(!data.hasOwnProperty('header')||!data.hasOwnProperty('payload')){console.log('Malformed signal');return false;}
console.log(data);if(data.payload.hasOwnProperty('ids')){data.payload.ids.forEach(function(id){switch(data.header.type){case 'chatPinned':if(entity('Chats').findById(id).raw){entity('Chats').findById(id).set('pinned',true);entity('Chats').sortByDateTimeDesc();}
break;case 'chatUnpinned':if(entity('Chats').findById(id).raw){entity('Chats').findById(id).set('pinned',false);entity('Chats').sortByDateTimeDesc();}
break;case 'chatMuted':if(entity('Chats').findById(id).raw){entity('Chats').findById(id).set('mute',1);}
break;case 'chatUnmuted':if(entity('Chats').findById(id).raw){entity('Chats').findById(id).set('mute',0);}
break;case 'chatMarkedAsRead':var chat=entity('Chats').findById(id);if(chat.raw){external.incChatBadge(-(chat.get('unread').raw));chat.set('unread',0);entity('AppState').refreshUnreadCount();}
break;case 'chatReopened':var state=entity('AppState');if(state.getActiveChatId()==id){switchTabToOpenChats(id);break;}
case 'chatDeleted':case 'chatClosed':if(entity('Chats').findById(id).raw){entity('Chats').removeById(id);}
entity('AppState').refreshUnreadCount();break;case 'messageDeleted':case 'messageIncomingDeleted':entity('Messages').removeById(id);entity('AppState').messagesChanged();break;case 'messageSessionDeleted':var message=entity('Messages').findBy({sessionId:id});if(message.raw){entity('Messages').removeById(message.raw.id);entity('AppState').messagesChanged();}
break;}});}
switch(data.header.type){case 'chatCreated':if(!entity('Chats').findById(data.payload.id).raw){var isThatPanelOpened=(entity('AppState').isClosedChatMode()&&data.payload.status=='c')||(!entity('AppState').isClosedChatMode()&&data.payload.status=='a');if(!isThatPanelOpened){return;}
entity('Chats').upsertResource(data.payload);}
break;case 'chatCacheClear':var status=(entity('AppState').isClosedChatMode()?'c':null);var chats=entity('Chats');if(chats.get('ignoreChatCacheClear').raw){chats.set('ignoreChatCacheClear',false);}else{chats.refreshList(status);}
entity('AppState').refreshUnreadCount();var chat=entity('AppState').getActiveChatRaw();entity('Messages').refreshList(chat);break;case 'messageCacheClear':var chat=entity('AppState').getActiveChatRaw();entity('Messages').refreshList(chat);break;case 'messageStateChanged':var message=entity('Messages').findById(data.payload.id);if(!message.raw){break;}
message.merge(data.payload,{deep:true});entity('AppState').messagesChanged();break;case 'callFinished':case 'messageSent':if(!data.payload.direction){data.payload.direction='o';}
if(!data.payload.chatId){return;}
if(entity('Chats').hasPendingMessage(data.payload.chatId)){return;}
var chat=entity('Chats').findById(data.payload.chatId);if(!chat.raw){var status=(entity('AppState').isClosedChatMode()?'c':null);throttle('messageSent',2000,function(){entity('Chats').refreshList(status)});return;}
var ownedBy={ownedBy:'Chats',key:data.payload.chatId};if(entity('Messages').pageLoaded(ownedBy)!=0){entity('Messages').insertToChat(data.payload.chatId,data.payload);chat.set('lastMessage',data.payload.text);chat.set('updatedAt',data.payload.messageTime);entity('Chats').sortByDateTimeDesc();}else{var status=(entity('AppState').isClosedChatMode()?'c':null);throttle('messageSent',2000,function(){entity('Chats').refreshList(status)});}
entity('AppState').messagesChanged();break;case 'messageIncoming':data.payload.direction='i';var chat=entity('Chats').findById(data.payload.chatId);var activeChat=entity('AppState').getActiveChatId();if(!chat.raw){var status=(entity('AppState').isClosedChatMode()?'c':null);entity('Chats').refreshList(status);}else{var ownedBy={ownedBy:'Chats',key:data.payload.chatId};if(entity('Messages').pageLoaded(ownedBy)!=0){entity('Messages').insertToChat(data.payload.chatId,JSON.parse(JSON.stringify(data.payload)));entity('AppState').messagesChanged();}
chat.set('lastMessage',data.payload.text);chat.set('updatedAt',data.payload.messageTime);}
if(!data.payload.muted&&(activeChat!=data.payload.chatId||!external.isTabVisible())){var user=entity('Textmagic::CoreBundle::User');var dnPlaySound=user.get('dnPlaySound').raw;var dnShowNotifications=user.get('dnShowNotifications').raw;var dnShowText=user.get('dnShowText').raw;if(dnPlaySound){external.playSound('button_tiny');}
if(!dnShowText){data.payload.text='';}
if(dnShowNotifications&&external.isGrantedNotification()){var lastMessageIncoming=window.localStorage.getItem("lastMessageIncoming");if(lastMessageIncoming!=data.payload.id){window.localStorage.setItem("lastMessageIncoming",data.payload.id);var parsed=container.get('Textmagic::CoreBundle::Services::MMS').parseRawMMS(data.payload.text);external.showNotification(container.get('Textmagic::CoreBundle::Services::MMS').parsedMMSToShortCode(parsed),data.payload.contactId?data.payload:data.payload.sender,function(){entity('AppState').setActiveChat(data.payload.chatId);global.window.focus();this.close();});}}}
if(!chat.raw){setTimeout(function(){entity('AppState').refreshUnreadCount();},500);return;}
if(activeChat==chat.raw.id){var newMessagesLineCount=entity('AppState').get('newMessagesLineCount').raw;if(newMessagesLineCount>0){entity('AppState').set('newMessagesLineCount',newMessagesLineCount+1);}}
if(activeChat==-1&&entity('Chats').getResources().length>0&&chat.raw.id==entity('Chats').getResources()[0].id){return;}
if(activeChat!=chat.raw.id){external.incChatBadge(1);entity('AppState').refreshUnreadCount();}else if(entity('AppState').isClosedChatMode()){switchTabToOpenChats(chat.raw.id);break;}else{if(external.isTabVisible()){chat.set('unread',0);apiCalls().Chats.markAsRead(chat.raw.id);setTimeout(function(){entity('AppState').refreshUnreadCount();chat.set('unread',0);},1000);}else{external.incChatBadge(1);entity('AppState').refreshUnreadCount();}}
entity('Chats').sortByDateTimeDesc();entity('Chats').refreshChat(chat.raw.id);break;case 'contactAdded':case 'contactStateChanged':var chat=entity('Chats').findBy({phone:data.payload.phone});if(!chat.raw){return;}
entity('Chats').refreshChat(chat.raw.id);break;case 'contactDeleted':case 'contactCacheClear':var ids=data.payload.ids;if(ids.length!=1){var status=(entity('AppState').isClosedChatMode()?'c':null);entity('Chats').refreshList(status);return;}
var chat=entity('Chats').findBy(function(el){return(el.contact&&el.contact.id==ids[0]);});if(!chat.raw){return;}
entity('Chats').refreshChat(chat.raw.id);break;case 'systemAccountStateChanged':var user=entity('Textmagic::CoreBundle::User');external.updateUserInfo(data.payload);user.setCredentials(data.payload.username,user.getToken());user.set('timezoneId',data.payload.timezone.id);user.set('timezoneOffset',data.payload.timezone.offset/60);break;case 'customFieldsCacheClear':entity('Textmagic::CoreBundle::User').refreshCustomTags();break;case 'messageWipeEnd':break;case 'contactWipeEnd':var status=(entity('AppState').isClosedChatMode()?'c':null);entity('Chats').refreshList(status);break;}};container.register('Textmagic::ChatBundle::Api::Sync',exports);})(global.AHServiceContainer);(function(container){var entity,vue,apiCalls,apiHandler,external,sync;var exports={init:function(){vue=container.get('Textmagic::FrameworkBundle::VueComponent');sync=container.get('Textmagic::ChatBundle::Api::Sync');entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');apiHandler=container.get('Textmagic::ChatBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);external=container.get('Textmagic::ChatBundle::Component::External');},run:function(options){apiCalls().setBaseUrl(options.apiBaseUrl);container.get('Textmagic::ChatBundle::Api::AuthFailureHandler').initHandlers(options);global.onresize=external.resize;global.onresize();var user=entity('Textmagic::CoreBundle::User');var voice=entity('Textmagic::ChatBundle::VoiceCall');var timezones=entity('Textmagic::CoreBundle::Timezones');var callPrices=entity('Textmagic::CoreBundle::CallPrices');user.setCredentials(options.user.login,options.user.api_key);user.set('firstName',options.user.firstName);user.set('lastName',options.user.lastName);user.set('country',options.user.country);user.set('totalSenderId',options.user.totalSenderId);user.set('localNumbersByCountry',options.user.localNumbersByCountry);user.set('allowSendForbiddenCountry',options.user.allowSendForbiddenCountry);user.set('signUpForbiddenCountries',options.user.signUpForbiddenCountries);user.set('currencySign',options.user.currencySign);user.set('isUsingAmPm',options.user.isUsingAmPm);user.set('timezoneId',options.user.timezoneId);user.set('timezone',options.user.timezone);user.set('timezoneOffset',options.user.timezoneOffset/60);user.set('serverTimeVariance',0);user.set('dnPlaySound',options.user.dnPlaySound);user.set('dnShowNotifications',options.user.dnShowNotifications);user.set('dnShowText',options.user.dnShowText);user.set('dnSoundId',options.sound.message.forwardAudioId);user.set('dnSoundUrl',options.sound.message.path);user.set('customScroll',!options.user.customScrollOff);user.set('allowedMms',options.user.allowedMms);user.set('hasBandwidthNumber',options.user.hasBandwidthNumber);entity('Chats').fetch('a',options.chatId);vue.register(container.match('^Textmagic::ChatBundle::Components::'),'all');global.Vue.component('emoji',global.EmojiMart.Emoji);global.Vue.component('picker',global.EmojiMart.Picker);Vue.directive('click-outside',{bind:function(el,binding,vnode){el.clickOutsideEvent=function(event){if(!(el==event.target||el.contains(event.target))){vnode.context[binding.expression](event);}};document.body.addEventListener('click',el.clickOutsideEvent)},unbind:function(el){document.body.removeEventListener('click',el.clickOutsideEvent)},});var vueNative=new global.Vue({el:options.selector,data:{state:entity('AppState').raw}});sync.connect(options.sync.url,user.getUsername(),user.getToken(),'textmagic_ws_chat');external.initSounds(options.sound);external.initSnippets();external.syncTitleToBadge();voice.set('asterisk',options.user.voice);var voiceAvailable=voice.get('asterisk.endpoint').raw&&(voice.get('asterisk.endpoint').raw+''!=='false')&&!entity('AppState').isIE();if(voiceAvailable){if(!voice.initCalls()){console.log('Error init calls!!!');}}
global.onresize();apiCalls().ping();apiCalls().Messages.prices();user.refreshCustomTags();timezones.fetch();callPrices.fetch();if(voiceAvailable){var isOnline=function(){voice.initCalls();};var isOffline=function(){voice.destroyCalls();};if(window.addEventListener){window.addEventListener("online",isOnline,false);window.addEventListener("offline",isOffline,false);}
else{document.body.ononline=isOnline;document.body.onoffline=isOffline;}}}};container.register('Textmagic::ChatBundle::App',exports);})(global.AHServiceContainer);(function(container){var entity,external;var exports=[{template:'#app',mounted:function(){external.setEmojiData(this.$refs.textmagicEmojiSingle.data);},data:function(){return{state:entity('AppState')}}}];exports.init=function(){entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');external=container.get('Textmagic::CoreBundle::Component::External');};container.register('Textmagic::ChatBundle::Components::App',exports);})(global.AHServiceContainer);(function(container){var chatListComponent,button_tiny,callRingingSound,callRingingSoundTimer,callConnecting,busySound,callRingToneSound,entity,soundBasePath;var exports={init:function(){chatListComponent=container.get('Textmagic::ChatBundle::Components::ChatList');entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');},acceptModal:function(title,message,action,success,checkboxes,modalClass,cancel){return global.jQuery.confirm({title:title,message:message,buttons:{'cancel':{class:'btn btn-default',text:'Cancel',click:function(apiConfirm,elemState){if(cancel){cancel(elemState);}
return false;}},'ok':{text:action,class:action=='Close'||action=='Delete'||action=='Block'||action=='Unsubscribe'?'btn btn-danger':'btn btn-success',click:function(apiConfirm,elemState){success(elemState);global.jQuery(this).modal('hide');return false;}}},checkboxes:checkboxes?checkboxes:[],modalClass:modalClass,});},resize:function(){var wHeight=global.jQuery(window).height();var wWidth=global.jQuery(window).width();var containerHeight=wWidth>1199?wHeight-100:wHeight-50;if(entity('VoiceCall').isCallActive()){containerHeight=containerHeight-55;}
var bannersHeight=global.jQuery('nav').offset().top;if(bannersHeight>0){containerHeight=containerHeight-bannersHeight;}
global.jQuery('.chat-container').height(containerHeight);var elSimpleBar=chatListComponent.chatSimpleBar();if(elSimpleBar){elSimpleBar.recalculate();}},clipboard:function(selector,options){return new Clipboard(selector,options);},detailModal:function(message){var modal='';var exportUrl='';var ajaxUrl='';var messageId=message.id;if(message.direction=='o'){modal='#messageSentModal';exportUrl='/online/export/messages_sent_detail/pdf?id=';ajaxUrl='/online/messages/sent/detail';}
if(message.direction=='i'){modal='#messageInboxModal';exportUrl='/online/export/messages_inbox_detail/pdf?id=';ajaxUrl='/online/messages/inbox/detail';}
if(message.direction=='co'||message.direction=='ci'||message.direction=='cim'){modal='#outboundCallsModal';exportUrl='/online/export/history_sip_calls_details/pdf?id=';ajaxUrl='/online/calls/all/details';}
var $content=$(modal).find('#modal-content-table');$('a.pdf_export').attr('href',exportUrl+messageId);$('a.delete-link').attr('href',$('a.delete-link').data('base-url')+'/'+messageId);$(modal).modal('show');$content.spin('enable');$.ajax({url:ajaxUrl,cache:false,type:"POST",data:{id:messageId,ajax:true},dataType:"html"}).done(function(html){$content.spin('disable');$content.html(html);});},sayWho:function(){var ua=navigator.userAgent,tem,M=ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(/trident/i.test(M[1])){tem=/\brv[ :]+(\d+)/g.exec(ua)||[];return{'browser':'ie','version':(tem[1]||'')};}
if(M[1]==='Chrome'){tem=ua.match(/\b(OPR|Edge)\/(\d+)/);if(tem!=null)return{'browser':tem.slice(1)[0].replace('OPR','Opera').toLowerCase(),'version':tem.slice(1)[1]};}
M=M[2]?[M[1],M[2]]:[navigator.appName,navigator.appVersion,'-?'];if((tem=ua.match(/version\/(\d+)/i))!=null)M.splice(1,1,tem[1]);return{'browser':M[0].toLowerCase(),'version':M[1]};},notificationSettingsForm:{toggleAlert:function(){if(!exports.browserHasNotification()){global.jQuery('#notifications-alert').warningBlock('Notifications are not supported by your browser.');return;}
if(exports.isDeniedNotification()){var alertText='Notifications are blocked by your browser. Please go to your browser settings and enable notifications for TextMagic.';var browser=exports.sayWho().browser;var href=false;if(browser=='chrome'){href='https://support.google.com/chrome/answer/3220216?co=GENIE.Platform%3DDesktop&hl=en';}else if(browser=='safari'){href='https://support.apple.com/kb/PH21493';}else if(browser=='firefox'){href='https://support.mozilla.org/en-US/kb/push-notifications-firefox?as=u&utm_source=inproduct#w_upgraded-notifications';}else{href=false;}
if(href){alertText=alertText.replace('settings','<a href="'+href+'" target="_blank">settings<\/a>');global.jQuery('#notifications-alert').warningBlock(alertText);}}
global.jQuery('#notifications-alert').hide();},onChange:function(c){var form=global.jQuery('#notificationSettingsForm');var notify=form.find('#dnShowNotifications').prop('checked');if(!notify){form.find('#dnShowText').prop('checked',false).prop('disabled',true);form.find('#dnShowText').parent().parent().addClass('text-muted');}else{form.find('#dnShowText').prop('disabled',false);form.find('#dnShowText').parent().parent().removeClass('text-muted');if(c!=undefined)c();}},onAudioChange:function(soundElem){soundElem=$(soundElem);var greetingModal=global.jQuery('#greetingmodal');if(soundElem.val()==='custom'&&!soundElem.data('id')){greetingModal.modal('show');}},setCheckboxState:function(id,state){global.jQuery('#notificationSettingsForm input#'+id).prop('checked',state);this.onChange();},getCheckboxState:function(){var form=global.jQuery('#notificationSettingsForm');return{playSound:form.find('#dnPlaySound').prop('checked'),showNotifications:form.find('#dnShowNotifications').prop('checked'),showText:form.find('#dnShowText').prop('checked')}},getFormState:function(){var form=global.jQuery('#notificationSettingsForm'),soundId=null,playSound=0,soundElem=form.find('input[name="sound"]:checked');switch(soundElem.val()){case 'default':playSound=1;break;case 'custom':playSound=1;soundId=soundElem.data('id');if(!soundId){this.setRadioState('sound','default');}
break;}
return{playSound:playSound,showNotifications:form.find('#dnShowNotifications').prop('checked'),showText:form.find('#dnShowText').prop('checked'),soundId:soundId}},setRadioState:function(name,value){global.jQuery('#notificationSettingsForm input[name="'+name+'"]').val([value]);},init:function(onChecked,onSave){var form=global.jQuery('#notificationSettingsForm');var that=this;that.onChange();form.find('#dnShowNotifications').on('change',function(e){that.onChange(onChecked);});form.find('input[name="sound"]').on('change',function(e){that.onAudioChange($(this));});form.on('submit',onSave);}},updateContactForm:{fillPhoneField:function(phone){global.jQuery('#updateContactForm input[type="text"]').val('');global.jQuery('#updateContactForm input#contact_phone').val(phone);},resetTooltips:function(){global.jQuery('#updateContactForm [data-toggle="tooltip"]').tooltip('destroy').tooltip();},onHideModal:function(f){global.jQuery('#updateContactModal').off('hide.bs.modal').on('hide.bs.modal',f);}},senderSettingsModal:{reloadContent:function(chatId){global.jQuery('#sender-settings-content').data('chatId',chatId).trigger('external-reload');},onHideModal:function(f){global.jQuery('#chatSenderSettingsModal').off('hide.bs.modal').on('hide.bs.modal',f);}},templateModalInsertButton:function(state){global.jQuery(document).ready(function(){global.jQuery(document).off('click','[data-widget="new-message-row"]').on('click','[data-widget="new-message-row"]',function(e){e.preventDefault();e.stopPropagation();var data=global.jQuery(this).closest('tr').find('[data-content-body]').data('content-body');state.appendText(data);return false;});});},getSocketIo:function(){return global.window.io;},updateUserInfo:function(user){global.jQuery('span.header-balance').html(user.currency.htmlSymbol+user.balance.toFixed(2));global.jQuery('span[data-rel="owner"]').text(user.firstName+' '+user.lastName);var globalUser=global.app.data.user;globalUser.balance=user.balance;globalUser.email=user.email;globalUser.country=user.country.id;globalUser.currency=user.currency.id;globalUser.currencySign=user.currency.htmlSymbol;globalUser.firstName=user.firstName;globalUser.lastName=user.lastName;globalUser.login=user.username;},initSounds:function(options){options=global.Sugar.Object.merge({message:{forwardAudioId:null,path:null}},options);options.basePath=options.basePath||soundBasePath;if(options.basePath){soundBasePath=options.basePath;}
var url=options.basePath+'button_tiny.mp3';if(options.message.forwardAudioId&&options.message.path){url=options.message.path;}
button_tiny=new Audio(url);button_tiny.preload="auto";button_tiny.volume="0.5";button_tiny.loop=false;button_tiny.url=url;button_tiny.load();var url2=options.basePath+"ringback_tone.mp3";callRingingSound=new Audio(url2);callRingingSound.preload="auto";callRingingSound.volume="0.8";callRingingSound.loop=true;callRingingSound.url=url2;callRingingSound.load();var url3=options.basePath+"сonnecting.wav";callConnecting=new Audio(url3);callConnecting.preload="auto";callConnecting.volume="0.3";callConnecting.loop=false;callConnecting.url=url3;callConnecting.load();var url4=options.basePath+"busy_signal.mp3";busySound=new Audio(url4);busySound.preload="auto";busySound.volume="0.7";busySound.loop=false;busySound.url=url4;busySound.load();var url5=options.basePath+"wake_up.mp3";callRingToneSound=new Audio(url5);callRingToneSound.preload="auto";callRingToneSound.volume="0.8";callRingToneSound.loop=true;callRingToneSound.url=url5;callRingToneSound.load();},playSound:function(name){button_tiny.src=button_tiny.url;button_tiny.play();},playCallRingingSound:function(){callConnecting.src=callConnecting.url;callConnecting.play();callRingingSoundTimer=setTimeout(function(){callConnecting.pause();callRingingSound.src=callRingingSound.url;callRingingSound.play();},1800);},stopCallRingingSound:function(){clearTimeout(callRingingSoundTimer);callConnecting.pause();callRingingSound.pause();},playBusySound:function(name){busySound.src=busySound.url;busySound.play();},playRingToneSound:function(name){callRingToneSound.src=callRingToneSound.url;callRingToneSound.play();},stopRingToneSound:function(){callRingToneSound.pause();},initSnippets:function(){if(typeof(RegExp.escape)!=='function'){RegExp.escape=function(s){return s.replace(/[-\/\\^$*+?.()|[\]{}]/g,'\\$&');};}},showNotification:function(text,contact,callback){if(typeof(Notification)==='undefined'||!Notification||this.isInElectron()||this.shouldSuppressNotifications()){return false;}
global.Notification.show(text,contact,callback);},isGrantedNotification:function(){if(typeof(Notification)==='undefined'||!Notification){return false;}
return Notification.permission=='granted';},browserHasNotification:function(){if(typeof(Notification)==='undefined'||!Notification){return false;}
return true;},isDeniedNotification:function(){if(typeof(Notification)==='undefined'||!Notification){return false;}
return Notification.permission=='denied';},formatDecimal:function(decimal){return decimal.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},cleanParseInt:function(str){return parseInt(str.replace(/\D+/g,''),10);},updateChatBadge:function(value){if(value==0){value='';}
global.jQuery('ul.nav span.total-unread').text(this.formatDecimal(value));this.syncTitleToBadge();},incChatBadge:function(delta){var badge=global.jQuery('ul.nav span.total-unread');var previousValue=this.cleanParseInt(badge.eq(0).text());if(isNaN(previousValue)||!previousValue){previousValue=0;}
var newValue=previousValue+delta;if(newValue<=0||isNaN(newValue)){newValue='';}
badge.text(this.formatDecimal(newValue));this.syncTitleToBadge();},isTabVisible:function(){return global.app.tabvis();},updateTitleBadge:function(value){var defaultTitle='TextMagic: Chats';if(value){global.document.title='('+this.formatDecimal(value)+') '+defaultTitle;}else{global.document.title=defaultTitle;}},syncTitleToBadge:function(){var badge=global.jQuery('ul.nav span.total-unread');var value=this.cleanParseInt(badge.eq(0).text());if(isNaN(value)||!value){value='';}
this.updateTitleBadge(value);},isInElectron:function(){return!!(global.window&&global.window.hasOwnProperty('process')&&global.window.process.hasOwnProperty('type'));},shouldSuppressNotifications:function(){return!!(global.window.suppressNotifications)||global.window.hasOwnProperty('nodeRequire');}};container.register('Textmagic::ChatBundle::Component::External',exports);})(global.AHServiceContainer);(function(container){var entity;var exports=[{template:'#checkbox',methods:{change:function(e){this.$emit('change',this.value,e.target.checked);}},props:['prefix','value','checked']},{template:'#radio',methods:{change:function(e){this.$emit('change',this.value,e.target.checked);}},props:['prefix','value','checked','name','label']},{template:'#chat-spinner',props:['text']},{template:'#empty-container',props:['text','large']},{template:'#empty-chat-list'},{template:'#empty-chat-list-unread',methods:{viewAll:function(){this.state.set('unreadOnly',false);this.state.resetToOpenTab();}},data:function(){return{state:entity('AppState')}}},{template:'#alert',methods:{close:function(){this.state.show=false;this.state.text='';this.state.template=false;this.state.action=null;},reload:function(){location.reload();}},data:function(){return{state:entity('AppState').get('alert').raw}}}];exports.init=function(){entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');};container.register('Textmagic::ChatBundle::Components::Elements',exports);})(global.AHServiceContainer);(function(container){var entity,smsInfo,external,apiCalls,apiHandler,dateFormat,formstate,messagePreview;var lineSpanKey=1;var ampm=false;var exports=[{template:'#attach-list',methods:{showMediaPreview:function(media){entity('Textmagic::MmsPreviewBundle::MmsPreview').setMedia(media);entity('Textmagic::MmsPreviewBundle::MmsPreview').showModal();},removeMmsAttach:function(id){this.state.remove(id);entity('AppState').messagesChanged();}},mounted:function(){},updated:function(){},data:function(){return{state:entity('AttachList')};}}];exports.init=function(){entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');apiHandler=container.get('Textmagic::ChatBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);};container.register('Textmagic::ChatBundle::Components::AttachList',exports);})(global.AHServiceContainer);(function(container){var exports=[{template:'#sms-info',props:{attachList:{type:Array,},isMms:{type:Boolean,default:false},isActive:{type:Boolean,default:false},smsInfo:{type:Object,required:true},sign:{type:String,required:true},},}];container.register('Textmagic::ChatBundle::Components::SMSInfo',exports);})(global.AHServiceContainer);(function(container){var entity,smsInfo,external,apiCalls,apiHandler,dateFormat,formstate,messagePreview,attachPreviewModal;var lineSpanKey=1;var ampm=false;var timerText;var parseHours=function(v){if(!v)v=0;var max=ampm?12:23;var def=ampm?'01':'00';var min=ampm?1:0;var vi=parseInt(v);if(vi>max||vi<min)return def;if(vi<10)return '0'+vi;return vi;};var parseMinutes=function(v){if(!v)v=0;var vi=parseInt(v);if(vi>59||vi<0)return '00';if(vi<10)return '0'+vi;return vi;};var smsInfoTextCheck=function(text,price){var si=entity('AttachList').isEmpty()?smsInfo.info(text,price):smsInfo.infoMms(text,price);if(si.overflow){var prefix=si.unicode?'Unicode message ':'Message ';var alertText=prefix+'text should not exceed  '+si.maxChars+' characters.';entity('AppState').showAlert('warning',alertText,'maxChars');}else if(entity('AppState').get('alert.template').raw=='maxChars'){var chat=entity('AppState').getActiveChatRaw();entity('AppState').updateBlockedContactWarning(chat);}
return si;};var exports=[{template:'#send-form',methods:{textEditorOnSendShortCut:function(text){this.textareaText=text;if(this.isSendButtonDisabled()){return;}
this.send();},textEditorOnChange:function(textObj){this.textareaText=textObj.rawText;this.textareaHtml=textObj.innerHTML;var prices=entity('AppState').getPrices();var chat=entity('AppState').getActiveChatRaw();if(!chat||!chat.country){return;}
var countryPrices=typeof(prices[chat.country.id])!=='undefined'?prices[chat.country.id]:prices['GB'];if(!countryPrices){return;}
var si=smsInfoTextCheck(this.textareaText,this.attachList.isEmpty()?countryPrices.price:countryPrices.outboundMmsPrice);if(!si){return;}
this.smsInfo.overflow=si.overflow;global.Sugar.Object.merge(this.smsInfo,si);},showAttachDetailOnToggle:function(state){this.showAttachDetail=state;},onSelectEmoji:function(emoji){var emojiCheet=':'+emoji.id+':';this.$refs.textEditorComponent.textEditorSelectAndReplaceInPlaceEmoji(emojiCheet,emojiCheet,true);this.$refs.textEditorComponent.textEditorPlaceholderOnClick();this.$refs.textEditorComponent.textEditorOnChange();this.showEmojiMart=false;},onSelectContactTag:function(tag){this.$refs.textEditorComponent.textEditorInsertText('{'+tag+'}');this.$refs.textEditorComponent.textEditorPlaceholderOnClick();this.$refs.textEditorComponent.textEditorOnChange();},appendText:function(text){var chat=entity('AppState').getActiveChatRaw();if(!chat)return;this.$refs.textEditorComponent.textEditorInsertText(text);this.$refs.textEditorComponent.textEditorPlaceholderOnClick();this.$refs.textEditorComponent.textEditorOnChange();},isMms:function(){return!this.attachList.isEmpty();},textEditorOnToggleFocus:function(focused){this.textEditorHasFocus=focused;},isSendButtonDisabled:function(){var chat=this.state.getActiveChatRaw();var user=entity('Textmagic::CoreBundle::User');var isBlockedContact=chat&&chat.contact&&chat.contact.blocked&&chat.contact.user.username==user.get('username').raw;var isUnsubscribed=chat&&chat.unsubscribedContactId;var lnByCountry=user.get('localNumbersByCountry').raw;var totalSenderId=user.get('totalSenderId').raw;var hasNoLvn=false;var hasNoSenderIdFr=chat&&chat.country&&chat.country.id=='FR'&&lnByCountry.hasOwnProperty(chat.country.id)&&lnByCountry[chat.country.id]==0&&totalSenderId===0;return this.state.get('sendButtonDisabled').raw||isBlockedContact||isUnsubscribed||hasNoLvn||hasNoSenderIdFr||this.smsInfo.overflow||(this.textareaText.trim().length==0&&!this.isMms());},send:function(){var chatId=entity('AppState').getActiveChatId();var text=this.textareaText;if((!text&&!this.isMms())||!chatId){return;};apiCalls().Messages.send(chatId,text);this.textareaText='';this.smsInfo.text='';this.smsInfo.parts=0;this.smsInfo.maxParts=0;this.smsInfo.unicode=false;this.smsInfo.chars=0;this.smsInfo.label='';this.smsInfo.cost=0;this.smsInfo.overflow=false;entity('AppState').hideAlert();entity('AppState').set('newMessagesLineCount',0);entity('AppState').set('sendButtonDisabled',true);entity('AppState').get('typedTexts').set(chatId,'');entity('AppState').badVeryBadDirtyFunction();},sendButtonInnerHtml:function(){return this.state.get('sendButtonDisabled').raw?'Sending':'Send'+(this.attachList.isEmpty()?'':' MMS');},},computed:{sign:function(){return entity('Textmagic::CoreBundle::User').get('currencySign').raw;}},data:function(){formstate={showAttachDetail:false,textEditorHasFocus:false,state:entity('AppState'),attachList:entity('AttachList'),showCost:false,textareaText:'',textareaHtml:'',smsInfo:{text:'',parts:0,maxParts:0,unicode:false,chars:0,label:'',cost:0,overflow:false}};return formstate;},mounted:function(){apiHandler.setInsertLinkDependency(this.appendText);attachPreviewModal.setInsertLinkDependency(this.appendText);external.templateModalInsertButton(this);},watch:{textareaHtml:function(newText){var chatId=entity('AppState').getActiveChatId();entity('AppState').get('typedTexts').set(chatId,newText);}}},{template:'#attach-controls',props:['textareaText','textEditorHasFocus','showAttachDetail'],methods:{previewModalShow:function(e){var chat=this.state.getActiveChatRaw();var contacts=chat&&chat.contact?[chat.contact.id]:[];var phones=chat&&chat.contact?[]:[chat.phone];var getSubmitData={schedule:{mode:false,params:{"recurrencePattern":"FREQ=DAILY;INTERVAL=1;COUNT=1;","startDateTime":"2018-02-13T15:30+02:00"}},message:{text:this.textareaText},from:chat.from,serviceType:'text',audioId:null,recipients:{"groups":[],"contacts":contacts,"numbers":phones}};messagePreview.forced=false;var targetSpinner=document.getElementById('message-preview-table-content');var fakeEvent={target:targetSpinner,preventDefault:function(){},source:'chat'};messagePreview.previewBtnClickHandler(fakeEvent,getSubmitData);},newAttachModalShow:function(){var user=entity('Textmagic::CoreBundle::User');if(this.state.isUsCaPrChat()&&user.get('allowedMms').raw){entity('NewAttachment').showModal();return;}
entity('AttachUpload').showModal();},attachModalShow:function(){entity('AttachUpload').showModal();},attachMmsModalShow:function(){entity('MmsUpload').showModal();},insertTemplateModalShow:function(){global.jQuery('#addTemplateModal2').modal('show');},clickContactTagItem:function(tag){jQuery('#chat-messages-container').click();this.$emit('selectContactTag',tag);},isInsertTagButtonDisabled:function(){var chat=this.state.getActiveChatRaw();var isNotBlockedContact=chat&&chat.contact&&!chat.contact.blocked;return!isNotBlockedContact;},isSendButtonDisabled:function(){var chat=this.state.getActiveChatRaw();var user=entity('Textmagic::CoreBundle::User');var attachList=entity('AttachList');var isBlockedContact=chat&&chat.contact&&chat.contact.blocked&&chat.contact.user.username==user.get('username').raw;return this.state.get('sendButtonDisabled').raw||isBlockedContact||(this.textareaText.trim().length==0&&attachList.isEmpty());},isPreviewButtonDisabled:function(){var chat=this.state.getActiveChatRaw();var user=entity('Textmagic::CoreBundle::User');var attachList=entity('AttachList');var isBlockedContact=chat&&chat.contact&&chat.contact.blocked&&chat.contact.user.username==user.get('username').raw;return this.state.get('sendButtonDisabled').raw||isBlockedContact||(this.textareaText.trim().length==0);},tagFields:function(){var userCustomFields=entity('Textmagic::CoreBundle::User').getCustomFields();return entity('AppState').get('staticFields').add(userCustomFields).raw;},onEmoticonSelect:function(emoji){this.$emit('selectEmoji',emoji);this.showEmojiMart=!this.showEmojiMart;},clickOutsideEmoji:function(e){this.showEmojiMart=false;},showSchedulePanel:function(){this.$emit('showAttachDetailEvent',true);}},data:function(){return{showEmojiMart:false,state:entity('AppState'),user:entity('Textmagic::CoreBundle::User'),attachList:entity('AttachList')};},mounted:function(){entity('AppState').set('emojiData',this.$refs.textmagicEmojiPicker.data);entity('AppState').createEmojiBackMap();messagePreview=new MessagePreview({showPrevNextBar:false,forcedSingleMessage:true});}},{template:'#attach-controls-details',props:['textareaText','showAttachDetail'],methods:{startDateFormatted:function(){return dateFormat.format(this.startDate,'D MMM YYYY');},schedule:function(){var chatId=entity('AppState').getActiveChatId();var text=this.textareaText;var attachList=entity('AttachList');if((!text&&attachList.isEmpty())||!chatId){return};var datePart=dateFormat.moment(this.startDate).format("YYYY-MM-DD");var timePart='';if(this.ampm){var dateStr='1 Jan 1900 '+this.hours+':'+this.minutes+':00 '+this.ampm;timePart=dateFormat.moment(new Date(dateStr),["hh:mm A"]).format("HH:mm:ss");}else{timePart=dateFormat.moment({hour:this.hours,minute:this.minutes}).format("HH:mm:ss");}
var sendingDateTime=datePart+' '+timePart;var sendingTimezone=this.timezone;var labelTime=this.ampm?dateFormat.moment(sendingDateTime).format("D MMM YYYY h:mm A"):dateFormat.moment(sendingDateTime).format("D MMM YYYY HH:mm");apiCalls().Messages.schedule(chatId,text,sendingDateTime,sendingTimezone,{labelTime:labelTime,component:this});entity('AppState').set('sendButtonDisabled',true);entity('AppState').set('newMessagesLineCount',0);entity('AppState').get('typedTexts').set(chatId,'');entity('AppState').badVeryBadDirtyFunction();this.$emit('showAttachDetailEvent',false);},onHours:function(e){var val=e.target.value;this.hours=parseHours(val);this.$refs.hours.value=this.hours;},onMinutes:function(e){var val=e.target.value;this.minutes=parseMinutes(val);this.$refs.minutes.value=this.minutes;},onAmPm:function(e){this.ampm=e.target.value;},isSendButtonDisabled:function(){var state=entity('AppState');var chat=state.getActiveChatRaw();var user=entity('Textmagic::CoreBundle::User');var attachList=entity('AttachList');var isBlockedContact=chat&&chat.contact&&chat.contact.blocked&&chat.contact.user.username==user.get('username').raw;return state.get('sendButtonDisabled').raw||isBlockedContact||this.textareaText.trim().length==0&&attachList.isEmpty();},closeSheduledPanel:function(){this.$emit('showAttachDetailEvent',false);},getTimezonesList:function(){return entity('Textmagic::CoreBundle::Timezones').raw;}},mounted:function(){var that=this;var dp=global.jQuery('#scheduleStartDate').parent();dp.bootstrapDP().on('changeDate',function(){that.startDate=dp.bootstrapDP('getDate');});ampm=entity('Textmagic::CoreBundle::User').get('isUsingAmPm').raw;this.ampm=ampm?'AM':false;global.jQuery('[data-toggle="tooltip"]').tooltip('destroy').tooltip({container:'body'});},updated:function(){var that=this;global.jQuery('#timeZoneSelect').chosen("destroy");global.jQuery('#timeZoneSelect').chosen({width:'85%',search_contains:true}).change(function(){that.timezone=global.jQuery("#timeZoneSelect").chosen().val();});global.jQuery('[data-toggle="tooltip"]').tooltip('destroy').tooltip({container:'body'});},data:function(){var user=entity('Textmagic::CoreBundle::User');var now=new Date();var isAmPm=user.get('isUsingAmPm').raw;var hourFormat=isAmPm?'hh':'HH';var nowAdd30Min=new Date();if(nowAdd30Min.getMinutes()<30){nowAdd30Min.setMinutes(0);}else{nowAdd30Min.setMinutes(30);}
nowAdd30Min=dateFormat.moment(nowAdd30Min).add(30,'m');return{user:user,timezones:entity('Textmagic::CoreBundle::Timezones'),startDate:now,hours:nowAdd30Min.format(hourFormat),minutes:nowAdd30Min.format('mm'),timezone:user.get('timezoneId').raw,ampm:isAmPm?'AM':false};}}];exports.init=function(){entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');apiHandler=container.get('Textmagic::ChatBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);external=container.get('Textmagic::ChatBundle::Component::External');dateFormat=container.get('Textmagic::ChatBundle::Utils::Date');smsInfo=container.get('Textmagic::CoreBundle::Utils::SmsInfo');attachPreviewModal=container.get('Textmagic::ChatBundle::Components::FilePreviewUploadModal');};container.register('Textmagic::ChatBundle::Components::SendForm',exports);})(global.AHServiceContainer);(function(container){function surrogatePairToCodepoint(lead,trail){return(lead-0xD800)*0x400+(trail-0xDC00)+0x10000;}
function saveSelection(){if(window.getSelection){var sel=window.getSelection();if(sel.getRangeAt&&sel.rangeCount){return sel.getRangeAt(0);}}else if(document.selection&&document.selection.createRange){return document.selection.createRange();}
return null;}
function restoreSelection(range){if(range){if(window.getSelection){var sel=window.getSelection();sel.removeAllRanges();sel.addRange(range);}else if(document.selection&&range.select){range.select();}}}
var NATIVE_EMOJI_PATERN=/([\ud800-\udbff])([\udc00-\udfff])/g;var CONTACT_TAG_PATTERN=/\{(.+?)\}/g;var CHEET_CODE_EMOJI_PATTERN=/\:([a-zA-Z-_0-9\+]+?)\:/g;var EMPTY_GIF_STR="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";var chatMessagesContainerElement,chatFormSend,entity,selRange;var exports=[{template:'#text-editor',props:[],data:function(){return{version:0,html:'',rawText:'',placeholder:true,focused:false};},methods:{isMobileViewBelow768:function(){return document.body.clientWidth<768;},setTextareaText:function(html){this.html=html;this.getTextAreaElement().innerHTML=this.html;if(!this.isMobileViewBelow768()){this.getTextAreaElement().focus();}
this.textEditorOnChange();},getTextAreaElement:function(){return this.$el.firstChild;},setRawTextEmmit:function(text){var range=document.createRange();var referenceNode=this.getTextAreaElement();range.selectNode(referenceNode);var innerText=this.textEditorRawTextFromRange(range).replace(/\u200b/g,'');innerText=this.emojiReplaceCheatToNative(innerText);this.rawText=text?text:innerText;this.$emit('textEditorOnChange',{rawText:this.rawText,innerHTML:this.getTextAreaElement().innerHTML});},placeHolderVisible:function(){return this.getTextAreaElement().innerText.length==0&&this.getTextAreaElement().innerHTML.indexOf('<img')==-1;},textEditorPlaceholderOnClick:function(){this.placeholder=false;this.getTextAreaElement().focus();},textEditorOnBlur:function(){selRange=saveSelection();this.placeholder=this.placeHolderVisible();this.focused=false;setTimeout(function(){this.$emit('textEditorOnToggleFocus',this.focused);}.bind(this),150);},textEditorOnFocus:function(){restoreSelection(selRange);this.placeholder=this.placeHolderVisible();this.focused=true;this.$emit('textEditorOnToggleFocus',this.focused);},textEditorOnChange:function(e){this.setRawTextEmmit();this.placeholder=this.placeHolderVisible();entity('AppState').messagesChanged();},textEditorOnKeyup:function(e){if(e.ctrlKey&&e.code=='KeyA'){var range=document.createRange();range.selectNodeContents(this.getTextAreaElement());var sel=window.getSelection();sel.removeAllRanges();sel.addRange(range);}},textEditorOnKeydown:function(e){if(e.key==':'){setTimeout(function(){this.textEditorReplaceCheetEmojiInValue(this.getTextAreaElement());this.setRawTextEmmit();}.bind(this),50);}
if(e.key=='}'){setTimeout(function(){this.textEditorReplaceContactTagInValue(this.getTextAreaElement());this.setRawTextEmmit();}.bind(this),50);}
if(e.ctrlKey&&(e.keyCode==10||e.keyCode==13)){this.setRawTextEmmit();this.$emit('textEditorOnSendShortCut',this.rawText);e.stopPropagation();e.preventDefault();}
if(e.key=='Backspace'){var f=navigator.userAgent.search('Firefox');if(f>-1){var selection=document.getSelection();if(selection.anchorNode.previousSibling&&selection.anchorNode.previousSibling.localName=='span'&&selection.anchorOffset==0){selection.anchorNode.previousSibling.parentNode.removeChild(selection.anchorNode.previousSibling);}}}},emojiCheatExist:function(value){var map=entity('AppState').get('emojiForwardMap').raw;return map.hasOwnProperty(value);},matchEmojiInValue:function(pattern){var currentRange=window.getSelection().getRangeAt(0);var endContainer=currentRange.endContainer;var data=endContainer.data;if(!endContainer||!data||data.length==0){return[];}
var emojiArray=data.match(pattern);if(!emojiArray||emojiArray.length==0){return[];}
return emojiArray;},textEditorReplaceContactTagInValue:function(){var contactTagsArray=this.matchEmojiInValue(CONTACT_TAG_PATTERN);contactTagsArray.map(function(contactTag){this.textEditorSelectAndReplaceInPlaceContactTag(contactTag,contactTag);}.bind(this));},textEditorReplaceCheetEmojiInValue:function(){var emojiCheetsArray=this.matchEmojiInValue(CHEET_CODE_EMOJI_PATTERN);emojiCheetsArray.map(function(emojiCheat){this.textEditorSelectAndReplaceInPlaceEmoji(emojiCheat,emojiCheat);}.bind(this));},textEditorReplaceNativeEmojiInValue:function(){var emojiNativeArray=this.matchEmojiInValue(NATIVE_EMOJI_PATERN);emojiNativeArray.map(function(emojiNative){var emojiCheat=this.emojiReplaceNativeToCheat(emojiNative);this.textEditorSelectAndReplaceInPlaceEmoji(emojiCheat,emojiNative);}.bind(this));},textEditorSelectAndReplaceInPlaceEmoji:function(emoji1,emoji2,useSavedRange){var emojiId=emoji1.replace(':','').replace(':','');if(!this.emojiCheatExist(emojiId)){return;}
return this.textEditorSelectAndReplaceInPlace(emoji1,emoji2,useSavedRange,'emoji');},textEditorSelectAndReplaceInPlaceContactTag:function(tag1,tag2,useSavedRange){return this.textEditorSelectAndReplaceInPlace(tag1,tag1,useSavedRange,'tag');},textEditorSelectAndReplaceInPlace:function(emoji1,emoji2,useSavedRange,replacer){var currentRange=useSavedRange?selRange:window.getSelection().getRangeAt(0);if(!currentRange||!currentRange.endContainer){return;}
var endContainer=currentRange.endContainer;var data=endContainer.data;var start=0;var end=0;if(!useSavedRange&&data&&data.length>0){start=data.indexOf(emoji2);end=start+emoji2.length;currentRange.setStart(endContainer,start);currentRange.setEnd(endContainer,end);currentRange.deleteContents();}
var html=replacer=='emoji'?this.emojiReplaceCheatToHtml(emoji1):this.contactTagTextReplaceToHtml(emoji1);var fragment=currentRange.createContextualFragment(html);currentRange.insertNode(fragment);currentRange.collapse(false);},textEditorInsertText:function(text){var currentRange=selRange;if(!currentRange||!currentRange.endContainer){return;}
var html=this.contactTagTextReplaceToHtml(text);html=this.replaceNLBR(html);var fragment=currentRange.createContextualFragment(html);currentRange.insertNode(fragment);currentRange.collapse();},contactTagTextReplaceToHtml:function(value){return value.replace(CONTACT_TAG_PATTERN,function(string,tag){return '<span class="tag-item" contenteditable="false"><span class="emoji-wrap">{</span>'
+tag.replace('{','').replace('}','')
+'<span class="emoji-wrap">}</span></span>';});},emojiReplaceNativeToCheat:function(value){var map=entity('AppState').get('emojiBackMap').raw;var replacement=value,matches=value.match(NATIVE_EMOJI_PATERN);if(matches){replacement=value.replace(NATIVE_EMOJI_PATERN,function(match,p1,p2){var pi1=p1.charCodeAt(0),pi2=p2.charCodeAt(0);if(pi1==55349&&(pi2>=56788&&pi2<=56813)){return String.fromCharCode(pi2-56723);}
var codepoint=surrogatePairToCodepoint(pi1,pi2).toString(16).toUpperCase();if(!map.hasOwnProperty(codepoint)){return match;}
return ':'+map[codepoint]+':';});}
return replacement;},emojiReplaceCheatToHtml:function(value){var emojiData=entity('AppState').get('emojiData').raw;return value.replace(CHEET_CODE_EMOJI_PATTERN,function(string,emojiId){if(!this.emojiCheatExist(emojiId)){return string;};var compClass=global.Vue.extend(global.EmojiMart.Emoji);var emojii=new compClass({functional:false,propsData:{emoji:emojiId,size:22},render:function(createElement){var ctx={data:function(){},props:{emoji:emojiId,size:22,data:emojiData},children:''};var result=global.EmojiMart.Emoji.render(createElement,ctx);return result;}});var el=emojii.$mount();var img=new Image();img.style.cssText=el.$el.firstChild.style.cssText;img.src=EMPTY_GIF_STR;img.setAttribute("data-emoji-cheet",':'+emojiId+':');return img.outerHTML;}.bind(this));},emojiReplaceCheatToNative:function(value){var map=entity('AppState').get('emojiForwardMap').raw;return value.replace(CHEET_CODE_EMOJI_PATTERN,function(string,emojiId){return map.hasOwnProperty(emojiId)?String.fromCodePoint('0x'+map[emojiId]):':'+emojiId+':';});},textEditorOnPaste:function(e){var text=(e.originalEvent||e).clipboardData.getData('text/plain');text=this.contactTagTextReplaceToHtml(text);text=this.emojiReplaceNativeToCheat(text);text=this.emojiReplaceCheatToHtml(text);var html=this.replaceNLBR(text);document.execCommand('insertHTML',false,html);this.textEditorOnChange();},textEditorOnCopy:function(e){var selection=document.getSelection();var range=selection.getRangeAt(0);var text=this.textEditorRawTextFromRange(range);e.clipboardData.setData('text/plain',text);},replaceNLBR:function(text){if(text.split("\n").length==1){return text;};return text.split("\n").map(function(value){var val1=value;if(value.trim().length==0){val1='<br>';}
return '<div>'+val1+'</div>';}).join('').split('<div></div>').join('');},textEditorRawTextFromRange:function(range){var fragment=range.cloneContents();var arr=fragment.querySelectorAll('img');for(var i=0,len=arr.length;i<len;++i){var e=arr[i];var cheet=e.getAttribute("data-emoji-cheet");var textNode=document.createTextNode(cheet);e.replaceWith(textNode);};var copyElement=document.getElementById('text-editor-copy-element-replacer');copyElement.innerHTML="";copyElement.appendChild(fragment);copyElement.innerHTML=copyElement.innerHTML.split('<div><div>').join("<div>").split('</div></div>').join("</div>").split('<br></div>').join("</div>").split("\n</div>").join("</div>").split("</div>\n").join("</div>").split('<div').join("\n<div").split('<br>').join("<div>\n</div>");return copyElement.innerText.replace(/^\s+|\s+$/g,'');}},mounted:function(){entity('AppState').badVeryBadDirtyFunction=entity('AppState').badVeryBadDirtyFunction.bind(null,this);}}];exports.init=function(){entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');};container.register('Textmagic::ChatBundle::Components::TextEditor',exports);})(global.AHServiceContainer);(function(container){var entity,apiCalls,apiHandler,external;var exports=[{template:'#new-attachment-modal',data:function(){return{appstate:entity('AppState'),state:entity('NewAttachment'),user:entity('Textmagic::CoreBundle::User'),list:entity('AttachList'),showBuyNumberBtn:false};},methods:{attachModalShowClick:function(){entity('AttachUpload').showModal();entity('NewAttachment').hideModal();},mmsModalShowClick:function(){if(this.appstate.needToBuyNumber()){this.showBuyNumberBtn=true;return;}
if(this.appstate.isAllowedMmsChat()){entity('MmsUpload').showModal();entity('NewAttachment').hideModal();}}},computed:{}}];exports.init=function(){apiHandler=container.get('Textmagic::ChatBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');external=container.get('Textmagic::CoreBundle::Component::External');};container.register('Textmagic::ChatBundle::Components::NewAttachmentModal',exports);})(global.AHServiceContainer);(function(container){var entity,apiCalls,apiHandler,external,textSetter;var exports=[{template:'#file-upload-prview-modal',data:function(){return{state:entity('FilePreviewUpload')};},methods:{insertLink:function(){textSetter('{'+entity('FilePreviewUpload').getLinkFullUrl()+'}');entity('FilePreviewUpload').toggleModal(false,true);},attachFile:function(){var file=entity('FilePreviewUpload').getFileRaw();entity('AttachList').append(file);entity('FilePreviewUpload').toggleModal(false,true);}},computed:{}}];exports.setInsertLinkDependency=function(setter){textSetter=setter;};exports.init=function(){apiHandler=container.get('Textmagic::ChatBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');external=container.get('Textmagic::CoreBundle::Component::External');};container.register('Textmagic::ChatBundle::Components::FilePreviewUploadModal',exports);})(global.AHServiceContainer);(function(container){var entity,apiCalls,apiHandler,external;var exports=[{template:'#attach-upload-modal',data:function(){return{state:entity('AttachUpload')};},methods:{uploadFile:function(){entity('AttachUpload').set('alert.text','');entity('AttachUpload').set('alert.show',false);entity('AttachUpload').set('loader',true);var form=document.forms['attachLinkFileForm'];apiCalls().Messages.uploadAttachFile(new FormData(form));}},computed:{}}];exports.init=function(){apiHandler=container.get('Textmagic::ChatBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');external=container.get('Textmagic::CoreBundle::Component::External');};container.register('Textmagic::ChatBundle::Components::AttachUploadModal',exports);})(global.AHServiceContainer);(function(container){var entity,apiCalls,apiHandler,dateUtil,external,externalCore;var exports=[{template:'#notes-modal',data:function(){return{state:entity('NotesForm'),user:entity('Textmagic::CoreBundle::User').raw,};},watch:{'state.raw.showModal':function(val,oldVal){if(val){var that=this;if(this.$refs['note-input-id-new']){this.$refs['note-input-id-new'].innerHTML='';}
this.$nextTick(function(){this.state.get('chat').raw.contact.notes.forEach(function(v){that.$refs['note-input-id-'+v.id][0].textContent=v.note;});});this.state.get('chat.contact.notes').sortBy('id',true);}},'state.raw.isNewNoteInputVisible':function(val,oldVal){var that=this;if(val){this.$nextTick(function(){externalCore.placeCaretAtEnd(that.$refs['note-input-id-new']);});}},},methods:{saveNote:function(){var that=this;this.state.set('isShowSpinnerForNewNoteInput',true);apiCalls().Notes.add(this.$data.state.get('chat').raw.contact.id,{note:this.$refs['note-input-id-new'].innerText}).then(function(result){that.state.get('chat.contact.notes').raw.unshift({id:result.id,note:that.$refs['note-input-id-new'].innerText,createdAt:new Date().getTime()});that.state.toggleModal(false);}).fail(function(){externalCore.placeCaretAtEnd(that.$refs['note-input-id-new']);}).always(function(){that.state.set('isShowSpinnerForNewNoteInput',false);});},updateNote:function(id){var that=this;this.$set(this.state.get('isShowSpinnerById').raw,id,true);apiCalls().Notes.put(id,{note:this.$refs['note-input-id-'+id][0].innerText}).then(function(result){var originalChatObject=that.state.get('chat.contact.notes').raw.find(function(v){return v.id===result.id;});originalChatObject.note=that.$refs['note-input-id-'+id][0].innerText;originalChatObject.createdAt=new Date().getTime();that.state.removeActiveEditInputById(result.id);}).fail(function(){externalCore.placeCaretAtEnd(that.$refs['note-input-id-'+id][0]);}).always(function(){that.state.get('isShowSpinnerById').set(id,false);});},deleteNote:function(id){var that=this;external.acceptModal('Delete note confirmation','Are you sure you would like to delete note?','Delete',function(){document.body.classList.add('modal-open');that.$set(that.state.get('isShowSpinnerById').raw,id,true);apiCalls().Notes.delete(id).then(function(){that.state.deleteNote(id);}).always(function(){that.state.get('isShowSpinnerById').set(id,false);});setTimeout(function(){document.body.classList.add('modal-open');},0);},null,null,function(){setTimeout(function(){document.body.classList.add('modal-open');},0);});},removeActiveEditInputById:function(id){this.state.removeActiveEditInputById(id);this.$refs['note-input-id-'+id][0].innerText=this.state.getOriginalChatNoteById(id);},openEditModeForInputValueById:function(id){var that=this;this.state.addActiveEditInputId(id);this.$nextTick(function(){externalCore.placeCaretAtEnd(that.$refs['note-input-id-'+id][0]);});},toggleNewNoteInput:function(){this.state.set('isNewNoteInputVisible',!this.state.get('isNewNoteInputVisible').raw);},formatCreatedAt:function(date){return dateUtil.timeFormatFromNow(date);}}}];exports.init=function(){apiHandler=container.get('Textmagic::ChatBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');dateUtil=container.get('Textmagic::ChatBundle::Utils::Date');external=container.get('Textmagic::ChatBundle::Component::External');externalCore=container.get('Textmagic::CoreBundle::Component::External');};container.register('Textmagic::ChatBundle::Components::NotesModal',exports);})(global.AHServiceContainer);(function(container){var entity,apiCalls,apiHandler,external;var exports=[{template:'#mms-upload-modal',data:function(){return{state:entity('MmsUpload')};},methods:{uploadFile:function(){entity('MmsUpload').set('alert.text','');entity('MmsUpload').set('alert.show',false);entity('MmsUpload').set('loader',true);var form=document.forms['attachMmsFileForm'];apiCalls().Messages.uploadMmsAttachFile(new FormData(form));}},computed:{}}];exports.init=function(){apiHandler=container.get('Textmagic::ChatBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');external=container.get('Textmagic::CoreBundle::Component::External');};container.register('Textmagic::ChatBundle::Components::MmsUploadModal',exports);})(global.AHServiceContainer);(function(container){var entity,dateFormat,apiCalls,apiHandler,elSimpleBar;var exports=[{template:'#chats-empty-search-result',props:['query'],data:function(){return{state:entity('AppState'),header:entity('ChatsSearchResult').raw}}},{template:'#chats-search-result',methods:{selectchat:function(chat){apiCalls().Chats.getByPhone(chat.phone,{upsert:1,reopen:chat.status=='a'?'1':'0'},chat.status);},timeago:function(timeStr){var offset=entity('Textmagic::CoreBundle::User').get('timezoneOffset').raw;return dateFormat.timeFormatFromNow(timeStr,offset);},highlight:function(value,query,cl){if(!query){return value;}
var hl='<span class="chat-highlight">$&</span>';return value.replace(new RegExp(RegExp.escape(query),'gi'),hl);},contactNameOrPhone:function(chat,query){var str=chat.contact===null?chat.phone:(chat.contact.firstName+' '+chat.contact.lastName).replace('null','').trim();return this.highlight(str,query);},replaceAudio:function(text){if(!text)return '';if(text.indexOf('<audio')<0){return text;}
var res=text.match(/>(.*)</,'$1');if(!res||res.length<2){return text;}
return res[1];}},data:function(){return{state:entity('AppState'),chats:entity('ChatsSearchResult').getResources(),header:entity('ChatsSearchResult').raw,customScroll:entity('Textmagic::CoreBundle::User').get('customScroll').raw}},mounted:function(){if(!this.customScroll){return;}
var that=this;elSimpleBar=new SimpleBar(document.getElementById('chat-search-result-contact-list'),{wrapContent:false,autoHide:true});}}];exports.init=function(){entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');apiHandler=container.get('Textmagic::ChatBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);dateFormat=container.get('Textmagic::ChatBundle::Utils::Date');};container.register('Textmagic::ChatBundle::Components::ChatsSearchResults',exports);})(global.AHServiceContainer);(function(container){var entity,dateFormat,external,elSimpleBar,chatActions;var chatListPopupMenu={template:'#chat-list-popup-menu',mixins:[],props:['id','isMuted','isPinned','hasUnread','isContactBlocked'],methods:{popUpMenuClick:function(e){this.state.set('preventChatSelect',true);var el=e.target;var containerHeight=document.getElementById('chat-contact-list').clientHeight;var popup=el.parentElement.nextElementSibling;if(!popup){return;}
popup.className=popup.className.replace(' drop-upper','');if(e.pageY>containerHeight-80){popup.className+=' drop-upper';}},hide:function(id){var elementId='chatAtionsMenu'+id;var el=document.getElementById(elementId);if(!el){return;}
el.className='btn-group chat-actions';}},data:function(){return{state:entity('AppState')}}};var exports=[{template:'#chat-list',methods:{nop:function(){return false;},isMuted:function(item){return item.mute>0&&(item.mutedUntil==null||dateFormat.moment(item.mutedUntil).toDate().getTime()>=Date.now());},timeAgo:function(timeStr){var offset=entity('Textmagic::CoreBundle::User').get('timezoneOffset').raw;return dateFormat.timeFormatFromNow(timeStr,offset);},cleanUpMMS:function(text){if(!text){return text;}
var parsed=container.get('Textmagic::CoreBundle::Services::MMS').parseRawMMS(text);if(parsed.media.length===0){return text;}
return container.get('Textmagic::CoreBundle::Services::MMS').parsedMMSToShortCode(parsed);},replaceAudio:function(text,notReplaceEmoji,message){if(!text)return '';if(text.indexOf('<audio')<0){text=text.replace(/[&"<>]/g,function(c){return{'&':"&amp;",'"':"&quot;",'<':"&lt;",'>':"&gt;"}[c];});if(!notReplaceEmoji){text=external.replaceEmojis(text);}
if(message.direction=='co'||message.direction=='ci'||message.direction=='cim'){var callTime=message.lastMessage.match(/^.*?\([^\d]*(\d+)[^\d]*\).*$/);var callTimeFormatted='0:00:00';if(callTime&&callTime[1]){callTimeFormatted='('+dateFormat.timeFormatFromSeconds(callTime[1])+')';}
var direction,icon,textClass;if(message.direction=='co'){direction='Outbound';icon='tmi30-handset-arrow';textClass='text-primary';}else{if(parseInt(callTime[1])==0){direction='Missed ';icon='tmi30-handset-cancel';textClass='text-danger';callTimeFormatted='';}else{direction='Inbound';icon='tmi30-handset-arrow-back';textClass='text-success';}}
text=(!notReplaceEmoji?'<span class="'+textClass+'"><i class="tmi30 '+icon+'"></i></span>&nbsp;':'')+direction+' call '+callTimeFormatted;}
return text;}
if(!notReplaceEmoji){text=external.replaceEmojis(text);}
var res=text.match(/>(.*)</,'$1');if(!res||res.length<2){return text;}
return res[1];},chatName:function(item){var contactName='';if(item.contact!==null){contactName=(item.contact.firstName+' '+item.contact.lastName).replace('null','').trim();}
return item.contact===null||item.phone===contactName?'+'+item.phone.replace('+','').trim():contactName;},selectChat:function(chat){var state=entity('AppState');var pcs=state.get('preventChatSelect').raw;if(pcs){state.set('preventChatSelect',false);return;}
var ownedBy={ownedBy:'Chats',key:chat.id};state.setActiveChat(chat.id).setMessagesScrollDown(true).set('visibility.movedRight',true);},checkboxChange:function(chatId,checked){var checkedChats=entity('AppState').get('checkedChats');if(checked){checkedChats.append(chatId);}else{checkedChats.remove(chatId);}},checkboxIsChecked:function(chatId){var checkedChats=entity('AppState').get('checkedChats');return checkedChats.indexOf(chatId)>=0;},handleScroll:function(e){var src=e.target;var scrollPosition=src.scrollTop+src.clientHeight;var hasScroll=src.scrollHeight>src.clientHeight;if(hasScroll&&scrollPosition>=src.scrollHeight*0.7){var closed=entity('AppState').get('visibility.chatPanel.closed').raw;entity('Chats').fetch(closed?'c':'a');}},isTotalRowsBelowOnePage:function(){var chats=entity('Chats');return chats.rowsLoaded()<chats.pageSize||chats.pageLoaded()==chats.pageCount()},closeBanner:function(){this.isClosedNotificationBanner=true;},notificationBannerShow:function(){if(typeof(Notification)==='undefined'||!Notification){return false;}
return(Notification.permission=='default')&&!this.isClosedNotificationBanner;},notificationBannerClick:function(){var that=this;Notification.requestPermission(function(result){if(result==='default'){return;}
that.isClosedNotificationBanner=true;});},formatDecimal:function(decimal){return external.formatDecimal(decimal);}},data:function(){return{isClosedNotificationBanner:false,state:entity('AppState'),chats:entity('Chats').getResources(),header:entity('Chats').raw,customScroll:entity('Textmagic::CoreBundle::User').get('customScroll').raw};},mounted:function(){var that=this;if(!this.customScroll){return;}
elSimpleBar=new SimpleBar(document.getElementById('chat-contact-list'),{wrapContent:false,autoHide:true});elSimpleBar.el.SimpleBar.getScrollElement().addEventListener('scroll',function(e){return that.handleScroll(e);});if(this.notificationBannerShow()){this.notificationBannerClick();}},updated:function(){if(elSimpleBar){elSimpleBar.recalculate();}
if(!this.state.get('messagesScrollUp').raw){return;}
var objDiv=elSimpleBar?elSimpleBar.scrollContentEl:document.getElementById('chat-contact-list-scroll-content');if(!objDiv){return;}
this.$nextTick(function(){objDiv.scrollTop=0;if(elSimpleBar){elSimpleBar.recalculate();}});this.state.set('messagesScrollUp',false);}},chatListPopupMenu];exports.chatSimpleBar=function(){return elSimpleBar;};exports.init=function(){entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');external=container.get('Textmagic::CoreBundle::Component::External');dateFormat=container.get('Textmagic::ChatBundle::Utils::Date');chatActions=container.get('Textmagic::ChatBundle::Actions::Chat');chatListPopupMenu.mixins.push(chatActions);};container.register('Textmagic::ChatBundle::Components::ChatList',exports);})(global.AHServiceContainer);(function(container){var entity,apiCalls,apiHandler,external;var s=function(isSingleSelected){return isSingleSelected?'':'s';};var remove=function(){var isSingleSelected=entity('AppState').checkedChats().length==1;external.acceptModal('Delete chat'+s(isSingleSelected)+' confirmation','All messages contained in '
+(isSingleSelected?' this chat':' these chats')
+' will be <b>deleted permanently from all pages</b> and cannot be restored in future.','Delete',function(){var state=entity('AppState');var selected=state.checkedChats();var selectAll=state.isCheckedAllChats();var status=state.isClosedChatMode()?'c':'a';apiCalls().Chats.Bulk.remove(selected,selectAll,status);state.resetCheckedChats();});};var exports=[{template:'#chats-actions-bar',data:function(){return{state:entity('AppState')}},methods:{close:function(){var isSingleSelected=entity('AppState').checkedChats().length==1;external.acceptModal('Close chat'+s(isSingleSelected)+' confirmation','Are you sure you want to close'
+(isSingleSelected?' this chat?':' these chats?')
+'<br>You will later be able to reopen '+(isSingleSelected?'it':'them')+' from the "Closed" tab.','Close',function(){var selected=entity('AppState').checkedChats();var selectAll=entity('AppState').isCheckedAllChats();apiCalls().Chats.Bulk.close(selected,selectAll);entity('AppState').resetCheckedChats();});},remove:remove,markAsRead:function(){var selected=entity('AppState').checkedChats();var selectAll=entity('AppState').isCheckedAllChats();selected.map(function(id){entity('Chats').findById(id).set('unread',0);});apiCalls().Chats.Bulk.markAsRead(selected,selectAll);entity('AppState').resetCheckedChats();},markAsUnRead:function(){var selected=entity('AppState').checkedChats();var selectAll=entity('AppState').isCheckedAllChats();selected.map(function(id){var chat=entity('Chats').findById(id);if(chat&&chat.raw.unread==0){chat.set('unread',1);}});apiCalls().Chats.Bulk.markAsUnRead(selected,selectAll);entity('AppState').resetCheckedChats();}}},{template:'#chats-reopen-bar',data:function(){return{state:entity('AppState')}},methods:{reopen:function(){var isSingleSelected=entity('AppState').checkedChats().length==1;external.acceptModal('Reopen chat'+s(isSingleSelected)+' confirmation','Are you sure you want to reopen'
+(isSingleSelected?' this chat?':' these chats?'),'Reopen',function(){var selected=entity('AppState').checkedChats();var selectAll=entity('AppState').isCheckedAllChats();apiCalls().Chats.Bulk.reopen(selected,selectAll);entity('AppState').resetCheckedChats();});},remove:remove}},{template:'#chats-search-bar',methods:{chatSelectHandler:function(){this.text='';}},computed:{newChatSearchShow:function(){return this.state.get('visibility.chatPanel.newChat').raw&&this.state.get('visibility.chatPanel.subline').raw}},data:function(){return{state:entity('AppState')}}}];exports.init=function(){entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');apiHandler=container.get('Textmagic::ChatBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);external=container.get('Textmagic::ChatBundle::Component::External');};container.register('Textmagic::ChatBundle::Components::ChatsSublines',exports);})(global.AHServiceContainer);(function(container){var entity;var exports=[{template:'#chats-bottom-tabs',methods:{unreadClick:function(){var closed=this.state.get('visibility.chatPanel.closed').raw;if(!closed&&this.state.get('unreadOnly').raw){return;}
this.state.set('unreadOnly',true);this.state.resetToOpenTab();},openClick:function(){var closed=this.state.get('visibility.chatPanel.closed').raw;if(!closed&&!this.state.get('unreadOnly').raw){return;}
this.state.set('unreadOnly',false);this.state.resetToOpenTab();},closeClick:function(){var closed=this.state.get('visibility.chatPanel.closed').raw;if(closed){return;}
entity('Chats').reset();this.state.cancelChatSearch();this.state.cancelMessagesSearch();this.state.resetChatPanelVisibility({newChat:true,closed:true});this.state.resetCheckedChats();this.state.messagesChanged();entity('Chats').fetch('c');}},data:function(){return{state:entity('AppState')}}}];exports.init=function(){entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');};container.register('Textmagic::ChatBundle::Components::ChatsBottomTabs',exports);})(global.AHServiceContainer);(function(container){var entity;var exports=[{template:'#chat-side-bar',methods:{},data:function(){return{state:entity('AppState')}}}];exports.init=function(){entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');};container.register('Textmagic::ChatBundle::Components::ChatSideBar',exports);})(global.AHServiceContainer);(function(container){var entity,external;var timer=null;var apiCalls,apiHandler;var exports=[{template:'#new-chat-header',methods:{showUnreadChats:function(){this.state.set('unreadOnly',true);this.state.resetToOpenTab();},showAllChats:function(){this.state.set('unreadOnly',false);this.state.resetToOpenTab();},startNewChat:function(){this.state.toggleSubline();global.Vue.nextTick(function(){document.getElementById('input-chat-new-contact-serach').focus();});if(this.state.get('visibility.chatPanel.subline').raw==false){window.location.hash='';}},showChatSearch:function(){this.state.resetChatPanelVisibility({search:true,closed:this.state.get('visibility.chatPanel.closed').raw});global.Vue.nextTick(function(){document.getElementById('input-chat-search').focus();});},showChatActions:function(){this.state.resetChatPanelVisibility({actions:true,closed:this.state.get('visibility.chatPanel.closed').raw,subline:true});},markAllAsRead:function(){apiCalls().Chats.Bulk.markAsRead([],true);},beforeNotificationsModal:function(){var user=entity('Textmagic::CoreBundle::User');external.notificationSettingsForm.toggleAlert();external.notificationSettingsForm.setCheckboxState('dnShowNotifications',user.get('dnShowNotifications').raw);external.notificationSettingsForm.setCheckboxState('dnShowText',user.get('dnShowText').raw);external.notificationSettingsForm.setRadioState('sound',user.get('dnPlaySound').raw?user.get('dnSoundId').raw?'custom':'default':'off');},closeRead:function(){external.acceptModal('Close chats confirmation','Are you sure you want to close all read chats?'
+'<br>You will later be able to reopen them from the "Closed" tab.','Close',function(){apiCalls().Chats.Bulk.closeRead();});}},computed:{newChatSearchShow:function(){return this.state.get('visibility.chatPanel.newChat').raw&&this.state.get('visibility.chatPanel.subline').raw}},data:function(){return{state:entity('AppState'),chats:entity('Chats').getResources(),voice:entity('VoiceCall')}},mounted:function(){var that=this;window.onhashchange=function(){if(window.location.hash=="#new-chat"){that.startNewChat();}};external.notificationSettingsForm.init(function requestPermission(){if(typeof(Notification)==='undefined'||!Notification){return false;}
console.log('requestPermission');Notification.requestPermission();},function saveButtonClick(e){var data=external.notificationSettingsForm.getFormState();apiCalls().User.setNotifications(data);e.stopPropagation();e.preventDefault();global.jQuery('#notificationSettingsModal').modal('hide');return false;});}},{template:'#find-chat-header',methods:{cancelSearchHeader:function(){this.state.resetChatPanelVisibility({newChat:true,closed:this.state.get('visibility.chatPanel.closed').raw});this.updateChatSearch('');},updateChatSearch:function(query){if(!query){entity('AppState').set('visibility.chatList','list');entity('ChatsSearchResult').reset();if(timer){clearTimeout(timer);}
entity('AppState').set('chatSearchQuery','');return;}
if(query.length<1){if(timer){clearTimeout(timer);}
return;}
if(query.substring(0,1)==='+'){query=query.substring(1);}
if(timer){clearTimeout(timer);}
timer=setTimeout(function(){entity('ChatsSearchResult').fetch(query);},300);entity('AppState').set('chatSearchQuery',query);}},props:['query'],data:function(){return{state:entity('AppState')}},},{template:'#chat-actions-header',methods:{checkboxChange:function(chatId,checked){var ids=entity('Chats').loadedChatsIds();entity('AppState').resetCheckedChats(checked?ids:false);},cancelActionsHeader:function(){this.state.resetChatPanelVisibility({newChat:true,closed:this.state.get('visibility.chatPanel.closed').raw});this.state.resetCheckedChats();}},data:function(){return{state:entity('AppState')}}}];exports.init=function(){entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');apiHandler=container.get('Textmagic::ChatBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);external=container.get('Textmagic::ChatBundle::Component::External');};container.register('Textmagic::ChatBundle::Components::ChatsHeaders',exports);})(global.AHServiceContainer);(function(container){var entity,dateFormat,apiCalls,apiHandler,elSimpleBar;var exports=[{template:'#call-progress',methods:{startCall:function(){return this.voice.startCall();},endCall:function(){return this.voice.hangupCall();},chatName:function(chat){var contactName='';if(chat.contact!==null){contactName=(chat.contact.firstName+' '+chat.contact.lastName).replace('null','').trim();}
return chat.contact===null||chat.phone===contactName?'+'+chat.phone.replace('+','').trim():contactName;}},data:function(){return{voice:entity('VoiceCall'),user:entity('Textmagic::CoreBundle::User')}}},{template:'#call-ringing',methods:{answerCall:function(){return this.voice.answerCall();},rejectCall:function(){return this.voice.rejectCall();},chatName:function(chat){var contactName='';if(chat.contact!==null){contactName=(chat.contact.firstName+' '+chat.contact.lastName).replace('null','').trim();}
return chat.contact===null||chat.phone===contactName?'+'+chat.phone.replace('+','').trim():contactName;}},data:function(){return{voice:entity('VoiceCall'),user:entity('Textmagic::CoreBundle::User')}}}];exports.init=function(){entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');};container.register('Textmagic::ChatBundle::Components::CallProgress',exports);})(global.AHServiceContainer);(function(container){var entity,autocomplete,apiCalls,apiHandler;var timer=null;var exports=[{template:'#chat-autocomplete',methods:{onChange:function(event){autocomplete.updateAutocomplete(this.text);},onEnterDown:function(){var result=autocomplete.get('result');if(autocomplete.isEmpty()){return;}
this.onSelectAutocomplete(result.first().raw);},onSelectAutocomplete:function(value){var status='a';this.text='';apiCalls().Chats.getByPhone(value.value,{upsert:1},status);autocomplete.resetAutocompleteList();},showResultsPanel:function(){return!autocomplete.isEmpty()&&autocomplete.get('text').raw.length>0&&this.state.get('visibility.chatPanel.newChat').raw&&this.state.get('visibility.chatPanel.subline').raw;},buttonDisabled:function(){return autocomplete.isEmpty()||autocomplete.get('text').raw.length==0;}},data:function(){return{text:'',state:entity('AppState'),autocomplete:autocomplete};},}];exports.init=function(){entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');autocomplete=entity('Textmagic::CoreBundle::Autocomplete');apiHandler=container.get('Textmagic::ChatBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);};container.register('Textmagic::ChatBundle::Components::ChatAutocomplete',exports);})(global.AHServiceContainer);(function(container){var entity,external,apiCalls,apiHandler,dateFormat,singleChatActions={},externalCore;var timer;var getMessagesEntity=function(){return entity('AppState').isSearchResult()?entity('MessagesSearchResult'):entity('Messages');};var beforeAddContactFormOpen=function(chat){external.updateContactForm.fillPhoneField('+'+chat.phone);external.updateContactForm.resetTooltips();external.updateContactForm.onHideModal(function(){var chatId=entity('AppState').getActiveChatId();apiCalls().Chats.refreshChatData(chatId);});};var showMessagesSearch=function(){entity('AppState').resetMessagesPanelVisibility({search:true});entity('AppState').cancelChatSearch();global.Vue.nextTick(function(){document.getElementById('input-messages-search').focus();});};var dateFilter=function(){var query={startDate:dateFormat.format(entity('AppState').get('startDate').raw,"YYYY-MM-DD"),endDate:dateFormat.format(entity('AppState').get('endDate').raw,"YYYY-MM-DD 23:59:59")};entity('MessagesSearchResult').reset().fetch(query);entity('AppState').set('messagesSearchQuery',query);entity('AppState').setMessagesScrollDown(true);};var messagesHeaderControls={template:'#messages-header-controls',props:['chat'],mixins:[],methods:{startCall:function(){if(entity('AppState').isIE()){entity('AppState').showAlert('warning','','calls-not-allowed');return;}
var chat=this.state.getActiveChatRaw();if(!chat){return;}
return this.voice.startCall(chat);},endCall:function(){return this.voice.rejectCall();},isMuted:function(chat){return chat.mute>0&&(chat.mutedUntil==null||(new Date(chat.mutedUntil)).getTime()>=Date.now());},showMessagesSearch:showMessagesSearch,beforeAddContactFormOpen:beforeAddContactFormOpen,unblockContact:function(chat){if(!chat.contact){return false;}
external.acceptModal('Unblock confirmation','You will be able to exchange messages with this contact once unblocked. ','Unblock',function(){apiCalls().Contacts.Bulk.unblock([chat.contact.id]);chat.contact.blocked=false;});},checkChatData:function(){var chatId=entity('AppState').getActiveChatId();var ownedBy={ownedBy:'Chats',key:chatId};this.isEmptyChat=getMessagesEntity().getResources(ownedBy).length==0;},showAsPhone:function(item){var contactName='';if(item.contact!==null){contactName=(item.contact.firstName+' '+item.contact.lastName).replace('null','').trim();}
return item.contact===null||item.phone===contactName;},isMobileViewBelow500:function(){return document.body.clientWidth<500;},showNotesModal:function(chat,event){event.stopPropagation();event.preventDefault();var notesFrom=entity('NotesForm');notesFrom.setChat(chat).toggleModal(true,true);notesFrom.set('isNewNoteInputVisible',false);}},data:function(){return{voice:entity('VoiceCall'),state:entity('AppState'),isEmptyChat:true}}};var messagesDropDown={template:'#messages-header-drop-down',props:['chat','isEmptyChat'],mixins:[],methods:{showMessagesSelect:function(){entity('AppState').resetMessagesPanelVisibility({select:true});entity('AppState').hideAlert();},showNotesModal:function(chat){var notesFrom=entity('NotesForm');notesFrom.setChat(chat).toggleModal(true,true);notesFrom.set('isNewNoteInputVisible',true);notesFrom.set('isNewNoteInputVisible',true);setTimeout(function(){externalCore.placeCaretAtEnd(document.getElementById('noteInputIdNew'));},500);},download:function(){var chatId=entity('AppState').getActiveChatId();apiCalls().Chats.downloadPdf(chatId,[],1);},beforeSenderSettingsModalOpened:function(){var chatId=entity('AppState').getActiveChatId();external.senderSettingsModal.reloadContent(chatId);external.senderSettingsModal.onHideModal(function(){var chatId=entity('AppState').getActiveChatId();apiCalls().Chats.refreshChatData(chatId);});},dateFilter:function(){entity('AppState').resetMessagesPanelVisibility({date:true});dateFilter();},block:function(phone){var chatId=entity('AppState').getActiveChatId();var chat=entity('Chats').findById(chatId).raw;var contact=chat.contact;var info='+'+phone;if(contact){var name='';if(contact.firstName){name+=contact.firstName+' ';}
if(contact.lastName){name+=contact.lastName+' ';}
info=name+'('+info+')';}
var spanContact='<p><span class="badge badge-info"><span id="blocked-contact-name">'+info+'</span></span></p>';external.acceptModal('Block confirmation',spanContact+'You will no longer be able to exchange messages with this contact once it is blocked. You will later be able to unblock this contact.','Block',function(){apiCalls().Contacts.block({phone:phone},{chatId:chatId});});},unsubscribeContact:function(phone){var chatId=entity('AppState').getActiveChatId();var chat=entity('Chats').findById(chatId).raw;var contact=chat.contact;var info='+'+phone;if(contact){var name='';if(contact.firstName){name+=contact.firstName+' ';}
if(contact.lastName){name+=contact.lastName+' ';}
info=name+'('+info+')';}
var spanContact='<p><span class="badge badge-info"><span id="blocked-contact-name">'+info+'</span></span></p>';var chkName='block-incoming-chk';external.acceptModal('Unsubscribe contact',spanContact+'Contact will be permanently removed from your lists. All future messages to this number will be rejected by TextMagic. '+
'This applies to all your sub-accounts too.','Unsubscribe',function(elemState){apiCalls().Contacts.unsubscribe({phone:phone,blockIncoming:+elemState.checkboxes[chkName]},{chatId:chatId});},[{name:chkName,text:'Also block incoming messages from this number.',disableOnChange:true}],'unsubscribe-chat-modal');},unblockContact:function(chat){if(!chat.contact){return false;}
external.acceptModal('Unblock confirmation','You will be able to exchange messages with this contact once unblocked. ','Unblock',function(){apiCalls().Contacts.Bulk.unblock([chat.contact.id]);chat.contact.blocked=false;});},isMobileViewBelow500:function(){return document.body.clientWidth<500;},showMessagesSearch:showMessagesSearch,beforeAddContactFormOpen:beforeAddContactFormOpen,},data:function(){return{state:entity('AppState')};}};var exports=[{template:'#messages-header-mute-options',props:['chat','isEmptyChat'],methods:{sound:function(val){var chat=this.chat;if(val===1){entity('Chats').findById(chat.id).set('mute',0);apiCalls().Chats.unmute({ids:chat.id,all:0});return;}
if(val===0){apiCalls().Chats.mute(chat.id);return;}
apiCalls().Chats.mute(chat.id,val/60);return;},timeLeft:function(){var chat=this.chat;var user=entity('Textmagic::CoreBundle::User');var serverTimeVariance=user.get('serverTimeVariance').raw;var now=dateFormat.getTimeUTC();var to=dateFormat.getTimeUTC(chat.mutedUntil);var timeLeft=to-now-serverTimeVariance;var leftStr=dateFormat.moment().milliseconds(timeLeft).fromNow();return leftStr.replace('in ','~ ');},ending:function(val,prev){return this.isActive(val,prev)?'d':'';},isActive:function(val,prev){var chat=this.chat;var m=chat.mute;var mus=chat.mutedUntil;var isEnabled=!m&&!mus&&(val===1);var isDisabled=m&&!mus&&(val===0);if(isDisabled){return true;}
if(isEnabled){return true;}
if((val===1)&&!isEnabled){return false;}
if((val!==1)&&!m){return false;}
var user=entity('Textmagic::CoreBundle::User');var serverTimeVariance=user.get('serverTimeVariance').raw;var now=dateFormat.getTimeUTC();var to=dateFormat.getTimeUTC(chat.mutedUntil);var timeLeft=to-now+serverTimeVariance-1000;if(timeLeft<=0){return val===1}
var minutes=(timeLeft)/60000;return minutes>prev&&minutes<=val;},radioChange:function(value){}}},{template:'#messages-header-select',methods:{checkboxChange:function(messageId,checked){var chatId=this.state.getActiveChatId();var ids=getMessagesEntity().messagesIds(chatId);this.state.resetCheckedMessages(checked?ids:false);},cancelSelectHeader:function(){var prev=this.state.get('visibility.prevPanel').raw;var panels={};panels[prev]=true;this.state.resetMessagesPanelVisibility(panels);this.state.resetCheckedMessages();var chat=this.state.getActiveChatRaw();if(chat){this.state.updateBlockedContactWarning(chat);}},copy:function(e){var that=this;var $element=global.jQuery('#copyToClipboardAll');setTimeout(function(){$element.tooltip('hide');},1500);},remove:function(){external.acceptModal('Delete confirmation','Are you sure you want to delete the selected item'
+(this.state.checkedMessages().length==1?'?':'s?'),'Delete',function(){var state=entity('AppState');var checkedMessages=state.checkedMessages().map(function(id){return id;});if(checkedMessages.length==0){return;}
var selectAll=state.isCheckedAllMessages()&&!state.isSearchResult();var chatId=state.getActiveChatId();apiCalls().Chats.messagesRemove(chatId,checkedMessages,selectAll);state.resetCheckedMessages();});},download:function(){var state=entity('AppState');var messages=entity('Messages');var checkedMessages=state.checkedMessages().map(function(id){return messages.findById(id).raw;});if(checkedMessages.length==0){return;}
var selectAll=state.isCheckedAllMessages()&&!state.isSearchResult();var chatId=state.getActiveChatId();apiCalls().Chats.downloadPdf(chatId,checkedMessages,selectAll);}},data:function(){return{state:entity('AppState'),copyLabel:'Copy'};},mounted:function(){external.clipboard('#copyToClipboardAll',{text:function(trigger){return entity('AppState').checkedMessagesAsText();}});var $element=global.jQuery('#copyToClipboardAll');$element.tooltip('destroy').tooltip({container:'body',trigger:'click',delay:{"show":100,"hide":1000}});global.jQuery(document).bind('copy',function(){if(entity('AppState').get('visibility.messagesPanel.select').raw){global.jQuery('#copyToClipboardAll').click();}});var that=this;global.jQuery(document).keydown(function(e){if(e.ctrlKey||e.metaKey){if(e.keyCode==65||e.keyCode==97){if(global.jQuery('#newMsgText').is(":focus")){return true;}
that.checkboxChange(null,!that.state.isCheckedAllMessages());e.preventDefault();return false;}}});}},{template:'#messages-header-search',props:['query'],methods:{cancelMessagesSearch:function(){entity('AppState').cancelMessagesSearch();},updateMessagesSearch:function(query){entity('MessagesSearchResult').reset();if(!query){entity('AppState').set('visibility.messagesList','list');if(timer){clearTimeout(timer);}
entity('AppState').set('messagesSearchQuery','');return;}
if(query.length<1){if(timer){clearTimeout(timer);}
return;}
if(timer){clearTimeout(timer);}
timer=setTimeout(function(){entity('AppState').setMessagesScrollDown(true);entity('MessagesSearchResult').fetch(query);},300);entity('AppState').set('messagesSearchQuery',query);}},data:function(){return{state:entity('AppState')};}},{template:'#messages-header-date',methods:{dateFormatted:function(date){return dateFormat.format(date,'D MMM YYYY');},searchByDate:dateFilter,cancelMessagesSearch:function(){entity('AppState').cancelMessagesSearch();},initDatePickerEvents:function(){var that=this;var opt={keyboardNavigation:false,todayHighlight:true};var $startDateDp=global.jQuery('#messagesStartDate');var $endDateDp=global.jQuery('#messagesEndDate');$startDateDp.bootstrapDP(opt).on('changeDate',function(){var date=global.jQuery(this).bootstrapDP('getDate');$endDateDp.bootstrapDP('setStartDate',date);that.state.set('startDate',date);that.searchByDate();});opt.startDate=$startDateDp.bootstrapDP('getDate');global.jQuery('#messagesEndDate').bootstrapDP(opt).on('changeDate',function(){var date=global.jQuery(this).bootstrapDP('getDate');that.state.set('endDate',date);that.searchByDate();});}},data:function(){return{state:entity('AppState')};},mounted:function(){this.initDatePickerEvents();},updated:function(){var $startDateDp=global.jQuery('#messagesStartDate');var $endDateDp=global.jQuery('#messagesEndDate');$startDateDp.bootstrapDP().off('changeDate');$endDateDp.bootstrapDP().off('changeDate');var date1=this.state.get('startDate').raw;var date2=this.state.get('endDate').raw;$startDateDp.bootstrapDP('setDate',date1).bootstrapDP('update');$endDateDp.bootstrapDP('setStartDate',date1);$endDateDp.bootstrapDP('setDate',date2).bootstrapDP('update');this.initDatePickerEvents();}},{template:'#messages-header',methods:{getActiveChat:function(){var emptyChat={id:null,contact:null,phone:'',mute:0};var chatId=entity('AppState').get('activeChat').raw;var chat=entity('Chats').findById(chatId).raw;if(!chat){return emptyChat}
return chat;}},data:function(){return{state:entity('AppState')};}},messagesDropDown,messagesHeaderControls];exports.init=function(){entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');apiHandler=container.get('Textmagic::ChatBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);external=container.get('Textmagic::ChatBundle::Component::External');dateFormat=container.get('Textmagic::ChatBundle::Utils::Date');externalCore=container.get('Textmagic::CoreBundle::Component::External');var chatActions=container.get('Textmagic::ChatBundle::Actions::Chat');messagesDropDown.mixins.push(chatActions);messagesHeaderControls.mixins.push(chatActions);};container.register('Textmagic::ChatBundle::Components::MessagesHeader',exports);})(global.AHServiceContainer);(function(container){var timeout;var exports=[{template:'#chat-progress-bar',props:{progress:{type:Number,default:0}},methods:{}}];container.register('Textmagic::ChatBundle::Components::ChatProgressBar',exports);})(global.AHServiceContainer);(function(container){var entity,dateFormat,external,apiCalls,apiHandler,clipboard,copiedId,elSimpleBar;var lastMessageToScroll=false;var getMessagesEntity=function(){return entity('AppState').isSearchResult()?entity('MessagesSearchResult'):entity('Messages');};var exports=[{template:'#messages-empty-search-result',props:['query'],data:function(){return{state:entity('AppState'),header:entity('MessagesSearchResult').raw}}},{template:'#messages-list-popup-menu',props:['id','direction'],methods:{select:function(id){var state=entity('AppState');state.resetCheckedMessages(id);state.resetMessagesPanelVisibility({select:true});},details:function(id){var message=getMessagesEntity().findById(id).raw;if(!message){return;}
external.detailModal(message);},copy:function(id){copiedId=id;return true;},remove:function(id,direction){var item=(direction=='co'||direction=='ci'||direction=='cim')?'call':'message';external.acceptModal('Delete confirmation','Are you sure you want to delete this '+item+'?','Delete',function(){var chatId=entity('AppState').getActiveChatId();apiCalls().Chats.messagesRemove(chatId,[id]);});}}},{template:'#messages-list',methods:{onDragOver:function(panel){entity('AppState').hideAlert();this.dragoverPanel=panel;this.dragover=true;},onDrop:function(event){this.dragover=false;var that=this;var file=event.dataTransfer.files[0];var formData=new FormData();formData.append("file",file);if(this.dragoverPanel=='mms'){if(entity('AttachList').get('resources').raw.length>1){entity('AppState').showAlert('warning','Sorry, but no more than 2 files can be attached to MMS.');return false;}
apiCalls().Messages.uploadMmsAttachFileWithProgress(formData);}else{apiCalls().Messages.uploadAttachFileWithProgress(formData);}
return false;},time:function(timeStr){var offset=entity('Textmagic::CoreBundle::User').get('timezoneOffset').raw;var isAmPm=entity('Textmagic::CoreBundle::User').get('isUsingAmPm').raw;return dateFormat.timeFormat(timeStr,offset,null,isAmPm);},getResources:function(){var chatId=this.state.getActiveChatId();return getMessagesEntity().getGroupedByDate(chatId);},getSpinner:function(){return getMessagesEntity().get('spinner').raw},isTotalRowsBelowOnePage:function(){var appState=this.state;var messages=getMessagesEntity();var chatId=appState.getActiveChatId();var ownedBy=appState.isSearchResult()?undefined:{ownedBy:'Chats',key:chatId};return messages.rowsLoaded(ownedBy)<messages.pageSize||messages.pageLoaded(ownedBy)==messages.pageCount(ownedBy);},handleScroll:function(e){var el=e.target;var scrollPosition=el.scrollTop;var scrollBottom=scrollPosition+el.offsetHeight;var hasScroll=el.scrollHeight>el.clientHeight;var appState=this.state;var messages=getMessagesEntity();if(el.scrollHeight-scrollBottom<100){appState.setMessagesScrollDown(true);}else{appState.setMessagesScrollDown(false);}
lastMessageToScroll=false;if(scrollPosition<33&&hasScroll){var chatId=appState.getActiveChatId();var ownedBy=appState.isSearchResult()?undefined:{ownedBy:'Chats',key:chatId};var lastMessage=messages.last(ownedBy).raw;if(lastMessage){lastMessageToScroll=lastMessage.direction+lastMessage.id;}
if(appState.isSearchResult()){messages.fetch(appState.get('messagesSearchQuery').raw);return;}
messages.fetch(chatId,{firstPageOnly:false});}},checkboxChange:function(messageId,checked){var checkedMessages=entity('AppState').get('checkedMessages');if(checked){checkedMessages.append(messageId);}else{checkedMessages.remove(messageId);}},checkboxIsChecked:function(messageId){var checkedMessages=entity('AppState').get('checkedMessages');return checkedMessages.indexOf(messageId)>=0;},popUpMenuClick:function(e){var el=e.target;if(el.nodeName!='A'){el=e.target.parentNode;}
var containerHeight=document.getElementById('chat-messages-container').clientHeight;var popup=el.nextElementSibling;popup.className=popup.className.replace(' drop-upper','');if(e.pageY>containerHeight-80){popup.className+=' drop-upper';}},viewByDate:function(d){var date=dateFormat.moment(d).toDate();var startDate=dateFormat.moment(date).add(-1,'d');var endDate=dateFormat.moment(date).add(1,'d');this.state.set('startDate',startDate.toDate());this.state.set('endDate',endDate.toDate());this.state.resetMessagesPanelVisibility({date:true});var query={startDate:dateFormat.format(startDate,"YYYY-MM-DD"),endDate:dateFormat.format(endDate,"YYYY-MM-DD")};entity('MessagesSearchResult').reset().fetch(query);this.state.set('messagesSearchQuery',query);},imageOnLoad:function(){},scrollBlackMagic:function(){var that=this;var objDiv=document.getElementById('simplebar-content-123');this.$nextTick(function(){if(!objDiv||!this.customScroll)return;if(objDiv.scrollHeight<=objDiv.clientHeight&&objDiv.scrollHeight>0){objDiv.style.overflow='visible';}else{objDiv.style.overflow='auto';}});if(!objDiv||objDiv.scrollHeight==0){return;}
if(this.customScroll){if(!elSimpleBar){elSimpleBar=new SimpleBar(document.getElementById('chat-messages-container'),{wrapContent:false,autoHide:true});elSimpleBar.el.SimpleBar.getScrollElement().addEventListener('scroll',function(e){return that.handleScroll(e);});}
elSimpleBar.recalculate();}
var objDiv=elSimpleBar?elSimpleBar.scrollContentEl:document.getElementById('chat-messages-container');if(entity('AppState').getMessagesScrollDown()){Vue.nextTick(function(){objDiv.scrollTop=objDiv.scrollHeight;if(elSimpleBar){elSimpleBar.recalculate();}});return;}
if(!lastMessageToScroll){return;}
var e=document.getElementById(lastMessageToScroll);if(!e){return;}
e.scrollIntoView();var objDiv=elSimpleBar?elSimpleBar.scrollContentEl:document.getElementById('chat-messages-container');objDiv.scrollTop=objDiv.scrollTop-49-34;lastMessageToScroll=false;if(elSimpleBar){elSimpleBar.recalculate();}}},data:function(){return{dragoverPanel:null,dragover:false,progress:0,imagesTotal:0,state:entity('AppState'),header:entity('Messages'),customScroll:entity('Textmagic::CoreBundle::User').get('customScroll').raw};},updated:function(){global.jQuery('[data-toggle="tooltip"]').tooltip('destroy').tooltip({container:'body'});var audioPlayers=document.getElementsByTagName('audio');audioPlayers=Array.prototype.slice.call(audioPlayers);audioPlayers.forEach(function(player){player.addEventListener('playing',function(e){entity('AppState').set('currentAudioMessageId',e.target.dataset.message);});player.addEventListener('ended',function(){entity('AppState').set('currentAudioMessageId',null);});});this.scrollBlackMagic();},mounted:function(){external.clipboard('.copyToCLipboardSingle',{text:function(trigger){var state=entity('AppState');state.resetCheckedMessages([copiedId]);var text=state.checkedMessagesAsText();state.resetCheckedMessages();var parsed=container.get('Textmagic::CoreBundle::Services::MMS').parseRawMMS(text);if(parsed.media.length>0){return parsed.text;}
return text;}});}}];exports.init=function(){entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ChatBundle');apiHandler=container.get('Textmagic::ChatBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);external=container.get('Textmagic::ChatBundle::Component::External');dateFormat=container.get('Textmagic::ChatBundle::Utils::Date');};container.register('Textmagic::ChatBundle::Components::MessagesList',exports);})(global.AHServiceContainer);(function(container){var entity,external,base,apiCalls,apiHandler;var exports={init:function(){entity=container.get('Textmagic::FrameworkBundle::Entity');base=container.get('Textmagic::CoreBundle::Repository::BaseModalForm');entity({name:'Textmagic::ChatBundle::MmsUpload',initState:base.initForm({modalId:'vueMmsUploadModal',form:{},errors:{},alert:{show:false,text:''},loader:false}),methods:[base,this]});},showModal:function(){global.document.getElementById("attachMmsFileForm").reset();this.toggleModal(true,true);}};container.register('Textmagic::ChatBundle::Repository::MmsUpload',exports);})(global.AHServiceContainer);(function(container){var PAGE_SIZE=100;var entity,apiCalls,apiHandler,base,dateFormat;var exports={pageSize:PAGE_SIZE,refreshListPageSize:PAGE_SIZE,init:function(){entity=container.get('Textmagic::FrameworkBundle::Entity');apiHandler=container.get('Textmagic::ChatBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);dateFormat=container.get('Textmagic::ChatBundle::Utils::Date');base=container.get('Textmagic::CoreBundle::Repository::Base');entity({name:'Textmagic::ChatBundle::Chats',initState:function(){return{"ignoreChatCacheClear":false,"spinner":true,"pageLoaded":0,"rowsLoaded":0,"pageCount":1000000,"resources":[]};},methods:[base,this]});entity=entity.useBundle('Textmagic::ChatBundle');},fetch:function(status,activeChatId){if(this.pageLoaded()==0){this.set('spinner',true);}
apiCalls().Chats.list({status:status||'a',page:this.pageLoaded()+1,orderBy:'messageTime',direction:'desc',unread:entity('AppState').get('unreadOnly').raw},{status:status||'a',id:activeChatId?activeChatId:-1});},sortByDateTimeDesc:function(){var offset=entity('Textmagic::CoreBundle::User').get('timezoneOffset').raw;this.get('resources').sortBy(function(chat){var chatTime=dateFormat.moment(chat.updatedAt).utcOffset(offset);var multiplicator=chat.pinned?2:1;return chatTime.toDate().getTime()*multiplicator*10000+chat.id;},true)},loadedChatsIds:function(){return this.get('resources').map(function(chat){return chat.id}).raw;},refreshList:function(status,id){apiCalls().Chats.refreshList({status:status||'a',orderBy:'messageTime',direction:'desc',unread:entity('AppState').get('unreadOnly').raw},id);},refreshChat:function(chatId){apiCalls().Chats.refreshChatData(chatId);},hasPendingMessage:function(chatId){var ownedBy={ownedBy:'Chats',key:chatId};var dataSet=entity('Messages');if(dataSet.resourcesLength(ownedBy)==0){return false;}
return dataSet.first(ownedBy).raw.id<0;}};container.register('Textmagic::ChatBundle::Repository::Chats',exports);})(global.AHServiceContainer);(function(container){var PAGE_SIZE=20;var entity,apiCalls,base,apiHandler;var exports={pageSize:PAGE_SIZE,init:function(){entity=container.get('Textmagic::FrameworkBundle::Entity');apiHandler=container.get('Textmagic::ChatBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);entity({name:'Textmagic::ChatBundle::AttachList',initState:function(){return{"resources":[]};},methods:[this]});},getResources:function(){var chatId=entity('Textmagic::ChatBundle::AppState').getActiveChatId();return this.get('resources').filter(function(file){return file.chatId==chatId;}).raw;},prepareToSend:function(){return this.getResources().map(function(file){return file.resource;}).join(',');},append:function(obj){var chatId=entity('Textmagic::ChatBundle::AppState').getActiveChatId();if(!chatId){return true;}
obj['id']=(new Date()).getTime();obj['chatId']=chatId;this.get('resources').append(obj);},isEmpty:function(){var chatId=entity('Textmagic::ChatBundle::AppState').getActiveChatId();if(!chatId){return true;}
var res=this.get('resources').find(function(file){return file.chatId==chatId;});return res.raw==undefined;},remove:function(id){this.get('resources').remove(function(n){return n.id==id;});},removeAll:function(){var chatId=entity('Textmagic::ChatBundle::AppState').getActiveChatId();this.get('resources').remove(function(n){return n.chatId==chatId;});},sizeAll:function(){var totalSize=0;this.getResources().map(function(file){totalSize+=file.size*1;});return totalSize;},getMessageAsMediaTags:function(){return this.getResources().map(function(file){var tag='<media src="'+(file.isVideo?file.resourceS3FullUrl:file.resourceFullUrl)
+'" size="'+file.size
+'" width="'+file.width
+'" height="'+file.height
+'" video="'+(file.isVideo?'1':'0')
+'">'+file.name+'</media>';return tag;}).join('');}};container.register('Textmagic::ChatBundle::Repository::AttachList',exports);})(global.AHServiceContainer);(function(container){var entity,external,base,apiCalls,apiHandler;var exports={init:function(){entity=container.get('Textmagic::FrameworkBundle::Entity');base=container.get('Textmagic::CoreBundle::Repository::BaseModalForm');entity({name:'Textmagic::ChatBundle::NotesForm',initState:base.initForm({modalId:'vueNotesModal',chat:{contact:{notes:[]}},isNewNoteInputVisible:false,showNewNoteInputSpinner:false,currentActiveEditInputIds:[],isShowSpinnerById:{},isShowSpinnerForNewNoteInput:false}),methods:[base,this]});},addActiveEditInputId:function(id){this.get('currentActiveEditInputIds').raw.push(id);},removeActiveEditInputById:function(id){this.set('currentActiveEditInputIds',this.get('currentActiveEditInputIds').raw.filter(function(e){return e!==id}));},isActiveEditInputById:function(id){return this.get('currentActiveEditInputIds').raw.indexOf(id)>-1;},getOriginalChatNoteById:function(id){return this.get('chat').raw.contact.notes.find(function(note){return note.id===id}).note;},setChat:function(chat){this.set('chat',chat);return this;},deleteNote:function(id){this.set('chat.contact.notes',this.get('chat.contact.notes').raw.filter(function(e){return e.id!==id}));}};container.register('Textmagic::ChatBundle::Repository::NotesForm',exports);})(global.AHServiceContainer);(function(container){var entity,dateFormat,apiCalls,external,apiHandler;var exports={init:function(){entity=container.get('Textmagic::FrameworkBundle::Entity');apiHandler=container.get('Textmagic::ChatBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);external=container.get('Textmagic::ChatBundle::Component::External');dateFormat=container.get('Textmagic::ChatBundle::Utils::Date');entity({name:'Textmagic::ChatBundle::AppState',initState:function(){return{alert:{show:false,type:'warning',text:'',template:false,action:null},spinner:true,activeChat:null,messagesContentChanges:0,messagesScrollUp:false,messagesScrollDown:true,checkedChats:[],checkedMessages:[],visibility:{movedRight:false,chatPanel:{newChat:true,search:false,closed:false,actions:false,subline:false||window.location.hash=='#new-chat'},messagesPanel:{search:false,select:false,controls:true,date:false},prevPanel:null,chatList:'list',messagesList:'list'},showTextarea:true,sendButtonDisabled:false,prices:{},chatSearchQuery:'',messagesSearchQuery:'',startDate:dateFormat.moment(new Date()).add(-30,'d').toDate(),endDate:new Date(),staticFields:[{"id":1,"name":"First name"},{"id":2,"name":"Last name"},{"id":3,"name":"Company name"},{"id":4,"name":"Phone"},{"id":5,"name":"Email"}],syncConnected:false,currentAudioMessageId:null,preventChatSelect:false,newMessagesLineCount:0,typedTexts:{},unreadOnly:false,imagesLoaded:0,progress:0,emojiData:{},emojiBackMap:{},emojiForwardMap:{},}},methods:this});entity=entity.useBundle('Textmagic::ChatBundle');window.onblur=function(e){e.stopPropagation();e.preventDefault();entity('AppState').set('showTextarea',true);};global.app.tabvis(function(){var chatId=entity('AppState').getActiveChatId();var chat=entity('Chats').findById(chatId);entity('AppState').set('showTextarea',true);if(chat.raw&&chat.raw.unread>0){chat.set('unread',0);apiCalls().Chats.markAsRead(chat.raw.id);}});},isIE:function(){var ua=navigator.userAgent;var is_ie=ua.indexOf("MSIE ")>-1||ua.indexOf("Trident/")>-1;var is_edge=/Edge\/\d./i.test(ua);return is_ie||is_edge;},isAllowedMmsChat:function(){var chat=this.getActiveChatRaw();var user=entity('Textmagic::CoreBundle::User');return chat&&entity('AttachList').getResources().length==0&&chat.country&&user.get('hasBandwidthNumber').raw&&user.get('allowedMms').raw&&(chat.country.id=='US'||chat.country.id=='CA'||chat.country.id=='PR');},isUsCaPrChat:function(){var chat=this.getActiveChatRaw();return chat&&chat.country&&(chat.country.id=='US'||chat.country.id=='CA'||chat.country.id=='PR');},needToBuyNumber:function(){var chat=this.getActiveChatRaw();var user=entity('Textmagic::CoreBundle::User');return!user.get('hasBandwidthNumber').raw&&chat&&chat.country&&(chat.country.id=='US'||chat.country.id=='CA'||chat.country.id=='PR');},createEmojiBackMap:function(){var objBackMap={};var objForwardMap={};this.get('emojiData.emojis').forEach(function(val,key){objBackMap[val.unified.split('-')[0].toUpperCase()]=key;objForwardMap[key]=val.unified.split('-')[0].toUpperCase();});this.set('emojiBackMap',objBackMap);this.set('emojiForwardMap',objForwardMap);},isForbiddenCountryChat:function(country){var user=entity('Textmagic::CoreBundle::User').raw;return!user.allowSendForbiddenCountry&&user.signUpForbiddenCountries.indexOf(country)>-1},badVeryBadDirtyFunction:function(componentState){if(!componentState||!componentState.hasOwnProperty('setTextareaText')){return;}
var appstate=entity('AppState');componentState.setTextareaText(appstate.oldTypedText());},oldTypedText:function(){var chatId=this.getActiveChatId();var exist=this.get('typedTexts').has(chatId).raw;return exist?this.get('typedTexts').get(chatId).raw:'';},cancelMessagesSearch:function(){entity('MessagesSearchResult').reset();this.setMessagesScrollDown(true);this.set('messagesSearchQuery','');this.set('visibility.messagesList','list');this.resetMessagesPanelVisibility({controls:true});},cancelChatSearch:function(){entity('ChatsSearchResult').reset();this.set('chatSearchQuery','');this.set('visibility.chatList','list');},isSearchResult:function(){var query=this.get('messagesSearchQuery').raw;var queryIsNonEmptyString=query.length>0;var queryIsObject=typeof query=='object';return queryIsNonEmptyString||queryIsObject;},hideAlert:function(){this.set('alert.show',false);this.set('alert.type','warning');this.set('alert.text','');this.set('alert.template',false);this.set('alert.action',null);},showAlert:function(type,text,template,action){this.set('alert.show',true);this.set('alert.type',type);this.set('alert.text',text);this.set('alert.template',template);this.set('alert.action',action);},isCheckedAllChats:function(){var resLength=entity('Chats').resourcesLength();return this.get('checkedChats').raw.length==resLength&&resLength>0},hasCheckedChats:function(){return this.get('checkedChats').raw.length>0},checkedChats:function(){return this.get('checkedChats').raw},isCheckedChatsHasUnread:function(){var checked=this.get('checkedChats').raw;var chats=entity('Chats');for(var i=0;i<checked.length;i++){var chat=chats.findById(checked[i]).raw;if(chat&&chat.unread>0){return true;}}
return false;},resetCheckedChats:function(data){this.get('checkedChats').remove(function(){return true;}).raw.length=0;if(!data){return this;}
this.get('checkedChats').append(data);return this;},isCheckedAllMessages:function(){var messages=this.isSearchResult()?entity('MessagesSearchResult'):entity('Messages');var ownedBy=this.isSearchResult()?undefined:{ownedBy:'Chats',key:this.getActiveChatId()};return this.checkedMessages().length==messages.rowsLoaded(ownedBy)&&messages.rowsLoaded(ownedBy)>0;},checkedMessages:function(){return this.get('checkedMessages').raw},hasCheckedMessages:function(){return this.get('checkedMessages').raw.length>0},resetCheckedMessages:function(data){this.get('checkedMessages').remove(function(){return true;}).raw.length=0;if(!data){return this;}
this.get('checkedMessages').append(data);return this;},checkedMessagesAsText:function(){var messages=this.isSearchResult()?entity('MessagesSearchResult'):entity('Messages');var offset=entity('Textmagic::CoreBundle::User').get('timezoneOffset').raw;var messagesTotal=this.checkedMessages().length;return this.checkedMessages().map(function(id){var m=messages.findById(id).raw;var mtf=dateFormat.dayMonthYearHour(m.messageTime,offset);var senderInfo='['+mtf+'] '
+(m.firstName+' '+m.lastName).replace('null','').trim()
+': ';return(messagesTotal>1?senderInfo:'')+container.get('Textmagic::CoreBundle::Services::MMS').parseRawMMS(m.text).text;}).reverse().join("\n");},resetMessagesPanelVisibility:function(over){var cp=this.get('visibility.messagesPanel');var prev=cp.find(true).raw;this.set('visibility.prevPanel',prev);cp.set('search',false).set('select',false).set('date',false).set('controls',false);if(over==undefined){return this;}
cp.merge(over);if(cp.get('select').raw){this.set('newMessagesLineCount',0);}
if(cp.get('select').raw||cp.get('search').raw||cp.get('date').raw){var closed=this.get('visibility.chatPanel.closed').raw;this.resetChatPanelVisibility({newChat:true,closed:closed});}
return this;},resetChatPanelVisibility:function(over){var cp=this.get('visibility.chatPanel');cp.set('newChat',false).set('search',false).set('closed',false).set('actions',false).set('subline',false);if(over==undefined){return this;}
cp.merge(over);if(cp.get('search').raw||cp.get('actions').raw||cp.get('subline').raw){this.cancelMessagesSearch();}
return this;},toggleSubline:function(val){var path='visibility.chatPanel.subline';if(val!=undefined){this.set(path,val);return this;}
var state=this.get(path).raw;this.set(path,!state);return this;},setMessagesScrollDown:function(d){this.set('messagesScrollDown',d);return this;},getMessagesScrollDown:function(){return this.get('messagesScrollDown').raw;},messagesChanged:function(){this.set('messagesContentChanges',this.get('messagesContentChanges').raw+1);},getActiveChatRaw:function(){var chatId=this.getActiveChatId();if(chatId!==-1){return entity('Chats').findById(chatId).raw;}
if(entity('Chats').getResources().length>0){return entity('Chats').getResources()[0].raw;}},getActiveChatId:function(){return this.get('activeChat').raw;},setActiveChat:function(id){var chats=entity('Chats');var messaages=entity('Messages');var newActiveChat=null;this.resetCheckedMessages();this.set('showTextarea',true);var chat=chats.findById(id).raw;if(chat){newActiveChat=chat.id;this.set('activeChat',newActiveChat);messaages.fetch(newActiveChat,{firstPageOnly:true});this.updateBlockedContactWarning(chat);this.cancelMessagesSearch();this.set('newMessagesLineCount',0);if(chat.unread>0){this.set('newMessagesLineCount',chat.unread);setTimeout(function(){chat.unread=0;apiCalls().Chats.markAsRead(chat.id);},1000);}
this.badVeryBadDirtyFunction();this.setMessagesScrollDown(true);this.messagesChanged();if(this.get('unreadOnly').raw){var status=(this.isClosedChatMode()?'c':null);chats.refreshList(status);}
return this;}
if(chats.get('resources').raw.length==0){newActiveChat=null;this.set('activeChat',newActiveChat);this.badVeryBadDirtyFunction();messaages.fetch(newActiveChat,{firstPageOnly:true});this.updateBlockedContactWarning(newActiveChat);return this;}
newActiveChat=chats.get('resources').first().get('id').raw;messaages.fetch(newActiveChat,{firstPageOnly:true});this.set('activeChat',newActiveChat);var newActiveChatObject=chats.findById(newActiveChat).raw;if(newActiveChatObject){this.updateBlockedContactWarning(newActiveChatObject);}
return this;},hasLoadedChats:function(){return entity('Chats').get('resources').raw.length>0;},updateBlockedContactWarning:function(chat){entity('AppState').hideAlert();if(!chat){return;}
var user=entity('Textmagic::CoreBundle::User');var lnByCountry=user.get('localNumbersByCountry').raw;var totalSenderId=user.get('totalSenderId').raw;if(chat.unsubscribedContactId>0){entity('AppState').showAlert('warning','This contact has unsubscribed from your lists. No messages can be sent to this contact');}
else if(chat.contact&&chat.contact.blocked&&chat.contact.user.username==user.get('username').raw){var action=function(){if(!chat.contact){return false;}
external.acceptModal('Unblock confirmation','You will be able to exchange messages with this contact once unblocked. ','Unblock',function(){apiCalls().Contacts.Bulk.unblock([chat.contact.id]);chat.contact.blocked=false;});};entity('AppState').showAlert('warning','','blocked',action);}
else if(chat.status=='c'){entity('AppState').showAlert('warning','This chat is closed. If you send or receive a text message, it will be reopened automatically.');}
else if(chat.country&&chat.country.id!=='FR'&&lnByCountry.hasOwnProperty(chat.country.id)&&lnByCountry[chat.country.id]==0){}
else if(chat.country&&chat.country.id=='FR'&&lnByCountry.hasOwnProperty(chat.country.id)&&lnByCountry[chat.country.id]==0&&totalSenderId===0){entity('AppState').showAlert('warning','','buy-nubmer-or-senderid',chat.country.id);}},setPrices:function(prices){this.set('prices',prices);},getPrices:function(){return this.get('prices').raw;},setSyncConnected:function(state){this.set('syncConnected',!!state);},getSyncConnected:function(){return!!this.get('syncConnected').raw;},isClosedChatMode:function(){return this.get('visibility').raw.chatPanel.closed;},refreshUnreadCount:function(){apiCalls().Chats.refreshUnreadCount();},resetToOpenTab:function(){entity('Chats').reset().fetch();this.cancelChatSearch();this.cancelMessagesSearch();this.resetChatPanelVisibility({newChat:true});this.resetCheckedChats();this.messagesChanged();},authFailureWarning:function(){entity('AppState').showAlert('warning','','auth-failure');}};container.register('Textmagic::ChatBundle:Repository::AppState',exports);})(global.AHServiceContainer);(function(container){var entity,external,base,apiCalls,apiHandler;var exports={init:function(){entity=container.get('Textmagic::FrameworkBundle::Entity');base=container.get('Textmagic::CoreBundle::Repository::BaseModalForm');entity({name:'Textmagic::ChatBundle::NewAttachment',initState:base.initForm({modalId:'vueNewAttachment',form:{},errors:{},}),methods:[base,this]});},showModal:function(){this.toggleModal(true,true);},hideModal:function(){this.toggleModal(false,false);}};container.register('Textmagic::ChatBundle::Repository::NewAttachment',exports);})(global.AHServiceContainer);(function(container){var entity,external,callAgent,apiCalls,apiHandler,dateFormat,beforeUnload;var exports={statuses:{'STATUS_HANGUP':'h','STATUS_CONNECTING':'n','STATUS_CALLING':'c','STATUS_BUSY':'b','STATUS_IN_PROGRESS':'p','STATUS_RINGING':'r'},init:function(){apiHandler=container.get('Textmagic::ChatBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);external=container.get('Textmagic::ChatBundle::Component::External');entity=container.get('Textmagic::FrameworkBundle::Entity');dateFormat=container.get('Textmagic::ChatBundle::Utils::Date');entity({name:'Textmagic::ChatBundle::VoiceCall',initState:function(){return{"asterisk":false,"calling":false,"chat":null,"muted":false,"callObject":null,"status":'h',"duration":0,"ticker":null,"callerId":null,"callerCountry":null,"callPrice":0,"allowedCountries":['AU','BE','AT','NL','GG','JE','IM','MY','GB','IL','DK','HK','CZ','KR','US','CA','EE','RU','PR','FI','PL','CA','SE','FR','RO','ID']};},methods:[this]});entity=entity.useBundle('Textmagic::ChatBundle');},destroyCalls:function(){console.log('destroyCalls');callAgent=null;window.removeEventListener("beforeunload",beforeUnload);},initCalls:function(){console.log('InitCalls');var that=this;var config={media:{remote:{video:false,audio:global.document.getElementById('remoteAudio')}},ua:that.get('asterisk').raw};config.ua.uri=that.get('asterisk.endpoint').raw+'@'+that.get('asterisk.aorsDomain').raw;callAgent=new global.SIP.Web.Simple(config);callAgent.on('connecting',function(){that.set('status',that.statuses.STATUS_CALLING);});callAgent.on('new',function(){});callAgent.on('ringing',function(session){if(external.shouldSuppressNotifications()){console.log('Rejecting inbound call event because we are running in Electron');return false;}else{console.log('Incoming call...');}
var callerId=session.remoteIdentity.displayName;that.set('status',that.statuses.STATUS_RINGING);that.set('callerId',callerId);var validatedPhone=that.parsePhone('+'+callerId,'');var prices=entity('Textmagic::CoreBundle::CallPrices');if(validatedPhone&&validatedPhone.country&&prices.get(validatedPhone.country).raw){var callPrice=prices.get(validatedPhone.country).raw;that.set('callerCountry',validatedPhone.country);that.set('callPrice',parseFloat(callPrice.inbound));}
var chat=entity('Chats').findBy({phone:callerId});if(!chat.raw){var status='a';apiCalls().Chats.getByPhone(callerId,{upsert:1},status);external.playRingToneSound();return;}else{if(!that.isChatMuted(chat.raw)){external.playRingToneSound();}}
that.set('chat',JSON.parse(JSON.stringify(chat.raw)));});callAgent.on('connected',function(){that.set('status',that.statuses.STATUS_IN_PROGRESS);that.set('calling',true);that.set('muted',false);that.startTicker();external.stopCallRingingSound();external.stopRingToneSound();});callAgent.on('ended',function(){that.endCall();that.set('callObject',null);});beforeUnload=function(e){if(that.isCallActive()||that.isCallRinging()){var confirmationMessage='Are you sure you want to close this tab? Your ongoing call will be disconnected. ';Vue.nextTick(function(){entity('AppState').showAlert('warning',confirmationMessage);});e.preventDefault();(e||window.event).returnValue=confirmationMessage;return confirmationMessage;}};window.addEventListener("beforeunload",beforeUnload);return callAgent;},getCallAgent:function(){return callAgent;},startCall:function(chat){if(this.get('calling').raw){return;}
var that=this;this.set('calling',true);this.set('muted',false);this.set('status',this.statuses.STATUS_CONNECTING);this.set('chat',JSON.parse(JSON.stringify(chat)));external.playCallRingingSound();var call=callAgent.call(chat.phone);call.on('failed',function(request){external.stopCallRingingSound();external.stopRingToneSound();var errorStrBusy='Could not connect your call. The number is busy.';var errorStrLowBalance='Could not connect your call. Please buy credit to make calls.';var errorStrFailed='Could not connect your call. Please try again later or contact support.';if(request&&request.status_code&&request.reason_phrase){var sc=request.status_code;if(sc==487){return;}
if(sc==486||sc==600){entity('AppState').showAlert('warning',errorStrBusy);external.playBusySound();return;}
if(sc==603){entity('AppState').showAlert('warning',errorStrLowBalance);return;}
if(sc==408||sc==410||sc==430||sc==480){entity('AppState').showAlert('warning',errorStrFailed);return;}
entity('AppState').showAlert('warning',errorStrFailed+' ('+request.status_code+')');}});that.set('callObject',call);that.set('status',that.statuses.STATUS_CALLING);var validatedPhone=that.parsePhone('+'+chat.phone,'');var prices=entity('Textmagic::CoreBundle::CallPrices');if(validatedPhone&&validatedPhone.country&&prices.get(validatedPhone.country).raw){var callPrice=prices.get(validatedPhone.country).raw;that.set('callerCountry',validatedPhone.country);that.set('callPrice',parseFloat(callPrice.outbound));}
if(!call){return that.endCall();}
global.Vue.nextTick(function(){external.resize();});},endCall:function(){if(callAgent.session&&!callAgent.session.hasOwnProperty('cancel')){console.log('Hangup Call');callAgent.hangup();}
console.log('End Call');external.stopCallRingingSound();external.stopRingToneSound();this.stopTicker();this.set('calling',false);this.set('muted',false);this.set('chat',null);this.set('status',this.statuses.STATUS_HANGUP);this.set('duration',0);global.Vue.nextTick(function(){external.resize();});},hangupCall:function(){this.endCall();},answerCall:function(){var that=this;var call=callAgent.answer();console.log('ANSWEERRRR',call);that.set('callObject',call);if(!call){return that.endCall();}},rejectCall:function(){if(callAgent.session&&!callAgent.session.hasOwnProperty('cancel')){console.log('Reject Call');try{callAgent.reject();}catch(e){}}
this.endCall();},isCallActive:function(){return this.get('calling').raw;},isCallRinging:function(){return this.get('status').raw==this.statuses.STATUS_RINGING;},getChat:function(){return this.get('chat').raw;},isMuted:function(){return this.get('muted').raw;},mute:function(val){if(val){callAgent.mute();}else{callAgent.unmute();}
return this.set('muted',val);},getStatusLabel:function(){switch(this.get('status').raw){case this.statuses.STATUS_HANGUP:return 'Call ended';case this.statuses.STATUS_CONNECTING:return 'Connecting...';case this.statuses.STATUS_RINGING:return 'Ringing...';case this.statuses.STATUS_CALLING:return 'Calling...';case this.statuses.STATUS_BUSY:return 'Busy';case this.statuses.STATUS_IN_PROGRESS:var duration=global.moment.duration(this.get('duration').raw,'seconds');var minutes=duration.minutes();var seconds=duration.seconds();return minutes+':'+(seconds<10?'0':'')+seconds;}},startTicker:function(){var _this=this;this.set('ticker',setInterval(function(){_this.set('duration',_this.get('duration').raw+1);},1000));},stopTicker:function(){clearInterval(this.get('ticker').raw);this.set('ticker',null);},parsePhone:function(phone,country){var phoneNumberUtil=global.window.i18n.phonenumbers.PhoneNumberUtil.getInstance();var data=phoneNumberUtil.transformPhoneNumber(phone.replace(/^00/,'+'),country);return data;},isChatMuted:function(chat){return chat.mute>0&&(chat.mutedUntil==null||dateFormat.moment(chat.mutedUntil).toDate().getTime()>=Date.now());}};container.register('Textmagic::ChatBundle::Repository::VoiceCall',exports);})(global.AHServiceContainer);(function(container){var entity,external,base,ulilsFile,apiHandler;var exports={init:function(){entity=container.get('Textmagic::FrameworkBundle::Entity');base=container.get('Textmagic::CoreBundle::Repository::BaseModalForm');ulilsFile=container.get('Textmagic::CoreBundle::Utils::File');entity({name:'Textmagic::ChatBundle::FilePreviewUpload',initState:base.initForm({modalId:'vueFilePreviewUploadModal',form:{},errors:{},file:{},type:'mms'}),methods:[base,this]});},showModal:function(type){this.toggleModal(true,true);},getServerName:function(){return window.location.protocol+'//'+window.location.host+'/';},getLinkFullUrl:function(){return this.getServerName()+this.get('file.href').raw;},getFileHash:function(){return this.get('file.href').raw.replace('click/','');},getResourceFullUrl:function(){return this.getServerName()+'upload/'+this.getFileHash();},getResourceS3FullUrl:function(){return this.getServerName()+'s3/upload/'+this.get('file.resource').raw;},getThumbnailFullUrl:function(){return this.getServerName()
+'s3/upload/'
+this.get('file.resource').raw.replace(this.getFileExt(),'_thumbnail.jpg');},getFileExt:function(){var filename=this.get('file.resource').raw;return ulilsFile.getFileExt(filename);},getFileSizeLabel:function(){return ulilsFile.getFileSizeLabel(this.get('file.size').raw);},isImage:function(){var filename=this.get('file.resource').raw;return ulilsFile.isImage(filename);},isVideo:function(){var filename=this.get('file.resource').raw;return ulilsFile.isVideo(filename);},getFileRaw:function(){var file=this.get('file').raw;file['isImage']=this.isImage();file['isVideo']=this.isVideo();file['fileExt']=this.getFileExt();file['resourceFullUrl']=this.getResourceFullUrl();file['resourceS3FullUrl']=this.getResourceS3FullUrl();file['thumbnail']=file['isVideo']?this.getThumbnailFullUrl():false;file['fileSizeLabel']=this.getFileSizeLabel();return file;}};container.register('Textmagic::ChatBundle::Repository::FilePreviewUpload',exports);})(global.AHServiceContainer);(function(container){var PAGE_SIZE=20;var entity,apiCalls,base,apiHandler;var exports={pageSize:PAGE_SIZE,init:function(){entity=container.get('Textmagic::FrameworkBundle::Entity');apiHandler=container.get('Textmagic::ChatBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);base=container.get('Textmagic::CoreBundle::Repository::Base');entity({name:'Textmagic::ChatBundle::ChatsSearchResult',initState:function(){return{"spinner":true,"pageLoaded":0,"rowsLoaded":0,"pageCount":1000000,"resources":[]};},methods:[base,this]});},fetch:function(query){apiCalls().Chats.search(query);}};container.register('Textmagic::ChatBundle::Repository::ChatsSearchResult',exports);})(global.AHServiceContainer);(function(container){var PAGE_SIZE=20;var entity,apiCalls,base,dateFormat,apiHandler;var exports={pageSize:PAGE_SIZE,init:function(){entity=container.get('Textmagic::FrameworkBundle::Entity');apiHandler=container.get('Textmagic::ChatBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);dateFormat=container.get('Textmagic::ChatBundle::Utils::Date');base=container.get('Textmagic::CoreBundle::Repository::Base');entity({name:'Textmagic::ChatBundle::Messages',initState:function(){return{}},methods:[base,this]});entity=entity.useBundle('Textmagic::ChatBundle');},getGroupedByDate:function(chatId){var messages=this.getResources({ownedBy:'Chats',key:chatId});var unread=entity('AppState').get('newMessagesLineCount').raw;var offset=entity('Textmagic::CoreBundle::User').get('timezoneOffset').raw;var result=[];var i=messages.length;var prev='';var prevDate;var prevDirection='*';var messagesGrouped=[];while(i--){var message=messages[i];var isUreadMessage=false;var key=dateFormat.monthDayYear(message.messageTime,offset);if((key!==prev&&prev!=='')||isUreadMessage){result.push({dateFormatted:prev,date:prevDate,messages:messagesGrouped});messagesGrouped=new Array(0);prevDirection='*';}
message.first=prevDirection!=message.direction;prev=key;prevDate=message.messageTime;prevDirection=message.direction;messagesGrouped.push(message);}
if(prev===''){return result;}
result.push({dateFormatted:prev,date:prevDate,messages:messagesGrouped});return result;},fetch:function(chatId,options){var defaults={firstPageOnly:false};var opt=global.Sugar.Object.merge(defaults,options);var chat=entity('Chats').findById(chatId).raw;if(!chat){return;}
var pageLoaded=this.pageLoaded({ownedBy:'Chats',key:chat.id});if(opt.firstPageOnly&&pageLoaded>0){return;}
var page=pageLoaded+1;var options1={chat:chat,reset:options&&options.reset?true:false};apiCalls().Messages.list(chat.id,{page:page},options1);},refreshList:function(chat){if(!chat){return;}
for(var owner in this.raw){if(!this.hasOwnProperty(owner)){continue;}
if(!this.get(owner).has('resources').raw){continue;}
var model=owner.split('_')[0];var key=owner.split('_')[1];if(key==chat.id){continue;}
var ownedBy={ownedBy:model,key:key};this.reset(ownedBy);}
var options={chat:chat,reset:true};apiCalls().Messages.refreshList(chat.id,{page:1},options);},messagesIds:function(chatId){return this.getResources({ownedBy:'Chats',key:chatId}).map(function(message){return message.id});},insertToChat:function(chatId,message){var chat=entity('Chats').findById(chatId).raw;if(!chat){return;}
var ownedBy={ownedBy:'Chats',key:chat.id};var dataSet=this.ownedBy(ownedBy);if(!dataSet.has('pageLoaded').raw){return;}
var rows=dataSet.get('rowsLoaded').raw;dataSet.set('rowsLoaded',rows+1);this.upsertResource(message,ownedBy);}};container.register('Textmagic::ChatBundle::Repository::Messages',exports);})(global.AHServiceContainer);(function(container){var PAGE_SIZE=20;var entity,apiCalls,apiHandler,base,dateFormat;var exports={pageSize:PAGE_SIZE,init:function(){entity=container.get('Textmagic::FrameworkBundle::Entity');apiHandler=container.get('Textmagic::ChatBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);dateFormat=container.get('Textmagic::ChatBundle::Utils::Date');base=container.get('Textmagic::CoreBundle::Repository::Base');entity({name:'Textmagic::ChatBundle::MessagesSearchResult',initState:function(){return{"spinner":true,"pageLoaded":0,"rowsLoaded":0,"pageCount":1000000,"resources":[]};},methods:[base,this]});entity=entity.useBundle('Textmagic::ChatBundle');},fetch:function(query){var chatId=entity('AppState').getActiveChatId();apiCalls().Messages.search(chatId,query);},messagesIds:function(){return this.getResources().map(function(message){return message.id});},getGroupedByDate:function(){var offset=entity('Textmagic::CoreBundle::User').get('timezoneOffset').raw;var messages=this.getResources();var result=[];var i=messages.length;var prev='';var prevDate;var prevDirection='*';var messagesGrouped=[];while(i--){var message=messages[i];var key=dateFormat.monthDayYear(message.messageTime,offset);message.first=prevDirection!=message.direction||messagesGrouped.length==0;if(key!==prev&&prev!==''){result.push({dateFormatted:prev,date:prevDate,messages:messagesGrouped});messagesGrouped=[];}
prev=key;prevDate=message.messageTime;prevDirection=message.direction;messagesGrouped.push(message);}
if(prev===''){return result;}
result.push({dateFormatted:prev,date:prevDate,messages:messagesGrouped});return result;},};container.register('Textmagic::repository::messages-search-result',exports);})(global.AHServiceContainer);(function(container){var entity,external,base,apiCalls,apiHandler;var exports={init:function(){entity=container.get('Textmagic::FrameworkBundle::Entity');base=container.get('Textmagic::CoreBundle::Repository::BaseModalForm');entity({name:'Textmagic::ChatBundle::AttachUpload',initState:base.initForm({modalId:'vueAttachUploadModal',form:{},errors:{},alert:{show:false,text:''},href:'',loader:false,}),methods:[base,this]});},showModal:function(){global.document.getElementById("attachLinkFileForm").reset();this.toggleModal(true,true);}};container.register('Textmagic::ChatBundle::Repository::AttachUpload',exports);})(global.AHServiceContainer);(function(container){var entity;var exports={init:function(){entity=container.get('Textmagic::FrameworkBundle::Entity');}};exports.getTimeUTC=function getTimeUTC(str){var tmLoc=str?global.moment(str).toDate():new Date();return tmLoc.getTime()+tmLoc.getTimezoneOffset()*60000;};exports.moment=function(d){return global.moment(d);};exports.format=function(utcTimeString,format,offset){if(!utcTimeString||!global.moment)return '';return global.moment(utcTimeString).format(format);};exports.timeFormat=function(utcTimeString,offset,timezone,isAmPm){if(!offset){offset=0;}
if(!utcTimeString||!global.moment)return '';var timezone=entity('Textmagic::CoreBundle::User').get('timezone').raw;var isDST=global.moment(utcTimeString).utcOffset(offset).tz(timezone).isDST();return global.moment(utcTimeString).utcOffset(offset).format(!isAmPm?'HH:mm':'h:mm a');};exports.timeFormatFromSeconds=function(s){return global.moment("2018-01-01").startOf('day').seconds(s).format('H:mm:ss');};exports.timeFormatFromNow=function(utcTimeString,offset){if(!utcTimeString||!global.moment)return '';if(!offset){offset=0;}
var mtt=global.moment(utcTimeString).utcOffset(offset);var ct=new Date().getTime();var mt=mtt.toDate().getTime();var timeLabel;if(ct-mt<60*1000){timeLabel='just now';}
else if(ct-mt<2*24*60*60*1000){timeLabel=mtt.fromNow();}
else{timeLabel=mtt.format('D MMM');}
return timeLabel;};exports.monthDayYear=function(utcTimeString,offset){if(!offset){offset=0;}
return global.moment(utcTimeString).utcOffset(offset).format('MMM D, YYYY');};exports.dayMonthYearHour=function(utcTimeString,offset){if(!offset){offset=0;}
var timezone=entity('Textmagic::CoreBundle::User').get('timezone').raw;var isDST=global.moment(utcTimeString).utcOffset(offset).tz(timezone).isDST();if(isDST){offset=offset+60;}
return global.moment(utcTimeString).utcOffset(offset).format('D MMM YYYY, HH:mm a');};container.register('Textmagic::ChatBundle::Utils::Date',exports);})(global.AHServiceContainer);