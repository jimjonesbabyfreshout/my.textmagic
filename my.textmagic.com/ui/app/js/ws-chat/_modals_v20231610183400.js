;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;(function(container){var entity,thisApiHandler,defaultApiHandler,apiCalls,external,app;var nop=function(){};var nopHandler={done:nop,fail:nop,always:nop};var formErrorsHandler=function(entityName){return function(xhr,message){var json=xhr.responseJSON;if(json.errors&&json.errors.hasOwnProperty('fields')){entity(entityName).loadErrors(json.errors.fields);}
if(json.message&&json.code==403){external.alert('warning',json.message);}}};var commonFormSaveHandler=function(form,successMessage,woIncCount){return{done:function(res){entity(form).toggleModal(false);external.alert('success',successMessage);entity(form).applyCallbackSuccess(res,woIncCount);},fail:formErrorsHandler(form),always:function(){entity(form).toggleSpinner(false);}}};var exports={before:nop,nop:nopHandler,Templates:{add:commonFormSaveHandler('TemplateForm','New template has been successfully created.')},Lists:{list:{list:false},add:commonFormSaveHandler('Textmagic::ModalBundle::ListForm','New list has been successfully created.'),getListDropdown:{done:function(res){var form=entity('ContactForm');var item={id:res.id,name:res.name};form.get('form.lists').append(item);form.fetchLists();var $dropdown=global.jQuery('#'+form.get('modalId')).find('.dropdown.tag-input');$dropdown.trigger('click');}},addListDropdown:{done:function(res,opt){external.alert('success','New list has been successfully created.');apiCalls().Lists.get({href:res.href},thisApiHandler.Lists.getListDropdown);entity('ListForm').applyCallbackSuccess(res);},fail:nop,always:nop},listContactForm:{done:function(res){var form=entity('ContactForm');form.set('lists',res.resources);},fail:nop,always:nop},loadDefaultLists:{done:function(res){var form=entity('ContactForm');if(res.hasOwnProperty('resources')){for(var i=0;i<res.resources.length;i++){var item=res.resources[i];form.getForm().lists.push({id:item.id,name:item.name})}}}}},Contacts:{list:{list:false},add:{done:function(res){var form=entity('ContactForm');if(form.getForm().addAnother){form.resetForm();form.getForm().addAnother=true;}else{form.toggleModal(false);}
external.alert('success','New contact has been successfully added.');form.applyCallbackSuccess(res);},fail:formErrorsHandler('ContactForm'),always:function(){entity('ContactForm').toggleSpinner(false);}},getContactForm:{done:function(res){var form=entity('ContactForm');form.loadForm(res);if(!form.get('showModal').raw){form.toggleModal(true,true);}},fail:nop,always:nop},getByPhoneValidationError:{done:function(res){var form=entity('ContactForm');if(res.blocked){form.set('errors.phoneBlocked',res);}else{form.set('errors.phoneExists',res);}},fail:nop,always:nop},unblockContactValidationError:{done:function(res){var form=entity('ContactForm');external.alert('success','Contact has been successfully unblocked.');form.loadForm(form.get('errors.phoneBlocked').raw);},fail:nop,always:nop},putContactForm:commonFormSaveHandler('ContactForm','Contact details have been successfully edited.',true),}};exports.init=function(){external=container.get('Textmagic::CoreBundle::Component::External');entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ModalBundle');app=container.get('Textmagic::ModalBundle::App');thisApiHandler=container.get('Textmagic::ModalBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(thisApiHandler);defaultApiHandler=container.get('Textmagic::CoreBundle::Api::DefaultHandler');exports.Lists.list=defaultApiHandler.Lists.list;};container.register('Textmagic::ModalBundle::Api::Handlers',exports);})(global.AHServiceContainer);(function(container){var that,entity,vue,apiCalls,apiHandler,vueModals,vueHeaderDropdown;var exports={init:function(){vue=container.get('Textmagic::FrameworkBundle::VueComponent');entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ModalBundle');},setCallbackSuccessContactForm:function(callback){entity('ContactForm').setCallbackSuccess(callback);},setCallbackSuccessListForm:function(callback){entity('ListForm').setCallbackSuccess(callback);},setCallbackSuccessTemplateForm:function(callback){entity('TemplateForm').setCallbackSuccess(callback);},run:function(options){var user=entity('Textmagic::CoreBundle::User');user.setCredentials(options.user.login,options.user.api_key);user.set('country',options.user.country);user.setDisallowedRules(options.user.disallowedRules);vue.register(container.match('^Textmagic::ModalBundle::Components::'),'all');vueHeaderDropdown=new global.Vue({el:options.selectors[1]});vueModals=new global.Vue({el:options.selectors[0]});}};container.register('Textmagic::ModalBundle::App',exports);})(global.AHServiceContainer);(function(container){var entity,apiCalls,apiHandler,tagUtils,smsInfo;var exports=[{template:'#modal-add-template',data:function(){return{user:entity('Textmagic::CoreBundle::User'),state:entity('TemplateForm'),textareaRows:tagUtils.rowsVisible('',20)};},methods:{isShowedTextarea:function(){return this.state.get('showTextarea').raw;},tagFieldOnClick:function(){this.state.showTextarea();Vue.nextTick(function(){global.document.getElementById('vueEditTmplText').focus();});},getCaretPos:function(){var node=document.getElementById('vueEditTmplText');if(node.selectionStart){return node.selectionStart;}
return this.state.getForm().content.length;},onSelectTag:function(tag){var pos=this.getCaretPos();var existTxt=this.state.getForm().content;var result=existTxt.slice(0,pos)+'{'+tag+'}'+existTxt.slice(pos);this.state.getForm().content=result;this.textareaOnChange();},tagFields:function(){var userCustomFields=entity('Textmagic::CoreBundle::User').getCustomFields();return entity('TemplateForm').get('staticFields').add(userCustomFields).raw;},textareaOnChange:function(){var value=this.state.getForm().content;this.textareaRows=tagUtils.rowsVisible(value,20);},textareaOnBlur:function(){this.state.hideTextarea();},textareaOnFocus:function(){this.textareaOnChange();},onSubmit:function(){entity('TemplateForm').loadErrors().toggleSpinner(true);apiCalls().Templates.add(entity('TemplateForm').getForm());}},computed:{textareaHtml:function(){var value=this.state.getForm().content;return tagUtils.getTextareaHtml(value);},smsInfo:function(){var value=this.state.getForm().content;return smsInfo.info(value,0);}}}];exports.init=function(){apiHandler=container.get('Textmagic::ModalBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ModalBundle');tagUtils=container.get('Textmagic::CoreBundle::Utils::TextareaTags');smsInfo=container.get('Textmagic::CoreBundle::Utils::SmsInfo');};container.register('Textmagic::ModalBundle::Components::ModalAddTemplate',exports);})(global.AHServiceContainer);(function(container){var entity,apiCalls,apiHandler;var ModalAddList={mixins:[],template:'#modal-add-list',data:function(){return{state:entity('ListForm')};},methods:{onSubmit:function(){entity('ListForm').loadErrors().toggleSpinner(true);apiCalls().Lists.add(entity('ListForm').getForm());}},props:{onToggleModal:{type:Function,default:function(isVisible){this.state.toggleModal(isVisible)}},onSubmitForm:{type:Function,default:function(){this.onSubmit();}},extraClass:{type:String,default:''}}};var exports=[ModalAddList];exports.init=function(){apiHandler=container.get('Textmagic::ModalBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ModalBundle');ModalAddList.mixins.push(container.get('Textmagic::CoreBundle::Mixins::jQueryInit'));};container.register('Textmagic::ModalBundle::Components::ModalAddList',exports);})(global.AHServiceContainer);(function(container){var entity,vueHeaderDropdown,apiHandler,apiCalls,autocomplete,indexById;indexById=function(id,arr){var i;for(i=0;i<arr.length;i++){if(arr[i]['id']===id){return i;}}
return false;};var exports=[{template:'#modal-add-contact',data:function(){return{state:entity('ContactForm'),autocomplete:autocomplete};},methods:{onChangePhone:function(event){autocomplete.updateAutocomplete(this.state.getForm().phone);this.state.setCountryByPhone(this.state.getForm().phone);},onBlurPhone:function(event){setTimeout(function(){autocomplete.resetAutocompleteList();},200);},onChangeCountry:function(e){this.state.getForm().country=e;this.state.setPhonePrefixByCountry(this.state.getForm().country);},onSelectAutocomplete:function(item){autocomplete.resetAutocompleteList();if(item.entityType==='contact'){this.state.fetchContact(item.entityId);this.state.getForm().isShared=Boolean(item.sharedBy);}else{this.state.set('form.phone','+'+item.value);}},onSubmit:function(){var form=entity('ContactForm');var data=form.getFormApiPreSubmit();form.loadErrors().toggleSpinner(true);var id=parseInt(form.get('form.id'));if(id){apiCalls().Contacts.put(id,data);}else{apiCalls().Contacts.add(data)}},addListItem:function(item){var lists=this.state.getForm().lists,index=indexById(item.id,lists);if(index===false){lists.push(item);this.state.set('errors.lists',false);}},removeListItem:function(id){var lists=this.state.getForm().lists,index=indexById(id,lists);if(index!==false){lists.splice(index,1);}},onClickErrorEdit:function(){var form=entity('ContactForm');form.loadForm(form.get('errors.phoneExists').raw);},onClickErrorUnblock:function(){apiCalls().Contacts.unblock({phone:this.state.get('errors.phoneBlocked.phone').raw},apiHandler.Contacts.unblockContactValidationError);}},computed:{phoneType:function(){return this.state.getForm().phoneType;},country:function(){return this.state.getForm().country;},customFields:function(){var ucf=entity('Textmagic::CoreBundle::User').getCustomFields();var ccf=entity('ContactForm').get('form.customFieldValues');var filtered=entity('ContactForm').filterContactCustomFields(ucf,ccf);return entity('ContactForm').set('form.customFieldValues',filtered).get('form.customFieldValues').sortBy('id').raw;}}}];exports.init=function(){apiHandler=container.get('Textmagic::ModalBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ModalBundle');autocomplete=entity('Textmagic::CoreBundle::Autocomplete');};exports.setVueHeaderDropdown=function(vVueHeaderDropdown){vueHeaderDropdown=vVueHeaderDropdown;};container.register('Textmagic::ModalBundle::Components::ModalAddContact',exports);})(global.AHServiceContainer);(function(container){var entity;var exports=[{template:'#app-modals',data:function(){return{}}}];exports.init=function(){entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ModalBundle');};container.register('Textmagic::ModalBundle::Components::App',exports);})(global.AHServiceContainer);(function(container){var entity;var types={'-1':'Auto','0':'Landline','1':'Mobile'};var initChosen=function(context){global.jQuery(context.$el).chosen({search_contains:true,width:'100%'}).on('change',function(e){context.$emit('change',e.target.value);}).trigger('chosen:updated');};var exports=[{template:'#select-countries',methods:{change:function(e){this.$emit('change',e.target.value);}},data:function(){return{countries:entity('Textmagic::CoreBundle::Country')}},updated:function(){initChosen(this);},props:['country']},{template:'#select-phone-types',methods:{change:function(e){this.$emit('change',e.target.value);},getTypes:function(){return types;}},mounted:function(){initChosen(this);},updated:function(){initChosen(this);},computed:{type:function(){var type=this.phoneType.toString();return['-1','0','1'].indexOf(type)>'-1'?type:'1';}},props:['phoneType']}];exports.init=function(){entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ModalBundle');};container.register('Textmagic::ModalBundle::Components::Elements',exports);})(global.AHServiceContainer);(function(container){var entity,apiHandler,apiCalls,searchTimer,searchDelay;searchDelay=500;var exports=[{template:'#dropdown-lists',methods:{onClickDropdownItem:function(item){this.$emit('dropdown-lists-add-item',{id:item.id,name:item.name});},onClickCreateList:function(e){this.listAdd='';this.toggleListAddShow();var ul=e.target.closest('ul');},onClickRemoveTag:function(id){this.$emit('dropdown-lists-remove-item',id);},onInputSearch:function(e){var query=e.target.value;this.search=query;clearTimeout(searchTimer);searchTimer=setTimeout(function(){apiCalls().Lists.search({query:query,onlyMine:1},apiHandler.Lists.listContactForm);},searchDelay);},submitListAdd:function(){if(this.listAdd.trim().length===0){return;}
apiCalls().Lists.add({name:this.listAdd,private:true},apiHandler.Lists.addListDropdown);this.toggleListAddShow();},toggleListAddShow:function(){this.listAddShow=!this.listAddShow;},isChosen:function(id){return{hidden:this.itemsChosen.map(function(item){return item.id;}).indexOf(id)>-1}},highlight:function(value,query){if(query.length===0){return value;}
query=query.toLowerCase();var index=value.toLowerCase().indexOf(query);if(index>-1){value=value.substring(0,index)+
"<span class='chat-highlight'>"+
value.substring(index,index+query.length)+
"</span>"+
value.substring(index+query.length);return value;}
return value;}},props:['items','itemsChosen'],data:function(){return{user:entity('Textmagic::CoreBundle::User'),search:'',listAdd:'',listAddShow:false}}}];exports.init=function(){apiHandler=container.get('Textmagic::ModalBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ModalBundle');};container.register('Textmagic::ModalBundle::Components::DropdownLists',exports);})(global.AHServiceContainer);(function(container){var entity,apiCalls,apiHandler;var ModalAddCustomField={mixins:[],template:'#modal-add-custom-field',data:function(){var baseForm=entity('Textmagic::CoreBundle::BaseForm');baseForm.createForm('add-custom-field',{errors:{name:''},values:{name:''}});return{customFieldForm:baseForm.get('forms.add-custom-field')}},props:{onSubmit:{type:Function,default:function(){}},onToggleModal:{type:Function,default:function(){}},}};var exports=[ModalAddCustomField];exports.init=function(){apiHandler=container.get('Textmagic::ModalBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ModalBundle');ModalAddCustomField.mixins.push(container.get('Textmagic::CoreBundle::Mixins::jQueryInit'));};container.register('Textmagic::ModalBundle::Components::ModalAddCustomField',exports);})(global.AHServiceContainer);(function(container){var entity,vueHeaderDropdown;var exports=[{template:'#dropdown-header-menu',methods:{onClickAddContact:function(){entity('ContactForm').initForm().toggleModal(true,true);},onClickAddList:function(){entity('ListForm').toggleModal(true);},onClickAddTemplate:function(){entity('TemplateForm').initForm().toggleModal(true);},isRuleDisallowed:function(rule){return entity('Textmagic::CoreBundle::User').isRuleDisallowed(rule);}}}];exports.init=function(){entity=container.get('Textmagic::FrameworkBundle::Entity').useBundle('Textmagic::ModalBundle');};container.register('Textmagic::ModalBundle::Components::DropdownAddSimple',exports);})(global.AHServiceContainer);(function(container){var entity,apiCalls,external,apiHandler,base,phoneNumberUtil;var exports={init:function(){entity=container.get('Textmagic::FrameworkBundle::Entity');base=container.get('Textmagic::CoreBundle::Repository::BaseModalForm');apiHandler=container.get('Textmagic::ModalBundle::Api::Handlers');apiCalls=container.get('Textmagic::CoreBundle::Api::Calls').setHandler(apiHandler);phoneNumberUtil=global.window.i18n.phonenumbers.PhoneNumberUtil.getInstance();entity({name:'Textmagic::ModalBundle::ContactForm',initState:base.initForm({modalId:'vueUpdateContactModal',tabCounter:'#contacts-tabs li:nth-child(2) span.badge',saveButtonId:'vueSaveContactButton',lists:[],form:this.emptyForm(),errors:this.emptyErrors()}),methods:[base,this]});},emptyErrors:function(){return{phone:false,phoneExists:null,phoneBlocked:null,firstName:false,lastName:false,companyName:false,email:false,phoneType:false,addAnother:false,country:false,lists:false,customFieldValues:false}},emptyForm:function(){return{id:null,isShared:false,phone:'',firstName:'',lastName:'',companyName:'',email:'',phoneType:'-1',addAnother:false,country:'GB',lists:[],customFieldValues:[]}},fetchContact:function(id){apiCalls().Contacts.get(id);},loadForm:function(data){this.set('form.id',data.id);this.set('form.phone','+'+data.phone);this.set('form.firstName',data.firstName);this.set('form.lastName',data.lastName);this.set('form.companyName',data.companyName);this.set('form.email',data.email);this.set('form.lists',data.lists);this.set('form.country',(typeof data.country=='object'?data.country.id:data.country));this.set('form.phoneType',data.phoneType);this.set('errors',this.emptyErrors());var ucf=entity('Textmagic::CoreBundle::User').getCustomFields();var ccf=new global.Sugar.Array(data.customFields);this.set('form.customFieldValues',this.filterContactCustomFields(ucf,ccf));},filterContactCustomFields:function(ucf,ccf){var r=[];ucf.forEach(function(o,i){var value='';var item=ccf.find({id:o.id});if(item.raw){value=item.raw.value;}
r.push({id:o.id,name:o.name,value:value})});return r;},parsePhone:function(phone,country){var data=phoneNumberUtil.transformPhoneNumber(phone.replace(/^00/,'+'),(country||'GB'));if(!data.isValid){return null;}
return data;},setCountryByPhone:function(phone){var countryCode=null;if(phone.substr(0,4)==='+999'){this.set('form.country','ZZ');return;}
try{var phoneNumber=phoneNumberUtil.parse(phone,"");countryCode=phoneNumberUtil.getRegionCodeForNumber(phoneNumber);if(!countryCode){countryCode=phoneNumberUtil.getRegionCodeForCountryCode(phoneNumber.getCountryCode());}}catch(err){}
if(countryCode!==null){this.set('form.country',countryCode);}},setPhonePrefixByCountry:function(countryCode){var prefix=null;if(countryCode==='ZZ'){this.set('form.phone','+999');return;}
try{var prefix=phoneNumberUtil.getCountryCodeForRegion(countryCode);prefix='+'+prefix;}catch(err){}
if(prefix!==null){this.set('form.phone',prefix);}},initForm:function(){var user=entity('Textmagic::CoreBundle::User');if(user.getCustomFields().length==0){user.refreshCustomTags();}
if(this.get('lists').raw.length===0){this.fetchLists();}
if(entity('Textmagic::CoreBundle::Country').raw.length===0){this.fetchCountries();}
this.resetForm();return this;},resetForm:function(){this.set('form',this.emptyForm());this.set('errors',this.emptyErrors());var country=entity('Textmagic::CoreBundle::User').get('country').raw;this.set('form.country',country);this.setPhonePrefixByCountry(country);this.loadDefaultLists();},loadDefaultLists:function(){apiCalls().Lists.search({onlyDefault:1,onlyMine:1,limit:100},apiHandler.Lists.loadDefaultLists);},fetchLists:function(){apiCalls().Lists.search({onlyMine:1,limit:100},apiHandler.Lists.listContactForm);},fetchCountries:function(){entity('Textmagic::CoreBundle::Country').fetch();},getFormApiPreSubmit:function(){var customFieldValues={};var data=this.getForm();data.customFieldValues.forEach(function(o,i){customFieldValues[o.id]=o.value;});var lists=data.lists.map(function(obj){return obj.id}).join(',');var phoneObj=this.parsePhone(this.get('form.phone').raw,this.get('form.country').raw);var phone=phoneObj!==null?phoneObj.number.substr(1):null;return{firstName:data.firstName,lastName:data.lastName,phone:phone,type:data.phoneType,email:data.email,companyName:data.companyName,lists:lists,customFieldValues:customFieldValues};},loadErrors:function(errors){var that=this;this.get('errors').forEach(function(val,key){var value=errors&&errors.hasOwnProperty(key)?errors[key].toString():false;that.get('errors').set(key,value);});var listsEmpty=this.get('errors.lists').raw&&this.get('form.lists').raw.length===0;if(listsEmpty){this.set('errors.lists','Please specify at least one list.');}
var phoneExists=this.get('errors.phone').raw=='Phone number already exists in your contacts.';if(phoneExists){var phoneObj=this.parsePhone(this.getForm().phone,this.getForm().country);if(phoneObj===null){return this;}
apiCalls().Contacts.getByPhone(phoneObj.number.substr(1),apiHandler.Contacts.getByPhoneValidationError);}
this.scrollToErrors();return this;},};container.register('Textmagic::ModalBundle::Repository::ContactForm',exports);})(global.AHServiceContainer);(function(container){var entity,external,base,apiCalls,apiHandler;var exports={init:function(){entity=container.get('Textmagic::FrameworkBundle::Entity');base=container.get('Textmagic::CoreBundle::Repository::BaseModalForm');entity({name:'Textmagic::ModalBundle::TemplateForm',initState:base.initForm({modalId:'vueAddTemplateModal',saveButtonId:'vueSaveTemplateButton',showTextarea:false,textareaHtml:'',staticFields:[{"id":1,"name":"First name"},{"id":2,"name":"Last name"},{"id":3,"name":"Company name"},{"id":4,"name":"Phone"},{"id":5,"name":"Email"}],form:this.emptyForm(),errors:this.emptyErrors()}),methods:[base,this]});},initForm:function(){this.set('textareaHtml','');var user=entity('Textmagic::CoreBundle::User');if(user.getCustomFields().length==0){user.refreshCustomTags();}
return this;},showTextarea:function(){this.set('showTextarea',true);},hideTextarea:function(){this.set('showTextarea',false);},emptyErrors:function(){return{name:false,content:false}},emptyForm:function(){return{name:'',content:''}}};container.register('Textmagic::ModalBundle::Repository::TemplateForm',exports);})(global.AHServiceContainer);(function(container){var entity,base,external,apiCalls,apiHandler;var exports={init:function(){entity=container.get('Textmagic::FrameworkBundle::Entity');base=container.get('Textmagic::CoreBundle::Repository::BaseModalForm');entity({name:'Textmagic::ModalBundle::ListForm',initState:base.initForm({modalId:'vueUpdateListModal',saveButtonId:'vueSaveListButton',tabCounter:'#contacts-tabs li:nth-child(1) span.badge',form:this.emptyForm(),errors:this.emptyErrors()}),methods:[base,this]});},emptyErrors:function(){return{name:false,private:false,isDefault:false}},emptyForm:function(){return{name:'',private:true,isDefault:false}}};container.register('Textmagic::ModalBundle::Repository::ListForm',exports);})(global.AHServiceContainer);